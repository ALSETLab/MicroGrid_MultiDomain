within OpenIPSL.Examples;
package ModelPredictiveControl
  "Package containing system examples for Model Predictive Control Studies"
  package Luigi_Vanfretti_Special_Package

    model MPCAppliedEnergyOriginal
      "THIS ONE IS STABLE, CONTROLLABLE, OBSERVABLE!!!!!!!"
      extends Modelica.Icons.Example;

      parameter Boolean equivalentGRID = false;
      parameter Boolean equivalentsystem = false;

      OpenIPSL.Electrical.Buses.Bus Bus1(v_0=powerFlow.powerflow.bus.V1, angle_0=
            powerFlow.powerflow.bus.A1) if not equivalentGRID
        annotation (Placement(transformation(extent={{-90,70},{-70,90}})));
      OpenIPSL.Electrical.Buses.Bus Bus2(v_0=powerFlow.powerflow.bus.V2, angle_0=
            powerFlow.powerflow.bus.A1) if not equivalentGRID
        annotation (Placement(transformation(extent={{-50,70},{-30,90}})));
      OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
        R=0.001,
        X=0.2,
        G=0,
        B=0,
        VNOM1=13800,
        VB1=13800,
        VNOM2=6000,
        VB2=6000)  if not equivalentGRID annotation (Placement(transformation(
            extent={{-8,-8},{8,8}},
            rotation=180,
            origin={-60,80})));
      OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
        enableV_b=true,
        v_0=powerFlow.powerflow.bus.V1,
        angle_0=powerFlow.powerflow.bus.A1,
        P_0=powerFlow.powerflow.machines.PG1,
        Q_0=powerFlow.powerflow.machines.QG1,
        V_b=6000)  if not equivalentGRID
        annotation (Placement(transformation(extent={{-112,70},{-92,90}})));
      OpenIPSL.Electrical.Branches.PwLine L1(
        R=0.001,
        X=0.2,
        G=0,
        B=0) if not equivalentGRID annotation (Placement(transformation(extent={{-26,76},
                {-14,84}})));
      OpenIPSL.Electrical.Buses.Bus Bus3(v_0=powerFlow.powerflow.bus.V3, angle_0=
            powerFlow.powerflow.bus.A3) if not equivalentGRID
        annotation (Placement(transformation(extent={{-10,70},{10,90}})));
      OpenIPSL.Electrical.Buses.Bus Bus4(v_0=powerFlow.powerflow.bus.V4, angle_0=
            powerFlow.powerflow.bus.V4) if not equivalentGRID
        annotation (Placement(transformation(extent={{50,70},{70,90}})));
      OpenIPSL.Electrical.Branches.PwLine L2_1(
        R=0.0005,
        X=0.1,
        G=0,
        B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,86},
                {36,94}})));
      OpenIPSL.Electrical.Branches.PwLine L2_2(
        R=0.0005,
        X=0.1,
        G=0,
        B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,66},
                {36,74}})));
      OpenIPSL.Electrical.Buses.Bus Bus5(angle_0=powerFlow.powerflow.bus.A5, v_0=
            powerFlow.powerflow.bus.V5)  annotation (Placement(
            transformation(
            extent={{-10,-10},{10,10}},
            rotation=90,
            origin={80,16})));
      OpenIPSL.Electrical.Branches.PwLine L3(
        R=0.001,
        X=0.2,
        G=0,
        B=0) if not equivalentGRID annotation (Placement(transformation(
            extent={{-6,-4},{6,4}},
            rotation=-90,
            origin={80,60})));
      OpenIPSL.Electrical.Buses.Bus Bus6(v_0=powerFlow.powerflow.bus.V6, angle_0=
            powerFlow.powerflow.bus.A6) annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={-10,10})));
      OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
        G=0,
        B=0,
        VNOM1=13800,
        VB1=13800,
        VNOM2=6000,
        VB2=6000,
        R=0.005,
        X=0.1)  annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={10,10})));
      GenerationUnits.PSSE.G2_16MVA                         G2(
        enableV_b=true,
        enableP_0=true,
        enableQ_0=true,
        v_0=powerFlow.powerflow.bus.V6,
        enablev_0=true,
        angle_0=powerFlow.powerflow.bus.A6,
        V_b=6000,
        P_0=powerFlow.powerflow.machines.PG2,
        Q_0=powerFlow.powerflow.machines.QG2,
        enableangle_0=true)
                      annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=0,
            origin={-30,10})));
      inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000, fn=60)
        annotation (Placement(transformation(extent={{-128,104},{-74,124}})));
      OpenIPSL.Electrical.Loads.PSSE.Load Load1(
        V_b=220000,
        P_0=powerFlow.powerflow.loads.PL1,
        Q_0=powerFlow.powerflow.loads.QL1,
        v_0=powerFlow.powerflow.bus.V3,
        angle_0=powerFlow.powerflow.bus.A3) if not equivalentGRID
        annotation (Placement(transformation(extent={{-20,48},{0,68}})));
      Electrical.Events.Breaker breaker(enableTrigger=false,
        t_o=0.25,
        rc_enabled=false,
        t_rc=80.01)       if not equivalentGRID                     annotation (Placement(transformation(
            extent={{-4,-4},{4,4}},
            rotation=90,
            origin={80,26})));

      Modelica.Blocks.Interfaces.RealInput IN1(start=0)
        "Connector of Real input signal 2" annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=0,
            origin={-150,10}),iconTransformation(extent={{-10,-10},{10,10}}, origin={-150,10})));
      Modelica.Blocks.Sources.Constant IN11(k=0)
        annotation (Placement(transformation(extent={{-108,-2},{-96,10}})));
      Modelica.Blocks.Math.Add AddU1
        annotation (Placement(transformation(extent={{-80,0},{-60,20}})));
      Modelica.Blocks.Sources.Constant IN22(k=0)
        annotation (Placement(transformation(extent={{-108,-32},{-96,-20}})));
      Modelica.Blocks.Math.Add AddU2
        annotation (Placement(transformation(extent={{-80,-30},{-60,-10}})));
      Modelica.Blocks.Interfaces.RealInput IN2(start=0)
        "Connector of Real input signal 2"
               annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=0,
            origin={-150,-12}), iconTransformation(extent={{-10,-10},{10,10}},
              origin={-150,-12})));
                Modelica.Blocks.Interfaces.RealInput IN3 "Connector of Real input signal 1"
        annotation (Placement(transformation(extent={{-160,-44},{-140,-24}}),
            iconTransformation(extent={{-160,-44},{-140,-24}})));
      Modelica.Blocks.Interfaces.RealInput IN4(start = 0) "Connector of Real input signal 1"
        annotation (Placement(transformation(extent={{-160,-66},{-140,-46}}),
            iconTransformation(extent={{-160,-66},{-140,-46}})));
      Modelica.Blocks.Interfaces.RealInput IN5(start = 0) "Connector of Real input signal 1"
        annotation (Placement(transformation(extent={{-160,-88},{-140,-68}}),
            iconTransformation(extent={{-160,-88},{-140,-68}})));

      Modelica.Blocks.Interfaces.RealOutput OUT1
        annotation (Placement(transformation(extent={{140,70},{160,90}})));
     Modelica.Blocks.Interfaces.RealOutput OUT2
        annotation (Placement(transformation(extent={{140,50},{160,70}})));
      Modelica.Blocks.Interfaces.RealOutput OUT3
        annotation (Placement(transformation(extent={{140,30},{160,50}})));

      PFData.PowerFlow powerFlow(redeclare record PowerFlow =
            OpenIPSL.Examples.ModelPredictiveControl.PFData.PF16)
        annotation (Placement(transformation(extent={{-68,104},{-48,124}})));
      Electrical.Machines.PSSE.GENCLS IB(
        V_b=220000,
        v_0=powerFlow.powerflow.bus.V4,
        angle_0=powerFlow.powerflow.bus.A4,
        P_0=powerFlow.powerflow.machines.Pinf,
        Q_0=powerFlow.powerflow.machines.Qinf,
        M_b=100000000,
        X_d=1) if not equivalentGRID annotation (Placement(transformation(extent={{110,70},
                {100,90}})));
      Electrical.Loads.PSSE.Load_ExtInput Load2(
        P_0=powerFlow.powerflow.loads.PL2,
        Q_0=powerFlow.powerflow.loads.QL2,
        v_0=powerFlow.powerflow.bus.V5,
        angle_0=powerFlow.powerflow.bus.A5,
        d_P=0,
        t1=100,
        d_t=1000)
        annotation (Placement(transformation(extent={{100,-30},{120,-10}})));

      inner Modelica.Blocks.Noise.GlobalSeed globalSeed(useAutomaticSeed=false,
          fixedSeed=10000)
        annotation (Placement(transformation(extent={{-42,102},{-22,122}})));
      Modelica.Blocks.Sources.Sine sine(
        amplitude=0,
        f=1/260,
        phase=3.1415926535898,
        startTime=1000)
        annotation (Placement(transformation(extent={{70,-36},{80,-26}})));

      Electrical.Buses.Bus Bus10(v_0=powerFlow.powerflow.bus.V10, angle_0=powerFlow.powerflow.bus.A10)
        annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={-10,-90})));
      Electrical.Branches.PSSE.TwoWindingTransformer          T4(
        G=0,
        B=0,
        CW=1,
        VNOM1=13800,
        VB1=13800,
        VNOM2=480,
        VB2=480,
        R=0.001,
        X=0.1)  annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={10,-90})));
      GenerationUnits.PSSE.Solar_Units.SolarMPCLocalVQControl PV(
        V_b=480,
        P_0=powerFlow.powerflow.machines.PPV,
        enableP_0=true,
        Q_0=powerFlow.powerflow.machines.QPV,
        enableQ_0=true,
        v_0=powerFlow.powerflow.bus.V8,
        enablev_0=true,
        angle_0=powerFlow.powerflow.bus.A8,
        enableangle_0=true)
        annotation (Placement(transformation(extent={{-40,-60},{-20,-40}})));
      Modelica.Blocks.Math.Add AddU3
        annotation (Placement(transformation(extent={{-80,-60},{-60,-40}})));
      Modelica.Blocks.Sources.Constant IN33(k=0)
        annotation (Placement(transformation(extent={{-108,-62},{-96,-50}})));

      Modelica.Blocks.Math.Add AddU4
        annotation (Placement(transformation(extent={{-80,-90},{-60,-70}})));
      Modelica.Blocks.Math.Add AddU5
        annotation (Placement(transformation(extent={{-80,-116},{-60,-96}})));
      Modelica.Blocks.Sources.Constant IN44(k=0)
        annotation (Placement(transformation(extent={{-108,-92},{-96,-80}})));
      Modelica.Blocks.Sources.Constant IN55(k=0)
        annotation (Placement(transformation(extent={{-108,-118},{-96,-106}})));
      Modelica.Blocks.Interfaces.RealOutput OUT4
        annotation (Placement(transformation(extent={{140,10},{160,30}})));
      Modelica.Blocks.Interfaces.RealOutput OUT5
        annotation (Placement(transformation(extent={{140,-10},{160,10}})));
      Modelica.Blocks.Interfaces.RealOutput OUT6
        annotation (Placement(transformation(extent={{140,-30},{160,-10}})));
      Modelica.Blocks.Interfaces.RealOutput OUT7
        annotation (Placement(transformation(extent={{140,-50},{160,-30}})));
      Modelica.Blocks.Interfaces.RealOutput OUT8
        annotation (Placement(transformation(extent={{140,-70},{160,-50}})));
      Modelica.Blocks.Interfaces.RealOutput OUT9
        annotation (Placement(transformation(extent={{140,-90},{160,-70}})));
      Modelica.Blocks.Interfaces.RealOutput OUT10
        annotation (Placement(transformation(extent={{140,-110},{160,-90}})));
      Modelica.Blocks.Interfaces.RealOutput OUT11
        annotation (Placement(transformation(extent={{164,70},{184,90}})));
      Modelica.Blocks.Interfaces.RealOutput OUT12
        annotation (Placement(transformation(extent={{164,50},{184,70}})));
      Modelica.Blocks.Interfaces.RealOutput OUT13
        annotation (Placement(transformation(extent={{164,30},{184,50}})));
      Modelica.Blocks.Interfaces.RealOutput OUT14
        annotation (Placement(transformation(extent={{164,10},{184,30}})));
      Modelica.Blocks.Interfaces.RealOutput OUT15
        annotation (Placement(transformation(extent={{164,-10},{184,10}})));
      Modelica.Blocks.Interfaces.RealOutput OUT16
        annotation (Placement(transformation(extent={{164,-30},{184,-10}})));
      Modelica.Blocks.Interfaces.RealOutput OUT17
        annotation (Placement(transformation(extent={{164,-50},{184,-30}})));
      Modelica.Blocks.Interfaces.RealOutput OUT18
        annotation (Placement(transformation(extent={{164,-70},{184,-50}})));
      Modelica.Blocks.Interfaces.RealOutput OUT19
        annotation (Placement(transformation(extent={{164,-90},{184,-70}})));
      Modelica.Blocks.Interfaces.RealOutput OUT20
        annotation (Placement(transformation(extent={{164,-110},{184,-90}})));
      Modelica.Blocks.Interfaces.RealOutput OUT21
        annotation (Placement(transformation(extent={{184,70},{204,90}})));
      Modelica.Blocks.Interfaces.RealOutput OUT22
        annotation (Placement(transformation(extent={{184,50},{204,70}})));
      Modelica.Blocks.Interfaces.RealOutput OUT23
        annotation (Placement(transformation(extent={{184,30},{204,50}})));
      Modelica.Blocks.Interfaces.RealOutput OUT24
        annotation (Placement(transformation(extent={{184,10},{204,30}})));
      Modelica.Blocks.Interfaces.RealOutput OUT25
        annotation (Placement(transformation(extent={{184,-10},{204,10}})));
      Modelica.Blocks.Interfaces.RealOutput OUT26
        annotation (Placement(transformation(extent={{184,-30},{204,-10}})));
      Modelica.Blocks.Interfaces.RealOutput OUT27
        annotation (Placement(transformation(extent={{184,-50},{204,-30}})));
      Modelica.Blocks.Interfaces.RealOutput OUT28
        annotation (Placement(transformation(extent={{184,-70},{204,-50}})));
      Modelica.Blocks.Interfaces.RealOutput OUT29
        annotation (Placement(transformation(extent={{184,-90},{204,-70}})));
      Modelica.Blocks.Interfaces.RealOutput OUT30
        annotation (Placement(transformation(extent={{184,-110},{204,-90}})));
      Modelica.Blocks.Interfaces.RealOutput OUT31
        annotation (Placement(transformation(extent={{204,70},{224,90}})));
      Modelica.Blocks.Interfaces.RealOutput OUT32
        annotation (Placement(transformation(extent={{204,50},{224,70}})));
      Modelica.Blocks.Interfaces.RealOutput OUT33
        annotation (Placement(transformation(extent={{204,30},{224,50}})));
      GenerationUnits.PSSE.Battery_Units.BESSMPCLocalVQControl BESS(
        V_base=480,
        V_b(displayUnit="kV") = 480,
        enableV_b=true,
        P_0=powerFlow.powerflow.machines.PBESS,
        enableP_0=true,
        Q_0=powerFlow.powerflow.machines.QBESS,
        enableQ_0=true,
        v_0=powerFlow.powerflow.bus.V10,
        enablev_0=true,
        angle_0=powerFlow.powerflow.bus.A10,
        enableangle_0=true)
        annotation (Placement(transformation(extent={{-40,-100},{-20,-80}})));
      Modelica.Blocks.Interfaces.RealOutput OUT34
        annotation (Placement(transformation(extent={{204,10},{224,30}})));
      Modelica.Blocks.Interfaces.RealOutput OUT35
        annotation (Placement(transformation(extent={{206,-10},{226,10}})));
      Modelica.Blocks.Interfaces.RealOutput OUT36
        annotation (Placement(transformation(extent={{206,-30},{226,-10}})));
      Modelica.Blocks.Interfaces.RealOutput OUT37
        annotation (Placement(transformation(extent={{206,-50},{226,-30}})));
      Modelica.Blocks.Interfaces.RealOutput OUT38
        annotation (Placement(transformation(extent={{206,-70},{226,-50}})));
      Modelica.Blocks.Interfaces.RealOutput OUT39
        annotation (Placement(transformation(extent={{206,-90},{226,-70}})));
      Electrical.Buses.Bus Bus8(v_0=powerFlow.powerflow.bus.V8, angle_0=powerFlow.powerflow.bus.A8)
        annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={-10,-50})));
      Electrical.Branches.PSSE.TwoWindingTransformer          T3(
        G=0,
        B=0,
        CW=1,
        VNOM1=13800,
        VB1=13800,
        VNOM2=480,
        VB2=480,
        R=0.001,
        X=0.1)  annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={12,-50})));
      Electrical.Buses.Bus Bus11(v_0=powerFlow.powerflow.bus.V11, angle_0=powerFlow.powerflow.bus.A11)
        annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={30,-90})));
      Electrical.Buses.Bus Bus9(v_0=powerFlow.powerflow.bus.V9, angle_0=powerFlow.powerflow.bus.A9)
        annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={30,-50})));
      Electrical.Buses.Bus Bus7(v_0=powerFlow.powerflow.bus.V7, angle_0=powerFlow.powerflow.bus.A7)
        annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={30,10})));
      Electrical.Branches.PwLine          L4(
        R=0.01,
        X=0.001,
        G=0,
        B=0)  annotation (Placement(transformation(extent={{38,6},{
                50,14}})));
      Electrical.Branches.PwLine          L5(
        R=0.01,
        X=0.001,
        G=0,
        B=0)  annotation (Placement(transformation(extent={{38,-54},
                {50,-46}})));
      Electrical.Branches.PwLine          L6(
        R=0.01,
        X=0.001,
        G=0,
        B=0)  annotation (Placement(transformation(extent={{38,-94},
                {50,-86}})));
      Modelica.Blocks.Interfaces.RealOutput OUT40
        annotation (Placement(transformation(extent={{206,-110},{226,-90}})));
      Modelica.Blocks.Interfaces.RealOutput OUT41
        annotation (Placement(transformation(extent={{224,70},{244,90}})));
      Electrical.Loads.NoiseInjections.WhiteNoiseInjection whiteNoiseInjection(
          active_sigma=0.0000000001, samplePeriod=0.1)
        annotation (Placement(transformation(extent={{68,-18},{80,-6}})));
      Modelica.Blocks.Math.Add add
        annotation (Placement(transformation(extent={{86,-18},{94,-10}})));
      Modelica.Blocks.Interfaces.RealOutput OUT42
        annotation (Placement(transformation(extent={{224,50},{244,70}})));
    equation

    // OUT1 = G2.gen.w;
    // OUT2 = G2.gen.delta;
    // OUT3 = G2.gen.Epq;
    // OUT4 = G2.gen.PSIkd;
    // OUT5 = G2.gen.PSIppq;
    // OUT6 = G2.sEXSMPC.simpleLagLim.state;
    // OUT7 = G2.sEXSMPC.leadLag.TF.x_scaled[1];
    // OUT8 = G2.gASTMPC.simpleLagLim.state;
    // OUT9 = G2.gASTMPC.simpleLag.state;
    // OUT10 = G2.gASTMPC.simpleLag1.state;
    // OUT11 = PV.rEGCA1_1.simpleLag.state;
    // OUT12 = PV.rEGCA1_1.integrator.y;
    // OUT13 = PV.rEGCA1_1.integrator1.y;
    // OUT14 =PV.EC.IGQ.y;
    // OUT15 =PV.EC.IGV.y;
    // OUT16 =PV.EC.simpleLag.state;
    // OUT17 =PV.EC.simpleLag1.state;
    // OUT18 =PV.EC.simpleLag2.state;
    // OUT19 =PV.EC.IGP.y;
    // OUT20 =PV.EC.simpleLag3.state;
    // OUT21 =PV.EC.simpleLag4.state;
    // OUT22 =PV.EC.simpleLag5.state;
    // OUT23 = BESS.rEGCA1_1.simpleLag.state;
    // OUT24 = BESS.rEGCA1_1.integrator.y;
    // OUT25 = BESS.rEGCA1_1.integrator1.y;
    // OUT26 =BESS.EC.integrator3.y;
    // OUT27 =BESS.EC.integrator1.y;
    // OUT28 =BESS.EC.simpleLag.state;
    // OUT29 =BESS.EC.IGQ.y;
    // OUT30 =BESS.EC.IGV.y;
    // OUT31 =BESS.EC.IGP.y;
    // OUT32 =BESS.EC.simpleLag1.state;
    // OUT33 =BESS.EC.simpleLag2.state;
    // OUT34 =BESS.EC.simpleLag3.state;
    // OUT35 =BESS.EC.simpleLag4.state;
    // OUT36 = G2.gen.PMECH;
    // OUT37 = G2.sEXSMPC.EFD;
    // OUT38 = BESS.rEGCA1_1.Pgen;
    // OUT39 = BESS.rEGCA1_1.Qgen;
    // OUT40 = PV.rEGCA1_1.Pgen;
    // OUT41 = PV.rEGCA1_1.Qgen;
    // OUT42 = Bus5.v;
    // OUT43 = Bus5.angle;

    OUT1 = G2.gen.w;
    OUT2 = G2.gen.delta;
    OUT3 = G2.gen.Epq;
    OUT4 = G2.gen.PSIkd;
    OUT5 = G2.gen.PSIppq;
    OUT6 = G2.sEXSMPC.simpleLagLim.state;
    OUT7 = G2.sEXSMPC.leadLag.TF.x_scaled[1];
    OUT8 = G2.gASTMPC.simpleLagLim.state;
    OUT9 = G2.gASTMPC.simpleLag.state;
    OUT10 = G2.gASTMPC.simpleLag1.state;
    OUT11 = PV.rEGCA1_1.simpleLag.state;
    OUT12 = PV.rEGCA1_1.integrator.y;
    OUT13 = PV.rEGCA1_1.integrator1.y;
    OUT14 =PV.EC.IGQ.y;
    OUT15 =PV.EC.IGV.y;
    OUT16 =PV.EC.simpleLag.state;
    OUT17 =PV.EC.simpleLag1.state;
    OUT18 =PV.EC.simpleLag2.state;
    OUT19 =PV.EC.IGP.y;
    OUT20 =PV.EC.simpleLag3.state;
    OUT21 =PV.EC.simpleLag5.state;
    OUT22 = PV.EC.simpleLag4.state;
    OUT23 = BESS.rEGCA1_1.simpleLag.state;
    OUT24 = BESS.rEGCA1_1.integrator.y;
    OUT25 = BESS.rEGCA1_1.integrator1.y;
    OUT26 =BESS.EC.integrator3.y;
    OUT27 =BESS.EC.simpleLag.state;
    OUT28 =BESS.EC.IGQ.y;
    OUT29 =BESS.EC.IGV.y;
    OUT30 =BESS.EC.IGP.y;
    OUT31 =BESS.EC.simpleLag1.state;
    OUT32 =BESS.EC.simpleLag2.state;
    OUT33 =BESS.EC.simpleLag3.state;
    OUT34 =BESS.EC.simpleLag4.state;
    OUT35 = G2.gen.PMECH;
    OUT36 = G2.sEXSMPC.EFD;
    OUT37 = BESS.rEGCA1_1.Pgen;
    OUT38 = BESS.rEGCA1_1.Qgen;
    OUT39 = PV.rEGCA1_1.Pgen;
    OUT40 = PV.rEGCA1_1.Qgen;
    OUT41 = Bus5.v;
    OUT42 = Bus5.angle;

      connect(T1.p, Bus2.p)
        annotation (Line(points={{-51.2,80},{-40,80}}, color={0,0,255}));
      connect(Bus1.p, T1.n)
        annotation (Line(points={{-80,80},{-68.8,80}}, color={0,0,255}));
      connect(G1.conn, Bus1.p)
        annotation (Line(points={{-91,80},{-80,80}}, color={0,0,255}));
      connect(L1.n, Bus3.p)
        annotation (Line(points={{-14.6,80},{0,80}}, color={0,0,255}));
      connect(L1.p, Bus2.p)
        annotation (Line(points={{-25.4,80},{-40,80}}, color={0,0,255}));
      connect(L2_2.n, Bus4.p) annotation (Line(points={{35.4,70},{44,70},{44,80},{60,
              80}}, color={0,0,255}));
      connect(L2_1.n, Bus4.p) annotation (Line(points={{35.4,90},{44,90},{44,80},{60,
              80}}, color={0,0,255}));
      connect(L2_1.p, Bus3.p) annotation (Line(points={{24.6,90},{16,90},{16,80},{0,
              80}}, color={0,0,255}));
      connect(L2_2.p, Bus3.p) annotation (Line(points={{24.6,70},{16,70},{16,80},{0,
              80}}, color={0,0,255}));
      connect(Load1.p, Bus3.p)
        annotation (Line(points={{-10,68},{-10,80},{0,80}}, color={0,0,255}));
      connect(L3.p, Bus4.p)
        annotation (Line(points={{80,65.4},{80,80},{60,80}}, color={0,0,255}));
      connect(breaker.s, Bus5.p)
        annotation (Line(points={{80,22},{80,16}},color={0,0,255}));
      connect(breaker.r, L3.n)
        annotation (Line(points={{80,30},{80,54.6}},color={0,0,255}));
      connect(IN11.y, AddU1.u2) annotation (Line(points={{-95.4,4},{-82,4}},
                          color={0,0,127}));
      connect(IN1, AddU1.u1) annotation (Line(points={{-150,10},{-116,10},{-116,16},
              {-82,16}},
                     color={0,0,127}));

      connect(IN22.y,AddU2. u2) annotation (Line(points={{-95.4,-26},{-82,-26}},
                     color={0,0,127}));
      connect(IN2,AddU2. u1) annotation (Line(points={{-150,-12},{-118,-12},{-118,-14},
              {-82,-14}},
                     color={0,0,127}));
      connect(AddU2.y, G2.Efd_ref)
        annotation (Line(points={{-59,-20},{-52,-20},{-52,4},{-42,4}},
                                                               color={0,0,127}));
      connect(AddU1.y, G2.P_ref1) annotation (Line(points={{-59,10},{-52,10},{-52,16},
              {-42,16}},                          color={0,0,127}));
      connect(IB.p, Bus4.p)
        annotation (Line(points={{100,80},{60,80}}, color={0,0,255}));
      connect(Load2.p, Bus5.p) annotation (Line(points={{110,-10},{110,10},{80,10},{
              80,16}},
                   color={0,0,255}));
      connect(T4.n, Bus10.p)
        annotation (Line(points={{-1,-90},{-10,-90}}, color={0,0,255}));
      connect(Bus6.p, T2.n)
        annotation (Line(points={{-10,10},{-1,10}},
                                                color={0,0,255}));
      connect(AddU3.y, PV.QINPUT) annotation (Line(points={{-59,-50},{-42,-50}},
                               color={0,0,127}));
      connect(IN33.y,AddU3. u2)
        annotation (Line(points={{-95.4,-56},{-82,-56}}, color={0,0,127}));
      connect(BESS.p1, Bus10.p)
        annotation (Line(points={{-20,-90},{-10,-90}}, color={0,0,255}));
      connect(BESS.Paux1, AddU4.y) annotation (Line(points={{-42,-84},{-54,-84},{-54,
              -80},{-59,-80}}, color={0,0,127}));
      connect(IN55.y, AddU5.u2)
        annotation (Line(points={{-95.4,-112},{-82,-112}}, color={0,0,127}));
      connect(AddU5.y, BESS.Qext1) annotation (Line(points={{-59,-106},{-52,-106},{-52,
              -96},{-42,-96}},   color={0,0,127}));
      connect(IN44.y, AddU4.u2)
        annotation (Line(points={{-95.4,-86},{-82,-86}}, color={0,0,127}));
      connect(AddU4.u1,IN4)  annotation (Line(points={{-82,-74},{-100,-74},{-100,-70},
              {-116,-70},{-116,-56},{-150,-56}}, color={0,0,127}));
      connect(AddU5.u1,IN5)  annotation (Line(points={{-82,-100},{-116,-100},{-116,-78},
              {-150,-78}}, color={0,0,127}));
      connect(G2.conn, Bus6.p) annotation (Line(points={{-19,10},{-10,10}},
                                         color={0,0,255}));
      connect(AddU3.u1, IN3) annotation (Line(points={{-82,-44},{-118,-44},{-118,-34},
              {-150,-34}}, color={0,0,127}));
      connect(PV.p1, Bus8.p)
        annotation (Line(points={{-20,-50},{-10,-50}}, color={0,0,255}));
      connect(Bus8.p, T3.n)
        annotation (Line(points={{-10,-50},{1,-50}},  color={0,0,255}));
      connect(T2.p, Bus7.p) annotation (Line(points={{21,10},{25.5,10},{25.5,10},{30,
              10}}, color={0,0,255}));
      connect(T3.p, Bus9.p)
        annotation (Line(points={{23,-50},{30,-50}}, color={0,0,255}));
      connect(T4.p, Bus11.p)
        annotation (Line(points={{21,-90},{30,-90}}, color={0,0,255}));
      connect(L4.n, Bus5.p) annotation (Line(points={{49.4,10},{60,10},{60,10},{80,10},
              {80,16}},     color={0,0,255}));
      connect(L5.n, Bus5.p) annotation (Line(points={{49.4,-50},{60,-50},{60,10},{80,
              10},{80,16}}, color={0,0,255}));
      connect(Bus11.p, L6.p)
        annotation (Line(points={{30,-90},{38.6,-90}}, color={0,0,255}));
      connect(Bus9.p, L5.p)
        annotation (Line(points={{30,-50},{38.6,-50}}, color={0,0,255}));
      connect(L6.n, Bus5.p) annotation (Line(points={{49.4,-90},{60,-90},{60,10},{80,
              10},{80,16}}, color={0,0,255}));
      connect(Bus7.p, L4.p) annotation (Line(points={{30,10},{34.3,10},{34.3,10},{38.6,
              10}}, color={0,0,255}));
      connect(sine.y, add.u2) annotation (Line(points={{80.5,-31},{85.2,-31},{85.2,-16.4}},
            color={0,0,127}));
      connect(whiteNoiseInjection.y, add.u1) annotation (Line(points={{80.54,-12.06},
              {82.87,-12.06},{82.87,-11.6},{85.2,-11.6}}, color={0,0,127}));
      connect(add.y, Load2.u) annotation (Line(points={{94.4,-14},{98.15,-14},{98.15,
              -14.5},{101.9,-14.5}}, color={0,0,127}));
        annotation (Placement(transformation(extent={{140,-20},{160,0}})),
                    Placement(transformation(extent={{140,-40},{160,-20}})),
                    Placement(transformation(extent={{140,-60},{160,-40}})),
                    Placement(transformation(extent={{140,-80},{160,-60}})),
                   Diagram(coordinateSystem(preserveAspectRatio=false,
              extent={{-140,-140},{140,140}}), graphics={
            Rectangle(
              extent={{130,98},{252,-124}},
              lineColor={0,140,72},
              lineThickness=0.5),
            Rectangle(
              extent={{-160,30},{-134,-90}},
              lineColor={0,140,72},
              lineThickness=0.5),
            Rectangle(
              extent={{-128,36},{124,-124}},
              lineColor={238,46,47},
              lineThickness=0.5),
            Rectangle(
              extent={{-128,98},{124,38}},
              lineColor={0,128,255},
              lineThickness=0.5),
            Text(
              extent={{78,-106},{114,-120}},
              textColor={238,46,47},
              textString="Microgrid"),
            Text(
              extent={{76,58},{128,34}},
              textColor={28,108,200},
              textString="Utility Grid"),
            Text(
              extent={{-30,-102},{34,-124}},
              textColor={0,140,72},
              textString="Linearization Unit"),
            Text(
              extent={{-164,50},{-132,30}},
              textColor={0,140,72},
              textString="Inputs"),
            Text(
              extent={{128,118},{168,98}},
              textColor={0,140,72},
              textString="Outputs")}),
        Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),
        experiment(
          StopTime=10,
          Interval=0.0001,
          __Dymola_Algorithm="Dassl"),
        Icon(coordinateSystem(extent={{-140,-140},{140,140}})));
    end MPCAppliedEnergyOriginal;

    model MPCAppliedEnergyLinearized
      "THIS ONE IS STABLE, CONTROLLABLE, OBSERVABLE!!!!!!!"
      extends Modelica.Icons.Example;

      parameter Boolean equivalentGRID = true;
      parameter Boolean equivalentsystem = false;

      OpenIPSL.Electrical.Buses.Bus Bus1(v_0=powerFlow.powerflow.bus.V1, angle_0=
            powerFlow.powerflow.bus.A1) if not equivalentGRID
        annotation (Placement(transformation(extent={{-90,70},{-70,90}})));
      OpenIPSL.Electrical.Buses.Bus Bus2(v_0=powerFlow.powerflow.bus.V2, angle_0=
            powerFlow.powerflow.bus.A1) if not equivalentGRID
        annotation (Placement(transformation(extent={{-50,70},{-30,90}})));
      OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
        R=0.001,
        X=0.2,
        G=0,
        B=0,
        VNOM1=13800,
        VB1=13800,
        VNOM2=6000,
        VB2=6000)  if not equivalentGRID annotation (Placement(transformation(
            extent={{-8,-8},{8,8}},
            rotation=180,
            origin={-60,80})));
      OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
        enableV_b=true,
        v_0=powerFlow.powerflow.bus.V1,
        angle_0=powerFlow.powerflow.bus.A1,
        P_0=powerFlow.powerflow.machines.PG1,
        Q_0=powerFlow.powerflow.machines.QG1,
        V_b=6000)  if not equivalentGRID
        annotation (Placement(transformation(extent={{-112,70},{-92,90}})));
      OpenIPSL.Electrical.Branches.PwLine L1(
        R=0.001,
        X=0.2,
        G=0,
        B=0) if not equivalentGRID annotation (Placement(transformation(extent={{-26,76},
                {-14,84}})));
      OpenIPSL.Electrical.Buses.Bus Bus3(v_0=powerFlow.powerflow.bus.V3, angle_0=
            powerFlow.powerflow.bus.A3) if not equivalentGRID
        annotation (Placement(transformation(extent={{-10,70},{10,90}})));
      OpenIPSL.Electrical.Buses.Bus Bus4(v_0=powerFlow.powerflow.bus.V4, angle_0=
            powerFlow.powerflow.bus.V4) if not equivalentGRID
        annotation (Placement(transformation(extent={{50,70},{70,90}})));
      OpenIPSL.Electrical.Branches.PwLine L2_1(
        R=0.0005,
        X=0.1,
        G=0,
        B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,86},
                {36,94}})));
      OpenIPSL.Electrical.Branches.PwLine L2_2(
        R=0.0005,
        X=0.1,
        G=0,
        B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,66},
                {36,74}})));
      OpenIPSL.Electrical.Buses.Bus Bus5(angle_0=powerFlow.powerflow.bus.A5, v_0=
            powerFlow.powerflow.bus.V5)  annotation (Placement(
            transformation(
            extent={{-10,-10},{10,10}},
            rotation=90,
            origin={80,16})));
      OpenIPSL.Electrical.Branches.PwLine L3(
        R=0.001,
        X=0.2,
        G=0,
        B=0) if not equivalentGRID annotation (Placement(transformation(
            extent={{-6,-4},{6,4}},
            rotation=-90,
            origin={80,60})));
      OpenIPSL.Electrical.Buses.Bus Bus6(v_0=powerFlow.powerflow.bus.V6, angle_0=
            powerFlow.powerflow.bus.A6) annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={-10,10})));
      OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
        G=0,
        B=0,
        VNOM1=13800,
        VB1=13800,
        VNOM2=6000,
        VB2=6000,
        R=0.005,
        X=0.1)  annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={10,10})));
      GenerationUnits.PSSE.G2_16MVA                         G2(
        enableV_b=true,
        enableP_0=true,
        enableQ_0=true,
        v_0=powerFlow.powerflow.bus.V6,
        enablev_0=true,
        angle_0=powerFlow.powerflow.bus.A6,
        V_b=6000,
        P_0=powerFlow.powerflow.machines.PG2,
        Q_0=powerFlow.powerflow.machines.QG2,
        enableangle_0=true)
                      annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=0,
            origin={-30,10})));
      inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000, fn=60)
        annotation (Placement(transformation(extent={{-128,104},{-74,124}})));
      OpenIPSL.Electrical.Loads.PSSE.Load Load1(
        V_b=220000,
        P_0=powerFlow.powerflow.loads.PL1,
        Q_0=powerFlow.powerflow.loads.QL1,
        v_0=powerFlow.powerflow.bus.V3,
        angle_0=powerFlow.powerflow.bus.A3) if not equivalentGRID
        annotation (Placement(transformation(extent={{-20,48},{0,68}})));
      Electrical.Events.Breaker breaker(enableTrigger=false,
        t_o=0.05,
        rc_enabled=true,
        t_rc=10000)       if not equivalentGRID                     annotation (Placement(transformation(
            extent={{-4,-4},{4,4}},
            rotation=90,
            origin={80,26})));

      Modelica.Blocks.Interfaces.RealInput IN1(start=0)
        "Connector of Real input signal 2" annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=0,
            origin={-150,10}),iconTransformation(extent={{-10,-10},{10,10}}, origin={-150,10})));
      Modelica.Blocks.Sources.Constant IN11(k=0)
        annotation (Placement(transformation(extent={{-108,-2},{-96,10}})));
      Modelica.Blocks.Math.Add AddU1
        annotation (Placement(transformation(extent={{-80,0},{-60,20}})));
      Modelica.Blocks.Sources.Constant IN22(k=0)
        annotation (Placement(transformation(extent={{-108,-32},{-96,-20}})));
      Modelica.Blocks.Math.Add AddU2
        annotation (Placement(transformation(extent={{-80,-30},{-60,-10}})));
      Modelica.Blocks.Interfaces.RealInput IN2(start=0)
        "Connector of Real input signal 2"
               annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=0,
            origin={-150,-12}), iconTransformation(extent={{-10,-10},{10,10}},
              origin={-150,-12})));

      Modelica.Blocks.Interfaces.RealInput IN3(start = 0) "Connector of Real input signal 1"
        annotation (Placement(transformation(extent={{-160,-44},{-140,-24}}),
            iconTransformation(extent={{-160,-44},{-140,-24}})));
      Modelica.Blocks.Interfaces.RealInput IN4(start = 0) "Connector of Real input signal 1"
        annotation (Placement(transformation(extent={{-160,-66},{-140,-46}}),
            iconTransformation(extent={{-160,-66},{-140,-46}})));
      Modelica.Blocks.Interfaces.RealInput IN5(start = 0) "Connector of Real input signal 1"
        annotation (Placement(transformation(extent={{-160,-88},{-140,-68}}),
            iconTransformation(extent={{-160,-88},{-140,-68}})));

      Modelica.Blocks.Interfaces.RealOutput OUT1
        annotation (Placement(transformation(extent={{140,70},{160,90}})));
     Modelica.Blocks.Interfaces.RealOutput OUT2
        annotation (Placement(transformation(extent={{140,50},{160,70}})));
      Modelica.Blocks.Interfaces.RealOutput OUT3
        annotation (Placement(transformation(extent={{140,30},{160,50}})));

      PFData.PowerFlow powerFlow(redeclare record PowerFlow =
            OpenIPSL.Examples.ModelPredictiveControl.PFData.PF16)
        annotation (Placement(transformation(extent={{-68,104},{-48,124}})));
      Electrical.Machines.PSSE.GENCLS IB(
        V_b=220000,
        v_0=powerFlow.powerflow.bus.V4,
        angle_0=powerFlow.powerflow.bus.A4,
        P_0=powerFlow.powerflow.machines.Pinf,
        Q_0=powerFlow.powerflow.machines.Qinf,
        M_b=100000000,
        X_d=1) if not equivalentGRID annotation (Placement(transformation(extent={{110,70},
                {100,90}})));
      Electrical.Loads.PSSE.Load_ExtInput Load2(
        P_0=powerFlow.powerflow.loads.PL2,
        Q_0=powerFlow.powerflow.loads.QL2,
        v_0=powerFlow.powerflow.bus.V5,
        angle_0=powerFlow.powerflow.bus.A5,
        d_P=0,
        t1=100,
        d_t=1000)
        annotation (Placement(transformation(extent={{100,-30},{120,-10}})));

      inner Modelica.Blocks.Noise.GlobalSeed globalSeed(useAutomaticSeed=false,
          fixedSeed=10000)
        annotation (Placement(transformation(extent={{-42,102},{-22,122}})));

      Electrical.Buses.Bus Bus10(v_0=powerFlow.powerflow.bus.V10, angle_0=powerFlow.powerflow.bus.A10)
        annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={-10,-90})));
      Electrical.Branches.PSSE.TwoWindingTransformer          T4(
        G=0,
        B=0,
        CW=1,
        VNOM1=13800,
        VB1=13800,
        VNOM2=480,
        VB2=480,
        R=0.001,
        X=0.1)  annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={10,-90})));
      GenerationUnits.PSSE.Solar_Units.SolarMPCLocalVQControl PV(
        V_b=480,
        P_0=powerFlow.powerflow.machines.PPV,
        enableP_0=true,
        Q_0=powerFlow.powerflow.machines.QPV,
        enableQ_0=true,
        v_0=powerFlow.powerflow.bus.V8,
        enablev_0=true,
        angle_0=powerFlow.powerflow.bus.A8,
        enableangle_0=true)
        annotation (Placement(transformation(extent={{-40,-60},{-20,-40}})));
      Modelica.Blocks.Math.Add AddU3
        annotation (Placement(transformation(extent={{-80,-60},{-60,-40}})));
      Modelica.Blocks.Sources.Constant IN33(k=0)
        annotation (Placement(transformation(extent={{-108,-62},{-96,-50}})));

      Modelica.Blocks.Math.Add AddU4
        annotation (Placement(transformation(extent={{-80,-90},{-60,-70}})));
      Modelica.Blocks.Math.Add AddU5
        annotation (Placement(transformation(extent={{-80,-116},{-60,-96}})));
      Modelica.Blocks.Sources.Constant IN44(k=0)
        annotation (Placement(transformation(extent={{-108,-92},{-96,-80}})));
      Modelica.Blocks.Sources.Constant IN55(k=0)
        annotation (Placement(transformation(extent={{-108,-118},{-96,-106}})));
      Modelica.Blocks.Interfaces.RealOutput OUT4
        annotation (Placement(transformation(extent={{140,10},{160,30}})));
      Modelica.Blocks.Interfaces.RealOutput OUT5
        annotation (Placement(transformation(extent={{140,-10},{160,10}})));
      Modelica.Blocks.Interfaces.RealOutput OUT6
        annotation (Placement(transformation(extent={{140,-30},{160,-10}})));
      Modelica.Blocks.Interfaces.RealOutput OUT7
        annotation (Placement(transformation(extent={{140,-50},{160,-30}})));
      Modelica.Blocks.Interfaces.RealOutput OUT8
        annotation (Placement(transformation(extent={{140,-70},{160,-50}})));
      Modelica.Blocks.Interfaces.RealOutput OUT9
        annotation (Placement(transformation(extent={{140,-90},{160,-70}})));
      Modelica.Blocks.Interfaces.RealOutput OUT10
        annotation (Placement(transformation(extent={{140,-110},{160,-90}})));
      Modelica.Blocks.Interfaces.RealOutput OUT11
        annotation (Placement(transformation(extent={{164,70},{184,90}})));
      Modelica.Blocks.Interfaces.RealOutput OUT12
        annotation (Placement(transformation(extent={{164,50},{184,70}})));
      Modelica.Blocks.Interfaces.RealOutput OUT13
        annotation (Placement(transformation(extent={{164,30},{184,50}})));
      Modelica.Blocks.Interfaces.RealOutput OUT14
        annotation (Placement(transformation(extent={{164,10},{184,30}})));
      Modelica.Blocks.Interfaces.RealOutput OUT15
        annotation (Placement(transformation(extent={{164,-10},{184,10}})));
      Modelica.Blocks.Interfaces.RealOutput OUT16
        annotation (Placement(transformation(extent={{164,-30},{184,-10}})));
      Modelica.Blocks.Interfaces.RealOutput OUT17
        annotation (Placement(transformation(extent={{164,-50},{184,-30}})));
      Modelica.Blocks.Interfaces.RealOutput OUT18
        annotation (Placement(transformation(extent={{164,-70},{184,-50}})));
      Modelica.Blocks.Interfaces.RealOutput OUT19
        annotation (Placement(transformation(extent={{164,-90},{184,-70}})));
      Modelica.Blocks.Interfaces.RealOutput OUT20
        annotation (Placement(transformation(extent={{164,-110},{184,-90}})));
      Modelica.Blocks.Interfaces.RealOutput OUT21
        annotation (Placement(transformation(extent={{184,70},{204,90}})));
      Modelica.Blocks.Interfaces.RealOutput OUT22
        annotation (Placement(transformation(extent={{184,50},{204,70}})));
      Modelica.Blocks.Interfaces.RealOutput OUT23
        annotation (Placement(transformation(extent={{184,30},{204,50}})));
      Modelica.Blocks.Interfaces.RealOutput OUT24
        annotation (Placement(transformation(extent={{184,10},{204,30}})));
      Modelica.Blocks.Interfaces.RealOutput OUT25
        annotation (Placement(transformation(extent={{184,-10},{204,10}})));
      Modelica.Blocks.Interfaces.RealOutput OUT26
        annotation (Placement(transformation(extent={{184,-30},{204,-10}})));
      Modelica.Blocks.Interfaces.RealOutput OUT27
        annotation (Placement(transformation(extent={{184,-50},{204,-30}})));
      Modelica.Blocks.Interfaces.RealOutput OUT28
        annotation (Placement(transformation(extent={{184,-70},{204,-50}})));
      Modelica.Blocks.Interfaces.RealOutput OUT29
        annotation (Placement(transformation(extent={{184,-90},{204,-70}})));
      Modelica.Blocks.Interfaces.RealOutput OUT30
        annotation (Placement(transformation(extent={{184,-110},{204,-90}})));
      Modelica.Blocks.Interfaces.RealOutput OUT31
        annotation (Placement(transformation(extent={{204,70},{224,90}})));
      Modelica.Blocks.Interfaces.RealOutput OUT32
        annotation (Placement(transformation(extent={{204,50},{224,70}})));
      Modelica.Blocks.Interfaces.RealOutput OUT33
        annotation (Placement(transformation(extent={{204,30},{224,50}})));
      GenerationUnits.PSSE.Battery_Units.BESSMPCLocalVQControlLinearized
                                                               BESS(
        V_base=480,
        V_b(displayUnit="kV") = 480,
        enableV_b=true,
        P_0=powerFlow.powerflow.machines.PBESS,
        enableP_0=true,
        Q_0=powerFlow.powerflow.machines.QBESS,
        enableQ_0=true,
        v_0=powerFlow.powerflow.bus.V10,
        enablev_0=true,
        angle_0=powerFlow.powerflow.bus.A10,
        enableangle_0=true)
        annotation (Placement(transformation(extent={{-40,-100},{-20,-80}})));
      Modelica.Blocks.Interfaces.RealOutput OUT34
        annotation (Placement(transformation(extent={{204,10},{224,30}})));
      Modelica.Blocks.Interfaces.RealOutput OUT35
        annotation (Placement(transformation(extent={{206,-10},{226,10}})));
      Modelica.Blocks.Interfaces.RealOutput OUT36
        annotation (Placement(transformation(extent={{206,-30},{226,-10}})));
      Modelica.Blocks.Interfaces.RealOutput OUT37
        annotation (Placement(transformation(extent={{206,-50},{226,-30}})));
      Modelica.Blocks.Interfaces.RealOutput OUT38
        annotation (Placement(transformation(extent={{206,-70},{226,-50}})));
      Electrical.Buses.Bus Bus8(v_0=powerFlow.powerflow.bus.V8, angle_0=powerFlow.powerflow.bus.A8)
        annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={-10,-50})));
      Electrical.Branches.PSSE.TwoWindingTransformer          T3(
        G=0,
        B=0,
        CW=1,
        VNOM1=13800,
        VB1=13800,
        VNOM2=480,
        VB2=480,
        R=0.001,
        X=0.1)  annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={12,-50})));
      Electrical.Buses.Bus Bus11(v_0=powerFlow.powerflow.bus.V11, angle_0=powerFlow.powerflow.bus.A11)
        annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={30,-90})));
      Electrical.Buses.Bus Bus9(v_0=powerFlow.powerflow.bus.V9, angle_0=powerFlow.powerflow.bus.A9)
        annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={30,-50})));
      Electrical.Buses.Bus Bus7(v_0=powerFlow.powerflow.bus.V7, angle_0=powerFlow.powerflow.bus.A7)
        annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={30,10})));
      Electrical.Branches.PwLine          L4(
        R=0.01,
        X=0.001,
        G=0,
        B=0)  annotation (Placement(transformation(extent={{38,6},{
                50,14}})));
      Electrical.Branches.PwLine          L5(
        R=0.01,
        X=0.001,
        G=0,
        B=0)  annotation (Placement(transformation(extent={{38,-54},
                {50,-46}})));
      Electrical.Branches.PwLine          L6(
        R=0.01,
        X=0.001,
        G=0,
        B=0)  annotation (Placement(transformation(extent={{38,-94},
                {50,-86}})));
      Modelica.Blocks.Interfaces.RealOutput OUT39
        annotation (Placement(transformation(extent={{206,-90},{226,-70}})));
      Modelica.Blocks.Interfaces.RealOutput OUT40
        annotation (Placement(transformation(extent={{208,-108},{228,-88}})));
      Modelica.Blocks.Interfaces.RealOutput OUT41
        annotation (Placement(transformation(extent={{224,70},{244,90}})));
      Modelica.Blocks.Sources.Sine sine(
        amplitude=0,
        f=1/260,
        phase=3.1415926535898,
        startTime=1000)
        annotation (Placement(transformation(extent={{68,-36},{78,-26}})));
      Electrical.Loads.NoiseInjections.WhiteNoiseInjection whiteNoiseInjection(
          active_sigma=0.0000000000000001,
                                     samplePeriod=0.01)
        annotation (Placement(transformation(extent={{66,-18},{78,-6}})));
      Modelica.Blocks.Math.Add add
        annotation (Placement(transformation(extent={{84,-18},{92,-10}})));
      Modelica.Blocks.Interfaces.RealOutput OUT42
        annotation (Placement(transformation(extent={{224,50},{244,70}})));
    equation

    OUT1 = G2.gen.w;
    OUT2 = G2.gen.delta;
    OUT3 = G2.gen.Epq;
    OUT4 = G2.gen.PSIkd;
    OUT5 = G2.gen.PSIppq;
    OUT6 = G2.sEXSMPC.simpleLagLim.state;
    OUT7 = G2.sEXSMPC.leadLag.TF.x_scaled[1];
    OUT8 = G2.gASTMPC.simpleLagLim.state;
    OUT9 = G2.gASTMPC.simpleLag.state;
    OUT10 = G2.gASTMPC.simpleLag1.state;
    OUT11 = PV.rEGCA1_1.simpleLag.state;
    OUT12 = PV.rEGCA1_1.integrator.y;
    OUT13 = PV.rEGCA1_1.integrator1.y;
    OUT14 =PV.EC.IGQ.y;
    OUT15 =PV.EC.IGV.y;
    OUT16 =PV.EC.simpleLag.state;
    OUT17 =PV.EC.simpleLag1.state;
    OUT18 =PV.EC.simpleLag2.state;
    OUT19 =PV.EC.IGP.y;
    OUT20 =PV.EC.simpleLag3.state;
    OUT21 =PV.EC.simpleLag5.state;
    OUT22 = PV.EC.simpleLag4.state;
    OUT23 = BESS.rEGCA1_1.simpleLag.state;
    OUT24 = BESS.rEGCA1_1.integrator.y;
    OUT25 = BESS.rEGCA1_1.integrator1.y;
    OUT26 =BESS.EC.integrator3.y;
    OUT27 =BESS.EC.simpleLag.state;
    OUT28 =BESS.EC.IGQ.y;
    OUT29 =BESS.EC.IGV.y;
    OUT30 =BESS.EC.IGP.y;
    OUT31 =BESS.EC.simpleLag1.state;
    OUT32 =BESS.EC.simpleLag2.state;
    OUT33 =BESS.EC.simpleLag3.state;
    OUT34 =BESS.EC.simpleLag4.state;
    OUT35 = G2.gen.PMECH;
    OUT36 = G2.sEXSMPC.EFD;
    OUT37 = BESS.rEGCA1_1.Pgen;
    OUT38 = BESS.rEGCA1_1.Qgen;
    OUT39 = PV.rEGCA1_1.Pgen;
    OUT40 = PV.rEGCA1_1.Qgen;
    OUT41 = Bus5.v;
    OUT42 = Bus5.angle;

      connect(T1.p, Bus2.p)
        annotation (Line(points={{-51.2,80},{-40,80}}, color={0,0,255}));
      connect(Bus1.p, T1.n)
        annotation (Line(points={{-80,80},{-68.8,80}}, color={0,0,255}));
      connect(G1.conn, Bus1.p)
        annotation (Line(points={{-91,80},{-80,80}}, color={0,0,255}));
      connect(L1.n, Bus3.p)
        annotation (Line(points={{-14.6,80},{0,80}}, color={0,0,255}));
      connect(L1.p, Bus2.p)
        annotation (Line(points={{-25.4,80},{-40,80}}, color={0,0,255}));
      connect(L2_2.n, Bus4.p) annotation (Line(points={{35.4,70},{44,70},{44,80},{60,
              80}}, color={0,0,255}));
      connect(L2_1.n, Bus4.p) annotation (Line(points={{35.4,90},{44,90},{44,80},{60,
              80}}, color={0,0,255}));
      connect(L2_1.p, Bus3.p) annotation (Line(points={{24.6,90},{16,90},{16,80},{0,
              80}}, color={0,0,255}));
      connect(L2_2.p, Bus3.p) annotation (Line(points={{24.6,70},{16,70},{16,80},{0,
              80}}, color={0,0,255}));
      connect(Load1.p, Bus3.p)
        annotation (Line(points={{-10,68},{-10,80},{0,80}}, color={0,0,255}));
      connect(L3.p, Bus4.p)
        annotation (Line(points={{80,65.4},{80,80},{60,80}}, color={0,0,255}));
      connect(breaker.s, Bus5.p)
        annotation (Line(points={{80,22},{80,16}},color={0,0,255}));
      connect(breaker.r, L3.n)
        annotation (Line(points={{80,30},{80,54.6}},color={0,0,255}));
      connect(IN11.y, AddU1.u2) annotation (Line(points={{-95.4,4},{-82,4}},
                          color={0,0,127}));
      connect(IN1, AddU1.u1) annotation (Line(points={{-150,10},{-116,10},{-116,16},
              {-82,16}},
                     color={0,0,127}));

      connect(IN22.y,AddU2. u2) annotation (Line(points={{-95.4,-26},{-82,-26}},
                     color={0,0,127}));
      connect(IN2,AddU2. u1) annotation (Line(points={{-150,-12},{-118,-12},{-118,-14},
              {-82,-14}},
                     color={0,0,127}));
      connect(AddU2.y, G2.Efd_ref)
        annotation (Line(points={{-59,-20},{-52,-20},{-52,4},{-42,4}},
                                                               color={0,0,127}));
      connect(AddU1.y, G2.P_ref1) annotation (Line(points={{-59,10},{-52,10},{-52,16},
              {-42,16}},                          color={0,0,127}));
      connect(IB.p, Bus4.p)
        annotation (Line(points={{100,80},{60,80}}, color={0,0,255}));
      connect(Load2.p, Bus5.p) annotation (Line(points={{110,-10},{110,10},{80,10},{
              80,16}},
                   color={0,0,255}));
      connect(T4.n, Bus10.p)
        annotation (Line(points={{-1,-90},{-10,-90}}, color={0,0,255}));
      connect(Bus6.p, T2.n)
        annotation (Line(points={{-10,10},{-1,10}},
                                                color={0,0,255}));
      connect(AddU3.y, PV.QINPUT) annotation (Line(points={{-59,-50},{-42,-50}},
                               color={0,0,127}));
      connect(IN33.y,AddU3. u2)
        annotation (Line(points={{-95.4,-56},{-82,-56}}, color={0,0,127}));
      connect(BESS.p1, Bus10.p)
        annotation (Line(points={{-20,-90},{-10,-90}}, color={0,0,255}));
      connect(BESS.Paux1, AddU4.y) annotation (Line(points={{-42,-84},{-54,-84},{-54,
              -80},{-59,-80}}, color={0,0,127}));
      connect(IN55.y, AddU5.u2)
        annotation (Line(points={{-95.4,-112},{-82,-112}}, color={0,0,127}));
      connect(AddU5.y, BESS.Qext1) annotation (Line(points={{-59,-106},{-52,-106},{-52,
              -96},{-42,-96}},   color={0,0,127}));
      connect(IN44.y, AddU4.u2)
        annotation (Line(points={{-95.4,-86},{-82,-86}}, color={0,0,127}));
      connect(AddU4.u1,IN4)  annotation (Line(points={{-82,-74},{-100,-74},{-100,-70},
              {-116,-70},{-116,-56},{-150,-56}}, color={0,0,127}));
      connect(AddU5.u1,IN5)  annotation (Line(points={{-82,-100},{-116,-100},{-116,-78},
              {-150,-78}}, color={0,0,127}));
      connect(G2.conn, Bus6.p) annotation (Line(points={{-19,10},{-10,10}},
                                         color={0,0,255}));
      connect(AddU3.u1, IN3) annotation (Line(points={{-82,-44},{-118,-44},{-118,-34},
              {-150,-34}}, color={0,0,127}));
      connect(PV.p1, Bus8.p)
        annotation (Line(points={{-20,-50},{-10,-50}}, color={0,0,255}));
      connect(Bus8.p, T3.n)
        annotation (Line(points={{-10,-50},{1,-50}},  color={0,0,255}));
      connect(T2.p, Bus7.p) annotation (Line(points={{21,10},{25.5,10},{25.5,10},{30,
              10}}, color={0,0,255}));
      connect(T3.p, Bus9.p)
        annotation (Line(points={{23,-50},{30,-50}}, color={0,0,255}));
      connect(T4.p, Bus11.p)
        annotation (Line(points={{21,-90},{30,-90}}, color={0,0,255}));
      connect(L4.n, Bus5.p) annotation (Line(points={{49.4,10},{60,10},{60,10},{80,10},
              {80,16}},     color={0,0,255}));
      connect(L5.n, Bus5.p) annotation (Line(points={{49.4,-50},{60,-50},{60,10},{80,
              10},{80,16}}, color={0,0,255}));
      connect(Bus11.p, L6.p)
        annotation (Line(points={{30,-90},{38.6,-90}}, color={0,0,255}));
      connect(Bus9.p, L5.p)
        annotation (Line(points={{30,-50},{38.6,-50}}, color={0,0,255}));
      connect(L6.n, Bus5.p) annotation (Line(points={{49.4,-90},{60,-90},{60,10},{80,
              10},{80,16}}, color={0,0,255}));
      connect(Bus7.p, L4.p) annotation (Line(points={{30,10},{34.3,10},{34.3,10},{38.6,
              10}}, color={0,0,255}));
      connect(sine.y, add.u2) annotation (Line(points={{78.5,-31},{78.5,-16.4},
              {83.2,-16.4}}, color={0,0,127}));
      connect(whiteNoiseInjection.y, add.u1) annotation (Line(points={{78.54,
              -12.06},{80.87,-12.06},{80.87,-11.6},{83.2,-11.6}}, color={0,0,
              127}));
      connect(add.y, Load2.u) annotation (Line(points={{92.4,-14},{97.15,-14},
              {97.15,-14.5},{101.9,-14.5}}, color={0,0,127}));
        annotation (Placement(transformation(extent={{140,-20},{160,0}})),
                    Placement(transformation(extent={{140,-40},{160,-20}})),
                    Placement(transformation(extent={{140,-60},{160,-40}})),
                    Placement(transformation(extent={{140,-80},{160,-60}})),
                   Diagram(coordinateSystem(preserveAspectRatio=false,
              extent={{-140,-140},{140,140}}), graphics={
            Rectangle(
              extent={{130,98},{254,-124}},
              lineColor={0,140,72},
              lineThickness=0.5),
            Rectangle(
              extent={{-160,30},{-134,-90}},
              lineColor={0,140,72},
              lineThickness=0.5),
            Rectangle(
              extent={{-128,36},{124,-124}},
              lineColor={238,46,47},
              lineThickness=0.5),
            Rectangle(
              extent={{-128,98},{124,38}},
              lineColor={0,128,255},
              lineThickness=0.5),
            Text(
              extent={{78,-106},{114,-120}},
              textColor={238,46,47},
              textString="Microgrid"),
            Text(
              extent={{76,58},{128,34}},
              textColor={28,108,200},
              textString="Utility Grid"),
            Text(
              extent={{-30,-102},{34,-124}},
              textColor={0,140,72},
              textString="Linearization Unit"),
            Text(
              extent={{-164,50},{-132,30}},
              textColor={0,140,72},
              textString="Inputs"),
            Text(
              extent={{128,118},{168,98}},
              textColor={0,140,72},
              textString="Outputs")}),
        Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),
        experiment(StopTime=10, __Dymola_Algorithm="Dassl"),
        Icon(coordinateSystem(extent={{-140,-140},{140,140}})));
    end MPCAppliedEnergyLinearized;

    model MPCAppliedEnergyOriginal_TABLE
      "THIS ONE IS STABLE, CONTROLLABLE, OBSERVABLE!!!!!!!"
      extends Modelica.Icons.Example;

      parameter Boolean equivalentGRID = false;
      parameter Boolean equivalentsystem = false;

      OpenIPSL.Electrical.Buses.Bus Bus1(v_0=powerFlow.powerflow.bus.V1, angle_0=
            powerFlow.powerflow.bus.A1) if not equivalentGRID
        annotation (Placement(transformation(extent={{-90,70},{-70,90}})));
      OpenIPSL.Electrical.Buses.Bus Bus2(v_0=powerFlow.powerflow.bus.V2, angle_0=
            powerFlow.powerflow.bus.A1) if not equivalentGRID
        annotation (Placement(transformation(extent={{-50,70},{-30,90}})));
      OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
        R=0.001,
        X=0.2,
        G=0,
        B=0,
        VNOM1=13800,
        VB1=13800,
        VNOM2=6000,
        VB2=6000)  if not equivalentGRID annotation (Placement(transformation(
            extent={{-8,-8},{8,8}},
            rotation=180,
            origin={-60,80})));
      OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
        enableV_b=true,
        v_0=powerFlow.powerflow.bus.V1,
        angle_0=powerFlow.powerflow.bus.A1,
        P_0=powerFlow.powerflow.machines.PG1,
        Q_0=powerFlow.powerflow.machines.QG1,
        V_b=6000)  if not equivalentGRID
        annotation (Placement(transformation(extent={{-112,70},{-92,90}})));
      OpenIPSL.Electrical.Branches.PwLine L1(
        R=0.001,
        X=0.2,
        G=0,
        B=0) if not equivalentGRID annotation (Placement(transformation(extent={{-26,76},
                {-14,84}})));
      OpenIPSL.Electrical.Buses.Bus Bus3(v_0=powerFlow.powerflow.bus.V3, angle_0=
            powerFlow.powerflow.bus.A3) if not equivalentGRID
        annotation (Placement(transformation(extent={{-10,70},{10,90}})));
      OpenIPSL.Electrical.Buses.Bus Bus4(v_0=powerFlow.powerflow.bus.V4, angle_0=
            powerFlow.powerflow.bus.V4) if not equivalentGRID
        annotation (Placement(transformation(extent={{50,70},{70,90}})));
      OpenIPSL.Electrical.Branches.PwLine L2_1(
        R=0.0005,
        X=0.1,
        G=0,
        B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,86},
                {36,94}})));
      OpenIPSL.Electrical.Branches.PwLine L2_2(
        R=0.0005,
        X=0.1,
        G=0,
        B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,66},
                {36,74}})));
      OpenIPSL.Electrical.Buses.Bus Bus5(angle_0=powerFlow.powerflow.bus.A5, v_0=
            powerFlow.powerflow.bus.V5)  annotation (Placement(
            transformation(
            extent={{-10,-10},{10,10}},
            rotation=90,
            origin={80,16})));
      OpenIPSL.Electrical.Branches.PwLine L3(
        R=0.001,
        X=0.2,
        G=0,
        B=0) if not equivalentGRID annotation (Placement(transformation(
            extent={{-6,-4},{6,4}},
            rotation=-90,
            origin={80,60})));
      OpenIPSL.Electrical.Buses.Bus Bus6(v_0=powerFlow.powerflow.bus.V6, angle_0=
            powerFlow.powerflow.bus.A6) annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={-10,10})));
      OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
        G=0,
        B=0,
        VNOM1=13800,
        VB1=13800,
        VNOM2=6000,
        VB2=6000,
        R=0.005,
        X=0.1)  annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={10,10})));
      GenerationUnits.PSSE.G2_16MVA                         G2(
        enableV_b=true,
        enableP_0=true,
        enableQ_0=true,
        v_0=powerFlow.powerflow.bus.V6,
        enablev_0=true,
        angle_0=powerFlow.powerflow.bus.A6,
        V_b=6000,
        P_0=powerFlow.powerflow.machines.PG2,
        Q_0=powerFlow.powerflow.machines.QG2,
        enableangle_0=true)
                      annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=0,
            origin={-30,10})));
      inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000, fn=60)
        annotation (Placement(transformation(extent={{-128,104},{-74,124}})));
      OpenIPSL.Electrical.Loads.PSSE.Load Load1(
        V_b=220000,
        P_0=powerFlow.powerflow.loads.PL1,
        Q_0=powerFlow.powerflow.loads.QL1,
        v_0=powerFlow.powerflow.bus.V3,
        angle_0=powerFlow.powerflow.bus.A3) if not equivalentGRID
        annotation (Placement(transformation(extent={{-20,48},{0,68}})));
      Electrical.Events.Breaker breaker(enableTrigger=false,
        t_o=8.05,
        rc_enabled=false,
        t_rc=80.01)       if not equivalentGRID                     annotation (Placement(transformation(
            extent={{-4,-4},{4,4}},
            rotation=90,
            origin={80,26})));

      Modelica.Blocks.Interfaces.RealOutput OUT1
        annotation (Placement(transformation(extent={{140,70},{160,90}})));
     Modelica.Blocks.Interfaces.RealOutput OUT2
        annotation (Placement(transformation(extent={{140,50},{160,70}})));
      Modelica.Blocks.Interfaces.RealOutput OUT3
        annotation (Placement(transformation(extent={{140,30},{160,50}})));

      PFData.PowerFlow powerFlow(redeclare record PowerFlow =
            OpenIPSL.Examples.ModelPredictiveControl.PFData.PF16)
        annotation (Placement(transformation(extent={{-68,104},{-48,124}})));
      Electrical.Machines.PSSE.GENCLS IB(
        V_b=220000,
        v_0=powerFlow.powerflow.bus.V4,
        angle_0=powerFlow.powerflow.bus.A4,
        P_0=powerFlow.powerflow.machines.Pinf,
        Q_0=powerFlow.powerflow.machines.Qinf,
        M_b=100000000,
        X_d=1) if not equivalentGRID annotation (Placement(transformation(extent={{110,70},
                {100,90}})));
      Electrical.Loads.PSSE.Load_ExtInput Load2(
        P_0=powerFlow.powerflow.loads.PL2,
        Q_0=powerFlow.powerflow.loads.QL2,
        v_0=powerFlow.powerflow.bus.V5,
        angle_0=powerFlow.powerflow.bus.A5,
        d_P=0,
        t1=100,
        d_t=1000)
        annotation (Placement(transformation(extent={{100,-30},{120,-10}})));

      inner Modelica.Blocks.Noise.GlobalSeed globalSeed(useAutomaticSeed=false,
          fixedSeed=10000)
        annotation (Placement(transformation(extent={{-42,102},{-22,122}})));
      Modelica.Blocks.Sources.Sine sine(
        amplitude=0,
        f=1/260,
        phase=3.1415926535898,
        startTime=1000)
        annotation (Placement(transformation(extent={{70,-36},{80,-26}})));

      Electrical.Buses.Bus Bus10(v_0=powerFlow.powerflow.bus.V10, angle_0=powerFlow.powerflow.bus.A10)
        annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={-10,-90})));
      Electrical.Branches.PSSE.TwoWindingTransformer          T4(
        G=0,
        B=0,
        CW=1,
        VNOM1=13800,
        VB1=13800,
        VNOM2=480,
        VB2=480,
        R=0.001,
        X=0.1)  annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={10,-90})));
      GenerationUnits.PSSE.Solar_Units.SolarMPCLocalVQControl PV(
        V_b=480,
        P_0=powerFlow.powerflow.machines.PPV,
        enableP_0=true,
        Q_0=powerFlow.powerflow.machines.QPV,
        enableQ_0=true,
        v_0=powerFlow.powerflow.bus.V8,
        enablev_0=true,
        angle_0=powerFlow.powerflow.bus.A8,
        enableangle_0=true)
        annotation (Placement(transformation(extent={{-40,-60},{-20,-40}})));

      Modelica.Blocks.Interfaces.RealOutput OUT4
        annotation (Placement(transformation(extent={{140,10},{160,30}})));
      Modelica.Blocks.Interfaces.RealOutput OUT5
        annotation (Placement(transformation(extent={{140,-10},{160,10}})));
      Modelica.Blocks.Interfaces.RealOutput OUT6
        annotation (Placement(transformation(extent={{140,-30},{160,-10}})));
      Modelica.Blocks.Interfaces.RealOutput OUT7
        annotation (Placement(transformation(extent={{140,-50},{160,-30}})));
      Modelica.Blocks.Interfaces.RealOutput OUT8
        annotation (Placement(transformation(extent={{140,-70},{160,-50}})));
      Modelica.Blocks.Interfaces.RealOutput OUT9
        annotation (Placement(transformation(extent={{140,-90},{160,-70}})));
      Modelica.Blocks.Interfaces.RealOutput OUT10
        annotation (Placement(transformation(extent={{140,-110},{160,-90}})));
      Modelica.Blocks.Interfaces.RealOutput OUT11
        annotation (Placement(transformation(extent={{164,70},{184,90}})));
      Modelica.Blocks.Interfaces.RealOutput OUT12
        annotation (Placement(transformation(extent={{164,50},{184,70}})));
      Modelica.Blocks.Interfaces.RealOutput OUT13
        annotation (Placement(transformation(extent={{164,30},{184,50}})));
      Modelica.Blocks.Interfaces.RealOutput OUT14
        annotation (Placement(transformation(extent={{164,10},{184,30}})));
      Modelica.Blocks.Interfaces.RealOutput OUT15
        annotation (Placement(transformation(extent={{164,-10},{184,10}})));
      Modelica.Blocks.Interfaces.RealOutput OUT16
        annotation (Placement(transformation(extent={{164,-30},{184,-10}})));
      Modelica.Blocks.Interfaces.RealOutput OUT17
        annotation (Placement(transformation(extent={{164,-50},{184,-30}})));
      Modelica.Blocks.Interfaces.RealOutput OUT18
        annotation (Placement(transformation(extent={{164,-70},{184,-50}})));
      Modelica.Blocks.Interfaces.RealOutput OUT19
        annotation (Placement(transformation(extent={{164,-90},{184,-70}})));
      Modelica.Blocks.Interfaces.RealOutput OUT20
        annotation (Placement(transformation(extent={{164,-110},{184,-90}})));
      Modelica.Blocks.Interfaces.RealOutput OUT21
        annotation (Placement(transformation(extent={{184,70},{204,90}})));
      Modelica.Blocks.Interfaces.RealOutput OUT22
        annotation (Placement(transformation(extent={{184,50},{204,70}})));
      Modelica.Blocks.Interfaces.RealOutput OUT23
        annotation (Placement(transformation(extent={{184,30},{204,50}})));
      Modelica.Blocks.Interfaces.RealOutput OUT24
        annotation (Placement(transformation(extent={{184,10},{204,30}})));
      Modelica.Blocks.Interfaces.RealOutput OUT25
        annotation (Placement(transformation(extent={{184,-10},{204,10}})));
      Modelica.Blocks.Interfaces.RealOutput OUT26
        annotation (Placement(transformation(extent={{184,-30},{204,-10}})));
      Modelica.Blocks.Interfaces.RealOutput OUT27
        annotation (Placement(transformation(extent={{184,-50},{204,-30}})));
      Modelica.Blocks.Interfaces.RealOutput OUT28
        annotation (Placement(transformation(extent={{184,-70},{204,-50}})));
      Modelica.Blocks.Interfaces.RealOutput OUT29
        annotation (Placement(transformation(extent={{184,-90},{204,-70}})));
      Modelica.Blocks.Interfaces.RealOutput OUT30
        annotation (Placement(transformation(extent={{184,-110},{204,-90}})));
      Modelica.Blocks.Interfaces.RealOutput OUT31
        annotation (Placement(transformation(extent={{204,70},{224,90}})));
      Modelica.Blocks.Interfaces.RealOutput OUT32
        annotation (Placement(transformation(extent={{204,50},{224,70}})));
      Modelica.Blocks.Interfaces.RealOutput OUT33
        annotation (Placement(transformation(extent={{204,30},{224,50}})));
      GenerationUnits.PSSE.Battery_Units.BESSMPCLocalVQControl BESS(
        V_base=480,
        V_b(displayUnit="kV") = 480,
        enableV_b=true,
        P_0=powerFlow.powerflow.machines.PBESS,
        enableP_0=true,
        Q_0=powerFlow.powerflow.machines.QBESS,
        enableQ_0=true,
        v_0=powerFlow.powerflow.bus.V10,
        enablev_0=true,
        angle_0=powerFlow.powerflow.bus.A10,
        enableangle_0=true)
        annotation (Placement(transformation(extent={{-40,-100},{-20,-80}})));
      Modelica.Blocks.Interfaces.RealOutput OUT34
        annotation (Placement(transformation(extent={{204,10},{224,30}})));
      Modelica.Blocks.Interfaces.RealOutput OUT35
        annotation (Placement(transformation(extent={{206,-10},{226,10}})));
      Modelica.Blocks.Interfaces.RealOutput OUT36
        annotation (Placement(transformation(extent={{206,-30},{226,-10}})));
      Modelica.Blocks.Interfaces.RealOutput OUT37
        annotation (Placement(transformation(extent={{206,-50},{226,-30}})));
      Modelica.Blocks.Interfaces.RealOutput OUT38
        annotation (Placement(transformation(extent={{206,-70},{226,-50}})));
      Modelica.Blocks.Interfaces.RealOutput OUT39
        annotation (Placement(transformation(extent={{206,-90},{226,-70}})));
      Electrical.Buses.Bus Bus8(v_0=powerFlow.powerflow.bus.V8, angle_0=powerFlow.powerflow.bus.A8)
        annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={-10,-50})));
      Electrical.Branches.PSSE.TwoWindingTransformer          T3(
        G=0,
        B=0,
        CW=1,
        VNOM1=13800,
        VB1=13800,
        VNOM2=480,
        VB2=480,
        R=0.001,
        X=0.1)  annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={12,-50})));
      Electrical.Buses.Bus Bus11(v_0=powerFlow.powerflow.bus.V11, angle_0=powerFlow.powerflow.bus.A11)
        annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={30,-90})));
      Electrical.Buses.Bus Bus9(v_0=powerFlow.powerflow.bus.V9, angle_0=powerFlow.powerflow.bus.A9)
        annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={30,-50})));
      Electrical.Buses.Bus Bus7(v_0=powerFlow.powerflow.bus.V7, angle_0=powerFlow.powerflow.bus.A7)
        annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={30,10})));
      Electrical.Branches.PwLine          L4(
        R=0.01,
        X=0.001,
        G=0,
        B=0)  annotation (Placement(transformation(extent={{38,6},{
                50,14}})));
      Electrical.Branches.PwLine          L5(
        R=0.01,
        X=0.001,
        G=0,
        B=0)  annotation (Placement(transformation(extent={{38,-54},
                {50,-46}})));
      Electrical.Branches.PwLine          L6(
        R=0.01,
        X=0.001,
        G=0,
        B=0)  annotation (Placement(transformation(extent={{38,-94},
                {50,-86}})));
      Modelica.Blocks.Interfaces.RealOutput OUT40
        annotation (Placement(transformation(extent={{206,-110},{226,-90}})));
      Modelica.Blocks.Interfaces.RealOutput OUT41
        annotation (Placement(transformation(extent={{224,70},{244,90}})));
      Electrical.Loads.NoiseInjections.WhiteNoiseInjection whiteNoiseInjection(
          active_sigma=0.0000000001, samplePeriod=0.1)
        annotation (Placement(transformation(extent={{68,-18},{80,-6}})));
      Modelica.Blocks.Math.Add add
        annotation (Placement(transformation(extent={{86,-18},{94,-10}})));
      Modelica.Blocks.Interfaces.RealOutput OUT42
        annotation (Placement(transformation(extent={{224,50},{244,70}})));
      Modelica.Blocks.Sources.CombiTimeTable combiTimeTable(table=[0,0; 0.5,0;
            1,0; 1.5,0.01; 2,0.02; 2.5,0.03; 3,0.038866743; 3.5,0.037753418; 4,
            0.037107802; 4.5,0.037002253; 5,0.036978601; 5.5,0.036940717; 6,
            0.036891783; 6.5,0.036838558; 7,0.036783494; 7.5,0.036727613; 8,
            0.036671576; 8.5,0.036615857; 9,0.036560784; 9.5,0.036506575; 10,
            0.036453372; 10.5,0.036401264; 11,0.036350303; 11.5,0.036300516; 12,
            0.036251911; 12.5,0.036204487; 13,0.036205816; 13.5,0.036165179; 14,
            0.036100279; 14.5,0.036026731; 15,0.035950076; 15.5,0.035872445; 16,
            0.035794958; 16.5,0.035718269; 17,0.03564276; 17.5,0.035568647; 18,
            0.035496054; 18.5,0.035425046; 19,0.035355653; 19.5,0.035287881; 20,
            0.035221723; 20.5,0.035157162; 21,0.035094174], smoothness=Modelica.Blocks.Types.Smoothness.ConstantSegments)
        annotation (Placement(transformation(extent={{-98,6},{-78,26}})));
      Modelica.Blocks.Sources.CombiTimeTable combiTimeTable1(table=[0,0; 0.5,0;
            1,0; 1.5,-0.01; 2,-0.019403796; 2.5,-0.015015564; 3,-0.006630538;
            3.5,0.000448858; 4,0.005655098; 4.5,0.00953237; 5,0.012513723; 5.5,
            0.014870511; 6,0.016783628; 6.5,0.018379301; 7,0.019746297; 7.5,
            0.020946948; 8,0.022025012; 8.5,0.023011249; 9,0.023927323; 9.5,
            0.024788538; 10,0.025605744; 10.5,0.026386672; 11,0.027136872; 11.5,
            0.027860361; 12,0.02856008; 12.5,0.029238219; 13,0.029713182; 13.5,
            0.030025595; 14,0.030212236; 14.5,0.030303839; 15,0.030325643; 15.5,
            0.030297179; 16,0.030233092; 16.5,0.030144187; 17,0.03003836; 17.5,
            0.029921336; 18,0.029797245; 18.5,0.029669051; 19,0.029538871; 19.5,
            0.029408206; 20,0.029278116; 20.5,0.029149341; 21,0.029022391],
          smoothness=Modelica.Blocks.Types.Smoothness.ConstantSegments)
        annotation (Placement(transformation(extent={{-98,-20},{-78,0}})));
      Modelica.Blocks.Sources.CombiTimeTable combiTimeTable2(table=[0,0; 0.5,0;
            1,0; 1.5,0.01; 2,0.003467729; 2.5,0.00193645; 3,0.001766902; 3.5,
            0.002546846; 4,0.003888495; 4.5,0.005526485; 5,0.007337952; 5.5,
            0.009253813; 6,0.011226833; 6.5,0.013223775; 7,0.015221652; 7.5,
            0.017204785; 8,0.019162611; 8.5,0.021088128; 9,0.022976813; 9.5,
            0.024825867; 10,0.026633689; 10.5,0.028399504; 11,0.030123108; 11.5,
            0.031804685; 12,0.033444686; 12.5,0.035043737; 13,0.035868876; 13.5,
            0.036277836; 14,0.036483454; 14.5,0.036588736; 15,0.036644418; 15.5,
            0.036675573; 16,0.036694567; 16.5,0.036707491; 17,0.036717347; 17.5,
            0.036725612; 18,0.036733013; 18.5,0.036739911; 19,0.036746483; 19.5,
            0.036752818; 20,0.036758959; 20.5,0.036764932; 21,0.036770748],
          smoothness=Modelica.Blocks.Types.Smoothness.ConstantSegments)
        annotation (Placement(transformation(extent={{-98,-48},{-78,-28}})));
      Modelica.Blocks.Sources.CombiTimeTable combiTimeTable3(table=[0,0; 0.5,0;
            1,0; 1.5,0.049405385; 2,0.024119186; 2.5,0.025918531; 3,0.024962863;
            3.5,0.024409993; 4,0.024302432; 4.5,0.024294339; 5,0.024290294; 5.5,
            0.024285185; 6,0.024281474; 6.5,0.024279358; 7,0.024278379; 7.5,
            0.024278162; 8,0.02427846; 8.5,0.024279106; 9,0.024279984; 9.5,
            0.024281014; 10,0.024282139; 10.5,0.024283321; 11,0.024284532; 11.5,
            0.024285754; 12,0.024286973; 12.5,0.024288182; 13,0.024301127; 13.5,
            0.024302225; 14,0.024305414; 14.5,0.024310561; 15,0.024316785; 15.5,
            0.024323536; 16,0.024330526; 16.5,0.024337598; 17,0.02434466; 17.5,
            0.024351657; 18,0.024358555; 18.5,0.024365332; 19,0.024371977; 19.5,
            0.024378481; 20,0.024384841; 20.5,0.024391055; 21,0.024397122],
          smoothness=Modelica.Blocks.Types.Smoothness.ConstantSegments)
        annotation (Placement(transformation(extent={{-98,-94},{-78,-74}})));
      Modelica.Blocks.Sources.CombiTimeTable combiTimeTable4(table=[0,0; 0.5,0;
            1,0; 1.5,0.000922072; 2,-0.002003474; 2.5,-0.000623297; 3,-0.001029937;
            3.5,-0.002167308; 4,-0.003618844; 4.5,-0.005313508; 5,-0.007180519;
            5.5,-0.009152941; 6,-0.011181594; 6.5,-0.01323276; 7,-0.015283462;
            7.5,-0.017318074; 8,-0.019326068; 8.5,-0.021300474; 9,-0.023236801;
            9.5,-0.02513228; 10,-0.026985341; 10.5,-0.028795238; 11,-0.030561796;
            11.5,-0.032285229; 12,-0.033966015; 12.5,-0.035604807; 13,-0.036444876;
            13.5,-0.03686358; 14,-0.037073175; 14.5,-0.037178802; 15,-0.037232902;
            15.5,-0.037261466; 16,-0.037277341; 16.5,-0.037286874; 17,-0.037293207;
            17.5,-0.037297902; 18,-0.037301735; 18.5,-0.037305093; 19,-0.037308174;
            19.5,-0.037311076; 20,-0.037313851; 20.5,-0.037316528; 21,-0.037319122],
          smoothness=Modelica.Blocks.Types.Smoothness.ConstantSegments)
        annotation (Placement(transformation(extent={{-98,-120},{-78,-100}})));
    equation

    // OUT1 = G2.gen.w;
    // OUT2 = G2.gen.delta;
    // OUT3 = G2.gen.Epq;
    // OUT4 = G2.gen.PSIkd;
    // OUT5 = G2.gen.PSIppq;
    // OUT6 = G2.sEXSMPC.simpleLagLim.state;
    // OUT7 = G2.sEXSMPC.leadLag.TF.x_scaled[1];
    // OUT8 = G2.gASTMPC.simpleLagLim.state;
    // OUT9 = G2.gASTMPC.simpleLag.state;
    // OUT10 = G2.gASTMPC.simpleLag1.state;
    // OUT11 = PV.rEGCA1_1.simpleLag.state;
    // OUT12 = PV.rEGCA1_1.integrator.y;
    // OUT13 = PV.rEGCA1_1.integrator1.y;
    // OUT14 =PV.EC.IGQ.y;
    // OUT15 =PV.EC.IGV.y;
    // OUT16 =PV.EC.simpleLag.state;
    // OUT17 =PV.EC.simpleLag1.state;
    // OUT18 =PV.EC.simpleLag2.state;
    // OUT19 =PV.EC.IGP.y;
    // OUT20 =PV.EC.simpleLag3.state;
    // OUT21 =PV.EC.simpleLag4.state;
    // OUT22 =PV.EC.simpleLag5.state;
    // OUT23 = BESS.rEGCA1_1.simpleLag.state;
    // OUT24 = BESS.rEGCA1_1.integrator.y;
    // OUT25 = BESS.rEGCA1_1.integrator1.y;
    // OUT26 =BESS.EC.integrator3.y;
    // OUT27 =BESS.EC.integrator1.y;
    // OUT28 =BESS.EC.simpleLag.state;
    // OUT29 =BESS.EC.IGQ.y;
    // OUT30 =BESS.EC.IGV.y;
    // OUT31 =BESS.EC.IGP.y;
    // OUT32 =BESS.EC.simpleLag1.state;
    // OUT33 =BESS.EC.simpleLag2.state;
    // OUT34 =BESS.EC.simpleLag3.state;
    // OUT35 =BESS.EC.simpleLag4.state;
    // OUT36 = G2.gen.PMECH;
    // OUT37 = G2.sEXSMPC.EFD;
    // OUT38 = BESS.rEGCA1_1.Pgen;
    // OUT39 = BESS.rEGCA1_1.Qgen;
    // OUT40 = PV.rEGCA1_1.Pgen;
    // OUT41 = PV.rEGCA1_1.Qgen;
    // OUT42 = Bus5.v;
    // OUT43 = Bus5.angle;

    OUT1 = G2.gen.w;
    OUT2 = G2.gen.delta;
    OUT3 = G2.gen.Epq;
    OUT4 = G2.gen.PSIkd;
    OUT5 = G2.gen.PSIppq;
    OUT6 = G2.sEXSMPC.simpleLagLim.state;
    OUT7 = G2.sEXSMPC.leadLag.TF.x_scaled[1];
    OUT8 = G2.gASTMPC.simpleLagLim.state;
    OUT9 = G2.gASTMPC.simpleLag.state;
    OUT10 = G2.gASTMPC.simpleLag1.state;
    OUT11 = PV.rEGCA1_1.simpleLag.state;
    OUT12 = PV.rEGCA1_1.integrator.y;
    OUT13 = PV.rEGCA1_1.integrator1.y;
    OUT14 =PV.EC.IGQ.y;
    OUT15 =PV.EC.IGV.y;
    OUT16 =PV.EC.simpleLag.state;
    OUT17 =PV.EC.simpleLag1.state;
    OUT18 =PV.EC.simpleLag2.state;
    OUT19 =PV.EC.IGP.y;
    OUT20 =PV.EC.simpleLag3.state;
    OUT21 =PV.EC.simpleLag5.state;
    OUT22 = PV.EC.simpleLag4.state;
    OUT23 = BESS.rEGCA1_1.simpleLag.state;
    OUT24 = BESS.rEGCA1_1.integrator.y;
    OUT25 = BESS.rEGCA1_1.integrator1.y;
    OUT26 =BESS.EC.integrator3.y;
    OUT27 =BESS.EC.simpleLag.state;
    OUT28 =BESS.EC.IGQ.y;
    OUT29 =BESS.EC.IGV.y;
    OUT30 =BESS.EC.IGP.y;
    OUT31 =BESS.EC.simpleLag1.state;
    OUT32 =BESS.EC.simpleLag2.state;
    OUT33 =BESS.EC.simpleLag3.state;
    OUT34 =BESS.EC.simpleLag4.state;
    OUT35 = G2.gen.PMECH;
    OUT36 = G2.sEXSMPC.EFD;
    OUT37 = BESS.rEGCA1_1.Pgen;
    OUT38 = BESS.rEGCA1_1.Qgen;
    OUT39 = PV.rEGCA1_1.Pgen;
    OUT40 = PV.rEGCA1_1.Qgen;
    OUT41 = Bus5.v;
    OUT42 = Bus5.angle;

      connect(T1.p, Bus2.p)
        annotation (Line(points={{-51.2,80},{-40,80}}, color={0,0,255}));
      connect(Bus1.p, T1.n)
        annotation (Line(points={{-80,80},{-68.8,80}}, color={0,0,255}));
      connect(G1.conn, Bus1.p)
        annotation (Line(points={{-91,80},{-80,80}}, color={0,0,255}));
      connect(L1.n, Bus3.p)
        annotation (Line(points={{-14.6,80},{0,80}}, color={0,0,255}));
      connect(L1.p, Bus2.p)
        annotation (Line(points={{-25.4,80},{-40,80}}, color={0,0,255}));
      connect(L2_2.n, Bus4.p) annotation (Line(points={{35.4,70},{44,70},{44,80},{60,
              80}}, color={0,0,255}));
      connect(L2_1.n, Bus4.p) annotation (Line(points={{35.4,90},{44,90},{44,80},{60,
              80}}, color={0,0,255}));
      connect(L2_1.p, Bus3.p) annotation (Line(points={{24.6,90},{16,90},{16,80},{0,
              80}}, color={0,0,255}));
      connect(L2_2.p, Bus3.p) annotation (Line(points={{24.6,70},{16,70},{16,80},{0,
              80}}, color={0,0,255}));
      connect(Load1.p, Bus3.p)
        annotation (Line(points={{-10,68},{-10,80},{0,80}}, color={0,0,255}));
      connect(L3.p, Bus4.p)
        annotation (Line(points={{80,65.4},{80,80},{60,80}}, color={0,0,255}));
      connect(breaker.s, Bus5.p)
        annotation (Line(points={{80,22},{80,16}},color={0,0,255}));
      connect(breaker.r, L3.n)
        annotation (Line(points={{80,30},{80,54.6}},color={0,0,255}));

      connect(IB.p, Bus4.p)
        annotation (Line(points={{100,80},{60,80}}, color={0,0,255}));
      connect(Load2.p, Bus5.p) annotation (Line(points={{110,-10},{110,10},{80,10},{
              80,16}},
                   color={0,0,255}));
      connect(T4.n, Bus10.p)
        annotation (Line(points={{-1,-90},{-10,-90}}, color={0,0,255}));
      connect(Bus6.p, T2.n)
        annotation (Line(points={{-10,10},{-1,10}},
                                                color={0,0,255}));
      connect(BESS.p1, Bus10.p)
        annotation (Line(points={{-20,-90},{-10,-90}}, color={0,0,255}));
      connect(G2.conn, Bus6.p) annotation (Line(points={{-19,10},{-10,10}},
                                         color={0,0,255}));
      connect(PV.p1, Bus8.p)
        annotation (Line(points={{-20,-50},{-10,-50}}, color={0,0,255}));
      connect(Bus8.p, T3.n)
        annotation (Line(points={{-10,-50},{1,-50}},  color={0,0,255}));
      connect(T2.p, Bus7.p) annotation (Line(points={{21,10},{25.5,10},{25.5,10},{30,
              10}}, color={0,0,255}));
      connect(T3.p, Bus9.p)
        annotation (Line(points={{23,-50},{30,-50}}, color={0,0,255}));
      connect(T4.p, Bus11.p)
        annotation (Line(points={{21,-90},{30,-90}}, color={0,0,255}));
      connect(L4.n, Bus5.p) annotation (Line(points={{49.4,10},{60,10},{60,10},{80,10},
              {80,16}},     color={0,0,255}));
      connect(L5.n, Bus5.p) annotation (Line(points={{49.4,-50},{60,-50},{60,10},{80,
              10},{80,16}}, color={0,0,255}));
      connect(Bus11.p, L6.p)
        annotation (Line(points={{30,-90},{38.6,-90}}, color={0,0,255}));
      connect(Bus9.p, L5.p)
        annotation (Line(points={{30,-50},{38.6,-50}}, color={0,0,255}));
      connect(L6.n, Bus5.p) annotation (Line(points={{49.4,-90},{60,-90},{60,10},{80,
              10},{80,16}}, color={0,0,255}));
      connect(Bus7.p, L4.p) annotation (Line(points={{30,10},{34.3,10},{34.3,10},{38.6,
              10}}, color={0,0,255}));
      connect(sine.y, add.u2) annotation (Line(points={{80.5,-31},{85.2,-31},{85.2,-16.4}},
            color={0,0,127}));
      connect(whiteNoiseInjection.y, add.u1) annotation (Line(points={{80.54,-12.06},
              {82.87,-12.06},{82.87,-11.6},{85.2,-11.6}}, color={0,0,127}));
      connect(add.y, Load2.u) annotation (Line(points={{94.4,-14},{98.15,-14},{98.15,
              -14.5},{101.9,-14.5}}, color={0,0,127}));
      connect(combiTimeTable.y[1], G2.P_ref1)
        annotation (Line(points={{-77,16},{-42,16}}, color={0,0,127}));
      connect(combiTimeTable1.y[1], G2.Efd_ref) annotation (Line(points={{-77,
              -10},{-52,-10},{-52,4},{-42,4}}, color={0,0,127}));
      connect(combiTimeTable2.y[1], PV.QINPUT) annotation (Line(points={{-77,
              -38},{-50,-38},{-50,-50},{-42,-50}}, color={0,0,127}));
      connect(combiTimeTable3.y[1], BESS.Paux1)
        annotation (Line(points={{-77,-84},{-42,-84}}, color={0,0,127}));
      connect(combiTimeTable4.y[1], BESS.Qext1) annotation (Line(points={{-77,
              -110},{-52,-110},{-52,-96},{-42,-96}}, color={0,0,127}));
        annotation (Placement(transformation(extent={{140,-20},{160,0}})),
                    Placement(transformation(extent={{140,-40},{160,-20}})),
                    Placement(transformation(extent={{140,-60},{160,-40}})),
                    Placement(transformation(extent={{140,-80},{160,-60}})),
                   Diagram(coordinateSystem(preserveAspectRatio=false,
              extent={{-140,-140},{140,140}}), graphics={
            Rectangle(
              extent={{130,98},{252,-124}},
              lineColor={0,140,72},
              lineThickness=0.5),
            Rectangle(
              extent={{-128,98},{124,38}},
              lineColor={0,128,255},
              lineThickness=0.5),
            Text(
              extent={{78,-106},{114,-120}},
              textColor={238,46,47},
              textString="Microgrid"),
            Text(
              extent={{76,58},{128,34}},
              textColor={28,108,200},
              textString="Utility Grid"),
            Text(
              extent={{-30,-102},{34,-124}},
              textColor={0,140,72},
              textString="Linearization Unit"),
            Text(
              extent={{128,118},{168,98}},
              textColor={0,140,72},
              textString="Outputs")}),
        Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),
        experiment(
          StopTime=10,
          Interval=0.0001,
          __Dymola_Algorithm="Dassl"),
        Icon(coordinateSystem(extent={{-140,-140},{140,140}})));
    end MPCAppliedEnergyOriginal_TABLE;

    model Microgrid_with_simplified_renewable_Signal_Generator_Kalman_Filter
      "THIS ONE IS STABLE, CONTROLLABLE, OBSERVABLE!!!!!!!"
      extends Modelica.Icons.Example;

      parameter Boolean equivalentGRID = true;
      parameter Boolean equivalentsystem = false;

      OpenIPSL.Electrical.Buses.Bus Bus1(v_0=powerFlow.powerflow.bus.V1, angle_0=
            powerFlow.powerflow.bus.A1) if not equivalentGRID
        annotation (Placement(transformation(extent={{-90,70},{-70,90}})));
      OpenIPSL.Electrical.Buses.Bus Bus2(v_0=powerFlow.powerflow.bus.V2, angle_0=
            powerFlow.powerflow.bus.A1) if not equivalentGRID
        annotation (Placement(transformation(extent={{-50,70},{-30,90}})));
      OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
        R=0.001,
        X=0.2,
        G=0,
        B=0,
        VNOM1=13800,
        VB1=13800,
        VNOM2=6000,
        VB2=6000)  if not equivalentGRID annotation (Placement(transformation(
            extent={{-8,-8},{8,8}},
            rotation=180,
            origin={-60,80})));
      OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
        enableV_b=true,
        v_0=powerFlow.powerflow.bus.V1,
        angle_0=powerFlow.powerflow.bus.A1,
        P_0=powerFlow.powerflow.machines.PG1,
        Q_0=powerFlow.powerflow.machines.QG1,
        V_b=6000)  if not equivalentGRID
        annotation (Placement(transformation(extent={{-112,70},{-92,90}})));
      OpenIPSL.Electrical.Branches.PwLine L1(
        R=0.001,
        X=0.2,
        G=0,
        B=0) if not equivalentGRID annotation (Placement(transformation(extent={{-26,76},
                {-14,84}})));
      OpenIPSL.Electrical.Buses.Bus Bus3(v_0=powerFlow.powerflow.bus.V3, angle_0=
            powerFlow.powerflow.bus.A3) if not equivalentGRID
        annotation (Placement(transformation(extent={{-10,70},{10,90}})));
      OpenIPSL.Electrical.Buses.Bus Bus4(v_0=powerFlow.powerflow.bus.V4, angle_0=
            powerFlow.powerflow.bus.V4) if not equivalentGRID
        annotation (Placement(transformation(extent={{50,70},{70,90}})));
      OpenIPSL.Electrical.Branches.PwLine L2_1(
        R=0.0005,
        X=0.1,
        G=0,
        B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,86},
                {36,94}})));
      OpenIPSL.Electrical.Branches.PwLine L2_2(
        R=0.0005,
        X=0.1,
        G=0,
        B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,66},
                {36,74}})));
      OpenIPSL.Electrical.Buses.Bus Bus5(angle_0=powerFlow.powerflow.bus.A5, v_0=
            powerFlow.powerflow.bus.V5)  annotation (Placement(
            transformation(
            extent={{-10,-10},{10,10}},
            rotation=90,
            origin={80,16})));
      OpenIPSL.Electrical.Branches.PwLine L3(
        R=0.001,
        X=0.2,
        G=0,
        B=0) if not equivalentGRID annotation (Placement(transformation(
            extent={{-6,-4},{6,4}},
            rotation=-90,
            origin={80,60})));
      OpenIPSL.Electrical.Buses.Bus Bus6(v_0=powerFlow.powerflow.bus.V6, angle_0=
            powerFlow.powerflow.bus.A6) annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={-10,10})));
      OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
        G=0,
        B=0,
        VNOM1=13800,
        VB1=13800,
        VNOM2=6000,
        VB2=6000,
        R=0.005,
        X=0.1)  annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={10,10})));
      GenerationUnits.PSSE.G2_16MVA                         G2(
        enableV_b=true,
        enableP_0=true,
        enableQ_0=true,
        v_0=powerFlow.powerflow.bus.V6,
        enablev_0=true,
        angle_0=powerFlow.powerflow.bus.A6,
        V_b=6000,
        P_0=powerFlow.powerflow.machines.PG2,
        Q_0=powerFlow.powerflow.machines.QG2,
        enableangle_0=true)
                      annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=0,
            origin={-30,10})));
      inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000, fn=60)
        annotation (Placement(transformation(extent={{-128,104},{-74,124}})));
      OpenIPSL.Electrical.Loads.PSSE.Load Load1(
        V_b=220000,
        P_0=powerFlow.powerflow.loads.PL1,
        Q_0=powerFlow.powerflow.loads.QL1,
        v_0=powerFlow.powerflow.bus.V3,
        angle_0=powerFlow.powerflow.bus.A3) if not equivalentGRID
        annotation (Placement(transformation(extent={{-20,48},{0,68}})));
      Electrical.Events.Breaker breaker(enableTrigger=false,
        t_o=0.5,
        rc_enabled=true,
        t_rc=10000)       if not equivalentGRID                     annotation (Placement(transformation(
            extent={{-4,-4},{4,4}},
            rotation=90,
            origin={80,26})));

      PFData.PowerFlow powerFlow(redeclare record PowerFlow =
            OpenIPSL.Examples.ModelPredictiveControl.PFData.PF16)
        annotation (Placement(transformation(extent={{-68,104},{-48,124}})));
      Electrical.Machines.PSSE.GENCLS IB(
        V_b=220000,
        v_0=powerFlow.powerflow.bus.V4,
        angle_0=powerFlow.powerflow.bus.A4,
        P_0=powerFlow.powerflow.machines.Pinf,
        Q_0=powerFlow.powerflow.machines.Qinf,
        M_b=100000000,
        X_d=1) if not equivalentGRID annotation (Placement(transformation(extent={{110,70},
                {100,90}})));
      Electrical.Loads.PSSE.Load_ExtInput Load2(
        P_0=powerFlow.powerflow.loads.PL2,
        Q_0=powerFlow.powerflow.loads.QL2,
        v_0=powerFlow.powerflow.bus.V5,
        angle_0=powerFlow.powerflow.bus.A5,
        d_P=0,
        t1=100,
        d_t=1000)
        annotation (Placement(transformation(extent={{100,-30},{120,-10}})));

      inner Modelica.Blocks.Noise.GlobalSeed globalSeed(useAutomaticSeed=false,
          fixedSeed=10000)
        annotation (Placement(transformation(extent={{-42,102},{-22,122}})));

      Electrical.Buses.Bus Bus10(v_0=powerFlow.powerflow.bus.V10, angle_0=powerFlow.powerflow.bus.A10)
        annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={-10,-90})));
      Electrical.Branches.PSSE.TwoWindingTransformer          T4(
        G=0,
        B=0,
        CW=1,
        VNOM1=13800,
        VB1=13800,
        VNOM2=480,
        VB2=480,
        R=0.001,
        X=0.1)  annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={10,-90})));
      GenerationUnits.PSSE.Solar_Units.SolarMPCSysIdentification
                                                              PV(
        V_b=480,
        P_0=powerFlow.powerflow.machines.PPV,
        enableP_0=true,
        Q_0=powerFlow.powerflow.machines.QPV,
        enableQ_0=true,
        v_0=powerFlow.powerflow.bus.V8,
        enablev_0=true,
        angle_0=powerFlow.powerflow.bus.A8,
        enableangle_0=true)
        annotation (Placement(transformation(extent={{-40,-60},{-20,-40}})));

      GenerationUnits.PSSE.Battery_Units.BESSMPCSysIdentification
                                                               BESS(
        V_base=480,
        V_b(displayUnit="kV") = 480,
        enableV_b=true,
        P_0=powerFlow.powerflow.machines.PBESS,
        enableP_0=true,
        Q_0=powerFlow.powerflow.machines.QBESS,
        enableQ_0=true,
        v_0=powerFlow.powerflow.bus.V10,
        enablev_0=true,
        angle_0=powerFlow.powerflow.bus.A10,
        enableangle_0=true)
        annotation (Placement(transformation(extent={{-40,-100},{-20,-80}})));
      Electrical.Buses.Bus Bus8(v_0=powerFlow.powerflow.bus.V8, angle_0=powerFlow.powerflow.bus.A8)
        annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={-10,-50})));
      Electrical.Branches.PSSE.TwoWindingTransformer          T3(
        G=0,
        B=0,
        CW=1,
        VNOM1=13800,
        VB1=13800,
        VNOM2=480,
        VB2=480,
        R=0.001,
        X=0.1)  annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={12,-50})));
      Electrical.Buses.Bus Bus11(v_0=powerFlow.powerflow.bus.V11, angle_0=powerFlow.powerflow.bus.A11)
        annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={30,-90})));
      Electrical.Buses.Bus Bus9(v_0=powerFlow.powerflow.bus.V9, angle_0=powerFlow.powerflow.bus.A9)
        annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={30,-50})));
      Electrical.Buses.Bus Bus7(v_0=powerFlow.powerflow.bus.V7, angle_0=powerFlow.powerflow.bus.A7)
        annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={30,10})));
      Electrical.Branches.PwLine          L4(
        R=0.01,
        X=0.001,
        G=0,
        B=0)  annotation (Placement(transformation(extent={{38,6},{
                50,14}})));
      Electrical.Branches.PwLine          L5(
        R=0.01,
        X=0.001,
        G=0,
        B=0)  annotation (Placement(transformation(extent={{38,-54},
                {50,-46}})));
      Electrical.Branches.PwLine          L6(
        R=0.01,
        X=0.001,
        G=0,
        B=0)  annotation (Placement(transformation(extent={{38,-94},
                {50,-86}})));
      Modelica.Blocks.Sources.Sine sine(
        amplitude=0,
        f=1/260,
        phase=3.1415926535898,
        startTime=1000)
        annotation (Placement(transformation(extent={{68,-36},{78,-26}})));
      Electrical.Loads.NoiseInjections.WhiteNoiseInjection whiteNoiseInjection(
          active_sigma=0.0000000001, samplePeriod=0.01)
        annotation (Placement(transformation(extent={{66,-18},{78,-6}})));
      Modelica.Blocks.Math.Add add
        annotation (Placement(transformation(extent={{84,-18},{92,-10}})));
      Modelica.Blocks.Interfaces.RealOutput OUT1
        annotation (Placement(transformation(extent={{140,70},{160,90}})));
     Modelica.Blocks.Interfaces.RealOutput OUT2
        annotation (Placement(transformation(extent={{140,50},{160,70}})));
      Modelica.Blocks.Interfaces.RealOutput OUT3
        annotation (Placement(transformation(extent={{140,30},{160,50}})));
      Modelica.Blocks.Interfaces.RealOutput OUT4
        annotation (Placement(transformation(extent={{140,10},{160,30}})));
      Modelica.Blocks.Interfaces.RealOutput OUT5
        annotation (Placement(transformation(extent={{140,-10},{160,10}})));
      Modelica.Blocks.Interfaces.RealOutput OUT6
        annotation (Placement(transformation(extent={{140,-30},{160,-10}})));
      Modelica.Blocks.Interfaces.RealOutput OUT7
        annotation (Placement(transformation(extent={{140,-50},{160,-30}})));
      Modelica.Blocks.Interfaces.RealOutput OUT8
        annotation (Placement(transformation(extent={{140,-70},{160,-50}})));
      Modelica.Blocks.Interfaces.RealOutput OUT9
        annotation (Placement(transformation(extent={{140,-90},{160,-70}})));
      Modelica.Blocks.Interfaces.RealOutput OUT10
        annotation (Placement(transformation(extent={{140,-110},{160,-90}})));
      Modelica.Blocks.Interfaces.RealOutput OUT11
        annotation (Placement(transformation(extent={{164,70},{184,90}})));
      Modelica.Blocks.Interfaces.RealOutput OUT12
        annotation (Placement(transformation(extent={{164,50},{184,70}})));
      Modelica.Blocks.Interfaces.RealOutput OUT13
        annotation (Placement(transformation(extent={{164,30},{184,50}})));
      Modelica.Blocks.Interfaces.RealOutput OUT14
        annotation (Placement(transformation(extent={{164,10},{184,30}})));
      Modelica.Blocks.Interfaces.RealOutput OUT15
        annotation (Placement(transformation(extent={{164,-10},{184,10}})));
      Modelica.Blocks.Interfaces.RealOutput OUT16
        annotation (Placement(transformation(extent={{164,-30},{184,-10}})));
      Modelica.Blocks.Interfaces.RealOutput OUT17
        annotation (Placement(transformation(extent={{164,-50},{184,-30}})));
      Modelica.Blocks.Interfaces.RealOutput OUT18
        annotation (Placement(transformation(extent={{164,-70},{184,-50}})));
      Modelica.Blocks.Interfaces.RealOutput OUT19
        annotation (Placement(transformation(extent={{164,-90},{184,-70}})));
      Modelica.Blocks.Interfaces.RealOutput OUT20
        annotation (Placement(transformation(extent={{164,-110},{184,-90}})));
      Modelica.Blocks.Interfaces.RealOutput OUT21
        annotation (Placement(transformation(extent={{184,70},{204,90}})));
      Modelica.Blocks.Interfaces.RealOutput OUT22
        annotation (Placement(transformation(extent={{184,50},{204,70}})));
      Modelica.Blocks.Interfaces.RealOutput OUT23
        annotation (Placement(transformation(extent={{184,30},{204,50}})));
      Modelica.Blocks.Interfaces.RealOutput OUT24
        annotation (Placement(transformation(extent={{184,10},{204,30}})));
      Modelica.Blocks.Interfaces.RealOutput OUT25
        annotation (Placement(transformation(extent={{184,-10},{204,10}})));
      Modelica.Blocks.Sources.CombiTimeTable combiTimeTable(table=[0,0; 0.5,0; 0.51,
            0.01; 5,0.01], smoothness=Modelica.Blocks.Types.Smoothness.ConstantSegments)
        annotation (Placement(transformation(extent={{-122,6},{-102,26}})));
      Modelica.Blocks.Sources.CombiTimeTable combiTimeTable1(table=[0,0; 0.5,0; 0.51,
            0.01; 5,0.01], smoothness=Modelica.Blocks.Types.Smoothness.ConstantSegments)
        annotation (Placement(transformation(extent={{-122,-20},{-102,0}})));
      Modelica.Blocks.Sources.CombiTimeTable combiTimeTable2(table=[0,0; 0.5,0; 0.51,
            0.01; 5,0.01], smoothness=Modelica.Blocks.Types.Smoothness.ConstantSegments)
        annotation (Placement(transformation(extent={{-122,-48},{-102,-28}})));
      Modelica.Blocks.Sources.CombiTimeTable combiTimeTable3(table=[0,0; 0.5,0; 0.51,
            0.05; 5,0.05], smoothness=Modelica.Blocks.Types.Smoothness.ConstantSegments)
        annotation (Placement(transformation(extent={{-122,-94},{-102,-74}})));
      Modelica.Blocks.Sources.CombiTimeTable combiTimeTable4(table=[0,0; 0.5,0; 0.51,
            0.05; 5,0.05], smoothness=Modelica.Blocks.Types.Smoothness.ConstantSegments)
        annotation (Placement(transformation(extent={{-122,-120},{-102,-100}})));
    equation

    OUT1 = G2.gen.w;
    OUT2 = G2.gen.delta;
    OUT3 = G2.gen.Epq;
    OUT4 = G2.gen.PSIkd;
    OUT5 = G2.gen.PSIppq;
    OUT6 = G2.sEXSMPC.simpleLagLim.state;
    OUT7 = G2.sEXSMPC.leadLag.TF.x_scaled[1];
    OUT8 = G2.gASTMPC.simpleLagLim.state;
    OUT9 = G2.gASTMPC.simpleLag.state;
    OUT10 = G2.gASTMPC.simpleLag1.state;

    // OUT1 = G2.gen.w;
    // OUT2 = G2.gen.delta;
    // OUT3 = G2.gen.P;
    // OUT4 = G2.gen.Q;
    // OUT5 = G2.gen.p.ir;
    // OUT6 = G2.gen.p.ii;
    // OUT7 = G2.gen.PMECH;
    // OUT8 = G2.sEXSMPC.EFD;
    // OUT9 = G2.gASTMPC.simpleLag1.y;
    OUT11 = Bus6.v;

    OUT12 =PV.rEGCA1_1.Pgen;
    OUT13 =PV.rEGCA1_1.Qgen;
    OUT14 =PV.rEGCA1_1.p.ir;
    OUT15 =PV.rEGCA1_1.p.ii;
    OUT16 = Bus8.v;


    OUT17 =BESS.rEGCA1_1.Pgen;
    OUT18 =BESS.rEGCA1_1.Qgen;
    OUT19 =BESS.rEGCA1_1.p.ir;
    OUT20 =BESS.rEGCA1_1.p.ii;
    OUT21 = Bus10.v;

    OUT22 = Load2.P;
    OUT23 = Load2.Q;

    OUT24 = Bus5.v;
    OUT25 = Bus5.angle;

      connect(T1.p, Bus2.p)
        annotation (Line(points={{-51.2,80},{-40,80}}, color={0,0,255}));
      connect(Bus1.p, T1.n)
        annotation (Line(points={{-80,80},{-68.8,80}}, color={0,0,255}));
      connect(G1.conn, Bus1.p)
        annotation (Line(points={{-91,80},{-80,80}}, color={0,0,255}));
      connect(L1.n, Bus3.p)
        annotation (Line(points={{-14.6,80},{0,80}}, color={0,0,255}));
      connect(L1.p, Bus2.p)
        annotation (Line(points={{-25.4,80},{-40,80}}, color={0,0,255}));
      connect(L2_2.n, Bus4.p) annotation (Line(points={{35.4,70},{44,70},{44,80},{60,
              80}}, color={0,0,255}));
      connect(L2_1.n, Bus4.p) annotation (Line(points={{35.4,90},{44,90},{44,80},{60,
              80}}, color={0,0,255}));
      connect(L2_1.p, Bus3.p) annotation (Line(points={{24.6,90},{16,90},{16,80},{0,
              80}}, color={0,0,255}));
      connect(L2_2.p, Bus3.p) annotation (Line(points={{24.6,70},{16,70},{16,80},{0,
              80}}, color={0,0,255}));
      connect(Load1.p, Bus3.p)
        annotation (Line(points={{-10,68},{-10,80},{0,80}}, color={0,0,255}));
      connect(L3.p, Bus4.p)
        annotation (Line(points={{80,65.4},{80,80},{60,80}}, color={0,0,255}));
      connect(breaker.s, Bus5.p)
        annotation (Line(points={{80,22},{80,16}},color={0,0,255}));
      connect(breaker.r, L3.n)
        annotation (Line(points={{80,30},{80,54.6}},color={0,0,255}));

      connect(IB.p, Bus4.p)
        annotation (Line(points={{100,80},{60,80}}, color={0,0,255}));
      connect(Load2.p, Bus5.p) annotation (Line(points={{110,-10},{110,10},{80,10},{
              80,16}},
                   color={0,0,255}));
      connect(T4.n, Bus10.p)
        annotation (Line(points={{-1,-90},{-10,-90}}, color={0,0,255}));
      connect(Bus6.p, T2.n)
        annotation (Line(points={{-10,10},{-1,10}},
                                                color={0,0,255}));
      connect(BESS.p1, Bus10.p)
        annotation (Line(points={{-20,-90},{-10,-90}}, color={0,0,255}));
      connect(G2.conn, Bus6.p) annotation (Line(points={{-19,10},{-10,10}},
                                         color={0,0,255}));
      connect(PV.p1, Bus8.p)
        annotation (Line(points={{-20,-50},{-10,-50}}, color={0,0,255}));
      connect(Bus8.p, T3.n)
        annotation (Line(points={{-10,-50},{1,-50}},  color={0,0,255}));
      connect(T2.p, Bus7.p) annotation (Line(points={{21,10},{25.5,10},{25.5,10},{30,
              10}}, color={0,0,255}));
      connect(T3.p, Bus9.p)
        annotation (Line(points={{23,-50},{30,-50}}, color={0,0,255}));
      connect(T4.p, Bus11.p)
        annotation (Line(points={{21,-90},{30,-90}}, color={0,0,255}));
      connect(L4.n, Bus5.p) annotation (Line(points={{49.4,10},{60,10},{60,10},{80,10},
              {80,16}},     color={0,0,255}));
      connect(L5.n, Bus5.p) annotation (Line(points={{49.4,-50},{60,-50},{60,10},{80,
              10},{80,16}}, color={0,0,255}));
      connect(Bus11.p, L6.p)
        annotation (Line(points={{30,-90},{38.6,-90}}, color={0,0,255}));
      connect(Bus9.p, L5.p)
        annotation (Line(points={{30,-50},{38.6,-50}}, color={0,0,255}));
      connect(L6.n, Bus5.p) annotation (Line(points={{49.4,-90},{60,-90},{60,10},{80,
              10},{80,16}}, color={0,0,255}));
      connect(Bus7.p, L4.p) annotation (Line(points={{30,10},{34.3,10},{34.3,10},{38.6,
              10}}, color={0,0,255}));
      connect(sine.y, add.u2) annotation (Line(points={{78.5,-31},{78.5,-16.4},
              {83.2,-16.4}}, color={0,0,127}));
      connect(whiteNoiseInjection.y, add.u1) annotation (Line(points={{78.54,
              -12.06},{80.87,-12.06},{80.87,-11.6},{83.2,-11.6}}, color={0,0,
              127}));
      connect(add.y, Load2.u) annotation (Line(points={{92.4,-14},{97.15,-14},
              {97.15,-14.5},{101.9,-14.5}}, color={0,0,127}));
      connect(combiTimeTable.y[1], G2.P_ref1) annotation (Line(points={{-101,16},{-42,
              16}},                   color={0,0,127}));
      connect(combiTimeTable1.y[1], G2.Efd_ref) annotation (Line(points={{-101,-10},
              {-50,-10},{-50,4},{-42,4}}, color={0,0,127}));
      connect(combiTimeTable3.y[1], BESS.Paux1) annotation (Line(points={{-101,-84},
              {-42,-84}},                     color={0,0,127}));
      connect(combiTimeTable4.y[1], BESS.Qext1) annotation (Line(points={{-101,-110},
              {-50,-110},{-50,-96},{-42,-96}}, color={0,0,127}));
      connect(combiTimeTable2.y[1], PV.Qref) annotation (Line(points={{-101,-38},{-50,
              -38},{-50,-56},{-42,-56}}, color={0,0,127}));
        annotation (Placement(transformation(extent={{140,-20},{160,0}})),
                    Placement(transformation(extent={{140,-40},{160,-20}})),
                    Placement(transformation(extent={{140,-60},{160,-40}})),
                    Placement(transformation(extent={{140,-80},{160,-60}})),
                   Diagram(coordinateSystem(preserveAspectRatio=false,
              extent={{-140,-140},{140,140}}), graphics={
            Rectangle(
              extent={{-128,98},{124,38}},
              lineColor={0,128,255},
              lineThickness=0.5),
            Text(
              extent={{78,-106},{114,-120}},
              textColor={238,46,47},
              textString="Microgrid"),
            Text(
              extent={{76,58},{128,34}},
              textColor={28,108,200},
              textString="Utility Grid"),
            Text(
              extent={{-30,-102},{34,-124}},
              textColor={0,140,72},
              textString="Linearization Unit")}),
        Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),
        experiment(
          StopTime=3,
          __Dymola_NumberOfIntervals=1000,
          __Dymola_Algorithm="Dassl"),
        Icon(coordinateSystem(extent={{-140,-140},{140,140}})));
    end Microgrid_with_simplified_renewable_Signal_Generator_Kalman_Filter;

    model Microgrid_with_simplified_renewable_no_outputs
      "THIS ONE IS STABLE, CONTROLLABLE, OBSERVABLE!!!!!!!"
      extends Modelica.Icons.Example;

      parameter Boolean equivalentGRID = true;
      parameter Boolean equivalentsystem = false;

      OpenIPSL.Electrical.Buses.Bus Bus1(v_0=powerFlow.powerflow.bus.V1, angle_0=
            powerFlow.powerflow.bus.A1) if not equivalentGRID
        annotation (Placement(transformation(extent={{-90,70},{-70,90}})));
      OpenIPSL.Electrical.Buses.Bus Bus2(v_0=powerFlow.powerflow.bus.V2, angle_0=
            powerFlow.powerflow.bus.A1) if not equivalentGRID
        annotation (Placement(transformation(extent={{-50,70},{-30,90}})));
      OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
        R=0.001,
        X=0.2,
        G=0,
        B=0,
        VNOM1=13800,
        VB1=13800,
        VNOM2=6000,
        VB2=6000)  if not equivalentGRID annotation (Placement(transformation(
            extent={{-8,-8},{8,8}},
            rotation=180,
            origin={-60,80})));
      OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
        enableV_b=true,
        v_0=powerFlow.powerflow.bus.V1,
        angle_0=powerFlow.powerflow.bus.A1,
        P_0=powerFlow.powerflow.machines.PG1,
        Q_0=powerFlow.powerflow.machines.QG1,
        V_b=6000)  if not equivalentGRID
        annotation (Placement(transformation(extent={{-112,70},{-92,90}})));
      OpenIPSL.Electrical.Branches.PwLine L1(
        R=0.001,
        X=0.2,
        G=0,
        B=0) if not equivalentGRID annotation (Placement(transformation(extent={{-26,76},
                {-14,84}})));
      OpenIPSL.Electrical.Buses.Bus Bus3(v_0=powerFlow.powerflow.bus.V3, angle_0=
            powerFlow.powerflow.bus.A3) if not equivalentGRID
        annotation (Placement(transformation(extent={{-10,70},{10,90}})));
      OpenIPSL.Electrical.Buses.Bus Bus4(v_0=powerFlow.powerflow.bus.V4, angle_0=
            powerFlow.powerflow.bus.V4) if not equivalentGRID
        annotation (Placement(transformation(extent={{50,70},{70,90}})));
      OpenIPSL.Electrical.Branches.PwLine L2_1(
        R=0.0005,
        X=0.1,
        G=0,
        B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,86},
                {36,94}})));
      OpenIPSL.Electrical.Branches.PwLine L2_2(
        R=0.0005,
        X=0.1,
        G=0,
        B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,66},
                {36,74}})));
      OpenIPSL.Electrical.Buses.Bus Bus5(angle_0=powerFlow.powerflow.bus.A5, v_0=
            powerFlow.powerflow.bus.V5)  annotation (Placement(
            transformation(
            extent={{-10,-10},{10,10}},
            rotation=90,
            origin={80,16})));
      OpenIPSL.Electrical.Branches.PwLine L3(
        R=0.001,
        X=0.2,
        G=0,
        B=0) if not equivalentGRID annotation (Placement(transformation(
            extent={{-6,-4},{6,4}},
            rotation=-90,
            origin={80,60})));
      OpenIPSL.Electrical.Buses.Bus Bus6(v_0=powerFlow.powerflow.bus.V6, angle_0=
            powerFlow.powerflow.bus.A6) annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={-10,10})));
      OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
        G=0,
        B=0,
        VNOM1=13800,
        VB1=13800,
        VNOM2=6000,
        VB2=6000,
        R=0.005,
        X=0.1)  annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={10,10})));
      GenerationUnits.PSSE.G2_16MVA                         G2(
        enableV_b=true,
        enableP_0=true,
        enableQ_0=true,
        v_0=powerFlow.powerflow.bus.V6,
        enablev_0=true,
        angle_0=powerFlow.powerflow.bus.A6,
        V_b=6000,
        P_0=powerFlow.powerflow.machines.PG2,
        Q_0=powerFlow.powerflow.machines.QG2,
        enableangle_0=true)
                      annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=0,
            origin={-30,10})));
      inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000, fn=60)
        annotation (Placement(transformation(extent={{-128,104},{-74,124}})));
      OpenIPSL.Electrical.Loads.PSSE.Load Load1(
        V_b=220000,
        P_0=powerFlow.powerflow.loads.PL1,
        Q_0=powerFlow.powerflow.loads.QL1,
        v_0=powerFlow.powerflow.bus.V3,
        angle_0=powerFlow.powerflow.bus.A3) if not equivalentGRID
        annotation (Placement(transformation(extent={{-20,48},{0,68}})));
      Electrical.Events.Breaker breaker(enableTrigger=false,
        t_o=0.5,
        rc_enabled=true,
        t_rc=10000)       if not equivalentGRID                     annotation (Placement(transformation(
            extent={{-4,-4},{4,4}},
            rotation=90,
            origin={80,26})));

      Modelica.Blocks.Interfaces.RealInput IN1(start=0)
        "Connector of Real input signal 2" annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=0,
            origin={-150,10}),iconTransformation(extent={{-10,-10},{10,10}}, origin={-150,10})));
      Modelica.Blocks.Sources.Constant IN11(k=0)
        annotation (Placement(transformation(extent={{-108,-2},{-96,10}})));
      Modelica.Blocks.Math.Add AddU1
        annotation (Placement(transformation(extent={{-80,0},{-60,20}})));
      Modelica.Blocks.Sources.Constant IN22(k=0)
        annotation (Placement(transformation(extent={{-108,-32},{-96,-20}})));
      Modelica.Blocks.Math.Add AddU2
        annotation (Placement(transformation(extent={{-80,-30},{-60,-10}})));
      Modelica.Blocks.Interfaces.RealInput IN2(start=0)
        "Connector of Real input signal 2"
               annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=0,
            origin={-150,-12}), iconTransformation(extent={{-10,-10},{10,10}},
              origin={-150,-12})));

      Modelica.Blocks.Interfaces.RealInput IN3(start = 0) "Connector of Real input signal 1"
        annotation (Placement(transformation(extent={{-160,-44},{-140,-24}}),
            iconTransformation(extent={{-160,-44},{-140,-24}})));
      Modelica.Blocks.Interfaces.RealInput IN4(start = 0) "Connector of Real input signal 1"
        annotation (Placement(transformation(extent={{-160,-66},{-140,-46}}),
            iconTransformation(extent={{-160,-66},{-140,-46}})));
      Modelica.Blocks.Interfaces.RealInput IN5(start = 0) "Connector of Real input signal 1"
        annotation (Placement(transformation(extent={{-160,-88},{-140,-68}}),
            iconTransformation(extent={{-160,-88},{-140,-68}})));

      PFData.PowerFlow powerFlow(redeclare record PowerFlow =
            OpenIPSL.Examples.ModelPredictiveControl.PFData.PF16)
        annotation (Placement(transformation(extent={{-68,104},{-48,124}})));
      Electrical.Machines.PSSE.GENCLS IB(
        V_b=220000,
        v_0=powerFlow.powerflow.bus.V4,
        angle_0=powerFlow.powerflow.bus.A4,
        P_0=powerFlow.powerflow.machines.Pinf,
        Q_0=powerFlow.powerflow.machines.Qinf,
        M_b=100000000,
        X_d=1) if not equivalentGRID annotation (Placement(transformation(extent={{110,70},
                {100,90}})));
      Electrical.Loads.PSSE.Load_ExtInput Load2(
        P_0=powerFlow.powerflow.loads.PL2,
        Q_0=powerFlow.powerflow.loads.QL2,
        v_0=powerFlow.powerflow.bus.V5,
        angle_0=powerFlow.powerflow.bus.A5,
        d_P=0,
        t1=100,
        d_t=1000)
        annotation (Placement(transformation(extent={{100,-30},{120,-10}})));

      inner Modelica.Blocks.Noise.GlobalSeed globalSeed(useAutomaticSeed=false,
          fixedSeed=10000)
        annotation (Placement(transformation(extent={{-42,102},{-22,122}})));

      Electrical.Buses.Bus Bus10(v_0=powerFlow.powerflow.bus.V10, angle_0=powerFlow.powerflow.bus.A10)
        annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={-10,-90})));
      Electrical.Branches.PSSE.TwoWindingTransformer          T4(
        G=0,
        B=0,
        CW=1,
        VNOM1=13800,
        VB1=13800,
        VNOM2=480,
        VB2=480,
        R=0.001,
        X=0.1)  annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={10,-90})));
      GenerationUnits.PSSE.Solar_Units.SolarMPCSysIdentification
                                                              PV(
        V_b=480,
        P_0=powerFlow.powerflow.machines.PPV,
        enableP_0=true,
        Q_0=powerFlow.powerflow.machines.QPV,
        enableQ_0=true,
        v_0=powerFlow.powerflow.bus.V8,
        enablev_0=true,
        angle_0=powerFlow.powerflow.bus.A8,
        enableangle_0=true)
        annotation (Placement(transformation(extent={{-40,-60},{-20,-40}})));
      Modelica.Blocks.Math.Add AddU3
        annotation (Placement(transformation(extent={{-80,-60},{-60,-40}})));
      Modelica.Blocks.Sources.Constant IN33(k=0)
        annotation (Placement(transformation(extent={{-108,-62},{-96,-50}})));

      Modelica.Blocks.Math.Add AddU4
        annotation (Placement(transformation(extent={{-80,-90},{-60,-70}})));
      Modelica.Blocks.Math.Add AddU5
        annotation (Placement(transformation(extent={{-80,-116},{-60,-96}})));
      Modelica.Blocks.Sources.Constant IN44(k=0)
        annotation (Placement(transformation(extent={{-108,-92},{-96,-80}})));
      Modelica.Blocks.Sources.Constant IN55(k=0)
        annotation (Placement(transformation(extent={{-108,-118},{-96,-106}})));
      GenerationUnits.PSSE.Battery_Units.BESSMPCSysIdentification
                                                               BESS(
        V_base=480,
        V_b(displayUnit="kV") = 480,
        enableV_b=true,
        P_0=powerFlow.powerflow.machines.PBESS,
        enableP_0=true,
        Q_0=powerFlow.powerflow.machines.QBESS,
        enableQ_0=true,
        v_0=powerFlow.powerflow.bus.V10,
        enablev_0=true,
        angle_0=powerFlow.powerflow.bus.A10,
        enableangle_0=true)
        annotation (Placement(transformation(extent={{-40,-100},{-20,-80}})));
      Electrical.Buses.Bus Bus8(v_0=powerFlow.powerflow.bus.V8, angle_0=powerFlow.powerflow.bus.A8)
        annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={-10,-50})));
      Electrical.Branches.PSSE.TwoWindingTransformer          T3(
        G=0,
        B=0,
        CW=1,
        VNOM1=13800,
        VB1=13800,
        VNOM2=480,
        VB2=480,
        R=0.001,
        X=0.1)  annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={12,-50})));
      Electrical.Buses.Bus Bus11(v_0=powerFlow.powerflow.bus.V11, angle_0=powerFlow.powerflow.bus.A11)
        annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={30,-90})));
      Electrical.Buses.Bus Bus9(v_0=powerFlow.powerflow.bus.V9, angle_0=powerFlow.powerflow.bus.A9)
        annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={30,-50})));
      Electrical.Buses.Bus Bus7(v_0=powerFlow.powerflow.bus.V7, angle_0=powerFlow.powerflow.bus.A7)
        annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={30,10})));
      Electrical.Branches.PwLine          L4(
        R=0.01,
        X=0.001,
        G=0,
        B=0)  annotation (Placement(transformation(extent={{38,6},{
                50,14}})));
      Electrical.Branches.PwLine          L5(
        R=0.01,
        X=0.001,
        G=0,
        B=0)  annotation (Placement(transformation(extent={{38,-54},
                {50,-46}})));
      Electrical.Branches.PwLine          L6(
        R=0.01,
        X=0.001,
        G=0,
        B=0)  annotation (Placement(transformation(extent={{38,-94},
                {50,-86}})));
      Modelica.Blocks.Sources.Sine sine(
        amplitude=0,
        f=1/260,
        phase=3.1415926535898,
        startTime=1000)
        annotation (Placement(transformation(extent={{68,-36},{78,-26}})));
      Electrical.Loads.NoiseInjections.WhiteNoiseInjection whiteNoiseInjection(
          active_sigma=0.0000000001, samplePeriod=0.01)
        annotation (Placement(transformation(extent={{66,-18},{78,-6}})));
      Modelica.Blocks.Math.Add add
        annotation (Placement(transformation(extent={{84,-18},{92,-10}})));
    equation


      connect(T1.p, Bus2.p)
        annotation (Line(points={{-51.2,80},{-40,80}}, color={0,0,255}));
      connect(Bus1.p, T1.n)
        annotation (Line(points={{-80,80},{-68.8,80}}, color={0,0,255}));
      connect(G1.conn, Bus1.p)
        annotation (Line(points={{-91,80},{-80,80}}, color={0,0,255}));
      connect(L1.n, Bus3.p)
        annotation (Line(points={{-14.6,80},{0,80}}, color={0,0,255}));
      connect(L1.p, Bus2.p)
        annotation (Line(points={{-25.4,80},{-40,80}}, color={0,0,255}));
      connect(L2_2.n, Bus4.p) annotation (Line(points={{35.4,70},{44,70},{44,80},{60,
              80}}, color={0,0,255}));
      connect(L2_1.n, Bus4.p) annotation (Line(points={{35.4,90},{44,90},{44,80},{60,
              80}}, color={0,0,255}));
      connect(L2_1.p, Bus3.p) annotation (Line(points={{24.6,90},{16,90},{16,80},{0,
              80}}, color={0,0,255}));
      connect(L2_2.p, Bus3.p) annotation (Line(points={{24.6,70},{16,70},{16,80},{0,
              80}}, color={0,0,255}));
      connect(Load1.p, Bus3.p)
        annotation (Line(points={{-10,68},{-10,80},{0,80}}, color={0,0,255}));
      connect(L3.p, Bus4.p)
        annotation (Line(points={{80,65.4},{80,80},{60,80}}, color={0,0,255}));
      connect(breaker.s, Bus5.p)
        annotation (Line(points={{80,22},{80,16}},color={0,0,255}));
      connect(breaker.r, L3.n)
        annotation (Line(points={{80,30},{80,54.6}},color={0,0,255}));
      connect(IN11.y, AddU1.u2) annotation (Line(points={{-95.4,4},{-82,4}},
                          color={0,0,127}));
      connect(IN1, AddU1.u1) annotation (Line(points={{-150,10},{-116,10},{-116,16},
              {-82,16}},
                     color={0,0,127}));

      connect(IN22.y,AddU2. u2) annotation (Line(points={{-95.4,-26},{-82,-26}},
                     color={0,0,127}));
      connect(IN2,AddU2. u1) annotation (Line(points={{-150,-12},{-118,-12},{-118,-14},
              {-82,-14}},
                     color={0,0,127}));
      connect(AddU2.y, G2.Efd_ref)
        annotation (Line(points={{-59,-20},{-52,-20},{-52,4},{-42,4}},
                                                               color={0,0,127}));
      connect(AddU1.y, G2.P_ref1) annotation (Line(points={{-59,10},{-52,10},{-52,16},
              {-42,16}},                          color={0,0,127}));
      connect(IB.p, Bus4.p)
        annotation (Line(points={{100,80},{60,80}}, color={0,0,255}));
      connect(Load2.p, Bus5.p) annotation (Line(points={{110,-10},{110,10},{80,10},{
              80,16}},
                   color={0,0,255}));
      connect(T4.n, Bus10.p)
        annotation (Line(points={{-1,-90},{-10,-90}}, color={0,0,255}));
      connect(Bus6.p, T2.n)
        annotation (Line(points={{-10,10},{-1,10}},
                                                color={0,0,255}));
      connect(IN33.y,AddU3. u2)
        annotation (Line(points={{-95.4,-56},{-82,-56}}, color={0,0,127}));
      connect(BESS.p1, Bus10.p)
        annotation (Line(points={{-20,-90},{-10,-90}}, color={0,0,255}));
      connect(BESS.Paux1, AddU4.y) annotation (Line(points={{-42,-84},{-54,-84},{-54,
              -80},{-59,-80}}, color={0,0,127}));
      connect(IN55.y, AddU5.u2)
        annotation (Line(points={{-95.4,-112},{-82,-112}}, color={0,0,127}));
      connect(AddU5.y, BESS.Qext1) annotation (Line(points={{-59,-106},{-52,-106},{-52,
              -96},{-42,-96}},   color={0,0,127}));
      connect(IN44.y, AddU4.u2)
        annotation (Line(points={{-95.4,-86},{-82,-86}}, color={0,0,127}));
      connect(AddU4.u1,IN4)  annotation (Line(points={{-82,-74},{-100,-74},{-100,-70},
              {-116,-70},{-116,-56},{-150,-56}}, color={0,0,127}));
      connect(AddU5.u1,IN5)  annotation (Line(points={{-82,-100},{-116,-100},{-116,-78},
              {-150,-78}}, color={0,0,127}));
      connect(G2.conn, Bus6.p) annotation (Line(points={{-19,10},{-10,10}},
                                         color={0,0,255}));
      connect(AddU3.u1, IN3) annotation (Line(points={{-82,-44},{-118,-44},{-118,-34},
              {-150,-34}}, color={0,0,127}));
      connect(PV.p1, Bus8.p)
        annotation (Line(points={{-20,-50},{-10,-50}}, color={0,0,255}));
      connect(Bus8.p, T3.n)
        annotation (Line(points={{-10,-50},{1,-50}},  color={0,0,255}));
      connect(T2.p, Bus7.p) annotation (Line(points={{21,10},{25.5,10},{25.5,10},{30,
              10}}, color={0,0,255}));
      connect(T3.p, Bus9.p)
        annotation (Line(points={{23,-50},{30,-50}}, color={0,0,255}));
      connect(T4.p, Bus11.p)
        annotation (Line(points={{21,-90},{30,-90}}, color={0,0,255}));
      connect(L4.n, Bus5.p) annotation (Line(points={{49.4,10},{60,10},{60,10},{80,10},
              {80,16}},     color={0,0,255}));
      connect(L5.n, Bus5.p) annotation (Line(points={{49.4,-50},{60,-50},{60,10},{80,
              10},{80,16}}, color={0,0,255}));
      connect(Bus11.p, L6.p)
        annotation (Line(points={{30,-90},{38.6,-90}}, color={0,0,255}));
      connect(Bus9.p, L5.p)
        annotation (Line(points={{30,-50},{38.6,-50}}, color={0,0,255}));
      connect(L6.n, Bus5.p) annotation (Line(points={{49.4,-90},{60,-90},{60,10},{80,
              10},{80,16}}, color={0,0,255}));
      connect(Bus7.p, L4.p) annotation (Line(points={{30,10},{34.3,10},{34.3,10},{38.6,
              10}}, color={0,0,255}));
      connect(sine.y, add.u2) annotation (Line(points={{78.5,-31},{78.5,-16.4},
              {83.2,-16.4}}, color={0,0,127}));
      connect(whiteNoiseInjection.y, add.u1) annotation (Line(points={{78.54,
              -12.06},{80.87,-12.06},{80.87,-11.6},{83.2,-11.6}}, color={0,0,
              127}));
      connect(add.y, Load2.u) annotation (Line(points={{92.4,-14},{97.15,-14},
              {97.15,-14.5},{101.9,-14.5}}, color={0,0,127}));
      connect(PV.Qref, AddU3.y) annotation (Line(points={{-42,-56},{-54,-56},{-54,-50},
              {-59,-50}}, color={0,0,127}));
        annotation (Placement(transformation(extent={{140,-20},{160,0}})),
                    Placement(transformation(extent={{140,-40},{160,-20}})),
                    Placement(transformation(extent={{140,-60},{160,-40}})),
                    Placement(transformation(extent={{140,-80},{160,-60}})),
                   Diagram(coordinateSystem(preserveAspectRatio=false,
              extent={{-140,-140},{140,140}}), graphics={
            Rectangle(
              extent={{-160,30},{-134,-90}},
              lineColor={0,140,72},
              lineThickness=0.5),
            Rectangle(
              extent={{-128,36},{124,-124}},
              lineColor={238,46,47},
              lineThickness=0.5),
            Rectangle(
              extent={{-128,98},{124,38}},
              lineColor={0,128,255},
              lineThickness=0.5),
            Text(
              extent={{78,-106},{114,-120}},
              textColor={238,46,47},
              textString="Microgrid"),
            Text(
              extent={{76,58},{128,34}},
              textColor={28,108,200},
              textString="Utility Grid"),
            Text(
              extent={{-30,-102},{34,-124}},
              textColor={0,140,72},
              textString="Linearization Unit"),
            Text(
              extent={{-164,50},{-132,30}},
              textColor={0,140,72},
              textString="Inputs")}),
        Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),
        experiment(
          StopTime=10,
          __Dymola_NumberOfIntervals=10000,
          __Dymola_Algorithm="Dassl"),
        Icon(coordinateSystem(extent={{-140,-140},{140,140}})));
    end Microgrid_with_simplified_renewable_no_outputs;

    model Microgrid_with_simplified_renewable_V1
      "THIS ONE IS STABLE, CONTROLLABLE, OBSERVABLE!!!!!!!"
      extends Modelica.Icons.Example;

      parameter Boolean equivalentGRID = true;
      parameter Boolean equivalentsystem = false;

      OpenIPSL.Electrical.Buses.Bus Bus1(v_0=powerFlow.powerflow.bus.V1, angle_0=
            powerFlow.powerflow.bus.A1) if not equivalentGRID
        annotation (Placement(transformation(extent={{-90,70},{-70,90}})));
      OpenIPSL.Electrical.Buses.Bus Bus2(v_0=powerFlow.powerflow.bus.V2, angle_0=
            powerFlow.powerflow.bus.A1) if not equivalentGRID
        annotation (Placement(transformation(extent={{-50,70},{-30,90}})));
      OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
        R=0.001,
        X=0.2,
        G=0,
        B=0,
        VNOM1=13800,
        VB1=13800,
        VNOM2=6000,
        VB2=6000)  if not equivalentGRID annotation (Placement(transformation(
            extent={{-8,-8},{8,8}},
            rotation=180,
            origin={-60,80})));
      OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
        enableV_b=true,
        v_0=powerFlow.powerflow.bus.V1,
        angle_0=powerFlow.powerflow.bus.A1,
        P_0=powerFlow.powerflow.machines.PG1,
        Q_0=powerFlow.powerflow.machines.QG1,
        V_b=6000)  if not equivalentGRID
        annotation (Placement(transformation(extent={{-112,70},{-92,90}})));
      OpenIPSL.Electrical.Branches.PwLine L1(
        R=0.001,
        X=0.2,
        G=0,
        B=0) if not equivalentGRID annotation (Placement(transformation(extent={{-26,76},
                {-14,84}})));
      OpenIPSL.Electrical.Buses.Bus Bus3(v_0=powerFlow.powerflow.bus.V3, angle_0=
            powerFlow.powerflow.bus.A3) if not equivalentGRID
        annotation (Placement(transformation(extent={{-10,70},{10,90}})));
      OpenIPSL.Electrical.Buses.Bus Bus4(v_0=powerFlow.powerflow.bus.V4, angle_0=
            powerFlow.powerflow.bus.V4) if not equivalentGRID
        annotation (Placement(transformation(extent={{50,70},{70,90}})));
      OpenIPSL.Electrical.Branches.PwLine L2_1(
        R=0.0005,
        X=0.1,
        G=0,
        B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,86},
                {36,94}})));
      OpenIPSL.Electrical.Branches.PwLine L2_2(
        R=0.0005,
        X=0.1,
        G=0,
        B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,66},
                {36,74}})));
      OpenIPSL.Electrical.Buses.Bus Bus5(angle_0=powerFlow.powerflow.bus.A5, v_0=
            powerFlow.powerflow.bus.V5)  annotation (Placement(
            transformation(
            extent={{-10,-10},{10,10}},
            rotation=90,
            origin={80,16})));
      OpenIPSL.Electrical.Branches.PwLine L3(
        R=0.001,
        X=0.2,
        G=0,
        B=0) if not equivalentGRID annotation (Placement(transformation(
            extent={{-6,-4},{6,4}},
            rotation=-90,
            origin={80,60})));
      OpenIPSL.Electrical.Buses.Bus Bus6(v_0=powerFlow.powerflow.bus.V6, angle_0=
            powerFlow.powerflow.bus.A6) annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={-10,10})));
      OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
        G=0,
        B=0,
        VNOM1=13800,
        VB1=13800,
        VNOM2=6000,
        VB2=6000,
        R=0.005,
        X=0.1)  annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={10,10})));
      GenerationUnits.PSSE.G2_16MVA                         G2(
        enableV_b=true,
        enableP_0=true,
        enableQ_0=true,
        v_0=powerFlow.powerflow.bus.V6,
        enablev_0=true,
        angle_0=powerFlow.powerflow.bus.A6,
        V_b=6000,
        P_0=powerFlow.powerflow.machines.PG2,
        Q_0=powerFlow.powerflow.machines.QG2,
        enableangle_0=true)
                      annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=0,
            origin={-30,10})));
      inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000, fn=60)
        annotation (Placement(transformation(extent={{-128,104},{-74,124}})));
      OpenIPSL.Electrical.Loads.PSSE.Load Load1(
        V_b=220000,
        P_0=powerFlow.powerflow.loads.PL1,
        Q_0=powerFlow.powerflow.loads.QL1,
        v_0=powerFlow.powerflow.bus.V3,
        angle_0=powerFlow.powerflow.bus.A3) if not equivalentGRID
        annotation (Placement(transformation(extent={{-20,48},{0,68}})));
      Electrical.Events.Breaker breaker(enableTrigger=false,
        t_o=0.5,
        rc_enabled=true,
        t_rc=10000)       if not equivalentGRID                     annotation (Placement(transformation(
            extent={{-4,-4},{4,4}},
            rotation=90,
            origin={80,26})));

      Modelica.Blocks.Interfaces.RealInput IN1(start=0)
        "Connector of Real input signal 2" annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=0,
            origin={-150,10}),iconTransformation(extent={{-10,-10},{10,10}}, origin={-150,10})));
      Modelica.Blocks.Sources.Constant IN11(k=0)
        annotation (Placement(transformation(extent={{-108,-2},{-96,10}})));
      Modelica.Blocks.Math.Add AddU1
        annotation (Placement(transformation(extent={{-80,0},{-60,20}})));
      Modelica.Blocks.Sources.Constant IN22(k=0)
        annotation (Placement(transformation(extent={{-108,-32},{-96,-20}})));
      Modelica.Blocks.Math.Add AddU2
        annotation (Placement(transformation(extent={{-80,-30},{-60,-10}})));
      Modelica.Blocks.Interfaces.RealInput IN2(start=0)
        "Connector of Real input signal 2"
               annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=0,
            origin={-150,-12}), iconTransformation(extent={{-10,-10},{10,10}},
              origin={-150,-12})));

      Modelica.Blocks.Interfaces.RealInput IN3(start = 0) "Connector of Real input signal 1"
        annotation (Placement(transformation(extent={{-160,-44},{-140,-24}}),
            iconTransformation(extent={{-160,-44},{-140,-24}})));
      Modelica.Blocks.Interfaces.RealInput IN4(start = 0) "Connector of Real input signal 1"
        annotation (Placement(transformation(extent={{-160,-66},{-140,-46}}),
            iconTransformation(extent={{-160,-66},{-140,-46}})));
      Modelica.Blocks.Interfaces.RealInput IN5(start = 0) "Connector of Real input signal 1"
        annotation (Placement(transformation(extent={{-160,-88},{-140,-68}}),
            iconTransformation(extent={{-160,-88},{-140,-68}})));

      PFData.PowerFlow powerFlow(redeclare record PowerFlow =
            OpenIPSL.Examples.ModelPredictiveControl.PFData.PF16)
        annotation (Placement(transformation(extent={{-68,104},{-48,124}})));
      Electrical.Machines.PSSE.GENCLS IB(
        V_b=220000,
        v_0=powerFlow.powerflow.bus.V4,
        angle_0=powerFlow.powerflow.bus.A4,
        P_0=powerFlow.powerflow.machines.Pinf,
        Q_0=powerFlow.powerflow.machines.Qinf,
        M_b=100000000,
        X_d=1) if not equivalentGRID annotation (Placement(transformation(extent={{110,70},
                {100,90}})));
      Electrical.Loads.PSSE.Load_ExtInput Load2(
        P_0=powerFlow.powerflow.loads.PL2,
        Q_0=powerFlow.powerflow.loads.QL2,
        v_0=powerFlow.powerflow.bus.V5,
        angle_0=powerFlow.powerflow.bus.A5,
        d_P=0,
        t1=100,
        d_t=1000)
        annotation (Placement(transformation(extent={{100,-30},{120,-10}})));

      inner Modelica.Blocks.Noise.GlobalSeed globalSeed(useAutomaticSeed=false,
          fixedSeed=10000)
        annotation (Placement(transformation(extent={{-42,102},{-22,122}})));

      Electrical.Buses.Bus Bus10(v_0=powerFlow.powerflow.bus.V10, angle_0=powerFlow.powerflow.bus.A10)
        annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={-10,-90})));
      Electrical.Branches.PSSE.TwoWindingTransformer          T4(
        G=0,
        B=0,
        CW=1,
        VNOM1=13800,
        VB1=13800,
        VNOM2=480,
        VB2=480,
        R=0.001,
        X=0.1)  annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={10,-90})));
      GenerationUnits.PSSE.Solar_Units.SolarMPCSysIdentification
                                                              PV(
        V_b=480,
        P_0=powerFlow.powerflow.machines.PPV,
        enableP_0=true,
        Q_0=powerFlow.powerflow.machines.QPV,
        enableQ_0=true,
        v_0=powerFlow.powerflow.bus.V8,
        enablev_0=true,
        angle_0=powerFlow.powerflow.bus.A8,
        enableangle_0=true)
        annotation (Placement(transformation(extent={{-40,-60},{-20,-40}})));
      Modelica.Blocks.Math.Add AddU3
        annotation (Placement(transformation(extent={{-80,-60},{-60,-40}})));
      Modelica.Blocks.Sources.Constant IN33(k=0)
        annotation (Placement(transformation(extent={{-108,-62},{-96,-50}})));

      Modelica.Blocks.Math.Add AddU4
        annotation (Placement(transformation(extent={{-80,-90},{-60,-70}})));
      Modelica.Blocks.Math.Add AddU5
        annotation (Placement(transformation(extent={{-80,-116},{-60,-96}})));
      Modelica.Blocks.Sources.Constant IN44(k=0)
        annotation (Placement(transformation(extent={{-108,-92},{-96,-80}})));
      Modelica.Blocks.Sources.Constant IN55(k=0)
        annotation (Placement(transformation(extent={{-108,-118},{-96,-106}})));
      GenerationUnits.PSSE.Battery_Units.BESSMPCSysIdentification
                                                               BESS(
        V_base=480,
        V_b(displayUnit="kV") = 480,
        enableV_b=true,
        P_0=powerFlow.powerflow.machines.PBESS,
        enableP_0=true,
        Q_0=powerFlow.powerflow.machines.QBESS,
        enableQ_0=true,
        v_0=powerFlow.powerflow.bus.V10,
        enablev_0=true,
        angle_0=powerFlow.powerflow.bus.A10,
        enableangle_0=true)
        annotation (Placement(transformation(extent={{-40,-100},{-20,-80}})));
      Electrical.Buses.Bus Bus8(v_0=powerFlow.powerflow.bus.V8, angle_0=powerFlow.powerflow.bus.A8)
        annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={-10,-50})));
      Electrical.Branches.PSSE.TwoWindingTransformer          T3(
        G=0,
        B=0,
        CW=1,
        VNOM1=13800,
        VB1=13800,
        VNOM2=480,
        VB2=480,
        R=0.001,
        X=0.1)  annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={12,-50})));
      Electrical.Buses.Bus Bus11(v_0=powerFlow.powerflow.bus.V11, angle_0=powerFlow.powerflow.bus.A11)
        annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={30,-90})));
      Electrical.Buses.Bus Bus9(v_0=powerFlow.powerflow.bus.V9, angle_0=powerFlow.powerflow.bus.A9)
        annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={30,-50})));
      Electrical.Buses.Bus Bus7(v_0=powerFlow.powerflow.bus.V7, angle_0=powerFlow.powerflow.bus.A7)
        annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={30,10})));
      Electrical.Branches.PwLine          L4(
        R=0.01,
        X=0.001,
        G=0,
        B=0)  annotation (Placement(transformation(extent={{38,6},{
                50,14}})));
      Electrical.Branches.PwLine          L5(
        R=0.01,
        X=0.001,
        G=0,
        B=0)  annotation (Placement(transformation(extent={{38,-54},
                {50,-46}})));
      Electrical.Branches.PwLine          L6(
        R=0.01,
        X=0.001,
        G=0,
        B=0)  annotation (Placement(transformation(extent={{38,-94},
                {50,-86}})));
      Modelica.Blocks.Sources.Sine sine(
        amplitude=0,
        f=1/260,
        phase=3.1415926535898,
        startTime=1000)
        annotation (Placement(transformation(extent={{68,-36},{78,-26}})));
      Electrical.Loads.NoiseInjections.WhiteNoiseInjection whiteNoiseInjection(
          active_sigma=0.0000000001, samplePeriod=0.01)
        annotation (Placement(transformation(extent={{66,-18},{78,-6}})));
      Modelica.Blocks.Math.Add add
        annotation (Placement(transformation(extent={{84,-18},{92,-10}})));
      Modelica.Blocks.Interfaces.RealOutput OUT1
        annotation (Placement(transformation(extent={{140,70},{160,90}})));
     Modelica.Blocks.Interfaces.RealOutput OUT2
        annotation (Placement(transformation(extent={{140,50},{160,70}})));
      Modelica.Blocks.Interfaces.RealOutput OUT3
        annotation (Placement(transformation(extent={{140,30},{160,50}})));
      Modelica.Blocks.Interfaces.RealOutput OUT4
        annotation (Placement(transformation(extent={{140,10},{160,30}})));
      Modelica.Blocks.Interfaces.RealOutput OUT5
        annotation (Placement(transformation(extent={{140,-10},{160,10}})));
      Modelica.Blocks.Interfaces.RealOutput OUT6
        annotation (Placement(transformation(extent={{140,-30},{160,-10}})));
      Modelica.Blocks.Interfaces.RealOutput OUT7
        annotation (Placement(transformation(extent={{140,-50},{160,-30}})));
      Modelica.Blocks.Interfaces.RealOutput OUT8
        annotation (Placement(transformation(extent={{140,-70},{160,-50}})));
      Modelica.Blocks.Interfaces.RealOutput OUT9
        annotation (Placement(transformation(extent={{140,-90},{160,-70}})));
      Modelica.Blocks.Interfaces.RealOutput OUT10
        annotation (Placement(transformation(extent={{140,-110},{160,-90}})));
      Modelica.Blocks.Interfaces.RealOutput OUT11
        annotation (Placement(transformation(extent={{164,70},{184,90}})));
      Modelica.Blocks.Interfaces.RealOutput OUT12
        annotation (Placement(transformation(extent={{164,50},{184,70}})));
      Modelica.Blocks.Interfaces.RealOutput OUT13
        annotation (Placement(transformation(extent={{164,30},{184,50}})));
      Modelica.Blocks.Interfaces.RealOutput OUT14
        annotation (Placement(transformation(extent={{164,10},{184,30}})));
      Modelica.Blocks.Interfaces.RealOutput OUT15
        annotation (Placement(transformation(extent={{164,-10},{184,10}})));
      Modelica.Blocks.Interfaces.RealOutput OUT16
        annotation (Placement(transformation(extent={{164,-30},{184,-10}})));
      Modelica.Blocks.Interfaces.RealOutput OUT17
        annotation (Placement(transformation(extent={{164,-50},{184,-30}})));
      Modelica.Blocks.Interfaces.RealOutput OUT18
        annotation (Placement(transformation(extent={{164,-70},{184,-50}})));
      Modelica.Blocks.Interfaces.RealOutput OUT19
        annotation (Placement(transformation(extent={{164,-90},{184,-70}})));
      Modelica.Blocks.Interfaces.RealOutput OUT20
        annotation (Placement(transformation(extent={{164,-110},{184,-90}})));
      Modelica.Blocks.Interfaces.RealOutput OUT21
        annotation (Placement(transformation(extent={{184,70},{204,90}})));
      Modelica.Blocks.Interfaces.RealOutput OUT22
        annotation (Placement(transformation(extent={{184,50},{204,70}})));
      Modelica.Blocks.Interfaces.RealOutput OUT23
        annotation (Placement(transformation(extent={{184,30},{204,50}})));
      Modelica.Blocks.Interfaces.RealOutput OUT24
        annotation (Placement(transformation(extent={{184,10},{204,30}})));
      Modelica.Blocks.Interfaces.RealOutput OUT25
        annotation (Placement(transformation(extent={{184,-10},{204,10}})));
    equation

    OUT1 = G2.gen.w;
    OUT2 = G2.gen.delta;
    OUT3 = G2.gen.Epq;
    OUT4 = G2.gen.PSIkd;
    OUT5 = G2.gen.PSIppq;
    OUT6 = G2.sEXSMPC.simpleLagLim.state;
    OUT7 = G2.sEXSMPC.leadLag.TF.x_scaled[1];
    OUT8 = G2.gASTMPC.simpleLagLim.state;
    OUT9 = G2.gASTMPC.simpleLag.state;
    OUT10 = G2.gASTMPC.simpleLag1.state;

    // OUT1 = G2.gen.w;
    // OUT2 = G2.gen.delta;
    // OUT3 = G2.gen.P;
    // OUT4 = G2.gen.Q;
    // OUT5 = G2.gen.p.ir;
    // OUT6 = G2.gen.p.ii;
    // OUT7 = G2.gen.PMECH;
    // OUT8 = G2.sEXSMPC.EFD;
    // OUT9 = G2.gASTMPC.simpleLag1.y;
    OUT11 = Bus6.v;

    OUT12 =PV.rEGCA1_1.Pgen;
    OUT13 =PV.rEGCA1_1.Qgen;
    OUT14 =PV.rEGCA1_1.p.ir;
    OUT15 =PV.rEGCA1_1.p.ii;
    OUT16 = Bus8.v;

    OUT17 =BESS.rEGCA1_1.Pgen;
    OUT18 =BESS.rEGCA1_1.Qgen;
    OUT19 =BESS.rEGCA1_1.p.ir;
    OUT20 =BESS.rEGCA1_1.p.ii;
    OUT21 = Bus10.v;

    OUT22 = Load2.P;
    OUT23 = Load2.Q;

    OUT24 = Bus5.v;
    OUT25 = Bus5.angle;

      connect(T1.p, Bus2.p)
        annotation (Line(points={{-51.2,80},{-40,80}}, color={0,0,255}));
      connect(Bus1.p, T1.n)
        annotation (Line(points={{-80,80},{-68.8,80}}, color={0,0,255}));
      connect(G1.conn, Bus1.p)
        annotation (Line(points={{-91,80},{-80,80}}, color={0,0,255}));
      connect(L1.n, Bus3.p)
        annotation (Line(points={{-14.6,80},{0,80}}, color={0,0,255}));
      connect(L1.p, Bus2.p)
        annotation (Line(points={{-25.4,80},{-40,80}}, color={0,0,255}));
      connect(L2_2.n, Bus4.p) annotation (Line(points={{35.4,70},{44,70},{44,80},{60,
              80}}, color={0,0,255}));
      connect(L2_1.n, Bus4.p) annotation (Line(points={{35.4,90},{44,90},{44,80},{60,
              80}}, color={0,0,255}));
      connect(L2_1.p, Bus3.p) annotation (Line(points={{24.6,90},{16,90},{16,80},{0,
              80}}, color={0,0,255}));
      connect(L2_2.p, Bus3.p) annotation (Line(points={{24.6,70},{16,70},{16,80},{0,
              80}}, color={0,0,255}));
      connect(Load1.p, Bus3.p)
        annotation (Line(points={{-10,68},{-10,80},{0,80}}, color={0,0,255}));
      connect(L3.p, Bus4.p)
        annotation (Line(points={{80,65.4},{80,80},{60,80}}, color={0,0,255}));
      connect(breaker.s, Bus5.p)
        annotation (Line(points={{80,22},{80,16}},color={0,0,255}));
      connect(breaker.r, L3.n)
        annotation (Line(points={{80,30},{80,54.6}},color={0,0,255}));
      connect(IN11.y, AddU1.u2) annotation (Line(points={{-95.4,4},{-82,4}},
                          color={0,0,127}));
      connect(IN1, AddU1.u1) annotation (Line(points={{-150,10},{-116,10},{-116,16},
              {-82,16}},
                     color={0,0,127}));

      connect(IN22.y,AddU2. u2) annotation (Line(points={{-95.4,-26},{-82,-26}},
                     color={0,0,127}));
      connect(IN2,AddU2. u1) annotation (Line(points={{-150,-12},{-118,-12},{-118,-14},
              {-82,-14}},
                     color={0,0,127}));
      connect(AddU2.y, G2.Efd_ref)
        annotation (Line(points={{-59,-20},{-52,-20},{-52,4},{-42,4}},
                                                               color={0,0,127}));
      connect(AddU1.y, G2.P_ref1) annotation (Line(points={{-59,10},{-52,10},{-52,16},
              {-42,16}},                          color={0,0,127}));
      connect(IB.p, Bus4.p)
        annotation (Line(points={{100,80},{60,80}}, color={0,0,255}));
      connect(Load2.p, Bus5.p) annotation (Line(points={{110,-10},{110,10},{80,10},{
              80,16}},
                   color={0,0,255}));
      connect(T4.n, Bus10.p)
        annotation (Line(points={{-1,-90},{-10,-90}}, color={0,0,255}));
      connect(Bus6.p, T2.n)
        annotation (Line(points={{-10,10},{-1,10}},
                                                color={0,0,255}));
      connect(IN33.y,AddU3. u2)
        annotation (Line(points={{-95.4,-56},{-82,-56}}, color={0,0,127}));
      connect(BESS.p1, Bus10.p)
        annotation (Line(points={{-20,-90},{-10,-90}}, color={0,0,255}));
      connect(BESS.Paux1, AddU4.y) annotation (Line(points={{-42,-84},{-54,-84},{-54,
              -80},{-59,-80}}, color={0,0,127}));
      connect(IN55.y, AddU5.u2)
        annotation (Line(points={{-95.4,-112},{-82,-112}}, color={0,0,127}));
      connect(AddU5.y, BESS.Qext1) annotation (Line(points={{-59,-106},{-52,-106},{-52,
              -96},{-42,-96}},   color={0,0,127}));
      connect(IN44.y, AddU4.u2)
        annotation (Line(points={{-95.4,-86},{-82,-86}}, color={0,0,127}));
      connect(AddU4.u1,IN4)  annotation (Line(points={{-82,-74},{-100,-74},{-100,-70},
              {-116,-70},{-116,-56},{-150,-56}}, color={0,0,127}));
      connect(AddU5.u1,IN5)  annotation (Line(points={{-82,-100},{-116,-100},{-116,-78},
              {-150,-78}}, color={0,0,127}));
      connect(G2.conn, Bus6.p) annotation (Line(points={{-19,10},{-10,10}},
                                         color={0,0,255}));
      connect(AddU3.u1, IN3) annotation (Line(points={{-82,-44},{-118,-44},{-118,-34},
              {-150,-34}}, color={0,0,127}));
      connect(PV.p1, Bus8.p)
        annotation (Line(points={{-20,-50},{-10,-50}}, color={0,0,255}));
      connect(Bus8.p, T3.n)
        annotation (Line(points={{-10,-50},{1,-50}},  color={0,0,255}));
      connect(T2.p, Bus7.p) annotation (Line(points={{21,10},{25.5,10},{25.5,10},{30,
              10}}, color={0,0,255}));
      connect(T3.p, Bus9.p)
        annotation (Line(points={{23,-50},{30,-50}}, color={0,0,255}));
      connect(T4.p, Bus11.p)
        annotation (Line(points={{21,-90},{30,-90}}, color={0,0,255}));
      connect(L4.n, Bus5.p) annotation (Line(points={{49.4,10},{60,10},{60,10},{80,10},
              {80,16}},     color={0,0,255}));
      connect(L5.n, Bus5.p) annotation (Line(points={{49.4,-50},{60,-50},{60,10},{80,
              10},{80,16}}, color={0,0,255}));
      connect(Bus11.p, L6.p)
        annotation (Line(points={{30,-90},{38.6,-90}}, color={0,0,255}));
      connect(Bus9.p, L5.p)
        annotation (Line(points={{30,-50},{38.6,-50}}, color={0,0,255}));
      connect(L6.n, Bus5.p) annotation (Line(points={{49.4,-90},{60,-90},{60,10},{80,
              10},{80,16}}, color={0,0,255}));
      connect(Bus7.p, L4.p) annotation (Line(points={{30,10},{34.3,10},{34.3,10},{38.6,
              10}}, color={0,0,255}));
      connect(sine.y, add.u2) annotation (Line(points={{78.5,-31},{78.5,-16.4},
              {83.2,-16.4}}, color={0,0,127}));
      connect(whiteNoiseInjection.y, add.u1) annotation (Line(points={{78.54,
              -12.06},{80.87,-12.06},{80.87,-11.6},{83.2,-11.6}}, color={0,0,
              127}));
      connect(add.y, Load2.u) annotation (Line(points={{92.4,-14},{97.15,-14},
              {97.15,-14.5},{101.9,-14.5}}, color={0,0,127}));
      connect(PV.Qref, AddU3.y) annotation (Line(points={{-42,-56},{-54,-56},{-54,-50},
              {-59,-50}}, color={0,0,127}));
        annotation(Diagram(coordinateSystem(preserveAspectRatio=false,
              extent={{-140,-140},{140,140}}), graphics={
            Rectangle(
              extent={{-160,30},{-134,-90}},
              lineColor={0,140,72},
              lineThickness=0.5),
            Rectangle(
              extent={{-128,36},{124,-124}},
              lineColor={238,46,47},
              lineThickness=0.5),
            Rectangle(
              extent={{-128,98},{124,38}},
              lineColor={0,128,255},
              lineThickness=0.5),
            Text(
              extent={{78,-106},{114,-120}},
              textColor={238,46,47},
              textString="Microgrid"),
            Text(
              extent={{76,58},{128,34}},
              textColor={28,108,200},
              textString="Utility Grid"),
            Text(
              extent={{-30,-102},{34,-124}},
              textColor={0,140,72},
              textString="Linearization Unit"),
            Text(
              extent={{-164,50},{-132,30}},
              textColor={0,140,72},
              textString="Inputs")}),
        Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),
        experiment(
          StopTime=10,
          __Dymola_NumberOfIntervals=10000,
          __Dymola_Algorithm="Dassl"),
        Icon(coordinateSystem(extent={{-140,-140},{140,140}})));
    end Microgrid_with_simplified_renewable_V1;

    model Microgrid_with_simplified_renewable_V2
      "THIS ONE IS STABLE, CONTROLLABLE, OBSERVABLE!!!!!!!"
      extends Modelica.Icons.Example;

      parameter Boolean equivalentGRID = true;
      parameter Boolean equivalentsystem = false;

      OpenIPSL.Electrical.Buses.Bus Bus1(v_0=powerFlow.powerflow.bus.V1, angle_0=
            powerFlow.powerflow.bus.A1) if not equivalentGRID
        annotation (Placement(transformation(extent={{-90,70},{-70,90}})));
      OpenIPSL.Electrical.Buses.Bus Bus2(v_0=powerFlow.powerflow.bus.V2, angle_0=
            powerFlow.powerflow.bus.A1) if not equivalentGRID
        annotation (Placement(transformation(extent={{-50,70},{-30,90}})));
      OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
        R=0.001,
        X=0.2,
        G=0,
        B=0,
        VNOM1=13800,
        VB1=13800,
        VNOM2=6000,
        VB2=6000)  if not equivalentGRID annotation (Placement(transformation(
            extent={{-8,-8},{8,8}},
            rotation=180,
            origin={-60,80})));
      OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
        enableV_b=true,
        v_0=powerFlow.powerflow.bus.V1,
        angle_0=powerFlow.powerflow.bus.A1,
        P_0=powerFlow.powerflow.machines.PG1,
        Q_0=powerFlow.powerflow.machines.QG1,
        V_b=6000)  if not equivalentGRID
        annotation (Placement(transformation(extent={{-112,70},{-92,90}})));
      OpenIPSL.Electrical.Branches.PwLine L1(
        R=0.001,
        X=0.2,
        G=0,
        B=0) if not equivalentGRID annotation (Placement(transformation(extent={{-26,76},
                {-14,84}})));
      OpenIPSL.Electrical.Buses.Bus Bus3(v_0=powerFlow.powerflow.bus.V3, angle_0=
            powerFlow.powerflow.bus.A3) if not equivalentGRID
        annotation (Placement(transformation(extent={{-10,70},{10,90}})));
      OpenIPSL.Electrical.Buses.Bus Bus4(v_0=powerFlow.powerflow.bus.V4, angle_0=
            powerFlow.powerflow.bus.V4) if not equivalentGRID
        annotation (Placement(transformation(extent={{50,70},{70,90}})));
      OpenIPSL.Electrical.Branches.PwLine L2_1(
        R=0.0005,
        X=0.1,
        G=0,
        B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,86},
                {36,94}})));
      OpenIPSL.Electrical.Branches.PwLine L2_2(
        R=0.0005,
        X=0.1,
        G=0,
        B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,66},
                {36,74}})));
      OpenIPSL.Electrical.Buses.Bus Bus5(angle_0=powerFlow.powerflow.bus.A5, v_0=
            powerFlow.powerflow.bus.V5)  annotation (Placement(
            transformation(
            extent={{-10,-10},{10,10}},
            rotation=90,
            origin={80,16})));
      OpenIPSL.Electrical.Branches.PwLine L3(
        R=0.001,
        X=0.2,
        G=0,
        B=0) if not equivalentGRID annotation (Placement(transformation(
            extent={{-6,-4},{6,4}},
            rotation=-90,
            origin={80,60})));
      OpenIPSL.Electrical.Buses.Bus Bus6(v_0=powerFlow.powerflow.bus.V6, angle_0=
            powerFlow.powerflow.bus.A6) annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={-10,10})));
      OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
        G=0,
        B=0,
        VNOM1=13800,
        VB1=13800,
        VNOM2=6000,
        VB2=6000,
        R=0.005,
        X=0.1)  annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={10,10})));
      GenerationUnits.PSSE.G2_16MVA                         G2(
        enableV_b=true,
        enableP_0=true,
        enableQ_0=true,
        v_0=powerFlow.powerflow.bus.V6,
        enablev_0=true,
        angle_0=powerFlow.powerflow.bus.A6,
        V_b=6000,
        P_0=powerFlow.powerflow.machines.PG2,
        Q_0=powerFlow.powerflow.machines.QG2,
        enableangle_0=true)
                      annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=0,
            origin={-30,10})));
      inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000, fn=60)
        annotation (Placement(transformation(extent={{-128,104},{-74,124}})));
      OpenIPSL.Electrical.Loads.PSSE.Load Load1(
        V_b=220000,
        P_0=powerFlow.powerflow.loads.PL1,
        Q_0=powerFlow.powerflow.loads.QL1,
        v_0=powerFlow.powerflow.bus.V3,
        angle_0=powerFlow.powerflow.bus.A3) if not equivalentGRID
        annotation (Placement(transformation(extent={{-20,48},{0,68}})));
      Electrical.Events.Breaker breaker(enableTrigger=false,
        t_o=0.5,
        rc_enabled=true,
        t_rc=10000)       if not equivalentGRID                     annotation (Placement(transformation(
            extent={{-4,-4},{4,4}},
            rotation=90,
            origin={80,26})));

      Modelica.Blocks.Interfaces.RealInput IN1(start=0)
        "Connector of Real input signal 2" annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=0,
            origin={-150,10}),iconTransformation(extent={{-10,-10},{10,10}}, origin={-150,10})));
      Modelica.Blocks.Sources.Constant IN11(k=0)
        annotation (Placement(transformation(extent={{-108,-2},{-96,10}})));
      Modelica.Blocks.Math.Add AddU1
        annotation (Placement(transformation(extent={{-80,0},{-60,20}})));
      Modelica.Blocks.Sources.Constant IN22(k=0)
        annotation (Placement(transformation(extent={{-108,-32},{-96,-20}})));
      Modelica.Blocks.Math.Add AddU2
        annotation (Placement(transformation(extent={{-80,-30},{-60,-10}})));
      Modelica.Blocks.Interfaces.RealInput IN2(start=0)
        "Connector of Real input signal 2"
               annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=0,
            origin={-150,-12}), iconTransformation(extent={{-10,-10},{10,10}},
              origin={-150,-12})));

      Modelica.Blocks.Interfaces.RealInput IN3(start = 0) "Connector of Real input signal 1"
        annotation (Placement(transformation(extent={{-160,-44},{-140,-24}}),
            iconTransformation(extent={{-160,-44},{-140,-24}})));
      Modelica.Blocks.Interfaces.RealInput IN4(start = 0) "Connector of Real input signal 1"
        annotation (Placement(transformation(extent={{-160,-66},{-140,-46}}),
            iconTransformation(extent={{-160,-66},{-140,-46}})));
      Modelica.Blocks.Interfaces.RealInput IN5(start = 0) "Connector of Real input signal 1"
        annotation (Placement(transformation(extent={{-160,-88},{-140,-68}}),
            iconTransformation(extent={{-160,-88},{-140,-68}})));

      PFData.PowerFlow powerFlow(redeclare record PowerFlow =
            OpenIPSL.Examples.ModelPredictiveControl.PFData.PF16)
        annotation (Placement(transformation(extent={{-68,104},{-48,124}})));
      Electrical.Machines.PSSE.GENCLS IB(
        V_b=220000,
        v_0=powerFlow.powerflow.bus.V4,
        angle_0=powerFlow.powerflow.bus.A4,
        P_0=powerFlow.powerflow.machines.Pinf,
        Q_0=powerFlow.powerflow.machines.Qinf,
        M_b=100000000,
        X_d=1) if not equivalentGRID annotation (Placement(transformation(extent={{110,70},
                {100,90}})));
      Electrical.Loads.PSSE.Load_ExtInput Load2(
        P_0=powerFlow.powerflow.loads.PL2,
        Q_0=powerFlow.powerflow.loads.QL2,
        v_0=powerFlow.powerflow.bus.V5,
        angle_0=powerFlow.powerflow.bus.A5,
        d_P=0,
        t1=100,
        d_t=1000)
        annotation (Placement(transformation(extent={{100,-30},{120,-10}})));

      inner Modelica.Blocks.Noise.GlobalSeed globalSeed(useAutomaticSeed=false,
          fixedSeed=10000)
        annotation (Placement(transformation(extent={{-42,102},{-22,122}})));

      Electrical.Buses.Bus Bus10(v_0=powerFlow.powerflow.bus.V10, angle_0=powerFlow.powerflow.bus.A10)
        annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={-10,-90})));
      Electrical.Branches.PSSE.TwoWindingTransformer          T4(
        G=0,
        B=0,
        CW=1,
        VNOM1=13800,
        VB1=13800,
        VNOM2=480,
        VB2=480,
        R=0.001,
        X=0.1)  annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={10,-90})));
      GenerationUnits.PSSE.Solar_Units.SolarMPCSysIdentification
                                                              PV(
        V_b=480,
        P_0=powerFlow.powerflow.machines.PPV,
        enableP_0=true,
        Q_0=powerFlow.powerflow.machines.QPV,
        enableQ_0=true,
        v_0=powerFlow.powerflow.bus.V8,
        enablev_0=true,
        angle_0=powerFlow.powerflow.bus.A8,
        enableangle_0=true)
        annotation (Placement(transformation(extent={{-40,-60},{-20,-40}})));
      Modelica.Blocks.Math.Add AddU3
        annotation (Placement(transformation(extent={{-80,-60},{-60,-40}})));
      Modelica.Blocks.Sources.Constant IN33(k=0)
        annotation (Placement(transformation(extent={{-108,-62},{-96,-50}})));

      Modelica.Blocks.Math.Add AddU4
        annotation (Placement(transformation(extent={{-80,-90},{-60,-70}})));
      Modelica.Blocks.Math.Add AddU5
        annotation (Placement(transformation(extent={{-80,-116},{-60,-96}})));
      Modelica.Blocks.Sources.Constant IN44(k=0)
        annotation (Placement(transformation(extent={{-108,-92},{-96,-80}})));
      Modelica.Blocks.Sources.Constant IN55(k=0)
        annotation (Placement(transformation(extent={{-108,-118},{-96,-106}})));
      GenerationUnits.PSSE.Battery_Units.BESSMPCSysIdentification
                                                               BESS(
        V_base=480,
        V_b(displayUnit="kV") = 480,
        enableV_b=true,
        P_0=powerFlow.powerflow.machines.PBESS,
        enableP_0=true,
        Q_0=powerFlow.powerflow.machines.QBESS,
        enableQ_0=true,
        v_0=powerFlow.powerflow.bus.V10,
        enablev_0=true,
        angle_0=powerFlow.powerflow.bus.A10,
        enableangle_0=true)
        annotation (Placement(transformation(extent={{-40,-100},{-20,-80}})));
      Electrical.Buses.Bus Bus8(v_0=powerFlow.powerflow.bus.V8, angle_0=powerFlow.powerflow.bus.A8)
        annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={-10,-50})));
      Electrical.Branches.PSSE.TwoWindingTransformer          T3(
        G=0,
        B=0,
        CW=1,
        VNOM1=13800,
        VB1=13800,
        VNOM2=480,
        VB2=480,
        R=0.001,
        X=0.1)  annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={12,-50})));
      Electrical.Buses.Bus Bus11(v_0=powerFlow.powerflow.bus.V11, angle_0=powerFlow.powerflow.bus.A11)
        annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={30,-90})));
      Electrical.Buses.Bus Bus9(v_0=powerFlow.powerflow.bus.V9, angle_0=powerFlow.powerflow.bus.A9)
        annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={30,-50})));
      Electrical.Buses.Bus Bus7(v_0=powerFlow.powerflow.bus.V7, angle_0=powerFlow.powerflow.bus.A7)
        annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={30,10})));
      Electrical.Branches.PwLine          L4(
        R=0.01,
        X=0.001,
        G=0,
        B=0)  annotation (Placement(transformation(extent={{38,6},{
                50,14}})));
      Electrical.Branches.PwLine          L5(
        R=0.01,
        X=0.001,
        G=0,
        B=0)  annotation (Placement(transformation(extent={{38,-54},
                {50,-46}})));
      Electrical.Branches.PwLine          L6(
        R=0.01,
        X=0.001,
        G=0,
        B=0)  annotation (Placement(transformation(extent={{38,-94},
                {50,-86}})));
      Modelica.Blocks.Sources.Sine sine(
        amplitude=0,
        f=1/260,
        phase=3.1415926535898,
        startTime=1000)
        annotation (Placement(transformation(extent={{68,-36},{78,-26}})));
      Electrical.Loads.NoiseInjections.WhiteNoiseInjection whiteNoiseInjection(
          active_sigma=0.0000000001, samplePeriod=0.01)
        annotation (Placement(transformation(extent={{66,-18},{78,-6}})));
      Modelica.Blocks.Math.Add add
        annotation (Placement(transformation(extent={{84,-18},{92,-10}})));
      Modelica.Blocks.Interfaces.RealOutput OUT1
        annotation (Placement(transformation(extent={{140,70},{160,90}})));
     Modelica.Blocks.Interfaces.RealOutput OUT2
        annotation (Placement(transformation(extent={{140,50},{160,70}})));
      Modelica.Blocks.Interfaces.RealOutput OUT3
        annotation (Placement(transformation(extent={{140,30},{160,50}})));
      Modelica.Blocks.Interfaces.RealOutput OUT4
        annotation (Placement(transformation(extent={{140,10},{160,30}})));
      Modelica.Blocks.Interfaces.RealOutput OUT5
        annotation (Placement(transformation(extent={{140,-10},{160,10}})));
      Modelica.Blocks.Interfaces.RealOutput OUT6
        annotation (Placement(transformation(extent={{140,-30},{160,-10}})));
      Modelica.Blocks.Interfaces.RealOutput OUT7
        annotation (Placement(transformation(extent={{140,-50},{160,-30}})));
      Modelica.Blocks.Interfaces.RealOutput OUT8
        annotation (Placement(transformation(extent={{140,-70},{160,-50}})));
      Modelica.Blocks.Interfaces.RealOutput OUT9
        annotation (Placement(transformation(extent={{140,-90},{160,-70}})));
      Modelica.Blocks.Interfaces.RealOutput OUT10
        annotation (Placement(transformation(extent={{140,-110},{160,-90}})));
      Modelica.Blocks.Interfaces.RealOutput OUT11
        annotation (Placement(transformation(extent={{164,70},{184,90}})));
      Modelica.Blocks.Interfaces.RealOutput OUT12
        annotation (Placement(transformation(extent={{164,50},{184,70}})));
      Modelica.Blocks.Interfaces.RealOutput OUT13
        annotation (Placement(transformation(extent={{164,30},{184,50}})));
      Modelica.Blocks.Interfaces.RealOutput OUT14
        annotation (Placement(transformation(extent={{164,10},{184,30}})));
      Modelica.Blocks.Interfaces.RealOutput OUT15
        annotation (Placement(transformation(extent={{164,-10},{184,10}})));
      Modelica.Blocks.Interfaces.RealOutput OUT16
        annotation (Placement(transformation(extent={{164,-30},{184,-10}})));
      Modelica.Blocks.Interfaces.RealOutput OUT17
        annotation (Placement(transformation(extent={{164,-50},{184,-30}})));
      Modelica.Blocks.Interfaces.RealOutput OUT18
        annotation (Placement(transformation(extent={{164,-70},{184,-50}})));
      Modelica.Blocks.Interfaces.RealOutput OUT19
        annotation (Placement(transformation(extent={{164,-90},{184,-70}})));
      Modelica.Blocks.Interfaces.RealOutput OUT20
        annotation (Placement(transformation(extent={{164,-110},{184,-90}})));
      Modelica.Blocks.Interfaces.RealOutput OUT21
        annotation (Placement(transformation(extent={{184,70},{204,90}})));
      Modelica.Blocks.Interfaces.RealOutput OUT22
        annotation (Placement(transformation(extent={{184,50},{204,70}})));
      Modelica.Blocks.Interfaces.RealOutput OUT23
        annotation (Placement(transformation(extent={{184,30},{204,50}})));
      Modelica.Blocks.Interfaces.RealOutput OUT24
        annotation (Placement(transformation(extent={{184,10},{204,30}})));
      Modelica.Blocks.Interfaces.RealOutput OUT25
        annotation (Placement(transformation(extent={{184,-10},{204,10}})));
    equation

    OUT1 = G2.gen.w;
    OUT2 = G2.gen.delta;
    OUT3 = G2.sEXSMPC.EFD;
    OUT4 = G2.gASTMPC.simpleLag1.state;
    OUT5 = G2.gen.P;
    OUT6 = G2.gen.Q;
    OUT7 = G2.gen.p.ir;
    OUT8 = G2.gen.p.ii;
    OUT9 = G2.gen.PMECH;
    OUT10 = G2.sEXSMPC.EFD;
    OUT11 = Bus6.v;

    OUT12 =PV.rEGCA1_1.Pgen;
    OUT13 =PV.rEGCA1_1.Qgen;
    OUT14 =PV.rEGCA1_1.p.ir;
    OUT15 =PV.rEGCA1_1.p.ii;
    OUT16 = Bus8.v;

    OUT17 =BESS.rEGCA1_1.Pgen;
    OUT18 =BESS.rEGCA1_1.Qgen;
    OUT19 =BESS.rEGCA1_1.p.ir;
    OUT20 =BESS.rEGCA1_1.p.ii;
    OUT21 = Bus10.v;

    OUT22 = Load2.P;
    OUT23 = Load2.Q;

    OUT24 = Bus5.v;
    OUT25 = Bus5.angle;

      connect(T1.p, Bus2.p)
        annotation (Line(points={{-51.2,80},{-40,80}}, color={0,0,255}));
      connect(Bus1.p, T1.n)
        annotation (Line(points={{-80,80},{-68.8,80}}, color={0,0,255}));
      connect(G1.conn, Bus1.p)
        annotation (Line(points={{-91,80},{-80,80}}, color={0,0,255}));
      connect(L1.n, Bus3.p)
        annotation (Line(points={{-14.6,80},{0,80}}, color={0,0,255}));
      connect(L1.p, Bus2.p)
        annotation (Line(points={{-25.4,80},{-40,80}}, color={0,0,255}));
      connect(L2_2.n, Bus4.p) annotation (Line(points={{35.4,70},{44,70},{44,80},{60,
              80}}, color={0,0,255}));
      connect(L2_1.n, Bus4.p) annotation (Line(points={{35.4,90},{44,90},{44,80},{60,
              80}}, color={0,0,255}));
      connect(L2_1.p, Bus3.p) annotation (Line(points={{24.6,90},{16,90},{16,80},{0,
              80}}, color={0,0,255}));
      connect(L2_2.p, Bus3.p) annotation (Line(points={{24.6,70},{16,70},{16,80},{0,
              80}}, color={0,0,255}));
      connect(Load1.p, Bus3.p)
        annotation (Line(points={{-10,68},{-10,80},{0,80}}, color={0,0,255}));
      connect(L3.p, Bus4.p)
        annotation (Line(points={{80,65.4},{80,80},{60,80}}, color={0,0,255}));
      connect(breaker.s, Bus5.p)
        annotation (Line(points={{80,22},{80,16}},color={0,0,255}));
      connect(breaker.r, L3.n)
        annotation (Line(points={{80,30},{80,54.6}},color={0,0,255}));
      connect(IN11.y, AddU1.u2) annotation (Line(points={{-95.4,4},{-82,4}},
                          color={0,0,127}));
      connect(IN1, AddU1.u1) annotation (Line(points={{-150,10},{-116,10},{-116,16},
              {-82,16}},
                     color={0,0,127}));

      connect(IN22.y,AddU2. u2) annotation (Line(points={{-95.4,-26},{-82,-26}},
                     color={0,0,127}));
      connect(IN2,AddU2. u1) annotation (Line(points={{-150,-12},{-118,-12},{-118,-14},
              {-82,-14}},
                     color={0,0,127}));
      connect(AddU2.y, G2.Efd_ref)
        annotation (Line(points={{-59,-20},{-52,-20},{-52,4},{-42,4}},
                                                               color={0,0,127}));
      connect(AddU1.y, G2.P_ref1) annotation (Line(points={{-59,10},{-52,10},{-52,16},
              {-42,16}},                          color={0,0,127}));
      connect(IB.p, Bus4.p)
        annotation (Line(points={{100,80},{60,80}}, color={0,0,255}));
      connect(Load2.p, Bus5.p) annotation (Line(points={{110,-10},{110,10},{80,10},{
              80,16}},
                   color={0,0,255}));
      connect(T4.n, Bus10.p)
        annotation (Line(points={{-1,-90},{-10,-90}}, color={0,0,255}));
      connect(Bus6.p, T2.n)
        annotation (Line(points={{-10,10},{-1,10}},
                                                color={0,0,255}));
      connect(IN33.y,AddU3. u2)
        annotation (Line(points={{-95.4,-56},{-82,-56}}, color={0,0,127}));
      connect(BESS.p1, Bus10.p)
        annotation (Line(points={{-20,-90},{-10,-90}}, color={0,0,255}));
      connect(BESS.Paux1, AddU4.y) annotation (Line(points={{-42,-84},{-54,-84},{-54,
              -80},{-59,-80}}, color={0,0,127}));
      connect(IN55.y, AddU5.u2)
        annotation (Line(points={{-95.4,-112},{-82,-112}}, color={0,0,127}));
      connect(AddU5.y, BESS.Qext1) annotation (Line(points={{-59,-106},{-52,-106},{-52,
              -96},{-42,-96}},   color={0,0,127}));
      connect(IN44.y, AddU4.u2)
        annotation (Line(points={{-95.4,-86},{-82,-86}}, color={0,0,127}));
      connect(AddU4.u1,IN4)  annotation (Line(points={{-82,-74},{-100,-74},{-100,-70},
              {-116,-70},{-116,-56},{-150,-56}}, color={0,0,127}));
      connect(AddU5.u1,IN5)  annotation (Line(points={{-82,-100},{-116,-100},{-116,-78},
              {-150,-78}}, color={0,0,127}));
      connect(G2.conn, Bus6.p) annotation (Line(points={{-19,10},{-10,10}},
                                         color={0,0,255}));
      connect(AddU3.u1, IN3) annotation (Line(points={{-82,-44},{-118,-44},{-118,-34},
              {-150,-34}}, color={0,0,127}));
      connect(PV.p1, Bus8.p)
        annotation (Line(points={{-20,-50},{-10,-50}}, color={0,0,255}));
      connect(Bus8.p, T3.n)
        annotation (Line(points={{-10,-50},{1,-50}},  color={0,0,255}));
      connect(T2.p, Bus7.p) annotation (Line(points={{21,10},{25.5,10},{25.5,10},{30,
              10}}, color={0,0,255}));
      connect(T3.p, Bus9.p)
        annotation (Line(points={{23,-50},{30,-50}}, color={0,0,255}));
      connect(T4.p, Bus11.p)
        annotation (Line(points={{21,-90},{30,-90}}, color={0,0,255}));
      connect(L4.n, Bus5.p) annotation (Line(points={{49.4,10},{60,10},{60,10},{80,10},
              {80,16}},     color={0,0,255}));
      connect(L5.n, Bus5.p) annotation (Line(points={{49.4,-50},{60,-50},{60,10},{80,
              10},{80,16}}, color={0,0,255}));
      connect(Bus11.p, L6.p)
        annotation (Line(points={{30,-90},{38.6,-90}}, color={0,0,255}));
      connect(Bus9.p, L5.p)
        annotation (Line(points={{30,-50},{38.6,-50}}, color={0,0,255}));
      connect(L6.n, Bus5.p) annotation (Line(points={{49.4,-90},{60,-90},{60,10},{80,
              10},{80,16}}, color={0,0,255}));
      connect(Bus7.p, L4.p) annotation (Line(points={{30,10},{34.3,10},{34.3,10},{38.6,
              10}}, color={0,0,255}));
      connect(sine.y, add.u2) annotation (Line(points={{78.5,-31},{78.5,-16.4},
              {83.2,-16.4}}, color={0,0,127}));
      connect(whiteNoiseInjection.y, add.u1) annotation (Line(points={{78.54,
              -12.06},{80.87,-12.06},{80.87,-11.6},{83.2,-11.6}}, color={0,0,
              127}));
      connect(add.y, Load2.u) annotation (Line(points={{92.4,-14},{97.15,-14},
              {97.15,-14.5},{101.9,-14.5}}, color={0,0,127}));
      connect(PV.Qref, AddU3.y) annotation (Line(points={{-42,-56},{-54,-56},{-54,-50},
              {-59,-50}}, color={0,0,127}));
        annotation(Diagram(coordinateSystem(preserveAspectRatio=false,
              extent={{-140,-140},{140,140}}), graphics={
            Rectangle(
              extent={{-160,30},{-134,-90}},
              lineColor={0,140,72},
              lineThickness=0.5),
            Rectangle(
              extent={{-128,36},{124,-124}},
              lineColor={238,46,47},
              lineThickness=0.5),
            Rectangle(
              extent={{-128,98},{124,38}},
              lineColor={0,128,255},
              lineThickness=0.5),
            Text(
              extent={{78,-106},{114,-120}},
              textColor={238,46,47},
              textString="Microgrid"),
            Text(
              extent={{76,58},{128,34}},
              textColor={28,108,200},
              textString="Utility Grid"),
            Text(
              extent={{-30,-102},{34,-124}},
              textColor={0,140,72},
              textString="Linearization Unit"),
            Text(
              extent={{-164,50},{-132,30}},
              textColor={0,140,72},
              textString="Inputs")}),
        Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),
        experiment(
          StopTime=10,
          __Dymola_NumberOfIntervals=10000,
          __Dymola_Algorithm="Dassl"),
        Icon(coordinateSystem(extent={{-140,-140},{140,140}})));
    end Microgrid_with_simplified_renewable_V2;

    model MPCAppliedEnergyOriginal_V2
      "THIS ONE IS STABLE, CONTROLLABLE, OBSERVABLE!!!!!!!"
      extends Modelica.Icons.Example;

      parameter Boolean equivalentGRID = false;
      parameter Boolean equivalentsystem = false;

      OpenIPSL.Electrical.Buses.Bus Bus1(v_0=powerFlow.powerflow.bus.V1, angle_0=
            powerFlow.powerflow.bus.A1) if not equivalentGRID
        annotation (Placement(transformation(extent={{-90,70},{-70,90}})));
      OpenIPSL.Electrical.Buses.Bus Bus2(v_0=powerFlow.powerflow.bus.V2, angle_0=
            powerFlow.powerflow.bus.A1) if not equivalentGRID
        annotation (Placement(transformation(extent={{-50,70},{-30,90}})));
      OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
        R=0.001,
        X=0.2,
        G=0,
        B=0,
        VNOM1=13800,
        VB1=13800,
        VNOM2=6000,
        VB2=6000)  if not equivalentGRID annotation (Placement(transformation(
            extent={{-8,-8},{8,8}},
            rotation=180,
            origin={-60,80})));
      OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
        enableV_b=true,
        v_0=powerFlow.powerflow.bus.V1,
        angle_0=powerFlow.powerflow.bus.A1,
        P_0=powerFlow.powerflow.machines.PG1,
        Q_0=powerFlow.powerflow.machines.QG1,
        V_b=6000)  if not equivalentGRID
        annotation (Placement(transformation(extent={{-112,70},{-92,90}})));
      OpenIPSL.Electrical.Branches.PwLine L1(
        R=0.001,
        X=0.2,
        G=0,
        B=0) if not equivalentGRID annotation (Placement(transformation(extent={{-26,76},
                {-14,84}})));
      OpenIPSL.Electrical.Buses.Bus Bus3(v_0=powerFlow.powerflow.bus.V3, angle_0=
            powerFlow.powerflow.bus.A3) if not equivalentGRID
        annotation (Placement(transformation(extent={{-10,70},{10,90}})));
      OpenIPSL.Electrical.Buses.Bus Bus4(v_0=powerFlow.powerflow.bus.V4, angle_0=
            powerFlow.powerflow.bus.V4) if not equivalentGRID
        annotation (Placement(transformation(extent={{50,70},{70,90}})));
      OpenIPSL.Electrical.Branches.PwLine L2_1(
        R=0.0005,
        X=0.1,
        G=0,
        B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,86},
                {36,94}})));
      OpenIPSL.Electrical.Branches.PwLine L2_2(
        R=0.0005,
        X=0.1,
        G=0,
        B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,66},
                {36,74}})));
      OpenIPSL.Electrical.Buses.Bus Bus5(angle_0=powerFlow.powerflow.bus.A5, v_0=
            powerFlow.powerflow.bus.V5)  annotation (Placement(
            transformation(
            extent={{-10,-10},{10,10}},
            rotation=90,
            origin={80,16})));
      OpenIPSL.Electrical.Branches.PwLine L3(
        R=0.001,
        X=0.2,
        G=0,
        B=0) if not equivalentGRID annotation (Placement(transformation(
            extent={{-6,-4},{6,4}},
            rotation=-90,
            origin={80,60})));
      OpenIPSL.Electrical.Buses.Bus Bus6(v_0=powerFlow.powerflow.bus.V6, angle_0=
            powerFlow.powerflow.bus.A6) annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={-10,10})));
      OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
        G=0,
        B=0,
        VNOM1=13800,
        VB1=13800,
        VNOM2=6000,
        VB2=6000,
        R=0.005,
        X=0.1)  annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={10,10})));
      GenerationUnits.PSSE.G2_16MVA                         G2(
        enableV_b=true,
        enableP_0=true,
        enableQ_0=true,
        v_0=powerFlow.powerflow.bus.V6,
        enablev_0=true,
        angle_0=powerFlow.powerflow.bus.A6,
        V_b=6000,
        P_0=powerFlow.powerflow.machines.PG2,
        Q_0=powerFlow.powerflow.machines.QG2,
        enableangle_0=true)
                      annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=0,
            origin={-30,10})));
      inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000, fn=60)
        annotation (Placement(transformation(extent={{-128,104},{-74,124}})));
      OpenIPSL.Electrical.Loads.PSSE.Load Load1(
        V_b=220000,
        P_0=powerFlow.powerflow.loads.PL1,
        Q_0=powerFlow.powerflow.loads.QL1,
        v_0=powerFlow.powerflow.bus.V3,
        angle_0=powerFlow.powerflow.bus.A3) if not equivalentGRID
        annotation (Placement(transformation(extent={{-20,48},{0,68}})));
      Electrical.Events.Breaker breaker(enableTrigger=false,
        t_o=0.25,
        rc_enabled=false,
        t_rc=80.01)       if not equivalentGRID                     annotation (Placement(transformation(
            extent={{-4,-4},{4,4}},
            rotation=90,
            origin={80,26})));

      Modelica.Blocks.Interfaces.RealInput IN1(start=0)
        "Connector of Real input signal 2" annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=0,
            origin={-150,10}),iconTransformation(extent={{-10,-10},{10,10}}, origin={-150,10})));
      Modelica.Blocks.Sources.Constant IN11(k=0)
        annotation (Placement(transformation(extent={{-108,-2},{-96,10}})));
      Modelica.Blocks.Math.Add AddU1
        annotation (Placement(transformation(extent={{-80,0},{-60,20}})));
      Modelica.Blocks.Sources.Constant IN22(k=0)
        annotation (Placement(transformation(extent={{-108,-32},{-96,-20}})));
      Modelica.Blocks.Math.Add AddU2
        annotation (Placement(transformation(extent={{-80,-30},{-60,-10}})));
      Modelica.Blocks.Interfaces.RealInput IN2(start=0)
        "Connector of Real input signal 2"
               annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=0,
            origin={-150,-12}), iconTransformation(extent={{-10,-10},{10,10}},
              origin={-150,-12})));
                Modelica.Blocks.Interfaces.RealInput IN3 "Connector of Real input signal 1"
        annotation (Placement(transformation(extent={{-160,-44},{-140,-24}}),
            iconTransformation(extent={{-160,-44},{-140,-24}})));
      Modelica.Blocks.Interfaces.RealInput IN4(start = 0) "Connector of Real input signal 1"
        annotation (Placement(transformation(extent={{-160,-66},{-140,-46}}),
            iconTransformation(extent={{-160,-66},{-140,-46}})));
      Modelica.Blocks.Interfaces.RealInput IN5(start = 0) "Connector of Real input signal 1"
        annotation (Placement(transformation(extent={{-160,-88},{-140,-68}}),
            iconTransformation(extent={{-160,-88},{-140,-68}})));

      Modelica.Blocks.Interfaces.RealOutput OUT1
        annotation (Placement(transformation(extent={{140,70},{160,90}})));
     Modelica.Blocks.Interfaces.RealOutput OUT2
        annotation (Placement(transformation(extent={{140,50},{160,70}})));
      Modelica.Blocks.Interfaces.RealOutput OUT3
        annotation (Placement(transformation(extent={{140,30},{160,50}})));

      PFData.PowerFlow powerFlow(redeclare record PowerFlow =
            OpenIPSL.Examples.ModelPredictiveControl.PFData.PF16)
        annotation (Placement(transformation(extent={{-68,104},{-48,124}})));
      Electrical.Machines.PSSE.GENCLS IB(
        V_b=220000,
        v_0=powerFlow.powerflow.bus.V4,
        angle_0=powerFlow.powerflow.bus.A4,
        P_0=powerFlow.powerflow.machines.Pinf,
        Q_0=powerFlow.powerflow.machines.Qinf,
        M_b=100000000,
        X_d=1) if not equivalentGRID annotation (Placement(transformation(extent={{110,70},
                {100,90}})));
      Electrical.Loads.PSSE.Load_ExtInput Load2(
        P_0=powerFlow.powerflow.loads.PL2,
        Q_0=powerFlow.powerflow.loads.QL2,
        v_0=powerFlow.powerflow.bus.V5,
        angle_0=powerFlow.powerflow.bus.A5,
        d_P=0,
        t1=100,
        d_t=1000)
        annotation (Placement(transformation(extent={{100,-30},{120,-10}})));

      inner Modelica.Blocks.Noise.GlobalSeed globalSeed(useAutomaticSeed=false,
          fixedSeed=10000)
        annotation (Placement(transformation(extent={{-42,102},{-22,122}})));
      Modelica.Blocks.Sources.Sine sine(
        amplitude=0,
        f=1/260,
        phase=3.1415926535898,
        startTime=1000)
        annotation (Placement(transformation(extent={{70,-36},{80,-26}})));

      Electrical.Buses.Bus Bus10(v_0=powerFlow.powerflow.bus.V10, angle_0=powerFlow.powerflow.bus.A10)
        annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={-10,-90})));
      Electrical.Branches.PSSE.TwoWindingTransformer          T4(
        G=0,
        B=0,
        CW=1,
        VNOM1=13800,
        VB1=13800,
        VNOM2=480,
        VB2=480,
        R=0.001,
        X=0.1)  annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={10,-90})));
      GenerationUnits.PSSE.Solar_Units.SolarMPCLocalVQControl PV(
        V_b=480,
        P_0=powerFlow.powerflow.machines.PPV,
        enableP_0=true,
        Q_0=powerFlow.powerflow.machines.QPV,
        enableQ_0=true,
        v_0=powerFlow.powerflow.bus.V8,
        enablev_0=true,
        angle_0=powerFlow.powerflow.bus.A8,
        enableangle_0=true)
        annotation (Placement(transformation(extent={{-40,-60},{-20,-40}})));
      Modelica.Blocks.Math.Add AddU3
        annotation (Placement(transformation(extent={{-80,-60},{-60,-40}})));
      Modelica.Blocks.Sources.Constant IN33(k=0)
        annotation (Placement(transformation(extent={{-108,-62},{-96,-50}})));

      Modelica.Blocks.Math.Add AddU4
        annotation (Placement(transformation(extent={{-80,-90},{-60,-70}})));
      Modelica.Blocks.Math.Add AddU5
        annotation (Placement(transformation(extent={{-80,-116},{-60,-96}})));
      Modelica.Blocks.Sources.Constant IN44(k=0)
        annotation (Placement(transformation(extent={{-108,-92},{-96,-80}})));
      Modelica.Blocks.Sources.Constant IN55(k=0)
        annotation (Placement(transformation(extent={{-108,-118},{-96,-106}})));
      Modelica.Blocks.Interfaces.RealOutput OUT4
        annotation (Placement(transformation(extent={{140,10},{160,30}})));
      Modelica.Blocks.Interfaces.RealOutput OUT5
        annotation (Placement(transformation(extent={{140,-10},{160,10}})));
      Modelica.Blocks.Interfaces.RealOutput OUT6
        annotation (Placement(transformation(extent={{140,-30},{160,-10}})));
      Modelica.Blocks.Interfaces.RealOutput OUT7
        annotation (Placement(transformation(extent={{140,-50},{160,-30}})));
      Modelica.Blocks.Interfaces.RealOutput OUT8
        annotation (Placement(transformation(extent={{140,-70},{160,-50}})));
      Modelica.Blocks.Interfaces.RealOutput OUT9
        annotation (Placement(transformation(extent={{140,-90},{160,-70}})));
      Modelica.Blocks.Interfaces.RealOutput OUT10
        annotation (Placement(transformation(extent={{140,-110},{160,-90}})));
      Modelica.Blocks.Interfaces.RealOutput OUT11
        annotation (Placement(transformation(extent={{164,70},{184,90}})));
      Modelica.Blocks.Interfaces.RealOutput OUT12
        annotation (Placement(transformation(extent={{164,50},{184,70}})));
      Modelica.Blocks.Interfaces.RealOutput OUT13
        annotation (Placement(transformation(extent={{164,30},{184,50}})));
      Modelica.Blocks.Interfaces.RealOutput OUT14
        annotation (Placement(transformation(extent={{164,10},{184,30}})));
      Modelica.Blocks.Interfaces.RealOutput OUT15
        annotation (Placement(transformation(extent={{164,-10},{184,10}})));
      Modelica.Blocks.Interfaces.RealOutput OUT16
        annotation (Placement(transformation(extent={{164,-30},{184,-10}})));
      Modelica.Blocks.Interfaces.RealOutput OUT17
        annotation (Placement(transformation(extent={{164,-50},{184,-30}})));
      Modelica.Blocks.Interfaces.RealOutput OUT18
        annotation (Placement(transformation(extent={{164,-70},{184,-50}})));
      Modelica.Blocks.Interfaces.RealOutput OUT19
        annotation (Placement(transformation(extent={{164,-90},{184,-70}})));
      Modelica.Blocks.Interfaces.RealOutput OUT20
        annotation (Placement(transformation(extent={{164,-110},{184,-90}})));
      Modelica.Blocks.Interfaces.RealOutput OUT21
        annotation (Placement(transformation(extent={{184,70},{204,90}})));
      Modelica.Blocks.Interfaces.RealOutput OUT22
        annotation (Placement(transformation(extent={{184,50},{204,70}})));
      Modelica.Blocks.Interfaces.RealOutput OUT23
        annotation (Placement(transformation(extent={{184,30},{204,50}})));
      Modelica.Blocks.Interfaces.RealOutput OUT24
        annotation (Placement(transformation(extent={{184,10},{204,30}})));
      Modelica.Blocks.Interfaces.RealOutput OUT25
        annotation (Placement(transformation(extent={{184,-10},{204,10}})));
      GenerationUnits.PSSE.Battery_Units.BESSMPCLocalVQControl BESS(
        V_base=480,
        V_b(displayUnit="kV") = 480,
        enableV_b=true,
        P_0=powerFlow.powerflow.machines.PBESS,
        enableP_0=true,
        Q_0=powerFlow.powerflow.machines.QBESS,
        enableQ_0=true,
        v_0=powerFlow.powerflow.bus.V10,
        enablev_0=true,
        angle_0=powerFlow.powerflow.bus.A10,
        enableangle_0=true)
        annotation (Placement(transformation(extent={{-40,-100},{-20,-80}})));
      Electrical.Buses.Bus Bus8(v_0=powerFlow.powerflow.bus.V8, angle_0=powerFlow.powerflow.bus.A8)
        annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={-10,-50})));
      Electrical.Branches.PSSE.TwoWindingTransformer          T3(
        G=0,
        B=0,
        CW=1,
        VNOM1=13800,
        VB1=13800,
        VNOM2=480,
        VB2=480,
        R=0.001,
        X=0.1)  annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={12,-50})));
      Electrical.Buses.Bus Bus11(v_0=powerFlow.powerflow.bus.V11, angle_0=powerFlow.powerflow.bus.A11)
        annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={30,-90})));
      Electrical.Buses.Bus Bus9(v_0=powerFlow.powerflow.bus.V9, angle_0=powerFlow.powerflow.bus.A9)
        annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={30,-50})));
      Electrical.Buses.Bus Bus7(v_0=powerFlow.powerflow.bus.V7, angle_0=powerFlow.powerflow.bus.A7)
        annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={30,10})));
      Electrical.Branches.PwLine          L4(
        R=0.01,
        X=0.001,
        G=0,
        B=0)  annotation (Placement(transformation(extent={{38,6},{
                50,14}})));
      Electrical.Branches.PwLine          L5(
        R=0.01,
        X=0.001,
        G=0,
        B=0)  annotation (Placement(transformation(extent={{38,-54},
                {50,-46}})));
      Electrical.Branches.PwLine          L6(
        R=0.01,
        X=0.001,
        G=0,
        B=0)  annotation (Placement(transformation(extent={{38,-94},
                {50,-86}})));
      Electrical.Loads.NoiseInjections.WhiteNoiseInjection whiteNoiseInjection(
          active_sigma=0.0000000001, samplePeriod=0.1)
        annotation (Placement(transformation(extent={{68,-18},{80,-6}})));
      Modelica.Blocks.Math.Add add
        annotation (Placement(transformation(extent={{86,-18},{94,-10}})));
    equation

    OUT1 = G2.gen.w;
    OUT2 = G2.gen.delta;
    OUT3 = G2.sEXSMPC.EFD;
    OUT4 = G2.gASTMPC.simpleLag1.state;
    OUT5 = G2.gen.P;
    OUT6 = G2.gen.Q;
    OUT7 = G2.gen.p.ir;
    OUT8 = G2.gen.p.ii;
    OUT9 = G2.gen.PMECH;
    OUT10 = G2.sEXSMPC.EFD;
    OUT11 = Bus6.v;

    OUT12 =PV.rEGCA1_1.Pgen;
    OUT13 =PV.rEGCA1_1.Qgen;
    OUT14 =PV.rEGCA1_1.p.ir;
    OUT15 =PV.rEGCA1_1.p.ii;
    OUT16 = Bus8.v;

    OUT17 =BESS.rEGCA1_1.Pgen;
    OUT18 =BESS.rEGCA1_1.Qgen;
    OUT19 =BESS.rEGCA1_1.p.ir;
    OUT20 =BESS.rEGCA1_1.p.ii;
    OUT21 = Bus10.v;

    OUT22 = Load2.P;
    OUT23 = Load2.Q;

    OUT24 = Bus5.v;
    OUT25 = Bus5.angle;

      connect(T1.p, Bus2.p)
        annotation (Line(points={{-51.2,80},{-40,80}}, color={0,0,255}));
      connect(Bus1.p, T1.n)
        annotation (Line(points={{-80,80},{-68.8,80}}, color={0,0,255}));
      connect(G1.conn, Bus1.p)
        annotation (Line(points={{-91,80},{-80,80}}, color={0,0,255}));
      connect(L1.n, Bus3.p)
        annotation (Line(points={{-14.6,80},{0,80}}, color={0,0,255}));
      connect(L1.p, Bus2.p)
        annotation (Line(points={{-25.4,80},{-40,80}}, color={0,0,255}));
      connect(L2_2.n, Bus4.p) annotation (Line(points={{35.4,70},{44,70},{44,80},{60,
              80}}, color={0,0,255}));
      connect(L2_1.n, Bus4.p) annotation (Line(points={{35.4,90},{44,90},{44,80},{60,
              80}}, color={0,0,255}));
      connect(L2_1.p, Bus3.p) annotation (Line(points={{24.6,90},{16,90},{16,80},{0,
              80}}, color={0,0,255}));
      connect(L2_2.p, Bus3.p) annotation (Line(points={{24.6,70},{16,70},{16,80},{0,
              80}}, color={0,0,255}));
      connect(Load1.p, Bus3.p)
        annotation (Line(points={{-10,68},{-10,80},{0,80}}, color={0,0,255}));
      connect(L3.p, Bus4.p)
        annotation (Line(points={{80,65.4},{80,80},{60,80}}, color={0,0,255}));
      connect(breaker.s, Bus5.p)
        annotation (Line(points={{80,22},{80,16}},color={0,0,255}));
      connect(breaker.r, L3.n)
        annotation (Line(points={{80,30},{80,54.6}},color={0,0,255}));
      connect(IN11.y, AddU1.u2) annotation (Line(points={{-95.4,4},{-82,4}},
                          color={0,0,127}));
      connect(IN1, AddU1.u1) annotation (Line(points={{-150,10},{-116,10},{-116,16},
              {-82,16}},
                     color={0,0,127}));

      connect(IN22.y,AddU2. u2) annotation (Line(points={{-95.4,-26},{-82,-26}},
                     color={0,0,127}));
      connect(IN2,AddU2. u1) annotation (Line(points={{-150,-12},{-118,-12},{-118,-14},
              {-82,-14}},
                     color={0,0,127}));
      connect(AddU2.y, G2.Efd_ref)
        annotation (Line(points={{-59,-20},{-52,-20},{-52,4},{-42,4}},
                                                               color={0,0,127}));
      connect(AddU1.y, G2.P_ref1) annotation (Line(points={{-59,10},{-52,10},{-52,16},
              {-42,16}},                          color={0,0,127}));
      connect(IB.p, Bus4.p)
        annotation (Line(points={{100,80},{60,80}}, color={0,0,255}));
      connect(Load2.p, Bus5.p) annotation (Line(points={{110,-10},{110,10},{80,10},{
              80,16}},
                   color={0,0,255}));
      connect(T4.n, Bus10.p)
        annotation (Line(points={{-1,-90},{-10,-90}}, color={0,0,255}));
      connect(Bus6.p, T2.n)
        annotation (Line(points={{-10,10},{-1,10}},
                                                color={0,0,255}));
      connect(AddU3.y, PV.QINPUT) annotation (Line(points={{-59,-50},{-42,-50}},
                               color={0,0,127}));
      connect(IN33.y,AddU3. u2)
        annotation (Line(points={{-95.4,-56},{-82,-56}}, color={0,0,127}));
      connect(BESS.p1, Bus10.p)
        annotation (Line(points={{-20,-90},{-10,-90}}, color={0,0,255}));
      connect(BESS.Paux1, AddU4.y) annotation (Line(points={{-42,-84},{-54,-84},{-54,
              -80},{-59,-80}}, color={0,0,127}));
      connect(IN55.y, AddU5.u2)
        annotation (Line(points={{-95.4,-112},{-82,-112}}, color={0,0,127}));
      connect(AddU5.y, BESS.Qext1) annotation (Line(points={{-59,-106},{-52,-106},{-52,
              -96},{-42,-96}},   color={0,0,127}));
      connect(IN44.y, AddU4.u2)
        annotation (Line(points={{-95.4,-86},{-82,-86}}, color={0,0,127}));
      connect(AddU4.u1,IN4)  annotation (Line(points={{-82,-74},{-100,-74},{-100,-70},
              {-116,-70},{-116,-56},{-150,-56}}, color={0,0,127}));
      connect(AddU5.u1,IN5)  annotation (Line(points={{-82,-100},{-116,-100},{-116,-78},
              {-150,-78}}, color={0,0,127}));
      connect(G2.conn, Bus6.p) annotation (Line(points={{-19,10},{-10,10}},
                                         color={0,0,255}));
      connect(AddU3.u1, IN3) annotation (Line(points={{-82,-44},{-118,-44},{-118,-34},
              {-150,-34}}, color={0,0,127}));
      connect(PV.p1, Bus8.p)
        annotation (Line(points={{-20,-50},{-10,-50}}, color={0,0,255}));
      connect(Bus8.p, T3.n)
        annotation (Line(points={{-10,-50},{1,-50}},  color={0,0,255}));
      connect(T2.p, Bus7.p) annotation (Line(points={{21,10},{25.5,10},{25.5,10},{30,
              10}}, color={0,0,255}));
      connect(T3.p, Bus9.p)
        annotation (Line(points={{23,-50},{30,-50}}, color={0,0,255}));
      connect(T4.p, Bus11.p)
        annotation (Line(points={{21,-90},{30,-90}}, color={0,0,255}));
      connect(L4.n, Bus5.p) annotation (Line(points={{49.4,10},{60,10},{60,10},{80,10},
              {80,16}},     color={0,0,255}));
      connect(L5.n, Bus5.p) annotation (Line(points={{49.4,-50},{60,-50},{60,10},{80,
              10},{80,16}}, color={0,0,255}));
      connect(Bus11.p, L6.p)
        annotation (Line(points={{30,-90},{38.6,-90}}, color={0,0,255}));
      connect(Bus9.p, L5.p)
        annotation (Line(points={{30,-50},{38.6,-50}}, color={0,0,255}));
      connect(L6.n, Bus5.p) annotation (Line(points={{49.4,-90},{60,-90},{60,10},{80,
              10},{80,16}}, color={0,0,255}));
      connect(Bus7.p, L4.p) annotation (Line(points={{30,10},{34.3,10},{34.3,10},{38.6,
              10}}, color={0,0,255}));
      connect(sine.y, add.u2) annotation (Line(points={{80.5,-31},{85.2,-31},{85.2,-16.4}},
            color={0,0,127}));
      connect(whiteNoiseInjection.y, add.u1) annotation (Line(points={{80.54,-12.06},
              {82.87,-12.06},{82.87,-11.6},{85.2,-11.6}}, color={0,0,127}));
      connect(add.y, Load2.u) annotation (Line(points={{94.4,-14},{98.15,-14},{98.15,
              -14.5},{101.9,-14.5}}, color={0,0,127}));
        annotation (Placement(transformation(extent={{140,-20},{160,0}})),
                    Placement(transformation(extent={{140,-40},{160,-20}})),
                    Placement(transformation(extent={{140,-60},{160,-40}})),
                    Placement(transformation(extent={{140,-80},{160,-60}})),
                   Diagram(coordinateSystem(preserveAspectRatio=false,
              extent={{-140,-140},{140,140}}), graphics={
            Rectangle(
              extent={{-160,30},{-134,-90}},
              lineColor={0,140,72},
              lineThickness=0.5),
            Rectangle(
              extent={{-128,36},{124,-124}},
              lineColor={238,46,47},
              lineThickness=0.5),
            Rectangle(
              extent={{-128,98},{124,38}},
              lineColor={0,128,255},
              lineThickness=0.5),
            Text(
              extent={{78,-106},{114,-120}},
              textColor={238,46,47},
              textString="Microgrid"),
            Text(
              extent={{76,58},{128,34}},
              textColor={28,108,200},
              textString="Utility Grid"),
            Text(
              extent={{-30,-102},{34,-124}},
              textColor={0,140,72},
              textString="Linearization Unit"),
            Text(
              extent={{-164,50},{-132,30}},
              textColor={0,140,72},
              textString="Inputs"),
            Text(
              extent={{128,118},{168,98}},
              textColor={0,140,72},
              textString="Outputs")}),
        Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),
        experiment(
          StopTime=10,
          Interval=0.0001,
          __Dymola_Algorithm="Dassl"),
        Icon(coordinateSystem(extent={{-140,-140},{140,140}})));
    end MPCAppliedEnergyOriginal_V2;

    package Testing_Kalman_Filter_State_Estimation
      model MPCAppliedEnergyOriginal_v1
        "THIS ONE IS STABLE, CONTROLLABLE, OBSERVABLE!!!!!!!"
        extends Modelica.Icons.Example;

        parameter Boolean equivalentGRID = false;
        parameter Boolean equivalentsystem = false;

        OpenIPSL.Electrical.Buses.Bus Bus1(v_0=powerFlow.powerflow.bus.V1, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-90,70},{-70,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus2(v_0=powerFlow.powerflow.bus.V2, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-50,70},{-30,90}})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
          R=0.001,
          X=0.2,
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000)  if not equivalentGRID annotation (Placement(transformation(
              extent={{-8,-8},{8,8}},
              rotation=180,
              origin={-60,80})));
        OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
          enableV_b=true,
          v_0=powerFlow.powerflow.bus.V1,
          angle_0=powerFlow.powerflow.bus.A1,
          P_0=powerFlow.powerflow.machines.PG1,
          Q_0=powerFlow.powerflow.machines.QG1,
          V_b=6000)  if not equivalentGRID
          annotation (Placement(transformation(extent={{-112,70},{-92,90}})));
        OpenIPSL.Electrical.Branches.PwLine L1(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{-26,76},
                  {-14,84}})));
        OpenIPSL.Electrical.Buses.Bus Bus3(v_0=powerFlow.powerflow.bus.V3, angle_0=
              powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-10,70},{10,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus4(v_0=powerFlow.powerflow.bus.V4, angle_0=
              powerFlow.powerflow.bus.V4) if not equivalentGRID
          annotation (Placement(transformation(extent={{50,70},{70,90}})));
        OpenIPSL.Electrical.Branches.PwLine L2_1(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,86},
                  {36,94}})));
        OpenIPSL.Electrical.Branches.PwLine L2_2(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,66},
                  {36,74}})));
        OpenIPSL.Electrical.Buses.Bus Bus5(angle_0=powerFlow.powerflow.bus.A5, v_0=
              powerFlow.powerflow.bus.V5)  annotation (Placement(
              transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={80,16})));
        OpenIPSL.Electrical.Branches.PwLine L3(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=-90,
              origin={80,60})));
        OpenIPSL.Electrical.Buses.Bus Bus6(v_0=powerFlow.powerflow.bus.V6, angle_0=
              powerFlow.powerflow.bus.A6) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,10})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000,
          R=0.005,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={10,10})));
        GenerationUnits.PSSE.G2_16MVA                         G2(
          enableV_b=true,
          enableP_0=true,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V6,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A6,
          V_b=6000,
          P_0=powerFlow.powerflow.machines.PG2,
          Q_0=powerFlow.powerflow.machines.QG2,
          enableangle_0=true)
                        annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-30,10})));
        inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000, fn=60)
          annotation (Placement(transformation(extent={{-128,104},{-74,124}})));
        OpenIPSL.Electrical.Loads.PSSE.Load Load1(
          V_b=220000,
          P_0=powerFlow.powerflow.loads.PL1,
          Q_0=powerFlow.powerflow.loads.QL1,
          v_0=powerFlow.powerflow.bus.V3,
          angle_0=powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-20,48},{0,68}})));
        Electrical.Events.Breaker breaker(enableTrigger=false,
          t_o=0.25,
          rc_enabled=false,
          t_rc=80.01)       if not equivalentGRID                     annotation (Placement(transformation(
              extent={{-4,-4},{4,4}},
              rotation=90,
              origin={80,26})));

        Modelica.Blocks.Interfaces.RealInput IN1(start=0)
          "Connector of Real input signal 2" annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-150,10}),iconTransformation(extent={{-10,-10},{10,10}}, origin={-150,10})));
        Modelica.Blocks.Sources.Constant IN11(k=0)
          annotation (Placement(transformation(extent={{-108,-2},{-96,10}})));
        Modelica.Blocks.Math.Add AddU1
          annotation (Placement(transformation(extent={{-80,0},{-60,20}})));
        Modelica.Blocks.Sources.Constant IN22(k=0)
          annotation (Placement(transformation(extent={{-108,-32},{-96,-20}})));
        Modelica.Blocks.Math.Add AddU2
          annotation (Placement(transformation(extent={{-80,-30},{-60,-10}})));
        Modelica.Blocks.Interfaces.RealInput IN2(start=0)
          "Connector of Real input signal 2"
                 annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-150,-12}), iconTransformation(extent={{-10,-10},{10,10}},
                origin={-150,-12})));
                  Modelica.Blocks.Interfaces.RealInput IN3 "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-44},{-140,-24}}),
              iconTransformation(extent={{-160,-44},{-140,-24}})));
        Modelica.Blocks.Interfaces.RealInput IN4(start = 0) "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-66},{-140,-46}}),
              iconTransformation(extent={{-160,-66},{-140,-46}})));
        Modelica.Blocks.Interfaces.RealInput IN5(start = 0) "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-88},{-140,-68}}),
              iconTransformation(extent={{-160,-88},{-140,-68}})));

        Modelica.Blocks.Interfaces.RealOutput OUT1
          annotation (Placement(transformation(extent={{140,70},{160,90}})));
       Modelica.Blocks.Interfaces.RealOutput OUT2
          annotation (Placement(transformation(extent={{140,50},{160,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT3
          annotation (Placement(transformation(extent={{140,30},{160,50}})));

        PFData.PowerFlow powerFlow(redeclare record PowerFlow =
              OpenIPSL.Examples.ModelPredictiveControl.PFData.PF16)
          annotation (Placement(transformation(extent={{-68,104},{-48,124}})));
        Electrical.Machines.PSSE.GENCLS IB(
          V_b=220000,
          v_0=powerFlow.powerflow.bus.V4,
          angle_0=powerFlow.powerflow.bus.A4,
          P_0=powerFlow.powerflow.machines.Pinf,
          Q_0=powerFlow.powerflow.machines.Qinf,
          M_b=100000000,
          X_d=1) if not equivalentGRID annotation (Placement(transformation(extent={{110,70},
                  {100,90}})));
        Electrical.Loads.PSSE.Load_ExtInput Load2(
          P_0=powerFlow.powerflow.loads.PL2,
          Q_0=powerFlow.powerflow.loads.QL2,
          v_0=powerFlow.powerflow.bus.V5,
          angle_0=powerFlow.powerflow.bus.A5,
          d_P=0,
          t1=100,
          d_t=1000)
          annotation (Placement(transformation(extent={{100,-30},{120,-10}})));

        inner Modelica.Blocks.Noise.GlobalSeed globalSeed(useAutomaticSeed=false,
            fixedSeed=10000)
          annotation (Placement(transformation(extent={{-42,102},{-22,122}})));
        Modelica.Blocks.Sources.Sine sine(
          amplitude=0,
          f=1/260,
          phase=3.1415926535898,
          startTime=1000)
          annotation (Placement(transformation(extent={{70,-36},{80,-26}})));

        Electrical.Buses.Bus Bus10(v_0=powerFlow.powerflow.bus.V10, angle_0=powerFlow.powerflow.bus.A10)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,-90})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T4(
          G=0,
          B=0,
          CW=1,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={10,-90})));
        GenerationUnits.PSSE.Solar_Units.SolarMPCLocalVQControl PV(
          V_b=480,
          P_0=powerFlow.powerflow.machines.PPV,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QPV,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V8,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A8,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-60},{-20,-40}})));
        Modelica.Blocks.Math.Add AddU3
          annotation (Placement(transformation(extent={{-80,-60},{-60,-40}})));
        Modelica.Blocks.Sources.Constant IN33(k=0)
          annotation (Placement(transformation(extent={{-108,-62},{-96,-50}})));

        Modelica.Blocks.Math.Add AddU4
          annotation (Placement(transformation(extent={{-80,-90},{-60,-70}})));
        Modelica.Blocks.Math.Add AddU5
          annotation (Placement(transformation(extent={{-80,-116},{-60,-96}})));
        Modelica.Blocks.Sources.Constant IN44(k=0)
          annotation (Placement(transformation(extent={{-108,-92},{-96,-80}})));
        Modelica.Blocks.Sources.Constant IN55(k=0)
          annotation (Placement(transformation(extent={{-108,-118},{-96,-106}})));
        Modelica.Blocks.Interfaces.RealOutput OUT4
          annotation (Placement(transformation(extent={{140,10},{160,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT5
          annotation (Placement(transformation(extent={{140,-10},{160,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT6
          annotation (Placement(transformation(extent={{140,-30},{160,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT7
          annotation (Placement(transformation(extent={{140,-50},{160,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT8
          annotation (Placement(transformation(extent={{140,-70},{160,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT9
          annotation (Placement(transformation(extent={{140,-90},{160,-70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT10
          annotation (Placement(transformation(extent={{140,-110},{160,-90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT11
          annotation (Placement(transformation(extent={{164,70},{184,90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT12
          annotation (Placement(transformation(extent={{164,50},{184,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT13
          annotation (Placement(transformation(extent={{164,30},{184,50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT14
          annotation (Placement(transformation(extent={{164,10},{184,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT15
          annotation (Placement(transformation(extent={{164,-10},{184,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT16
          annotation (Placement(transformation(extent={{164,-30},{184,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT17
          annotation (Placement(transformation(extent={{164,-50},{184,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT18
          annotation (Placement(transformation(extent={{164,-70},{184,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT19
          annotation (Placement(transformation(extent={{164,-90},{184,-70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT20
          annotation (Placement(transformation(extent={{164,-110},{184,-90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT21
          annotation (Placement(transformation(extent={{184,70},{204,90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT22
          annotation (Placement(transformation(extent={{184,50},{204,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT23
          annotation (Placement(transformation(extent={{184,30},{204,50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT24
          annotation (Placement(transformation(extent={{184,10},{204,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT25
          annotation (Placement(transformation(extent={{184,-10},{204,10}})));
        GenerationUnits.PSSE.Battery_Units.BESSMPCLocalVQControl BESS(
          V_base=480,
          V_b(displayUnit="kV") = 480,
          enableV_b=true,
          P_0=powerFlow.powerflow.machines.PBESS,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QBESS,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V10,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A10,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-100},{-20,-80}})));
        Electrical.Buses.Bus Bus8(v_0=powerFlow.powerflow.bus.V8, angle_0=powerFlow.powerflow.bus.A8)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,-50})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T3(
          G=0,
          B=0,
          CW=1,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={12,-50})));
        Electrical.Buses.Bus Bus11(v_0=powerFlow.powerflow.bus.V11, angle_0=powerFlow.powerflow.bus.A11)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,-90})));
        Electrical.Buses.Bus Bus9(v_0=powerFlow.powerflow.bus.V9, angle_0=powerFlow.powerflow.bus.A9)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,-50})));
        Electrical.Buses.Bus Bus7(v_0=powerFlow.powerflow.bus.V7, angle_0=powerFlow.powerflow.bus.A7)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,10})));
        Electrical.Branches.PwLine          L4(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,6},{
                  50,14}})));
        Electrical.Branches.PwLine          L5(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,-54},
                  {50,-46}})));
        Electrical.Branches.PwLine          L6(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,-94},
                  {50,-86}})));
        Electrical.Loads.NoiseInjections.WhiteNoiseInjection whiteNoiseInjection(
            active_sigma=0.0000000001, samplePeriod=0.1)
          annotation (Placement(transformation(extent={{68,-18},{80,-6}})));
        Modelica.Blocks.Math.Add add
          annotation (Placement(transformation(extent={{86,-18},{94,-10}})));
      equation

      OUT1 = G2.gen.w;
      OUT2 = G2.gen.delta;
      OUT3 = G2.sEXSMPC.EFD;
      OUT4 = G2.gASTMPC.simpleLag1.state;
      OUT5 = G2.gen.P;
      OUT6 = G2.gen.Q;
      OUT7 = G2.gen.p.ir;
      OUT8 = G2.gen.p.ii;
      OUT9 = G2.gen.PMECH;
      OUT10 = G2.sEXSMPC.EFD;
      OUT11 = Bus6.v;

      OUT12 =PV.rEGCA1_1.Pgen;
      OUT13 =PV.rEGCA1_1.Qgen;
      OUT14 =PV.rEGCA1_1.p.ir;
      OUT15 =PV.rEGCA1_1.p.ii;
      OUT16 = Bus8.v;

      OUT17 =BESS.rEGCA1_1.Pgen;
      OUT18 =BESS.rEGCA1_1.Qgen;
      OUT19 =BESS.rEGCA1_1.p.ir;
      OUT20 =BESS.rEGCA1_1.p.ii;
      OUT21 = Bus10.v;

      OUT22 = Load2.P;
      OUT23 = Load2.Q;

      OUT24 = Bus5.v;
      OUT25 = Bus5.angle;


        connect(T1.p, Bus2.p)
          annotation (Line(points={{-51.2,80},{-40,80}}, color={0,0,255}));
        connect(Bus1.p, T1.n)
          annotation (Line(points={{-80,80},{-68.8,80}}, color={0,0,255}));
        connect(G1.conn, Bus1.p)
          annotation (Line(points={{-91,80},{-80,80}}, color={0,0,255}));
        connect(L1.n, Bus3.p)
          annotation (Line(points={{-14.6,80},{0,80}}, color={0,0,255}));
        connect(L1.p, Bus2.p)
          annotation (Line(points={{-25.4,80},{-40,80}}, color={0,0,255}));
        connect(L2_2.n, Bus4.p) annotation (Line(points={{35.4,70},{44,70},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.n, Bus4.p) annotation (Line(points={{35.4,90},{44,90},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.p, Bus3.p) annotation (Line(points={{24.6,90},{16,90},{16,80},{0,
                80}}, color={0,0,255}));
        connect(L2_2.p, Bus3.p) annotation (Line(points={{24.6,70},{16,70},{16,80},{0,
                80}}, color={0,0,255}));
        connect(Load1.p, Bus3.p)
          annotation (Line(points={{-10,68},{-10,80},{0,80}}, color={0,0,255}));
        connect(L3.p, Bus4.p)
          annotation (Line(points={{80,65.4},{80,80},{60,80}}, color={0,0,255}));
        connect(breaker.s, Bus5.p)
          annotation (Line(points={{80,22},{80,16}},color={0,0,255}));
        connect(breaker.r, L3.n)
          annotation (Line(points={{80,30},{80,54.6}},color={0,0,255}));
        connect(IN11.y, AddU1.u2) annotation (Line(points={{-95.4,4},{-82,4}},
                            color={0,0,127}));
        connect(IN1, AddU1.u1) annotation (Line(points={{-150,10},{-116,10},{-116,16},
                {-82,16}},
                       color={0,0,127}));

        connect(IN22.y,AddU2. u2) annotation (Line(points={{-95.4,-26},{-82,-26}},
                       color={0,0,127}));
        connect(IN2,AddU2. u1) annotation (Line(points={{-150,-12},{-118,-12},{-118,-14},
                {-82,-14}},
                       color={0,0,127}));
        connect(AddU2.y, G2.Efd_ref)
          annotation (Line(points={{-59,-20},{-52,-20},{-52,4},{-42,4}},
                                                                 color={0,0,127}));
        connect(AddU1.y, G2.P_ref1) annotation (Line(points={{-59,10},{-52,10},{-52,16},
                {-42,16}},                          color={0,0,127}));
        connect(IB.p, Bus4.p)
          annotation (Line(points={{100,80},{60,80}}, color={0,0,255}));
        connect(Load2.p, Bus5.p) annotation (Line(points={{110,-10},{110,10},{80,10},{
                80,16}},
                     color={0,0,255}));
        connect(T4.n, Bus10.p)
          annotation (Line(points={{-1,-90},{-10,-90}}, color={0,0,255}));
        connect(Bus6.p, T2.n)
          annotation (Line(points={{-10,10},{-1,10}},
                                                  color={0,0,255}));
        connect(AddU3.y, PV.QINPUT) annotation (Line(points={{-59,-50},{-42,-50}},
                                 color={0,0,127}));
        connect(IN33.y,AddU3. u2)
          annotation (Line(points={{-95.4,-56},{-82,-56}}, color={0,0,127}));
        connect(BESS.p1, Bus10.p)
          annotation (Line(points={{-20,-90},{-10,-90}}, color={0,0,255}));
        connect(BESS.Paux1, AddU4.y) annotation (Line(points={{-42,-84},{-54,-84},{-54,
                -80},{-59,-80}}, color={0,0,127}));
        connect(IN55.y, AddU5.u2)
          annotation (Line(points={{-95.4,-112},{-82,-112}}, color={0,0,127}));
        connect(AddU5.y, BESS.Qext1) annotation (Line(points={{-59,-106},{-52,-106},{-52,
                -96},{-42,-96}},   color={0,0,127}));
        connect(IN44.y, AddU4.u2)
          annotation (Line(points={{-95.4,-86},{-82,-86}}, color={0,0,127}));
        connect(AddU4.u1,IN4)  annotation (Line(points={{-82,-74},{-100,-74},{-100,-70},
                {-116,-70},{-116,-56},{-150,-56}}, color={0,0,127}));
        connect(AddU5.u1,IN5)  annotation (Line(points={{-82,-100},{-116,-100},{-116,-78},
                {-150,-78}}, color={0,0,127}));
        connect(G2.conn, Bus6.p) annotation (Line(points={{-19,10},{-10,10}},
                                           color={0,0,255}));
        connect(AddU3.u1, IN3) annotation (Line(points={{-82,-44},{-118,-44},{-118,-34},
                {-150,-34}}, color={0,0,127}));
        connect(PV.p1, Bus8.p)
          annotation (Line(points={{-20,-50},{-10,-50}}, color={0,0,255}));
        connect(Bus8.p, T3.n)
          annotation (Line(points={{-10,-50},{1,-50}},  color={0,0,255}));
        connect(T2.p, Bus7.p) annotation (Line(points={{21,10},{25.5,10},{25.5,10},{30,
                10}}, color={0,0,255}));
        connect(T3.p, Bus9.p)
          annotation (Line(points={{23,-50},{30,-50}}, color={0,0,255}));
        connect(T4.p, Bus11.p)
          annotation (Line(points={{21,-90},{30,-90}}, color={0,0,255}));
        connect(L4.n, Bus5.p) annotation (Line(points={{49.4,10},{60,10},{60,10},{80,10},
                {80,16}},     color={0,0,255}));
        connect(L5.n, Bus5.p) annotation (Line(points={{49.4,-50},{60,-50},{60,10},{80,
                10},{80,16}}, color={0,0,255}));
        connect(Bus11.p, L6.p)
          annotation (Line(points={{30,-90},{38.6,-90}}, color={0,0,255}));
        connect(Bus9.p, L5.p)
          annotation (Line(points={{30,-50},{38.6,-50}}, color={0,0,255}));
        connect(L6.n, Bus5.p) annotation (Line(points={{49.4,-90},{60,-90},{60,10},{80,
                10},{80,16}}, color={0,0,255}));
        connect(Bus7.p, L4.p) annotation (Line(points={{30,10},{34.3,10},{34.3,10},{38.6,
                10}}, color={0,0,255}));
        connect(sine.y, add.u2) annotation (Line(points={{80.5,-31},{85.2,-31},{85.2,-16.4}},
              color={0,0,127}));
        connect(whiteNoiseInjection.y, add.u1) annotation (Line(points={{80.54,-12.06},
                {82.87,-12.06},{82.87,-11.6},{85.2,-11.6}}, color={0,0,127}));
        connect(add.y, Load2.u) annotation (Line(points={{94.4,-14},{98.15,-14},{98.15,
                -14.5},{101.9,-14.5}}, color={0,0,127}));
          annotation (Placement(transformation(extent={{140,-20},{160,0}})),
                      Placement(transformation(extent={{140,-40},{160,-20}})),
                      Placement(transformation(extent={{140,-60},{160,-40}})),
                      Placement(transformation(extent={{140,-80},{160,-60}})),
                     Diagram(coordinateSystem(preserveAspectRatio=false,
                extent={{-140,-140},{140,140}}), graphics={
              Rectangle(
                extent={{-160,30},{-134,-90}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,36},{124,-124}},
                lineColor={238,46,47},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,98},{124,38}},
                lineColor={0,128,255},
                lineThickness=0.5),
              Text(
                extent={{78,-106},{114,-120}},
                textColor={238,46,47},
                textString="Microgrid"),
              Text(
                extent={{76,58},{128,34}},
                textColor={28,108,200},
                textString="Utility Grid"),
              Text(
                extent={{-30,-102},{34,-124}},
                textColor={0,140,72},
                textString="Linearization Unit"),
              Text(
                extent={{-164,50},{-132,30}},
                textColor={0,140,72},
                textString="Inputs")}),
          Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),experiment(
            StopTime=10,
            Interval=0.0001,
            __Dymola_Algorithm="Dassl"),
          Icon(coordinateSystem(extent={{-140,-140},{140,140}})));
      end MPCAppliedEnergyOriginal_v1;

      model MPCAppliedEnergyLinearized_v1
        "THIS ONE IS STABLE, CONTROLLABLE, OBSERVABLE!!!!!!!"
        extends Modelica.Icons.Example;

        parameter Boolean equivalentGRID = true;
        parameter Boolean equivalentsystem = false;

        OpenIPSL.Electrical.Buses.Bus Bus1(v_0=powerFlow.powerflow.bus.V1, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-90,70},{-70,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus2(v_0=powerFlow.powerflow.bus.V2, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-50,70},{-30,90}})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
          R=0.001,
          X=0.2,
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000)  if not equivalentGRID annotation (Placement(transformation(
              extent={{-8,-8},{8,8}},
              rotation=180,
              origin={-60,80})));
        OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
          enableV_b=true,
          v_0=powerFlow.powerflow.bus.V1,
          angle_0=powerFlow.powerflow.bus.A1,
          P_0=powerFlow.powerflow.machines.PG1,
          Q_0=powerFlow.powerflow.machines.QG1,
          V_b=6000)  if not equivalentGRID
          annotation (Placement(transformation(extent={{-112,70},{-92,90}})));
        OpenIPSL.Electrical.Branches.PwLine L1(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{-26,76},
                  {-14,84}})));
        OpenIPSL.Electrical.Buses.Bus Bus3(v_0=powerFlow.powerflow.bus.V3, angle_0=
              powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-10,70},{10,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus4(v_0=powerFlow.powerflow.bus.V4, angle_0=
              powerFlow.powerflow.bus.V4) if not equivalentGRID
          annotation (Placement(transformation(extent={{50,70},{70,90}})));
        OpenIPSL.Electrical.Branches.PwLine L2_1(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,86},
                  {36,94}})));
        OpenIPSL.Electrical.Branches.PwLine L2_2(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,66},
                  {36,74}})));
        OpenIPSL.Electrical.Buses.Bus Bus5(angle_0=powerFlow.powerflow.bus.A5, v_0=
              powerFlow.powerflow.bus.V5)  annotation (Placement(
              transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={80,16})));
        OpenIPSL.Electrical.Branches.PwLine L3(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=-90,
              origin={80,60})));
        OpenIPSL.Electrical.Buses.Bus Bus6(v_0=powerFlow.powerflow.bus.V6, angle_0=
              powerFlow.powerflow.bus.A6) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,10})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000,
          R=0.005,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={10,10})));
        GenerationUnits.PSSE.G2_16MVA                         G2(
          enableV_b=true,
          enableP_0=true,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V6,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A6,
          V_b=6000,
          P_0=powerFlow.powerflow.machines.PG2,
          Q_0=powerFlow.powerflow.machines.QG2,
          enableangle_0=true)
                        annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-30,10})));
        inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000, fn=60)
          annotation (Placement(transformation(extent={{-128,104},{-74,124}})));
        OpenIPSL.Electrical.Loads.PSSE.Load Load1(
          V_b=220000,
          P_0=powerFlow.powerflow.loads.PL1,
          Q_0=powerFlow.powerflow.loads.QL1,
          v_0=powerFlow.powerflow.bus.V3,
          angle_0=powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-20,48},{0,68}})));
        Electrical.Events.Breaker breaker(enableTrigger=false,
          t_o=0.05,
          rc_enabled=true,
          t_rc=10000)       if not equivalentGRID                     annotation (Placement(transformation(
              extent={{-4,-4},{4,4}},
              rotation=90,
              origin={80,26})));

        Modelica.Blocks.Interfaces.RealInput IN1(start=0)
          "Connector of Real input signal 2" annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-150,10}),iconTransformation(extent={{-10,-10},{10,10}}, origin={-150,10})));
        Modelica.Blocks.Sources.Constant IN11(k=0)
          annotation (Placement(transformation(extent={{-108,-2},{-96,10}})));
        Modelica.Blocks.Math.Add AddU1
          annotation (Placement(transformation(extent={{-80,0},{-60,20}})));
        Modelica.Blocks.Sources.Constant IN22(k=0)
          annotation (Placement(transformation(extent={{-108,-32},{-96,-20}})));
        Modelica.Blocks.Math.Add AddU2
          annotation (Placement(transformation(extent={{-80,-30},{-60,-10}})));
        Modelica.Blocks.Interfaces.RealInput IN2(start=0)
          "Connector of Real input signal 2"
                 annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-150,-12}), iconTransformation(extent={{-10,-10},{10,10}},
                origin={-150,-12})));

        Modelica.Blocks.Interfaces.RealInput IN3(start = 0) "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-44},{-140,-24}}),
              iconTransformation(extent={{-160,-44},{-140,-24}})));
        Modelica.Blocks.Interfaces.RealInput IN4(start = 0) "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-66},{-140,-46}}),
              iconTransformation(extent={{-160,-66},{-140,-46}})));
        Modelica.Blocks.Interfaces.RealInput IN5(start = 0) "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-88},{-140,-68}}),
              iconTransformation(extent={{-160,-88},{-140,-68}})));

        Modelica.Blocks.Interfaces.RealOutput OUT1
          annotation (Placement(transformation(extent={{140,70},{160,90}})));
       Modelica.Blocks.Interfaces.RealOutput OUT2
          annotation (Placement(transformation(extent={{140,50},{160,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT3
          annotation (Placement(transformation(extent={{140,30},{160,50}})));

        PFData.PowerFlow powerFlow(redeclare record PowerFlow =
              OpenIPSL.Examples.ModelPredictiveControl.PFData.PF16)
          annotation (Placement(transformation(extent={{-68,104},{-48,124}})));
        Electrical.Machines.PSSE.GENCLS IB(
          V_b=220000,
          v_0=powerFlow.powerflow.bus.V4,
          angle_0=powerFlow.powerflow.bus.A4,
          P_0=powerFlow.powerflow.machines.Pinf,
          Q_0=powerFlow.powerflow.machines.Qinf,
          M_b=100000000,
          X_d=1) if not equivalentGRID annotation (Placement(transformation(extent={{110,70},
                  {100,90}})));
        Electrical.Loads.PSSE.Load_ExtInput Load2(
          P_0=powerFlow.powerflow.loads.PL2,
          Q_0=powerFlow.powerflow.loads.QL2,
          v_0=powerFlow.powerflow.bus.V5,
          angle_0=powerFlow.powerflow.bus.A5,
          d_P=0,
          t1=100,
          d_t=1000)
          annotation (Placement(transformation(extent={{100,-30},{120,-10}})));

        inner Modelica.Blocks.Noise.GlobalSeed globalSeed(useAutomaticSeed=false,
            fixedSeed=10000)
          annotation (Placement(transformation(extent={{-42,102},{-22,122}})));

        Electrical.Buses.Bus Bus10(v_0=powerFlow.powerflow.bus.V10, angle_0=powerFlow.powerflow.bus.A10)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,-90})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T4(
          G=0,
          B=0,
          CW=1,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={10,-90})));
        GenerationUnits.PSSE.Solar_Units.SolarMPCLocalVQControl PV(
          V_b=480,
          P_0=powerFlow.powerflow.machines.PPV,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QPV,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V8,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A8,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-60},{-20,-40}})));
        Modelica.Blocks.Math.Add AddU3
          annotation (Placement(transformation(extent={{-80,-60},{-60,-40}})));
        Modelica.Blocks.Sources.Constant IN33(k=0)
          annotation (Placement(transformation(extent={{-108,-62},{-96,-50}})));

        Modelica.Blocks.Math.Add AddU4
          annotation (Placement(transformation(extent={{-80,-90},{-60,-70}})));
        Modelica.Blocks.Math.Add AddU5
          annotation (Placement(transformation(extent={{-80,-116},{-60,-96}})));
        Modelica.Blocks.Sources.Constant IN44(k=0)
          annotation (Placement(transformation(extent={{-108,-92},{-96,-80}})));
        Modelica.Blocks.Sources.Constant IN55(k=0)
          annotation (Placement(transformation(extent={{-108,-118},{-96,-106}})));
        Modelica.Blocks.Interfaces.RealOutput OUT4
          annotation (Placement(transformation(extent={{140,10},{160,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT5
          annotation (Placement(transformation(extent={{140,-10},{160,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT6
          annotation (Placement(transformation(extent={{140,-30},{160,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT7
          annotation (Placement(transformation(extent={{140,-50},{160,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT8
          annotation (Placement(transformation(extent={{140,-70},{160,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT9
          annotation (Placement(transformation(extent={{140,-90},{160,-70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT10
          annotation (Placement(transformation(extent={{140,-110},{160,-90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT11
          annotation (Placement(transformation(extent={{164,70},{184,90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT12
          annotation (Placement(transformation(extent={{164,50},{184,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT13
          annotation (Placement(transformation(extent={{164,30},{184,50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT14
          annotation (Placement(transformation(extent={{164,10},{184,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT15
          annotation (Placement(transformation(extent={{164,-10},{184,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT16
          annotation (Placement(transformation(extent={{164,-30},{184,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT17
          annotation (Placement(transformation(extent={{164,-50},{184,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT18
          annotation (Placement(transformation(extent={{164,-70},{184,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT19
          annotation (Placement(transformation(extent={{164,-90},{184,-70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT20
          annotation (Placement(transformation(extent={{164,-110},{184,-90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT21
          annotation (Placement(transformation(extent={{184,70},{204,90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT22
          annotation (Placement(transformation(extent={{184,50},{204,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT23
          annotation (Placement(transformation(extent={{184,30},{204,50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT24
          annotation (Placement(transformation(extent={{184,10},{204,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT25
          annotation (Placement(transformation(extent={{184,-10},{204,10}})));
        GenerationUnits.PSSE.Battery_Units.BESSMPCLocalVQControlLinearized
                                                                 BESS(
          V_base=480,
          V_b(displayUnit="kV") = 480,
          enableV_b=true,
          P_0=powerFlow.powerflow.machines.PBESS,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QBESS,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V10,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A10,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-100},{-20,-80}})));
        Electrical.Buses.Bus Bus8(v_0=powerFlow.powerflow.bus.V8, angle_0=powerFlow.powerflow.bus.A8)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,-50})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T3(
          G=0,
          B=0,
          CW=1,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={12,-50})));
        Electrical.Buses.Bus Bus11(v_0=powerFlow.powerflow.bus.V11, angle_0=powerFlow.powerflow.bus.A11)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,-90})));
        Electrical.Buses.Bus Bus9(v_0=powerFlow.powerflow.bus.V9, angle_0=powerFlow.powerflow.bus.A9)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,-50})));
        Electrical.Buses.Bus Bus7(v_0=powerFlow.powerflow.bus.V7, angle_0=powerFlow.powerflow.bus.A7)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,10})));
        Electrical.Branches.PwLine          L4(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,6},{
                  50,14}})));
        Electrical.Branches.PwLine          L5(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,-54},
                  {50,-46}})));
        Electrical.Branches.PwLine          L6(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,-94},
                  {50,-86}})));
        Modelica.Blocks.Sources.Sine sine(
          amplitude=0,
          f=1/260,
          phase=3.1415926535898,
          startTime=1000)
          annotation (Placement(transformation(extent={{68,-36},{78,-26}})));
        Electrical.Loads.NoiseInjections.WhiteNoiseInjection whiteNoiseInjection(
            active_sigma=0.0000000000000001,
                                       samplePeriod=0.01)
          annotation (Placement(transformation(extent={{66,-18},{78,-6}})));
        Modelica.Blocks.Math.Add add
          annotation (Placement(transformation(extent={{84,-18},{92,-10}})));
      equation

      OUT1 = G2.gen.w;
      OUT2 = G2.gen.delta;
      OUT3 = G2.sEXSMPC.EFD;
      OUT4 = G2.gASTMPC.simpleLag1.state;
      OUT5 = G2.gen.P;
      OUT6 = G2.gen.Q;
      OUT7 = G2.gen.p.ir;
      OUT8 = G2.gen.p.ii;
      OUT9 = G2.gen.PMECH;
      OUT10 = G2.sEXSMPC.EFD;
      OUT11 = Bus6.v;

      OUT12 =PV.rEGCA1_1.Pgen;
      OUT13 =PV.rEGCA1_1.Qgen;
      OUT14 =PV.rEGCA1_1.p.ir;
      OUT15 =PV.rEGCA1_1.p.ii;
      OUT16 = Bus8.v;

      OUT17 =BESS.rEGCA1_1.Pgen;
      OUT18 =BESS.rEGCA1_1.Qgen;
      OUT19 =BESS.rEGCA1_1.p.ir;
      OUT20 =BESS.rEGCA1_1.p.ii;
      OUT21 = Bus10.v;

      OUT22 = Load2.P;
      OUT23 = Load2.Q;

      OUT24 = Bus5.v;
      OUT25 = Bus5.angle;


        connect(T1.p, Bus2.p)
          annotation (Line(points={{-51.2,80},{-40,80}}, color={0,0,255}));
        connect(Bus1.p, T1.n)
          annotation (Line(points={{-80,80},{-68.8,80}}, color={0,0,255}));
        connect(G1.conn, Bus1.p)
          annotation (Line(points={{-91,80},{-80,80}}, color={0,0,255}));
        connect(L1.n, Bus3.p)
          annotation (Line(points={{-14.6,80},{0,80}}, color={0,0,255}));
        connect(L1.p, Bus2.p)
          annotation (Line(points={{-25.4,80},{-40,80}}, color={0,0,255}));
        connect(L2_2.n, Bus4.p) annotation (Line(points={{35.4,70},{44,70},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.n, Bus4.p) annotation (Line(points={{35.4,90},{44,90},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.p, Bus3.p) annotation (Line(points={{24.6,90},{16,90},{16,80},{0,
                80}}, color={0,0,255}));
        connect(L2_2.p, Bus3.p) annotation (Line(points={{24.6,70},{16,70},{16,80},{0,
                80}}, color={0,0,255}));
        connect(Load1.p, Bus3.p)
          annotation (Line(points={{-10,68},{-10,80},{0,80}}, color={0,0,255}));
        connect(L3.p, Bus4.p)
          annotation (Line(points={{80,65.4},{80,80},{60,80}}, color={0,0,255}));
        connect(breaker.s, Bus5.p)
          annotation (Line(points={{80,22},{80,16}},color={0,0,255}));
        connect(breaker.r, L3.n)
          annotation (Line(points={{80,30},{80,54.6}},color={0,0,255}));
        connect(IN11.y, AddU1.u2) annotation (Line(points={{-95.4,4},{-82,4}},
                            color={0,0,127}));
        connect(IN1, AddU1.u1) annotation (Line(points={{-150,10},{-116,10},{-116,16},
                {-82,16}},
                       color={0,0,127}));

        connect(IN22.y,AddU2. u2) annotation (Line(points={{-95.4,-26},{-82,-26}},
                       color={0,0,127}));
        connect(IN2,AddU2. u1) annotation (Line(points={{-150,-12},{-118,-12},{-118,-14},
                {-82,-14}},
                       color={0,0,127}));
        connect(AddU2.y, G2.Efd_ref)
          annotation (Line(points={{-59,-20},{-52,-20},{-52,4},{-42,4}},
                                                                 color={0,0,127}));
        connect(AddU1.y, G2.P_ref1) annotation (Line(points={{-59,10},{-52,10},{-52,16},
                {-42,16}},                          color={0,0,127}));
        connect(IB.p, Bus4.p)
          annotation (Line(points={{100,80},{60,80}}, color={0,0,255}));
        connect(Load2.p, Bus5.p) annotation (Line(points={{110,-10},{110,10},{80,10},{
                80,16}},
                     color={0,0,255}));
        connect(T4.n, Bus10.p)
          annotation (Line(points={{-1,-90},{-10,-90}}, color={0,0,255}));
        connect(Bus6.p, T2.n)
          annotation (Line(points={{-10,10},{-1,10}},
                                                  color={0,0,255}));
        connect(AddU3.y, PV.QINPUT) annotation (Line(points={{-59,-50},{-42,-50}},
                                 color={0,0,127}));
        connect(IN33.y,AddU3. u2)
          annotation (Line(points={{-95.4,-56},{-82,-56}}, color={0,0,127}));
        connect(BESS.p1, Bus10.p)
          annotation (Line(points={{-20,-90},{-10,-90}}, color={0,0,255}));
        connect(BESS.Paux1, AddU4.y) annotation (Line(points={{-42,-84},{-54,-84},{-54,
                -80},{-59,-80}}, color={0,0,127}));
        connect(IN55.y, AddU5.u2)
          annotation (Line(points={{-95.4,-112},{-82,-112}}, color={0,0,127}));
        connect(AddU5.y, BESS.Qext1) annotation (Line(points={{-59,-106},{-52,-106},{-52,
                -96},{-42,-96}},   color={0,0,127}));
        connect(IN44.y, AddU4.u2)
          annotation (Line(points={{-95.4,-86},{-82,-86}}, color={0,0,127}));
        connect(AddU4.u1,IN4)  annotation (Line(points={{-82,-74},{-100,-74},{-100,-70},
                {-116,-70},{-116,-56},{-150,-56}}, color={0,0,127}));
        connect(AddU5.u1,IN5)  annotation (Line(points={{-82,-100},{-116,-100},{-116,-78},
                {-150,-78}}, color={0,0,127}));
        connect(G2.conn, Bus6.p) annotation (Line(points={{-19,10},{-10,10}},
                                           color={0,0,255}));
        connect(AddU3.u1, IN3) annotation (Line(points={{-82,-44},{-118,-44},{-118,-34},
                {-150,-34}}, color={0,0,127}));
        connect(PV.p1, Bus8.p)
          annotation (Line(points={{-20,-50},{-10,-50}}, color={0,0,255}));
        connect(Bus8.p, T3.n)
          annotation (Line(points={{-10,-50},{1,-50}},  color={0,0,255}));
        connect(T2.p, Bus7.p) annotation (Line(points={{21,10},{25.5,10},{25.5,10},{30,
                10}}, color={0,0,255}));
        connect(T3.p, Bus9.p)
          annotation (Line(points={{23,-50},{30,-50}}, color={0,0,255}));
        connect(T4.p, Bus11.p)
          annotation (Line(points={{21,-90},{30,-90}}, color={0,0,255}));
        connect(L4.n, Bus5.p) annotation (Line(points={{49.4,10},{60,10},{60,10},{80,10},
                {80,16}},     color={0,0,255}));
        connect(L5.n, Bus5.p) annotation (Line(points={{49.4,-50},{60,-50},{60,10},{80,
                10},{80,16}}, color={0,0,255}));
        connect(Bus11.p, L6.p)
          annotation (Line(points={{30,-90},{38.6,-90}}, color={0,0,255}));
        connect(Bus9.p, L5.p)
          annotation (Line(points={{30,-50},{38.6,-50}}, color={0,0,255}));
        connect(L6.n, Bus5.p) annotation (Line(points={{49.4,-90},{60,-90},{60,10},{80,
                10},{80,16}}, color={0,0,255}));
        connect(Bus7.p, L4.p) annotation (Line(points={{30,10},{34.3,10},{34.3,10},{38.6,
                10}}, color={0,0,255}));
        connect(sine.y, add.u2) annotation (Line(points={{78.5,-31},{78.5,-16.4},
                {83.2,-16.4}}, color={0,0,127}));
        connect(whiteNoiseInjection.y, add.u1) annotation (Line(points={{78.54,
                -12.06},{80.87,-12.06},{80.87,-11.6},{83.2,-11.6}}, color={0,0,
                127}));
        connect(add.y, Load2.u) annotation (Line(points={{92.4,-14},{97.15,-14},
                {97.15,-14.5},{101.9,-14.5}}, color={0,0,127}));
          annotation (Placement(transformation(extent={{140,-20},{160,0}})),
                      Placement(transformation(extent={{140,-40},{160,-20}})),
                      Placement(transformation(extent={{140,-60},{160,-40}})),
                      Placement(transformation(extent={{140,-80},{160,-60}})),
                     Diagram(coordinateSystem(preserveAspectRatio=false,
                extent={{-140,-140},{140,140}}), graphics={
              Rectangle(
                extent={{-160,30},{-134,-90}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,36},{124,-124}},
                lineColor={238,46,47},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,98},{124,38}},
                lineColor={0,128,255},
                lineThickness=0.5),
              Text(
                extent={{78,-106},{114,-120}},
                textColor={238,46,47},
                textString="Microgrid"),
              Text(
                extent={{76,58},{128,34}},
                textColor={28,108,200},
                textString="Utility Grid"),
              Text(
                extent={{-30,-102},{34,-124}},
                textColor={0,140,72},
                textString="Linearization Unit"),
              Text(
                extent={{-164,50},{-132,30}},
                textColor={0,140,72},
                textString="Inputs")}),
          Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),experiment(StopTime=10, __Dymola_Algorithm="Dassl"),
          Icon(coordinateSystem(extent={{-140,-140},{140,140}})));
      end MPCAppliedEnergyLinearized_v1;

      model MPCAppliedEnergyOriginal_v2
        "THIS ONE IS STABLE, CONTROLLABLE, OBSERVABLE!!!!!!!"
        extends Modelica.Icons.Example;

        parameter Boolean equivalentGRID = false;
        parameter Boolean equivalentsystem = false;

        OpenIPSL.Electrical.Buses.Bus Bus1(v_0=powerFlow.powerflow.bus.V1, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-90,70},{-70,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus2(v_0=powerFlow.powerflow.bus.V2, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-50,70},{-30,90}})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
          R=0.001,
          X=0.2,
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000)  if not equivalentGRID annotation (Placement(transformation(
              extent={{-8,-8},{8,8}},
              rotation=180,
              origin={-60,80})));
        OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
          enableV_b=true,
          v_0=powerFlow.powerflow.bus.V1,
          angle_0=powerFlow.powerflow.bus.A1,
          P_0=powerFlow.powerflow.machines.PG1,
          Q_0=powerFlow.powerflow.machines.QG1,
          V_b=6000)  if not equivalentGRID
          annotation (Placement(transformation(extent={{-112,70},{-92,90}})));
        OpenIPSL.Electrical.Branches.PwLine L1(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{-26,76},
                  {-14,84}})));
        OpenIPSL.Electrical.Buses.Bus Bus3(v_0=powerFlow.powerflow.bus.V3, angle_0=
              powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-10,70},{10,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus4(v_0=powerFlow.powerflow.bus.V4, angle_0=
              powerFlow.powerflow.bus.V4) if not equivalentGRID
          annotation (Placement(transformation(extent={{50,70},{70,90}})));
        OpenIPSL.Electrical.Branches.PwLine L2_1(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,86},
                  {36,94}})));
        OpenIPSL.Electrical.Branches.PwLine L2_2(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,66},
                  {36,74}})));
        OpenIPSL.Electrical.Buses.Bus Bus5(angle_0=powerFlow.powerflow.bus.A5, v_0=
              powerFlow.powerflow.bus.V5)  annotation (Placement(
              transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={80,16})));
        OpenIPSL.Electrical.Branches.PwLine L3(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=-90,
              origin={80,60})));
        OpenIPSL.Electrical.Buses.Bus Bus6(v_0=powerFlow.powerflow.bus.V6, angle_0=
              powerFlow.powerflow.bus.A6) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,10})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000,
          R=0.005,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={10,10})));
        GenerationUnits.PSSE.G2_16MVA                         G2(
          enableV_b=true,
          enableP_0=true,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V6,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A6,
          V_b=6000,
          P_0=powerFlow.powerflow.machines.PG2,
          Q_0=powerFlow.powerflow.machines.QG2,
          enableangle_0=true)
                        annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-30,10})));
        inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000, fn=60)
          annotation (Placement(transformation(extent={{-128,104},{-74,124}})));
        OpenIPSL.Electrical.Loads.PSSE.Load Load1(
          V_b=220000,
          P_0=powerFlow.powerflow.loads.PL1,
          Q_0=powerFlow.powerflow.loads.QL1,
          v_0=powerFlow.powerflow.bus.V3,
          angle_0=powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-20,48},{0,68}})));
        Electrical.Events.Breaker breaker(enableTrigger=false,
          t_o=0.25,
          rc_enabled=false,
          t_rc=80.01)       if not equivalentGRID                     annotation (Placement(transformation(
              extent={{-4,-4},{4,4}},
              rotation=90,
              origin={80,26})));

        Modelica.Blocks.Interfaces.RealInput IN1(start=0)
          "Connector of Real input signal 2" annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-150,10}),iconTransformation(extent={{-10,-10},{10,10}}, origin={-150,10})));
        Modelica.Blocks.Sources.Constant IN11(k=0)
          annotation (Placement(transformation(extent={{-108,-2},{-96,10}})));
        Modelica.Blocks.Math.Add AddU1
          annotation (Placement(transformation(extent={{-80,0},{-60,20}})));
        Modelica.Blocks.Sources.Constant IN22(k=0)
          annotation (Placement(transformation(extent={{-108,-32},{-96,-20}})));
        Modelica.Blocks.Math.Add AddU2
          annotation (Placement(transformation(extent={{-80,-30},{-60,-10}})));
        Modelica.Blocks.Interfaces.RealInput IN2(start=0)
          "Connector of Real input signal 2"
                 annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-150,-12}), iconTransformation(extent={{-10,-10},{10,10}},
                origin={-150,-12})));
                  Modelica.Blocks.Interfaces.RealInput IN3 "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-44},{-140,-24}}),
              iconTransformation(extent={{-160,-44},{-140,-24}})));
        Modelica.Blocks.Interfaces.RealInput IN4(start = 0) "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-66},{-140,-46}}),
              iconTransformation(extent={{-160,-66},{-140,-46}})));
        Modelica.Blocks.Interfaces.RealInput IN5(start = 0) "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-88},{-140,-68}}),
              iconTransformation(extent={{-160,-88},{-140,-68}})));

        Modelica.Blocks.Interfaces.RealOutput OUT1
          annotation (Placement(transformation(extent={{140,70},{160,90}})));
       Modelica.Blocks.Interfaces.RealOutput OUT2
          annotation (Placement(transformation(extent={{140,50},{160,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT3
          annotation (Placement(transformation(extent={{140,30},{160,50}})));

        PFData.PowerFlow powerFlow(redeclare record PowerFlow =
              OpenIPSL.Examples.ModelPredictiveControl.PFData.PF16)
          annotation (Placement(transformation(extent={{-68,104},{-48,124}})));
        Electrical.Machines.PSSE.GENCLS IB(
          V_b=220000,
          v_0=powerFlow.powerflow.bus.V4,
          angle_0=powerFlow.powerflow.bus.A4,
          P_0=powerFlow.powerflow.machines.Pinf,
          Q_0=powerFlow.powerflow.machines.Qinf,
          M_b=100000000,
          X_d=1) if not equivalentGRID annotation (Placement(transformation(extent={{110,70},
                  {100,90}})));
        Electrical.Loads.PSSE.Load_ExtInput Load2(
          P_0=powerFlow.powerflow.loads.PL2,
          Q_0=powerFlow.powerflow.loads.QL2,
          v_0=powerFlow.powerflow.bus.V5,
          angle_0=powerFlow.powerflow.bus.A5,
          d_P=0,
          t1=100,
          d_t=1000)
          annotation (Placement(transformation(extent={{100,-30},{120,-10}})));

        inner Modelica.Blocks.Noise.GlobalSeed globalSeed(useAutomaticSeed=false,
            fixedSeed=10000)
          annotation (Placement(transformation(extent={{-42,102},{-22,122}})));
        Modelica.Blocks.Sources.Sine sine(
          amplitude=0,
          f=1/260,
          phase=3.1415926535898,
          startTime=1000)
          annotation (Placement(transformation(extent={{70,-36},{80,-26}})));

        Electrical.Buses.Bus Bus10(v_0=powerFlow.powerflow.bus.V10, angle_0=powerFlow.powerflow.bus.A10)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,-90})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T4(
          G=0,
          B=0,
          CW=1,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={10,-90})));
        GenerationUnits.PSSE.Solar_Units.SolarMPCLocalVQControl PV(
          V_b=480,
          P_0=powerFlow.powerflow.machines.PPV,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QPV,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V8,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A8,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-60},{-20,-40}})));
        Modelica.Blocks.Math.Add AddU3
          annotation (Placement(transformation(extent={{-80,-60},{-60,-40}})));
        Modelica.Blocks.Sources.Constant IN33(k=0)
          annotation (Placement(transformation(extent={{-108,-62},{-96,-50}})));

        Modelica.Blocks.Math.Add AddU4
          annotation (Placement(transformation(extent={{-80,-90},{-60,-70}})));
        Modelica.Blocks.Math.Add AddU5
          annotation (Placement(transformation(extent={{-80,-116},{-60,-96}})));
        Modelica.Blocks.Sources.Constant IN44(k=0)
          annotation (Placement(transformation(extent={{-108,-92},{-96,-80}})));
        Modelica.Blocks.Sources.Constant IN55(k=0)
          annotation (Placement(transformation(extent={{-108,-118},{-96,-106}})));
        Modelica.Blocks.Interfaces.RealOutput OUT4
          annotation (Placement(transformation(extent={{140,10},{160,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT5
          annotation (Placement(transformation(extent={{140,-10},{160,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT6
          annotation (Placement(transformation(extent={{140,-30},{160,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT7
          annotation (Placement(transformation(extent={{140,-50},{160,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT8
          annotation (Placement(transformation(extent={{140,-70},{160,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT9
          annotation (Placement(transformation(extent={{140,-90},{160,-70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT10
          annotation (Placement(transformation(extent={{140,-110},{160,-90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT11
          annotation (Placement(transformation(extent={{164,70},{184,90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT12
          annotation (Placement(transformation(extent={{164,50},{184,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT13
          annotation (Placement(transformation(extent={{164,30},{184,50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT14
          annotation (Placement(transformation(extent={{164,10},{184,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT15
          annotation (Placement(transformation(extent={{164,-10},{184,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT16
          annotation (Placement(transformation(extent={{164,-30},{184,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT17
          annotation (Placement(transformation(extent={{164,-50},{184,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT18
          annotation (Placement(transformation(extent={{164,-70},{184,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT19
          annotation (Placement(transformation(extent={{164,-90},{184,-70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT20
          annotation (Placement(transformation(extent={{164,-110},{184,-90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT21
          annotation (Placement(transformation(extent={{184,70},{204,90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT22
          annotation (Placement(transformation(extent={{184,50},{204,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT23
          annotation (Placement(transformation(extent={{184,30},{204,50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT24
          annotation (Placement(transformation(extent={{184,10},{204,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT25
          annotation (Placement(transformation(extent={{184,-10},{204,10}})));
        GenerationUnits.PSSE.Battery_Units.BESSMPCLocalVQControl BESS(
          V_base=480,
          V_b(displayUnit="kV") = 480,
          enableV_b=true,
          P_0=powerFlow.powerflow.machines.PBESS,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QBESS,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V10,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A10,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-100},{-20,-80}})));
        Electrical.Buses.Bus Bus8(v_0=powerFlow.powerflow.bus.V8, angle_0=powerFlow.powerflow.bus.A8)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,-50})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T3(
          G=0,
          B=0,
          CW=1,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={12,-50})));
        Electrical.Buses.Bus Bus11(v_0=powerFlow.powerflow.bus.V11, angle_0=powerFlow.powerflow.bus.A11)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,-90})));
        Electrical.Buses.Bus Bus9(v_0=powerFlow.powerflow.bus.V9, angle_0=powerFlow.powerflow.bus.A9)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,-50})));
        Electrical.Buses.Bus Bus7(v_0=powerFlow.powerflow.bus.V7, angle_0=powerFlow.powerflow.bus.A7)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,10})));
        Electrical.Branches.PwLine          L4(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,6},{
                  50,14}})));
        Electrical.Branches.PwLine          L5(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,-54},
                  {50,-46}})));
        Electrical.Branches.PwLine          L6(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,-94},
                  {50,-86}})));
        Electrical.Loads.NoiseInjections.WhiteNoiseInjection whiteNoiseInjection(
            active_sigma=0.0000000001, samplePeriod=0.1)
          annotation (Placement(transformation(extent={{68,-18},{80,-6}})));
        Modelica.Blocks.Math.Add add
          annotation (Placement(transformation(extent={{86,-18},{94,-10}})));
      equation

      OUT1 = G2.gen.w;
      OUT2 = G2.gen.delta;
      OUT3 = G2.sEXSMPC.EFD;
      OUT4 = G2.gASTMPC.simpleLag1.state;
      OUT5 = G2.gen.P;
      OUT6 = G2.gen.Q;
      OUT7 = G2.gen.p.ir;
      OUT8 = G2.gen.p.ii;
      OUT9 = G2.gen.PMECH;
      OUT10 = G2.sEXSMPC.EFD;
      OUT11 = Bus6.v;

      OUT12 =PV.rEGCA1_1.Pgen;
      OUT13 =PV.rEGCA1_1.Qgen;
      OUT14 =PV.rEGCA1_1.p.ir;
      OUT15 =PV.rEGCA1_1.p.ii;
      OUT16 = Bus8.v;

      OUT17 =BESS.rEGCA1_1.Pgen;
      OUT18 =BESS.rEGCA1_1.Qgen;
      OUT19 =BESS.rEGCA1_1.p.ir;
      OUT20 =BESS.rEGCA1_1.p.ii;
      OUT21 = Bus10.v;

      OUT22 = Load2.P;
      OUT23 = Load2.Q;

      OUT24 = Bus5.v;
      OUT25 = Bus5.angle;

        connect(T1.p, Bus2.p)
          annotation (Line(points={{-51.2,80},{-40,80}}, color={0,0,255}));
        connect(Bus1.p, T1.n)
          annotation (Line(points={{-80,80},{-68.8,80}}, color={0,0,255}));
        connect(G1.conn, Bus1.p)
          annotation (Line(points={{-91,80},{-80,80}}, color={0,0,255}));
        connect(L1.n, Bus3.p)
          annotation (Line(points={{-14.6,80},{0,80}}, color={0,0,255}));
        connect(L1.p, Bus2.p)
          annotation (Line(points={{-25.4,80},{-40,80}}, color={0,0,255}));
        connect(L2_2.n, Bus4.p) annotation (Line(points={{35.4,70},{44,70},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.n, Bus4.p) annotation (Line(points={{35.4,90},{44,90},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.p, Bus3.p) annotation (Line(points={{24.6,90},{16,90},{16,80},{0,
                80}}, color={0,0,255}));
        connect(L2_2.p, Bus3.p) annotation (Line(points={{24.6,70},{16,70},{16,80},{0,
                80}}, color={0,0,255}));
        connect(Load1.p, Bus3.p)
          annotation (Line(points={{-10,68},{-10,80},{0,80}}, color={0,0,255}));
        connect(L3.p, Bus4.p)
          annotation (Line(points={{80,65.4},{80,80},{60,80}}, color={0,0,255}));
        connect(breaker.s, Bus5.p)
          annotation (Line(points={{80,22},{80,16}},color={0,0,255}));
        connect(breaker.r, L3.n)
          annotation (Line(points={{80,30},{80,54.6}},color={0,0,255}));
        connect(IN11.y, AddU1.u2) annotation (Line(points={{-95.4,4},{-82,4}},
                            color={0,0,127}));
        connect(IN1, AddU1.u1) annotation (Line(points={{-150,10},{-116,10},{-116,16},
                {-82,16}},
                       color={0,0,127}));

        connect(IN22.y,AddU2. u2) annotation (Line(points={{-95.4,-26},{-82,-26}},
                       color={0,0,127}));
        connect(IN2,AddU2. u1) annotation (Line(points={{-150,-12},{-118,-12},{-118,-14},
                {-82,-14}},
                       color={0,0,127}));
        connect(AddU2.y, G2.Efd_ref)
          annotation (Line(points={{-59,-20},{-52,-20},{-52,4},{-42,4}},
                                                                 color={0,0,127}));
        connect(AddU1.y, G2.P_ref1) annotation (Line(points={{-59,10},{-52,10},{-52,16},
                {-42,16}},                          color={0,0,127}));
        connect(IB.p, Bus4.p)
          annotation (Line(points={{100,80},{60,80}}, color={0,0,255}));
        connect(Load2.p, Bus5.p) annotation (Line(points={{110,-10},{110,10},{80,10},{
                80,16}},
                     color={0,0,255}));
        connect(T4.n, Bus10.p)
          annotation (Line(points={{-1,-90},{-10,-90}}, color={0,0,255}));
        connect(Bus6.p, T2.n)
          annotation (Line(points={{-10,10},{-1,10}},
                                                  color={0,0,255}));
        connect(AddU3.y, PV.QINPUT) annotation (Line(points={{-59,-50},{-42,-50}},
                                 color={0,0,127}));
        connect(IN33.y,AddU3. u2)
          annotation (Line(points={{-95.4,-56},{-82,-56}}, color={0,0,127}));
        connect(BESS.p1, Bus10.p)
          annotation (Line(points={{-20,-90},{-10,-90}}, color={0,0,255}));
        connect(BESS.Paux1, AddU4.y) annotation (Line(points={{-42,-84},{-54,-84},{-54,
                -80},{-59,-80}}, color={0,0,127}));
        connect(IN55.y, AddU5.u2)
          annotation (Line(points={{-95.4,-112},{-82,-112}}, color={0,0,127}));
        connect(AddU5.y, BESS.Qext1) annotation (Line(points={{-59,-106},{-52,-106},{-52,
                -96},{-42,-96}},   color={0,0,127}));
        connect(IN44.y, AddU4.u2)
          annotation (Line(points={{-95.4,-86},{-82,-86}}, color={0,0,127}));
        connect(AddU4.u1,IN4)  annotation (Line(points={{-82,-74},{-100,-74},{-100,-70},
                {-116,-70},{-116,-56},{-150,-56}}, color={0,0,127}));
        connect(AddU5.u1,IN5)  annotation (Line(points={{-82,-100},{-116,-100},{-116,-78},
                {-150,-78}}, color={0,0,127}));
        connect(G2.conn, Bus6.p) annotation (Line(points={{-19,10},{-10,10}},
                                           color={0,0,255}));
        connect(AddU3.u1, IN3) annotation (Line(points={{-82,-44},{-118,-44},{-118,-34},
                {-150,-34}}, color={0,0,127}));
        connect(PV.p1, Bus8.p)
          annotation (Line(points={{-20,-50},{-10,-50}}, color={0,0,255}));
        connect(Bus8.p, T3.n)
          annotation (Line(points={{-10,-50},{1,-50}},  color={0,0,255}));
        connect(T2.p, Bus7.p) annotation (Line(points={{21,10},{25.5,10},{25.5,10},{30,
                10}}, color={0,0,255}));
        connect(T3.p, Bus9.p)
          annotation (Line(points={{23,-50},{30,-50}}, color={0,0,255}));
        connect(T4.p, Bus11.p)
          annotation (Line(points={{21,-90},{30,-90}}, color={0,0,255}));
        connect(L4.n, Bus5.p) annotation (Line(points={{49.4,10},{60,10},{60,10},{80,10},
                {80,16}},     color={0,0,255}));
        connect(L5.n, Bus5.p) annotation (Line(points={{49.4,-50},{60,-50},{60,10},{80,
                10},{80,16}}, color={0,0,255}));
        connect(Bus11.p, L6.p)
          annotation (Line(points={{30,-90},{38.6,-90}}, color={0,0,255}));
        connect(Bus9.p, L5.p)
          annotation (Line(points={{30,-50},{38.6,-50}}, color={0,0,255}));
        connect(L6.n, Bus5.p) annotation (Line(points={{49.4,-90},{60,-90},{60,10},{80,
                10},{80,16}}, color={0,0,255}));
        connect(Bus7.p, L4.p) annotation (Line(points={{30,10},{34.3,10},{34.3,10},{38.6,
                10}}, color={0,0,255}));
        connect(sine.y, add.u2) annotation (Line(points={{80.5,-31},{85.2,-31},{85.2,-16.4}},
              color={0,0,127}));
        connect(whiteNoiseInjection.y, add.u1) annotation (Line(points={{80.54,-12.06},
                {82.87,-12.06},{82.87,-11.6},{85.2,-11.6}}, color={0,0,127}));
        connect(add.y, Load2.u) annotation (Line(points={{94.4,-14},{98.15,-14},{98.15,
                -14.5},{101.9,-14.5}}, color={0,0,127}));
          annotation (Placement(transformation(extent={{140,-20},{160,0}})),
                      Placement(transformation(extent={{140,-40},{160,-20}})),
                      Placement(transformation(extent={{140,-60},{160,-40}})),
                      Placement(transformation(extent={{140,-80},{160,-60}})),
                     Diagram(coordinateSystem(preserveAspectRatio=false,
                extent={{-140,-140},{140,140}}), graphics={
              Rectangle(
                extent={{-160,30},{-134,-90}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,36},{124,-124}},
                lineColor={238,46,47},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,98},{124,38}},
                lineColor={0,128,255},
                lineThickness=0.5),
              Text(
                extent={{78,-106},{114,-120}},
                textColor={238,46,47},
                textString="Microgrid"),
              Text(
                extent={{76,58},{128,34}},
                textColor={28,108,200},
                textString="Utility Grid"),
              Text(
                extent={{-30,-102},{34,-124}},
                textColor={0,140,72},
                textString="Linearization Unit"),
              Text(
                extent={{-164,50},{-132,30}},
                textColor={0,140,72},
                textString="Inputs")}),
          Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),experiment(
            StopTime=10,
            Interval=0.0001,
            __Dymola_Algorithm="Dassl"),
          Icon(coordinateSystem(extent={{-140,-140},{140,140}})));
      end MPCAppliedEnergyOriginal_v2;

      model MPCAppliedEnergyLinearized_v2
        "THIS ONE IS STABLE, CONTROLLABLE, OBSERVABLE!!!!!!!"
        extends Modelica.Icons.Example;

        parameter Boolean equivalentGRID = true;
        parameter Boolean equivalentsystem = false;

        OpenIPSL.Electrical.Buses.Bus Bus1(v_0=powerFlow.powerflow.bus.V1, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-90,70},{-70,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus2(v_0=powerFlow.powerflow.bus.V2, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-50,70},{-30,90}})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
          R=0.001,
          X=0.2,
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000)  if not equivalentGRID annotation (Placement(transformation(
              extent={{-8,-8},{8,8}},
              rotation=180,
              origin={-60,80})));
        OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
          enableV_b=true,
          v_0=powerFlow.powerflow.bus.V1,
          angle_0=powerFlow.powerflow.bus.A1,
          P_0=powerFlow.powerflow.machines.PG1,
          Q_0=powerFlow.powerflow.machines.QG1,
          V_b=6000)  if not equivalentGRID
          annotation (Placement(transformation(extent={{-112,70},{-92,90}})));
        OpenIPSL.Electrical.Branches.PwLine L1(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{-26,76},
                  {-14,84}})));
        OpenIPSL.Electrical.Buses.Bus Bus3(v_0=powerFlow.powerflow.bus.V3, angle_0=
              powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-10,70},{10,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus4(v_0=powerFlow.powerflow.bus.V4, angle_0=
              powerFlow.powerflow.bus.V4) if not equivalentGRID
          annotation (Placement(transformation(extent={{50,70},{70,90}})));
        OpenIPSL.Electrical.Branches.PwLine L2_1(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,86},
                  {36,94}})));
        OpenIPSL.Electrical.Branches.PwLine L2_2(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,66},
                  {36,74}})));
        OpenIPSL.Electrical.Buses.Bus Bus5(angle_0=powerFlow.powerflow.bus.A5, v_0=
              powerFlow.powerflow.bus.V5)  annotation (Placement(
              transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={80,16})));
        OpenIPSL.Electrical.Branches.PwLine L3(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=-90,
              origin={80,60})));
        OpenIPSL.Electrical.Buses.Bus Bus6(v_0=powerFlow.powerflow.bus.V6, angle_0=
              powerFlow.powerflow.bus.A6) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,10})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000,
          R=0.005,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={10,10})));
        GenerationUnits.PSSE.G2_16MVA                         G2(
          enableV_b=true,
          enableP_0=true,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V6,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A6,
          V_b=6000,
          P_0=powerFlow.powerflow.machines.PG2,
          Q_0=powerFlow.powerflow.machines.QG2,
          enableangle_0=true)
                        annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-30,10})));
        inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000, fn=60)
          annotation (Placement(transformation(extent={{-128,104},{-74,124}})));
        OpenIPSL.Electrical.Loads.PSSE.Load Load1(
          V_b=220000,
          P_0=powerFlow.powerflow.loads.PL1,
          Q_0=powerFlow.powerflow.loads.QL1,
          v_0=powerFlow.powerflow.bus.V3,
          angle_0=powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-20,48},{0,68}})));
        Electrical.Events.Breaker breaker(enableTrigger=false,
          t_o=0.25,
          rc_enabled=true,
          t_rc=10000)       if not equivalentGRID                     annotation (Placement(transformation(
              extent={{-4,-4},{4,4}},
              rotation=90,
              origin={80,26})));

        Modelica.Blocks.Interfaces.RealInput IN1(start=0)
          "Connector of Real input signal 2" annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-150,10}),iconTransformation(extent={{-10,-10},{10,10}}, origin={-150,10})));
        Modelica.Blocks.Sources.Constant IN11(k=0)
          annotation (Placement(transformation(extent={{-108,-2},{-96,10}})));
        Modelica.Blocks.Math.Add AddU1
          annotation (Placement(transformation(extent={{-80,0},{-60,20}})));
        Modelica.Blocks.Sources.Constant IN22(k=0)
          annotation (Placement(transformation(extent={{-108,-32},{-96,-20}})));
        Modelica.Blocks.Math.Add AddU2
          annotation (Placement(transformation(extent={{-80,-30},{-60,-10}})));
        Modelica.Blocks.Interfaces.RealInput IN2(start=0)
          "Connector of Real input signal 2"
                 annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-150,-12}), iconTransformation(extent={{-10,-10},{10,10}},
                origin={-150,-12})));

        Modelica.Blocks.Interfaces.RealInput IN3(start = 0) "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-44},{-140,-24}}),
              iconTransformation(extent={{-160,-44},{-140,-24}})));
        Modelica.Blocks.Interfaces.RealInput IN4(start = 0) "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-66},{-140,-46}}),
              iconTransformation(extent={{-160,-66},{-140,-46}})));
        Modelica.Blocks.Interfaces.RealInput IN5(start = 0) "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-88},{-140,-68}}),
              iconTransformation(extent={{-160,-88},{-140,-68}})));

        PFData.PowerFlow powerFlow(redeclare record PowerFlow =
              OpenIPSL.Examples.ModelPredictiveControl.PFData.PF16)
          annotation (Placement(transformation(extent={{-68,104},{-48,124}})));
        Electrical.Machines.PSSE.GENCLS IB(
          V_b=220000,
          v_0=powerFlow.powerflow.bus.V4,
          angle_0=powerFlow.powerflow.bus.A4,
          P_0=powerFlow.powerflow.machines.Pinf,
          Q_0=powerFlow.powerflow.machines.Qinf,
          M_b=100000000,
          X_d=1) if not equivalentGRID annotation (Placement(transformation(extent={{110,70},
                  {100,90}})));
        Electrical.Loads.PSSE.Load_ExtInput Load2(
          P_0=powerFlow.powerflow.loads.PL2,
          Q_0=powerFlow.powerflow.loads.QL2,
          v_0=powerFlow.powerflow.bus.V5,
          angle_0=powerFlow.powerflow.bus.A5,
          d_P=0,
          t1=100,
          d_t=1000)
          annotation (Placement(transformation(extent={{100,-30},{120,-10}})));

        inner Modelica.Blocks.Noise.GlobalSeed globalSeed(useAutomaticSeed=false,
            fixedSeed=10000)
          annotation (Placement(transformation(extent={{-42,102},{-22,122}})));

        Electrical.Buses.Bus Bus10(v_0=powerFlow.powerflow.bus.V10, angle_0=powerFlow.powerflow.bus.A10)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,-90})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T4(
          G=0,
          B=0,
          CW=1,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={10,-90})));
        GenerationUnits.PSSE.Solar_Units.SolarMPCSysIdentification
                                                                PV(
          V_b=480,
          P_0=powerFlow.powerflow.machines.PPV,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QPV,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V8,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A8,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-60},{-20,-40}})));
        Modelica.Blocks.Math.Add AddU3
          annotation (Placement(transformation(extent={{-80,-60},{-60,-40}})));
        Modelica.Blocks.Sources.Constant IN33(k=0)
          annotation (Placement(transformation(extent={{-108,-62},{-96,-50}})));

        Modelica.Blocks.Math.Add AddU4
          annotation (Placement(transformation(extent={{-80,-90},{-60,-70}})));
        Modelica.Blocks.Math.Add AddU5
          annotation (Placement(transformation(extent={{-80,-116},{-60,-96}})));
        Modelica.Blocks.Sources.Constant IN44(k=0)
          annotation (Placement(transformation(extent={{-108,-92},{-96,-80}})));
        Modelica.Blocks.Sources.Constant IN55(k=0)
          annotation (Placement(transformation(extent={{-108,-118},{-96,-106}})));
        GenerationUnits.PSSE.Battery_Units.BESSMPCSysIdentification
                                                                 BESS(
          V_base=480,
          V_b(displayUnit="kV") = 480,
          enableV_b=true,
          P_0=powerFlow.powerflow.machines.PBESS,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QBESS,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V10,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A10,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-100},{-20,-80}})));
        Electrical.Buses.Bus Bus8(v_0=powerFlow.powerflow.bus.V8, angle_0=powerFlow.powerflow.bus.A8)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,-50})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T3(
          G=0,
          B=0,
          CW=1,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={12,-50})));
        Electrical.Buses.Bus Bus11(v_0=powerFlow.powerflow.bus.V11, angle_0=powerFlow.powerflow.bus.A11)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,-90})));
        Electrical.Buses.Bus Bus9(v_0=powerFlow.powerflow.bus.V9, angle_0=powerFlow.powerflow.bus.A9)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,-50})));
        Electrical.Buses.Bus Bus7(v_0=powerFlow.powerflow.bus.V7, angle_0=powerFlow.powerflow.bus.A7)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,10})));
        Electrical.Branches.PwLine          L4(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,6},{
                  50,14}})));
        Electrical.Branches.PwLine          L5(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,-54},
                  {50,-46}})));
        Electrical.Branches.PwLine          L6(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,-94},
                  {50,-86}})));
        Modelica.Blocks.Sources.Sine sine(
          amplitude=0,
          f=1/260,
          phase=3.1415926535898,
          startTime=1000)
          annotation (Placement(transformation(extent={{68,-36},{78,-26}})));
        Electrical.Loads.NoiseInjections.WhiteNoiseInjection whiteNoiseInjection(
            active_sigma=0.0000000001, samplePeriod=0.01)
          annotation (Placement(transformation(extent={{66,-18},{78,-6}})));
        Modelica.Blocks.Math.Add add
          annotation (Placement(transformation(extent={{84,-18},{92,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT1
          annotation (Placement(transformation(extent={{140,70},{160,90}})));
       Modelica.Blocks.Interfaces.RealOutput OUT2
          annotation (Placement(transformation(extent={{140,50},{160,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT3
          annotation (Placement(transformation(extent={{140,30},{160,50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT4
          annotation (Placement(transformation(extent={{140,10},{160,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT5
          annotation (Placement(transformation(extent={{140,-10},{160,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT6
          annotation (Placement(transformation(extent={{140,-30},{160,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT7
          annotation (Placement(transformation(extent={{140,-50},{160,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT8
          annotation (Placement(transformation(extent={{140,-70},{160,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT9
          annotation (Placement(transformation(extent={{140,-90},{160,-70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT10
          annotation (Placement(transformation(extent={{140,-110},{160,-90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT11
          annotation (Placement(transformation(extent={{164,70},{184,90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT12
          annotation (Placement(transformation(extent={{164,50},{184,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT13
          annotation (Placement(transformation(extent={{164,30},{184,50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT14
          annotation (Placement(transformation(extent={{164,10},{184,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT15
          annotation (Placement(transformation(extent={{164,-10},{184,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT16
          annotation (Placement(transformation(extent={{164,-30},{184,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT17
          annotation (Placement(transformation(extent={{164,-50},{184,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT18
          annotation (Placement(transformation(extent={{164,-70},{184,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT19
          annotation (Placement(transformation(extent={{164,-90},{184,-70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT20
          annotation (Placement(transformation(extent={{164,-110},{184,-90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT21
          annotation (Placement(transformation(extent={{184,70},{204,90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT22
          annotation (Placement(transformation(extent={{184,50},{204,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT23
          annotation (Placement(transformation(extent={{184,30},{204,50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT24
          annotation (Placement(transformation(extent={{184,10},{204,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT25
          annotation (Placement(transformation(extent={{184,-10},{204,10}})));
      equation

      OUT1 = G2.gen.w;
      OUT2 = G2.gen.delta;
      OUT3 = G2.sEXSMPC.EFD;
      OUT4 = G2.gASTMPC.simpleLag1.state;
      OUT5 = G2.gen.P;
      OUT6 = G2.gen.Q;
      OUT7 = G2.gen.p.ir;
      OUT8 = G2.gen.p.ii;
      OUT9 = G2.gen.PMECH;
      OUT10 = G2.sEXSMPC.EFD;
      OUT11 = Bus6.v;

      OUT12 =PV.rEGCA1_1.Pgen;
      OUT13 =PV.rEGCA1_1.Qgen;
      OUT14 =PV.rEGCA1_1.p.ir;
      OUT15 =PV.rEGCA1_1.p.ii;
      OUT16 = Bus8.v;

      OUT17 =BESS.rEGCA1_1.Pgen;
      OUT18 =BESS.rEGCA1_1.Qgen;
      OUT19 =BESS.rEGCA1_1.p.ir;
      OUT20 =BESS.rEGCA1_1.p.ii;
      OUT21 = Bus10.v;

      OUT22 = Load2.P;
      OUT23 = Load2.Q;

      OUT24 = Bus5.v;
      OUT25 = Bus5.angle;

        connect(T1.p, Bus2.p)
          annotation (Line(points={{-51.2,80},{-40,80}}, color={0,0,255}));
        connect(Bus1.p, T1.n)
          annotation (Line(points={{-80,80},{-68.8,80}}, color={0,0,255}));
        connect(G1.conn, Bus1.p)
          annotation (Line(points={{-91,80},{-80,80}}, color={0,0,255}));
        connect(L1.n, Bus3.p)
          annotation (Line(points={{-14.6,80},{0,80}}, color={0,0,255}));
        connect(L1.p, Bus2.p)
          annotation (Line(points={{-25.4,80},{-40,80}}, color={0,0,255}));
        connect(L2_2.n, Bus4.p) annotation (Line(points={{35.4,70},{44,70},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.n, Bus4.p) annotation (Line(points={{35.4,90},{44,90},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.p, Bus3.p) annotation (Line(points={{24.6,90},{16,90},{16,80},{0,
                80}}, color={0,0,255}));
        connect(L2_2.p, Bus3.p) annotation (Line(points={{24.6,70},{16,70},{16,80},{0,
                80}}, color={0,0,255}));
        connect(Load1.p, Bus3.p)
          annotation (Line(points={{-10,68},{-10,80},{0,80}}, color={0,0,255}));
        connect(L3.p, Bus4.p)
          annotation (Line(points={{80,65.4},{80,80},{60,80}}, color={0,0,255}));
        connect(breaker.s, Bus5.p)
          annotation (Line(points={{80,22},{80,16}},color={0,0,255}));
        connect(breaker.r, L3.n)
          annotation (Line(points={{80,30},{80,54.6}},color={0,0,255}));
        connect(IN11.y, AddU1.u2) annotation (Line(points={{-95.4,4},{-82,4}},
                            color={0,0,127}));
        connect(IN1, AddU1.u1) annotation (Line(points={{-150,10},{-116,10},{-116,16},
                {-82,16}},
                       color={0,0,127}));

        connect(IN22.y,AddU2. u2) annotation (Line(points={{-95.4,-26},{-82,-26}},
                       color={0,0,127}));
        connect(IN2,AddU2. u1) annotation (Line(points={{-150,-12},{-118,-12},{-118,-14},
                {-82,-14}},
                       color={0,0,127}));
        connect(AddU2.y, G2.Efd_ref)
          annotation (Line(points={{-59,-20},{-52,-20},{-52,4},{-42,4}},
                                                                 color={0,0,127}));
        connect(AddU1.y, G2.P_ref1) annotation (Line(points={{-59,10},{-52,10},{-52,16},
                {-42,16}},                          color={0,0,127}));
        connect(IB.p, Bus4.p)
          annotation (Line(points={{100,80},{60,80}}, color={0,0,255}));
        connect(Load2.p, Bus5.p) annotation (Line(points={{110,-10},{110,10},{80,10},{
                80,16}},
                     color={0,0,255}));
        connect(T4.n, Bus10.p)
          annotation (Line(points={{-1,-90},{-10,-90}}, color={0,0,255}));
        connect(Bus6.p, T2.n)
          annotation (Line(points={{-10,10},{-1,10}},
                                                  color={0,0,255}));
        connect(IN33.y,AddU3. u2)
          annotation (Line(points={{-95.4,-56},{-82,-56}}, color={0,0,127}));
        connect(BESS.p1, Bus10.p)
          annotation (Line(points={{-20,-90},{-10,-90}}, color={0,0,255}));
        connect(BESS.Paux1, AddU4.y) annotation (Line(points={{-42,-84},{-54,-84},{-54,
                -80},{-59,-80}}, color={0,0,127}));
        connect(IN55.y, AddU5.u2)
          annotation (Line(points={{-95.4,-112},{-82,-112}}, color={0,0,127}));
        connect(AddU5.y, BESS.Qext1) annotation (Line(points={{-59,-106},{-52,-106},{-52,
                -96},{-42,-96}},   color={0,0,127}));
        connect(IN44.y, AddU4.u2)
          annotation (Line(points={{-95.4,-86},{-82,-86}}, color={0,0,127}));
        connect(AddU4.u1,IN4)  annotation (Line(points={{-82,-74},{-100,-74},{-100,-70},
                {-116,-70},{-116,-56},{-150,-56}}, color={0,0,127}));
        connect(AddU5.u1,IN5)  annotation (Line(points={{-82,-100},{-116,-100},{-116,-78},
                {-150,-78}}, color={0,0,127}));
        connect(G2.conn, Bus6.p) annotation (Line(points={{-19,10},{-10,10}},
                                           color={0,0,255}));
        connect(AddU3.u1, IN3) annotation (Line(points={{-82,-44},{-118,-44},{-118,-34},
                {-150,-34}}, color={0,0,127}));
        connect(PV.p1, Bus8.p)
          annotation (Line(points={{-20,-50},{-10,-50}}, color={0,0,255}));
        connect(Bus8.p, T3.n)
          annotation (Line(points={{-10,-50},{1,-50}},  color={0,0,255}));
        connect(T2.p, Bus7.p) annotation (Line(points={{21,10},{25.5,10},{25.5,10},{30,
                10}}, color={0,0,255}));
        connect(T3.p, Bus9.p)
          annotation (Line(points={{23,-50},{30,-50}}, color={0,0,255}));
        connect(T4.p, Bus11.p)
          annotation (Line(points={{21,-90},{30,-90}}, color={0,0,255}));
        connect(L4.n, Bus5.p) annotation (Line(points={{49.4,10},{60,10},{60,10},{80,10},
                {80,16}},     color={0,0,255}));
        connect(L5.n, Bus5.p) annotation (Line(points={{49.4,-50},{60,-50},{60,10},{80,
                10},{80,16}}, color={0,0,255}));
        connect(Bus11.p, L6.p)
          annotation (Line(points={{30,-90},{38.6,-90}}, color={0,0,255}));
        connect(Bus9.p, L5.p)
          annotation (Line(points={{30,-50},{38.6,-50}}, color={0,0,255}));
        connect(L6.n, Bus5.p) annotation (Line(points={{49.4,-90},{60,-90},{60,10},{80,
                10},{80,16}}, color={0,0,255}));
        connect(Bus7.p, L4.p) annotation (Line(points={{30,10},{34.3,10},{34.3,10},{38.6,
                10}}, color={0,0,255}));
        connect(sine.y, add.u2) annotation (Line(points={{78.5,-31},{78.5,-16.4},
                {83.2,-16.4}}, color={0,0,127}));
        connect(whiteNoiseInjection.y, add.u1) annotation (Line(points={{78.54,
                -12.06},{80.87,-12.06},{80.87,-11.6},{83.2,-11.6}}, color={0,0,
                127}));
        connect(add.y, Load2.u) annotation (Line(points={{92.4,-14},{97.15,-14},
                {97.15,-14.5},{101.9,-14.5}}, color={0,0,127}));
        connect(PV.Qref, AddU3.y) annotation (Line(points={{-42,-56},{-54,-56},{-54,-50},
                {-59,-50}}, color={0,0,127}));
          annotation(Diagram(coordinateSystem(preserveAspectRatio=false,
                extent={{-140,-140},{140,140}}), graphics={
              Rectangle(
                extent={{-160,30},{-134,-90}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,36},{124,-124}},
                lineColor={238,46,47},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,98},{124,38}},
                lineColor={0,128,255},
                lineThickness=0.5),
              Text(
                extent={{78,-106},{114,-120}},
                textColor={238,46,47},
                textString="Microgrid"),
              Text(
                extent={{76,58},{128,34}},
                textColor={28,108,200},
                textString="Utility Grid"),
              Text(
                extent={{-30,-102},{34,-124}},
                textColor={0,140,72},
                textString="Linearization Unit"),
              Text(
                extent={{-164,50},{-132,30}},
                textColor={0,140,72},
                textString="Inputs")}),
          Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),experiment(
            StopTime=10,
            __Dymola_NumberOfIntervals=10000,
            __Dymola_Algorithm="Dassl"),
          Icon(coordinateSystem(extent={{-140,-140},{140,140}})));
      end MPCAppliedEnergyLinearized_v2;
    end Testing_Kalman_Filter_State_Estimation;
  end Luigi_Vanfretti_Special_Package;
  extends Modelica.Icons.ExamplesPackage;

  package GenerationUnits "Package containing generators for MPC studies"
    model REGCA1_OBSERVABILITY
      "Renewable energy generator/converter model A"
      extends Electrical.Renewables.PSSE.InverterInterface.BaseClasses.BaseREGC;
      Modelica.Blocks.Sources.RealExpression Vt(y=VT)
        annotation (Placement(transformation(extent={{-130,40},{-110,60}})));
      Modelica.Blocks.Math.Add add(k2=-1)
        annotation (Placement(transformation(extent={{-90,20},{-70,40}})));
      Modelica.Blocks.Sources.Constant Vo_limit(k=Volim)
        annotation (Placement(transformation(extent={{-130,14},{-110,34}})));
      Modelica.Blocks.Nonlinear.Limiter min_limiter(uMax=Modelica.Constants.inf,
          uMin=0) annotation (Placement(transformation(extent={{-30,20},{-10,40}})));
      Modelica.Blocks.Math.Add add1(k2=-1)
        annotation (Placement(transformation(extent={{78,78},{98,98}})));
      Modelica.Blocks.Nonlinear.Limiter IOLIM(uMax=Modelica.Constants.inf,
                                                        uMin=Iolim)
        annotation (Placement(transformation(extent={{112,78},{132,98}})));
      OpenIPSL.Electrical.Renewables.PSSE.InverterInterface.BaseClasses.LVACM LVACM(lvpnt0=
            lvpnt0, lvpnt1=lvpnt1)
        annotation (Placement(transformation(extent={{62,-80},{82,-60}})));
      OpenIPSL.Electrical.Renewables.PSSE.InverterInterface.BaseClasses.LVPL LVPL(
        Brkpt=Brkpt,
        Lvpl1=Lvpl1,
        Zerox=Zerox)
        annotation (Placement(transformation(extent={{10,-80},{-10,-60}})));
      Modelica.Blocks.Math.Product IP
        annotation (Placement(transformation(extent={{100,-40},{120,-20}})));
    public
      Modelica.Blocks.Math.Gain KHV(k=Khv)
        annotation (Placement(transformation(extent={{-60,20},{-40,40}})));
      Modelica.Blocks.Logical.Switch switch1 annotation (Placement(
            transformation(
            extent={{10,-10},{-10,10}},
            origin={-80,-90})));
      Modelica.Blocks.Sources.BooleanConstant Lvplsw_logic(k=Lvplsw)
        annotation (Placement(transformation(extent={{-30,-100},{-50,-80}})));
      Modelica.Blocks.Sources.RealExpression Terminal_Voltage1(y=VT)   annotation (
          Placement(transformation(
            extent={{-10,-10},{10,10}},
            origin={34,-100})));
      Modelica.Blocks.Sources.RealExpression LowerLimit(y=-Modelica.Constants.inf)
        annotation (Placement(transformation(extent={{-80,-70},{-60,-50}})));
      Modelica.Blocks.Math.Gain gain(k=-1)
        annotation (Placement(transformation(extent={{-120,70},{-100,90}})));
      Modelica.Blocks.Sources.RealExpression Constant(y=Modelica.Constants.inf)
        annotation (Placement(transformation(extent={{-30,-124},{-50,-104}})));
      Modelica.Blocks.Nonlinear.VariableLimiter variableLimiter
        annotation (Placement(transformation(extent={{-20,-40},{0,-20}})));
      Modelica.Blocks.Continuous.FirstOrder Delay_Iq(
        T=Tg,
        initType=Modelica.Blocks.Types.Init.InitialOutput,
        y_start=Iq0)
        annotation (Placement(transformation(extent={{-88,70},{-68,90}})));
      Modelica.Blocks.Continuous.FirstOrder Vt_sensor(
        T=Tfltr,
        initType=Modelica.Blocks.Types.Init.InitialOutput,
        y_start=v_0)
        annotation (Placement(transformation(extent={{44,-80},{24,-60}})));
      Modelica.Blocks.Continuous.FirstOrder Delay_Ip(
        T=Tg,
        initType=Modelica.Blocks.Types.Init.InitialOutput,
        y_start=Ip0)
        annotation (Placement(transformation(extent={{-80,-40},{-60,-20}})));
    equation
      [IP.y; IOLIM.y] = -[cos(delta), sin(delta); -sin(delta), cos(delta)]*[p.ir/CoB; p.ii/CoB];
      V_t = VT;
      Pgen = -(1/CoB)*(p.vr*p.ir + p.vi*p.ii);
      Qgen = -(1/CoB)*(p.vi*p.ir - p.vr*p.ii);
      IQ0 = Iq0;
      IP0 = Ip0;
      V_0 = v_0;
      p_0 = p0;
      q_0 = q0;

      connect(add.y,KHV. u)
        annotation (Line(points={{-69,30},{-62,30}},
                                                  color={0,0,127}));
      connect(LVACM.y,IP. u2) annotation (Line(points={{83,-70},{90,-70},{90,-36},{98,
              -36}},             color={0,0,127}));
      connect(switch1.u1,LVPL. y)
        annotation (Line(points={{-68,-82},{-56,-82},{-56,-70},{-11,-70}},
                                                               color={0,0,127}));
      connect(Lvplsw_logic.y,switch1. u2) annotation (Line(points={{-51,-90},{-68,-90}},
                                    color={255,0,255}));
      connect(KHV.y,min_limiter. u)
        annotation (Line(points={{-39,30},{-32,30}},
                                                   color={0,0,127}));
      connect(Vt.y,add. u1) annotation (Line(points={{-109,50},{-94,50},{-94,36},{-92,
              36}}, color={0,0,127}));
      connect(Vo_limit.y,add. u2)
        annotation (Line(points={{-109,24},{-92,24}},color={0,0,127}));
      connect(Terminal_Voltage1.y,LVACM. Vt) annotation (Line(points={{45,-100},{54,-100},{54,-70},{60,-70}},
                                         color={0,0,127}));
      connect(gain.u, Iqcmd) annotation (Line(points={{-122,80},{-134,80},{-134,80},
              {-160,80}}, color={0,0,127}));
      connect(Constant.y, switch1.u3) annotation (Line(points={{-51,-114},{-62,-114},
              {-62,-98},{-68,-98}}, color={0,0,127}));
      connect(LowerLimit.y, variableLimiter.limit2) annotation (Line(points={{-59,
              -60},{-28,-60},{-28,-38},{-22,-38}}, color={0,0,127}));
      connect(variableLimiter.limit1, switch1.y) annotation (Line(points={{-22,-22},
              {-26,-22},{-26,-4},{-124,-4},{-124,-90},{-91,-90}}, color={0,0,127}));
      connect(add1.y, IOLIM.u)
        annotation (Line(points={{99,88},{110,88}}, color={0,0,127}));
      connect(min_limiter.y, add1.u2) annotation (Line(points={{-9,30},{68,30},{
              68,82},{76,82}}, color={0,0,127}));
      connect(variableLimiter.y, IP.u1) annotation (Line(points={{1,-30},{88,-30},{88,
              -24},{98,-24}}, color={0,0,127}));
      connect(gain.y, Delay_Iq.u)
        annotation (Line(points={{-99,80},{-90,80}}, color={0,0,127}));
      connect(Delay_Iq.y, add1.u1) annotation (Line(points={{-67,80},{40,80},{40,94},
              {76,94}}, color={0,0,127}));
      connect(LVPL.V, Vt_sensor.y)
        annotation (Line(points={{12,-70},{23,-70}}, color={0,0,127}));
      connect(Vt_sensor.u, LVACM.Vt)
        annotation (Line(points={{46,-70},{60,-70}}, color={0,0,127}));
      connect(Delay_Ip.y, variableLimiter.u)
        annotation (Line(points={{-59,-30},{-22,-30}}, color={0,0,127}));
      connect(Delay_Ip.u, Ipcmd) annotation (Line(points={{-82,-30},{-106,-30},{-106,
              -80},{-160,-80}}, color={0,0,127}));
      annotation (Icon(graphics={Text(
              extent={{-82,70},{98,-70}},
              textColor={0,0,255},
              textString="REGCA")}), Documentation(info="<html>
<p>The REGCA1 component is used to represent the renewable source (inverter) interface with the grid. It takes in as input the real current command
(Ipcmd) and the reactive current command (Iqcmd) from the electrical controller, and outputs real (Ip) and reactive (Iq) injected currents to the grid through
OpenIPSL's proprietary pwpin connector.</p>
<p>In order to properly initialize all the components that form the renewable energy source, the REGC_A component has five initialization outputs, which its constant output originates from the
starting power flow: initial real and reactive injection currents (IP0 and IQ0), initial terminal voltage (v_0), and initial active and reactive power
injections (p_0 and q_0). This method reduces repetitiveness of initialization calculation, being calculated once at the REGCA1 component.</p>
<p>The connection with other components requires a closed loop through terminal voltage variable (V_t), and active and reactive power generation (Pgen and Qgen).</p>
<p>The modelling of such devices is based, mainly, on the following reference:</p>
<ul>
<li><p>Siemens: \"PSS&reg;E Model Library\"
<a href=\"modelica://OpenIPSL.UsersGuide.References\">[PSSE-MODELS]</a>.</p>
</li>
</ul>
</html>"));
    end REGCA1_OBSERVABILITY;

    model GASTMPC_THERMAL "GAST - Gas Turbine-Governor"
      extends Icons.VerifiedModel;
      extends Electrical.Controls.PSSE.TG.BaseClasses.BaseGovernor;
      parameter Types.PerUnit R=0.05 "Speed droop gain";
      parameter Types.Time T_1=0.4 "Valve response time constant";
      parameter Types.Time T_2=0.1 "Turbine response time constant";
      parameter Types.Time T_3=3.0 "Load limit response time constant";
      parameter Types.PerUnit AT=0.9 "Ambient temperature load limit";
      parameter Types.PerUnit K_T=2.0 "Load-limited feedback path adjustment gain";
      parameter Types.PerUnit V_MAX=0.1 "Operational control high limit on fuel valve opening";
      parameter Types.PerUnit V_MIN=0.025 "Low output control limit on fuel valve opening";
      parameter Types.PerUnit D_turb=0.0 "Turbine damping";
      Modelica.Blocks.Math.Add add(k1=-1)
        annotation (Placement(transformation(extent={{-80,16},{-60,-4}})));
      Modelica.Blocks.Math.Add add1(k2=-1) annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={40,-50})));
      Modelica.Blocks.Math.Add add2(k2=+1) annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={-20,-56})));
      Modelica.Blocks.Math.Add add3(k1=-1)
        annotation (Placement(transformation(extent={{120,-10},{140,10}})));
      Modelica.Blocks.Math.Gain gDturb(k=D_turb)
        annotation (Placement(transformation(extent={{-40,29},{-20,50}})));
      Modelica.Blocks.Math.Gain gKt(k=K_T) annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={10,-50})));
      Modelica.Blocks.Math.Gain g1_R(k=1/R) annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            origin={-110,0})));
      NonElectrical.Logical.LV_GATE lV_Gate
        annotation (Placement(transformation(extent={{-40,-10},{-20,10}})));
      Modelica.Blocks.Sources.Constant const(k=AT)
        annotation (Placement(transformation(extent={{90,-80},{70,-60}})));
      NonElectrical.Continuous.SimpleLag    simpleLagLim(
        K=1,
        T=T_1,
        y_start=pm0) annotation (Placement(transformation(extent={{0,-10},{20,10}})));
      Modelica.Blocks.Interfaces.RealInput PMECHControllable annotation (Placement(
            transformation(extent={{-260,110},{-220,150}}), iconTransformation(
            extent={{-20,-20},{20,20}},
            rotation=90,
            origin={0,-120})));
      Modelica.Blocks.Math.Add add4(k1=+1)
        annotation (Placement(transformation(extent={{-180,120},{-160,100}})));
      Modelica.Blocks.Interfaces.RealOutput TF2_out
        "Connector of Real output signal" annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=270,
            origin={68,-210}), iconTransformation(
            extent={{-10,-10},{10,10}},
            rotation=90,
            origin={90,110})));
      Modelica.Blocks.Nonlinear.Limiter limiter(uMax=V_MAX, uMin=V_MIN)
        annotation (Placement(transformation(extent={{32,-10},{52,10}})));
      NonElectrical.Continuous.SimpleLag simpleLag(
        K=1,
        T=T_2,
        y_start=pm0)
        annotation (Placement(transformation(extent={{70,-10},{90,10}})));
      NonElectrical.Continuous.SimpleLag simpleLag1(
        K=1,
        T=T_3,
        y_start=pm0)
        annotation (Placement(transformation(extent={{100,-42},{80,-22}})));
    protected
      parameter Types.PerUnit pm0(fixed=false);
    initial algorithm
      pm0 := PMECH0;
    equation
      connect(gDturb.y, add3.u1) annotation (Line(
          points={{-19,39.5},{100,39.5},{100,6},{118,6}},
          color={0,0,127},
          smooth=Smooth.None));
      connect(g1_R.y, add.u1) annotation (Line(
          points={{-99,0},{-82,0}},
          color={0,0,127},
          smooth=Smooth.None));
      connect(add1.y, gKt.u) annotation (Line(
          points={{29,-50},{22,-50}},
          color={0,0,127},
          smooth=Smooth.None));
      connect(gKt.y, add2.u2) annotation (Line(
          points={{-1,-50},{-8,-50}},
          color={0,0,127},
          smooth=Smooth.None));
      connect(add.y,lV_Gate.u1) annotation (Line(
          points={{-59,6},{-42,6}},
          color={0,0,127},
          smooth=Smooth.None));
      connect(lV_Gate.u2, add2.y) annotation (Line(
          points={{-42,-6},{-48,-6},{-48,-56},{-31,-56}},
          color={0,0,127},
          smooth=Smooth.None));
      connect(const.y, add2.u1) annotation (Line(points={{69,-70},{0,-70},{0,-62},{-8,-62}},
                          color={0,0,127}));
      connect(simpleLagLim.u,lV_Gate.y) annotation (Line(points={{-2,0},{-19,0}},
                                     color={0,0,127}));
      connect(add3.y, PMECH)
        annotation (Line(points={{141,0},{250,0}}, color={0,0,127}));
      connect(SPEED, g1_R.u) annotation (Line(points={{-240,-120},{-152,-120},{-152,0},{-122,0}},
                                color={0,0,127}));
      connect(gDturb.u, g1_R.u) annotation (Line(points={{-42,39.5},{-152,39.5},{-152,0},{-122,0}},
                           color={0,0,127}));
      connect(add1.u1, const.y) annotation (Line(points={{52,-56},{60,-56},{60,-70},{69,-70}}, color={0,0,127}));
      connect(add4.u2, PMECHControllable) annotation (Line(points={{-182,116},{-214,
              116},{-214,130},{-240,130}}, color={0,0,127}));
      connect(PMECH0, add4.u1) annotation (Line(points={{-240,80},{-190,80},{-190,
              104},{-182,104}}, color={0,0,127}));
      connect(add4.y, add.u2) annotation (Line(points={{-159,110},{-88,110},{-88,12},
              {-82,12}}, color={0,0,127}));
      connect(simpleLagLim.y, limiter.u)
        annotation (Line(points={{21,0},{30,0}}, color={0,0,127}));
      connect(simpleLag.y, add3.u2) annotation (Line(points={{91,0},{108,0},{108,-6},
              {118,-6}}, color={0,0,127}));
      connect(limiter.y, simpleLag.u)
        annotation (Line(points={{53,0},{68,0}}, color={0,0,127}));
      connect(simpleLag1.u, add3.u2) annotation (Line(points={{102,-32},{108,-32},{
              108,-6},{118,-6}}, color={0,0,127}));
      connect(simpleLag1.y, add1.u2) annotation (Line(points={{79,-32},{60,-32},{60,
              -44},{52,-44}}, color={0,0,127}));
      connect(TF2_out, add1.u2) annotation (Line(points={{68,-210},{68,-124},{134,
              -124},{134,-42},{68,-42},{68,-32},{60,-32},{60,-44},{52,-44}}, color=
              {0,0,127}));
      annotation (
        Diagram(coordinateSystem(
            extent={{-240,-200},{240,180}},
            preserveAspectRatio=false,
            grid={2,2})),
        Icon(coordinateSystem(
            extent={{-100,-100},{100,100}},
            preserveAspectRatio=false,
            grid={2,2}),
            graphics={Text(
              extent={{-100,160},{100,100}},
              lineColor={28,108,200},
              textString="GAST")}),
        Documentation(info="<html>Gas Turbine-Governor Model.</html>",
      revisions="<html>
<table cellspacing=\"1\" cellpadding=\"1\" border=\"1\">
<tr>
<td><p>Reference</p></td>
<td><p>PSS&reg;E Manual</p></td>
</tr>
<tr>
<td><p>Last update</p></td>
<td><p>2020-09</p></td>
</tr>
<tr>
<td><p>Author</p></td>
<td><p>ALSETLab, Rensselaer Polytechnic Institute</p></td>
</tr>
<tr>
<td><p>Contact</p></td>
<td><p>see <a href=\"modelica://OpenIPSL.UsersGuide.Contact\">UsersGuide.Contact</a></p></td>
</tr>
</table>
</html>"));
    end GASTMPC_THERMAL;

    model GASTMPCforthreeentradas "GAST - Gas Turbine-Governor"
      extends Icons.VerifiedModel;
      extends Electrical.Controls.PSSE.TG.BaseClasses.BaseGovernor;
      parameter Types.PerUnit R=0.05 "Speed droop gain";
      parameter Types.Time T_1=0.4 "Valve response time constant";
      parameter Types.Time T_2=0.1 "Turbine response time constant";
      parameter Types.Time T_3=3.0 "Load limit response time constant";
      parameter Types.PerUnit AT=0.9 "Ambient temperature load limit";
      parameter Types.PerUnit K_T=2.0 "Load-limited feedback path adjustment gain";
      parameter Types.PerUnit V_MAX=1.0 "Operational control high limit on fuel valve opening";
      parameter Types.PerUnit V_MIN=-0.05 "Low output control limit on fuel valve opening";
      parameter Types.PerUnit D_turb=0.0 "Turbine damping";
      Modelica.Blocks.Math.Add add(k1=-1)
        annotation (Placement(transformation(extent={{-80,16},{-60,-4}})));
      Modelica.Blocks.Math.Add add1(k2=-1) annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={40,-50})));
      Modelica.Blocks.Math.Add add2(k2=+1) annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={-20,-56})));
      Modelica.Blocks.Math.Add add3(k1=-1)
        annotation (Placement(transformation(extent={{120,-10},{140,10}})));
      Modelica.Blocks.Math.Gain gDturb(k=D_turb)
        annotation (Placement(transformation(extent={{-40,29},{-20,50}})));
      Modelica.Blocks.Math.Gain gKt(k=K_T) annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={10,-50})));
      Modelica.Blocks.Math.Gain g1_R(k=1/R) annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            origin={-110,0})));
      NonElectrical.Logical.LV_GATE lV_Gate
        annotation (Placement(transformation(extent={{-40,-10},{-20,10}})));
      Modelica.Blocks.Continuous.TransferFunction transferFunction1(a={T_2,1},
        initType=Modelica.Blocks.Types.Init.InitialOutput,
        y_start=pm0)
        annotation (Placement(transformation(extent={{64,-10},{84,10}})));
      Modelica.Blocks.Continuous.TransferFunction transferFunction2(a={T_3,1},
        initType=Modelica.Blocks.Types.Init.InitialOutput,
        y_start=pm0)
        annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={80,-30})));
      Modelica.Blocks.Sources.Constant const(k=AT)
        annotation (Placement(transformation(extent={{90,-80},{70,-60}})));
      NonElectrical.Continuous.SimpleLag    simpleLagLim(
        K=1,
        T=T_1,
        y_start=pm0) annotation (Placement(transformation(extent={{0,-10},{20,10}})));
      Modelica.Blocks.Interfaces.RealInput PMECHControllable1 annotation (Placement(
            transformation(extent={{-260,110},{-220,150}}), iconTransformation(
            extent={{-20,-20},{20,20}},
            rotation=90,
            origin={-60,-120})));
      Modelica.Blocks.Math.Add3 add3_1(
                                    k1=+1)
        annotation (Placement(transformation(extent={{-180,120},{-160,100}})));
      Modelica.Blocks.Interfaces.RealOutput TF2_out
        "Connector of Real output signal" annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=270,
            origin={68,-210}), iconTransformation(
            extent={{-10,-10},{10,10}},
            rotation=90,
            origin={90,110})));
      Modelica.Blocks.Nonlinear.Limiter limiter(uMax=V_MAX, uMin=V_MIN)
        annotation (Placement(transformation(extent={{32,-10},{52,10}})));
      Modelica.Blocks.Interfaces.RealInput PMECHControllable2
        "Connector of Real input signal 3" annotation (Placement(transformation(
            extent={{-20,-20},{20,20}},
            rotation=0,
            origin={-240,160}), iconTransformation(
            extent={{-20,-20},{20,20}},
            rotation=90,
            origin={60,-120})));
    protected
      parameter Types.PerUnit pm0(fixed=false);
    initial algorithm
      pm0 := PMECH0;
    equation
      connect(gDturb.y, add3.u1) annotation (Line(
          points={{-19,39.5},{100,39.5},{100,6},{118,6}},
          color={0,0,127},
          smooth=Smooth.None));
      connect(g1_R.y, add.u1) annotation (Line(
          points={{-99,0},{-82,0}},
          color={0,0,127},
          smooth=Smooth.None));
      connect(add1.y, gKt.u) annotation (Line(
          points={{29,-50},{22,-50}},
          color={0,0,127},
          smooth=Smooth.None));
      connect(gKt.y, add2.u2) annotation (Line(
          points={{-1,-50},{-8,-50}},
          color={0,0,127},
          smooth=Smooth.None));
      connect(transferFunction2.y, add1.u2) annotation (Line(
          points={{69,-30},{60,-30},{60,-44},{52,-44}},
          color={0,0,127},
          smooth=Smooth.None));
      connect(transferFunction1.y, add3.u2) annotation (Line(
          points={{85,0},{100,0},{100,-6},{118,-6}},
          color={0,0,127},
          smooth=Smooth.None));
      connect(transferFunction1.y, transferFunction2.u) annotation (Line(
          points={{85,0},{100,0},{100,-30},{92,-30}},
          color={0,0,127},
          smooth=Smooth.None));
      connect(add.y,lV_Gate.u1) annotation (Line(
          points={{-59,6},{-42,6}},
          color={0,0,127},
          smooth=Smooth.None));
      connect(lV_Gate.u2, add2.y) annotation (Line(
          points={{-42,-6},{-48,-6},{-48,-56},{-31,-56}},
          color={0,0,127},
          smooth=Smooth.None));
      connect(const.y, add2.u1) annotation (Line(points={{69,-70},{0,-70},{0,-62},{-8,-62}},
                          color={0,0,127}));
      connect(simpleLagLim.u,lV_Gate.y) annotation (Line(points={{-2,0},{-19,0}},
                                     color={0,0,127}));
      connect(add3.y, PMECH)
        annotation (Line(points={{141,0},{250,0}}, color={0,0,127}));
      connect(SPEED, g1_R.u) annotation (Line(points={{-240,-120},{-152,-120},{-152,0},{-122,0}},
                                color={0,0,127}));
      connect(gDturb.u, g1_R.u) annotation (Line(points={{-42,39.5},{-152,39.5},{-152,0},{-122,0}},
                           color={0,0,127}));
      connect(add1.u1, const.y) annotation (Line(points={{52,-56},{60,-56},{60,-70},{69,-70}}, color={0,0,127}));
      connect(add3_1.u2, PMECHControllable1) annotation (Line(points={{-182,110},{
              -214,110},{-214,130},{-240,130}}, color={0,0,127}));
      connect(PMECH0, add3_1.u1) annotation (Line(points={{-240,80},{-190,80},{-190,
              102},{-182,102}}, color={0,0,127}));
      connect(add3_1.y, add.u2) annotation (Line(points={{-159,110},{-88,110},{-88,
              12},{-82,12}}, color={0,0,127}));
      connect(transferFunction2.y, TF2_out) annotation (Line(points={{69,-30},{60,
              -30},{60,-54},{96,-54},{96,-194},{68,-194},{68,-210}}, color={0,0,127}));
      connect(simpleLagLim.y, limiter.u)
        annotation (Line(points={{21,0},{30,0}}, color={0,0,127}));
      connect(limiter.y, transferFunction1.u)
        annotation (Line(points={{53,0},{62,0}}, color={0,0,127}));
      connect(add3_1.u3, PMECHControllable2) annotation (Line(points={{-182,118},{
              -210,118},{-210,160},{-240,160}}, color={0,0,127}));
      annotation (
        Diagram(coordinateSystem(
            extent={{-240,-200},{240,180}},
            preserveAspectRatio=false,
            grid={2,2})),
        Icon(coordinateSystem(
            extent={{-100,-100},{100,100}},
            preserveAspectRatio=false,
            grid={2,2}),
            graphics={Text(
              extent={{-100,160},{100,100}},
              lineColor={28,108,200},
              textString="GAST")}),
        Documentation(info="<html>Gas Turbine-Governor Model.</html>",
      revisions="<html>
<table cellspacing=\"1\" cellpadding=\"1\" border=\"1\">
<tr>
<td><p>Reference</p></td>
<td><p>PSS&reg;E Manual</p></td>
</tr>
<tr>
<td><p>Last update</p></td>
<td><p>2020-09</p></td>
</tr>
<tr>
<td><p>Author</p></td>
<td><p>ALSETLab, Rensselaer Polytechnic Institute</p></td>
</tr>
<tr>
<td><p>Contact</p></td>
<td><p>see <a href=\"modelica://OpenIPSL.UsersGuide.Contact\">UsersGuide.Contact</a></p></td>
</tr>
</table>
</html>"));
    end GASTMPCforthreeentradas;

    partial model BaseExciterMPC "Base exciter model for PSSE excitation systems"
      Modelica.Blocks.Interfaces.RealInput VUEL annotation (Placement(
            transformation(
            extent={{-20,-20},{20,20}},
            rotation=90,
            origin={-130,-200}), iconTransformation(
            extent={{-10,-10},{10,10}},
            rotation=90,
            origin={-40,-110})));
      Modelica.Blocks.Interfaces.RealInput VOEL annotation (Placement(
            transformation(
            extent={{-20,-20},{20,20}},
            rotation=90,
            origin={-70,-200}), iconTransformation(
            extent={{-10,-10},{10,10}},
            rotation=90,
            origin={0,-110})));
      Modelica.Blocks.Interfaces.RealOutput EFD "Excitation Voltage [pu]"
        annotation (Placement(transformation(extent={{200,-10},{220,10}}), iconTransformation(extent={{100,-10},{120,10}})));
      Modelica.Blocks.Interfaces.RealInput EFD0 annotation (Placement(
            transformation(
            extent={{-20,-20},{20,20}},
            origin={-200,-130}), iconTransformation(extent={{-10,-10},{10,10}},
              origin={-110,-40})));
      Modelica.Blocks.Interfaces.RealInput VOTHSG annotation (Placement(
            transformation(
            extent={{-20,-20},{20,20}},
            origin={-200,90}), iconTransformation(extent={{-10,-10},{10,10}},
              origin={-110,40})));
      Modelica.Blocks.Interfaces.RealInput ECOMP annotation (Placement(
            transformation(
            extent={{-20,-20},{20,20}},
            origin={-200,0}), iconTransformation(extent={{-10,-10},{10,10}}, origin={-110,0})));
      Modelica.Blocks.Sources.Constant VoltageReference(k=V_REF)
        annotation (Placement(transformation(extent={{-170,40},{-150,60}})));
      Modelica.Blocks.Math.Add DiffV(k2=-1)
        annotation (Placement(transformation(extent={{-120,-10},{-100,10}})));
    protected
      parameter Real Efd0(fixed=false);
      parameter Real V_REF(fixed=false);
      parameter Real ECOMP0(fixed=false);
    public
      Modelica.Blocks.Interfaces.RealInput XADIFD annotation (Placement(
            transformation(
            extent={{-20,-20},{20,20}},
            rotation=90,
            origin={80,-200}), iconTransformation(
            extent={{-10,-10},{10,10}},
            rotation=90,
            origin={80,-110})));
      Modelica.Blocks.Math.Add sum
        annotation (Placement(transformation(extent={{-120,40},{-100,60}})));
      Modelica.Blocks.Interfaces.RealInput EFd_input
        "Connector of Real input signal 1" annotation (Placement(transformation(
            extent={{-20,-20},{20,20}},
            rotation=270,
            origin={0,180}), iconTransformation(
            extent={{0,0},{20,20}},
            rotation=0,
            origin={-120,70})));
      Modelica.Blocks.Math.Gain gain annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=270,
            origin={-130,110})));
    initial equation
      Efd0 = EFD0;
      ECOMP0 = ECOMP;
    equation
      connect(sum.y, DiffV.u1) annotation (Line(points={{-99,50},{-90,50},{-90,26},
              {-130,26},{-130,6},{-122,6}}, color={0,0,127}));
      connect(VoltageReference.y, sum.u2) annotation (Line(points={{-149,50},{-132,
              50},{-132,44},{-122,44}}, color={0,0,127}));
      connect(gain.y, sum.u1)
        annotation (Line(points={{-130,99},{-130,56},{-122,56}}, color={0,0,127}));
      connect(gain.u, EFd_input) annotation (Line(points={{-130,122},{-130,154},{0,
              154},{0,180}}, color={0,0,127}));
      annotation (
        Icon(
            graphics={Rectangle(
              extent={{-100,100},{100,-100}},
              lineColor={28,108,200},
              fillColor={255,255,255}), Text(
              extent={{-56,-80},{-24,-100}},
              lineColor={28,108,200},
              textString="VUEL"),Text(
              extent={{-14,-80},{14,-100}},
              lineColor={28,108,200},
              textString="VOEL"),Text(
              extent={{-90,10},{-20,-10}},
              lineColor={28,108,200},
              textString="ECOMP"),Text(
              extent={{-90,50},{-20,28}},
              lineColor={28,108,200},
              textString="VOTHSG"),Text(
              extent={{-90,-30},{-40,-52}},
              lineColor={28,108,200},
              textString="EFD0"),Text(
              extent={{50,10},{90,-10}},
              lineColor={28,108,200},
              textString="EFD"), Text(
              extent={{60,-80},{100,-100}},
              lineColor={28,108,200},
              textString="XADIFD")}),
        Diagram(coordinateSystem(extent={{-200,-200},{200,160}})));
    end BaseExciterMPC;

    model GASTMPC "GAST - Gas Turbine-Governor"
      extends Icons.VerifiedModel;
      extends Electrical.Controls.PSSE.TG.BaseClasses.BaseGovernor;
      parameter Types.PerUnit R=0.05 "Speed droop gain";
      parameter Types.Time T_1=0.4 "Valve response time constant";
      parameter Types.Time T_2=0.1 "Turbine response time constant";
      parameter Types.Time T_3=3.0 "Load limit response time constant";
      parameter Types.PerUnit AT=0.9 "Ambient temperature load limit";
      parameter Types.PerUnit K_T=2.0 "Load-limited feedback path adjustment gain";
      parameter Types.PerUnit V_MAX=0.1 "Operational control high limit on fuel valve opening";
      parameter Types.PerUnit V_MIN=0.025 "Low output control limit on fuel valve opening";
      parameter Types.PerUnit D_turb=0.0 "Turbine damping";
      Modelica.Blocks.Math.Add add(k1=-1)
        annotation (Placement(transformation(extent={{-80,16},{-60,-4}})));
      Modelica.Blocks.Math.Add add1(k2=-1) annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={40,-50})));
      Modelica.Blocks.Math.Add add2(k2=+1) annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={-20,-56})));
      Modelica.Blocks.Math.Add add3(k1=-1)
        annotation (Placement(transformation(extent={{120,-10},{140,10}})));
      Modelica.Blocks.Math.Gain gDturb(k=D_turb)
        annotation (Placement(transformation(extent={{-40,29},{-20,50}})));
      Modelica.Blocks.Math.Gain gKt(k=K_T) annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={10,-50})));
      Modelica.Blocks.Math.Gain g1_R(k=1/R) annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            origin={-110,0})));
      NonElectrical.Logical.LV_GATE lV_Gate
        annotation (Placement(transformation(extent={{-40,-10},{-20,10}})));
      Modelica.Blocks.Sources.Constant const(k=AT)
        annotation (Placement(transformation(extent={{90,-80},{70,-60}})));
      NonElectrical.Continuous.SimpleLag    simpleLagLim(
        K=1,
        T=T_1,
        y_start=pm0) annotation (Placement(transformation(extent={{0,-10},{20,10}})));
      Modelica.Blocks.Interfaces.RealInput PMECHControllable annotation (Placement(
            transformation(extent={{-260,110},{-220,150}}), iconTransformation(
            extent={{-20,-20},{20,20}},
            rotation=90,
            origin={0,-120})));
      Modelica.Blocks.Math.Add add4(k1=+1)
        annotation (Placement(transformation(extent={{-180,120},{-160,100}})));
      Modelica.Blocks.Interfaces.RealOutput TF2_out
        "Connector of Real output signal" annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=270,
            origin={68,-210}), iconTransformation(
            extent={{-10,-10},{10,10}},
            rotation=90,
            origin={90,110})));
      Modelica.Blocks.Nonlinear.Limiter limiter(uMax=V_MAX, uMin=V_MIN)
        annotation (Placement(transformation(extent={{32,-10},{52,10}})));
      NonElectrical.Continuous.SimpleLag simpleLag(
        K=1,
        T=T_2,
        y_start=pm0)
        annotation (Placement(transformation(extent={{70,-10},{90,10}})));
      NonElectrical.Continuous.SimpleLag simpleLag1(
        K=1,
        T=T_3,
        y_start=pm0)
        annotation (Placement(transformation(extent={{100,-42},{80,-22}})));
    protected
      parameter Types.PerUnit pm0(fixed=false);
    initial algorithm
      pm0 := PMECH0;
    equation
      connect(gDturb.y, add3.u1) annotation (Line(
          points={{-19,39.5},{100,39.5},{100,6},{118,6}},
          color={0,0,127},
          smooth=Smooth.None));
      connect(g1_R.y, add.u1) annotation (Line(
          points={{-99,0},{-82,0}},
          color={0,0,127},
          smooth=Smooth.None));
      connect(add1.y, gKt.u) annotation (Line(
          points={{29,-50},{22,-50}},
          color={0,0,127},
          smooth=Smooth.None));
      connect(gKt.y, add2.u2) annotation (Line(
          points={{-1,-50},{-8,-50}},
          color={0,0,127},
          smooth=Smooth.None));
      connect(add.y,lV_Gate.u1) annotation (Line(
          points={{-59,6},{-42,6}},
          color={0,0,127},
          smooth=Smooth.None));
      connect(lV_Gate.u2, add2.y) annotation (Line(
          points={{-42,-6},{-48,-6},{-48,-56},{-31,-56}},
          color={0,0,127},
          smooth=Smooth.None));
      connect(const.y, add2.u1) annotation (Line(points={{69,-70},{0,-70},{0,-62},{-8,-62}},
                          color={0,0,127}));
      connect(simpleLagLim.u,lV_Gate.y) annotation (Line(points={{-2,0},{-19,0}},
                                     color={0,0,127}));
      connect(add3.y, PMECH)
        annotation (Line(points={{141,0},{250,0}}, color={0,0,127}));
      connect(SPEED, g1_R.u) annotation (Line(points={{-240,-120},{-152,-120},{-152,0},{-122,0}},
                                color={0,0,127}));
      connect(gDturb.u, g1_R.u) annotation (Line(points={{-42,39.5},{-152,39.5},{-152,0},{-122,0}},
                           color={0,0,127}));
      connect(add1.u1, const.y) annotation (Line(points={{52,-56},{60,-56},{60,-70},{69,-70}}, color={0,0,127}));
      connect(add4.u2, PMECHControllable) annotation (Line(points={{-182,116},{-214,
              116},{-214,130},{-240,130}}, color={0,0,127}));
      connect(PMECH0, add4.u1) annotation (Line(points={{-240,80},{-190,80},{-190,
              104},{-182,104}}, color={0,0,127}));
      connect(add4.y, add.u2) annotation (Line(points={{-159,110},{-88,110},{-88,12},
              {-82,12}}, color={0,0,127}));
      connect(simpleLagLim.y, limiter.u)
        annotation (Line(points={{21,0},{30,0}}, color={0,0,127}));
      connect(simpleLag.y, add3.u2) annotation (Line(points={{91,0},{108,0},{108,-6},
              {118,-6}}, color={0,0,127}));
      connect(limiter.y, simpleLag.u)
        annotation (Line(points={{53,0},{68,0}}, color={0,0,127}));
      connect(simpleLag1.u, add3.u2) annotation (Line(points={{102,-32},{108,-32},{
              108,-6},{118,-6}}, color={0,0,127}));
      connect(simpleLag1.y, add1.u2) annotation (Line(points={{79,-32},{60,-32},{60,
              -44},{52,-44}}, color={0,0,127}));
      connect(TF2_out, add1.u2) annotation (Line(points={{68,-210},{68,-124},{134,
              -124},{134,-42},{68,-42},{68,-32},{60,-32},{60,-44},{52,-44}}, color=
              {0,0,127}));
      annotation (
        Diagram(coordinateSystem(
            extent={{-240,-200},{240,180}},
            preserveAspectRatio=false,
            grid={2,2})),
        Icon(coordinateSystem(
            extent={{-100,-100},{100,100}},
            preserveAspectRatio=false,
            grid={2,2}),
            graphics={Text(
              extent={{-100,160},{100,100}},
              lineColor={28,108,200},
              textString="GAST")}),
        Documentation(info="<html>Gas Turbine-Governor Model.</html>",
      revisions="<html>
<table cellspacing=\"1\" cellpadding=\"1\" border=\"1\">
<tr>
<td><p>Reference</p></td>
<td><p>PSS&reg;E Manual</p></td>
</tr>
<tr>
<td><p>Last update</p></td>
<td><p>2020-09</p></td>
</tr>
<tr>
<td><p>Author</p></td>
<td><p>ALSETLab, Rensselaer Polytechnic Institute</p></td>
</tr>
<tr>
<td><p>Contact</p></td>
<td><p>see <a href=\"modelica://OpenIPSL.UsersGuide.Contact\">UsersGuide.Contact</a></p></td>
</tr>
</table>
</html>"));
    end GASTMPC;

    model G2_no_controls3 "Generation unit connected to bus B5"
      outer OpenIPSL.Electrical.SystemBase SysData;
      extends OpenIPSL.Electrical.Essentials.pfComponent;

      OpenIPSL.Interfaces.PwPin conn annotation (Placement(transformation(extent={{
                100,-10},{120,10}}), iconTransformation(extent={{100,-10},{120,10}})));
      OpenIPSL.Electrical.Machines.PSSE.GENROE gen(
        M_b=100000000,
        Tpd0=5,
        Tppd0=0.07,
        Tppq0=0.09,
        H=4.28,
        D=0,
        Xd=1.84,
        Xq=1.75,
        Xpd=0.41,
        Xppd=0.2,
        Xl=0.12,
        S10=0.11,
        S12=0.39,
        Xppq=0.2,
        R_a=0,
        V_b=V_b,
        v_0=v_0,
        angle_0=angle_0,
        P_0=P_0,
        Q_0=Q_0,
        Xpq=0.1,
        Tpq0=2)  annotation (Placement(transformation(extent={{38,-20},{78,20}})));
      SEXS4MPC                                                sEXS(
        T_E=0.01)
                annotation (Placement(transformation(extent={{-10,-22},{10,-2}})));
      Modelica.Blocks.Sources.Constant non_active_limits(k=0)
        annotation (Placement(transformation(extent={{80,-80},{60,-60}})));
      Modelica.Blocks.Interfaces.RealInput Padd
        "Turbine mechanical power (machine base)"
        annotation (Placement(transformation(extent={{-140,-8},{-100,32}})));
      Modelica.Blocks.Interfaces.RealOutput PELEC1
                                 "Machine electrical power (machine base)"
        annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=90,
            origin={90,110})));
    equation
      connect(gen.p, conn)
        annotation (Line(points={{78,0},{110,0}}, color={0,0,255}));
      connect(sEXS.EFD, gen.EFD)
        annotation (Line(points={{11,-12},{34,-12}}, color={0,0,127}));
      connect(non_active_limits.y, sEXS.VOEL)
        annotation (Line(points={{59,-70},{0,-70},{0,-23}}, color={0,0,127}));
      connect(sEXS.VUEL, sEXS.VOEL) annotation (Line(points={{-4,-23},{-4,-70},{0,
              -70},{0,-23}}, color={0,0,127}));
      connect(sEXS.VOTHSG, sEXS.VOEL) annotation (Line(points={{-11,-8},{-22,-8},{
              -22,-70},{0,-70},{0,-23}}, color={0,0,127}));
      connect(sEXS.XADIFD, gen.XADIFD) annotation (Line(points={{8,-23},{8,-28},{86,
              -28},{86,-18},{80,-18}}, color={0,0,127}));
      connect(sEXS.EFD0, gen.EFD0) annotation (Line(points={{-11,-16},{-14,-16},{
              -14,-32},{90,-32},{90,-10},{80,-10}}, color={0,0,127}));
      connect(sEXS.ECOMP, gen.ETERM) annotation (Line(points={{-11,-12},{-18,-12},{
              -18,-36},{94,-36},{94,-6},{80,-6}}, color={0,0,127}));
      connect(gen.PELEC, PELEC1)
        annotation (Line(points={{80,6},{90,6},{90,110}}, color={0,0,127}));
      connect(Padd, gen.PMECH)
        annotation (Line(points={{-120,12},{34,12}}, color={0,0,127}));
      annotation (Icon(coordinateSystem(preserveAspectRatio=false, extent={{-100,-100},
                {100,100}}), graphics={Ellipse(
              extent={{-100,100},{100,-100}},
              lineColor={0,0,0},
              fillColor={255,255,255},
              fillPattern=FillPattern.Solid),Line(
              points={{-48,2},{-20,56},{2,4},{24,-28},{48,22}},
              color={0,0,0},
              smooth=Smooth.Bezier),Text(
              extent={{-52,-18},{56,-66}},
              lineColor={0,0,0},
              fillColor={255,255,255},
              fillPattern=FillPattern.Solid,
              textString="%name")}),
        Documentation(info="<html>
<p>24kV/100MVA generation unit connected to bus BG1, and composed of the following component models:</p>
<ul>
<li><strong>Machine</strong>: GENSAL, a salient pole synchronous machine from PSSE.</li>
<li><strong>Exciter</strong>: SEXS, a simplified excitation system from PSSE.</li>
<li><strong>Turbine/Governor</strong>: IEESGO, a standard turbine/governor from PSSE.</li>
</ul>
<p>This generation unit is supposed to be disconnected in all experiments and, then, to be resynchronized to the whole system.</p>
</html>"));
    end G2_no_controls3;

    model HYGOV4MPC "HYGOV - Hydro Turbine-Governor model"
      extends Icons.VerifiedModel;
      extends Electrical.Controls.PSSE.TG.BaseClasses.BaseGovernor;
      parameter Types.PerUnit R=0.05 "Permanent droop gain";
      parameter Types.PerUnit r=0.3 "Temporary droop gain";
      parameter Types.Time T_r=5 "Governor time constant";
      parameter Types.Time T_f=0.05 "Filter time constant";
      parameter Types.Time T_g=0.5 "Servo time constant";
      parameter Types.TimeAging VELM=0.2 "Gate open/close velocity limit";
      parameter Types.PerUnit G_MAX=0.9 "Maximum gate limit";
      parameter Types.PerUnit G_MIN=0 "Minimum gate limit";
      parameter Types.Time T_w=1.25 "Water time constant";
      parameter Types.PerUnit A_t=1.2 "Turbine gain";
      parameter Types.PerUnit D_turb=0.2 "Turbine damping";
      parameter Types.PerUnit q_NL=0.08 "Water flow at no load";
      parameter Types.PerUnit h0(min=0)=1 "Water head initial value > 0";
      Modelica.Blocks.Sources.Constant n_ref(k=nref) annotation (Placement(transformation(extent={{-178,14},{-166,26}})));
      OpenIPSL.NonElectrical.Continuous.SimpleLag SimpleLag1(
        K=1,
        T=T_f,
        y_start=0)
        annotation (Placement(transformation(extent={{-126,0},{-114,12}})));
      Modelica.Blocks.Math.Gain Gain3(k=R)
        annotation (Placement(transformation(extent={{-130,-22},{-142,-10}})));
      Modelica.Blocks.Math.Gain Gain4(k=D_turb)
        annotation (Placement(transformation(extent={{-62,-34},{-50,-22}})));
      Modelica.Blocks.Sources.Constant hs(k=h0)
        annotation (Placement(transformation(extent={{20,-20},{32,-8}})));
      Modelica.Blocks.Continuous.Integrator q(
        y_start=q0,
        initType=Modelica.Blocks.Types.Init.InitialOutput,
        k=1/T_w) annotation (Placement(transformation(extent={{62,-4},{74,8}})));
      Modelica.Blocks.Sources.Constant qNL(k=q_NL) annotation (Placement(transformation(extent={{92,-18},{84,-10}})));
      Modelica.Blocks.Math.Gain Gain6(k=A_t) annotation (Placement(transformation(extent={{132,-2},{144,10}})));
      OpenIPSL.NonElectrical.Continuous.SimpleLag g(
        K=1,
        T=T_g,
        y_start=g0) "servo_motor" annotation (Placement(transformation(extent={{-40,0},{-28,12}})));
      Modelica.Blocks.Nonlinear.Limiter Velocity_Limiter(uMin=-VELM, uMax=VELM) annotation (Placement(transformation(extent={{-86,0},{-74,12}})));
      Types.PerUnit G "Gate opening";
      Types.PerUnit c "Desired gate opening";
      Types.PerUnit Q "Turbine flow";
      Types.PerUnit H "Turbine head";
      Modelica.Blocks.Math.Add add(k2=-1)
        annotation (Placement(transformation(extent={{-144,0},{-132,12}})));
      Modelica.Blocks.Math.Add add1
        annotation (Placement(transformation(extent={{-168,-12},{-156,0}})));
      Modelica.Blocks.Math.Division division
        annotation (Placement(transformation(extent={{0,-4},{12,8}})));
      Modelica.Blocks.Math.Product product
        annotation (Placement(transformation(extent={{20,-4},{32,8}})));
      Modelica.Blocks.Math.Add add2(k1=-1)
        annotation (Placement(transformation(extent={{42,-4},{54,8}})));
      Modelica.Blocks.Math.Add add3(k2=-1)
        annotation (Placement(transformation(extent={{82,-4},{94,8}})));
      Modelica.Blocks.Math.Add add4(k2=-1)
        annotation (Placement(transformation(extent={{152,-6},{164,6}})));
      Modelica.Blocks.Math.Product product1
        annotation (Placement(transformation(extent={{58,-30},{70,-18}})));
      Modelica.Blocks.Math.Product product2
        annotation (Placement(transformation(extent={{108,-2},{120,10}})));
      NonElectrical.Continuous.SimpleLead simpleLead(
        K=r*T_r,
        T=T_r,
        y_start=0)
        annotation (Placement(transformation(extent={{-106,0},{-94,12}})));
      Modelica.Blocks.Continuous.Integrator integrator(k=1, y_start=c0)
        annotation (Placement(transformation(extent={{-68,0},{-56,12}})));
    protected
      parameter Real q0(fixed=false);
      //=Pm0/(A_t*h0)+q_NL "water flow initial value";
      parameter Real g0(fixed=false);
      //=q0/sqrt(h0) "the gate opening initial value";
      parameter Real c0(fixed=false);
      //=g0 "desired gate position";
      parameter Real e0=0 "initial output for the filter";
      parameter Real nref(fixed=false);
      //=R*c0 "speed reference";
      parameter Types.PerUnit P_m0(fixed=false);
    initial algorithm
      P_m0 := PMECH0;
      q0 := P_m0/(A_t*h0) + q_NL;
      g0 := q0/sqrt(h0);
      //
      //
      c0 := g0;
      //c0_calculation(g0,G_MIN,G_MAX);
      nref := R*c0;
      //
    equation
      G = g.y;
      c = g.u;
      Q = q.y;
      H = product.y;
      connect(add.y, SimpleLag1.u) annotation (Line(points={{-131.4,6},{-127.2,6}}, color={0,0,127}));
      connect(n_ref.y, add.u1) annotation (Line(points={{-165.4,20},{-152,20},{-152,9.6},{-145.2,9.6}}, color={0,0,127}));
      connect(add1.y, add.u2) annotation (Line(points={{-155.4,-6},{-150,-6},{-150,2.4},{-145.2,2.4}}, color={0,0,127}));
      connect(Gain3.y, add1.u2) annotation (Line(points={{-142.6,-16},{-178,-16},{-178,-9.6},{-169.2,-9.6}}, color={0,0,127}));
      connect(g.u, Gain3.u) annotation (Line(points={{-41.2,6},{-52,6},{-52,-16},{-128.8,-16}}, color={0,0,127}));
      connect(division.y, product.u1) annotation (Line(points={{12.6,2},{14,2},{14,5.6},{18.8,5.6}}, color={0,0,127}));
      connect(product.u2, product.u1) annotation (Line(points={{18.8,-1.6},{14,-1.6},{14,5.6},{18.8,5.6}}, color={0,0,127}));
      connect(product.y, add2.u1) annotation (Line(points={{32.6,2},{36,2},{36,5.6},{40.8,5.6}}, color={0,0,127}));
      connect(hs.y, add2.u2) annotation (Line(points={{32.6,-14},{36,-14},{36,-1.6},{40.8,-1.6}}, color={0,0,127}));
      connect(add2.y, q.u) annotation (Line(points={{54.6,2},{60.8,2}}, color={0,0,127}));
      connect(q.y, add3.u1) annotation (Line(points={{74.6,2},{76,2},{76,5.6},{80.8,5.6}}, color={0,0,127}));
      connect(qNL.y, add3.u2) annotation (Line(points={{83.6,-14},{76,-14},{76,-1.6},{80.8,-1.6}}, color={0,0,127}));
      connect(Gain4.y, product1.u2) annotation (Line(points={{-49.4,-28},{4,-28},{4,-27.6},{56.8,-27.6}}, color={0,0,127}));
      connect(product1.y, add4.u2) annotation (Line(points={{70.6,-24},{144,-24},{144,-3.6},{150.8,-3.6}}, color={0,0,127}));
      connect(product1.u1, g.y) annotation (Line(points={{56.8,-20.4},{-16,-20.4},{-16,6},{-27.4,6}}, color={0,0,127}));
      connect(division.u2, g.y) annotation (Line(points={{-1.2,-1.6},{-16,-1.6},{-16,6},{-27.4,6}}, color={0,0,127}));
      connect(division.u1, add3.u1) annotation (Line(points={{-1.2,5.6},{-6,5.6},{-6,20},{76,20},{76,5.6},{80.8,5.6}}, color={0,0,127}));
      connect(Gain6.y, add4.u1) annotation (Line(points={{144.6,4},{150.8,4},{150.8,3.6}}, color={0,0,127}));
      connect(product2.y, Gain6.u) annotation (Line(points={{120.6,4},{130.8,4},{130.8,4}}, color={0,0,127}));
      connect(add3.y, product2.u2) annotation (Line(points={{94.6,2},{100,2},{100,0.4},{106.8,0.4}}, color={0,0,127}));
      connect(product2.u1, add2.u1) annotation (Line(points={{106.8,7.6},{100,7.6},{100,16},{36,16},{36,5.6},{40.8,5.6}}, color={0,0,127}));
      connect(simpleLead.y, Velocity_Limiter.u) annotation (Line(points={{-93.4,6},{-87.2,6}}, color={0,0,127}));
      connect(simpleLead.u, SimpleLag1.y) annotation (Line(points={{-107.2,6},{-113.4,6}}, color={0,0,127}));
      connect(add4.y, PMECH)
        annotation (Line(points={{164.6,0},{250,0},{250,0}}, color={0,0,127}));
      connect(SPEED, add1.u1) annotation (Line(points={{-240,-120},{-200,-120},{
              -200,-2.4},{-169.2,-2.4}}, color={0,0,127}));
      connect(Gain4.u, add1.u1) annotation (Line(points={{-63.2,-28},{-200,-28},{
              -200,-2.4},{-169.2,-2.4}}, color={0,0,127}));
      connect(Velocity_Limiter.y, integrator.u)
        annotation (Line(points={{-73.4,6},{-69.2,6}}, color={0,0,127}));
      connect(g.u, integrator.y)
        annotation (Line(points={{-41.2,6},{-55.4,6}}, color={0,0,127}));
      annotation (
        Diagram(coordinateSystem(preserveAspectRatio=false, extent={{-240,-140},{240,100}}),
                                                                                         graphics={Rectangle(
              extent={{-190,32},{-12,-38}},
              lineColor={255,128,0},
              pattern=LinePattern.Dash,
              lineThickness=1),Text(
              extent={{-126,40},{-82,34}},
              lineColor={255,128,0},
              textStyle={TextStyle.Bold},
              textString="Governor System"),Rectangle(
              extent={{-8,32},{166,-38}},
              lineColor={85,170,255},
              pattern=LinePattern.Dash,
              lineThickness=1),Text(
              extent={{38,42},{98,32}},
              lineColor={85,170,255},
              textStyle={TextStyle.Bold},
              textString="Hydraulic Turbine System")}),
        Icon(graphics={Text(
              extent={{-100,160},{100,100}},
              lineColor={28,108,200},
              textString="HYGOV")}),
        Documentation(info="<html> 
<p> This is a hydro turbine-governor model. </p>
<p> If compared to the original PSSE implementation one will notice that the initial water head value, <code>h0</code>, is declared as a parameter.
This allows the user to modify it, if required, in order to perform adequate studies. 
The user should leave it in its default value (<code>1</code>) if they do not have any information on water head value, or if they do not wish to modify the parameter.</p>
</html>",    revisions="<html>
<table cellspacing=\"1\" cellpadding=\"1\" border=\"1\">
<tr>
<td><p>Reference</p></td>
<td><p>PSS&reg;E Manual</p></td>
</tr>
<tr>
<td><p>Last update</p></td>
<td><p>2022-11</p></td>
</tr>
<tr>
<td><p>Author</p></td>
<td><p>ALSETLab, Rensselaer Polytechnic Institute</p></td>
</tr>
<tr>
<td><p>Contact</p></td>
<td><p>see <a href=\"modelica://OpenIPSL.UsersGuide.Contact\">UsersGuide.Contact</a></p></td>
</tr>
</table>
</html>"));
    end HYGOV4MPC;

    model IEESGO4MPC "IEESGO - IEEE Standard Model for Turbine-Governor"
      extends Icons.VerifiedModel;
    extends Electrical.Controls.PSSE.TG.BaseClasses.BaseGovernor;
      parameter Types.Time T_1=0.2 "Controller lag";
      parameter Types.Time T_2=0 "Controller lead compensation";
      parameter Types.Time T_3=0.5 "Governor lag";
      parameter Types.Time T_4=0.12 "Delay due to steam inlet volumes associated with steam chest and inlet piping";
      parameter Types.Time T_5=5 "Reheater delay including hot and cold leads";
      parameter Types.Time T_6=0.5 "Delay due to IP-LP turbine, crossover pipes, and LP end hoods";
      parameter Real K_1=20 "Regulation gain [1/pu]";
      parameter Types.PerUnit K_2=0.59 "Intermediate pressure turbine fraction";
      parameter Types.PerUnit K_3=0.43 "Low pressure turbine fraction ";
      parameter Types.PerUnit P_MAX=0.98 "Upper power limit";
      parameter Types.PerUnit P_MIN=0 "Lower power limit";
      OpenIPSL.NonElectrical.Continuous.SimpleLag imSimpleLag(
        K=K_1,
        T=T_1,
        y_start=0) annotation (Placement(transformation(extent={{-180,-130},{-160,-110}})));
      NonElectrical.Continuous.SimpleLag        imLeadLag(
        K=1,
        T=T_3,
        y_start=0) annotation (Placement(transformation(extent={{-140,-130},{-120,-110}})));
      OpenIPSL.NonElectrical.Continuous.SimpleLag imSimpleLag1(
        K=1,
        T=T_4,
        y_start=p0) annotation (Placement(transformation(extent={{20,-10},{40,10}})));
      OpenIPSL.NonElectrical.Continuous.SimpleLag imSimpleLag2(
        K=K_2,
        T=T_5,
        y_start=p0*K_2) annotation (Placement(transformation(extent={{80,-80},{100,-60}})));
      OpenIPSL.NonElectrical.Continuous.SimpleLag imSimpleLag3(
        K=K_3,
        T=T_6,
        y_start=p0*K_2*K_3) annotation (Placement(transformation(extent={{120,-80},{
                140,-60}})));
      Modelica.Blocks.Math.Add add(k2=-1) annotation (Placement(transformation(extent={{-60,-10},
                {-40,10}})));
      Modelica.Blocks.Nonlinear.Limiter limiter(uMax=P_MAX, uMin=P_MIN) annotation (Placement(transformation(extent={{-20,-10},
                {0,10}})));
      Modelica.Blocks.Math.Gain gain(k=1 - K_2) annotation (Placement(transformation(extent={{120,-10},
                {140,10}})));
      Modelica.Blocks.Math.Gain gain1(k=1 - K_3) annotation (Placement(transformation(extent={{120,-40},
                {140,-20}})));
      Modelica.Blocks.Math.Add3 add3_1 annotation (Placement(transformation(extent={{160,-18},
                {180,2}})));
    protected
      parameter Types.PerUnit p0(fixed=false);
    initial algorithm
      p0 := PMECH0;

    equation
      connect(imSimpleLag.y, imLeadLag.u) annotation (Line(points={{-159,-120},{-142,
              -120}}, color={0,0,127}));
      connect(imLeadLag.y, add.u2) annotation (Line(points={{-119,-120},{-80,-120},{
              -80,-6},{-62,-6}}, color={0,0,127}));
      connect(add.y, limiter.u) annotation (Line(points={{-39,0},{-22,0}}, color={0,0,127}));
      connect(limiter.y, imSimpleLag1.u) annotation (Line(points={{1,0},{1,0},{18,0}}, color={0,0,127}));
      connect(imSimpleLag2.y, imSimpleLag3.u) annotation (Line(points={{101,-70},{118,
              -70}}, color={0,0,127}));
      connect(gain1.u, imSimpleLag3.u) annotation (Line(points={{118,-30},{110,-30},
              {110,-70},{118,-70}}, color={0,0,127}));
      connect(PMECH0, add.u1) annotation (Line(points={{-240,80},{-80,80},{-80,6},{-62,
              6}}, color={0,0,127}));
      connect(SPEED, imSimpleLag.u) annotation (Line(points={{-240,-120},{-212,-120},
              {-182,-120}}, color={0,0,127}));
      connect(imSimpleLag1.y, gain.u)
        annotation (Line(points={{41,0},{118,0}}, color={0,0,127}));
      connect(imSimpleLag2.u, gain.u) annotation (Line(points={{78,-70},{60,-70},{60,
              0},{118,0}}, color={0,0,127}));
      connect(gain.y, add3_1.u1)
        annotation (Line(points={{141,0},{141,0},{158,0}}, color={0,0,127}));
      connect(gain1.y, add3_1.u2) annotation (Line(points={{141,-30},{148,-30},{148,
              -8},{158,-8}}, color={0,0,127}));
      connect(imSimpleLag3.y, add3_1.u3) annotation (Line(points={{141,-70},{152,-70},
              {152,-16},{158,-16}}, color={0,0,127}));
      connect(add3_1.y, PMECH) annotation (Line(points={{181,-8},{188,-8},{188,0},{250,
              0}}, color={0,0,127}));
      annotation (
        Diagram(coordinateSystem(preserveAspectRatio=false, extent={{-240,-200},{240,160}})),
        Icon(coordinateSystem(preserveAspectRatio=false, extent={{-100,-100},{100,100}}),
             graphics={Text(
              extent={{-100,160},{100,100}},
              lineColor={28,108,200},
              textString="IEESGO")}),
        Documentation(revisions="<html>
<table cellspacing=\"1\" cellpadding=\"1\" border=\"1\">
<tr>
<td><p>Reference</p></td>
<td><p>PSS&reg;E Manual</p></td>
</tr>
<tr>
<td><p>Last update</p></td>
<td><p>2020-09</p></td>
</tr>
<tr>
<td><p>Author</p></td>
<td><p>ALSETLab, Rensselaer Polytechnic Institute</p></td>
</tr>
<tr>
<td><p>Contact</p></td>
<td><p>see <a href=\"modelica://OpenIPSL.UsersGuide.Contact\">UsersGuide.Contact</a></p></td>
</tr>
</table>
</html>"));
    end IEESGO4MPC;

    partial model baseMachine4MPC "Base machine for PSSE models"
      import Complex;
      import Modelica.ComplexMath.arg;
      import Modelica.ComplexMath.real;
      import Modelica.ComplexMath.imag;
      import Modelica.ComplexMath.conj;
      import Modelica.Blocks.Interfaces.*;
      extends OpenIPSL.Electrical.Essentials.pfComponent(
        final enabledisplayPF=false,
        final enablefn=false,
        final enableV_b=false,
        final enableangle_0=true,
        final enablev_0=true,
        final enableQ_0=true,
        final enableP_0=true,
        final enableS_b=true);
      //Machine parameters
      parameter Types.ApparentPower M_b "Machine base power"
        annotation (Dialog(group="Machine parameters"));
      parameter Types.Time Tpd0 "d-axis transient open-circuit time constant"
        annotation (Dialog(group="Machine parameters"));
      parameter Types.Time Tppd0 "d-axis sub-transient open-circuit time constant"
        annotation (Dialog(group="Machine parameters"));
      parameter Types.Time Tppq0 "q-axis sub-transient open-circuit time constant"
        annotation (Dialog(group="Machine parameters"));
      parameter Types.Time H "Inertia constant"
        annotation (Dialog(group="Machine parameters"));
      parameter Real D "Speed damping"
        annotation (Dialog(group="Machine parameters"));
      parameter Types.PerUnit Xd "d-axis reactance"
        annotation (Dialog(group="Machine parameters"));
      parameter Types.PerUnit Xq "q-axis reactance"
        annotation (Dialog(group="Machine parameters"));
      parameter Types.PerUnit Xpd "d-axis transient reactance"
        annotation (Dialog(group="Machine parameters"));
      parameter Types.PerUnit Xppd "d-axis sub-transient reactance"
        annotation (Dialog(group="Machine parameters"));
      parameter Types.PerUnit Xppq "q-axis sub-transient reactance"
        annotation (Dialog(group="Machine parameters"));
      parameter Types.PerUnit Xl "leakage reactance"
        annotation (Dialog(group="Machine parameters"));
      parameter Types.PerUnit S10 "Saturation factor at 1.0 pu"
        annotation (Dialog(group="Machine parameters"));
      parameter Types.PerUnit S12 "Saturation factor at 1.2 pu"
        annotation (Dialog(group="Machine parameters"));
      parameter Types.PerUnit R_a=0 "Armature resistance"
        annotation (Dialog(group="Machine parameters"));
      parameter Types.PerUnit w0(min=-1+C.eps)=0 "Initial speed deviation from nominal"
        annotation (Dialog(group="Initialization"));
      OpenIPSL.Interfaces.PwPin p(
        vr(start=vr0),
        vi(start=vi0),
        ir(start=ir0),
        ii(start=ii0))
        annotation (Placement(transformation(extent={{90,-10},{110,10}})));
      RealOutput SPEED "Machine speed deviation from nominal [pu]"
        annotation (Placement(transformation(extent={{100,60},{120,80}})));
      RealInput PMECH "Turbine mechanical power (machine base)"
        annotation (Placement(transformation(extent={{-140,40},{-100,80}}), iconTransformation(extent={{-140,40},{-100,80}})));
      RealOutput PMECH0 "Initial value of machine electrical power (machine base)"
        annotation (Placement(transformation(extent={{100,40},{120,60}})));
      RealOutput ETERM(start=v_0) "Machine terminal voltage [pu]"
        annotation (Placement(transformation(extent={{100,-40},{120,-20}})));
      RealInput EFD "Generator main field voltage [pu]"
        annotation (Placement(transformation(extent={{-140,-80},{-100,-40}}), iconTransformation(extent={{-140,-80},{-100,-40}})));
      RealOutput EFD0 "Initial generator main field voltage [pu]"
        annotation (Placement(transformation(extent={{100,-60},{120,-40}})));
      RealOutput PELEC(start=p0) "Machine electrical power (machine base)"
        annotation (Placement(transformation(extent={{100,20},{120,40}})));
      RealOutput ISORCE "Machine source current [pu]"
        annotation (Placement(transformation(extent={{100,-80},{120,-60}})));
          RealOutput ANGLE "Machine relative rotor angle"
        annotation (Placement(transformation(extent={{100,80},{120,100}})));
      RealOutput XADIFD "Machine field current [pu]" annotation (Placement(
            transformation(
            extent={{-10,-10},{10,10}},
            origin={110,-90}), iconTransformation(
            extent={{-10,-10},{10,10}},
            origin={110,-90})));
      Types.PerUnit w(start=w0, fixed=true) "Machine speed deviation";
      Types.Angle delta "Rotor angle";
      Types.PerUnit Vt(start=v_0) "Bus voltage magnitude";
      Types.Angle anglev(start=angle_0) "Bus voltage angle";
      Types.PerUnit I(start=sqrt(ir0^2 + ii0^2)) "Terminal current magnitude";
      Types.Angle anglei(start=atan2(ii0, ir0)) "Terminal current angle";
      Types.PerUnit P(start=P_0/S_b) "Active power (system base)";
      Types.PerUnit Q(start=Q_0/S_b) "Reactive power (system base)";
      Types.PerUnit Te "Electrical torque [pu]";
      Types.PerUnit id "d-axis armature current [pu]";
      Types.PerUnit iq "q-axis armature current [pu]";
      Types.PerUnit ud "d-axis terminal voltage [pu]";
      Types.PerUnit uq "q-axis terminal voltage [pu]";
    protected
      parameter Types.AngularVelocity w_b=2*C.pi*fn "System base speed";
      parameter Real CoB=M_b/S_b;
      parameter Types.PerUnit vr0=v_0*cos(angle_0)
        "Real component of initial terminal voltage";
      parameter Types.PerUnit vi0=v_0*sin(angle_0)
        "Imaginary component of initial terminal voltage";
      parameter Types.PerUnit ir0=-CoB*(p0*vr0 + q0*vi0)/(vr0^2 + vi0^2)
        "Real component of initial armature current (system base)";
      parameter Types.PerUnit ii0=-CoB*(p0*vi0 - q0*vr0)/(vr0^2 + vi0^2)
        "Imaginary component of initial armature current (system base)";
      parameter Types.PerUnit p0=P_0/M_b "Initial active power generation (machine base)";
      parameter Types.PerUnit q0=Q_0/M_b
        "Initial reactive power generation (machine base)";
    equation
      //Interfacing outputs with the internal variables
      ANGLE = delta;
      SPEED = w;
      ETERM = Vt;
      PELEC = P/CoB;
      [p.ir; p.ii] = -CoB*[sin(delta), cos(delta); -cos(delta), sin(delta)]*[id; iq];
      [p.vr; p.vi] = [sin(delta), cos(delta); -cos(delta), sin(delta)]*[ud; uq];
      -P = p.vr*p.ir + p.vi*p.ii;
      -Q = p.vi*p.ir - p.vr*p.ii;
      Vt = sqrt(p.vr^2 + p.vi^2);
      anglev = atan2(p.vi, p.vr);
      I = sqrt(p.ii^2 + p.ir^2);
      anglei = atan2(p.ii, p.ir);
      der(w) = ((PMECH - D*w)/(w + 1) - Te)/(2*H);
      der(delta) = w_b*w;
      annotation (
        Icon(coordinateSystem(preserveAspectRatio=false, extent={{-100,-100},{100,
                100}}), graphics={Rectangle(extent={{-100,100},{100,-100}},
              lineColor={0,0,255}),Text(
              extent={{64,75},{92,65}},
              lineColor={0,0,255},
              lineThickness=0.5,
              textString="SPEED"),Text(
              extent={{60,-66},{92,-76}},
              lineColor={0,0,255},
              lineThickness=0.5,
              textString="ISORCE"),Text(
              extent={{64,-25},{92,-35}},
              lineColor={0,0,255},
              textString="ETERM"),Text(
              extent={{64,94},{92,84}},
              lineColor={0,0,255},
              lineThickness=0.5,
              textString="ANGLE"),Text(
              extent={{58,56},{92,46}},
              lineColor={0,0,255},
              lineThickness=0.5,
              textString="PMECH0"),Text(
              extent={{64,34},{92,24}},
              lineColor={0,0,255},
              lineThickness=0.5,
              textString="PELEC"),Text(
              extent={{72,-46},{92,-56}},
              lineColor={0,0,255},
              lineThickness=0.5,
              textString="EFD0"),Text(
              extent={{56,-86},{92,-96}},
              lineColor={0,0,255},
              lineThickness=0.5,
              textString="XADIFD0"),Text(
              extent={{-90,70},{-50,50}},
              lineColor={0,0,255},
              lineThickness=0.5,
              textString="PMECH"), Text(
              extent={{-90,-50},{-60,-70}},
              lineColor={0,0,255},
              lineThickness=0.5,
              textString="EFD")}));
    end baseMachine4MPC;

    model GENROE4MPC
      "ROUND ROTOR GENERATOR MODEL (EXPONENTIAL SATURATION)"
      extends Icons.VerifiedModel;
      //Import of dependencies
      import Complex;
      import Modelica.ComplexMath.arg;
      import Modelica.ComplexMath.real;
      import Modelica.ComplexMath.imag;
      import Modelica.ComplexMath.abs;
      import Modelica.ComplexMath.conj;
      import Modelica.ComplexMath.fromPolar;
      import OpenIPSL.NonElectrical.Functions.SE_exp;
      import Modelica.ComplexMath.j;
      extends Electrical.Machines.PSSE.BaseClasses.baseMachine(
        EFD(start=efd0),
        XADIFD(start=efd0),
        PMECH(start=pm0),
        delta(start=delta0),
        id(start=id0),
        iq(start=iq0),
        ud(start=ud0),
        uq(start=uq0),
        Te(start=pm0));
      //Machine parameters
      parameter Types.PerUnit Xpq "Sub-transient reactance"
        annotation (Dialog(group="Machine parameters"));
      parameter Types.Time Tpq0 "q-axis transient open-circuit time constant"
        annotation (Dialog(group="Machine parameters"));
      parameter Types.PerUnit Xpp=Xppd "Sub-transient reactance"
        annotation (Dialog(group="Machine parameters"));
      Types.PerUnit Epd(start=Epd0) "d-axis voltage behind transient reactance";
      Types.PerUnit Epq(start=Epq0) "q-axis voltage behind transient reactance";
      Types.PerUnit PSIkd(start=PSIkd0) "d-axis rotor flux linkage";
      Types.PerUnit PSIkq(start=PSIkq0) "q-axis rotor flux linkage";
      //State variables
      Types.PerUnit PSId(start=PSId0) "d-axis flux linkage";
      Types.PerUnit PSIq(start=PSIq0) "q-axis flux linkage";
      Types.PerUnit PSIppd(start=PSIppd0) "d-axis subtransient flux linkage";
      Types.PerUnit PSIppq(start=PSIppq0) "q-axis subtransient flux linkage";
      Types.PerUnit PSIpp "Air-gap flux";
      Types.PerUnit XadIfd(start=efd0) "d-axis machine field current";
      Types.PerUnit XaqIlq(start=0) "q-axis Machine field current";
    protected
      parameter Complex Zs=Complex(R_a,Xpp) "Equivalent impedance";
      parameter Complex VT=Complex(v_0*cos(angle_0),v_0*sin(angle_0))
        "Complex terminal voltage";
      parameter Complex S=Complex(p0,q0) "Complex power on machine base";
      parameter Complex It=Complex(real(S/VT),-imag(S/VT))
        "Complex current, machine base";
      parameter Complex Is=Complex(real(It + VT/Zs),imag(It + VT/Zs))
        "Equivalent internal current source";
      parameter Complex PSIpp0=Complex(real(Zs*Is),imag(Zs*Is))
        "Sub-transient flux linkage in stator reference frame";
      parameter Real ang_PSIpp0=arg(PSIpp0) "flux angle";
      parameter Real ang_It=arg(It) "current angle";
      parameter Real ang_PSIpp0andIt=ang_PSIpp0 - ang_It "angle difference";
      parameter Types.PerUnit abs_PSIpp0=abs(PSIpp0)
        "magnitude of sub-transient flux linkage";
      parameter Real dsat=SE_exp(
          abs_PSIpp0,
          S10,
          S12,
          1,
          1.2) "To include saturation of during initialization";
      parameter Real a=abs_PSIpp0 + abs_PSIpp0*dsat*(Xq - Xl)/(Xd - Xl);
      parameter Real b=(It.re^2 + It.im^2)^0.5*(Xpp - Xq);
      //Initializion rotor angle position
      parameter Real delta0=atan(b*cos(ang_PSIpp0andIt)/(b*sin(ang_PSIpp0andIt) - a))
           + ang_PSIpp0 "initial rotor angle in radians";
      parameter Complex DQ_dq=Complex(cos(delta0),-sin(delta0))
        "Parks transformation, from stator to rotor reference frame";
      parameter Complex PSIpp0_dq=Complex(real(PSIpp0*DQ_dq),imag(PSIpp0*DQ_dq))
        "Flux linkage in rotor reference frame";
      parameter Complex I_dq=Complex(real(It*DQ_dq),-imag(It*DQ_dq));
      //"The terminal current in rotor reference frame"
      parameter Types.PerUnit PSIppq0=imag(PSIpp0_dq)
        "q-axis component of the sub-transient flux linkage";
      parameter Types.PerUnit PSIppd0=real(PSIpp0_dq)
        "d-axis component of the sub-transient flux linkage";
      //Initialization of current and voltage components in rotor reference frame (dq-axes).
      parameter Types.PerUnit iq0=real(I_dq) "q-axis component of initial current";
      parameter Types.PerUnit id0=imag(I_dq) "d-axis component of initial current";
      parameter Types.PerUnit ud0=(-(PSIppq0 - Xppq*iq0)) - R_a*id0
        "d-axis component of initial voltage";
      parameter Types.PerUnit uq0=PSIppd0 - Xppd*id0 - R_a*iq0
        "q-axis component of initial voltage";
      //Initialization current and voltage components in synchronous reference frame.
      parameter Types.PerUnit vr0=v_0*cos(angle_0)
        "Real component of initial terminal voltage";
      parameter Types.PerUnit vi0=v_0*sin(angle_0)
        "Imaginary component of initial terminal voltage";
      parameter Types.PerUnit ir0=-CoB*(p0*vr0 + q0*vi0)/(vr0^2 + vi0^2)
        "Real component of initial armature current, systembase";
      parameter Types.PerUnit ii0=-CoB*(p0*vi0 - q0*vr0)/(vr0^2 + vi0^2)
        "Imaginary component of initial armature current, systembase";
      //Initialization mechanical power and field voltage.
      parameter Types.PerUnit pm0=p0 + R_a*iq0*iq0 + R_a*id0*id0
        "Initial mechanical power, machine base";
      parameter Types.PerUnit efd0=dsat*PSIppd0 + PSIppd0 + (Xpd - Xpp)*id0 + (Xd - Xpd)*id0
        "Initial field voltage magnitude";
      parameter Types.PerUnit Epq0=PSIkd0 + (Xpd - Xl)*id0;
      parameter Types.PerUnit Epd0=PSIkq0 - (Xpq - Xl)*iq0;
      //Initialize remaining states:
      parameter Types.PerUnit PSIkd0=(PSIppd0 - (Xpd - Xl)*K3d*id0)/(K3d + K4d)
        "d-axis initial rotor flux linkage";
      parameter Types.PerUnit PSIkq0=((-PSIppq0) + (Xpq - Xl)*K3q*iq0)/(K3q + K4q)
        "q-axis initial rotor flux linkage";
      parameter Types.PerUnit PSId0=PSIppd0 - Xppd*id0;
      parameter Types.PerUnit PSIq0=PSIppq0 - Xppq*iq0;
      // Constants
      parameter Real K1d=(Xpd - Xppd)*(Xd - Xpd)/(Xpd - Xl)^2;
      parameter Real K2d=(Xpd - Xl)*(Xppd - Xl)/(Xpd - Xppd);
      parameter Real K1q=(Xpq - Xppq)*(Xq - Xpq)/(Xpq - Xl)^2;
      parameter Real K2q=(Xpq - Xl)*(Xppq - Xl)/(Xpq - Xppq);
      parameter Real K3d=(Xppd - Xl)/(Xpd - Xl);
      parameter Real K4d=(Xpd - Xppd)/(Xpd - Xl);
      parameter Real K3q=(Xppq - Xl)/(Xpq - Xl);
      parameter Real K4q=(Xpq - Xppq)/(Xpq - Xl);
      parameter Real CoB=M_b/S_b
        "Constant to change from system base to machine base";
    initial equation
      der(Epd) = 0;
      der(Epq) = 0;
      der(PSIkd) = 0;
      der(PSIkq) = 0;
    equation
      //Interfacing outputs with the internal variables
      XADIFD = XadIfd;
      ISORCE = XadIfd;
      EFD0 = efd0;
      PMECH0 = pm0;
      der(Epq) = 1/Tpd0*(EFD - XadIfd);
      der(Epd) = 1/Tpq0*(-1)*XaqIlq;
      der(PSIkd) = 1/Tppd0*(Epq - PSIkd - (Xpd - Xl)*id);
      der(PSIkq) = 1/Tppq0*(Epd - PSIkq + (Xpq - Xl)*iq);
      Te = PSId*iq - PSIq*id;
      PSId = PSIppd - Xppd*id;
      PSIq = (-PSIppq) - Xppq*iq;
      PSIppd = Epq*K3d + PSIkd*K4d;
      -PSIppq = (-Epd*K3q) - PSIkq*K4q;
      PSIpp = sqrt(PSIppd*PSIppd + PSIppq*PSIppq);
      XadIfd = K1d*(Epq - PSIkd - (Xpd - Xl)*id) + Epq + id*(Xd - Xpd) + SE_exp(
        PSIpp,
        S10,
        S12,
        1,
        1.2)*PSIppd;
      XaqIlq = K1q*(Epd - PSIkq + (Xpq - Xl)*iq) + Epd - iq*(Xq - Xpq) - SE_exp(
        PSIpp,
        S10,
        S12,
        1,
        1.2)*(-1)*PSIppq*(Xq - Xl)/(Xd - Xl);
      //change sign for PSIppq 3/3
      ud = (-PSIq) - R_a*id;
      uq = PSId - R_a*iq;
      annotation (
        Icon(coordinateSystem(preserveAspectRatio=false, extent={{-100,-100},{100,
                100}}), graphics={Text(
              extent={{-54,24},{54,-26}},
              lineColor={0,0,255},
              textString="GENROE")}),
              Documentation(info="<html>Round Rotor Generator Model GENROE. It is the same as GENROU model
          except that an exponential function is used as saturation.</html>",
              revisions="<html>
<table cellspacing=\"1\" cellpadding=\"1\" border=\"1\">
<tr>
<td><p>Reference</p></td>
<td><p>PSS&reg;E Manual</p></td>
</tr>
<tr>
<td><p>Last update</p></td>
<td><p>2020-09</p></td>
</tr>
<tr>
<td><p>Author</p></td>
<td><p>ALSETLab, Rensselaer Polytechnic Institute</p></td>
</tr>
<tr>
<td><p>Contact</p></td>
<td><p>see <a href=\"modelica://OpenIPSL.UsersGuide.Contact\">UsersGuide.Contact</a></p></td>
</tr>
</table>
</html>"));
    end GENROE4MPC;

    model SEXSMPC
      "SEXS - Simplified excitation system model (AC4 from [IEEE1981])"
      extends Icons.VerifiedModel;
      extends
        OpenIPSL.Examples.ModelPredictiveControl.GenerationUnits.BaseExciterMPC(
          gain(k=1/K));
      parameter Real T_AT_B=0.1 "Ratio between regulator numerator (lead) and denominator (lag) time constants";
      parameter Real T_B=1 "Regulator denominator (lag) time constant";
      parameter Real K=100 "Excitation power source output gain";
      parameter Real T_E=0.1 "Excitation power source output time constant";
      parameter Real E_MIN=-10 "Minimum exciter output";
      parameter Real E_MAX=10 "Maximum exciter output";
      Modelica.Blocks.Math.Add3 V_erro(
        k3=1,
        k1=1,
        k2=1) annotation (Placement(transformation(extent={{-40,-10},{-20,10}})));
      NonElectrical.Continuous.SimpleLagLim simpleLagLim(
        K=K,
        T=T_E,
        y_start=Efd0,
        outMax=E_MAX,
        outMin=E_MIN)
        annotation (Placement(transformation(extent={{120,-10},{140,10}})));
      Modelica.Blocks.Math.Add DiffV1 annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=90,
            origin={-100,-50})));
      NonElectrical.Continuous.LeadLag leadLag(
        K=1,
        T1=T_AT_B*T_B,
        T2=T_B,
        y_start=Efd0/K,
        x_start=Efd0/K)
        annotation (Placement(transformation(extent={{40,-10},{60,10}})));
    initial equation
      V_REF = Efd0/K + ECOMP0;
    equation
      connect(simpleLagLim.y, EFD)
        annotation (Line(points={{141,0},{210,0}}, color={0,0,127}));
      connect(DiffV.y, V_erro.u2)
        annotation (Line(points={{-99,0},{-42,0}}, color={0,0,127}));
      connect(V_erro.u1, VOTHSG) annotation (Line(points={{-42,8},{-52,8},{-52,90},
              {-200,90}}, color={0,0,127}));
      connect(ECOMP, DiffV.u2) annotation (Line(points={{-200,0},{-166,0},{-132,0},
              {-132,-6},{-122,-6}}, color={0,0,127}));
      connect(VUEL, DiffV1.u1) annotation (Line(points={{-130,-200},{-130,-72},{
              -106,-72},{-106,-62}}, color={0,0,127}));
      connect(VOEL, DiffV1.u2) annotation (Line(points={{-70,-200},{-70,-72},{-94,
              -72},{-94,-62}}, color={0,0,127}));
      connect(DiffV1.y, V_erro.u3) annotation (Line(points={{-100,-39},{-100,-16},{
              -42,-16},{-42,-8}}, color={0,0,127}));
      connect(V_erro.y, leadLag.u)
        annotation (Line(points={{-19,0},{38,0}}, color={0,0,127}));
      connect(leadLag.y, simpleLagLim.u)
        annotation (Line(points={{61,0},{118,0}}, color={0,0,127}));
      annotation (
        Diagram(coordinateSystem(extent={{-200,-200},{200,160}})),
        Icon(coordinateSystem(extent={{-100,-100},{100,100}}),
            graphics={Text(
              extent={{-100,160},{100,100}},
              lineColor={28,108,200},
              textString="SEXS")}),
        Documentation(info="<html>Simplified Excitation System Model.</html>",
        revisions = "<html><table cellspacing=\"1\" cellpadding=\"1\" border=\"1\">
<tr>
<td><p>Reference</p></td>
<td><p>PSS/E Manual</p></td>
</tr>
<tr>
<td><p>Last update</p></td>
<td><p>2020-09</p></td>
</tr>
<tr>
<td><p>Author</p></td>
<td><p>Mengjia Zhang, SmarTS Lab, KTH Royal Institute of Technology</p></td>
</tr>
<tr>
<td><p>Contact</p></td>
<td><p>see <a href=\"modelica://OpenIPSL.UsersGuide.Contact\">UsersGuide.Contact</a></p></td>
</tr>
</table>
</html>"));
    end SEXSMPC;

    model REECCU1
      "Electrical control model for utility scale battery energy storage"
      extends
        OpenIPSL.Electrical.Renewables.PSSE.ElectricalController.BaseClasses.BaseREECC(
         Iqcmd, Ipcmd);

      parameter OpenIPSL.Types.PerUnit Vdip = -99 "Low voltage threshold to activate reactive current injection logic (0.85 - 0.9)";
      parameter OpenIPSL.Types.PerUnit Vup = 99 "Voltage above which reactive current injection logic is activated (>1.1)";
      parameter OpenIPSL.Types.Time Trv = 0.01 "Filter time constant for voltage measurement (0.01 - 0.02)";
      parameter OpenIPSL.Types.PerUnit dbd1 = 0 "Voltage error dead band lower threshold (-0.1 - 0)";
      parameter OpenIPSL.Types.PerUnit dbd2 = 0 "Voltage error dead band upper threshold (0 - 0.1)";
      parameter Real Kqv = 0 "Reactive current injection gain during over and undervoltage conditions (0 - 10)";
      parameter OpenIPSL.Types.PerUnit Iqh1 = 1 "Upper limit on reactive current injection Iqinj (1 - 1.1)";
      parameter OpenIPSL.Types.PerUnit Iql1 = -1 "Lower limit on reactive current injection Iqinj (-1.1 - 1)";
      parameter OpenIPSL.Types.PerUnit vref0 = 1 "User defined voltage reference (0.95 - 1.05)";
      parameter OpenIPSL.Types.Time Tp = 0.01 "Filter time constant for electrical power (0.01 - 0.1)";
      parameter OpenIPSL.Types.PerUnit Qmax = 1 "Upper limits of the limit for reactive power regulator (0.4 - 1.0)";
      parameter OpenIPSL.Types.PerUnit Qmin = -1 "Lower limits of the limit for reactive power regulator (-1.0 - -0.4)";
      parameter OpenIPSL.Types.PerUnit Vmax = 1.1 "Maximum limit for voltage control (1.05 - 1.1)";
      parameter OpenIPSL.Types.PerUnit Vmin = 0.9 "Lower limits of input signals (0.9 - 0.95)";
      parameter Real Kqp = 0 "Reactive power regulator proportional gain (No predefined range)";
      parameter Real Kqi = 0.1 "Reactive power regulator integral gain (No predefined range)";
      parameter Real Kvp = 0 "Voltage regulator proportional gain (No predefined range)";
      parameter Real Kvi = 40 "Voltage regulator integral gain (No predefined range)";
      parameter OpenIPSL.Types.Time Tiq = 0.01 "Time constant on lag delay (0.01 - 0.02)";
      parameter Real dPmax = 99 "Power reference maximum ramp rate (No predefined range)";
      parameter Real dPmin = -99 "Lower limits of input signals (No predefined range)";
      parameter OpenIPSL.Types.PerUnit Pmax = 1 "Maximum power limit";
      parameter OpenIPSL.Types.PerUnit Pmin = 0 "Minimum power limit";
      parameter OpenIPSL.Types.PerUnit Imax = 1.1 "Maximum limit on total converter current (1.1 - 1.3)";
      parameter OpenIPSL.Types.Time Tpord = 0.02 "Power filter time constant (0.01 - 0.02) ";
      parameter OpenIPSL.Types.PerUnit Vq1 = 0.2 "Reactive Power V-I pair, voltage (user defined)";
      parameter OpenIPSL.Types.PerUnit Iq1 = 0.75 "Reactive Power V-I pair, current (user defined)";
      parameter OpenIPSL.Types.PerUnit Vq2 = 0.5 "Reactive Power V-I pair, voltage (user defined)";
      parameter OpenIPSL.Types.PerUnit Iq2 = 0.75 "Reactive Power V-I pair, current (user defined)";
      parameter OpenIPSL.Types.PerUnit Vq3 = 0.75 "Reactive Power V-I pair, voltage (user defined)";
      parameter OpenIPSL.Types.PerUnit Iq3 = 0.75 "Reactive Power V-I pair, current (user defined)";
      parameter OpenIPSL.Types.PerUnit Vq4 = 1 "Reactive Power V-I pair, voltage (user defined)";
      parameter OpenIPSL.Types.PerUnit Iq4 = 0.75 "Reactive Power V-I pair, current (user defined)";
      parameter OpenIPSL.Types.PerUnit Vp1 = 0.2 "Real Power V-I pair, voltage (user defined)";
      parameter OpenIPSL.Types.PerUnit Ip1 = 1.11 "Real Power V-I pair, current (user defined)";
      parameter OpenIPSL.Types.PerUnit Vp2 = 0.5 "Real Power V-I pair, voltage (user defined)";
      parameter OpenIPSL.Types.PerUnit Ip2 = 1.11 "Real Power V-I pair, current (user defined)";
      parameter OpenIPSL.Types.PerUnit Vp3 = 0.75 "Real Power V-I pair, voltage (user defined)";
      parameter OpenIPSL.Types.PerUnit Ip3 = 1.11 "Real Power V-I pair, current (user defined)";
      parameter OpenIPSL.Types.PerUnit Vp4 = 1 "Real Power V-I pair, voltage (user defined)";
      parameter OpenIPSL.Types.PerUnit Ip4 = 1.11 "Real Power V-I pair, current (user defined)";
      parameter Modelica.Units.SI.Time T = 999 "Battery discharge time";
      parameter OpenIPSL.Types.PerUnit SOCini = 0.5 "Initial state of charge";
      parameter OpenIPSL.Types.PerUnit SOCmax = 0.8 "Maximum allowable state of charge";
      parameter OpenIPSL.Types.PerUnit SOCmin = 0.2 "Minimum allowable state of charge";

      Integer Voltage_dip;

      Modelica.Blocks.Math.Division division1
        annotation (Placement(transformation(extent={{-54,-120},{-34,-140}})));
      Modelica.Blocks.Nonlinear.Limiter limiter5(uMax=Modelica.Constants.inf, uMin=0.01)
        annotation (Placement(transformation(extent={{-100,-90},{-80,-70}})));
      Modelica.Blocks.Math.Add add8(k2=-1)
        annotation (Placement(transformation(extent={{-242,-136},{-222,-116}})));
      Modelica.Blocks.Nonlinear.Limiter limiter7(uMax=dPmax, uMin=dPmin)
        annotation (Placement(transformation(extent={{-208,-136},{-188,-116}})));
      Modelica.Blocks.Continuous.Integrator integrator3(k=1/Tpord,
        initType=Modelica.Blocks.Types.Init.InitialState, y_start=Ip0*V0)
        annotation (Placement(transformation(extent={{-142,-136},{-122,-116}})));
      Modelica.Blocks.Nonlinear.Limiter limiter8(uMax=Pmax, uMin=Pmin)
        annotation (Placement(transformation(extent={{-102,-136},{-82,-116}})));
      Modelica.Blocks.Sources.RealExpression Vt_filt3(y=simpleLag.y)
        annotation (Placement(transformation(extent={{-140,-90},{-120,-70}})));
      Modelica.Blocks.Math.Add add7(k1=+1, k2=+1)
        annotation (Placement(transformation(extent={{-18,-140},{2,-120}})));
      Modelica.Blocks.Nonlinear.VariableLimiter variableLimiter2
        annotation (Placement(transformation(extent={{228,-170},{248,-150}})));
      Modelica.Blocks.Sources.RealExpression IPMAX(y=ccl_reecc.Ipmax) annotation (
          Placement(transformation(
            extent={{-10,10},{10,-10}},
            rotation=180,
            origin={240,-120})));
      Modelica.Blocks.Sources.RealExpression IPMIN(y=ccl_reecc.Ipmin) annotation (
          Placement(transformation(
            extent={{-10,10},{10,-10}},
            rotation=180,
            origin={240,-184})));
      Modelica.Blocks.Math.Product product2
        annotation (Placement(transformation(extent={{224,-136},{204,-116}})));
      Modelica.Blocks.Math.Product product3
        annotation (Placement(transformation(extent={{-10,-10},{10,10}},
            rotation=180,
            origin={214,-190})));
      Modelica.Blocks.Sources.RealExpression SOC_ipmax(y=sOC_logic.ipmax_SOC)
        annotation (Placement(transformation(extent={{250,-122},{230,-142}})));
      Modelica.Blocks.Sources.RealExpression SOC_ipmin(y=sOC_logic.ipmin_SOC)
        annotation (Placement(transformation(extent={{250,-186},{230,-206}})));
      Modelica.Blocks.Sources.RealExpression PELEC(y=Pe)
        annotation (Placement(transformation(extent={{-164,-226},{-144,-206}})));
      Modelica.Blocks.Continuous.Integrator integrator1(k=1/T,
        initType=Modelica.Blocks.Types.Init.InitialState, y_start=p00)
        annotation (Placement(transformation(extent={{-134,-226},{-114,-206}})));
      Modelica.Blocks.Math.Add add1(k1=-1, k2=+1)
        annotation (Placement(transformation(extent={{-104,-244},{-84,-224}})));
      Modelica.Blocks.Nonlinear.Limiter limiter1(uMax=SOCmax, uMin=SOCmin)
        annotation (Placement(transformation(extent={{-74,-244},{-54,-224}})));
      OpenIPSL.Electrical.Renewables.PSSE.ElectricalController.BaseClasses.StateOfChargeLogic
        sOC_logic(SOCmin=SOCmin, SOCmax=SOCmax)
        annotation (Placement(transformation(extent={{-30,-244},{-10,-224}})));
      Modelica.Blocks.Sources.BooleanConstant PfFlag_logic(k=pfflag)
        annotation (Placement(transformation(extent={{-254,86},{-234,106}})));
      Modelica.Blocks.Logical.Switch PfFlag
        "Constant Q (False) or PF (True) local control."
        annotation (Placement(transformation(extent={{-198,136},{-178,156}})));
      Modelica.Blocks.Nonlinear.Limiter limiter2(uMax=Qmax, uMin=Qmin)
        annotation (Placement(transformation(extent={{-164,136},{-144,156}})));
      Modelica.Blocks.Math.Add add2(k2=-1)
        annotation (Placement(transformation(extent={{-134,130},{-114,150}})));
      Modelica.Blocks.Sources.RealExpression frzState(y=if Voltage_dip == 1 then 0
             else 1) annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={-114,82})));
      Modelica.Blocks.Math.Product product1
        annotation (Placement(transformation(extent={{-124,90},{-104,110}})));
      Modelica.Blocks.Nonlinear.Limiter limiter3(uMax=Vmax, uMin=Vmin)
        annotation (Placement(transformation(extent={{-40,124},{-20,144}})));
      Modelica.Blocks.Sources.BooleanConstant Vflag_logic(k=vflag)
        annotation (Placement(transformation(extent={{-60,70},{-40,90}})));
      Modelica.Blocks.Logical.Switch VFlag
        "Constant Q (False) or PF (True) local control."
        annotation (Placement(transformation(extent={{-4,124},{16,144}})));
      Modelica.Blocks.Sources.RealExpression VReF0(y=Vref0) annotation (Placement(
            transformation(
            extent={{-10,10},{10,-10}},
            origin={-38,50})));
      Modelica.Blocks.Nonlinear.Limiter limiter4(uMax=Vmax, uMin=Vmin)
        annotation (Placement(transformation(extent={{26,124},{46,144}})));
      Modelica.Blocks.Math.Add add5(k2=-1)
        annotation (Placement(transformation(extent={{58,124},{78,144}})));
      Modelica.Blocks.Sources.RealExpression Vt_filt2(y=simpleLag.y)
        annotation (Placement(transformation(extent={{78,124},{58,104}})));
      Modelica.Blocks.Math.Product product4
        annotation (Placement(transformation(extent={{52,70},{72,90}})));
      Modelica.Blocks.Sources.RealExpression frzState1(y=if Voltage_dip == 1 then 0
             else 1) annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            origin={28,74})));
      Modelica.Blocks.Nonlinear.VariableLimiter variableLimiter1
        annotation (Placement(transformation(extent={{158,120},{178,140}})));
      Modelica.Blocks.Sources.RealExpression IQMAX_(y=ccl_reecc.Iqmax) annotation (
          Placement(transformation(
            extent={{-10,10},{10,-10}},
            rotation=180,
            origin={170,154})));
      Modelica.Blocks.Sources.RealExpression IQMIN_(y=ccl_reecc.Iqmin) annotation (
          Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={170,104})));
      Modelica.Blocks.Logical.Switch QFlag
        annotation (Placement(transformation(extent={{198,84},{218,104}})));
      Modelica.Blocks.Sources.BooleanConstant QFLAG(k=qflag)
        annotation (Placement(transformation(extent={{158,66},{178,86}})));
      Modelica.Blocks.Math.Add add9(k2=+1)
        annotation (Placement(transformation(extent={{232,150},{252,170}})));
      Modelica.Blocks.Nonlinear.VariableLimiter variableLimiter
        annotation (Placement(transformation(extent={{266,150},{286,170}})));
      Modelica.Blocks.Sources.RealExpression IQMIN(y=ccl_reecc.Iqmin)
        annotation (Placement(transformation(extent={{286,150},{266,130}})));
      Modelica.Blocks.Sources.RealExpression IQMAX(y=ccl_reecc.Iqmax)
        annotation (Placement(transformation(extent={{286,174},{266,194}})));
      Modelica.Blocks.Math.Add add10(k2=-1)
        annotation (Placement(transformation(extent={{52,-6},{72,14}})));
      Modelica.Blocks.Continuous.Integrator integrator4(k=1/Tiq,
        initType=Modelica.Blocks.Types.Init.InitialState, y_start=-Iq0 - (-
            V0 + Vref0)*Kqv)
        annotation (Placement(transformation(extent={{132,0},{152,20}})));
      Modelica.Blocks.Math.Product product5
        annotation (Placement(transformation(extent={{96,0},{116,20}})));
      Modelica.Blocks.Sources.RealExpression Vt_filt1(y=simpleLag.y)
        annotation (Placement(transformation(extent={{-68,-20},{-48,0}})));
      Modelica.Blocks.Nonlinear.Limiter limiter6(uMax=Modelica.Constants.inf, uMin=0.01)
        annotation (Placement(transformation(extent={{-28,-20},{-8,0}})));
      Modelica.Blocks.Math.Division division
        annotation (Placement(transformation(extent={{12,0},{32,20}})));
      Modelica.Blocks.Tables.CombiTable1Ds VDL1(table=[Vq1,Iq1; Vq2,Iq2; Vq3,Iq3;
            Vq4,Iq4],
        smoothness=Modelica.Blocks.Types.Smoothness.LinearSegments,
        extrapolation=Modelica.Blocks.Types.Extrapolation.HoldLastPoint)
        annotation (Placement(transformation(extent={{56,-60},{76,-40}})));
      Modelica.Blocks.Tables.CombiTable1Ds VDL2(table=[Vp1,Ip1; Vp2,Ip2; Vp3,Ip3;
            Vp4,Ip4],
        smoothness=Modelica.Blocks.Types.Smoothness.LinearSegments,
        extrapolation=Modelica.Blocks.Types.Extrapolation.HoldLastPoint)
        annotation (Placement(transformation(extent={{56,-60},{76,-80}})));
      OpenIPSL.Electrical.Renewables.PSSE.ElectricalController.BaseClasses.CurrentLimitLogicREECC
        ccl_reecc(
        start_ii=-Iq0,
        start_ir=Ip0,
        Imax=Imax)
        annotation (Placement(transformation(extent={{92,-76},{124,-44}})));
      Modelica.Blocks.Sources.RealExpression IQCMD(y=Iqcmd)
        annotation (Placement(transformation(extent={{168,-48},{148,-28}})));
      Modelica.Blocks.Sources.BooleanConstant PQFLAG(k=pqflag)
        annotation (Placement(transformation(extent={{168,-50},{148,-70}})));
      Modelica.Blocks.Sources.RealExpression IPCMD(y=Ipcmd)
        annotation (Placement(transformation(extent={{168,-72},{148,-92}})));
      NonElectrical.Continuous.SimpleLag simpleLag(
        K=1,
        T=Trv,
        y_start=V0)
        annotation (Placement(transformation(extent={{-288,230},{-268,250}})));
      Modelica.Blocks.Math.Add add(k1=-1)
        annotation (Placement(transformation(extent={{-248,224},{-228,244}})));
      Modelica.Blocks.Nonlinear.Limiter limiter(uMax=Iqh1, uMin=Iql1)
        annotation (Placement(transformation(extent={{-128,224},{-108,244}})));
      Modelica.Blocks.Sources.RealExpression VREF0(y=Vref0)
        annotation (Placement(transformation(extent={{-288,200},{-268,220}})));
      Modelica.Blocks.Nonlinear.DeadZone dbd1_dbd2(uMax=dbd2, uMin=dbd1)
        annotation (Placement(transformation(extent={{-208,224},{-188,244}})));
      Modelica.Blocks.Math.Gain gain2(k=Kqv)
        annotation (Placement(transformation(extent={{-168,224},{-148,244}})));
      NonElectrical.Continuous.SimpleLag simpleLag1(
        K=1,
        T=Tp,
        y_start=p00)
        annotation (Placement(transformation(extent={{-268,150},{-248,170}})));
      Modelica.Blocks.Math.Tan tan1
        annotation (Placement(transformation(extent={{-268,140},{-248,120}})));
      Modelica.Blocks.Math.Product product6
        annotation (Placement(transformation(extent={{-238,144},{-218,164}})));
      Modelica.Blocks.Sources.RealExpression PFAREF(y=pfangle)
        annotation (Placement(transformation(extent={{10,-10},{-10,10}},
            rotation=180,
            origin={-288,130})));

      Modelica.Blocks.Math.Product product7
        annotation (Placement(transformation(extent={{-174,-136},{-154,-116}})));
      Modelica.Blocks.Sources.RealExpression frzState2(y=if Voltage_dip == 1 then 0
             else 1) annotation (Placement(transformation(
            extent={{-10,10},{10,-10}},
            origin={-196,-96})));
      Modelica.Blocks.Sources.Constant SOC(k=SOCini)
        annotation (Placement(transformation(extent={{-200,-260},{-180,-240}})));
      Modelica.Blocks.Continuous.Integrator integrator(
        k=Kqi,
        initType=Modelica.Blocks.Types.Init.InitialState,
        y_start=V0)
        annotation (Placement(transformation(extent={{-96,90},{-76,110}})));
      Modelica.Blocks.Math.Gain gain(k=Kqp)
        annotation (Placement(transformation(extent={{-94,130},{-74,150}})));
      Modelica.Blocks.Math.Add add3
        annotation (Placement(transformation(extent={{-66,124},{-46,144}})));
      Modelica.Blocks.Math.Gain gain1(k=Kvp)
        annotation (Placement(transformation(extent={{100,126},{120,146}})));
      Modelica.Blocks.Continuous.Integrator integrator2(
        k=Kvi,
        initType=Modelica.Blocks.Types.Init.InitialState,
        y_start=-Iq0 - (-V0 + Vref0)*Kqv)
        annotation (Placement(transformation(extent={{100,92},{120,112}})));
      Modelica.Blocks.Math.Add add4
        annotation (Placement(transformation(extent={{128,120},{148,140}})));
    protected
      parameter Real pfaref=p00/sqrt(p00^2 +q00^2) "Power Factor of choice.";
      parameter OpenIPSL.Types.Angle pfangle = if q00 > 0 then acos(pfaref) else -acos(pfaref);
      parameter OpenIPSL.Types.PerUnit Ip0(fixed=false);
      parameter OpenIPSL.Types.PerUnit Iq0(fixed=false);
      parameter OpenIPSL.Types.PerUnit V0(fixed=false);
      parameter OpenIPSL.Types.PerUnit p00(fixed=false);
      parameter OpenIPSL.Types.PerUnit q00(fixed=false);
      parameter OpenIPSL.Types.PerUnit Vref0 = if vref0 == 0 then V0 else vref0;

    initial equation

      Ip0 = ip0;
      Iq0 = iq0;
      V0 = v0;
      p00 = p0;
      q00 = q0;
    equation

      Voltage_dip = if Vt<Vdip or Vt>Vup then 1 else 0;

      connect(limiter5.y,division1. u2) annotation (Line(points={{-79,-80},{-68,-80},
              {-68,-124},{-56,-124}}, color={0,0,127}));
      connect(add8.y,limiter7. u)
        annotation (Line(points={{-221,-126},{-210,-126}},
                                                         color={0,0,127}));
      connect(integrator3.y,limiter8. u)
        annotation (Line(points={{-121,-126},{-104,-126}},
                                                         color={0,0,127}));
      connect(add8.u2,limiter8. u) annotation (Line(points={{-244,-132},{-252,-132},
              {-252,-152},{-112,-152},{-112,-126},{-104,-126}},
                                                       color={0,0,127}));
      connect(Vt_filt3.y,limiter5. u)
        annotation (Line(points={{-119,-80},{-102,-80}},
                                                      color={0,0,127}));
      connect(add8.u1, Pref)
        annotation (Line(points={{-244,-120},{-292,-120},{-292,-80},{-320,-80}},
                                                           color={0,0,127}));
      connect(limiter8.y, division1.u1) annotation (Line(points={{-81,-126},{-72,-126},
              {-72,-136},{-56,-136}}, color={0,0,127}));
      connect(division1.y, add7.u1) annotation (Line(points={{-33,-130},{-28,-130},{
              -28,-124},{-20,-124}}, color={0,0,127}));
      connect(Paux, add7.u2) annotation (Line(points={{-320,-160},{-26,-160},{-26,-136},
              {-20,-136}}, color={0,0,127}));
      connect(variableLimiter2.y, Ipcmd)
        annotation (Line(points={{249,-160},{288,-160},{288,-170},{310,-170}},
                                                         color={0,0,127}));
      connect(add7.y,variableLimiter2. u) annotation (Line(points={{3,-130},{114,-130},
              {114,-160},{226,-160}}, color={0,0,127}));
      connect(product2.y,variableLimiter2. limit1) annotation (Line(points={{203,-126},
              {180,-126},{180,-152},{226,-152}},
                                      color={0,0,127}));
      connect(IPMAX.y,product2. u1)
        annotation (Line(points={{229,-120},{226,-120}}, color={0,0,127}));
      connect(product3.u2,IPMIN. y)
        annotation (Line(points={{226,-184},{229,-184}}, color={0,0,127}));
      connect(variableLimiter2.limit2,product3. y) annotation (Line(points={{226,-168},
              {180,-168},{180,-190},{203,-190}}, color={0,0,127}));
      connect(product2.u2,SOC_ipmax. y)
        annotation (Line(points={{226,-132},{229,-132}},
                                                       color={0,0,127}));
      connect(product3.u1,SOC_ipmin. y)
        annotation (Line(points={{226,-196},{229,-196}}, color={0,0,127}));
      connect(PELEC.y,integrator1. u)
        annotation (Line(points={{-143,-216},{-136,-216}},
                                                         color={0,0,127}));
      connect(integrator1.y,add1. u1) annotation (Line(points={{-113,-216},{-112,-216},
              {-112,-228},{-106,-228}}, color={0,0,127}));
      connect(add1.y,limiter1. u)
        annotation (Line(points={{-83,-234},{-76,-234}}, color={0,0,127}));
      connect(limiter1.y,sOC_logic. SOC)
        annotation (Line(points={{-53,-234},{-32,-234}},color={0,0,127}));
      connect(simpleLag.y,add. u1) annotation (Line(points={{-267,240},{-250,240}},
                                color={0,0,127}));
      connect(VREF0.y,add. u2) annotation (Line(points={{-267,210},{-254,210},{-254,
              228},{-250,228}},color={0,0,127}));
      connect(dbd1_dbd2.y,gain2. u)
        annotation (Line(points={{-187,234},{-170,234}}, color={0,0,127}));
      connect(add.y,dbd1_dbd2. u)
        annotation (Line(points={{-227,234},{-210,234}}, color={0,0,127}));
      connect(gain2.y,limiter. u)
        annotation (Line(points={{-147,234},{-130,234}},
                                                     color={0,0,127}));
      connect(simpleLag1.y,product6. u1)
        annotation (Line(points={{-247,160},{-240,160}}, color={0,0,127}));
      connect(tan1.y,product6. u2) annotation (Line(points={{-247,130},{-240,130},{-240,
              148}}, color={0,0,127}));
      connect(Pe,simpleLag1. u)
        annotation (Line(points={{-320,160},{-270,160}}, color={0,0,127}));
      connect(PFAREF.y,tan1. u)
        annotation (Line(points={{-277,130},{-270,130}},
                                                       color={0,0,127}));
      connect(Qext,PfFlag. u3) annotation (Line(points={{-320,0},{-204,0},{-204,138},
              {-200,138}}, color={0,0,127}));
      connect(product6.y,PfFlag. u1)
        annotation (Line(points={{-217,154},{-200,154}}, color={0,0,127}));
      connect(PfFlag_logic.y,PfFlag. u2) annotation (Line(points={{-233,96},{-208,
              96},{-208,146},{-200,146}},
                                      color={255,0,255}));
      connect(PfFlag.y,limiter2. u)
        annotation (Line(points={{-177,146},{-166,146}}, color={0,0,127}));
      connect(limiter2.y,add2. u1)
        annotation (Line(points={{-143,146},{-136,146}}, color={0,0,127}));
      connect(Qgen,add2. u2) annotation (Line(points={{-320,80},{-136,80},{-136,134}},
            color={0,0,127}));
      connect(frzState.y,product1. u2) annotation (Line(points={{-125,82},{-130,82},
              {-130,94},{-126,94}}, color={0,0,127}));
      connect(limiter3.y,VFlag. u1) annotation (Line(points={{-19,134},{-18,134},{-18,
              142},{-6,142}},color={0,0,127}));
      connect(Vflag_logic.y,VFlag. u2) annotation (Line(points={{-39,80},{-16,80},{-16,
              134},{-6,134}},color={255,0,255}));
      connect(limiter4.y,add5. u1) annotation (Line(points={{47,134},{52,134},{52,140},
              {56,140}}, color={0,0,127}));
      connect(Vt_filt2.y,add5. u2) annotation (Line(points={{57,114},{52,114},{52,128},
              {56,128}}, color={0,0,127}));
      connect(VFlag.y,limiter4. u)
        annotation (Line(points={{17,134},{24,134}}, color={0,0,127}));
      connect(frzState1.y,product4. u2) annotation (Line(points={{39,74},{50,74}},
                            color={0,0,127}));
      connect(IQMAX_.y,variableLimiter1. limit1) annotation (Line(points={{159,154},
              {152,154},{152,138},{156,138}}, color={0,0,127}));
      connect(variableLimiter1.y,QFlag. u1)
        annotation (Line(points={{179,130},{196,130},{196,102}},color={0,0,127}));
      connect(QFLAG.y,QFlag. u2) annotation (Line(points={{179,76},{184,76},{184,94},
              {196,94}}, color={255,0,255}));
      connect(IQMIN_.y,variableLimiter1. limit2) annotation (Line(points={{159,104},
              {152,104},{152,122},{156,122}},
                                            color={0,0,127}));
      connect(add9.y,variableLimiter. u)
        annotation (Line(points={{253,160},{264,160}},
                                                     color={0,0,127}));
      connect(IQMIN.y,variableLimiter. limit2) annotation (Line(points={{265,140},{258,
              140},{258,152},{264,152}},
                                      color={0,0,127}));
      connect(IQMAX.y,variableLimiter. limit1) annotation (Line(points={{265,184},{258,
              184},{258,168},{264,168}},
                                       color={0,0,127}));
      connect(QFlag.y,add9. u2) annotation (Line(points={{219,94},{230,94},{230,154}},
                         color={0,0,127}));
      connect(add10.y, product5.u2)
        annotation (Line(points={{73,4},{94,4}}, color={0,0,127}));
      connect(Vt_filt1.y,limiter6. u)
        annotation (Line(points={{-47,-10},{-30,-10}}, color={0,0,127}));
      connect(limiter6.y,division. u2) annotation (Line(points={{-7,-10},{0,-10},{0,
              4},{10,4}},color={0,0,127}));
      connect(division.u1,limiter2. u) annotation (Line(points={{10,16},{-172,16},{-172,
              146},{-166,146}}, color={0,0,127}));
      connect(division.y, add10.u1)
        annotation (Line(points={{33,10},{50,10}}, color={0,0,127}));
      connect(integrator4.y,QFlag. u3) annotation (Line(points={{153,10},{188,10},{188,
              86},{196,86}}, color={0,0,127}));
      connect(add10.u2, QFlag.u3) annotation (Line(points={{50,-2},{40,-2},{40,-12},
              {188,-12},{188,86},{196,86}}, color={0,0,127}));
      connect(product5.y,integrator4. u)
        annotation (Line(points={{117,10},{130,10}}, color={0,0,127}));
      connect(product5.u1,product4. u2) annotation (Line(points={{94,16},{82,16},{82,
              46},{44,46},{44,74},{50,74}}, color={0,0,127}));
      connect(VDL2.u,limiter6. u) annotation (Line(points={{54,-70},{-36,-70},{-36,-10},
              {-30,-10}}, color={0,0,127}));
      connect(VDL1.u,limiter6. u) annotation (Line(points={{54,-50},{-36,-50},{-36,-10},
              {-30,-10}}, color={0,0,127}));
      connect(VDL2.y[1], ccl_reecc.VDL2_out)
        annotation (Line(points={{77,-70},{88.8,-69.6}}, color={0,0,127}));
      connect(VDL1.y[1], ccl_reecc.VDL1_out) annotation (Line(points={{77,-50},{77,-50.4},
              {88.8,-50.4}}, color={0,0,127}));
      connect(PQFLAG.y, ccl_reecc.pqflag)
        annotation (Line(points={{147,-60},{88.8,-60}},  color={255,0,255}));
      connect(IQCMD.y, ccl_reecc.Iqcmd) annotation (Line(points={{147,-38},{132,-38},{132,-50.4},{127.2,-50.4}},
                                          color={0,0,127}));
      connect(IPCMD.y, ccl_reecc.Ipcmd) annotation (Line(points={{147,-82},{132,-82},{132,-69.6},{127.2,-69.6}},
                                          color={0,0,127}));
      connect(limiter.y, add9.u1)
        annotation (Line(points={{-107,234},{230,234},{230,166}},color={0,0,127}));
      connect(variableLimiter.y, Iqcmd)
        annotation (Line(points={{287,160},{294,160},{294,170},{310,170}},
                                                     color={0,0,127}));
      connect(Vt, simpleLag.u)
        annotation (Line(points={{-320,240},{-290,240}}, color={0,0,127}));
      connect(product1.u1, add2.y) annotation (Line(points={{-126,106},{-130,106},{-130,
              122},{-113,122},{-113,140}}, color={0,0,127}));
      connect(product4.u1, add5.y) annotation (Line(points={{50,86},{44,86},{44,98},
              {82,98},{82,134},{79,134}}, color={0,0,127}));
      connect(product7.y, integrator3.u)
        annotation (Line(points={{-153,-126},{-144,-126}}, color={0,0,127}));
      connect(limiter7.y, product7.u2) annotation (Line(points={{-187,-126},{-180,-126},
              {-180,-132},{-176,-132}}, color={0,0,127}));
      connect(frzState2.y, product7.u1) annotation (Line(points={{-185,-96},{-182,-96},
              {-182,-120},{-176,-120}}, color={0,0,127}));
      connect(VReF0.y, VFlag.u3)
        annotation (Line(points={{-27,50},{-6,50},{-6,126}}, color={0,0,127}));
      connect(SOC.y, add1.u2) annotation (Line(points={{-179,-250},{-128,-250},{-128,
              -240},{-106,-240}}, color={0,0,127}));
      connect(gain.y,add3. u1)
        annotation (Line(points={{-73,140},{-68,140}},
                                                     color={0,0,127}));
      connect(integrator.y,add3. u2)
        annotation (Line(points={{-75,100},{-68,100},{-68,128}},
                                                            color={0,0,127}));
      connect(product1.y, integrator.u)
        annotation (Line(points={{-103,100},{-98,100}}, color={0,0,127}));
      connect(gain.u, product1.y) annotation (Line(points={{-96,140},{-100,140},
              {-100,120},{-103,120},{-103,100}}, color={0,0,127}));
      connect(add3.y, limiter3.u)
        annotation (Line(points={{-45,134},{-42,134}}, color={0,0,127}));
      connect(gain1.y,add4. u1) annotation (Line(points={{121,136},{126,136}},
                    color={0,0,127}));
      connect(integrator2.y,add4. u2) annotation (Line(points={{121,102},{121,
              112},{126,112},{126,124}},
                    color={0,0,127}));
      connect(product4.y, integrator2.u) annotation (Line(points={{73,80},{92,
              80},{92,102},{98,102}}, color={0,0,127}));
      connect(gain1.u, product4.y) annotation (Line(points={{98,136},{88,136},{
              88,80},{73,80}}, color={0,0,127}));
      connect(add4.y, variableLimiter1.u)
        annotation (Line(points={{149,130},{156,130}}, color={0,0,127}));
      annotation (Documentation(info="<html>
<p>
The REECCU1 component is an augmented version of the existing renewable energy electrical control (REECA1) model, and can be utilized to represent
both type 3 and type 4 wind turbine electrical controllers as well as photovoltaic electrical controllers. The REECCU1 component can be connected to the
plant controller (REPCA1). This electrical controller provides real (Ipcmd) and reactive (Iqcmd) current commands to the REGCA1 component, which are the outputs
of this component.
</p>
<p>
For initialization purposes, there are 5 inputs that are derived from the inverter component: initial real and reactive injection currents (IP0 and IQ0), initial terminal voltage (v_0), and initial active and reactive power
injections (p_0 and q_0).
</p>
<p>
In terms of connectivity with other components to form the renewable source, the REECCU1 component has six inputs, three of which are connected to the inverter component
(for instance REGCA1), two more that can either be constant values from the power flow initialization or come from the connection to the plant controller, and
an auxiliary input variable that is rarely used (usually constant and zero). The three REECCU1 inputs that take in values from the output of the inverter model
are Vt, Pgen, and Qgen while the two inputs that could potentially be constant valued or come from the plant controller are Pref, and Qext.
</p>
<p>The modelling of such devices is based, mainly, on the following references:</p>
<ul>
<li>Siemens: \"PSS&reg;E Model Library\"
<a href=\"modelica://OpenIPSL.UsersGuide.References\">[PSSE-MODELS]</a>,</li>
<li>WECC: \"Battery Storage Dynamic Modeling Guideline\"
<a href=\"modelica://OpenIPSL.UsersGuide.References\">[WECCBattery]</a>.</li>
</ul>

</html>"));
    end REECCU1;

    model REECB1 "Electrical control model for large scale photovoltaic"
      extends
        OpenIPSL.Electrical.Renewables.PSSE.ElectricalController.BaseClasses.BaseREECB(
         Iqcmd, Ipcmd);

      parameter OpenIPSL.Types.PerUnit Vdip = -99 "Low voltage threshold to activate reactive current injection logic (0.85 - 0.9)";
      parameter OpenIPSL.Types.PerUnit Vup = 99 "Voltage above which reactive current injection logic is activated (>1.1)";
      parameter OpenIPSL.Types.Time Trv = 0 "Filter time constant for voltage measurement (0.01 - 0.02)";
      parameter OpenIPSL.Types.PerUnit dbd1 = -0.05 "Voltage error dead band lower threshold (-0.1 - 0)";
      parameter OpenIPSL.Types.PerUnit dbd2 = 0.05 "Voltage error dead band upper threshold (0 - 0.1)";
      parameter Real Kqv = 0 "Reactive current injection gain during over and undervoltage conditions (0 - 10)";
      parameter OpenIPSL.Types.PerUnit Iqh1 = 1.05 "Upper limit on reactive current injection Iqinj (1 - 1.1)";
      parameter OpenIPSL.Types.PerUnit Iql1 = -1.05 "Lower limit on reactive current injection Iqinj (-1.1 - 1)";
      parameter OpenIPSL.Types.PerUnit vref0 = 1 "User defined voltage reference (0.95 - 1.05)";
      parameter OpenIPSL.Types.Time Tp = 0.05 "Filter time constant for electrical power (0.01 - 0.1)";
      parameter OpenIPSL.Types.PerUnit Qmax = 0.4360 "Upper limits of the limit for reactive power regulator (0.4 - 1.0)";
      parameter OpenIPSL.Types.PerUnit Qmin = -0.4360 "Lower limits of the limit for reactive power regulator (-1.0 - -0.4)";
      parameter OpenIPSL.Types.PerUnit Vmax = 1.1 "Maximum limit for voltage control (1.05 - 1.1)";
      parameter OpenIPSL.Types.PerUnit Vmin = 0.9 "Lower limits of input signals (0.9 - 0.95)";
      parameter Real Kqp = 0 "Reactive power regulator proportional gain (No predefined range)";
      parameter Real Kqi = 0.1 "Reactive power regulator integral gain (No predefined range)";
      parameter Real Kvp = 0 "Voltage regulator proportional gain (No predefined range)";
      parameter Real Kvi = 40 "Voltage regulator integral gain (No predefined range)";
      parameter OpenIPSL.Types.Time Tiq = 0.02 "Time constant on lag delay (0.01 - 0.02)";
      parameter Real dPmax = 99 "Power reference maximum ramp rate (No predefined range)";
      parameter Real dPmin = -99 "Lower limits of input signals (No predefined range)";
      parameter OpenIPSL.Types.PerUnit Pmax = 1 "Maximum power limit";
      parameter OpenIPSL.Types.PerUnit Pmin = 0 "Minimum power limit";
      parameter OpenIPSL.Types.PerUnit Imax = 1.82 "Maximum limit on total converter current (1.1 - 1.3)";
      parameter OpenIPSL.Types.Time Tpord = 0.02 "Power filter time constant (0.01 - 0.02) ";

      Integer Voltage_dip;

      Modelica.Blocks.Sources.BooleanConstant PfFlag_logic(k=pfflag)
        annotation (Placement(transformation(extent={{-236,20},{-216,40}})));
      Modelica.Blocks.Logical.Switch PfFlag
        "Constant Q (False) or PF (True) local control."
        annotation (Placement(transformation(extent={{-196,56},{-176,76}})));
      Modelica.Blocks.Nonlinear.Limiter limiter1(uMax=Qmax, uMin=Qmin)
        annotation (Placement(transformation(extent={{-162,56},{-142,76}})));
      Modelica.Blocks.Math.Add add1(k2=-1)
        annotation (Placement(transformation(extent={{-132,50},{-112,70}})));
      Modelica.Blocks.Continuous.Integrator integrator(
        k=Kqi,
        initType=Modelica.Blocks.Types.Init.InitialState,
        y_start=V0)
        annotation (Placement(transformation(extent={{-94,10},{-74,30}})));
      Modelica.Blocks.Math.Gain gain(k=Kqp)
        annotation (Placement(transformation(extent={{-92,50},{-72,70}})));
      Modelica.Blocks.Math.Add add2
        annotation (Placement(transformation(extent={{-66,44},{-46,64}})));
      Modelica.Blocks.Sources.RealExpression frzState(y=if Voltage_dip == 1 then 0
             else 1) annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={-112,2})));
      Modelica.Blocks.Math.Product product2
        annotation (Placement(transformation(extent={{-122,10},{-102,30}})));
      Modelica.Blocks.Nonlinear.Limiter limiter2(uMax=Vmax, uMin=Vmin)
        annotation (Placement(transformation(extent={{-38,44},{-18,64}})));
      Modelica.Blocks.Sources.BooleanConstant Vflag_logic(k=vflag)
        annotation (Placement(transformation(extent={{-58,-10},{-38,10}})));
      Modelica.Blocks.Logical.Switch VFlag
        "Constant Q (False) or PF (True) local control."
        annotation (Placement(transformation(extent={{-2,44},{18,64}})));
      Modelica.Blocks.Nonlinear.Limiter limiter3(uMax=Vmax, uMin=Vmin)
        annotation (Placement(transformation(extent={{28,44},{48,64}})));
      Modelica.Blocks.Math.Add add4(k2=-1)
        annotation (Placement(transformation(extent={{60,44},{80,64}})));
      Modelica.Blocks.Sources.RealExpression Vt_filt2(y=simpleLag.y)
        annotation (Placement(transformation(extent={{80,44},{60,24}})));
      Modelica.Blocks.Math.Gain gain1(k=Kvp)
        annotation (Placement(transformation(extent={{100,44},{120,64}})));
      Modelica.Blocks.Continuous.Integrator integrator1(
        k=Kvi,
        initType=Modelica.Blocks.Types.Init.InitialState,
        y_start=-Iq0 - (-V0 + Vref0)*Kqv)
        annotation (Placement(transformation(extent={{100,10},{120,30}})));
      Modelica.Blocks.Math.Add add5
        annotation (Placement(transformation(extent={{128,38},{148,58}})));
      Modelica.Blocks.Math.Product product3
        annotation (Placement(transformation(extent={{54,-10},{74,10}})));
      Modelica.Blocks.Sources.RealExpression frzState1(y=if Voltage_dip == 1 then 0
             else 1) annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            origin={30,-6})));
      Modelica.Blocks.Nonlinear.VariableLimiter variableLimiter2
        annotation (Placement(transformation(extent={{162,38},{182,58}})));
      Modelica.Blocks.Sources.RealExpression IQMAX_(y=ccl.Iqmax) annotation (
          Placement(transformation(
            extent={{-10,10},{10,-10}},
            rotation=180,
            origin={172,74})));
      Modelica.Blocks.Sources.RealExpression IQMIN_(y=ccl.Iqmin) annotation (
          Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={172,24})));
      Modelica.Blocks.Logical.Switch QFlag
        annotation (Placement(transformation(extent={{200,4},{220,24}})));
      Modelica.Blocks.Sources.BooleanConstant QFLAG(k=qflag)
        annotation (Placement(transformation(extent={{160,-14},{180,6}})));
      Modelica.Blocks.Math.Add add6(k2=+1)
        annotation (Placement(transformation(extent={{230,70},{250,90}})));
      Modelica.Blocks.Nonlinear.VariableLimiter variableLimiter
        annotation (Placement(transformation(extent={{264,70},{284,90}})));
      Modelica.Blocks.Sources.RealExpression IQMIN(y=ccl.Iqmin)
        annotation (Placement(transformation(extent={{284,70},{264,50}})));
      Modelica.Blocks.Sources.RealExpression IQMAX(y=ccl.Iqmax)
        annotation (Placement(transformation(extent={{284,94},{264,114}})));
      Modelica.Blocks.Math.Add add7(k2=-1)
        annotation (Placement(transformation(extent={{54,-86},{74,-66}})));
      Modelica.Blocks.Continuous.Integrator integrator2(k=1/Tiq, y_start=-Iq0 - (-
            V0 + Vref0)*Kqv)
        annotation (Placement(transformation(extent={{134,-80},{154,-60}})));
      Modelica.Blocks.Math.Product product4
        annotation (Placement(transformation(extent={{98,-80},{118,-60}})));
      Modelica.Blocks.Sources.RealExpression Vt_filt1(y=simpleLag.y)
        annotation (Placement(transformation(extent={{-66,-100},{-46,-80}})));
      Modelica.Blocks.Nonlinear.Limiter limiter4(uMax=Modelica.Constants.inf, uMin=0.01)
        annotation (Placement(transformation(extent={{-26,-100},{-6,-80}})));
      Modelica.Blocks.Math.Division division
        annotation (Placement(transformation(extent={{14,-80},{34,-60}})));
      Modelica.Blocks.Nonlinear.VariableLimiter variableLimiter1
        annotation (Placement(transformation(extent={{54,-180},{74,-160}})));
      Modelica.Blocks.Sources.RealExpression IPMAX(y=ccl.Ipmax) annotation (
          Placement(transformation(
            extent={{10,-10},{-10,10}},
            origin={64,-140})));
      Modelica.Blocks.Sources.RealExpression IPMIN(y=ccl.Ipmin)
        annotation (Placement(transformation(extent={{74,-210},{54,-190}})));
      NonElectrical.Continuous.SimpleLag simpleLag(
        K=1,
        T=Trv,
        y_start=V0)
        annotation (Placement(transformation(extent={{-286,150},{-266,170}})));
      Modelica.Blocks.Math.Add add(k1=-1)
        annotation (Placement(transformation(extent={{-246,144},{-226,164}})));
      Modelica.Blocks.Nonlinear.Limiter limiter(uMax=Iqh1, uMin=Iql1)
        annotation (Placement(transformation(extent={{-126,144},{-106,164}})));
      Modelica.Blocks.Sources.RealExpression VREF0(y=Vref0)
        annotation (Placement(transformation(extent={{-286,120},{-266,140}})));
      Modelica.Blocks.Nonlinear.DeadZone dbd1_dbd2(uMax=dbd2, uMin=dbd1)
        annotation (Placement(transformation(extent={{-206,144},{-186,164}})));
      Modelica.Blocks.Math.Gain gain2(k=Kqv)
        annotation (Placement(transformation(extent={{-166,144},{-146,164}})));
      NonElectrical.Continuous.SimpleLag simpleLag1(
        K=1,
        T=Tp,
        y_start=p00)
        annotation (Placement(transformation(extent={{-266,70},{-246,90}})));
      Modelica.Blocks.Math.Tan tan1
        annotation (Placement(transformation(extent={{-252,56},{-244,48}})));
      Modelica.Blocks.Math.Product product1
        annotation (Placement(transformation(extent={{-236,64},{-216,84}})));
      Modelica.Blocks.Sources.RealExpression PFAREF(y=pfangle)
        annotation (Placement(transformation(extent={{10,-10},{-10,10}},
            rotation=180,
            origin={-290,30})));
      Modelica.Blocks.Math.Division division1
        annotation (Placement(transformation(extent={{-72,-180},{-52,-160}})));
      Modelica.Blocks.Nonlinear.Limiter limiter5(uMax=Modelica.Constants.inf, uMin=0.01)
        annotation (Placement(transformation(extent={{-132,-220},{-112,-200}})));
      Modelica.Blocks.Math.Add add8(k2=-1)
        annotation (Placement(transformation(extent={{-276,-176},{-256,-156}})));
      Modelica.Blocks.Nonlinear.Limiter limiter7(uMax=dPmax, uMin=dPmin)
        annotation (Placement(transformation(extent={{-240,-176},{-220,-156}})));
      Modelica.Blocks.Continuous.Integrator integrator3(k=1/Tpord, y_start=Ip0*V0)
        annotation (Placement(transformation(extent={{-152,-176},{-132,-156}})));
      Modelica.Blocks.Nonlinear.Limiter limiter8(uMax=Pmax, uMin=Pmin)
        annotation (Placement(transformation(extent={{-112,-176},{-92,-156}})));
      Modelica.Blocks.Sources.RealExpression Vt_filt3(y=simpleLag.y)
        annotation (Placement(transformation(extent={{-198,-220},{-178,-200}})));
      OpenIPSL.Electrical.Renewables.PSSE.ElectricalController.BaseClasses.CurrentLimitLogicREECB
        ccl(
        start_ii=-Iq0,
        start_ir=Ip0,
        Imax=Imax)
        annotation (Placement(transformation(extent={{260,-40},{280,-20}})));
      Modelica.Blocks.Sources.BooleanConstant Pqflag_logic(k=pqflag)
        annotation (Placement(transformation(extent={{220,-40},{240,-20}})));

      Modelica.Blocks.Sources.RealExpression frzState2(y=if Voltage_dip == 1 then 0
             else 1) annotation (Placement(transformation(
            extent={{-10,10},{10,-10}},
            origin={-230,-130})));
      Modelica.Blocks.Math.Product product6
        annotation (Placement(transformation(extent={{-190,-176},{-170,-156}})));
      Modelica.Blocks.Sources.RealExpression VReF0(y=Vref0) annotation (Placement(
            transformation(
            extent={{-10,10},{10,-10}},
            origin={-44,-32})));
    protected
      parameter Real pfaref = p00/sqrt(p00^2 +q00^2) "Power Factor of choice.";
      parameter OpenIPSL.Types.Angle pfangle = if q00 > 0 then acos(pfaref) else -acos(pfaref);
      parameter OpenIPSL.Types.PerUnit Ip0(fixed=false);
      parameter OpenIPSL.Types.PerUnit Iq0(fixed=false);
      parameter OpenIPSL.Types.PerUnit V0(fixed=false);
      parameter OpenIPSL.Types.PerUnit p00(fixed=false);
      parameter OpenIPSL.Types.PerUnit q00(fixed=false);
      parameter OpenIPSL.Types.PerUnit Vref0 = if vref0 == 0 then V0 else vref0;

    initial equation

      Ip0 = ip0;
      Iq0 = iq0;
      V0 = v0;
      p00 = p0;
      q00 = q0;

    equation

      Voltage_dip = if Vt<Vdip or Vt>Vup then 1 else 0;
      connect(simpleLag.y,add. u1) annotation (Line(points={{-265,160},{-248,160}},
                                color={0,0,127}));
      connect(VREF0.y,add. u2) annotation (Line(points={{-265,130},{-252,130},{-252,
              148},{-248,148}},color={0,0,127}));
      connect(dbd1_dbd2.y,gain2. u)
        annotation (Line(points={{-185,154},{-168,154}}, color={0,0,127}));
      connect(add.y,dbd1_dbd2. u)
        annotation (Line(points={{-225,154},{-208,154}}, color={0,0,127}));
      connect(gain2.y,limiter. u)
        annotation (Line(points={{-145,154},{-128,154}},
                                                     color={0,0,127}));
      connect(simpleLag1.y,product1. u1)
        annotation (Line(points={{-245,80},{-238,80}}, color={0,0,127}));
      connect(tan1.y,product1. u2) annotation (Line(points={{-243.6,52},{-238,
              52},{-238,68}},
                    color={0,0,127}));
      connect(Pe,simpleLag1. u)
        annotation (Line(points={{-320,80},{-268,80}}, color={0,0,127}));
      connect(product1.y,PfFlag. u1)
        annotation (Line(points={{-215,74},{-198,74}}, color={0,0,127}));
      connect(PfFlag_logic.y,PfFlag. u2) annotation (Line(points={{-215,30},{-206,30},
              {-206,66},{-198,66}}, color={255,0,255}));
      connect(PfFlag.y,limiter1. u)
        annotation (Line(points={{-175,66},{-164,66}}, color={0,0,127}));
      connect(limiter1.y,add1. u1)
        annotation (Line(points={{-141,66},{-134,66}}, color={0,0,127}));
      connect(Qgen,add1. u2) annotation (Line(points={{-320,0},{-134,0},{-134,54}},
            color={0,0,127}));
      connect(gain.y,add2. u1)
        annotation (Line(points={{-71,60},{-68,60}}, color={0,0,127}));
      connect(integrator.y,add2. u2)
        annotation (Line(points={{-73,20},{-70,20},{-70,48},{-68,48}},
                                                            color={0,0,127}));
      connect(product2.y,integrator. u)
        annotation (Line(points={{-101,20},{-96,20}},color={0,0,127}));
      connect(frzState.y,product2. u2) annotation (Line(points={{-123,2},{-128,2},{-128,
              14},{-124,14}}, color={0,0,127}));
      connect(add2.y,limiter2. u)
        annotation (Line(points={{-45,54},{-40,54}}, color={0,0,127}));
      connect(limiter2.y,VFlag. u1) annotation (Line(points={{-17,54},{-16,54},{-16,
              62},{-4,62}}, color={0,0,127}));
      connect(Vflag_logic.y,VFlag. u2) annotation (Line(points={{-37,0},{-14,0},{-14,
              54},{-4,54}}, color={255,0,255}));
      connect(limiter3.y,add4. u1) annotation (Line(points={{49,54},{54,54},{54,60},
              {58,60}}, color={0,0,127}));
      connect(Vt_filt2.y,add4. u2) annotation (Line(points={{59,34},{54,34},{54,48},
              {58,48}}, color={0,0,127}));
      connect(VFlag.y,limiter3. u)
        annotation (Line(points={{19,54},{26,54}}, color={0,0,127}));
      connect(gain1.y,add5. u1) annotation (Line(points={{121,54},{126,54}},
                    color={0,0,127}));
      connect(integrator1.y,add5. u2) annotation (Line(points={{121,20},{126,20},{126,
              42}}, color={0,0,127}));
      connect(frzState1.y,product3. u2) annotation (Line(points={{41,-6},{52,-6}},
                            color={0,0,127}));
      connect(product3.y,integrator1. u) annotation (Line(points={{75,0},{90,0},{90,
              20},{98,20}}, color={0,0,127}));
      connect(add5.y,variableLimiter2. u)
        annotation (Line(points={{149,48},{160,48}}, color={0,0,127}));
      connect(IQMAX_.y,variableLimiter2. limit1) annotation (Line(points={{161,74},{
              154,74},{154,56},{160,56}}, color={0,0,127}));
      connect(variableLimiter2.y,QFlag. u1)
        annotation (Line(points={{183,48},{198,48},{198,22}}, color={0,0,127}));
      connect(QFLAG.y,QFlag. u2) annotation (Line(points={{181,-4},{186,-4},{186,14},
              {198,14}}, color={255,0,255}));
      connect(IQMIN_.y,variableLimiter2. limit2) annotation (Line(points={{161,24},{
              154,24},{154,40},{160,40}}, color={0,0,127}));
      connect(add6.y,variableLimiter. u)
        annotation (Line(points={{251,80},{262,80}}, color={0,0,127}));
      connect(IQMIN.y,variableLimiter. limit2) annotation (Line(points={{263,60},{256,
              60},{256,72},{262,72}}, color={0,0,127}));
      connect(IQMAX.y,variableLimiter. limit1) annotation (Line(points={{263,104},{256,
              104},{256,88},{262,88}}, color={0,0,127}));
      connect(QFlag.y,add6. u2) annotation (Line(points={{221,14},{228,14},{228,74}},
                         color={0,0,127}));
      connect(add7.y,product4. u2)
        annotation (Line(points={{75,-76},{96,-76}}, color={0,0,127}));
      connect(Vt_filt1.y,limiter4. u)
        annotation (Line(points={{-45,-90},{-28,-90}}, color={0,0,127}));
      connect(limiter4.y,division. u2) annotation (Line(points={{-5,-90},{2,-90},{2,
              -76},{12,-76}},
                         color={0,0,127}));
      connect(division.u1,limiter1. u) annotation (Line(points={{12,-64},{-170,-64},
              {-170,66},{-164,66}},
                                color={0,0,127}));
      connect(division.y,add7. u1)
        annotation (Line(points={{35,-70},{52,-70}}, color={0,0,127}));
      connect(integrator2.y,QFlag. u3) annotation (Line(points={{155,-70},{190,-70},
              {190,6},{198,6}}, color={0,0,127}));
      connect(add7.u2,QFlag. u3) annotation (Line(points={{52,-82},{42,-82},{42,-92},
              {190,-92},{190,6},{198,6}}, color={0,0,127}));
      connect(product4.y,integrator2. u)
        annotation (Line(points={{119,-70},{132,-70}}, color={0,0,127}));
      connect(product4.u1,product3. u2) annotation (Line(points={{96,-64},{84,-64},{
              84,-34},{46,-34},{46,-6},{52,-6}},
                                            color={0,0,127}));
      connect(IPMIN.y,variableLimiter1. limit2) annotation (Line(points={{53,-200},{
              34,-200},{34,-178},{52,-178}}, color={0,0,127}));
      connect(IPMAX.y,variableLimiter1. limit1) annotation (Line(points={{53,-140},{
              34,-140},{34,-162},{52,-162}}, color={0,0,127}));
      connect(variableLimiter1.y, Ipcmd) annotation (Line(points={{75,-170},{254,-170},{254,-170},{310,-170}},
                                    color={0,0,127}));
      connect(Vt, simpleLag.u)
        annotation (Line(points={{-320,160},{-288,160}}, color={0,0,127}));
      connect(limiter.y, add6.u1)
        annotation (Line(points={{-105,154},{228,154},{228,86}}, color={0,0,127}));
      connect(limiter5.y,division1. u2) annotation (Line(points={{-111,-210},{-86,-210},
              {-86,-176},{-74,-176}}, color={0,0,127}));
      connect(add8.y,limiter7. u)
        annotation (Line(points={{-255,-166},{-242,-166}},
                                                         color={0,0,127}));
      connect(integrator3.y,limiter8. u)
        annotation (Line(points={{-131,-166},{-114,-166}},
                                                         color={0,0,127}));
      connect(add8.u2,limiter8. u) annotation (Line(points={{-278,-172},{-278,-188},
              {-124,-188},{-124,-166},{-114,-166}}, color={0,0,127}));
      connect(limiter8.y,division1. u1) annotation (Line(points={{-91,-166},{-82,-166},
              {-82,-164},{-74,-164}}, color={0,0,127}));
      connect(Vt_filt3.y,limiter5. u)
        annotation (Line(points={{-177,-210},{-134,-210}},
                                                      color={0,0,127}));
      connect(add8.u1, Pref)
        annotation (Line(points={{-278,-160},{-320,-160}}, color={0,0,127}));
      connect(division1.y, variableLimiter1.u)
        annotation (Line(points={{-51,-170},{52,-170}}, color={0,0,127}));
      connect(variableLimiter.y, Iqcmd)
        annotation (Line(points={{285,80},{292,80},{292,170},{310,170}},
                                                     color={0,0,127}));
      connect(Pqflag_logic.y, ccl.Pqflag)
        annotation (Line(points={{241,-30},{258,-30}}, color={255,0,255}));
      connect(ccl.Iqcmd, Iqcmd) annotation (Line(points={{282,-25},{292,-25},{292,170},{310,170}},
                         color={0,0,127}));
      connect(ccl.Ipcmd, Ipcmd) annotation (Line(points={{282,-35},{292,-35},{292,-170},{310,-170}},
                          color={0,0,127}));
      connect(product2.u1, add1.y) annotation (Line(points={{-124,26},{-128,26},{-128,
              40},{-111,40},{-111,60}}, color={0,0,127}));
      connect(gain.u, integrator.u) annotation (Line(points={{-94,60},{-98,60},{-98,
              20},{-96,20}}, color={0,0,127}));
      connect(product3.u1, add4.y) annotation (Line(points={{52,6},{50,6},{50,8},{46,
              8},{46,20},{84,20},{84,54},{81,54}}, color={0,0,127}));
      connect(gain1.u, integrator1.u) annotation (Line(points={{98,54},{90,54},{90,20},
              {98,20}}, color={0,0,127}));
      connect(frzState2.y, product6.u1) annotation (Line(points={{-219,-130},{-204,-130},
              {-204,-160},{-192,-160}}, color={0,0,127}));
      connect(limiter7.y, product6.u2) annotation (Line(points={{-219,-166},{-212,-166},
              {-212,-172},{-192,-172}}, color={0,0,127}));
      connect(product6.y, integrator3.u)
        annotation (Line(points={{-169,-166},{-154,-166}}, color={0,0,127}));
      connect(VReF0.y, VFlag.u3)
        annotation (Line(points={{-33,-32},{-4,-32},{-4,46}}, color={0,0,127}));
      connect(PFAREF.y, tan1.u) annotation (Line(points={{-279,30},{-266,30},{
              -266,52},{-252.8,52}}, color={0,0,127}));
      connect(Qext, PfFlag.u3) annotation (Line(points={{-320,-80},{-198,-80},{
              -198,58}}, color={0,0,127}));
      annotation (Documentation(info="<html>
<p>
The REECB1 component used to represent the electrical controls of photovoltaic generation. The electrical controller actuates on the active and reactive power
reference from either the plant controller component or from power flow power reference values (in the case where there is no plant controller),
with feedback variables that original from the inverter interface component, specifically terminal voltage and generator power output,
and provides real (Ipcmd) and reactive current (Iqcmd) commands to the REGC types module.
</p>
<p>
For initialization purposes, there are 5 inputs that are derived from the inverter component: initial real and reactive injection currents (IP0 and IQ0), initial terminal voltage (v_0), and initial active and reactive power
injections (p_0 and q_0).
</p>
<p>
In terms of connectivity with other components to form the renewable source, the REECB1 component has five inputs, three of which are connected to the inverter component
(for instance REGCA1), and two more that can either be constant values from the power flow initialization or come from the connection to the plant controller.
The three REECB1 inputs that take in values from the output of the inverter model
are Vt, Pgen, and Qgen while the two inputs that could potentially be constant valued or come from the plant controller are Pref, and Qext.
</p>
<p>The modelling of such devices is based, mainly, on the following references:</p>
<ul>
<li>Siemens: \"PSS&reg;E Model Library\"
<a href=\"modelica://OpenIPSL.UsersGuide.References\">[PSSE-MODELS]</a>,</li>
<li>WECC: \"Solar Photovoltaic Power Plant Modeling and Validation Guideline\"
<a href=\"modelica://OpenIPSL.UsersGuide.References\">[WECCPhotovoltaic]</a>.</li>
</ul>
</html>"), Icon(graphics={
            Text(
              extent={{-276,282},{-146,240}},
              textColor={0,0,255},
              textString="PFinput")}));
    end REECB1;

    model REECB_Constant_Q_Control
      "Electrical control model for large scale photovoltaic"
      extends
        OpenIPSL.Electrical.Renewables.PSSE.ElectricalController.BaseClasses.BaseREECB(
         Iqcmd, Ipcmd);

      parameter OpenIPSL.Types.PerUnit Vdip = -99 "Low voltage threshold to activate reactive current injection logic (0.85 - 0.9)";
      parameter OpenIPSL.Types.PerUnit Vup = 99 "Voltage above which reactive current injection logic is activated (>1.1)";
      parameter OpenIPSL.Types.Time Trv = 0 "Filter time constant for voltage measurement (0.01 - 0.02)";
      parameter OpenIPSL.Types.PerUnit dbd1 = -0.05 "Voltage error dead band lower threshold (-0.1 - 0)";
      parameter OpenIPSL.Types.PerUnit dbd2 = 0.05 "Voltage error dead band upper threshold (0 - 0.1)";
      parameter Real Kqv = 0 "Reactive current injection gain during over and undervoltage conditions (0 - 10)";
      parameter OpenIPSL.Types.PerUnit Iqh1 = 1.05 "Upper limit on reactive current injection Iqinj (1 - 1.1)";
      parameter OpenIPSL.Types.PerUnit Iql1 = -1.05 "Lower limit on reactive current injection Iqinj (-1.1 - 1)";
      parameter OpenIPSL.Types.PerUnit vref0 = 1 "User defined voltage reference (0.95 - 1.05)";
      parameter OpenIPSL.Types.Time Tp = 0.05 "Filter time constant for electrical power (0.01 - 0.1)";
      parameter OpenIPSL.Types.PerUnit Qmax = 0.4360 "Upper limits of the limit for reactive power regulator (0.4 - 1.0)";
      parameter OpenIPSL.Types.PerUnit Qmin = -0.4360 "Lower limits of the limit for reactive power regulator (-1.0 - -0.4)";
      parameter OpenIPSL.Types.PerUnit Vmax = 1.1 "Maximum limit for voltage control (1.05 - 1.1)";
      parameter OpenIPSL.Types.PerUnit Vmin = 0.9 "Lower limits of input signals (0.9 - 0.95)";
      parameter Real Kqp = 0 "Reactive power regulator proportional gain (No predefined range)";
      parameter Real Kqi = 0.1 "Reactive power regulator integral gain (No predefined range)";
      parameter Real Kvp = 0 "Voltage regulator proportional gain (No predefined range)";
      parameter Real Kvi = 40 "Voltage regulator integral gain (No predefined range)";
      parameter OpenIPSL.Types.Time Tiq = 0.02 "Time constant on lag delay (0.01 - 0.02)";
      parameter Real dPmax = 99 "Power reference maximum ramp rate (No predefined range)";
      parameter Real dPmin = -99 "Lower limits of input signals (No predefined range)";
      parameter OpenIPSL.Types.PerUnit Pmax = 1 "Maximum power limit";
      parameter OpenIPSL.Types.PerUnit Pmin = 0 "Minimum power limit";
      parameter OpenIPSL.Types.PerUnit Imax = 1.82 "Maximum limit on total converter current (1.1 - 1.3)";
      parameter OpenIPSL.Types.Time Tpord = 0.02 "Power filter time constant (0.01 - 0.02) ";

      Integer Voltage_dip;

      Modelica.Blocks.Nonlinear.VariableLimiter variableLimiter
        annotation (Placement(transformation(extent={{264,70},{284,90}})));
      Modelica.Blocks.Sources.RealExpression IQMIN(y=ccl.Iqmin)
        annotation (Placement(transformation(extent={{284,70},{264,50}})));
      Modelica.Blocks.Sources.RealExpression IQMAX(y=ccl.Iqmax)
        annotation (Placement(transformation(extent={{284,94},{264,114}})));
      Modelica.Blocks.Nonlinear.Limiter limiter4(uMax=Modelica.Constants.inf, uMin=0.01)
        annotation (Placement(transformation(extent={{-26,-100},{-6,-80}})));
      Modelica.Blocks.Math.Division division
        annotation (Placement(transformation(extent={{14,-80},{34,-60}})));
      Modelica.Blocks.Nonlinear.VariableLimiter variableLimiter1
        annotation (Placement(transformation(extent={{54,-180},{74,-160}})));
      Modelica.Blocks.Sources.RealExpression IPMAX(y=ccl.Ipmax) annotation (
          Placement(transformation(
            extent={{10,-10},{-10,10}},
            origin={64,-140})));
      Modelica.Blocks.Sources.RealExpression IPMIN(y=ccl.Ipmin)
        annotation (Placement(transformation(extent={{74,-210},{54,-190}})));
      NonElectrical.Continuous.SimpleLag simpleLag(
        K=1,
        T=Trv,
        y_start=V0)
        annotation (Placement(transformation(extent={{-286,150},{-266,170}})));
      Modelica.Blocks.Math.Division division1
        annotation (Placement(transformation(extent={{-72,-180},{-52,-160}})));
      Modelica.Blocks.Math.Add add8(k2=-1)
        annotation (Placement(transformation(extent={{-276,-176},{-256,-156}})));
      Modelica.Blocks.Nonlinear.Limiter limiter7(uMax=dPmax, uMin=dPmin)
        annotation (Placement(transformation(extent={{-240,-176},{-220,-156}})));
      Modelica.Blocks.Continuous.Integrator integrator3(k=1/Tpord, y_start=Ip0*V0)
        annotation (Placement(transformation(extent={{-170,-176},{-150,-156}})));
      Modelica.Blocks.Nonlinear.Limiter limiter8(uMax=Pmax, uMin=Pmin)
        annotation (Placement(transformation(extent={{-112,-176},{-92,-156}})));
      OpenIPSL.Electrical.Renewables.PSSE.ElectricalController.BaseClasses.CurrentLimitLogicREECB
        ccl(
        start_ii=-Iq0,
        start_ir=Ip0,
        Imax=Imax)
        annotation (Placement(transformation(extent={{260,-40},{280,-20}})));
      Modelica.Blocks.Sources.BooleanConstant Pqflag_logic(k=pqflag)
        annotation (Placement(transformation(extent={{220,-40},{240,-20}})));

      NonElectrical.Continuous.SimpleLag simpleLag1(
        K=1,
        T=Trv,
        y_start=q00)
        annotation (Placement(transformation(extent={{-220,-90},{-200,-70}})));
      NonElectrical.Continuous.SimpleLag simpleLag2(
        K=1,
        T=Tiq,
        y_start=-Iq0 - (-V0 + Vref0)*Kqv)
        annotation (Placement(transformation(extent={{60,-80},{80,-60}})));
    protected
      parameter Real pfaref = p00/sqrt(p00^2 +q00^2) "Power Factor of choice.";
      parameter OpenIPSL.Types.Angle pfangle = if q00 > 0 then acos(pfaref) else -acos(pfaref);
      parameter OpenIPSL.Types.PerUnit Ip0(fixed=false);
      parameter OpenIPSL.Types.PerUnit Iq0(fixed=false);
      parameter OpenIPSL.Types.PerUnit V0(fixed=false);
      parameter OpenIPSL.Types.PerUnit p00(fixed=false);
      parameter OpenIPSL.Types.PerUnit q00(fixed=false);
      parameter OpenIPSL.Types.PerUnit Vref0 = if vref0 == 0 then V0 else vref0;

    initial equation

      Ip0 = ip0;
      Iq0 = iq0;
      V0 = v0;
      p00 = p0;
      q00 = q0;

    equation

      Voltage_dip = if Vt<Vdip or Vt>Vup then 1 else 0;
      connect(IQMIN.y,variableLimiter. limit2) annotation (Line(points={{263,60},{256,
              60},{256,72},{262,72}}, color={0,0,127}));
      connect(IQMAX.y,variableLimiter. limit1) annotation (Line(points={{263,104},{256,
              104},{256,88},{262,88}}, color={0,0,127}));
      connect(limiter4.y,division. u2) annotation (Line(points={{-5,-90},{2,-90},{2,
              -76},{12,-76}},
                         color={0,0,127}));
      connect(IPMIN.y,variableLimiter1. limit2) annotation (Line(points={{53,-200},{
              34,-200},{34,-178},{52,-178}}, color={0,0,127}));
      connect(IPMAX.y,variableLimiter1. limit1) annotation (Line(points={{53,-140},{
              34,-140},{34,-162},{52,-162}}, color={0,0,127}));
      connect(variableLimiter1.y, Ipcmd) annotation (Line(points={{75,-170},{254,-170},{254,-170},{310,-170}},
                                    color={0,0,127}));
      connect(Vt, simpleLag.u)
        annotation (Line(points={{-320,160},{-288,160}}, color={0,0,127}));
      connect(add8.y,limiter7. u)
        annotation (Line(points={{-255,-166},{-242,-166}},
                                                         color={0,0,127}));
      connect(integrator3.y,limiter8. u)
        annotation (Line(points={{-149,-166},{-114,-166}},
                                                         color={0,0,127}));
      connect(add8.u2,limiter8. u) annotation (Line(points={{-278,-172},{-278,-188},
              {-124,-188},{-124,-166},{-114,-166}}, color={0,0,127}));
      connect(limiter8.y,division1. u1) annotation (Line(points={{-91,-166},{-82,-166},
              {-82,-164},{-74,-164}}, color={0,0,127}));
      connect(add8.u1, Pref)
        annotation (Line(points={{-278,-160},{-320,-160}}, color={0,0,127}));
      connect(division1.y, variableLimiter1.u)
        annotation (Line(points={{-51,-170},{52,-170}}, color={0,0,127}));
      connect(variableLimiter.y, Iqcmd)
        annotation (Line(points={{285,80},{292,80},{292,170},{310,170}},
                                                     color={0,0,127}));
      connect(Pqflag_logic.y, ccl.Pqflag)
        annotation (Line(points={{241,-30},{258,-30}}, color={255,0,255}));
      connect(ccl.Iqcmd, Iqcmd) annotation (Line(points={{282,-25},{292,-25},{292,170},{310,170}},
                         color={0,0,127}));
      connect(ccl.Ipcmd, Ipcmd) annotation (Line(points={{282,-35},{292,-35},{292,-170},{310,-170}},
                          color={0,0,127}));
      connect(Qext, simpleLag1.u)
        annotation (Line(points={{-320,-80},{-222,-80}}, color={0,0,127}));
      connect(simpleLag1.y, division.u1) annotation (Line(points={{-199,-80},{
              -106,-80},{-106,-64},{12,-64}}, color={0,0,127}));
      connect(simpleLag.y, limiter4.u) annotation (Line(points={{-265,160},{
              -178,160},{-178,158},{-60,158},{-60,-88},{-28,-88},{-28,-90}},
            color={0,0,127}));
      connect(division.y, simpleLag2.u)
        annotation (Line(points={{35,-70},{58,-70}}, color={0,0,127}));
      connect(simpleLag2.y, variableLimiter.u) annotation (Line(points={{81,-70},
              {180,-70},{180,80},{262,80}}, color={0,0,127}));
      connect(limiter7.y, integrator3.u)
        annotation (Line(points={{-219,-166},{-172,-166}}, color={0,0,127}));
      connect(division1.u2, division.u2) annotation (Line(points={{-74,-176},{
              -78,-176},{-78,-174},{-84,-174},{-84,-224},{2,-224},{2,-76},{12,
              -76}}, color={0,0,127}));
      annotation (Documentation(info="<html>
<p>
The REECB1 component used to represent the electrical controls of photovoltaic generation. The electrical controller actuates on the active and reactive power
reference from either the plant controller component or from power flow power reference values (in the case where there is no plant controller),
with feedback variables that original from the inverter interface component, specifically terminal voltage and generator power output,
and provides real (Ipcmd) and reactive current (Iqcmd) commands to the REGC types module.
</p>
<p>
For initialization purposes, there are 5 inputs that are derived from the inverter component: initial real and reactive injection currents (IP0 and IQ0), initial terminal voltage (v_0), and initial active and reactive power
injections (p_0 and q_0).
</p>
<p>
In terms of connectivity with other components to form the renewable source, the REECB1 component has five inputs, three of which are connected to the inverter component
(for instance REGCA1), and two more that can either be constant values from the power flow initialization or come from the connection to the plant controller.
The three REECB1 inputs that take in values from the output of the inverter model
are Vt, Pgen, and Qgen while the two inputs that could potentially be constant valued or come from the plant controller are Pref, and Qext.
</p>
<p>The modelling of such devices is based, mainly, on the following references:</p>
<ul>
<li>Siemens: \"PSS&reg;E Model Library\"
<a href=\"modelica://OpenIPSL.UsersGuide.References\">[PSSE-MODELS]</a>,</li>
<li>WECC: \"Solar Photovoltaic Power Plant Modeling and Validation Guideline\"
<a href=\"modelica://OpenIPSL.UsersGuide.References\">[WECCPhotovoltaic]</a>.</li>
</ul>
</html>"), Icon(graphics={
            Text(
              extent={{-276,282},{-146,240}},
              textColor={0,0,255},
              textString="PFinput")}));
    end REECB_Constant_Q_Control;

    model REECB1_Local_V_Control
      "Electrical control model for large scale photovoltaic"
      extends
        OpenIPSL.Electrical.Renewables.PSSE.ElectricalController.BaseClasses.BaseREECB(
         Iqcmd, Ipcmd);

      parameter OpenIPSL.Types.PerUnit Vdip = -99 "Low voltage threshold to activate reactive current injection logic (0.85 - 0.9)";
      parameter OpenIPSL.Types.PerUnit Vup = 99 "Voltage above which reactive current injection logic is activated (>1.1)";
      parameter OpenIPSL.Types.Time Trv = 0 "Filter time constant for voltage measurement (0.01 - 0.02)";
      parameter OpenIPSL.Types.PerUnit dbd1 = -0.05 "Voltage error dead band lower threshold (-0.1 - 0)";
      parameter OpenIPSL.Types.PerUnit dbd2 = 0.05 "Voltage error dead band upper threshold (0 - 0.1)";
      parameter Real Kqv = 0 "Reactive current injection gain during over and undervoltage conditions (0 - 10)";
      parameter OpenIPSL.Types.PerUnit Iqh1 = 1.05 "Upper limit on reactive current injection Iqinj (1 - 1.1)";
      parameter OpenIPSL.Types.PerUnit Iql1 = -1.05 "Lower limit on reactive current injection Iqinj (-1.1 - 1)";
      parameter OpenIPSL.Types.PerUnit vref0 = 1 "User defined voltage reference (0.95 - 1.05)";
      parameter OpenIPSL.Types.Time Tp = 0.05 "Filter time constant for electrical power (0.01 - 0.1)";
      parameter OpenIPSL.Types.PerUnit Qmax = 0.4360 "Upper limits of the limit for reactive power regulator (0.4 - 1.0)";
      parameter OpenIPSL.Types.PerUnit Qmin = -0.4360 "Lower limits of the limit for reactive power regulator (-1.0 - -0.4)";
      parameter OpenIPSL.Types.PerUnit Vmax = 1.1 "Maximum limit for voltage control (1.05 - 1.1)";
      parameter OpenIPSL.Types.PerUnit Vmin = 0.9 "Lower limits of input signals (0.9 - 0.95)";
      parameter Real Kqp = 0 "Reactive power regulator proportional gain (No predefined range)";
      parameter Real Kqi = 0.1 "Reactive power regulator integral gain (No predefined range)";
      parameter Real Kvp = 0 "Voltage regulator proportional gain (No predefined range)";
      parameter Real Kvi = 40 "Voltage regulator integral gain (No predefined range)";
      parameter OpenIPSL.Types.Time Tiq = 0.02 "Time constant on lag delay (0.01 - 0.02)";
      parameter Real dPmax = 99 "Power reference maximum ramp rate (No predefined range)";
      parameter Real dPmin = -99 "Lower limits of input signals (No predefined range)";
      parameter OpenIPSL.Types.PerUnit Pmax = 1 "Maximum power limit";
      parameter OpenIPSL.Types.PerUnit Pmin = 0 "Minimum power limit";
      parameter OpenIPSL.Types.PerUnit Imax = 1.82 "Maximum limit on total converter current (1.1 - 1.3)";
      parameter OpenIPSL.Types.Time Tpord = 0.02 "Power filter time constant (0.01 - 0.02) ";

      //Integer Voltage_dip;

      Modelica.Blocks.Nonlinear.Limiter limiter3(uMax=Vmax, uMin=Vmin)
        annotation (Placement(transformation(extent={{28,44},{48,64}})));
      Modelica.Blocks.Math.Add add4(k2=-1)
        annotation (Placement(transformation(extent={{60,44},{80,64}})));
      Modelica.Blocks.Math.Gain gain1(k=Kvp)
        annotation (Placement(transformation(extent={{100,44},{120,64}})));
      Modelica.Blocks.Continuous.Integrator integrator1(
        k=Kvi,
        initType=Modelica.Blocks.Types.Init.InitialState,
        y_start=Iq0)
        annotation (Placement(transformation(extent={{100,10},{120,30}})));
      Modelica.Blocks.Math.Add add5
        annotation (Placement(transformation(extent={{128,38},{148,58}})));
      Modelica.Blocks.Nonlinear.VariableLimiter variableLimiter2
        annotation (Placement(transformation(extent={{162,38},{182,58}})));
      Modelica.Blocks.Sources.RealExpression IQMAX_(y=ccl.Iqmax) annotation (
          Placement(transformation(
            extent={{-10,10},{10,-10}},
            rotation=180,
            origin={172,74})));
      Modelica.Blocks.Sources.RealExpression IQMIN_(y=ccl.Iqmin) annotation (
          Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={172,24})));
      Modelica.Blocks.Nonlinear.VariableLimiter variableLimiter
        annotation (Placement(transformation(extent={{264,70},{284,90}})));
      Modelica.Blocks.Sources.RealExpression IQMIN(y=ccl.Iqmin)
        annotation (Placement(transformation(extent={{284,70},{264,50}})));
      Modelica.Blocks.Sources.RealExpression IQMAX(y=ccl.Iqmax)
        annotation (Placement(transformation(extent={{284,94},{264,114}})));
      Modelica.Blocks.Nonlinear.VariableLimiter variableLimiter1
        annotation (Placement(transformation(extent={{54,-180},{74,-160}})));
      Modelica.Blocks.Sources.RealExpression IPMAX(y=ccl.Ipmax) annotation (
          Placement(transformation(
            extent={{10,-10},{-10,10}},
            origin={64,-140})));
      Modelica.Blocks.Sources.RealExpression IPMIN(y=ccl.Ipmin)
        annotation (Placement(transformation(extent={{74,-210},{54,-190}})));
      NonElectrical.Continuous.SimpleLag simpleLag(
        K=1,
        T=Trv,
        y_start=V0)
        annotation (Placement(transformation(extent={{-286,150},{-266,170}})));
      Modelica.Blocks.Math.Division division1
        annotation (Placement(transformation(extent={{-72,-180},{-52,-160}})));
      Modelica.Blocks.Nonlinear.Limiter limiter5(uMax=Modelica.Constants.inf, uMin=0.01)
        annotation (Placement(transformation(extent={{-132,-220},{-112,-200}})));
      Modelica.Blocks.Math.Add add8(k2=-1)
        annotation (Placement(transformation(extent={{-276,-176},{-256,-156}})));
      Modelica.Blocks.Nonlinear.Limiter limiter7(uMax=dPmax, uMin=dPmin)
        annotation (Placement(transformation(extent={{-240,-176},{-220,-156}})));
      Modelica.Blocks.Continuous.Integrator integrator3(k=1/Tpord, y_start=Ip0*V0)
        annotation (Placement(transformation(extent={{-152,-176},{-132,-156}})));
      Modelica.Blocks.Nonlinear.Limiter limiter8(uMax=Pmax, uMin=Pmin)
        annotation (Placement(transformation(extent={{-112,-176},{-92,-156}})));
      OpenIPSL.Electrical.Renewables.PSSE.ElectricalController.BaseClasses.CurrentLimitLogicREECB
        ccl(
        start_ii=-Iq0,
        start_ir=Ip0,
        Imax=Imax)
        annotation (Placement(transformation(extent={{260,-40},{280,-20}})));
      Modelica.Blocks.Sources.BooleanConstant Pqflag_logic(k=pqflag)
        annotation (Placement(transformation(extent={{220,-40},{240,-20}})));

      Modelica.Blocks.Sources.RealExpression VReF0(y=Vref0) annotation (Placement(
            transformation(
            extent={{-10,10},{10,-10}},
            origin={-50,70})));
      Modelica.Blocks.Math.Add add1
        annotation (Placement(transformation(extent={{-20,44},{0,64}})));
      Modelica.Blocks.Interfaces.RealInput Vref_input
        "Connector of Real input signal 2" annotation (Placement(transformation(
            extent={{-20,-20},{20,20}},
            rotation=0,
            origin={-320,260})));
      NonElectrical.Continuous.SimpleLag simpleLag1(
        K=1,
        T=Trv,
        y_start=0)
        annotation (Placement(transformation(extent={{-106,38},{-86,58}})));
    protected
      parameter Real pfaref = p00/sqrt(p00^2 +q00^2) "Power Factor of choice.";
      parameter OpenIPSL.Types.Angle pfangle = if q00 > 0 then acos(pfaref) else -acos(pfaref);
      parameter OpenIPSL.Types.PerUnit Ip0(fixed=false);
      parameter OpenIPSL.Types.PerUnit Iq0(fixed=false);
      parameter OpenIPSL.Types.PerUnit V0(fixed=false);
      parameter OpenIPSL.Types.PerUnit p00(fixed=false);
      parameter OpenIPSL.Types.PerUnit q00(fixed=false);
      parameter OpenIPSL.Types.PerUnit Vref0 = if vref0 == 0 then V0 else vref0;

    initial equation

      Ip0 = ip0;
      Iq0 = iq0;
      V0 = v0;
      p00 = p0;
      q00 = q0;

    equation

      //Voltage_dip = if Vt<Vdip or Vt>Vup then 1 else 0;
      connect(limiter3.y,add4. u1) annotation (Line(points={{49,54},{54,54},{54,60},
              {58,60}}, color={0,0,127}));
      connect(gain1.y,add5. u1) annotation (Line(points={{121,54},{126,54}},
                    color={0,0,127}));
      connect(integrator1.y,add5. u2) annotation (Line(points={{121,20},{126,20},{126,
              42}}, color={0,0,127}));
      connect(add5.y,variableLimiter2. u)
        annotation (Line(points={{149,48},{160,48}}, color={0,0,127}));
      connect(IQMAX_.y,variableLimiter2. limit1) annotation (Line(points={{161,74},{
              154,74},{154,56},{160,56}}, color={0,0,127}));
      connect(IQMIN_.y,variableLimiter2. limit2) annotation (Line(points={{161,24},{
              154,24},{154,40},{160,40}}, color={0,0,127}));
      connect(IQMIN.y,variableLimiter. limit2) annotation (Line(points={{263,60},{256,
              60},{256,72},{262,72}}, color={0,0,127}));
      connect(IQMAX.y,variableLimiter. limit1) annotation (Line(points={{263,104},{256,
              104},{256,88},{262,88}}, color={0,0,127}));
      connect(IPMIN.y,variableLimiter1. limit2) annotation (Line(points={{53,-200},{
              34,-200},{34,-178},{52,-178}}, color={0,0,127}));
      connect(IPMAX.y,variableLimiter1. limit1) annotation (Line(points={{53,-140},{
              34,-140},{34,-162},{52,-162}}, color={0,0,127}));
      connect(variableLimiter1.y, Ipcmd) annotation (Line(points={{75,-170},{254,-170},{254,-170},{310,-170}},
                                    color={0,0,127}));
      connect(Vt, simpleLag.u)
        annotation (Line(points={{-320,160},{-288,160}}, color={0,0,127}));
      connect(limiter5.y,division1. u2) annotation (Line(points={{-111,-210},{-86,-210},
              {-86,-176},{-74,-176}}, color={0,0,127}));
      connect(add8.y,limiter7. u)
        annotation (Line(points={{-255,-166},{-242,-166}},
                                                         color={0,0,127}));
      connect(integrator3.y,limiter8. u)
        annotation (Line(points={{-131,-166},{-114,-166}},
                                                         color={0,0,127}));
      connect(add8.u2,limiter8. u) annotation (Line(points={{-278,-172},{-278,-188},
              {-124,-188},{-124,-166},{-114,-166}}, color={0,0,127}));
      connect(limiter8.y,division1. u1) annotation (Line(points={{-91,-166},{-82,-166},
              {-82,-164},{-74,-164}}, color={0,0,127}));
      connect(add8.u1, Pref)
        annotation (Line(points={{-278,-160},{-320,-160}}, color={0,0,127}));
      connect(division1.y, variableLimiter1.u)
        annotation (Line(points={{-51,-170},{52,-170}}, color={0,0,127}));
      connect(variableLimiter.y, Iqcmd)
        annotation (Line(points={{285,80},{292,80},{292,170},{310,170}},
                                                     color={0,0,127}));
      connect(Pqflag_logic.y, ccl.Pqflag)
        annotation (Line(points={{241,-30},{258,-30}}, color={255,0,255}));
      connect(ccl.Iqcmd, Iqcmd) annotation (Line(points={{282,-25},{292,-25},{292,170},{310,170}},
                         color={0,0,127}));
      connect(ccl.Ipcmd, Ipcmd) annotation (Line(points={{282,-35},{292,-35},{292,-170},{310,-170}},
                          color={0,0,127}));
      connect(gain1.u, integrator1.u) annotation (Line(points={{98,54},{90,54},{90,20},
              {98,20}}, color={0,0,127}));
      connect(VReF0.y, add1.u1) annotation (Line(points={{-39,70},{-32,70},{-32,
              60},{-22,60}}, color={0,0,127}));
      connect(add1.y, limiter3.u)
        annotation (Line(points={{1,54},{26,54}}, color={0,0,127}));
      connect(simpleLag.y, add4.u2) annotation (Line(points={{-265,160},{-226,
              160},{-226,158},{-172,158},{-172,28},{58,28},{58,48}}, color={0,0,
              127}));
      connect(variableLimiter2.y, variableLimiter.u) annotation (Line(points={{
              183,48},{252,48},{252,80},{262,80}}, color={0,0,127}));
      connect(add4.y, gain1.u)
        annotation (Line(points={{81,54},{98,54}}, color={0,0,127}));
      connect(limiter7.y, integrator3.u)
        annotation (Line(points={{-219,-166},{-154,-166}}, color={0,0,127}));
      connect(limiter5.u, add4.u2) annotation (Line(points={{-134,-210},{-170,
              -210},{-170,28},{58,28},{58,48}}, color={0,0,127}));
      connect(simpleLag1.y, add1.u2)
        annotation (Line(points={{-85,48},{-22,48}}, color={0,0,127}));
      connect(simpleLag1.u, Vref_input) annotation (Line(points={{-108,48},{
              -140,48},{-140,260},{-320,260}}, color={0,0,127}));
      annotation (Documentation(info="<html>
<p>
The REECB1 component used to represent the electrical controls of photovoltaic generation. The electrical controller actuates on the active and reactive power
reference from either the plant controller component or from power flow power reference values (in the case where there is no plant controller),
with feedback variables that original from the inverter interface component, specifically terminal voltage and generator power output,
and provides real (Ipcmd) and reactive current (Iqcmd) commands to the REGC types module.
</p>
<p>
For initialization purposes, there are 5 inputs that are derived from the inverter component: initial real and reactive injection currents (IP0 and IQ0), initial terminal voltage (v_0), and initial active and reactive power
injections (p_0 and q_0).
</p>
<p>
In terms of connectivity with other components to form the renewable source, the REECB1 component has five inputs, three of which are connected to the inverter component
(for instance REGCA1), and two more that can either be constant values from the power flow initialization or come from the connection to the plant controller.
The three REECB1 inputs that take in values from the output of the inverter model
are Vt, Pgen, and Qgen while the two inputs that could potentially be constant valued or come from the plant controller are Pref, and Qext.
</p>
<p>The modelling of such devices is based, mainly, on the following references:</p>
<ul>
<li>Siemens: \"PSS&reg;E Model Library\"
<a href=\"modelica://OpenIPSL.UsersGuide.References\">[PSSE-MODELS]</a>,</li>
<li>WECC: \"Solar Photovoltaic Power Plant Modeling and Validation Guideline\"
<a href=\"modelica://OpenIPSL.UsersGuide.References\">[WECCPhotovoltaic]</a>.</li>
</ul>
</html>"), Icon(graphics={
            Text(
              extent={{-276,282},{-146,240}},
              textColor={0,0,255},
              textString="Vinput")}));
    end REECB1_Local_V_Control;

    model REECB1_Local_V_Q_Control
      "Electrical control model for large scale photovoltaic"
      extends
        OpenIPSL.Electrical.Renewables.PSSE.ElectricalController.BaseClasses.BaseREECB(
         Iqcmd, Ipcmd);

      parameter OpenIPSL.Types.PerUnit Vdip = -99 "Low voltage threshold to activate reactive current injection logic (0.85 - 0.9)";
      parameter OpenIPSL.Types.PerUnit Vup = 99 "Voltage above which reactive current injection logic is activated (>1.1)";
      parameter OpenIPSL.Types.Time Trv = 0 "Filter time constant for voltage measurement (0.01 - 0.02)";
      parameter OpenIPSL.Types.PerUnit dbd1 = -0.05 "Voltage error dead band lower threshold (-0.1 - 0)";
      parameter OpenIPSL.Types.PerUnit dbd2 = 0.05 "Voltage error dead band upper threshold (0 - 0.1)";
      parameter Real Kqv = 0 "Reactive current injection gain during over and undervoltage conditions (0 - 10)";
      parameter OpenIPSL.Types.PerUnit Iqh1 = 1.05 "Upper limit on reactive current injection Iqinj (1 - 1.1)";
      parameter OpenIPSL.Types.PerUnit Iql1 = -1.05 "Lower limit on reactive current injection Iqinj (-1.1 - 1)";
      parameter OpenIPSL.Types.PerUnit vref0 = 1 "User defined voltage reference (0.95 - 1.05)";
      parameter OpenIPSL.Types.Time Tp = 0.05 "Filter time constant for electrical power (0.01 - 0.1)";
      parameter OpenIPSL.Types.PerUnit Qmax = 0.4360 "Upper limits of the limit for reactive power regulator (0.4 - 1.0)";
      parameter OpenIPSL.Types.PerUnit Qmin = -0.4360 "Lower limits of the limit for reactive power regulator (-1.0 - -0.4)";
      parameter OpenIPSL.Types.PerUnit Vmax = 1.1 "Maximum limit for voltage control (1.05 - 1.1)";
      parameter OpenIPSL.Types.PerUnit Vmin = 0.9 "Lower limits of input signals (0.9 - 0.95)";
      parameter Real Kqp = 0 "Reactive power regulator proportional gain (No predefined range)";
      parameter Real Kqi = 0.1 "Reactive power regulator integral gain (No predefined range)";
      parameter Real Kvp = 0 "Voltage regulator proportional gain (No predefined range)";
      parameter Real Kvi = 40 "Voltage regulator integral gain (No predefined range)";
      parameter OpenIPSL.Types.Time Tiq = 0.02 "Time constant on lag delay (0.01 - 0.02)";
      parameter Real dPmax = 99 "Power reference maximum ramp rate (No predefined range)";
      parameter Real dPmin = -99 "Lower limits of input signals (No predefined range)";
      parameter OpenIPSL.Types.PerUnit Pmax = 1 "Maximum power limit";
      parameter OpenIPSL.Types.PerUnit Pmin = 0 "Minimum power limit";
      parameter OpenIPSL.Types.PerUnit Imax = 1.82 "Maximum limit on total converter current (1.1 - 1.3)";
      parameter OpenIPSL.Types.Time Tpord = 0.02 "Power filter time constant (0.01 - 0.02) ";

      Integer Voltage_dip;

      Modelica.Blocks.Nonlinear.Limiter limiter1(uMax=Qmax, uMin=Qmin)
        annotation (Placement(transformation(extent={{-162,56},{-142,76}})));
      Modelica.Blocks.Math.Add add1(k2=-1)
        annotation (Placement(transformation(extent={{-132,50},{-112,70}})));
      Modelica.Blocks.Continuous.Integrator integrator(
        k=Kqi,
        initType=Modelica.Blocks.Types.Init.InitialState,
        y_start=V0)
        annotation (Placement(transformation(extent={{-94,10},{-74,30}})));
      Modelica.Blocks.Math.Gain gain(k=Kqp)
        annotation (Placement(transformation(extent={{-92,50},{-72,70}})));
      Modelica.Blocks.Math.Add add2
        annotation (Placement(transformation(extent={{-66,44},{-46,64}})));
      Modelica.Blocks.Nonlinear.Limiter limiter2(uMax=Vmax, uMin=Vmin)
        annotation (Placement(transformation(extent={{-8,44},{12,64}})));
      Modelica.Blocks.Math.Add add4(k2=-1)
        annotation (Placement(transformation(extent={{60,44},{80,64}})));
      Modelica.Blocks.Math.Gain gain1(k=Kvp)
        annotation (Placement(transformation(extent={{100,44},{120,64}})));
      Modelica.Blocks.Continuous.Integrator integrator1(
        k=Kvi,
        initType=Modelica.Blocks.Types.Init.InitialState,
        y_start=-Iq0)
        annotation (Placement(transformation(extent={{100,10},{120,30}})));
      Modelica.Blocks.Math.Add add5
        annotation (Placement(transformation(extent={{128,38},{148,58}})));
      Modelica.Blocks.Nonlinear.VariableLimiter variableLimiter2
        annotation (Placement(transformation(extent={{162,38},{182,58}})));
      Modelica.Blocks.Sources.RealExpression IQMAX_(y=ccl.Iqmax) annotation (
          Placement(transformation(
            extent={{-10,10},{10,-10}},
            rotation=180,
            origin={172,74})));
      Modelica.Blocks.Sources.RealExpression IQMIN_(y=ccl.Iqmin) annotation (
          Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={172,24})));
      Modelica.Blocks.Nonlinear.VariableLimiter variableLimiter
        annotation (Placement(transformation(extent={{264,70},{284,90}})));
      Modelica.Blocks.Sources.RealExpression IQMIN(y=ccl.Iqmin)
        annotation (Placement(transformation(extent={{284,70},{264,50}})));
      Modelica.Blocks.Sources.RealExpression IQMAX(y=ccl.Iqmax)
        annotation (Placement(transformation(extent={{284,94},{264,114}})));
      Modelica.Blocks.Nonlinear.VariableLimiter variableLimiter1
        annotation (Placement(transformation(extent={{178,-180},{198,-160}})));
      Modelica.Blocks.Sources.RealExpression IPMAX(y=ccl.Ipmax) annotation (
          Placement(transformation(
            extent={{10,-10},{-10,10}},
            origin={188,-140})));
      Modelica.Blocks.Sources.RealExpression IPMIN(y=ccl.Ipmin)
        annotation (Placement(transformation(extent={{198,-210},{178,-190}})));
      NonElectrical.Continuous.SimpleLag simpleLag(
        K=1,
        T=Trv,
        y_start=V0)
        annotation (Placement(transformation(extent={{-286,150},{-266,170}})));
      Modelica.Blocks.Math.Division division1
        annotation (Placement(transformation(extent={{0,-180},{20,-160}})));
      Modelica.Blocks.Nonlinear.Limiter limiter5(uMax=Modelica.Constants.inf, uMin=0.01)
        annotation (Placement(transformation(extent={{-132,-220},{-112,-200}})));
      Modelica.Blocks.Nonlinear.Limiter limiter8(uMax=Pmax, uMin=Pmin)
        annotation (Placement(transformation(extent={{-70,-176},{-50,-156}})));
      OpenIPSL.Electrical.Renewables.PSSE.ElectricalController.BaseClasses.CurrentLimitLogicREECB
        ccl(
        start_ii=-Iq0,
        start_ir=Ip0,
        Imax=Imax)
        annotation (Placement(transformation(extent={{260,-40},{280,-20}})));
      Modelica.Blocks.Sources.BooleanConstant Pqflag_logic(k=pqflag)
        annotation (Placement(transformation(extent={{220,-40},{240,-20}})));

      NonElectrical.Continuous.SimpleLag simpleLag1(
        K=1,
        T=Trv,
        y_start=q00)
        annotation (Placement(transformation(extent={{-270,-90},{-250,-70}})));
      NonElectrical.Continuous.SimpleLag simpleLag2(
        K=1,
        T=Trv,
        y_start=p00)
        annotation (Placement(transformation(extent={{-276,-170},{-256,-150}})));
    protected
      parameter Real pfaref = p00/sqrt(p00^2 +q00^2) "Power Factor of choice.";
      parameter OpenIPSL.Types.Angle pfangle = if q00 > 0 then acos(pfaref) else -acos(pfaref);
      parameter OpenIPSL.Types.PerUnit Ip0(fixed=false);
      parameter OpenIPSL.Types.PerUnit Iq0(fixed=false);
      parameter OpenIPSL.Types.PerUnit V0(fixed=false);
      parameter OpenIPSL.Types.PerUnit p00(fixed=false);
      parameter OpenIPSL.Types.PerUnit q00(fixed=false);
      parameter OpenIPSL.Types.PerUnit Vref0 = if vref0 == 0 then V0 else vref0;

    initial equation

      Ip0 = ip0;
      Iq0 = iq0;
      V0 = v0;
      p00 = p0;
      q00 = q0;

    equation

      Voltage_dip = if Vt<Vdip or Vt>Vup then 1 else 0;
      connect(limiter1.y,add1. u1)
        annotation (Line(points={{-141,66},{-134,66}}, color={0,0,127}));
      connect(Qgen,add1. u2) annotation (Line(points={{-320,0},{-134,0},{-134,54}},
            color={0,0,127}));
      connect(gain.y,add2. u1)
        annotation (Line(points={{-71,60},{-68,60}}, color={0,0,127}));
      connect(integrator.y,add2. u2)
        annotation (Line(points={{-73,20},{-70,20},{-70,48},{-68,48}},
                                                            color={0,0,127}));
      connect(add2.y,limiter2. u)
        annotation (Line(points={{-45,54},{-10,54}}, color={0,0,127}));
      connect(gain1.y,add5. u1) annotation (Line(points={{121,54},{126,54}},
                    color={0,0,127}));
      connect(integrator1.y,add5. u2) annotation (Line(points={{121,20},{126,20},{126,
              42}}, color={0,0,127}));
      connect(add5.y,variableLimiter2. u)
        annotation (Line(points={{149,48},{160,48}}, color={0,0,127}));
      connect(IQMAX_.y,variableLimiter2. limit1) annotation (Line(points={{161,74},{
              154,74},{154,56},{160,56}}, color={0,0,127}));
      connect(IQMIN_.y,variableLimiter2. limit2) annotation (Line(points={{161,24},{
              154,24},{154,40},{160,40}}, color={0,0,127}));
      connect(IQMIN.y,variableLimiter. limit2) annotation (Line(points={{263,60},{256,
              60},{256,72},{262,72}}, color={0,0,127}));
      connect(IQMAX.y,variableLimiter. limit1) annotation (Line(points={{263,104},{256,
              104},{256,88},{262,88}}, color={0,0,127}));
      connect(IPMIN.y,variableLimiter1. limit2) annotation (Line(points={{177,
              -200},{177,-189},{176,-189},{176,-178}},
                                             color={0,0,127}));
      connect(IPMAX.y,variableLimiter1. limit1) annotation (Line(points={{177,
              -140},{177,-151},{176,-151},{176,-162}},
                                             color={0,0,127}));
      connect(variableLimiter1.y, Ipcmd) annotation (Line(points={{199,-170},{
              310,-170}},           color={0,0,127}));
      connect(Vt, simpleLag.u)
        annotation (Line(points={{-320,160},{-288,160}}, color={0,0,127}));
      connect(limiter5.y,division1. u2) annotation (Line(points={{-111,-210},{
              -111,-212},{-12,-212},{-12,-176},{-2,-176}},
                                      color={0,0,127}));
      connect(limiter8.y,division1. u1) annotation (Line(points={{-49,-166},{
              -25.5,-166},{-25.5,-164},{-2,-164}},
                                      color={0,0,127}));
      connect(division1.y, variableLimiter1.u)
        annotation (Line(points={{21,-170},{176,-170}}, color={0,0,127}));
      connect(variableLimiter.y, Iqcmd)
        annotation (Line(points={{285,80},{292,80},{292,170},{310,170}},
                                                     color={0,0,127}));
      connect(Pqflag_logic.y, ccl.Pqflag)
        annotation (Line(points={{241,-30},{258,-30}}, color={255,0,255}));
      connect(ccl.Iqcmd, Iqcmd) annotation (Line(points={{282,-25},{292,-25},{292,170},{310,170}},
                         color={0,0,127}));
      connect(ccl.Ipcmd, Ipcmd) annotation (Line(points={{282,-35},{292,-35},{292,-170},{310,-170}},
                          color={0,0,127}));
      connect(gain.u, integrator.u) annotation (Line(points={{-94,60},{-98,60},{-98,
              20},{-96,20}}, color={0,0,127}));
      connect(gain1.u, integrator1.u) annotation (Line(points={{98,54},{90,54},{90,20},
              {98,20}}, color={0,0,127}));
      connect(variableLimiter2.y, variableLimiter.u) annotation (Line(points={{
              183,48},{232,48},{232,80},{262,80}}, color={0,0,127}));
      connect(add4.y, gain1.u)
        annotation (Line(points={{81,54},{98,54}}, color={0,0,127}));
      connect(add4.u2, simpleLag.y) annotation (Line(points={{58,48},{58,28},{
              86,28},{86,160},{-265,160}}, color={0,0,127}));
      connect(limiter5.u, simpleLag.y) annotation (Line(points={{-134,-210},{
              -188,-210},{-188,160},{-265,160}}, color={0,0,127}));
      connect(limiter2.y, add4.u1)
        annotation (Line(points={{13,54},{13,60},{58,60}}, color={0,0,127}));
      connect(Qext, simpleLag1.u)
        annotation (Line(points={{-320,-80},{-272,-80}}, color={0,0,127}));
      connect(simpleLag1.y, limiter1.u) annotation (Line(points={{-249,-80},{
              -212,-80},{-212,66},{-164,66}}, color={0,0,127}));
      connect(add1.y, gain.u)
        annotation (Line(points={{-111,60},{-94,60}}, color={0,0,127}));
      connect(Pref, simpleLag2.u)
        annotation (Line(points={{-320,-160},{-278,-160}}, color={0,0,127}));
      connect(simpleLag2.y, limiter8.u) annotation (Line(points={{-255,-160},{
              -84,-160},{-84,-166},{-72,-166}}, color={0,0,127}));
      annotation (Documentation(info="<html>
<p>
The REECB1 component used to represent the electrical controls of photovoltaic generation. The electrical controller actuates on the active and reactive power
reference from either the plant controller component or from power flow power reference values (in the case where there is no plant controller),
with feedback variables that original from the inverter interface component, specifically terminal voltage and generator power output,
and provides real (Ipcmd) and reactive current (Iqcmd) commands to the REGC types module.
</p>
<p>
For initialization purposes, there are 5 inputs that are derived from the inverter component: initial real and reactive injection currents (IP0 and IQ0), initial terminal voltage (v_0), and initial active and reactive power
injections (p_0 and q_0).
</p>
<p>
In terms of connectivity with other components to form the renewable source, the REECB1 component has five inputs, three of which are connected to the inverter component
(for instance REGCA1), and two more that can either be constant values from the power flow initialization or come from the connection to the plant controller.
The three REECB1 inputs that take in values from the output of the inverter model
are Vt, Pgen, and Qgen while the two inputs that could potentially be constant valued or come from the plant controller are Pref, and Qext.
</p>
<p>The modelling of such devices is based, mainly, on the following references:</p>
<ul>
<li>Siemens: \"PSS&reg;E Model Library\"
<a href=\"modelica://OpenIPSL.UsersGuide.References\">[PSSE-MODELS]</a>,</li>
<li>WECC: \"Solar Photovoltaic Power Plant Modeling and Validation Guideline\"
<a href=\"modelica://OpenIPSL.UsersGuide.References\">[WECCPhotovoltaic]</a>.</li>
</ul>
</html>"));
    end REECB1_Local_V_Q_Control;

    model REECCU1_Local_V_Control
      "Electrical control model for utility scale battery energy storage"
      extends
        OpenIPSL.Electrical.Renewables.PSSE.ElectricalController.BaseClasses.BaseREECC(
         Iqcmd, Ipcmd);

      parameter OpenIPSL.Types.PerUnit Vdip = -99 "Low voltage threshold to activate reactive current injection logic (0.85 - 0.9)";
      parameter OpenIPSL.Types.PerUnit Vup = 99 "Voltage above which reactive current injection logic is activated (>1.1)";
      parameter OpenIPSL.Types.Time Trv = 0.01 "Filter time constant for voltage measurement (0.01 - 0.02)";
      parameter OpenIPSL.Types.PerUnit dbd1 = 0 "Voltage error dead band lower threshold (-0.1 - 0)";
      parameter OpenIPSL.Types.PerUnit dbd2 = 0 "Voltage error dead band upper threshold (0 - 0.1)";
      parameter Real Kqv = 0 "Reactive current injection gain during over and undervoltage conditions (0 - 10)";
      parameter OpenIPSL.Types.PerUnit Iqh1 = 1 "Upper limit on reactive current injection Iqinj (1 - 1.1)";
      parameter OpenIPSL.Types.PerUnit Iql1 = -1 "Lower limit on reactive current injection Iqinj (-1.1 - 1)";
      parameter OpenIPSL.Types.PerUnit vref0 = 1 "User defined voltage reference (0.95 - 1.05)";
      parameter OpenIPSL.Types.Time Tp = 0.01 "Filter time constant for electrical power (0.01 - 0.1)";
      parameter OpenIPSL.Types.PerUnit Qmax = 1 "Upper limits of the limit for reactive power regulator (0.4 - 1.0)";
      parameter OpenIPSL.Types.PerUnit Qmin = -1 "Lower limits of the limit for reactive power regulator (-1.0 - -0.4)";
      parameter OpenIPSL.Types.PerUnit Vmax = 1.1 "Maximum limit for voltage control (1.05 - 1.1)";
      parameter OpenIPSL.Types.PerUnit Vmin = 0.9 "Lower limits of input signals (0.9 - 0.95)";
      parameter Real Kqp = 0 "Reactive power regulator proportional gain (No predefined range)";
      parameter Real Kqi = 0.1 "Reactive power regulator integral gain (No predefined range)";
      parameter Real Kvp = 0 "Voltage regulator proportional gain (No predefined range)";
      parameter Real Kvi = 40 "Voltage regulator integral gain (No predefined range)";
      parameter OpenIPSL.Types.Time Tiq = 0.01 "Time constant on lag delay (0.01 - 0.02)";
      parameter Real dPmax = 99 "Power reference maximum ramp rate (No predefined range)";
      parameter Real dPmin = -99 "Lower limits of input signals (No predefined range)";
      parameter OpenIPSL.Types.PerUnit Pmax = 1 "Maximum power limit";
      parameter OpenIPSL.Types.PerUnit Pmin = 0 "Minimum power limit";
      parameter OpenIPSL.Types.PerUnit Imax = 1.1 "Maximum limit on total converter current (1.1 - 1.3)";
      parameter OpenIPSL.Types.Time Tpord = 0.02 "Power filter time constant (0.01 - 0.02) ";
      parameter OpenIPSL.Types.PerUnit Vq1 = 0.2 "Reactive Power V-I pair, voltage (user defined)";
      parameter OpenIPSL.Types.PerUnit Iq1 = 0.75 "Reactive Power V-I pair, current (user defined)";
      parameter OpenIPSL.Types.PerUnit Vq2 = 0.5 "Reactive Power V-I pair, voltage (user defined)";
      parameter OpenIPSL.Types.PerUnit Iq2 = 0.75 "Reactive Power V-I pair, current (user defined)";
      parameter OpenIPSL.Types.PerUnit Vq3 = 0.75 "Reactive Power V-I pair, voltage (user defined)";
      parameter OpenIPSL.Types.PerUnit Iq3 = 0.75 "Reactive Power V-I pair, current (user defined)";
      parameter OpenIPSL.Types.PerUnit Vq4 = 1 "Reactive Power V-I pair, voltage (user defined)";
      parameter OpenIPSL.Types.PerUnit Iq4 = 0.75 "Reactive Power V-I pair, current (user defined)";
      parameter OpenIPSL.Types.PerUnit Vp1 = 0.2 "Real Power V-I pair, voltage (user defined)";
      parameter OpenIPSL.Types.PerUnit Ip1 = 1.11 "Real Power V-I pair, current (user defined)";
      parameter OpenIPSL.Types.PerUnit Vp2 = 0.5 "Real Power V-I pair, voltage (user defined)";
      parameter OpenIPSL.Types.PerUnit Ip2 = 1.11 "Real Power V-I pair, current (user defined)";
      parameter OpenIPSL.Types.PerUnit Vp3 = 0.75 "Real Power V-I pair, voltage (user defined)";
      parameter OpenIPSL.Types.PerUnit Ip3 = 1.11 "Real Power V-I pair, current (user defined)";
      parameter OpenIPSL.Types.PerUnit Vp4 = 1 "Real Power V-I pair, voltage (user defined)";
      parameter OpenIPSL.Types.PerUnit Ip4 = 1.11 "Real Power V-I pair, current (user defined)";
      parameter Modelica.Units.SI.Time T = 999 "Battery discharge time";
      parameter OpenIPSL.Types.PerUnit SOCini = 0.5 "Initial state of charge";
      parameter OpenIPSL.Types.PerUnit SOCmax = 0.8 "Maximum allowable state of charge";
      parameter OpenIPSL.Types.PerUnit SOCmin = 0.2 "Minimum allowable state of charge";

      Integer Voltage_dip;

      Modelica.Blocks.Math.Division division1
        annotation (Placement(transformation(extent={{108,-132},{128,-152}})));
      Modelica.Blocks.Nonlinear.Limiter limiter5(uMax=Modelica.Constants.inf, uMin=0.01)
        annotation (Placement(transformation(extent={{62,-102},{82,-82}})));
      Modelica.Blocks.Math.Add add8(k2=-1)
        annotation (Placement(transformation(extent={{-50,-148},{-30,-128}})));
      Modelica.Blocks.Nonlinear.Limiter limiter7(uMax=dPmax, uMin=dPmin)
        annotation (Placement(transformation(extent={{-16,-148},{4,-128}})));
      Modelica.Blocks.Continuous.Integrator integrator3(k=1/Tpord,
        initType=Modelica.Blocks.Types.Init.InitialState, y_start=Ip0*V0)
        annotation (Placement(transformation(extent={{20,-148},{40,-128}})));
      Modelica.Blocks.Nonlinear.Limiter limiter8(uMax=Pmax, uMin=Pmin)
        annotation (Placement(transformation(extent={{60,-148},{80,-128}})));
      Modelica.Blocks.Math.Add add7(k1=+1, k2=+1)
        annotation (Placement(transformation(extent={{144,-152},{164,-132}})));
      Modelica.Blocks.Nonlinear.VariableLimiter variableLimiter2
        annotation (Placement(transformation(extent={{228,-170},{248,-150}})));
      Modelica.Blocks.Sources.RealExpression IPMAX(y=ccl_reecc.Ipmax) annotation (
          Placement(transformation(
            extent={{-10,10},{10,-10}},
            rotation=180,
            origin={240,-120})));
      Modelica.Blocks.Sources.RealExpression IPMIN(y=ccl_reecc.Ipmin) annotation (
          Placement(transformation(
            extent={{-10,10},{10,-10}},
            rotation=180,
            origin={240,-184})));
      Modelica.Blocks.Math.Product product2
        annotation (Placement(transformation(extent={{224,-136},{204,-116}})));
      Modelica.Blocks.Math.Product product3
        annotation (Placement(transformation(extent={{-10,-10},{10,10}},
            rotation=180,
            origin={214,-190})));
      Modelica.Blocks.Sources.RealExpression SOC_ipmax(y=sOC_logic.ipmax_SOC)
        annotation (Placement(transformation(extent={{250,-122},{230,-142}})));
      Modelica.Blocks.Sources.RealExpression SOC_ipmin(y=sOC_logic.ipmin_SOC)
        annotation (Placement(transformation(extent={{250,-186},{230,-206}})));
      Modelica.Blocks.Continuous.Integrator integrator1(k=1/T,
        initType=Modelica.Blocks.Types.Init.InitialState, y_start=p00)
        annotation (Placement(transformation(extent={{-258,-208},{-238,-188}})));
      Modelica.Blocks.Math.Add add1(k1=-1, k2=+1)
        annotation (Placement(transformation(extent={{64,-220},{84,-200}})));
      Modelica.Blocks.Nonlinear.Limiter limiter1(uMax=SOCmax, uMin=SOCmin)
        annotation (Placement(transformation(extent={{96,-220},{116,-200}})));
      OpenIPSL.Electrical.Renewables.PSSE.ElectricalController.BaseClasses.StateOfChargeLogic
        sOC_logic(SOCmin=SOCmin, SOCmax=SOCmax)
        annotation (Placement(transformation(extent={{132,-220},{152,-200}})));
      Modelica.Blocks.Nonlinear.Limiter limiter4(uMax=Vmax, uMin=Vmin)
        annotation (Placement(transformation(extent={{24,130},{44,150}})));
      Modelica.Blocks.Math.Add add5(k2=-1)
        annotation (Placement(transformation(extent={{58,124},{78,144}})));
      Modelica.Blocks.Nonlinear.VariableLimiter variableLimiter1
        annotation (Placement(transformation(extent={{158,120},{178,140}})));
      Modelica.Blocks.Sources.RealExpression IQMAX_(y=ccl_reecc.Iqmax) annotation (
          Placement(transformation(
            extent={{-10,10},{10,-10}},
            rotation=180,
            origin={170,154})));
      Modelica.Blocks.Sources.RealExpression IQMIN_(y=ccl_reecc.Iqmin) annotation (
          Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={170,104})));
      Modelica.Blocks.Nonlinear.VariableLimiter variableLimiter
        annotation (Placement(transformation(extent={{266,150},{286,170}})));
      Modelica.Blocks.Sources.RealExpression IQMIN(y=ccl_reecc.Iqmin)
        annotation (Placement(transformation(extent={{286,150},{266,130}})));
      Modelica.Blocks.Sources.RealExpression IQMAX(y=ccl_reecc.Iqmax)
        annotation (Placement(transformation(extent={{286,174},{266,194}})));
      Modelica.Blocks.Tables.CombiTable1Ds VDL1(table=[Vq1,Iq1; Vq2,Iq2; Vq3,Iq3;
            Vq4,Iq4],
        smoothness=Modelica.Blocks.Types.Smoothness.LinearSegments,
        extrapolation=Modelica.Blocks.Types.Extrapolation.HoldLastPoint)
        annotation (Placement(transformation(extent={{94,0},{114,20}})));
      Modelica.Blocks.Tables.CombiTable1Ds VDL2(table=[Vp1,Ip1; Vp2,Ip2; Vp3,Ip3;
            Vp4,Ip4],
        smoothness=Modelica.Blocks.Types.Smoothness.LinearSegments,
        extrapolation=Modelica.Blocks.Types.Extrapolation.HoldLastPoint)
        annotation (Placement(transformation(extent={{94,0},{114,-20}})));
      OpenIPSL.Electrical.Renewables.PSSE.ElectricalController.BaseClasses.CurrentLimitLogicREECC
        ccl_reecc(
        start_ii=-Iq0,
        start_ir=Ip0,
        Imax=Imax)
        annotation (Placement(transformation(extent={{130,-16},{162,16}})));
      Modelica.Blocks.Sources.RealExpression IQCMD(y=Iqcmd)
        annotation (Placement(transformation(extent={{206,12},{186,32}})));
      Modelica.Blocks.Sources.BooleanConstant PQFLAG(k=pqflag)
        annotation (Placement(transformation(extent={{206,10},{186,-10}})));
      Modelica.Blocks.Sources.RealExpression IPCMD(y=Ipcmd)
        annotation (Placement(transformation(extent={{206,-12},{186,-32}})));
      NonElectrical.Continuous.SimpleLag simpleLag(
        K=1,
        T=Trv,
        y_start=V0)
        annotation (Placement(transformation(extent={{-288,230},{-268,250}})));

      Modelica.Blocks.Sources.Constant SOC(k=SOCini)
        annotation (Placement(transformation(extent={{10,-284},{30,-264}})));
      Modelica.Blocks.Math.Gain PGQ(k=Kvp)
        annotation (Placement(transformation(extent={{98,150},{118,170}})));
      Modelica.Blocks.Continuous.Integrator IGQ(
        k=Kvi,
        initType=Modelica.Blocks.Types.Init.InitialState,
        y_start=-Iq0)
        annotation (Placement(transformation(extent={{98,92},{118,112}})));
      Modelica.Blocks.Math.Add add4
        annotation (Placement(transformation(extent={{128,120},{148,140}})));
      Modelica.Blocks.Math.Add add2
        annotation (Placement(transformation(extent={{-10,130},{10,150}})));
      Modelica.Blocks.Sources.RealExpression VReF0(y=V0)    annotation (Placement(
            transformation(
            extent={{-10,10},{10,-10}},
            origin={-38,134})));
      Modelica.Blocks.Interfaces.RealInput Vref_input
        "Connector of Real input signal 2" annotation (Placement(transformation(
            extent={{-20,-20},{20,20}},
            rotation=0,
            origin={-320,280}), iconTransformation(
            extent={{-20,-20},{20,20}},
            rotation=270,
            origin={0,320})));
      NonElectrical.Continuous.SimpleLag simpleLag2(
        K=1,
        T=Trv,
        y_start=0)
        annotation (Placement(transformation(extent={{-180,270},{-160,290}})));
      Modelica.Blocks.Math.Add add6(k2=-1)
        annotation (Placement(transformation(extent={{-200,-90},{-180,-70}})));
      Modelica.Blocks.Math.Gain PGP(k=1)
        annotation (Placement(transformation(extent={{-160,-70},{-140,-50}})));
      Modelica.Blocks.Continuous.Integrator IGP(k=1, y_start=p00)
        annotation (Placement(transformation(extent={{-160,-110},{-140,-90}})));
      Modelica.Blocks.Math.Add add9(k1=+1)
        annotation (Placement(transformation(extent={{-120,-90},{-100,-70}})));
      NonElectrical.Continuous.SimpleLag simpleLag1(
        K=1,
        T=Trv,
        y_start=p00)
        annotation (Placement(transformation(extent={{-244,-84},{-224,-64}})));
    protected
      parameter Real pfaref=p00/sqrt(p00^2 +q00^2) "Power Factor of choice.";
      parameter OpenIPSL.Types.Angle pfangle = if q00 > 0 then acos(pfaref) else -acos(pfaref);
      parameter OpenIPSL.Types.PerUnit Ip0(fixed=false);
      parameter OpenIPSL.Types.PerUnit Iq0(fixed=false);
      parameter OpenIPSL.Types.PerUnit V0(fixed=false);
      parameter OpenIPSL.Types.PerUnit p00(fixed=false);
      parameter OpenIPSL.Types.PerUnit q00(fixed=false);
      parameter OpenIPSL.Types.PerUnit Vref0 = if vref0 == 0 then V0 else vref0;

    initial equation

      Ip0 = ip0;
      Iq0 = iq0;
      V0 = v0;
      p00 = p0;
      q00 = q0;
    equation

      Voltage_dip = if Vt<Vdip or Vt>Vup then 1 else 0;

      connect(limiter5.y,division1. u2) annotation (Line(points={{83,-92},{96,
              -92},{96,-136},{106,-136}},
                                      color={0,0,127}));
      connect(add8.y,limiter7. u)
        annotation (Line(points={{-29,-138},{-18,-138}}, color={0,0,127}));
      connect(integrator3.y,limiter8. u)
        annotation (Line(points={{41,-138},{58,-138}},   color={0,0,127}));
      connect(add8.u2,limiter8. u) annotation (Line(points={{-52,-144},{-60,
              -144},{-60,-156},{48,-156},{48,-138},{58,-138}},
                                                       color={0,0,127}));
      connect(limiter8.y, division1.u1) annotation (Line(points={{81,-138},{96,
              -138},{96,-148},{106,-148}},
                                      color={0,0,127}));
      connect(division1.y, add7.u1) annotation (Line(points={{129,-142},{129,
              -136},{142,-136}},     color={0,0,127}));
      connect(Paux, add7.u2) annotation (Line(points={{-320,-160},{136,-160},{
              136,-148},{142,-148}},
                           color={0,0,127}));
      connect(variableLimiter2.y, Ipcmd)
        annotation (Line(points={{249,-160},{288,-160},{288,-170},{310,-170}},
                                                         color={0,0,127}));
      connect(add7.y,variableLimiter2. u) annotation (Line(points={{165,-142},{
              165,-144},{176,-144},{176,-160},{226,-160}},
                                      color={0,0,127}));
      connect(product2.y,variableLimiter2. limit1) annotation (Line(points={{203,-126},
              {180,-126},{180,-152},{226,-152}},
                                      color={0,0,127}));
      connect(IPMAX.y,product2. u1)
        annotation (Line(points={{229,-120},{226,-120}}, color={0,0,127}));
      connect(product3.u2,IPMIN. y)
        annotation (Line(points={{226,-184},{229,-184}}, color={0,0,127}));
      connect(variableLimiter2.limit2,product3. y) annotation (Line(points={{226,-168},
              {180,-168},{180,-190},{203,-190}}, color={0,0,127}));
      connect(product2.u2,SOC_ipmax. y)
        annotation (Line(points={{226,-132},{229,-132}},
                                                       color={0,0,127}));
      connect(product3.u1,SOC_ipmin. y)
        annotation (Line(points={{226,-196},{229,-196}}, color={0,0,127}));
      connect(add1.y,limiter1. u)
        annotation (Line(points={{85,-210},{94,-210}},   color={0,0,127}));
      connect(limiter1.y,sOC_logic. SOC)
        annotation (Line(points={{117,-210},{130,-210}},color={0,0,127}));
      connect(limiter4.y,add5. u1) annotation (Line(points={{45,140},{56,140}},
                         color={0,0,127}));
      connect(IQMAX_.y,variableLimiter1. limit1) annotation (Line(points={{159,154},
              {152,154},{152,138},{156,138}}, color={0,0,127}));
      connect(IQMIN_.y,variableLimiter1. limit2) annotation (Line(points={{159,104},
              {152,104},{152,122},{156,122}},
                                            color={0,0,127}));
      connect(IQMIN.y,variableLimiter. limit2) annotation (Line(points={{265,140},{258,
              140},{258,152},{264,152}},
                                      color={0,0,127}));
      connect(IQMAX.y,variableLimiter. limit1) annotation (Line(points={{265,184},{258,
              184},{258,168},{264,168}},
                                       color={0,0,127}));
      connect(VDL2.y[1], ccl_reecc.VDL2_out)
        annotation (Line(points={{115,-10},{120.9,-10},{120.9,-9.6},{126.8,-9.6}},
                                                         color={0,0,127}));
      connect(VDL1.y[1], ccl_reecc.VDL1_out) annotation (Line(points={{115,10},
              {115,9.6},{126.8,9.6}},
                             color={0,0,127}));
      connect(PQFLAG.y, ccl_reecc.pqflag)
        annotation (Line(points={{185,0},{172,0},{172,24},{126.8,24},{126.8,0}},
                                                         color={255,0,255}));
      connect(IQCMD.y, ccl_reecc.Iqcmd) annotation (Line(points={{185,22},{176,
              22},{176,9.6},{165.2,9.6}}, color={0,0,127}));
      connect(IPCMD.y, ccl_reecc.Ipcmd) annotation (Line(points={{185,-22},{
              165.2,-22},{165.2,-9.6}},   color={0,0,127}));
      connect(variableLimiter.y, Iqcmd)
        annotation (Line(points={{287,160},{294,160},{294,170},{310,170}},
                                                     color={0,0,127}));
      connect(Vt, simpleLag.u)
        annotation (Line(points={{-320,240},{-290,240}}, color={0,0,127}));
      connect(SOC.y, add1.u2) annotation (Line(points={{31,-274},{31,-276},{62,
              -276},{62,-216}},   color={0,0,127}));
      connect(PGQ.y, add4.u1) annotation (Line(points={{119,160},{119,148},{126,
              148},{126,136}}, color={0,0,127}));
      connect(IGQ.y, add4.u2) annotation (Line(points={{119,102},{126,102},{126,
              124}}, color={0,0,127}));
      connect(add4.y, variableLimiter1.u)
        annotation (Line(points={{149,130},{156,130}}, color={0,0,127}));
      connect(add5.y, PGQ.u) annotation (Line(points={{79,134},{79,144},{96,144},
              {96,160}}, color={0,0,127}));
      connect(variableLimiter1.y, variableLimiter.u) annotation (Line(points={{
              179,130},{240,130},{240,160},{264,160}}, color={0,0,127}));
      connect(VReF0.y, add2.u2)
        annotation (Line(points={{-27,134},{-12,134}}, color={0,0,127}));
      connect(add2.y, limiter4.u)
        annotation (Line(points={{11,140},{22,140}},  color={0,0,127}));
      connect(Vref_input, simpleLag2.u)
        annotation (Line(points={{-320,280},{-182,280}}, color={0,0,127}));
      connect(simpleLag2.y, add2.u1) annotation (Line(points={{-159,280},{-24,
              280},{-24,146},{-12,146}}, color={0,0,127}));
      connect(limiter7.y, integrator3.u)
        annotation (Line(points={{5,-138},{18,-138}},      color={0,0,127}));
      connect(limiter5.u, simpleLag.y) annotation (Line(points={{60,-92},{-60,
              -92},{-60,240},{-267,240}},       color={0,0,127}));
      connect(integrator1.u, Pe) annotation (Line(points={{-260,-198},{-280,
              -198},{-280,160},{-320,160}}, color={0,0,127}));
      connect(IGQ.u, PGQ.u) annotation (Line(points={{96,102},{88,102},{88,144},
              {96,144},{96,160}}, color={0,0,127}));
      connect(add5.u2, simpleLag.y) annotation (Line(points={{56,128},{54,128},
              {54,78},{-60,78},{-60,240},{-267,240}},   color={0,0,127}));
      connect(VDL1.u, simpleLag.y) annotation (Line(points={{92,10},{-60,10},{
              -60,240},{-267,240}},                      color={0,0,127}));
      connect(VDL2.u, simpleLag.y) annotation (Line(points={{92,-10},{-60,-10},
              {-60,240},{-267,240}},                      color={0,0,127}));
      connect(IGP.y,add9. u2) annotation (Line(points={{-139,-100},{-132,-100},
              {-132,-86},{-122,-86}},
                     color={0,0,127}));
      connect(PGP.y,add9. u1) annotation (Line(points={{-139,-60},{-132,-60},{
              -132,-74},{-122,-74}},
                         color={0,0,127}));
      connect(add9.y, add8.u1) annotation (Line(points={{-99,-80},{-64,-80},{
              -64,-132},{-52,-132}}, color={0,0,127}));
      connect(simpleLag1.y, add6.u1)
        annotation (Line(points={{-223,-74},{-202,-74}}, color={0,0,127}));
      connect(Pref, simpleLag1.u) annotation (Line(points={{-320,-80},{-320,-74},
              {-246,-74}}, color={0,0,127}));
      connect(IGP.u, add6.y) annotation (Line(points={{-162,-100},{-168,-100},{
              -168,-80},{-179,-80}}, color={0,0,127}));
      connect(PGP.u, add6.y) annotation (Line(points={{-162,-60},{-168,-60},{
              -168,-80},{-179,-80}}, color={0,0,127}));
      connect(integrator1.y, add1.u1) annotation (Line(points={{-237,-198},{
              -237,-204},{62,-204}}, color={0,0,127}));
      connect(add6.u2, Pe) annotation (Line(points={{-202,-86},{-206,-86},{-206,
              -118},{-280,-118},{-280,160},{-320,160}}, color={0,0,127}));
      annotation (Documentation(info="<html>
<p>
The REECCU1 component is an augmented version of the existing renewable energy electrical control (REECA1) model, and can be utilized to represent
both type 3 and type 4 wind turbine electrical controllers as well as photovoltaic electrical controllers. The REECCU1 component can be connected to the
plant controller (REPCA1). This electrical controller provides real (Ipcmd) and reactive (Iqcmd) current commands to the REGCA1 component, which are the outputs
of this component.
</p>
<p>
For initialization purposes, there are 5 inputs that are derived from the inverter component: initial real and reactive injection currents (IP0 and IQ0), initial terminal voltage (v_0), and initial active and reactive power
injections (p_0 and q_0).
</p>
<p>
In terms of connectivity with other components to form the renewable source, the REECCU1 component has six inputs, three of which are connected to the inverter component
(for instance REGCA1), two more that can either be constant values from the power flow initialization or come from the connection to the plant controller, and
an auxiliary input variable that is rarely used (usually constant and zero). The three REECCU1 inputs that take in values from the output of the inverter model
are Vt, Pgen, and Qgen while the two inputs that could potentially be constant valued or come from the plant controller are Pref, and Qext.
</p>
<p>The modelling of such devices is based, mainly, on the following references:</p>
<ul>
<li>Siemens: \"PSS&reg;E Model Library\"
<a href=\"modelica://OpenIPSL.UsersGuide.References\">[PSSE-MODELS]</a>,</li>
<li>WECC: \"Battery Storage Dynamic Modeling Guideline\"
<a href=\"modelica://OpenIPSL.UsersGuide.References\">[WECCBattery]</a>.</li>
</ul>

</html>"));
    end REECCU1_Local_V_Control;

    model REECCU1_Local_V_Q_Control
      "Electrical control model for utility scale battery energy storage"
      extends
        OpenIPSL.Electrical.Renewables.PSSE.ElectricalController.BaseClasses.BaseREECC(
         Iqcmd, Ipcmd);

      parameter OpenIPSL.Types.PerUnit Vdip = -99 "Low voltage threshold to activate reactive current injection logic (0.85 - 0.9)";
      parameter OpenIPSL.Types.PerUnit Vup = 99 "Voltage above which reactive current injection logic is activated (>1.1)";
      parameter OpenIPSL.Types.Time Trv = 0.01 "Filter time constant for voltage measurement (0.01 - 0.02)";
      parameter OpenIPSL.Types.PerUnit dbd1 = 0 "Voltage error dead band lower threshold (-0.1 - 0)";
      parameter OpenIPSL.Types.PerUnit dbd2 = 0 "Voltage error dead band upper threshold (0 - 0.1)";
      parameter Real Kqv = 0 "Reactive current injection gain during over and undervoltage conditions (0 - 10)";
      parameter OpenIPSL.Types.PerUnit Iqh1 = 1 "Upper limit on reactive current injection Iqinj (1 - 1.1)";
      parameter OpenIPSL.Types.PerUnit Iql1 = -1 "Lower limit on reactive current injection Iqinj (-1.1 - 1)";
      parameter OpenIPSL.Types.PerUnit vref0 = 1 "User defined voltage reference (0.95 - 1.05)";
      parameter OpenIPSL.Types.Time Tp = 0.01 "Filter time constant for electrical power (0.01 - 0.1)";
      parameter OpenIPSL.Types.PerUnit Qmax = 1 "Upper limits of the limit for reactive power regulator (0.4 - 1.0)";
      parameter OpenIPSL.Types.PerUnit Qmin = -1 "Lower limits of the limit for reactive power regulator (-1.0 - -0.4)";
      parameter OpenIPSL.Types.PerUnit Vmax = 1.1 "Maximum limit for voltage control (1.05 - 1.1)";
      parameter OpenIPSL.Types.PerUnit Vmin = 0.9 "Lower limits of input signals (0.9 - 0.95)";
      parameter Real Kqp = 0 "Reactive power regulator proportional gain (No predefined range)";
      parameter Real Kqi = 0.1 "Reactive power regulator integral gain (No predefined range)";
      parameter Real Kvp = 0 "Voltage regulator proportional gain (No predefined range)";
      parameter Real Kvi = 40 "Voltage regulator integral gain (No predefined range)";
      parameter OpenIPSL.Types.Time Tiq = 0.01 "Time constant on lag delay (0.01 - 0.02)";
      parameter Real dPmax = 99 "Power reference maximum ramp rate (No predefined range)";
      parameter Real dPmin = -99 "Lower limits of input signals (No predefined range)";
      parameter OpenIPSL.Types.PerUnit Pmax = 1 "Maximum power limit";
      parameter OpenIPSL.Types.PerUnit Pmin = 0 "Minimum power limit";
      parameter OpenIPSL.Types.PerUnit Imax = 1.1 "Maximum limit on total converter current (1.1 - 1.3)";
      parameter OpenIPSL.Types.Time Tpord = 0.02 "Power filter time constant (0.01 - 0.02) ";
      parameter OpenIPSL.Types.PerUnit Vq1 = 0.2 "Reactive Power V-I pair, voltage (user defined)";
      parameter OpenIPSL.Types.PerUnit Iq1 = 0.75 "Reactive Power V-I pair, current (user defined)";
      parameter OpenIPSL.Types.PerUnit Vq2 = 0.5 "Reactive Power V-I pair, voltage (user defined)";
      parameter OpenIPSL.Types.PerUnit Iq2 = 0.75 "Reactive Power V-I pair, current (user defined)";
      parameter OpenIPSL.Types.PerUnit Vq3 = 0.75 "Reactive Power V-I pair, voltage (user defined)";
      parameter OpenIPSL.Types.PerUnit Iq3 = 0.75 "Reactive Power V-I pair, current (user defined)";
      parameter OpenIPSL.Types.PerUnit Vq4 = 1 "Reactive Power V-I pair, voltage (user defined)";
      parameter OpenIPSL.Types.PerUnit Iq4 = 0.75 "Reactive Power V-I pair, current (user defined)";
      parameter OpenIPSL.Types.PerUnit Vp1 = 0.2 "Real Power V-I pair, voltage (user defined)";
      parameter OpenIPSL.Types.PerUnit Ip1 = 1.11 "Real Power V-I pair, current (user defined)";
      parameter OpenIPSL.Types.PerUnit Vp2 = 0.5 "Real Power V-I pair, voltage (user defined)";
      parameter OpenIPSL.Types.PerUnit Ip2 = 1.11 "Real Power V-I pair, current (user defined)";
      parameter OpenIPSL.Types.PerUnit Vp3 = 0.75 "Real Power V-I pair, voltage (user defined)";
      parameter OpenIPSL.Types.PerUnit Ip3 = 1.11 "Real Power V-I pair, current (user defined)";
      parameter OpenIPSL.Types.PerUnit Vp4 = 1 "Real Power V-I pair, voltage (user defined)";
      parameter OpenIPSL.Types.PerUnit Ip4 = 1.11 "Real Power V-I pair, current (user defined)";
      parameter Modelica.Units.SI.Time T = 999 "Battery discharge time";
      parameter OpenIPSL.Types.PerUnit SOCini = 0.5 "Initial state of charge";
      parameter OpenIPSL.Types.PerUnit SOCmax = 0.8 "Maximum allowable state of charge";
      parameter OpenIPSL.Types.PerUnit SOCmin = 0.2 "Minimum allowable state of charge";

      Integer Voltage_dip;

      Modelica.Blocks.Nonlinear.Limiter limiter5(uMax=Modelica.Constants.inf, uMin=0.01)
        annotation (Placement(transformation(extent={{-100,-90},{-80,-70}})));
      Modelica.Blocks.Math.Add add8(k2=-1)
        annotation (Placement(transformation(extent={{-242,-136},{-222,-116}})));
      Modelica.Blocks.Nonlinear.Limiter limiter7(uMax=dPmax, uMin=dPmin)
        annotation (Placement(transformation(extent={{-208,-136},{-188,-116}})));
      Modelica.Blocks.Continuous.Integrator integrator3(k=1/Tpord,
        initType=Modelica.Blocks.Types.Init.InitialState, y_start=Ip0*V0)
        annotation (Placement(transformation(extent={{-142,-136},{-122,-116}})));
      Modelica.Blocks.Nonlinear.Limiter limiter8(uMax=Pmax, uMin=Pmin)
        annotation (Placement(transformation(extent={{-102,-136},{-82,-116}})));
      Modelica.Blocks.Math.Add add7(k1=+1, k2=+1)
        annotation (Placement(transformation(extent={{-18,-140},{2,-120}})));
      Modelica.Blocks.Nonlinear.VariableLimiter variableLimiter2
        annotation (Placement(transformation(extent={{228,-170},{248,-150}})));
      Modelica.Blocks.Sources.RealExpression IPMAX(y=ccl_reecc.Ipmax) annotation (
          Placement(transformation(
            extent={{-10,10},{10,-10}},
            rotation=180,
            origin={240,-120})));
      Modelica.Blocks.Sources.RealExpression IPMIN(y=ccl_reecc.Ipmin) annotation (
          Placement(transformation(
            extent={{-10,10},{10,-10}},
            rotation=180,
            origin={240,-184})));
      Modelica.Blocks.Math.Product product2
        annotation (Placement(transformation(extent={{224,-136},{204,-116}})));
      Modelica.Blocks.Math.Product product3
        annotation (Placement(transformation(extent={{-10,-10},{10,10}},
            rotation=180,
            origin={214,-190})));
      Modelica.Blocks.Sources.RealExpression SOC_ipmax(y=sOC_logic.ipmax_SOC)
        annotation (Placement(transformation(extent={{250,-122},{230,-142}})));
      Modelica.Blocks.Sources.RealExpression SOC_ipmin(y=sOC_logic.ipmin_SOC)
        annotation (Placement(transformation(extent={{250,-186},{230,-206}})));
      Modelica.Blocks.Continuous.Integrator integrator1(k=1/T,
        initType=Modelica.Blocks.Types.Init.InitialState, y_start=p00)
        annotation (Placement(transformation(extent={{-134,-226},{-114,-206}})));
      Modelica.Blocks.Math.Add add1(k1=-1, k2=+1)
        annotation (Placement(transformation(extent={{-104,-244},{-84,-224}})));
      Modelica.Blocks.Nonlinear.Limiter limiter1(uMax=SOCmax, uMin=SOCmin)
        annotation (Placement(transformation(extent={{-74,-244},{-54,-224}})));
      OpenIPSL.Electrical.Renewables.PSSE.ElectricalController.BaseClasses.StateOfChargeLogic
        sOC_logic(SOCmin=SOCmin, SOCmax=SOCmax)
        annotation (Placement(transformation(extent={{-30,-244},{-10,-224}})));
      Modelica.Blocks.Nonlinear.Limiter limiter2(uMax=Qmax, uMin=Qmin)
        annotation (Placement(transformation(extent={{-164,136},{-144,156}})));
      Modelica.Blocks.Math.Add add2(k2=-1)
        annotation (Placement(transformation(extent={{-134,130},{-114,150}})));
      Modelica.Blocks.Nonlinear.Limiter limiter3(uMax=Vmax, uMin=Vmin)
        annotation (Placement(transformation(extent={{-40,124},{-20,144}})));
      Modelica.Blocks.Nonlinear.Limiter limiter4(uMax=Vmax, uMin=Vmin)
        annotation (Placement(transformation(extent={{26,124},{46,144}})));
      Modelica.Blocks.Math.Add add5(k2=-1)
        annotation (Placement(transformation(extent={{58,124},{78,144}})));
      Modelica.Blocks.Nonlinear.VariableLimiter variableLimiter1
        annotation (Placement(transformation(extent={{158,120},{178,140}})));
      Modelica.Blocks.Sources.RealExpression IQMAX_(y=ccl_reecc.Iqmax) annotation (
          Placement(transformation(
            extent={{-10,10},{10,-10}},
            rotation=180,
            origin={170,154})));
      Modelica.Blocks.Sources.RealExpression IQMIN_(y=ccl_reecc.Iqmin) annotation (
          Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={170,104})));
      Modelica.Blocks.Nonlinear.VariableLimiter variableLimiter
        annotation (Placement(transformation(extent={{266,150},{286,170}})));
      Modelica.Blocks.Sources.RealExpression IQMIN(y=ccl_reecc.Iqmin)
        annotation (Placement(transformation(extent={{286,150},{266,130}})));
      Modelica.Blocks.Sources.RealExpression IQMAX(y=ccl_reecc.Iqmax)
        annotation (Placement(transformation(extent={{286,174},{266,194}})));
      Modelica.Blocks.Tables.CombiTable1Ds VDL1(table=[Vq1,Iq1; Vq2,Iq2; Vq3,Iq3;
            Vq4,Iq4],
        smoothness=Modelica.Blocks.Types.Smoothness.LinearSegments,
        extrapolation=Modelica.Blocks.Types.Extrapolation.HoldLastPoint)
        annotation (Placement(transformation(extent={{56,-60},{76,-40}})));
      Modelica.Blocks.Tables.CombiTable1Ds VDL2(table=[Vp1,Ip1; Vp2,Ip2; Vp3,Ip3;
            Vp4,Ip4],
        smoothness=Modelica.Blocks.Types.Smoothness.LinearSegments,
        extrapolation=Modelica.Blocks.Types.Extrapolation.HoldLastPoint)
        annotation (Placement(transformation(extent={{56,-60},{76,-80}})));
      OpenIPSL.Electrical.Renewables.PSSE.ElectricalController.BaseClasses.CurrentLimitLogicREECC
        ccl_reecc(
        start_ii=-Iq0,
        start_ir=Ip0,
        Imax=Imax)
        annotation (Placement(transformation(extent={{92,-76},{124,-44}})));
      Modelica.Blocks.Sources.RealExpression IQCMD(y=Iqcmd)
        annotation (Placement(transformation(extent={{168,-48},{148,-28}})));
      Modelica.Blocks.Sources.BooleanConstant PQFLAG(k=pqflag)
        annotation (Placement(transformation(extent={{168,-50},{148,-70}})));
      Modelica.Blocks.Sources.RealExpression IPCMD(y=Ipcmd)
        annotation (Placement(transformation(extent={{168,-72},{148,-92}})));
      NonElectrical.Continuous.SimpleLag simpleLag(
        K=1,
        T=Trv,
        y_start=V0)
        annotation (Placement(transformation(extent={{-288,230},{-268,250}})));

      Modelica.Blocks.Sources.Constant SOC(k=SOCini)
        annotation (Placement(transformation(extent={{-200,-260},{-180,-240}})));
      Modelica.Blocks.Continuous.Integrator integrator(
        k=Kqi,
        initType=Modelica.Blocks.Types.Init.InitialState,
        y_start=V0)
        annotation (Placement(transformation(extent={{-96,90},{-76,110}})));
      Modelica.Blocks.Math.Gain gain(k=Kqp)
        annotation (Placement(transformation(extent={{-94,130},{-74,150}})));
      Modelica.Blocks.Math.Add add3
        annotation (Placement(transformation(extent={{-66,124},{-46,144}})));
      Modelica.Blocks.Math.Gain gain1(k=Kvp)
        annotation (Placement(transformation(extent={{100,126},{120,146}})));
      Modelica.Blocks.Continuous.Integrator integrator2(
        k=Kvi,
        initType=Modelica.Blocks.Types.Init.InitialState,
        y_start=-Iq0 - (-V0 + Vref0)*Kqv)
        annotation (Placement(transformation(extent={{100,92},{120,112}})));
      Modelica.Blocks.Math.Add add4
        annotation (Placement(transformation(extent={{128,120},{148,140}})));
      Modelica.Blocks.Math.Division division1
        annotation (Placement(transformation(extent={{-60,-110},{-40,-130}})));
    protected
      parameter Real pfaref=p00/sqrt(p00^2 +q00^2) "Power Factor of choice.";
      parameter OpenIPSL.Types.Angle pfangle = if q00 > 0 then acos(pfaref) else -acos(pfaref);
      parameter OpenIPSL.Types.PerUnit Ip0(fixed=false);
      parameter OpenIPSL.Types.PerUnit Iq0(fixed=false);
      parameter OpenIPSL.Types.PerUnit V0(fixed=false);
      parameter OpenIPSL.Types.PerUnit p00(fixed=false);
      parameter OpenIPSL.Types.PerUnit q00(fixed=false);
      parameter OpenIPSL.Types.PerUnit Vref0 = if vref0 == 0 then V0 else vref0;

    initial equation

      Ip0 = ip0;
      Iq0 = iq0;
      V0 = v0;
      p00 = p0;
      q00 = q0;
    equation

      Voltage_dip = if Vt<Vdip or Vt>Vup then 1 else 0;

      connect(add8.y,limiter7. u)
        annotation (Line(points={{-221,-126},{-210,-126}},
                                                         color={0,0,127}));
      connect(integrator3.y,limiter8. u)
        annotation (Line(points={{-121,-126},{-104,-126}},
                                                         color={0,0,127}));
      connect(add8.u2,limiter8. u) annotation (Line(points={{-244,-132},{-252,-132},
              {-252,-152},{-112,-152},{-112,-126},{-104,-126}},
                                                       color={0,0,127}));
      connect(Paux, add7.u2) annotation (Line(points={{-320,-160},{-26,-160},{-26,-136},
              {-20,-136}}, color={0,0,127}));
      connect(variableLimiter2.y, Ipcmd)
        annotation (Line(points={{249,-160},{288,-160},{288,-170},{310,-170}},
                                                         color={0,0,127}));
      connect(add7.y,variableLimiter2. u) annotation (Line(points={{3,-130},{114,-130},
              {114,-160},{226,-160}}, color={0,0,127}));
      connect(product2.y,variableLimiter2. limit1) annotation (Line(points={{203,-126},
              {180,-126},{180,-152},{226,-152}},
                                      color={0,0,127}));
      connect(IPMAX.y,product2. u1)
        annotation (Line(points={{229,-120},{226,-120}}, color={0,0,127}));
      connect(product3.u2,IPMIN. y)
        annotation (Line(points={{226,-184},{229,-184}}, color={0,0,127}));
      connect(variableLimiter2.limit2,product3. y) annotation (Line(points={{226,-168},
              {180,-168},{180,-190},{203,-190}}, color={0,0,127}));
      connect(product2.u2,SOC_ipmax. y)
        annotation (Line(points={{226,-132},{229,-132}},
                                                       color={0,0,127}));
      connect(product3.u1,SOC_ipmin. y)
        annotation (Line(points={{226,-196},{229,-196}}, color={0,0,127}));
      connect(integrator1.y,add1. u1) annotation (Line(points={{-113,-216},{-112,-216},
              {-112,-228},{-106,-228}}, color={0,0,127}));
      connect(add1.y,limiter1. u)
        annotation (Line(points={{-83,-234},{-76,-234}}, color={0,0,127}));
      connect(limiter1.y,sOC_logic. SOC)
        annotation (Line(points={{-53,-234},{-32,-234}},color={0,0,127}));
      connect(limiter2.y,add2. u1)
        annotation (Line(points={{-143,146},{-136,146}}, color={0,0,127}));
      connect(Qgen,add2. u2) annotation (Line(points={{-320,80},{-136,80},{-136,134}},
            color={0,0,127}));
      connect(limiter4.y,add5. u1) annotation (Line(points={{47,134},{52,134},{52,140},
              {56,140}}, color={0,0,127}));
      connect(IQMAX_.y,variableLimiter1. limit1) annotation (Line(points={{159,154},
              {152,154},{152,138},{156,138}}, color={0,0,127}));
      connect(IQMIN_.y,variableLimiter1. limit2) annotation (Line(points={{159,104},
              {152,104},{152,122},{156,122}},
                                            color={0,0,127}));
      connect(IQMIN.y,variableLimiter. limit2) annotation (Line(points={{265,140},{258,
              140},{258,152},{264,152}},
                                      color={0,0,127}));
      connect(IQMAX.y,variableLimiter. limit1) annotation (Line(points={{265,184},{258,
              184},{258,168},{264,168}},
                                       color={0,0,127}));
      connect(VDL2.y[1], ccl_reecc.VDL2_out)
        annotation (Line(points={{77,-70},{88.8,-69.6}}, color={0,0,127}));
      connect(VDL1.y[1], ccl_reecc.VDL1_out) annotation (Line(points={{77,-50},{77,-50.4},
              {88.8,-50.4}}, color={0,0,127}));
      connect(PQFLAG.y, ccl_reecc.pqflag)
        annotation (Line(points={{147,-60},{88.8,-60}},  color={255,0,255}));
      connect(IQCMD.y, ccl_reecc.Iqcmd) annotation (Line(points={{147,-38},{132,-38},{132,-50.4},{127.2,-50.4}},
                                          color={0,0,127}));
      connect(IPCMD.y, ccl_reecc.Ipcmd) annotation (Line(points={{147,-82},{132,-82},{132,-69.6},{127.2,-69.6}},
                                          color={0,0,127}));
      connect(variableLimiter.y, Iqcmd)
        annotation (Line(points={{287,160},{294,160},{294,170},{310,170}},
                                                     color={0,0,127}));
      connect(Vt, simpleLag.u)
        annotation (Line(points={{-320,240},{-290,240}}, color={0,0,127}));
      connect(SOC.y, add1.u2) annotation (Line(points={{-179,-250},{-128,-250},{-128,
              -240},{-106,-240}}, color={0,0,127}));
      connect(gain.y,add3. u1)
        annotation (Line(points={{-73,140},{-68,140}},
                                                     color={0,0,127}));
      connect(integrator.y,add3. u2)
        annotation (Line(points={{-75,100},{-68,100},{-68,128}},
                                                            color={0,0,127}));
      connect(add3.y, limiter3.u)
        annotation (Line(points={{-45,134},{-42,134}}, color={0,0,127}));
      connect(gain1.y,add4. u1) annotation (Line(points={{121,136},{126,136}},
                    color={0,0,127}));
      connect(integrator2.y,add4. u2) annotation (Line(points={{121,102},{121,
              112},{126,112},{126,124}},
                    color={0,0,127}));
      connect(add4.y, variableLimiter1.u)
        annotation (Line(points={{149,130},{156,130}}, color={0,0,127}));
      connect(Qext, limiter2.u) annotation (Line(points={{-320,0},{-200,0},{
              -200,146},{-166,146}}, color={0,0,127}));
      connect(gain.u, add2.y)
        annotation (Line(points={{-96,140},{-113,140}}, color={0,0,127}));
      connect(integrator.u, add2.y) annotation (Line(points={{-98,100},{-108,
              100},{-108,140},{-113,140}}, color={0,0,127}));
      connect(limiter3.y, limiter4.u)
        annotation (Line(points={{-19,134},{24,134}}, color={0,0,127}));
      connect(gain1.u, add5.y) annotation (Line(points={{98,136},{88.5,136},{
              88.5,134},{79,134}}, color={0,0,127}));
      connect(integrator2.u, add5.y) annotation (Line(points={{98,102},{88,102},
              {88,134},{79,134}}, color={0,0,127}));
      connect(variableLimiter1.y, variableLimiter.u) annotation (Line(points={{
              179,130},{202,130},{202,132},{228,132},{228,160},{264,160}},
            color={0,0,127}));
      connect(simpleLag.y, VDL1.u) annotation (Line(points={{-267,240},{-244,
              240},{-244,-50},{54,-50}}, color={0,0,127}));
      connect(VDL2.u, VDL1.u) annotation (Line(points={{54,-70},{22,-70},{22,
              -50},{54,-50}}, color={0,0,127}));
      connect(add5.u2, simpleLag.y) annotation (Line(points={{56,128},{52,128},
              {52,84},{-6,84},{-6,240},{-267,240}}, color={0,0,127}));
      connect(limiter5.u, VDL1.u) annotation (Line(points={{-102,-80},{-246,-80},
              {-246,-50},{54,-50}}, color={0,0,127}));
      connect(limiter7.y, integrator3.u)
        annotation (Line(points={{-187,-126},{-144,-126}}, color={0,0,127}));
      connect(integrator1.u, Pe) annotation (Line(points={{-136,-216},{-280,
              -216},{-280,160},{-320,160}}, color={0,0,127}));
      connect(limiter8.y, division1.u1)
        annotation (Line(points={{-81,-126},{-62,-126}}, color={0,0,127}));
      connect(limiter5.y, division1.u2) annotation (Line(points={{-79,-80},{-70,
              -80},{-70,-114},{-62,-114}}, color={0,0,127}));
      connect(division1.y, add7.u1) annotation (Line(points={{-39,-120},{-39,
              -124},{-20,-124}}, color={0,0,127}));
      connect(Pref, add8.u1) annotation (Line(points={{-320,-80},{-252,-80},{
              -252,-120},{-244,-120}}, color={0,0,127}));
      annotation (Documentation(info="<html>
<p>
The REECCU1 component is an augmented version of the existing renewable energy electrical control (REECA1) model, and can be utilized to represent
both type 3 and type 4 wind turbine electrical controllers as well as photovoltaic electrical controllers. The REECCU1 component can be connected to the
plant controller (REPCA1). This electrical controller provides real (Ipcmd) and reactive (Iqcmd) current commands to the REGCA1 component, which are the outputs
of this component.
</p>
<p>
For initialization purposes, there are 5 inputs that are derived from the inverter component: initial real and reactive injection currents (IP0 and IQ0), initial terminal voltage (v_0), and initial active and reactive power
injections (p_0 and q_0).
</p>
<p>
In terms of connectivity with other components to form the renewable source, the REECCU1 component has six inputs, three of which are connected to the inverter component
(for instance REGCA1), two more that can either be constant values from the power flow initialization or come from the connection to the plant controller, and
an auxiliary input variable that is rarely used (usually constant and zero). The three REECCU1 inputs that take in values from the output of the inverter model
are Vt, Pgen, and Qgen while the two inputs that could potentially be constant valued or come from the plant controller are Pref, and Qext.
</p>
<p>The modelling of such devices is based, mainly, on the following references:</p>
<ul>
<li>Siemens: \"PSS&reg;E Model Library\"
<a href=\"modelica://OpenIPSL.UsersGuide.References\">[PSSE-MODELS]</a>,</li>
<li>WECC: \"Battery Storage Dynamic Modeling Guideline\"
<a href=\"modelica://OpenIPSL.UsersGuide.References\">[WECCBattery]</a>.</li>
</ul>

</html>"));
    end REECCU1_Local_V_Q_Control;

    model REECCU1_Local_V_Q_Control2
      "Electrical control model for utility scale battery energy storage"
      extends
        OpenIPSL.Electrical.Renewables.PSSE.ElectricalController.BaseClasses.BaseREECC(
         Iqcmd, Ipcmd);

      parameter OpenIPSL.Types.PerUnit Vdip = -99 "Low voltage threshold to activate reactive current injection logic (0.85 - 0.9)";
      parameter OpenIPSL.Types.PerUnit Vup = 99 "Voltage above which reactive current injection logic is activated (>1.1)";
      parameter OpenIPSL.Types.Time Trv = 0.01 "Filter time constant for voltage measurement (0.01 - 0.02)";
      parameter OpenIPSL.Types.PerUnit dbd1 = 0 "Voltage error dead band lower threshold (-0.1 - 0)";
      parameter OpenIPSL.Types.PerUnit dbd2 = 0 "Voltage error dead band upper threshold (0 - 0.1)";
      parameter Real Kqv = 0 "Reactive current injection gain during over and undervoltage conditions (0 - 10)";
      parameter OpenIPSL.Types.PerUnit Iqh1 = 1 "Upper limit on reactive current injection Iqinj (1 - 1.1)";
      parameter OpenIPSL.Types.PerUnit Iql1 = -1 "Lower limit on reactive current injection Iqinj (-1.1 - 1)";
      parameter OpenIPSL.Types.PerUnit vref0 = 1 "User defined voltage reference (0.95 - 1.05)";
      parameter OpenIPSL.Types.Time Tp = 0.01 "Filter time constant for electrical power (0.01 - 0.1)";
      parameter OpenIPSL.Types.PerUnit Qmax = 1 "Upper limits of the limit for reactive power regulator (0.4 - 1.0)";
      parameter OpenIPSL.Types.PerUnit Qmin = -1 "Lower limits of the limit for reactive power regulator (-1.0 - -0.4)";
      parameter OpenIPSL.Types.PerUnit Vmax = 1.1 "Maximum limit for voltage control (1.05 - 1.1)";
      parameter OpenIPSL.Types.PerUnit Vmin = 0.9 "Lower limits of input signals (0.9 - 0.95)";
      parameter Real Kqp = 0 "Reactive power regulator proportional gain (No predefined range)";
      parameter Real Kqi = 0.1 "Reactive power regulator integral gain (No predefined range)";
      parameter Real Kvp = 0 "Voltage regulator proportional gain (No predefined range)";
      parameter Real Kvi = 40 "Voltage regulator integral gain (No predefined range)";
      parameter Real Kpp = 1 "Voltage regulator proportional gain (No predefined range)";
      parameter Real Kpi = 1 "Voltage regulator integral gain (No predefined range)";
      parameter OpenIPSL.Types.Time Tiq = 0.01 "Time constant on lag delay (0.01 - 0.02)";
      parameter Real dPmax = 99 "Power reference maximum ramp rate (No predefined range)";
      parameter Real dPmin = -99 "Lower limits of input signals (No predefined range)";
      parameter OpenIPSL.Types.PerUnit Pmax = 1 "Maximum power limit";
      parameter OpenIPSL.Types.PerUnit Pmin = 0 "Minimum power limit";
      parameter OpenIPSL.Types.PerUnit Imax = 1.1 "Maximum limit on total converter current (1.1 - 1.3)";
      parameter OpenIPSL.Types.Time Tpord = 0.02 "Power filter time constant (0.01 - 0.02) ";
      parameter OpenIPSL.Types.PerUnit Vq1 = 0.2 "Reactive Power V-I pair, voltage (user defined)";
      parameter OpenIPSL.Types.PerUnit Iq1 = 0.75 "Reactive Power V-I pair, current (user defined)";
      parameter OpenIPSL.Types.PerUnit Vq2 = 0.5 "Reactive Power V-I pair, voltage (user defined)";
      parameter OpenIPSL.Types.PerUnit Iq2 = 0.75 "Reactive Power V-I pair, current (user defined)";
      parameter OpenIPSL.Types.PerUnit Vq3 = 0.75 "Reactive Power V-I pair, voltage (user defined)";
      parameter OpenIPSL.Types.PerUnit Iq3 = 0.75 "Reactive Power V-I pair, current (user defined)";
      parameter OpenIPSL.Types.PerUnit Vq4 = 1 "Reactive Power V-I pair, voltage (user defined)";
      parameter OpenIPSL.Types.PerUnit Iq4 = 0.75 "Reactive Power V-I pair, current (user defined)";
      parameter OpenIPSL.Types.PerUnit Vp1 = 0.2 "Real Power V-I pair, voltage (user defined)";
      parameter OpenIPSL.Types.PerUnit Ip1 = 1.11 "Real Power V-I pair, current (user defined)";
      parameter OpenIPSL.Types.PerUnit Vp2 = 0.5 "Real Power V-I pair, voltage (user defined)";
      parameter OpenIPSL.Types.PerUnit Ip2 = 1.11 "Real Power V-I pair, current (user defined)";
      parameter OpenIPSL.Types.PerUnit Vp3 = 0.75 "Real Power V-I pair, voltage (user defined)";
      parameter OpenIPSL.Types.PerUnit Ip3 = 1.11 "Real Power V-I pair, current (user defined)";
      parameter OpenIPSL.Types.PerUnit Vp4 = 1 "Real Power V-I pair, voltage (user defined)";
      parameter OpenIPSL.Types.PerUnit Ip4 = 1.11 "Real Power V-I pair, current (user defined)";
      parameter Modelica.Units.SI.Time T = 999 "Battery discharge time";
      parameter OpenIPSL.Types.PerUnit SOCini = 0.5 "Initial state of charge";
      parameter OpenIPSL.Types.PerUnit SOCmax = 0.8 "Maximum allowable state of charge";
      parameter OpenIPSL.Types.PerUnit SOCmin = 0.2 "Minimum allowable state of charge";

      Integer Voltage_dip;

      Modelica.Blocks.Nonlinear.Limiter limiter5(uMax=Modelica.Constants.inf, uMin=0.01)
        annotation (Placement(transformation(extent={{-100,-90},{-80,-70}})));
      Modelica.Blocks.Math.Add add8(k2=-1)
        annotation (Placement(transformation(extent={{-242,-136},{-222,-116}})));
      Modelica.Blocks.Nonlinear.Limiter limiter7(uMax=dPmax, uMin=dPmin)
        annotation (Placement(transformation(extent={{-208,-136},{-188,-116}})));
      Modelica.Blocks.Continuous.Integrator integrator3(k=1/Tpord,
        initType=Modelica.Blocks.Types.Init.InitialState, y_start=Ip0*V0)
        annotation (Placement(transformation(extent={{-142,-136},{-122,-116}})));
      Modelica.Blocks.Nonlinear.Limiter limiter8(uMax=Pmax, uMin=Pmin)
        annotation (Placement(transformation(extent={{-102,-136},{-82,-116}})));
      Modelica.Blocks.Math.Add add7(k1=+1, k2=+1)
        annotation (Placement(transformation(extent={{-18,-140},{2,-120}})));
      Modelica.Blocks.Nonlinear.VariableLimiter variableLimiter2
        annotation (Placement(transformation(extent={{228,-170},{248,-150}})));
      Modelica.Blocks.Sources.RealExpression IPMAX(y=ccl_reecc.Ipmax) annotation (
          Placement(transformation(
            extent={{-10,10},{10,-10}},
            rotation=180,
            origin={240,-120})));
      Modelica.Blocks.Sources.RealExpression IPMIN(y=ccl_reecc.Ipmin) annotation (
          Placement(transformation(
            extent={{-10,10},{10,-10}},
            rotation=180,
            origin={240,-184})));
      Modelica.Blocks.Math.Product product2
        annotation (Placement(transformation(extent={{224,-136},{204,-116}})));
      Modelica.Blocks.Math.Product product3
        annotation (Placement(transformation(extent={{-10,-10},{10,10}},
            rotation=180,
            origin={214,-190})));
      Modelica.Blocks.Sources.RealExpression SOC_ipmax(y=sOC_logic.ipmax_SOC)
        annotation (Placement(transformation(extent={{250,-122},{230,-142}})));
      Modelica.Blocks.Sources.RealExpression SOC_ipmin(y=sOC_logic.ipmin_SOC)
        annotation (Placement(transformation(extent={{250,-186},{230,-206}})));
      Modelica.Blocks.Continuous.Integrator integrator1(k=1/T,
        initType=Modelica.Blocks.Types.Init.InitialState, y_start=p00)
        annotation (Placement(transformation(extent={{-134,-226},{-114,-206}})));
      Modelica.Blocks.Math.Add add1(k1=-1, k2=+1)
        annotation (Placement(transformation(extent={{-104,-244},{-84,-224}})));
      Modelica.Blocks.Nonlinear.Limiter limiter1(uMax=SOCmax, uMin=SOCmin)
        annotation (Placement(transformation(extent={{-74,-244},{-54,-224}})));
      OpenIPSL.Electrical.Renewables.PSSE.ElectricalController.BaseClasses.StateOfChargeLogic
        sOC_logic(SOCmin=SOCmin, SOCmax=SOCmax)
        annotation (Placement(transformation(extent={{-30,-244},{-10,-224}})));
      Modelica.Blocks.Nonlinear.Limiter limiter2(uMax=Qmax, uMin=Qmin)
        annotation (Placement(transformation(extent={{-164,136},{-144,156}})));
      Modelica.Blocks.Math.Add add2(k2=-1)
        annotation (Placement(transformation(extent={{-134,130},{-114,150}})));
      Modelica.Blocks.Nonlinear.Limiter limiter3(uMax=Vmax, uMin=Vmin)
        annotation (Placement(transformation(extent={{-40,124},{-20,144}})));
      Modelica.Blocks.Nonlinear.Limiter limiter4(uMax=Vmax, uMin=Vmin)
        annotation (Placement(transformation(extent={{26,124},{46,144}})));
      Modelica.Blocks.Math.Add add5(k2=-1)
        annotation (Placement(transformation(extent={{58,124},{78,144}})));
      Modelica.Blocks.Nonlinear.VariableLimiter variableLimiter1
        annotation (Placement(transformation(extent={{158,120},{178,140}})));
      Modelica.Blocks.Sources.RealExpression IQMAX_(y=ccl_reecc.Iqmax) annotation (
          Placement(transformation(
            extent={{-10,10},{10,-10}},
            rotation=180,
            origin={170,154})));
      Modelica.Blocks.Sources.RealExpression IQMIN_(y=ccl_reecc.Iqmin) annotation (
          Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={170,104})));
      Modelica.Blocks.Nonlinear.VariableLimiter variableLimiter
        annotation (Placement(transformation(extent={{266,150},{286,170}})));
      Modelica.Blocks.Sources.RealExpression IQMIN(y=ccl_reecc.Iqmin)
        annotation (Placement(transformation(extent={{286,150},{266,130}})));
      Modelica.Blocks.Sources.RealExpression IQMAX(y=ccl_reecc.Iqmax)
        annotation (Placement(transformation(extent={{286,174},{266,194}})));
      Modelica.Blocks.Tables.CombiTable1Ds VDL1(table=[Vq1,Iq1; Vq2,Iq2; Vq3,Iq3;
            Vq4,Iq4],
        smoothness=Modelica.Blocks.Types.Smoothness.LinearSegments,
        extrapolation=Modelica.Blocks.Types.Extrapolation.HoldLastPoint)
        annotation (Placement(transformation(extent={{56,-60},{76,-40}})));
      Modelica.Blocks.Tables.CombiTable1Ds VDL2(table=[Vp1,Ip1; Vp2,Ip2; Vp3,Ip3;
            Vp4,Ip4],
        smoothness=Modelica.Blocks.Types.Smoothness.LinearSegments,
        extrapolation=Modelica.Blocks.Types.Extrapolation.HoldLastPoint)
        annotation (Placement(transformation(extent={{56,-60},{76,-80}})));
      OpenIPSL.Electrical.Renewables.PSSE.ElectricalController.BaseClasses.CurrentLimitLogicREECC
        ccl_reecc(
        start_ii=-Iq0,
        start_ir=Ip0,
        Imax=Imax)
        annotation (Placement(transformation(extent={{92,-76},{124,-44}})));
      Modelica.Blocks.Sources.RealExpression IQCMD(y=Iqcmd)
        annotation (Placement(transformation(extent={{168,-48},{148,-28}})));
      Modelica.Blocks.Sources.BooleanConstant PQFLAG(k=pqflag)
        annotation (Placement(transformation(extent={{168,-50},{148,-70}})));
      Modelica.Blocks.Sources.RealExpression IPCMD(y=Ipcmd)
        annotation (Placement(transformation(extent={{168,-72},{148,-92}})));
      NonElectrical.Continuous.SimpleLag simpleLag(
        K=1,
        T=Trv,
        y_start=V0)
        annotation (Placement(transformation(extent={{-288,230},{-268,250}})));

      Modelica.Blocks.Sources.Constant SOC(k=SOCini)
        annotation (Placement(transformation(extent={{-200,-260},{-180,-240}})));
      Modelica.Blocks.Continuous.Integrator IGQ(
        k=Kqi,
        initType=Modelica.Blocks.Types.Init.InitialState,
        y_start=V0)
        annotation (Placement(transformation(extent={{-96,90},{-76,110}})));
      Modelica.Blocks.Math.Gain PGQ(k=Kqp)
        annotation (Placement(transformation(extent={{-94,130},{-74,150}})));
      Modelica.Blocks.Math.Add add3
        annotation (Placement(transformation(extent={{-66,124},{-46,144}})));
      Modelica.Blocks.Math.Gain PGV(k=Kvp)
        annotation (Placement(transformation(extent={{100,126},{120,146}})));
      Modelica.Blocks.Continuous.Integrator IGV(
        k=Kvi,
        initType=Modelica.Blocks.Types.Init.InitialState,
        y_start=-Iq0 - (-V0 + Vref0)*Kqv)
        annotation (Placement(transformation(extent={{100,92},{120,112}})));
      Modelica.Blocks.Math.Add add4
        annotation (Placement(transformation(extent={{128,120},{148,140}})));
      Modelica.Blocks.Math.Division division1
        annotation (Placement(transformation(extent={{-60,-110},{-40,-130}})));
      Modelica.Blocks.Math.Add add6(k2=-1)
        annotation (Placement(transformation(extent={{14,-210},{34,-190}})));
      Modelica.Blocks.Math.Gain PGP(k=Kpp)
        annotation (Placement(transformation(extent={{54,-190},{74,-170}})));
      Modelica.Blocks.Continuous.Integrator IGP(k=Kpi,     y_start=p00)
        annotation (Placement(transformation(extent={{54,-228},{74,-208}})));
      Modelica.Blocks.Math.Add add9(k1=+1)
        annotation (Placement(transformation(extent={{94,-210},{114,-190}})));
      NonElectrical.Continuous.SimpleLag simpleLag1(
        K=1,
        T=Trv,
        y_start=p00)
        annotation (Placement(transformation(extent={{-30,-204},{-10,-184}})));
      NonElectrical.Continuous.SimpleLag simpleLag2(
        K=1,
        T=Tp,
        y_start=p00)
        annotation (Placement(transformation(extent={{-286,150},{-266,170}})));
      NonElectrical.Continuous.SimpleLag simpleLag3(
        K=1,
        T=Tp,
        y_start=q00)
        annotation (Placement(transformation(extent={{-288,70},{-268,90}})));
      NonElectrical.Continuous.SimpleLag simpleLag4(
        K=1,
        T=Tp,
        y_start=q00)
        annotation (Placement(transformation(extent={{-220,-10},{-200,10}})));
    protected
      parameter Real pfaref=p00/sqrt(p00^2 +q00^2) "Power Factor of choice.";
      parameter OpenIPSL.Types.Angle pfangle = if q00 > 0 then acos(pfaref) else -acos(pfaref);
      parameter OpenIPSL.Types.PerUnit Ip0(fixed=false);
      parameter OpenIPSL.Types.PerUnit Iq0(fixed=false);
      parameter OpenIPSL.Types.PerUnit V0(fixed=false);
      parameter OpenIPSL.Types.PerUnit p00(fixed=false);
      parameter OpenIPSL.Types.PerUnit q00(fixed=false);
      parameter OpenIPSL.Types.PerUnit Vref0 = if vref0 == 0 then V0 else vref0;

    initial equation

      Ip0 = ip0;
      Iq0 = iq0;
      V0 = v0;
      p00 = p0;
      q00 = q0;
    equation

      Voltage_dip = if Vt<Vdip or Vt>Vup then 1 else 0;

      connect(add8.y,limiter7. u)
        annotation (Line(points={{-221,-126},{-210,-126}},
                                                         color={0,0,127}));
      connect(integrator3.y,limiter8. u)
        annotation (Line(points={{-121,-126},{-104,-126}},
                                                         color={0,0,127}));
      connect(add8.u2,limiter8. u) annotation (Line(points={{-244,-132},{-252,-132},
              {-252,-152},{-112,-152},{-112,-126},{-104,-126}},
                                                       color={0,0,127}));
      connect(Paux, add7.u2) annotation (Line(points={{-320,-160},{-26,-160},{-26,-136},
              {-20,-136}}, color={0,0,127}));
      connect(variableLimiter2.y, Ipcmd)
        annotation (Line(points={{249,-160},{288,-160},{288,-170},{310,-170}},
                                                         color={0,0,127}));
      connect(add7.y,variableLimiter2. u) annotation (Line(points={{3,-130},{114,-130},
              {114,-160},{226,-160}}, color={0,0,127}));
      connect(product2.y,variableLimiter2. limit1) annotation (Line(points={{203,-126},
              {180,-126},{180,-152},{226,-152}},
                                      color={0,0,127}));
      connect(IPMAX.y,product2. u1)
        annotation (Line(points={{229,-120},{226,-120}}, color={0,0,127}));
      connect(product3.u2,IPMIN. y)
        annotation (Line(points={{226,-184},{229,-184}}, color={0,0,127}));
      connect(variableLimiter2.limit2,product3. y) annotation (Line(points={{226,-168},
              {180,-168},{180,-190},{203,-190}}, color={0,0,127}));
      connect(product2.u2,SOC_ipmax. y)
        annotation (Line(points={{226,-132},{229,-132}},
                                                       color={0,0,127}));
      connect(product3.u1,SOC_ipmin. y)
        annotation (Line(points={{226,-196},{229,-196}}, color={0,0,127}));
      connect(integrator1.y,add1. u1) annotation (Line(points={{-113,-216},{-112,-216},
              {-112,-228},{-106,-228}}, color={0,0,127}));
      connect(add1.y,limiter1. u)
        annotation (Line(points={{-83,-234},{-76,-234}}, color={0,0,127}));
      connect(limiter1.y,sOC_logic. SOC)
        annotation (Line(points={{-53,-234},{-32,-234}},color={0,0,127}));
      connect(limiter2.y,add2. u1)
        annotation (Line(points={{-143,146},{-136,146}}, color={0,0,127}));
      connect(limiter4.y,add5. u1) annotation (Line(points={{47,134},{52,134},{52,140},
              {56,140}}, color={0,0,127}));
      connect(IQMAX_.y,variableLimiter1. limit1) annotation (Line(points={{159,154},
              {152,154},{152,138},{156,138}}, color={0,0,127}));
      connect(IQMIN_.y,variableLimiter1. limit2) annotation (Line(points={{159,104},
              {152,104},{152,122},{156,122}},
                                            color={0,0,127}));
      connect(IQMIN.y,variableLimiter. limit2) annotation (Line(points={{265,140},{258,
              140},{258,152},{264,152}},
                                      color={0,0,127}));
      connect(IQMAX.y,variableLimiter. limit1) annotation (Line(points={{265,184},{258,
              184},{258,168},{264,168}},
                                       color={0,0,127}));
      connect(VDL2.y[1], ccl_reecc.VDL2_out)
        annotation (Line(points={{77,-70},{88.8,-69.6}}, color={0,0,127}));
      connect(VDL1.y[1], ccl_reecc.VDL1_out) annotation (Line(points={{77,-50},{77,-50.4},
              {88.8,-50.4}}, color={0,0,127}));
      connect(PQFLAG.y, ccl_reecc.pqflag)
        annotation (Line(points={{147,-60},{88.8,-60}},  color={255,0,255}));
      connect(IQCMD.y, ccl_reecc.Iqcmd) annotation (Line(points={{147,-38},{132,-38},{132,-50.4},{127.2,-50.4}},
                                          color={0,0,127}));
      connect(IPCMD.y, ccl_reecc.Ipcmd) annotation (Line(points={{147,-82},{132,-82},{132,-69.6},{127.2,-69.6}},
                                          color={0,0,127}));
      connect(variableLimiter.y, Iqcmd)
        annotation (Line(points={{287,160},{294,160},{294,170},{310,170}},
                                                     color={0,0,127}));
      connect(Vt, simpleLag.u)
        annotation (Line(points={{-320,240},{-290,240}}, color={0,0,127}));
      connect(SOC.y, add1.u2) annotation (Line(points={{-179,-250},{-128,-250},{-128,
              -240},{-106,-240}}, color={0,0,127}));
      connect(PGQ.y, add3.u1)
        annotation (Line(points={{-73,140},{-68,140}}, color={0,0,127}));
      connect(IGQ.y, add3.u2) annotation (Line(points={{-75,100},{-68,100},{-68,
              128}}, color={0,0,127}));
      connect(add3.y, limiter3.u)
        annotation (Line(points={{-45,134},{-42,134}}, color={0,0,127}));
      connect(PGV.y, add4.u1)
        annotation (Line(points={{121,136},{126,136}}, color={0,0,127}));
      connect(IGV.y, add4.u2) annotation (Line(points={{121,102},{121,112},{126,
              112},{126,124}}, color={0,0,127}));
      connect(add4.y, variableLimiter1.u)
        annotation (Line(points={{149,130},{156,130}}, color={0,0,127}));
      connect(PGQ.u, add2.y)
        annotation (Line(points={{-96,140},{-113,140}}, color={0,0,127}));
      connect(IGQ.u, add2.y) annotation (Line(points={{-98,100},{-108,100},{
              -108,140},{-113,140}}, color={0,0,127}));
      connect(limiter3.y, limiter4.u)
        annotation (Line(points={{-19,134},{24,134}}, color={0,0,127}));
      connect(PGV.u, add5.y) annotation (Line(points={{98,136},{88.5,136},{88.5,
              134},{79,134}}, color={0,0,127}));
      connect(IGV.u, add5.y) annotation (Line(points={{98,102},{88,102},{88,134},
              {79,134}}, color={0,0,127}));
      connect(variableLimiter1.y, variableLimiter.u) annotation (Line(points={{
              179,130},{202,130},{202,132},{228,132},{228,160},{264,160}},
            color={0,0,127}));
      connect(simpleLag.y, VDL1.u) annotation (Line(points={{-267,240},{-244,
              240},{-244,-50},{54,-50}}, color={0,0,127}));
      connect(VDL2.u, VDL1.u) annotation (Line(points={{54,-70},{22,-70},{22,
              -50},{54,-50}}, color={0,0,127}));
      connect(add5.u2, simpleLag.y) annotation (Line(points={{56,128},{52,128},
              {52,84},{-6,84},{-6,240},{-267,240}}, color={0,0,127}));
      connect(limiter5.u, VDL1.u) annotation (Line(points={{-102,-80},{-246,-80},
              {-246,-50},{54,-50}}, color={0,0,127}));
      connect(limiter7.y, integrator3.u)
        annotation (Line(points={{-187,-126},{-144,-126}}, color={0,0,127}));
      connect(limiter8.y, division1.u1)
        annotation (Line(points={{-81,-126},{-62,-126}}, color={0,0,127}));
      connect(limiter5.y, division1.u2) annotation (Line(points={{-79,-80},{-70,
              -80},{-70,-114},{-62,-114}}, color={0,0,127}));
      connect(division1.y, add7.u1) annotation (Line(points={{-39,-120},{-39,
              -124},{-20,-124}}, color={0,0,127}));
      connect(IGP.y,add9. u2) annotation (Line(points={{75,-218},{80,-218},{80,
              -206},{92,-206}},
                     color={0,0,127}));
      connect(PGP.y,add9. u1) annotation (Line(points={{75,-180},{75,-194},{92,
              -194}},    color={0,0,127}));
      connect(simpleLag1.y,add6. u1)
        annotation (Line(points={{-9,-194},{12,-194}},   color={0,0,127}));
      connect(IGP.u,add6. y) annotation (Line(points={{52,-218},{44,-218},{44,
              -200},{35,-200}},      color={0,0,127}));
      connect(PGP.u,add6. y) annotation (Line(points={{52,-180},{44,-180},{44,
              -200},{35,-200}},      color={0,0,127}));
      connect(simpleLag1.u, Pref) annotation (Line(points={{-32,-194},{-150,
              -194},{-150,-176},{-270,-176},{-270,-80},{-320,-80}}, color={0,0,
              127}));
      connect(add9.y, add8.u1) annotation (Line(points={{115,-200},{130,-200},{
              130,-170},{-264,-170},{-264,-120},{-244,-120}}, color={0,0,127}));
      connect(Pe, simpleLag2.u)
        annotation (Line(points={{-320,160},{-288,160}}, color={0,0,127}));
      connect(simpleLag2.y, integrator1.u) annotation (Line(points={{-265,160},
              {-260,160},{-260,14},{-282,14},{-282,-216},{-136,-216}}, color={0,
              0,127}));
      connect(add6.u2, integrator1.u) annotation (Line(points={{12,-206},{8,
              -206},{8,-40},{-282,-40},{-282,-216},{-136,-216}}, color={0,0,127}));
      connect(Qgen, simpleLag3.u)
        annotation (Line(points={{-320,80},{-290,80}}, color={0,0,127}));
      connect(simpleLag3.y, add2.u2) annotation (Line(points={{-267,80},{-136,
              80},{-136,134}}, color={0,0,127}));
      connect(Qext, simpleLag4.u)
        annotation (Line(points={{-320,0},{-222,0}}, color={0,0,127}));
      connect(simpleLag4.y, limiter2.u) annotation (Line(points={{-199,0},{-190,
              0},{-190,146},{-166,146}}, color={0,0,127}));
      annotation (Documentation(info="<html>
<p>
The REECCU1 component is an augmented version of the existing renewable energy electrical control (REECA1) model, and can be utilized to represent
both type 3 and type 4 wind turbine electrical controllers as well as photovoltaic electrical controllers. The REECCU1 component can be connected to the
plant controller (REPCA1). This electrical controller provides real (Ipcmd) and reactive (Iqcmd) current commands to the REGCA1 component, which are the outputs
of this component.
</p>
<p>
For initialization purposes, there are 5 inputs that are derived from the inverter component: initial real and reactive injection currents (IP0 and IQ0), initial terminal voltage (v_0), and initial active and reactive power
injections (p_0 and q_0).
</p>
<p>
In terms of connectivity with other components to form the renewable source, the REECCU1 component has six inputs, three of which are connected to the inverter component
(for instance REGCA1), two more that can either be constant values from the power flow initialization or come from the connection to the plant controller, and
an auxiliary input variable that is rarely used (usually constant and zero). The three REECCU1 inputs that take in values from the output of the inverter model
are Vt, Pgen, and Qgen while the two inputs that could potentially be constant valued or come from the plant controller are Pref, and Qext.
</p>
<p>The modelling of such devices is based, mainly, on the following references:</p>
<ul>
<li>Siemens: \"PSS&reg;E Model Library\"
<a href=\"modelica://OpenIPSL.UsersGuide.References\">[PSSE-MODELS]</a>,</li>
<li>WECC: \"Battery Storage Dynamic Modeling Guideline\"
<a href=\"modelica://OpenIPSL.UsersGuide.References\">[WECCBattery]</a>.</li>
</ul>

</html>"));
    end REECCU1_Local_V_Q_Control2;

    model REECCU1_Constant_Q_Control
      "Electrical control model for utility scale battery energy storage"
      extends
        OpenIPSL.Electrical.Renewables.PSSE.ElectricalController.BaseClasses.BaseREECC(
         Iqcmd, Ipcmd);

      parameter OpenIPSL.Types.PerUnit Vdip = -99 "Low voltage threshold to activate reactive current injection logic (0.85 - 0.9)";
      parameter OpenIPSL.Types.PerUnit Vup = 99 "Voltage above which reactive current injection logic is activated (>1.1)";
      parameter OpenIPSL.Types.Time Trv = 0.01 "Filter time constant for voltage measurement (0.01 - 0.02)";
      parameter OpenIPSL.Types.PerUnit dbd1 = 0 "Voltage error dead band lower threshold (-0.1 - 0)";
      parameter OpenIPSL.Types.PerUnit dbd2 = 0 "Voltage error dead band upper threshold (0 - 0.1)";
      parameter Real Kqv = 0 "Reactive current injection gain during over and undervoltage conditions (0 - 10)";
      parameter OpenIPSL.Types.PerUnit Iqh1 = 1 "Upper limit on reactive current injection Iqinj (1 - 1.1)";
      parameter OpenIPSL.Types.PerUnit Iql1 = -1 "Lower limit on reactive current injection Iqinj (-1.1 - 1)";
      parameter OpenIPSL.Types.PerUnit vref0 = 1 "User defined voltage reference (0.95 - 1.05)";
      parameter OpenIPSL.Types.Time Tp = 0.01 "Filter time constant for electrical power (0.01 - 0.1)";
      parameter OpenIPSL.Types.PerUnit Qmax = 1 "Upper limits of the limit for reactive power regulator (0.4 - 1.0)";
      parameter OpenIPSL.Types.PerUnit Qmin = -1 "Lower limits of the limit for reactive power regulator (-1.0 - -0.4)";
      parameter OpenIPSL.Types.PerUnit Vmax = 1.1 "Maximum limit for voltage control (1.05 - 1.1)";
      parameter OpenIPSL.Types.PerUnit Vmin = 0.9 "Lower limits of input signals (0.9 - 0.95)";
      parameter Real Kqp = 0 "Reactive power regulator proportional gain (No predefined range)";
      parameter Real Kqi = 0.1 "Reactive power regulator integral gain (No predefined range)";
      parameter Real Kvp = 0 "Voltage regulator proportional gain (No predefined range)";
      parameter Real Kvi = 40 "Voltage regulator integral gain (No predefined range)";
      parameter OpenIPSL.Types.Time Tiq = 0.01 "Time constant on lag delay (0.01 - 0.02)";
      parameter Real dPmax = 99 "Power reference maximum ramp rate (No predefined range)";
      parameter Real dPmin = -99 "Lower limits of input signals (No predefined range)";
      parameter OpenIPSL.Types.PerUnit Pmax = 1 "Maximum power limit";
      parameter OpenIPSL.Types.PerUnit Pmin = 0 "Minimum power limit";
      parameter OpenIPSL.Types.PerUnit Imax = 1.1 "Maximum limit on total converter current (1.1 - 1.3)";
      parameter OpenIPSL.Types.Time Tpord = 0.02 "Power filter time constant (0.01 - 0.02) ";
      parameter OpenIPSL.Types.PerUnit Vq1 = 0.2 "Reactive Power V-I pair, voltage (user defined)";
      parameter OpenIPSL.Types.PerUnit Iq1 = 0.75 "Reactive Power V-I pair, current (user defined)";
      parameter OpenIPSL.Types.PerUnit Vq2 = 0.5 "Reactive Power V-I pair, voltage (user defined)";
      parameter OpenIPSL.Types.PerUnit Iq2 = 0.75 "Reactive Power V-I pair, current (user defined)";
      parameter OpenIPSL.Types.PerUnit Vq3 = 0.75 "Reactive Power V-I pair, voltage (user defined)";
      parameter OpenIPSL.Types.PerUnit Iq3 = 0.75 "Reactive Power V-I pair, current (user defined)";
      parameter OpenIPSL.Types.PerUnit Vq4 = 1 "Reactive Power V-I pair, voltage (user defined)";
      parameter OpenIPSL.Types.PerUnit Iq4 = 0.75 "Reactive Power V-I pair, current (user defined)";
      parameter OpenIPSL.Types.PerUnit Vp1 = 0.2 "Real Power V-I pair, voltage (user defined)";
      parameter OpenIPSL.Types.PerUnit Ip1 = 1.11 "Real Power V-I pair, current (user defined)";
      parameter OpenIPSL.Types.PerUnit Vp2 = 0.5 "Real Power V-I pair, voltage (user defined)";
      parameter OpenIPSL.Types.PerUnit Ip2 = 1.11 "Real Power V-I pair, current (user defined)";
      parameter OpenIPSL.Types.PerUnit Vp3 = 0.75 "Real Power V-I pair, voltage (user defined)";
      parameter OpenIPSL.Types.PerUnit Ip3 = 1.11 "Real Power V-I pair, current (user defined)";
      parameter OpenIPSL.Types.PerUnit Vp4 = 1 "Real Power V-I pair, voltage (user defined)";
      parameter OpenIPSL.Types.PerUnit Ip4 = 1.11 "Real Power V-I pair, current (user defined)";
      parameter Modelica.Units.SI.Time T = 999 "Battery discharge time";
      parameter OpenIPSL.Types.PerUnit SOCini = 0.5 "Initial state of charge";
      parameter OpenIPSL.Types.PerUnit SOCmax = 0.8 "Maximum allowable state of charge";
      parameter OpenIPSL.Types.PerUnit SOCmin = 0.2 "Minimum allowable state of charge";

      Integer Voltage_dip;

      Modelica.Blocks.Math.Division division1
        annotation (Placement(transformation(extent={{-54,-120},{-34,-140}})));
      Modelica.Blocks.Nonlinear.Limiter limiter5(uMax=Modelica.Constants.inf, uMin=0.01)
        annotation (Placement(transformation(extent={{-100,-90},{-80,-70}})));
      Modelica.Blocks.Math.Add add8(k2=-1)
        annotation (Placement(transformation(extent={{-242,-136},{-222,-116}})));
      Modelica.Blocks.Nonlinear.Limiter limiter7(uMax=dPmax, uMin=dPmin)
        annotation (Placement(transformation(extent={{-208,-136},{-188,-116}})));
      Modelica.Blocks.Continuous.Integrator integrator3(k=1/Tpord,
        initType=Modelica.Blocks.Types.Init.InitialState, y_start=Ip0*V0)
        annotation (Placement(transformation(extent={{-142,-136},{-122,-116}})));
      Modelica.Blocks.Nonlinear.Limiter limiter8(uMax=Pmax, uMin=Pmin)
        annotation (Placement(transformation(extent={{-102,-136},{-82,-116}})));
      Modelica.Blocks.Math.Add add7(k1=+1, k2=+1)
        annotation (Placement(transformation(extent={{-18,-140},{2,-120}})));
      Modelica.Blocks.Nonlinear.VariableLimiter variableLimiter2
        annotation (Placement(transformation(extent={{228,-170},{248,-150}})));
      Modelica.Blocks.Sources.RealExpression IPMAX(y=ccl_reecc.Ipmax) annotation (
          Placement(transformation(
            extent={{-10,10},{10,-10}},
            rotation=180,
            origin={240,-120})));
      Modelica.Blocks.Sources.RealExpression IPMIN(y=ccl_reecc.Ipmin) annotation (
          Placement(transformation(
            extent={{-10,10},{10,-10}},
            rotation=180,
            origin={240,-184})));
      Modelica.Blocks.Math.Product product2
        annotation (Placement(transformation(extent={{224,-136},{204,-116}})));
      Modelica.Blocks.Math.Product product3
        annotation (Placement(transformation(extent={{-10,-10},{10,10}},
            rotation=180,
            origin={214,-190})));
      Modelica.Blocks.Sources.RealExpression SOC_ipmax(y=sOC_logic.ipmax_SOC)
        annotation (Placement(transformation(extent={{250,-122},{230,-142}})));
      Modelica.Blocks.Sources.RealExpression SOC_ipmin(y=sOC_logic.ipmin_SOC)
        annotation (Placement(transformation(extent={{250,-186},{230,-206}})));
      Modelica.Blocks.Continuous.Integrator integrator1(k=1/T,
        initType=Modelica.Blocks.Types.Init.InitialState, y_start=p00)
        annotation (Placement(transformation(extent={{-134,-226},{-114,-206}})));
      Modelica.Blocks.Math.Add add1(k1=-1, k2=+1)
        annotation (Placement(transformation(extent={{-104,-244},{-84,-224}})));
      Modelica.Blocks.Nonlinear.Limiter limiter1(uMax=SOCmax, uMin=SOCmin)
        annotation (Placement(transformation(extent={{-74,-244},{-54,-224}})));
      OpenIPSL.Electrical.Renewables.PSSE.ElectricalController.BaseClasses.StateOfChargeLogic
        sOC_logic(SOCmin=SOCmin, SOCmax=SOCmax)
        annotation (Placement(transformation(extent={{-30,-244},{-10,-224}})));
      Modelica.Blocks.Nonlinear.VariableLimiter variableLimiter
        annotation (Placement(transformation(extent={{266,150},{286,170}})));
      Modelica.Blocks.Sources.RealExpression IQMIN(y=ccl_reecc.Iqmin)
        annotation (Placement(transformation(extent={{286,150},{266,130}})));
      Modelica.Blocks.Sources.RealExpression IQMAX(y=ccl_reecc.Iqmax)
        annotation (Placement(transformation(extent={{286,174},{266,194}})));
      Modelica.Blocks.Nonlinear.Limiter limiter6(uMax=Modelica.Constants.inf, uMin=0.01)
        annotation (Placement(transformation(extent={{-28,-20},{-8,0}})));
      Modelica.Blocks.Math.Division division
        annotation (Placement(transformation(extent={{12,0},{32,20}})));
      Modelica.Blocks.Tables.CombiTable1Ds VDL1(table=[Vq1,Iq1; Vq2,Iq2; Vq3,Iq3;
            Vq4,Iq4],
        smoothness=Modelica.Blocks.Types.Smoothness.LinearSegments,
        extrapolation=Modelica.Blocks.Types.Extrapolation.HoldLastPoint)
        annotation (Placement(transformation(extent={{56,-60},{76,-40}})));
      Modelica.Blocks.Tables.CombiTable1Ds VDL2(table=[Vp1,Ip1; Vp2,Ip2; Vp3,Ip3;
            Vp4,Ip4],
        smoothness=Modelica.Blocks.Types.Smoothness.LinearSegments,
        extrapolation=Modelica.Blocks.Types.Extrapolation.HoldLastPoint)
        annotation (Placement(transformation(extent={{56,-60},{76,-80}})));
      OpenIPSL.Electrical.Renewables.PSSE.ElectricalController.BaseClasses.CurrentLimitLogicREECC
        ccl_reecc(
        start_ii=-Iq0,
        start_ir=Ip0,
        Imax=Imax)
        annotation (Placement(transformation(extent={{92,-76},{124,-44}})));
      Modelica.Blocks.Sources.RealExpression IQCMD(y=Iqcmd)
        annotation (Placement(transformation(extent={{168,-48},{148,-28}})));
      Modelica.Blocks.Sources.BooleanConstant PQFLAG(k=pqflag)
        annotation (Placement(transformation(extent={{168,-50},{148,-70}})));
      Modelica.Blocks.Sources.RealExpression IPCMD(y=Ipcmd)
        annotation (Placement(transformation(extent={{168,-72},{148,-92}})));
      NonElectrical.Continuous.SimpleLag simpleLag(
        K=1,
        T=Trv,
        y_start=V0)
        annotation (Placement(transformation(extent={{-288,230},{-268,250}})));

      Modelica.Blocks.Sources.Constant SOC(k=SOCini)
        annotation (Placement(transformation(extent={{-200,-260},{-180,-240}})));
      NonElectrical.Continuous.SimpleLag simpleLag1(
        K=1,
        T=Tiq,
        y_start=-Iq0)
        annotation (Placement(transformation(extent={{60,0},{80,20}})));
      NonElectrical.Continuous.SimpleLag simpleLag2(
        K=1,
        T=Trv,
        y_start=q00)
        annotation (Placement(transformation(extent={{-220,-10},{-200,10}})));
    protected
      parameter Real pfaref=p00/sqrt(p00^2 +q00^2) "Power Factor of choice.";
      parameter OpenIPSL.Types.Angle pfangle = if q00 > 0 then acos(pfaref) else -acos(pfaref);
      parameter OpenIPSL.Types.PerUnit Ip0(fixed=false);
      parameter OpenIPSL.Types.PerUnit Iq0(fixed=false);
      parameter OpenIPSL.Types.PerUnit V0(fixed=false);
      parameter OpenIPSL.Types.PerUnit p00(fixed=false);
      parameter OpenIPSL.Types.PerUnit q00(fixed=false);
      parameter OpenIPSL.Types.PerUnit Vref0 = if vref0 == 0 then V0 else vref0;

    initial equation

      Ip0 = ip0;
      Iq0 = iq0;
      V0 = v0;
      p00 = p0;
      q00 = q0;
    equation

      Voltage_dip = if Vt<Vdip or Vt>Vup then 1 else 0;

      connect(limiter5.y,division1. u2) annotation (Line(points={{-79,-80},{-68,-80},
              {-68,-124},{-56,-124}}, color={0,0,127}));
      connect(add8.y,limiter7. u)
        annotation (Line(points={{-221,-126},{-210,-126}},
                                                         color={0,0,127}));
      connect(integrator3.y,limiter8. u)
        annotation (Line(points={{-121,-126},{-104,-126}},
                                                         color={0,0,127}));
      connect(add8.u2,limiter8. u) annotation (Line(points={{-244,-132},{-252,-132},
              {-252,-152},{-112,-152},{-112,-126},{-104,-126}},
                                                       color={0,0,127}));
      connect(add8.u1, Pref)
        annotation (Line(points={{-244,-120},{-292,-120},{-292,-80},{-320,-80}},
                                                           color={0,0,127}));
      connect(limiter8.y, division1.u1) annotation (Line(points={{-81,-126},{-72,-126},
              {-72,-136},{-56,-136}}, color={0,0,127}));
      connect(division1.y, add7.u1) annotation (Line(points={{-33,-130},{-28,-130},{
              -28,-124},{-20,-124}}, color={0,0,127}));
      connect(Paux, add7.u2) annotation (Line(points={{-320,-160},{-26,-160},{-26,-136},
              {-20,-136}}, color={0,0,127}));
      connect(variableLimiter2.y, Ipcmd)
        annotation (Line(points={{249,-160},{288,-160},{288,-170},{310,-170}},
                                                         color={0,0,127}));
      connect(add7.y,variableLimiter2. u) annotation (Line(points={{3,-130},{114,-130},
              {114,-160},{226,-160}}, color={0,0,127}));
      connect(product2.y,variableLimiter2. limit1) annotation (Line(points={{203,-126},
              {180,-126},{180,-152},{226,-152}},
                                      color={0,0,127}));
      connect(IPMAX.y,product2. u1)
        annotation (Line(points={{229,-120},{226,-120}}, color={0,0,127}));
      connect(product3.u2,IPMIN. y)
        annotation (Line(points={{226,-184},{229,-184}}, color={0,0,127}));
      connect(variableLimiter2.limit2,product3. y) annotation (Line(points={{226,-168},
              {180,-168},{180,-190},{203,-190}}, color={0,0,127}));
      connect(product2.u2,SOC_ipmax. y)
        annotation (Line(points={{226,-132},{229,-132}},
                                                       color={0,0,127}));
      connect(product3.u1,SOC_ipmin. y)
        annotation (Line(points={{226,-196},{229,-196}}, color={0,0,127}));
      connect(integrator1.y,add1. u1) annotation (Line(points={{-113,-216},{-112,-216},
              {-112,-228},{-106,-228}}, color={0,0,127}));
      connect(add1.y,limiter1. u)
        annotation (Line(points={{-83,-234},{-76,-234}}, color={0,0,127}));
      connect(limiter1.y,sOC_logic. SOC)
        annotation (Line(points={{-53,-234},{-32,-234}},color={0,0,127}));
      connect(IQMIN.y,variableLimiter. limit2) annotation (Line(points={{265,140},{258,
              140},{258,152},{264,152}},
                                      color={0,0,127}));
      connect(IQMAX.y,variableLimiter. limit1) annotation (Line(points={{265,184},{258,
              184},{258,168},{264,168}},
                                       color={0,0,127}));
      connect(limiter6.y,division. u2) annotation (Line(points={{-7,-10},{0,-10},{0,
              4},{10,4}},color={0,0,127}));
      connect(VDL2.u,limiter6. u) annotation (Line(points={{54,-70},{-36,-70},{-36,-10},
              {-30,-10}}, color={0,0,127}));
      connect(VDL1.u,limiter6. u) annotation (Line(points={{54,-50},{-36,-50},{-36,-10},
              {-30,-10}}, color={0,0,127}));
      connect(VDL2.y[1], ccl_reecc.VDL2_out)
        annotation (Line(points={{77,-70},{88.8,-69.6}}, color={0,0,127}));
      connect(VDL1.y[1], ccl_reecc.VDL1_out) annotation (Line(points={{77,-50},{77,-50.4},
              {88.8,-50.4}}, color={0,0,127}));
      connect(PQFLAG.y, ccl_reecc.pqflag)
        annotation (Line(points={{147,-60},{88.8,-60}},  color={255,0,255}));
      connect(IQCMD.y, ccl_reecc.Iqcmd) annotation (Line(points={{147,-38},{132,-38},{132,-50.4},{127.2,-50.4}},
                                          color={0,0,127}));
      connect(IPCMD.y, ccl_reecc.Ipcmd) annotation (Line(points={{147,-82},{132,-82},{132,-69.6},{127.2,-69.6}},
                                          color={0,0,127}));
      connect(variableLimiter.y, Iqcmd)
        annotation (Line(points={{287,160},{294,160},{294,170},{310,170}},
                                                     color={0,0,127}));
      connect(Vt, simpleLag.u)
        annotation (Line(points={{-320,240},{-290,240}}, color={0,0,127}));
      connect(SOC.y, add1.u2) annotation (Line(points={{-179,-250},{-128,-250},{-128,
              -240},{-106,-240}}, color={0,0,127}));
      connect(division.y, simpleLag1.u)
        annotation (Line(points={{33,10},{58,10}}, color={0,0,127}));
      connect(simpleLag1.y, variableLimiter.u) annotation (Line(points={{81,10},
              {224,10},{224,160},{264,160}}, color={0,0,127}));
      connect(simpleLag.y, limiter6.u) annotation (Line(points={{-267,240},{-88,
              240},{-88,-10},{-30,-10}}, color={0,0,127}));
      connect(limiter7.y, integrator3.u)
        annotation (Line(points={{-187,-126},{-144,-126}}, color={0,0,127}));
      connect(limiter5.u, limiter6.u) annotation (Line(points={{-102,-80},{-242,
              -80},{-242,240},{-88,240},{-88,-10},{-30,-10}}, color={0,0,127}));
      connect(integrator1.u, Pe) annotation (Line(points={{-136,-216},{-280,
              -216},{-280,160},{-320,160}}, color={0,0,127}));
      connect(simpleLag2.u, Qext)
        annotation (Line(points={{-222,0},{-320,0}}, color={0,0,127}));
      connect(simpleLag2.y, division.u1) annotation (Line(points={{-199,0},{
              -134,0},{-134,16},{10,16}}, color={0,0,127}));
      annotation (Documentation(info="<html>
<p>
The REECCU1 component is an augmented version of the existing renewable energy electrical control (REECA1) model, and can be utilized to represent
both type 3 and type 4 wind turbine electrical controllers as well as photovoltaic electrical controllers. The REECCU1 component can be connected to the
plant controller (REPCA1). This electrical controller provides real (Ipcmd) and reactive (Iqcmd) current commands to the REGCA1 component, which are the outputs
of this component.
</p>
<p>
For initialization purposes, there are 5 inputs that are derived from the inverter component: initial real and reactive injection currents (IP0 and IQ0), initial terminal voltage (v_0), and initial active and reactive power
injections (p_0 and q_0).
</p>
<p>
In terms of connectivity with other components to form the renewable source, the REECCU1 component has six inputs, three of which are connected to the inverter component
(for instance REGCA1), two more that can either be constant values from the power flow initialization or come from the connection to the plant controller, and
an auxiliary input variable that is rarely used (usually constant and zero). The three REECCU1 inputs that take in values from the output of the inverter model
are Vt, Pgen, and Qgen while the two inputs that could potentially be constant valued or come from the plant controller are Pref, and Qext.
</p>
<p>The modelling of such devices is based, mainly, on the following references:</p>
<ul>
<li>Siemens: \"PSS&reg;E Model Library\"
<a href=\"modelica://OpenIPSL.UsersGuide.References\">[PSSE-MODELS]</a>,</li>
<li>WECC: \"Battery Storage Dynamic Modeling Guideline\"
<a href=\"modelica://OpenIPSL.UsersGuide.References\">[WECCBattery]</a>.</li>
</ul>

</html>"));
    end REECCU1_Constant_Q_Control;

    model REECCU1_Local_V_Q_Control_for_Linearization
      "Electrical control model for utility scale battery energy storage"
      extends
        OpenIPSL.Electrical.Renewables.PSSE.ElectricalController.BaseClasses.BaseREECC(
         Iqcmd, Ipcmd);

      parameter OpenIPSL.Types.PerUnit Vdip = -99 "Low voltage threshold to activate reactive current injection logic (0.85 - 0.9)";
      parameter OpenIPSL.Types.PerUnit Vup = 99 "Voltage above which reactive current injection logic is activated (>1.1)";
      parameter OpenIPSL.Types.Time Trv = 0.01 "Filter time constant for voltage measurement (0.01 - 0.02)";
      parameter OpenIPSL.Types.PerUnit dbd1 = 0 "Voltage error dead band lower threshold (-0.1 - 0)";
      parameter OpenIPSL.Types.PerUnit dbd2 = 0 "Voltage error dead band upper threshold (0 - 0.1)";
      parameter Real Kqv = 0 "Reactive current injection gain during over and undervoltage conditions (0 - 10)";
      parameter OpenIPSL.Types.PerUnit Iqh1 = 1 "Upper limit on reactive current injection Iqinj (1 - 1.1)";
      parameter OpenIPSL.Types.PerUnit Iql1 = -1 "Lower limit on reactive current injection Iqinj (-1.1 - 1)";
      parameter OpenIPSL.Types.PerUnit vref0 = 1 "User defined voltage reference (0.95 - 1.05)";
      parameter OpenIPSL.Types.Time Tp = 0.01 "Filter time constant for electrical power (0.01 - 0.1)";
      parameter OpenIPSL.Types.PerUnit Qmax = 1 "Upper limits of the limit for reactive power regulator (0.4 - 1.0)";
      parameter OpenIPSL.Types.PerUnit Qmin = -1 "Lower limits of the limit for reactive power regulator (-1.0 - -0.4)";
      parameter OpenIPSL.Types.PerUnit Vmax = 1.1 "Maximum limit for voltage control (1.05 - 1.1)";
      parameter OpenIPSL.Types.PerUnit Vmin = 0.9 "Lower limits of input signals (0.9 - 0.95)";
      parameter Real Kqp = 0 "Reactive power regulator proportional gain (No predefined range)";
      parameter Real Kqi = 0.1 "Reactive power regulator integral gain (No predefined range)";
      parameter Real Kvp = 0 "Voltage regulator proportional gain (No predefined range)";
      parameter Real Kvi = 40 "Voltage regulator integral gain (No predefined range)";
      parameter Real Kpp = 1 "Voltage regulator proportional gain (No predefined range)";
      parameter Real Kpi = 1 "Voltage regulator integral gain (No predefined range)";
      parameter OpenIPSL.Types.Time Tiq = 0.01 "Time constant on lag delay (0.01 - 0.02)";
      parameter Real dPmax = 99 "Power reference maximum ramp rate (No predefined range)";
      parameter Real dPmin = -99 "Lower limits of input signals (No predefined range)";
      parameter OpenIPSL.Types.PerUnit Pmax = 1 "Maximum power limit";
      parameter OpenIPSL.Types.PerUnit Pmin = 0 "Minimum power limit";
      parameter OpenIPSL.Types.PerUnit Imax = 1.1 "Maximum limit on total converter current (1.1 - 1.3)";
      parameter OpenIPSL.Types.Time Tpord = 0.02 "Power filter time constant (0.01 - 0.02) ";
      parameter OpenIPSL.Types.PerUnit Vq1 = 0.2 "Reactive Power V-I pair, voltage (user defined)";
      parameter OpenIPSL.Types.PerUnit Iq1 = 0.75 "Reactive Power V-I pair, current (user defined)";
      parameter OpenIPSL.Types.PerUnit Vq2 = 0.5 "Reactive Power V-I pair, voltage (user defined)";
      parameter OpenIPSL.Types.PerUnit Iq2 = 0.75 "Reactive Power V-I pair, current (user defined)";
      parameter OpenIPSL.Types.PerUnit Vq3 = 0.75 "Reactive Power V-I pair, voltage (user defined)";
      parameter OpenIPSL.Types.PerUnit Iq3 = 0.75 "Reactive Power V-I pair, current (user defined)";
      parameter OpenIPSL.Types.PerUnit Vq4 = 1 "Reactive Power V-I pair, voltage (user defined)";
      parameter OpenIPSL.Types.PerUnit Iq4 = 0.75 "Reactive Power V-I pair, current (user defined)";
      parameter OpenIPSL.Types.PerUnit Vp1 = 0.2 "Real Power V-I pair, voltage (user defined)";
      parameter OpenIPSL.Types.PerUnit Ip1 = 1.11 "Real Power V-I pair, current (user defined)";
      parameter OpenIPSL.Types.PerUnit Vp2 = 0.5 "Real Power V-I pair, voltage (user defined)";
      parameter OpenIPSL.Types.PerUnit Ip2 = 1.11 "Real Power V-I pair, current (user defined)";
      parameter OpenIPSL.Types.PerUnit Vp3 = 0.75 "Real Power V-I pair, voltage (user defined)";
      parameter OpenIPSL.Types.PerUnit Ip3 = 1.11 "Real Power V-I pair, current (user defined)";
      parameter OpenIPSL.Types.PerUnit Vp4 = 1 "Real Power V-I pair, voltage (user defined)";
      parameter OpenIPSL.Types.PerUnit Ip4 = 1.11 "Real Power V-I pair, current (user defined)";
      parameter Modelica.Units.SI.Time T = 999 "Battery discharge time";
      parameter OpenIPSL.Types.PerUnit SOCini = 0.5 "Initial state of charge";
      parameter OpenIPSL.Types.PerUnit SOCmax = 0.8 "Maximum allowable state of charge";
      parameter OpenIPSL.Types.PerUnit SOCmin = 0.2 "Minimum allowable state of charge";

      Integer Voltage_dip;

      Modelica.Blocks.Nonlinear.Limiter limiter5(uMax=Modelica.Constants.inf, uMin=0.01)
        annotation (Placement(transformation(extent={{-100,-90},{-80,-70}})));
      Modelica.Blocks.Math.Add add8(k2=-1)
        annotation (Placement(transformation(extent={{-242,-136},{-222,-116}})));
      Modelica.Blocks.Nonlinear.Limiter limiter7(uMax=dPmax, uMin=dPmin)
        annotation (Placement(transformation(extent={{-208,-136},{-188,-116}})));
      Modelica.Blocks.Continuous.Integrator integrator3(k=1/Tpord,
        initType=Modelica.Blocks.Types.Init.InitialState, y_start=Ip0*V0)
        annotation (Placement(transformation(extent={{-142,-136},{-122,-116}})));
      Modelica.Blocks.Nonlinear.Limiter limiter8(uMax=Pmax, uMin=Pmin)
        annotation (Placement(transformation(extent={{-102,-136},{-82,-116}})));
      Modelica.Blocks.Math.Add add7(k1=+1, k2=+1)
        annotation (Placement(transformation(extent={{-18,-140},{2,-120}})));
      Modelica.Blocks.Nonlinear.VariableLimiter variableLimiter2
        annotation (Placement(transformation(extent={{228,-170},{248,-150}})));
      Modelica.Blocks.Sources.RealExpression IPMAX(y=ccl_reecc.Ipmax) annotation (
          Placement(transformation(
            extent={{-10,10},{10,-10}},
            rotation=180,
            origin={240,-120})));
      Modelica.Blocks.Sources.RealExpression IPMIN(y=ccl_reecc.Ipmin) annotation (
          Placement(transformation(
            extent={{-10,10},{10,-10}},
            rotation=180,
            origin={240,-184})));
      Modelica.Blocks.Math.Product product2
        annotation (Placement(transformation(extent={{224,-136},{204,-116}})));
      Modelica.Blocks.Math.Product product3
        annotation (Placement(transformation(extent={{-10,-10},{10,10}},
            rotation=180,
            origin={214,-190})));
      Modelica.Blocks.Sources.RealExpression SOC_ipmax(y=1)
        annotation (Placement(transformation(extent={{250,-122},{230,-142}})));
      Modelica.Blocks.Sources.RealExpression SOC_ipmin(y=1)
        annotation (Placement(transformation(extent={{250,-186},{230,-206}})));
      Modelica.Blocks.Nonlinear.Limiter limiter2(uMax=Qmax, uMin=Qmin)
        annotation (Placement(transformation(extent={{-164,136},{-144,156}})));
      Modelica.Blocks.Math.Add add2(k2=-1)
        annotation (Placement(transformation(extent={{-134,130},{-114,150}})));
      Modelica.Blocks.Nonlinear.Limiter limiter3(uMax=Vmax, uMin=Vmin)
        annotation (Placement(transformation(extent={{-40,124},{-20,144}})));
      Modelica.Blocks.Nonlinear.Limiter limiter4(uMax=Vmax, uMin=Vmin)
        annotation (Placement(transformation(extent={{26,124},{46,144}})));
      Modelica.Blocks.Math.Add add5(k2=-1)
        annotation (Placement(transformation(extent={{58,124},{78,144}})));
      Modelica.Blocks.Nonlinear.VariableLimiter variableLimiter1
        annotation (Placement(transformation(extent={{158,120},{178,140}})));
      Modelica.Blocks.Sources.RealExpression IQMAX_(y=ccl_reecc.Iqmax) annotation (
          Placement(transformation(
            extent={{-10,10},{10,-10}},
            rotation=180,
            origin={170,154})));
      Modelica.Blocks.Sources.RealExpression IQMIN_(y=ccl_reecc.Iqmin) annotation (
          Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={170,104})));
      Modelica.Blocks.Nonlinear.VariableLimiter variableLimiter
        annotation (Placement(transformation(extent={{266,150},{286,170}})));
      Modelica.Blocks.Sources.RealExpression IQMIN(y=ccl_reecc.Iqmin)
        annotation (Placement(transformation(extent={{286,150},{266,130}})));
      Modelica.Blocks.Sources.RealExpression IQMAX(y=ccl_reecc.Iqmax)
        annotation (Placement(transformation(extent={{286,174},{266,194}})));
      Modelica.Blocks.Tables.CombiTable1Ds VDL1(table=[Vq1,Iq1; Vq2,Iq2; Vq3,Iq3;
            Vq4,Iq4],
        smoothness=Modelica.Blocks.Types.Smoothness.LinearSegments,
        extrapolation=Modelica.Blocks.Types.Extrapolation.HoldLastPoint)
        annotation (Placement(transformation(extent={{56,-60},{76,-40}})));
      Modelica.Blocks.Tables.CombiTable1Ds VDL2(table=[Vp1,Ip1; Vp2,Ip2; Vp3,Ip3;
            Vp4,Ip4],
        smoothness=Modelica.Blocks.Types.Smoothness.LinearSegments,
        extrapolation=Modelica.Blocks.Types.Extrapolation.HoldLastPoint)
        annotation (Placement(transformation(extent={{56,-60},{76,-80}})));
      OpenIPSL.Electrical.Renewables.PSSE.ElectricalController.BaseClasses.CurrentLimitLogicREECC
        ccl_reecc(
        start_ii=-Iq0,
        start_ir=Ip0,
        Imax=Imax)
        annotation (Placement(transformation(extent={{92,-76},{124,-44}})));
      Modelica.Blocks.Sources.RealExpression IQCMD(y=Iqcmd)
        annotation (Placement(transformation(extent={{168,-48},{148,-28}})));
      Modelica.Blocks.Sources.BooleanConstant PQFLAG(k=pqflag)
        annotation (Placement(transformation(extent={{168,-50},{148,-70}})));
      Modelica.Blocks.Sources.RealExpression IPCMD(y=Ipcmd)
        annotation (Placement(transformation(extent={{168,-72},{148,-92}})));
      NonElectrical.Continuous.SimpleLag simpleLag(
        K=1,
        T=Trv,
        y_start=V0)
        annotation (Placement(transformation(extent={{-288,230},{-268,250}})));

      Modelica.Blocks.Continuous.Integrator IGQ(
        k=Kqi,
        initType=Modelica.Blocks.Types.Init.InitialState,
        y_start=V0)
        annotation (Placement(transformation(extent={{-96,90},{-76,110}})));
      Modelica.Blocks.Math.Gain PGQ(k=Kqp)
        annotation (Placement(transformation(extent={{-94,130},{-74,150}})));
      Modelica.Blocks.Math.Add add3
        annotation (Placement(transformation(extent={{-66,124},{-46,144}})));
      Modelica.Blocks.Math.Gain PGV(k=Kvp)
        annotation (Placement(transformation(extent={{100,126},{120,146}})));
      Modelica.Blocks.Continuous.Integrator IGV(
        k=Kvi,
        initType=Modelica.Blocks.Types.Init.InitialState,
        y_start=-Iq0 - (-V0 + Vref0)*Kqv)
        annotation (Placement(transformation(extent={{100,92},{120,112}})));
      Modelica.Blocks.Math.Add add4
        annotation (Placement(transformation(extent={{128,120},{148,140}})));
      Modelica.Blocks.Math.Division division1
        annotation (Placement(transformation(extent={{-60,-110},{-40,-130}})));
      Modelica.Blocks.Math.Add add6(k2=-1)
        annotation (Placement(transformation(extent={{14,-210},{34,-190}})));
      Modelica.Blocks.Math.Gain PGP(k=Kpp)
        annotation (Placement(transformation(extent={{54,-190},{74,-170}})));
      Modelica.Blocks.Continuous.Integrator IGP(k=Kpi,     y_start=p00)
        annotation (Placement(transformation(extent={{54,-230},{74,-210}})));
      Modelica.Blocks.Math.Add add9(k1=+1)
        annotation (Placement(transformation(extent={{94,-210},{114,-190}})));
      NonElectrical.Continuous.SimpleLag simpleLag1(
        K=1,
        T=Trv,
        y_start=p00)
        annotation (Placement(transformation(extent={{-30,-204},{-10,-184}})));
      NonElectrical.Continuous.SimpleLag simpleLag2(
        K=1,
        T=Tp,
        y_start=p00)
        annotation (Placement(transformation(extent={{-286,150},{-266,170}})));
      NonElectrical.Continuous.SimpleLag simpleLag3(
        K=1,
        T=Tp,
        y_start=q00)
        annotation (Placement(transformation(extent={{-288,70},{-268,90}})));
      NonElectrical.Continuous.SimpleLag simpleLag4(
        K=1,
        T=Tp,
        y_start=q00)
        annotation (Placement(transformation(extent={{-288,-10},{-268,10}})));
    protected
      parameter Real pfaref=p00/sqrt(p00^2 +q00^2) "Power Factor of choice.";
      parameter OpenIPSL.Types.Angle pfangle = if q00 > 0 then acos(pfaref) else -acos(pfaref);
      parameter OpenIPSL.Types.PerUnit Ip0(fixed=false);
      parameter OpenIPSL.Types.PerUnit Iq0(fixed=false);
      parameter OpenIPSL.Types.PerUnit V0(fixed=false);
      parameter OpenIPSL.Types.PerUnit p00(fixed=false);
      parameter OpenIPSL.Types.PerUnit q00(fixed=false);
      parameter OpenIPSL.Types.PerUnit Vref0 = if vref0 == 0 then V0 else vref0;

    initial equation

      Ip0 = ip0;
      Iq0 = iq0;
      V0 = v0;
      p00 = p0;
      q00 = q0;
    equation

      Voltage_dip = if Vt<Vdip or Vt>Vup then 1 else 0;

      connect(add8.y,limiter7. u)
        annotation (Line(points={{-221,-126},{-210,-126}},
                                                         color={0,0,127}));
      connect(integrator3.y,limiter8. u)
        annotation (Line(points={{-121,-126},{-104,-126}},
                                                         color={0,0,127}));
      connect(add8.u2,limiter8. u) annotation (Line(points={{-244,-132},{-252,-132},
              {-252,-152},{-112,-152},{-112,-126},{-104,-126}},
                                                       color={0,0,127}));
      connect(Paux, add7.u2) annotation (Line(points={{-320,-160},{-26,-160},{-26,-136},
              {-20,-136}}, color={0,0,127}));
      connect(variableLimiter2.y, Ipcmd)
        annotation (Line(points={{249,-160},{288,-160},{288,-170},{310,-170}},
                                                         color={0,0,127}));
      connect(add7.y,variableLimiter2. u) annotation (Line(points={{3,-130},{114,-130},
              {114,-160},{226,-160}}, color={0,0,127}));
      connect(product2.y,variableLimiter2. limit1) annotation (Line(points={{203,-126},
              {180,-126},{180,-152},{226,-152}},
                                      color={0,0,127}));
      connect(IPMAX.y,product2. u1)
        annotation (Line(points={{229,-120},{226,-120}}, color={0,0,127}));
      connect(product3.u2,IPMIN. y)
        annotation (Line(points={{226,-184},{229,-184}}, color={0,0,127}));
      connect(variableLimiter2.limit2,product3. y) annotation (Line(points={{226,-168},
              {180,-168},{180,-190},{203,-190}}, color={0,0,127}));
      connect(product2.u2,SOC_ipmax. y)
        annotation (Line(points={{226,-132},{229,-132}},
                                                       color={0,0,127}));
      connect(product3.u1,SOC_ipmin. y)
        annotation (Line(points={{226,-196},{229,-196}}, color={0,0,127}));
      connect(limiter2.y,add2. u1)
        annotation (Line(points={{-143,146},{-136,146}}, color={0,0,127}));
      connect(limiter4.y,add5. u1) annotation (Line(points={{47,134},{52,134},{52,140},
              {56,140}}, color={0,0,127}));
      connect(IQMAX_.y,variableLimiter1. limit1) annotation (Line(points={{159,154},
              {152,154},{152,138},{156,138}}, color={0,0,127}));
      connect(IQMIN_.y,variableLimiter1. limit2) annotation (Line(points={{159,104},
              {152,104},{152,122},{156,122}},
                                            color={0,0,127}));
      connect(IQMIN.y,variableLimiter. limit2) annotation (Line(points={{265,140},{258,
              140},{258,152},{264,152}},
                                      color={0,0,127}));
      connect(IQMAX.y,variableLimiter. limit1) annotation (Line(points={{265,184},{258,
              184},{258,168},{264,168}},
                                       color={0,0,127}));
      connect(VDL2.y[1], ccl_reecc.VDL2_out)
        annotation (Line(points={{77,-70},{88.8,-69.6}}, color={0,0,127}));
      connect(VDL1.y[1], ccl_reecc.VDL1_out) annotation (Line(points={{77,-50},{77,-50.4},
              {88.8,-50.4}}, color={0,0,127}));
      connect(PQFLAG.y, ccl_reecc.pqflag)
        annotation (Line(points={{147,-60},{88.8,-60}},  color={255,0,255}));
      connect(IQCMD.y, ccl_reecc.Iqcmd) annotation (Line(points={{147,-38},{132,-38},{132,-50.4},{127.2,-50.4}},
                                          color={0,0,127}));
      connect(IPCMD.y, ccl_reecc.Ipcmd) annotation (Line(points={{147,-82},{132,-82},{132,-69.6},{127.2,-69.6}},
                                          color={0,0,127}));
      connect(variableLimiter.y, Iqcmd)
        annotation (Line(points={{287,160},{294,160},{294,170},{310,170}},
                                                     color={0,0,127}));
      connect(Vt, simpleLag.u)
        annotation (Line(points={{-320,240},{-290,240}}, color={0,0,127}));
      connect(PGQ.y, add3.u1)
        annotation (Line(points={{-73,140},{-68,140}}, color={0,0,127}));
      connect(IGQ.y, add3.u2) annotation (Line(points={{-75,100},{-68,100},{-68,
              128}}, color={0,0,127}));
      connect(add3.y, limiter3.u)
        annotation (Line(points={{-45,134},{-42,134}}, color={0,0,127}));
      connect(PGV.y, add4.u1)
        annotation (Line(points={{121,136},{126,136}}, color={0,0,127}));
      connect(IGV.y, add4.u2) annotation (Line(points={{121,102},{121,112},{126,
              112},{126,124}}, color={0,0,127}));
      connect(add4.y, variableLimiter1.u)
        annotation (Line(points={{149,130},{156,130}}, color={0,0,127}));
      connect(PGQ.u, add2.y)
        annotation (Line(points={{-96,140},{-113,140}}, color={0,0,127}));
      connect(IGQ.u, add2.y) annotation (Line(points={{-98,100},{-108,100},{
              -108,140},{-113,140}}, color={0,0,127}));
      connect(limiter3.y, limiter4.u)
        annotation (Line(points={{-19,134},{24,134}}, color={0,0,127}));
      connect(PGV.u, add5.y) annotation (Line(points={{98,136},{88.5,136},{88.5,
              134},{79,134}}, color={0,0,127}));
      connect(IGV.u, add5.y) annotation (Line(points={{98,102},{88,102},{88,134},
              {79,134}}, color={0,0,127}));
      connect(variableLimiter1.y, variableLimiter.u) annotation (Line(points={{
              179,130},{202,130},{202,132},{228,132},{228,160},{264,160}},
            color={0,0,127}));
      connect(simpleLag.y, VDL1.u) annotation (Line(points={{-267,240},{-244,
              240},{-244,-50},{54,-50}}, color={0,0,127}));
      connect(VDL2.u, VDL1.u) annotation (Line(points={{54,-70},{22,-70},{22,
              -50},{54,-50}}, color={0,0,127}));
      connect(add5.u2, simpleLag.y) annotation (Line(points={{56,128},{52,128},
              {52,84},{-6,84},{-6,240},{-267,240}}, color={0,0,127}));
      connect(limiter5.u, VDL1.u) annotation (Line(points={{-102,-80},{-246,-80},
              {-246,-50},{54,-50}}, color={0,0,127}));
      connect(limiter7.y, integrator3.u)
        annotation (Line(points={{-187,-126},{-144,-126}}, color={0,0,127}));
      connect(limiter8.y, division1.u1)
        annotation (Line(points={{-81,-126},{-62,-126}}, color={0,0,127}));
      connect(limiter5.y, division1.u2) annotation (Line(points={{-79,-80},{-70,
              -80},{-70,-114},{-62,-114}}, color={0,0,127}));
      connect(division1.y, add7.u1) annotation (Line(points={{-39,-120},{-39,
              -124},{-20,-124}}, color={0,0,127}));
      connect(IGP.y,add9. u2) annotation (Line(points={{75,-220},{80,-220},{80,
              -206},{92,-206}},
                     color={0,0,127}));
      connect(PGP.y,add9. u1) annotation (Line(points={{75,-180},{75,-194},{92,
              -194}},    color={0,0,127}));
      connect(simpleLag1.y,add6. u1)
        annotation (Line(points={{-9,-194},{12,-194}},   color={0,0,127}));
      connect(IGP.u,add6. y) annotation (Line(points={{52,-220},{44,-220},{44,
              -200},{35,-200}},      color={0,0,127}));
      connect(PGP.u,add6. y) annotation (Line(points={{52,-180},{44,-180},{44,
              -200},{35,-200}},      color={0,0,127}));
      connect(simpleLag1.u, Pref) annotation (Line(points={{-32,-194},{-150,
              -194},{-150,-176},{-270,-176},{-270,-80},{-320,-80}}, color={0,0,
              127}));
      connect(add9.y, add8.u1) annotation (Line(points={{115,-200},{130,-200},{
              130,-170},{-264,-170},{-264,-120},{-244,-120}}, color={0,0,127}));
      connect(Pe, simpleLag2.u)
        annotation (Line(points={{-320,160},{-288,160}}, color={0,0,127}));
      connect(simpleLag2.y, add6.u2) annotation (Line(points={{-265,160},{-260,160},
              {-260,-206},{12,-206}}, color={0,0,127}));
      connect(Qgen, simpleLag3.u)
        annotation (Line(points={{-320,80},{-290,80}}, color={0,0,127}));
      connect(simpleLag3.y, add2.u2) annotation (Line(points={{-267,80},{-136,
              80},{-136,134}}, color={0,0,127}));
      connect(Qext, simpleLag4.u)
        annotation (Line(points={{-320,0},{-290,0}}, color={0,0,127}));
      connect(simpleLag4.y, limiter2.u) annotation (Line(points={{-267,0},{-234,
              0},{-234,2},{-202,2},{-202,146},{-166,146}}, color={0,0,127}));
      annotation (Documentation(info="<html>
<p>
The REECCU1 component is an augmented version of the existing renewable energy electrical control (REECA1) model, and can be utilized to represent
both type 3 and type 4 wind turbine electrical controllers as well as photovoltaic electrical controllers. The REECCU1 component can be connected to the
plant controller (REPCA1). This electrical controller provides real (Ipcmd) and reactive (Iqcmd) current commands to the REGCA1 component, which are the outputs
of this component.
</p>
<p>
For initialization purposes, there are 5 inputs that are derived from the inverter component: initial real and reactive injection currents (IP0 and IQ0), initial terminal voltage (v_0), and initial active and reactive power
injections (p_0 and q_0).
</p>
<p>
In terms of connectivity with other components to form the renewable source, the REECCU1 component has six inputs, three of which are connected to the inverter component
(for instance REGCA1), two more that can either be constant values from the power flow initialization or come from the connection to the plant controller, and
an auxiliary input variable that is rarely used (usually constant and zero). The three REECCU1 inputs that take in values from the output of the inverter model
are Vt, Pgen, and Qgen while the two inputs that could potentially be constant valued or come from the plant controller are Pref, and Qext.
</p>
<p>The modelling of such devices is based, mainly, on the following references:</p>
<ul>
<li>Siemens: \"PSS&reg;E Model Library\"
<a href=\"modelica://OpenIPSL.UsersGuide.References\">[PSSE-MODELS]</a>,</li>
<li>WECC: \"Battery Storage Dynamic Modeling Guideline\"
<a href=\"modelica://OpenIPSL.UsersGuide.References\">[WECCBattery]</a>.</li>
</ul>

</html>"));
    end REECCU1_Local_V_Q_Control_for_Linearization;

    model REECB1_Local_V_Q_Control_PI
      "Electrical control model for large scale photovoltaic"
      extends
        OpenIPSL.Electrical.Renewables.PSSE.ElectricalController.BaseClasses.BaseREECB(
         Iqcmd, Ipcmd);

      parameter OpenIPSL.Types.PerUnit Vdip = -99 "Low voltage threshold to activate reactive current injection logic (0.85 - 0.9)";
      parameter OpenIPSL.Types.PerUnit Vup = 99 "Voltage above which reactive current injection logic is activated (>1.1)";
      parameter OpenIPSL.Types.Time Trv = 0 "Filter time constant for voltage measurement (0.01 - 0.02)";
      parameter OpenIPSL.Types.PerUnit dbd1 = -0.05 "Voltage error dead band lower threshold (-0.1 - 0)";
      parameter OpenIPSL.Types.PerUnit dbd2 = 0.05 "Voltage error dead band upper threshold (0 - 0.1)";
      parameter Real Kqv = 0 "Reactive current injection gain during over and undervoltage conditions (0 - 10)";
      parameter OpenIPSL.Types.PerUnit Iqh1 = 1.05 "Upper limit on reactive current injection Iqinj (1 - 1.1)";
      parameter OpenIPSL.Types.PerUnit Iql1 = -1.05 "Lower limit on reactive current injection Iqinj (-1.1 - 1)";
      parameter OpenIPSL.Types.PerUnit vref0 = 1 "User defined voltage reference (0.95 - 1.05)";
      parameter OpenIPSL.Types.Time Tp = 0.05 "Filter time constant for electrical power (0.01 - 0.1)";
      parameter OpenIPSL.Types.PerUnit Qmax = 0.4360 "Upper limits of the limit for reactive power regulator (0.4 - 1.0)";
      parameter OpenIPSL.Types.PerUnit Qmin = -0.4360 "Lower limits of the limit for reactive power regulator (-1.0 - -0.4)";
      parameter OpenIPSL.Types.PerUnit Vmax = 1.1 "Maximum limit for voltage control (1.05 - 1.1)";
      parameter OpenIPSL.Types.PerUnit Vmin = 0.9 "Lower limits of input signals (0.9 - 0.95)";
      parameter Real Kqp = 1 "Reactive power regulator proportional gain (No predefined range)";
      parameter Real Kqi = 1 "Reactive power regulator integral gain (No predefined range)";
      parameter Real Kvp = 1 "Voltage regulator proportional gain (No predefined range)";
      parameter Real Kvi = 1 "Voltage regulator integral gain (No predefined range)";
      parameter Real Kpp = 1 "Voltage regulator proportional gain (No predefined range)";
      parameter Real Kpi = 1 "Voltage regulator integral gain (No predefined range)";
      parameter OpenIPSL.Types.Time Tiq = 0.02 "Time constant on lag delay (0.01 - 0.02)";
      parameter Real dPmax = 99 "Power reference maximum ramp rate (No predefined range)";
      parameter Real dPmin = -99 "Lower limits of input signals (No predefined range)";
      parameter OpenIPSL.Types.PerUnit Pmax = 1 "Maximum power limit";
      parameter OpenIPSL.Types.PerUnit Pmin = 0 "Minimum power limit";
      parameter OpenIPSL.Types.PerUnit Imax = 1.82 "Maximum limit on total converter current (1.1 - 1.3)";
      parameter OpenIPSL.Types.Time Tpord = 0.02 "Power filter time constant (0.01 - 0.02) ";

      Integer Voltage_dip;

      Modelica.Blocks.Nonlinear.Limiter limiter1(uMax=Qmax, uMin=Qmin)
        annotation (Placement(transformation(extent={{-162,56},{-142,76}})));
      Modelica.Blocks.Math.Add add1(k2=-1)
        annotation (Placement(transformation(extent={{-132,50},{-112,70}})));
      Modelica.Blocks.Continuous.Integrator IGQ(
        k=Kqi,
        initType=Modelica.Blocks.Types.Init.InitialState,
        y_start=V0)
        annotation (Placement(transformation(extent={{-94,10},{-74,30}})));
      Modelica.Blocks.Math.Gain PGQ(k=Kqp)
        annotation (Placement(transformation(extent={{-92,50},{-72,70}})));
      Modelica.Blocks.Math.Add add2
        annotation (Placement(transformation(extent={{-66,44},{-46,64}})));
      Modelica.Blocks.Nonlinear.Limiter limiter2(uMax=Vmax, uMin=Vmin)
        annotation (Placement(transformation(extent={{-8,44},{12,64}})));
      Modelica.Blocks.Math.Add add4(k2=-1)
        annotation (Placement(transformation(extent={{60,44},{80,64}})));
      Modelica.Blocks.Math.Gain PGV(k=Kvp)
        annotation (Placement(transformation(extent={{100,44},{120,64}})));
      Modelica.Blocks.Continuous.Integrator IGV(
        k=Kvi,
        initType=Modelica.Blocks.Types.Init.InitialState,
        y_start=-Iq0)
        annotation (Placement(transformation(extent={{100,10},{120,30}})));
      Modelica.Blocks.Math.Add add5
        annotation (Placement(transformation(extent={{128,38},{148,58}})));
      Modelica.Blocks.Nonlinear.VariableLimiter variableLimiter2
        annotation (Placement(transformation(extent={{162,38},{182,58}})));
      Modelica.Blocks.Sources.RealExpression IQMAX_(y=ccl.Iqmax) annotation (
          Placement(transformation(
            extent={{-10,10},{10,-10}},
            rotation=180,
            origin={172,74})));
      Modelica.Blocks.Sources.RealExpression IQMIN_(y=ccl.Iqmin) annotation (
          Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={172,24})));
      Modelica.Blocks.Nonlinear.VariableLimiter variableLimiter
        annotation (Placement(transformation(extent={{264,70},{284,90}})));
      Modelica.Blocks.Sources.RealExpression IQMIN(y=ccl.Iqmin)
        annotation (Placement(transformation(extent={{284,70},{264,50}})));
      Modelica.Blocks.Sources.RealExpression IQMAX(y=ccl.Iqmax)
        annotation (Placement(transformation(extent={{284,94},{264,114}})));
      Modelica.Blocks.Nonlinear.VariableLimiter variableLimiter1
        annotation (Placement(transformation(extent={{178,-180},{198,-160}})));
      Modelica.Blocks.Sources.RealExpression IPMAX(y=ccl.Ipmax) annotation (
          Placement(transformation(
            extent={{10,-10},{-10,10}},
            origin={188,-140})));
      Modelica.Blocks.Sources.RealExpression IPMIN(y=ccl.Ipmin)
        annotation (Placement(transformation(extent={{198,-210},{178,-190}})));
      NonElectrical.Continuous.SimpleLag simpleLag(
        K=1,
        T=Trv,
        y_start=V0)
        annotation (Placement(transformation(extent={{-286,150},{-266,170}})));
      Modelica.Blocks.Math.Division division1
        annotation (Placement(transformation(extent={{0,-180},{20,-160}})));
      Modelica.Blocks.Nonlinear.Limiter limiter5(uMax=Modelica.Constants.inf, uMin=0.01)
        annotation (Placement(transformation(extent={{-132,-220},{-112,-200}})));
      Modelica.Blocks.Nonlinear.Limiter limiter8(uMax=Pmax, uMin=Pmin)
        annotation (Placement(transformation(extent={{-70,-176},{-50,-156}})));
      OpenIPSL.Electrical.Renewables.PSSE.ElectricalController.BaseClasses.CurrentLimitLogicREECB
        ccl(
        start_ii=-Iq0,
        start_ir=Ip0,
        Imax=Imax)
        annotation (Placement(transformation(extent={{260,-40},{280,-20}})));
      Modelica.Blocks.Sources.BooleanConstant Pqflag_logic(k=pqflag)
        annotation (Placement(transformation(extent={{220,-40},{240,-20}})));

      NonElectrical.Continuous.SimpleLag simpleLag1(
        K=1,
        T=Trv,
        y_start=q00)
        annotation (Placement(transformation(extent={{-270,-90},{-250,-70}})));
      NonElectrical.Continuous.SimpleLag simpleLag2(
        K=1,
        T=Trv,
        y_start=Ip0*V0)
        annotation (Placement(transformation(extent={{-110,-176},{-90,-156}})));
      Modelica.Blocks.Math.Add add6(k2=-1)
        annotation (Placement(transformation(extent={{52,-272},{72,-252}})));
      Modelica.Blocks.Math.Gain PGP(k=Kpp)
        annotation (Placement(transformation(extent={{92,-252},{112,-232}})));
      Modelica.Blocks.Continuous.Integrator IGP(k=Kpi,
                                                     y_start=Ip0*V0)
        annotation (Placement(transformation(extent={{92,-292},{112,-272}})));
      Modelica.Blocks.Math.Add add9(k1=+1)
        annotation (Placement(transformation(extent={{132,-272},{152,-252}})));
      NonElectrical.Continuous.SimpleLag simpleLag3(
        K=1,
        T=Tp,
        y_start=p00)
        annotation (Placement(transformation(extent={{-284,70},{-264,90}})));
      NonElectrical.Continuous.SimpleLag simpleLag4(
        K=1,
        T=Trv,
        y_start=p00)
        annotation (Placement(transformation(extent={{-278,-170},{-258,-150}})));
      NonElectrical.Continuous.SimpleLag simpleLag5(
        K=1,
        T=Trv,
        y_start=q00)
        annotation (Placement(transformation(extent={{-280,-10},{-260,10}})));
    protected
      parameter Real pfaref = p00/sqrt(p00^2 +q00^2) "Power Factor of choice.";
      parameter OpenIPSL.Types.Angle pfangle = if q00 > 0 then acos(pfaref) else -acos(pfaref);
      parameter OpenIPSL.Types.PerUnit Ip0(fixed=false);
      parameter OpenIPSL.Types.PerUnit Iq0(fixed=false);
      parameter OpenIPSL.Types.PerUnit V0(fixed=false);
      parameter OpenIPSL.Types.PerUnit p00(fixed=false);
      parameter OpenIPSL.Types.PerUnit q00(fixed=false);
      parameter OpenIPSL.Types.PerUnit Vref0 = if vref0 == 0 then V0 else vref0;

    initial equation

      Ip0 = ip0;
      Iq0 = iq0;
      V0 = v0;
      p00 = p0;
      q00 = q0;

    equation

      Voltage_dip = if Vt<Vdip or Vt>Vup then 1 else 0;
      connect(limiter1.y,add1. u1)
        annotation (Line(points={{-141,66},{-134,66}}, color={0,0,127}));
      connect(PGQ.y, add2.u1)
        annotation (Line(points={{-71,60},{-68,60}}, color={0,0,127}));
      connect(IGQ.y, add2.u2) annotation (Line(points={{-73,20},{-70,20},{-70,
              48},{-68,48}}, color={0,0,127}));
      connect(add2.y,limiter2. u)
        annotation (Line(points={{-45,54},{-10,54}}, color={0,0,127}));
      connect(PGV.y, add5.u1)
        annotation (Line(points={{121,54},{126,54}}, color={0,0,127}));
      connect(IGV.y, add5.u2) annotation (Line(points={{121,20},{126,20},{126,
              42}}, color={0,0,127}));
      connect(add5.y,variableLimiter2. u)
        annotation (Line(points={{149,48},{160,48}}, color={0,0,127}));
      connect(IQMAX_.y,variableLimiter2. limit1) annotation (Line(points={{161,74},{
              154,74},{154,56},{160,56}}, color={0,0,127}));
      connect(IQMIN_.y,variableLimiter2. limit2) annotation (Line(points={{161,24},{
              154,24},{154,40},{160,40}}, color={0,0,127}));
      connect(IQMIN.y,variableLimiter. limit2) annotation (Line(points={{263,60},{256,
              60},{256,72},{262,72}}, color={0,0,127}));
      connect(IQMAX.y,variableLimiter. limit1) annotation (Line(points={{263,104},{256,
              104},{256,88},{262,88}}, color={0,0,127}));
      connect(IPMIN.y,variableLimiter1. limit2) annotation (Line(points={{177,-200},
              {177,-189},{176,-189},{176,-178}},
                                             color={0,0,127}));
      connect(IPMAX.y,variableLimiter1. limit1) annotation (Line(points={{177,-140},
              {177,-151},{176,-151},{176,-162}},
                                             color={0,0,127}));
      connect(variableLimiter1.y, Ipcmd) annotation (Line(points={{199,-170},{310,-170}},
                                    color={0,0,127}));
      connect(Vt, simpleLag.u)
        annotation (Line(points={{-320,160},{-288,160}}, color={0,0,127}));
      connect(limiter5.y,division1. u2) annotation (Line(points={{-111,-210},{-111,-212},
              {-12,-212},{-12,-176},{-2,-176}},
                                      color={0,0,127}));
      connect(limiter8.y,division1. u1) annotation (Line(points={{-49,-166},{-25.5,-166},
              {-25.5,-164},{-2,-164}},color={0,0,127}));
      connect(division1.y, variableLimiter1.u)
        annotation (Line(points={{21,-170},{176,-170}}, color={0,0,127}));
      connect(variableLimiter.y, Iqcmd)
        annotation (Line(points={{285,80},{292,80},{292,170},{310,170}},
                                                     color={0,0,127}));
      connect(Pqflag_logic.y, ccl.Pqflag)
        annotation (Line(points={{241,-30},{258,-30}}, color={255,0,255}));
      connect(ccl.Iqcmd, Iqcmd) annotation (Line(points={{282,-25},{292,-25},{292,170},{310,170}},
                         color={0,0,127}));
      connect(ccl.Ipcmd, Ipcmd) annotation (Line(points={{282,-35},{292,-35},{292,-170},{310,-170}},
                          color={0,0,127}));
      connect(PGQ.u, IGQ.u) annotation (Line(points={{-94,60},{-98,60},{-98,20},
              {-96,20}}, color={0,0,127}));
      connect(PGV.u, IGV.u) annotation (Line(points={{98,54},{90,54},{90,20},{
              98,20}}, color={0,0,127}));
      connect(variableLimiter2.y, variableLimiter.u) annotation (Line(points={{
              183,48},{232,48},{232,80},{262,80}}, color={0,0,127}));
      connect(add4.y, PGV.u)
        annotation (Line(points={{81,54},{98,54}}, color={0,0,127}));
      connect(add4.u2, simpleLag.y) annotation (Line(points={{58,48},{58,28},{
              86,28},{86,160},{-265,160}}, color={0,0,127}));
      connect(limiter5.u, simpleLag.y) annotation (Line(points={{-134,-210},{
              -188,-210},{-188,160},{-265,160}}, color={0,0,127}));
      connect(limiter2.y, add4.u1)
        annotation (Line(points={{13,54},{13,60},{58,60}}, color={0,0,127}));
      connect(Qext, simpleLag1.u)
        annotation (Line(points={{-320,-80},{-272,-80}}, color={0,0,127}));
      connect(simpleLag1.y, limiter1.u) annotation (Line(points={{-249,-80},{
              -212,-80},{-212,66},{-164,66}}, color={0,0,127}));
      connect(add1.y, PGQ.u)
        annotation (Line(points={{-111,60},{-94,60}}, color={0,0,127}));
      connect(simpleLag2.y, limiter8.u)
        annotation (Line(points={{-89,-166},{-72,-166}}, color={0,0,127}));
      connect(add6.y, PGP.u) annotation (Line(points={{73,-262},{80,-262},{80,-242},
              {90,-242}}, color={0,0,127}));
      connect(IGP.u, PGP.u) annotation (Line(points={{90,-282},{80,-282},{80,-242},{
              90,-242}}, color={0,0,127}));
      connect(PGP.y, add9.u1) annotation (Line(points={{113,-242},{120,-242},{120,-256},
              {130,-256}}, color={0,0,127}));
      connect(IGP.y, add9.u2) annotation (Line(points={{113,-282},{122,-282},{122,-268},
              {130,-268}}, color={0,0,127}));
      connect(Pe, simpleLag3.u)
        annotation (Line(points={{-320,80},{-286,80}}, color={0,0,127}));
      connect(simpleLag3.y, add6.u2) annotation (Line(points={{-263,80},{-230,80},{-230,
              -268},{50,-268}}, color={0,0,127}));
      connect(add9.y, simpleLag2.u) annotation (Line(points={{153,-262},{172,-262},{
              172,-260},{152,-260},{152,-134},{-146,-134},{-146,-168},{-132,-168},{-132,
              -166},{-112,-166}}, color={0,0,127}));
      connect(Pref, simpleLag4.u)
        annotation (Line(points={{-320,-160},{-280,-160}}, color={0,0,127}));
      connect(simpleLag4.y, add6.u1) annotation (Line(points={{-257,-160},{-206,
              -160},{-206,-256},{50,-256}}, color={0,0,127}));
      connect(Qgen, simpleLag5.u)
        annotation (Line(points={{-320,0},{-282,0}}, color={0,0,127}));
      connect(simpleLag5.y, add1.u2) annotation (Line(points={{-259,0},{-134,0},
              {-134,54}}, color={0,0,127}));
      annotation (Documentation(info="<html>
<p>
The REECB1 component used to represent the electrical controls of photovoltaic generation. The electrical controller actuates on the active and reactive power
reference from either the plant controller component or from power flow power reference values (in the case where there is no plant controller),
with feedback variables that original from the inverter interface component, specifically terminal voltage and generator power output,
and provides real (Ipcmd) and reactive current (Iqcmd) commands to the REGC types module.
</p>
<p>
For initialization purposes, there are 5 inputs that are derived from the inverter component: initial real and reactive injection currents (IP0 and IQ0), initial terminal voltage (v_0), and initial active and reactive power
injections (p_0 and q_0).
</p>
<p>
In terms of connectivity with other components to form the renewable source, the REECB1 component has five inputs, three of which are connected to the inverter component
(for instance REGCA1), and two more that can either be constant values from the power flow initialization or come from the connection to the plant controller.
The three REECB1 inputs that take in values from the output of the inverter model
are Vt, Pgen, and Qgen while the two inputs that could potentially be constant valued or come from the plant controller are Pref, and Qext.
</p>
<p>The modelling of such devices is based, mainly, on the following references:</p>
<ul>
<li>Siemens: \"PSS&reg;E Model Library\"
<a href=\"modelica://OpenIPSL.UsersGuide.References\">[PSSE-MODELS]</a>,</li>
<li>WECC: \"Solar Photovoltaic Power Plant Modeling and Validation Guideline\"
<a href=\"modelica://OpenIPSL.UsersGuide.References\">[WECCPhotovoltaic]</a>.</li>
</ul>
</html>"));
    end REECB1_Local_V_Q_Control_PI;

    model REECCU1_Local_V_Q_Control_for_LinearizationPYTHON
      "Electrical control model for utility scale battery energy storage"
      extends
        OpenIPSL.Electrical.Renewables.PSSE.ElectricalController.BaseClasses.BaseREECC(
         Iqcmd, Ipcmd);

      parameter OpenIPSL.Types.PerUnit Vdip = -99 "Low voltage threshold to activate reactive current injection logic (0.85 - 0.9)";
      parameter OpenIPSL.Types.PerUnit Vup = 99 "Voltage above which reactive current injection logic is activated (>1.1)";
      parameter OpenIPSL.Types.Time Trv = 0.01 "Filter time constant for voltage measurement (0.01 - 0.02)";
      parameter OpenIPSL.Types.PerUnit dbd1 = 0 "Voltage error dead band lower threshold (-0.1 - 0)";
      parameter OpenIPSL.Types.PerUnit dbd2 = 0 "Voltage error dead band upper threshold (0 - 0.1)";
      parameter Real Kqv = 0 "Reactive current injection gain during over and undervoltage conditions (0 - 10)";
      parameter OpenIPSL.Types.PerUnit Iqh1 = 1 "Upper limit on reactive current injection Iqinj (1 - 1.1)";
      parameter OpenIPSL.Types.PerUnit Iql1 = -1 "Lower limit on reactive current injection Iqinj (-1.1 - 1)";
      parameter OpenIPSL.Types.PerUnit vref0 = 1 "User defined voltage reference (0.95 - 1.05)";
      parameter OpenIPSL.Types.Time Tp = 0.01 "Filter time constant for electrical power (0.01 - 0.1)";
      parameter OpenIPSL.Types.PerUnit Qmax = 1 "Upper limits of the limit for reactive power regulator (0.4 - 1.0)";
      parameter OpenIPSL.Types.PerUnit Qmin = -1 "Lower limits of the limit for reactive power regulator (-1.0 - -0.4)";
      parameter OpenIPSL.Types.PerUnit Vmax = 1.1 "Maximum limit for voltage control (1.05 - 1.1)";
      parameter OpenIPSL.Types.PerUnit Vmin = 0.9 "Lower limits of input signals (0.9 - 0.95)";
      parameter Real Kqp = 1 "Reactive power regulator proportional gain (No predefined range)";
      parameter Real Kqi = 1 "Reactive power regulator integral gain (No predefined range)";
      parameter Real Kvp = 1 "Voltage regulator proportional gain (No predefined range)";
      parameter Real Kvi = 1 "Voltage regulator integral gain (No predefined range)";
      parameter Real Kpp = 1 "Voltage regulator proportional gain (No predefined range)";
      parameter Real Kpi = 1 "Voltage regulator integral gain (No predefined range)";
      parameter OpenIPSL.Types.Time Tiq = 0.01 "Time constant on lag delay (0.01 - 0.02)";
      parameter Real dPmax = 99 "Power reference maximum ramp rate (No predefined range)";
      parameter Real dPmin = -99 "Lower limits of input signals (No predefined range)";
      parameter OpenIPSL.Types.PerUnit Pmax = 1 "Maximum power limit";
      parameter OpenIPSL.Types.PerUnit Pmin = 0 "Minimum power limit";
      parameter OpenIPSL.Types.PerUnit Imax = 1.1 "Maximum limit on total converter current (1.1 - 1.3)";
      parameter OpenIPSL.Types.Time Tpord = 0.02 "Power filter time constant (0.01 - 0.02) ";
      parameter OpenIPSL.Types.PerUnit Vq1 = 0.2 "Reactive Power V-I pair, voltage (user defined)";
      parameter OpenIPSL.Types.PerUnit Iq1 = 0.75 "Reactive Power V-I pair, current (user defined)";
      parameter OpenIPSL.Types.PerUnit Vq2 = 0.5 "Reactive Power V-I pair, voltage (user defined)";
      parameter OpenIPSL.Types.PerUnit Iq2 = 0.75 "Reactive Power V-I pair, current (user defined)";
      parameter OpenIPSL.Types.PerUnit Vq3 = 0.75 "Reactive Power V-I pair, voltage (user defined)";
      parameter OpenIPSL.Types.PerUnit Iq3 = 0.75 "Reactive Power V-I pair, current (user defined)";
      parameter OpenIPSL.Types.PerUnit Vq4 = 1 "Reactive Power V-I pair, voltage (user defined)";
      parameter OpenIPSL.Types.PerUnit Iq4 = 0.75 "Reactive Power V-I pair, current (user defined)";
      parameter OpenIPSL.Types.PerUnit Vp1 = 0.2 "Real Power V-I pair, voltage (user defined)";
      parameter OpenIPSL.Types.PerUnit Ip1 = 1.11 "Real Power V-I pair, current (user defined)";
      parameter OpenIPSL.Types.PerUnit Vp2 = 0.5 "Real Power V-I pair, voltage (user defined)";
      parameter OpenIPSL.Types.PerUnit Ip2 = 1.11 "Real Power V-I pair, current (user defined)";
      parameter OpenIPSL.Types.PerUnit Vp3 = 0.75 "Real Power V-I pair, voltage (user defined)";
      parameter OpenIPSL.Types.PerUnit Ip3 = 1.11 "Real Power V-I pair, current (user defined)";
      parameter OpenIPSL.Types.PerUnit Vp4 = 1 "Real Power V-I pair, voltage (user defined)";
      parameter OpenIPSL.Types.PerUnit Ip4 = 1.11 "Real Power V-I pair, current (user defined)";
      parameter Modelica.Units.SI.Time T = 999 "Battery discharge time";
      parameter OpenIPSL.Types.PerUnit SOCini = 0.5 "Initial state of charge";
      parameter OpenIPSL.Types.PerUnit SOCmax = 0.8 "Maximum allowable state of charge";
      parameter OpenIPSL.Types.PerUnit SOCmin = 0.2 "Minimum allowable state of charge";

      Integer Voltage_dip;

      Modelica.Blocks.Nonlinear.Limiter limiter5(uMax=Modelica.Constants.inf, uMin=0.01)
        annotation (Placement(transformation(extent={{-100,-90},{-80,-70}})));
      Modelica.Blocks.Math.Add add8(k2=-1)
        annotation (Placement(transformation(extent={{-242,-136},{-222,-116}})));
      Modelica.Blocks.Nonlinear.Limiter limiter7(uMax=dPmax, uMin=dPmin)
        annotation (Placement(transformation(extent={{-208,-136},{-188,-116}})));
      Modelica.Blocks.Continuous.Integrator integrator3(k=1/Tpord,
        initType=Modelica.Blocks.Types.Init.InitialState, y_start=Ip0*V0)
        annotation (Placement(transformation(extent={{-142,-136},{-122,-116}})));
      Modelica.Blocks.Nonlinear.Limiter limiter8(uMax=Pmax, uMin=Pmin)
        annotation (Placement(transformation(extent={{-102,-136},{-82,-116}})));
      Modelica.Blocks.Math.Add add7(k1=+1, k2=+1)
        annotation (Placement(transformation(extent={{-18,-140},{2,-120}})));
      Modelica.Blocks.Nonlinear.VariableLimiter variableLimiter2
        annotation (Placement(transformation(extent={{228,-170},{248,-150}})));
      Modelica.Blocks.Sources.RealExpression IPMAX(y=ccl_reecc.Ipmax) annotation (
          Placement(transformation(
            extent={{-10,10},{10,-10}},
            rotation=180,
            origin={240,-120})));
      Modelica.Blocks.Sources.RealExpression IPMIN(y=ccl_reecc.Ipmin) annotation (
          Placement(transformation(
            extent={{-10,10},{10,-10}},
            rotation=180,
            origin={240,-184})));
      Modelica.Blocks.Math.Product product2
        annotation (Placement(transformation(extent={{224,-136},{204,-116}})));
      Modelica.Blocks.Math.Product product3
        annotation (Placement(transformation(extent={{-10,-10},{10,10}},
            rotation=180,
            origin={214,-190})));
      Modelica.Blocks.Sources.RealExpression SOC_ipmax(y=1)
        annotation (Placement(transformation(extent={{250,-122},{230,-142}})));
      Modelica.Blocks.Sources.RealExpression SOC_ipmin(y=1)
        annotation (Placement(transformation(extent={{250,-186},{230,-206}})));
      Modelica.Blocks.Nonlinear.Limiter limiter2(uMax=Qmax, uMin=Qmin)
        annotation (Placement(transformation(extent={{-164,136},{-144,156}})));
      Modelica.Blocks.Math.Add add2(k2=-1)
        annotation (Placement(transformation(extent={{-134,130},{-114,150}})));
      Modelica.Blocks.Nonlinear.Limiter limiter3(uMax=Vmax, uMin=Vmin)
        annotation (Placement(transformation(extent={{-40,124},{-20,144}})));
      Modelica.Blocks.Nonlinear.Limiter limiter4(uMax=Vmax, uMin=Vmin)
        annotation (Placement(transformation(extent={{26,124},{46,144}})));
      Modelica.Blocks.Math.Add add5(k2=-1)
        annotation (Placement(transformation(extent={{58,124},{78,144}})));
      Modelica.Blocks.Nonlinear.VariableLimiter variableLimiter1
        annotation (Placement(transformation(extent={{158,120},{178,140}})));
      Modelica.Blocks.Sources.RealExpression IQMAX_(y=ccl_reecc.Iqmax) annotation (
          Placement(transformation(
            extent={{-10,10},{10,-10}},
            rotation=180,
            origin={170,154})));
      Modelica.Blocks.Sources.RealExpression IQMIN_(y=ccl_reecc.Iqmin) annotation (
          Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={170,104})));
      Modelica.Blocks.Nonlinear.VariableLimiter variableLimiter
        annotation (Placement(transformation(extent={{266,150},{286,170}})));
      Modelica.Blocks.Sources.RealExpression IQMIN(y=ccl_reecc.Iqmin)
        annotation (Placement(transformation(extent={{286,150},{266,130}})));
      Modelica.Blocks.Sources.RealExpression IQMAX(y=ccl_reecc.Iqmax)
        annotation (Placement(transformation(extent={{286,174},{266,194}})));
      Modelica.Blocks.Tables.CombiTable1Ds VDL1(table=[Vq1,Iq1; Vq2,Iq2; Vq3,Iq3;
            Vq4,Iq4],
        smoothness=Modelica.Blocks.Types.Smoothness.LinearSegments,
        extrapolation=Modelica.Blocks.Types.Extrapolation.HoldLastPoint)
        annotation (Placement(transformation(extent={{56,-60},{76,-40}})));
      Modelica.Blocks.Tables.CombiTable1Ds VDL2(table=[Vp1,Ip1; Vp2,Ip2; Vp3,Ip3;
            Vp4,Ip4],
        smoothness=Modelica.Blocks.Types.Smoothness.LinearSegments,
        extrapolation=Modelica.Blocks.Types.Extrapolation.HoldLastPoint)
        annotation (Placement(transformation(extent={{56,-60},{76,-80}})));
      OpenIPSL.Electrical.Renewables.PSSE.ElectricalController.BaseClasses.CurrentLimitLogicREECC
        ccl_reecc(
        start_ii=-Iq0,
        start_ir=Ip0,
        Imax=Imax)
        annotation (Placement(transformation(extent={{92,-76},{124,-44}})));
      Modelica.Blocks.Sources.RealExpression IQCMD(y=Iqcmd)
        annotation (Placement(transformation(extent={{168,-48},{148,-28}})));
      Modelica.Blocks.Sources.BooleanConstant PQFLAG(k=pqflag)
        annotation (Placement(transformation(extent={{168,-50},{148,-70}})));
      Modelica.Blocks.Sources.RealExpression IPCMD(y=Ipcmd)
        annotation (Placement(transformation(extent={{168,-72},{148,-92}})));
      NonElectrical.Continuous.SimpleLag simpleLag(
        K=1,
        T=Trv,
        y_start=V0)
        annotation (Placement(transformation(extent={{-288,230},{-268,250}})));

      Modelica.Blocks.Continuous.Integrator IGQ(
        k=Kqi,
        initType=Modelica.Blocks.Types.Init.InitialState,
        y_start=V0)
        annotation (Placement(transformation(extent={{-96,90},{-76,110}})));
      Modelica.Blocks.Math.Gain PGQ(k=Kqp)
        annotation (Placement(transformation(extent={{-94,130},{-74,150}})));
      Modelica.Blocks.Math.Add add3
        annotation (Placement(transformation(extent={{-66,124},{-46,144}})));
      Modelica.Blocks.Math.Gain PGV(k=Kvp)
        annotation (Placement(transformation(extent={{100,126},{120,146}})));
      Modelica.Blocks.Continuous.Integrator IGV(
        k=Kvi,
        initType=Modelica.Blocks.Types.Init.InitialState,
        y_start=-Iq0 - (-V0 + Vref0)*Kqv)
        annotation (Placement(transformation(extent={{100,92},{120,112}})));
      Modelica.Blocks.Math.Add add4
        annotation (Placement(transformation(extent={{128,120},{148,140}})));
      Modelica.Blocks.Math.Division division1
        annotation (Placement(transformation(extent={{-60,-110},{-40,-130}})));
      Modelica.Blocks.Math.Add add6(k2=-1)
        annotation (Placement(transformation(extent={{14,-210},{34,-190}})));
      Modelica.Blocks.Math.Gain PGP(k=Kpp)
        annotation (Placement(transformation(extent={{54,-190},{74,-170}})));
      Modelica.Blocks.Continuous.Integrator IGP(k=Kpi,     y_start=p00)
        annotation (Placement(transformation(extent={{54,-230},{74,-210}})));
      Modelica.Blocks.Math.Add add9(k1=+1)
        annotation (Placement(transformation(extent={{94,-210},{114,-190}})));
      NonElectrical.Continuous.SimpleLag simpleLag1(
        K=1,
        T=Trv,
        y_start=p00)
        annotation (Placement(transformation(extent={{-30,-204},{-10,-184}})));
      NonElectrical.Continuous.SimpleLag simpleLag2(
        K=1,
        T=Tp,
        y_start=p00)
        annotation (Placement(transformation(extent={{-286,150},{-266,170}})));
    protected
      parameter Real pfaref=p00/sqrt(p00^2 +q00^2) "Power Factor of choice.";
      parameter OpenIPSL.Types.Angle pfangle = if q00 > 0 then acos(pfaref) else -acos(pfaref);
      parameter OpenIPSL.Types.PerUnit Ip0(fixed=false);
      parameter OpenIPSL.Types.PerUnit Iq0(fixed=false);
      parameter OpenIPSL.Types.PerUnit V0(fixed=false);
      parameter OpenIPSL.Types.PerUnit p00(fixed=false);
      parameter OpenIPSL.Types.PerUnit q00(fixed=false);
      parameter OpenIPSL.Types.PerUnit Vref0 = if vref0 == 0 then V0 else vref0;

    initial equation

      Ip0 = ip0;
      Iq0 = iq0;
      V0 = v0;
      p00 = p0;
      q00 = q0;
    equation

      Voltage_dip = if Vt<Vdip or Vt>Vup then 1 else 0;

      connect(add8.y,limiter7. u)
        annotation (Line(points={{-221,-126},{-210,-126}},
                                                         color={0,0,127}));
      connect(integrator3.y,limiter8. u)
        annotation (Line(points={{-121,-126},{-104,-126}},
                                                         color={0,0,127}));
      connect(add8.u2,limiter8. u) annotation (Line(points={{-244,-132},{-252,-132},
              {-252,-152},{-112,-152},{-112,-126},{-104,-126}},
                                                       color={0,0,127}));
      connect(Paux, add7.u2) annotation (Line(points={{-320,-160},{-26,-160},{-26,-136},
              {-20,-136}}, color={0,0,127}));
      connect(variableLimiter2.y, Ipcmd)
        annotation (Line(points={{249,-160},{288,-160},{288,-170},{310,-170}},
                                                         color={0,0,127}));
      connect(add7.y,variableLimiter2. u) annotation (Line(points={{3,-130},{114,-130},
              {114,-160},{226,-160}}, color={0,0,127}));
      connect(product2.y,variableLimiter2. limit1) annotation (Line(points={{203,-126},
              {180,-126},{180,-152},{226,-152}},
                                      color={0,0,127}));
      connect(IPMAX.y,product2. u1)
        annotation (Line(points={{229,-120},{226,-120}}, color={0,0,127}));
      connect(product3.u2,IPMIN. y)
        annotation (Line(points={{226,-184},{229,-184}}, color={0,0,127}));
      connect(variableLimiter2.limit2,product3. y) annotation (Line(points={{226,-168},
              {180,-168},{180,-190},{203,-190}}, color={0,0,127}));
      connect(product2.u2,SOC_ipmax. y)
        annotation (Line(points={{226,-132},{229,-132}},
                                                       color={0,0,127}));
      connect(product3.u1,SOC_ipmin. y)
        annotation (Line(points={{226,-196},{229,-196}}, color={0,0,127}));
      connect(limiter2.y,add2. u1)
        annotation (Line(points={{-143,146},{-136,146}}, color={0,0,127}));
      connect(Qgen,add2. u2) annotation (Line(points={{-320,80},{-136,80},{-136,134}},
            color={0,0,127}));
      connect(limiter4.y,add5. u1) annotation (Line(points={{47,134},{52,134},{52,140},
              {56,140}}, color={0,0,127}));
      connect(IQMAX_.y,variableLimiter1. limit1) annotation (Line(points={{159,154},
              {152,154},{152,138},{156,138}}, color={0,0,127}));
      connect(IQMIN_.y,variableLimiter1. limit2) annotation (Line(points={{159,104},
              {152,104},{152,122},{156,122}},
                                            color={0,0,127}));
      connect(IQMIN.y,variableLimiter. limit2) annotation (Line(points={{265,140},{258,
              140},{258,152},{264,152}},
                                      color={0,0,127}));
      connect(IQMAX.y,variableLimiter. limit1) annotation (Line(points={{265,184},{258,
              184},{258,168},{264,168}},
                                       color={0,0,127}));
      connect(VDL2.y[1], ccl_reecc.VDL2_out)
        annotation (Line(points={{77,-70},{88.8,-69.6}}, color={0,0,127}));
      connect(VDL1.y[1], ccl_reecc.VDL1_out) annotation (Line(points={{77,-50},{77,-50.4},
              {88.8,-50.4}}, color={0,0,127}));
      connect(PQFLAG.y, ccl_reecc.pqflag)
        annotation (Line(points={{147,-60},{88.8,-60}},  color={255,0,255}));
      connect(IQCMD.y, ccl_reecc.Iqcmd) annotation (Line(points={{147,-38},{132,-38},{132,-50.4},{127.2,-50.4}},
                                          color={0,0,127}));
      connect(IPCMD.y, ccl_reecc.Ipcmd) annotation (Line(points={{147,-82},{132,-82},{132,-69.6},{127.2,-69.6}},
                                          color={0,0,127}));
      connect(variableLimiter.y, Iqcmd)
        annotation (Line(points={{287,160},{294,160},{294,170},{310,170}},
                                                     color={0,0,127}));
      connect(Vt, simpleLag.u)
        annotation (Line(points={{-320,240},{-290,240}}, color={0,0,127}));
      connect(PGQ.y, add3.u1)
        annotation (Line(points={{-73,140},{-68,140}}, color={0,0,127}));
      connect(IGQ.y, add3.u2) annotation (Line(points={{-75,100},{-68,100},{-68,
              128}}, color={0,0,127}));
      connect(add3.y, limiter3.u)
        annotation (Line(points={{-45,134},{-42,134}}, color={0,0,127}));
      connect(PGV.y, add4.u1)
        annotation (Line(points={{121,136},{126,136}}, color={0,0,127}));
      connect(IGV.y, add4.u2) annotation (Line(points={{121,102},{121,112},{126,
              112},{126,124}}, color={0,0,127}));
      connect(add4.y, variableLimiter1.u)
        annotation (Line(points={{149,130},{156,130}}, color={0,0,127}));
      connect(Qext, limiter2.u) annotation (Line(points={{-320,0},{-200,0},{
              -200,146},{-166,146}}, color={0,0,127}));
      connect(PGQ.u, add2.y)
        annotation (Line(points={{-96,140},{-113,140}}, color={0,0,127}));
      connect(IGQ.u, add2.y) annotation (Line(points={{-98,100},{-108,100},{
              -108,140},{-113,140}}, color={0,0,127}));
      connect(limiter3.y, limiter4.u)
        annotation (Line(points={{-19,134},{24,134}}, color={0,0,127}));
      connect(PGV.u, add5.y) annotation (Line(points={{98,136},{88.5,136},{88.5,
              134},{79,134}}, color={0,0,127}));
      connect(IGV.u, add5.y) annotation (Line(points={{98,102},{88,102},{88,134},
              {79,134}}, color={0,0,127}));
      connect(variableLimiter1.y, variableLimiter.u) annotation (Line(points={{
              179,130},{202,130},{202,132},{228,132},{228,160},{264,160}},
            color={0,0,127}));
      connect(simpleLag.y, VDL1.u) annotation (Line(points={{-267,240},{-244,
              240},{-244,-50},{54,-50}}, color={0,0,127}));
      connect(VDL2.u, VDL1.u) annotation (Line(points={{54,-70},{22,-70},{22,
              -50},{54,-50}}, color={0,0,127}));
      connect(add5.u2, simpleLag.y) annotation (Line(points={{56,128},{52,128},
              {52,84},{-6,84},{-6,240},{-267,240}}, color={0,0,127}));
      connect(limiter5.u, VDL1.u) annotation (Line(points={{-102,-80},{-246,-80},
              {-246,-50},{54,-50}}, color={0,0,127}));
      connect(limiter7.y, integrator3.u)
        annotation (Line(points={{-187,-126},{-144,-126}}, color={0,0,127}));
      connect(limiter8.y, division1.u1)
        annotation (Line(points={{-81,-126},{-62,-126}}, color={0,0,127}));
      connect(limiter5.y, division1.u2) annotation (Line(points={{-79,-80},{-70,
              -80},{-70,-114},{-62,-114}}, color={0,0,127}));
      connect(division1.y, add7.u1) annotation (Line(points={{-39,-120},{-39,
              -124},{-20,-124}}, color={0,0,127}));
      connect(IGP.y,add9. u2) annotation (Line(points={{75,-220},{80,-220},{80,
              -206},{92,-206}},
                     color={0,0,127}));
      connect(PGP.y,add9. u1) annotation (Line(points={{75,-180},{75,-194},{92,
              -194}},    color={0,0,127}));
      connect(simpleLag1.y,add6. u1)
        annotation (Line(points={{-9,-194},{12,-194}},   color={0,0,127}));
      connect(IGP.u,add6. y) annotation (Line(points={{52,-220},{44,-220},{44,
              -200},{35,-200}},      color={0,0,127}));
      connect(PGP.u,add6. y) annotation (Line(points={{52,-180},{44,-180},{44,
              -200},{35,-200}},      color={0,0,127}));
      connect(simpleLag1.u, Pref) annotation (Line(points={{-32,-194},{-150,
              -194},{-150,-176},{-270,-176},{-270,-80},{-320,-80}}, color={0,0,
              127}));
      connect(add9.y, add8.u1) annotation (Line(points={{115,-200},{130,-200},{
              130,-170},{-264,-170},{-264,-120},{-244,-120}}, color={0,0,127}));
      connect(Pe, simpleLag2.u)
        annotation (Line(points={{-320,160},{-288,160}}, color={0,0,127}));
      connect(simpleLag2.y, add6.u2) annotation (Line(points={{-265,160},{-260,160},
              {-260,-206},{12,-206}}, color={0,0,127}));
      annotation (Documentation(info="<html>
<p>
The REECCU1 component is an augmented version of the existing renewable energy electrical control (REECA1) model, and can be utilized to represent
both type 3 and type 4 wind turbine electrical controllers as well as photovoltaic electrical controllers. The REECCU1 component can be connected to the
plant controller (REPCA1). This electrical controller provides real (Ipcmd) and reactive (Iqcmd) current commands to the REGCA1 component, which are the outputs
of this component.
</p>
<p>
For initialization purposes, there are 5 inputs that are derived from the inverter component: initial real and reactive injection currents (IP0 and IQ0), initial terminal voltage (v_0), and initial active and reactive power
injections (p_0 and q_0).
</p>
<p>
In terms of connectivity with other components to form the renewable source, the REECCU1 component has six inputs, three of which are connected to the inverter component
(for instance REGCA1), two more that can either be constant values from the power flow initialization or come from the connection to the plant controller, and
an auxiliary input variable that is rarely used (usually constant and zero). The three REECCU1 inputs that take in values from the output of the inverter model
are Vt, Pgen, and Qgen while the two inputs that could potentially be constant valued or come from the plant controller are Pref, and Qext.
</p>
<p>The modelling of such devices is based, mainly, on the following references:</p>
<ul>
<li>Siemens: \"PSS&reg;E Model Library\"
<a href=\"modelica://OpenIPSL.UsersGuide.References\">[PSSE-MODELS]</a>,</li>
<li>WECC: \"Battery Storage Dynamic Modeling Guideline\"
<a href=\"modelica://OpenIPSL.UsersGuide.References\">[WECCBattery]</a>.</li>
</ul>

</html>"));
    end REECCU1_Local_V_Q_Control_for_LinearizationPYTHON;

    model REECB1_Local_V_Q_Control_PI_OBSERVABILITY
      "Electrical control model for large scale photovoltaic"
      extends
        OpenIPSL.Electrical.Renewables.PSSE.ElectricalController.BaseClasses.BaseREECB(
         Iqcmd, Ipcmd);

      parameter OpenIPSL.Types.PerUnit Vdip = -99 "Low voltage threshold to activate reactive current injection logic (0.85 - 0.9)";
      parameter OpenIPSL.Types.PerUnit Vup = 99 "Voltage above which reactive current injection logic is activated (>1.1)";
      parameter OpenIPSL.Types.Time Trv = 0 "Filter time constant for voltage measurement (0.01 - 0.02)";
      parameter OpenIPSL.Types.PerUnit dbd1 = -0.05 "Voltage error dead band lower threshold (-0.1 - 0)";
      parameter OpenIPSL.Types.PerUnit dbd2 = 0.05 "Voltage error dead band upper threshold (0 - 0.1)";
      parameter Real Kqv = 0 "Reactive current injection gain during over and undervoltage conditions (0 - 10)";
      parameter OpenIPSL.Types.PerUnit Iqh1 = 1.05 "Upper limit on reactive current injection Iqinj (1 - 1.1)";
      parameter OpenIPSL.Types.PerUnit Iql1 = -1.05 "Lower limit on reactive current injection Iqinj (-1.1 - 1)";
      parameter OpenIPSL.Types.PerUnit vref0 = 1 "User defined voltage reference (0.95 - 1.05)";
      parameter OpenIPSL.Types.Time Tp = 0.05 "Filter time constant for electrical power (0.01 - 0.1)";
      parameter OpenIPSL.Types.PerUnit Qmax = 0.4360 "Upper limits of the limit for reactive power regulator (0.4 - 1.0)";
      parameter OpenIPSL.Types.PerUnit Qmin = -0.4360 "Lower limits of the limit for reactive power regulator (-1.0 - -0.4)";
      parameter OpenIPSL.Types.PerUnit Vmax = 1.1 "Maximum limit for voltage control (1.05 - 1.1)";
      parameter OpenIPSL.Types.PerUnit Vmin = 0.9 "Lower limits of input signals (0.9 - 0.95)";
      parameter Real Kqp = 0 "Reactive power regulator proportional gain (No predefined range)";
      parameter Real Kqi = 0.1 "Reactive power regulator integral gain (No predefined range)";
      parameter Real Kvp = 0 "Voltage regulator proportional gain (No predefined range)";
      parameter Real Kvi = 40 "Voltage regulator integral gain (No predefined range)";
      parameter Real Kpp = 0 "Voltage regulator proportional gain (No predefined range)";
      parameter Real Kpi = 40 "Voltage regulator integral gain (No predefined range)";
      parameter OpenIPSL.Types.Time Tiq = 0.02 "Time constant on lag delay (0.01 - 0.02)";
      parameter Real dPmax = 99 "Power reference maximum ramp rate (No predefined range)";
      parameter Real dPmin = -99 "Lower limits of input signals (No predefined range)";
      parameter OpenIPSL.Types.PerUnit Pmax = 1 "Maximum power limit";
      parameter OpenIPSL.Types.PerUnit Pmin = 0 "Minimum power limit";
      parameter OpenIPSL.Types.PerUnit Imax = 1.82 "Maximum limit on total converter current (1.1 - 1.3)";
      parameter OpenIPSL.Types.Time Tpord = 0.02 "Power filter time constant (0.01 - 0.02) ";

      Integer Voltage_dip;

      Modelica.Blocks.Nonlinear.Limiter limiter1(uMax=Qmax, uMin=Qmin)
        annotation (Placement(transformation(extent={{-162,56},{-142,76}})));
      Modelica.Blocks.Math.Add add1(k2=-1)
        annotation (Placement(transformation(extent={{-132,50},{-112,70}})));
      Modelica.Blocks.Nonlinear.Limiter limiter2(uMax=Vmax, uMin=Vmin)
        annotation (Placement(transformation(extent={{-8,44},{12,64}})));
      Modelica.Blocks.Math.Add add4(k2=-1)
        annotation (Placement(transformation(extent={{60,44},{80,64}})));
      Modelica.Blocks.Nonlinear.VariableLimiter variableLimiter2
        annotation (Placement(transformation(extent={{162,38},{182,58}})));
      Modelica.Blocks.Sources.RealExpression IQMAX_(y=ccl.Iqmax) annotation (
          Placement(transformation(
            extent={{-10,10},{10,-10}},
            rotation=180,
            origin={172,74})));
      Modelica.Blocks.Sources.RealExpression IQMIN_(y=ccl.Iqmin) annotation (
          Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={172,24})));
      Modelica.Blocks.Nonlinear.VariableLimiter variableLimiter
        annotation (Placement(transformation(extent={{264,70},{284,90}})));
      Modelica.Blocks.Sources.RealExpression IQMIN(y=ccl.Iqmin)
        annotation (Placement(transformation(extent={{284,70},{264,50}})));
      Modelica.Blocks.Sources.RealExpression IQMAX(y=ccl.Iqmax)
        annotation (Placement(transformation(extent={{284,94},{264,114}})));
      Modelica.Blocks.Nonlinear.VariableLimiter variableLimiter1
        annotation (Placement(transformation(extent={{178,-180},{198,-160}})));
      Modelica.Blocks.Sources.RealExpression IPMAX(y=ccl.Ipmax) annotation (
          Placement(transformation(
            extent={{10,-10},{-10,10}},
            origin={188,-140})));
      Modelica.Blocks.Sources.RealExpression IPMIN(y=ccl.Ipmin)
        annotation (Placement(transformation(extent={{198,-210},{178,-190}})));
      Modelica.Blocks.Math.Division division1
        annotation (Placement(transformation(extent={{0,-180},{20,-160}})));
      Modelica.Blocks.Nonlinear.Limiter limiter5(uMax=Modelica.Constants.inf, uMin=0.01)
        annotation (Placement(transformation(extent={{-132,-220},{-112,-200}})));
      Modelica.Blocks.Nonlinear.Limiter limiter8(uMax=Pmax, uMin=Pmin)
        annotation (Placement(transformation(extent={{-70,-176},{-50,-156}})));
      OpenIPSL.Electrical.Renewables.PSSE.ElectricalController.BaseClasses.CurrentLimitLogicREECB
        ccl(
        start_ii=-Iq0,
        start_ir=Ip0,
        Imax=Imax)
        annotation (Placement(transformation(extent={{260,-40},{280,-20}})));
      Modelica.Blocks.Sources.BooleanConstant Pqflag_logic(k=pqflag)
        annotation (Placement(transformation(extent={{220,-40},{240,-20}})));

      Modelica.Blocks.Math.Add add6(k2=-1)
        annotation (Placement(transformation(extent={{52,-272},{72,-252}})));
      Modelica.Blocks.Continuous.PI PI(
        k=Kqp,
        T=Kqp/Kqi,
        initType=Modelica.Blocks.Types.Init.InitialOutput,
        y_start=V0)
        annotation (Placement(transformation(extent={{-60,44},{-40,64}})));
      Modelica.Blocks.Continuous.PI PI1(
        k=Kvp,
        T=Kvp/Kvi,
        initType=Modelica.Blocks.Types.Init.InitialOutput,
        y_start=-Iq0)
        annotation (Placement(transformation(extent={{114,40},{134,60}})));
      Modelica.Blocks.Continuous.PI PI2(
        k=Kpp,
        T=Kpp/Kpi,
        initType=Modelica.Blocks.Types.Init.InitialOutput,
        y_start=Ip0*V0)
        annotation (Placement(transformation(extent={{90,-272},{110,-252}})));
      Modelica.Blocks.Continuous.FirstOrder Vt_sensor(
        k=1,
        T=Trv,
        initType=Modelica.Blocks.Types.Init.InitialOutput,
        y_start=V0)
        annotation (Placement(transformation(extent={{-280,150},{-260,170}})));
      Modelica.Blocks.Continuous.FirstOrder P_sensor(
        k=1,
        T=Tp,
        initType=Modelica.Blocks.Types.Init.InitialOutput,
        y_start=p00)
        annotation (Placement(transformation(extent={{-280,70},{-260,90}})));
      Modelica.Blocks.Continuous.FirstOrder Q_sensor(
        k=1,
        T=Tp,
        initType=Modelica.Blocks.Types.Init.InitialOutput,
        y_start=q00)
        annotation (Placement(transformation(extent={{-278,-10},{-258,10}})));
      Modelica.Blocks.Continuous.FirstOrder Filter(
        k=1,
        T=Tpord,
        initType=Modelica.Blocks.Types.Init.InitialOutput,
        y_start=Ip0*V0)
        annotation (Placement(transformation(extent={{-110,-176},{-90,-156}})));
    protected
      parameter Real pfaref = p00/sqrt(p00^2 +q00^2) "Power Factor of choice.";
      parameter OpenIPSL.Types.Angle pfangle = if q00 > 0 then acos(pfaref) else -acos(pfaref);
      parameter OpenIPSL.Types.PerUnit Ip0(fixed=false);
      parameter OpenIPSL.Types.PerUnit Iq0(fixed=false);
      parameter OpenIPSL.Types.PerUnit V0(fixed=false);
      parameter OpenIPSL.Types.PerUnit p00(fixed=false);
      parameter OpenIPSL.Types.PerUnit q00(fixed=false);
      parameter OpenIPSL.Types.PerUnit Vref0 = if vref0 == 0 then V0 else vref0;

    initial equation

      Ip0 = ip0;
      Iq0 = iq0;
      V0 = v0;
      p00 = p0;
      q00 = q0;

    equation

      Voltage_dip = if Vt<Vdip or Vt>Vup then 1 else 0;


      connect(limiter1.y,add1. u1)
        annotation (Line(points={{-141,66},{-134,66}}, color={0,0,127}));
      connect(IQMAX_.y,variableLimiter2. limit1) annotation (Line(points={{161,74},{
              154,74},{154,56},{160,56}}, color={0,0,127}));
      connect(IQMIN_.y,variableLimiter2. limit2) annotation (Line(points={{161,24},{
              154,24},{154,40},{160,40}}, color={0,0,127}));
      connect(IQMIN.y,variableLimiter. limit2) annotation (Line(points={{263,60},{256,
              60},{256,72},{262,72}}, color={0,0,127}));
      connect(IQMAX.y,variableLimiter. limit1) annotation (Line(points={{263,104},{256,
              104},{256,88},{262,88}}, color={0,0,127}));
      connect(IPMIN.y,variableLimiter1. limit2) annotation (Line(points={{177,-200},
              {177,-189},{176,-189},{176,-178}},
                                             color={0,0,127}));
      connect(IPMAX.y,variableLimiter1. limit1) annotation (Line(points={{177,-140},
              {177,-151},{176,-151},{176,-162}},
                                             color={0,0,127}));
      connect(variableLimiter1.y, Ipcmd) annotation (Line(points={{199,-170},{310,-170}},
                                    color={0,0,127}));
      connect(limiter5.y,division1. u2) annotation (Line(points={{-111,-210},{-111,-212},
              {-12,-212},{-12,-176},{-2,-176}},
                                      color={0,0,127}));
      connect(limiter8.y,division1. u1) annotation (Line(points={{-49,-166},{-25.5,-166},
              {-25.5,-164},{-2,-164}},color={0,0,127}));
      connect(division1.y, variableLimiter1.u)
        annotation (Line(points={{21,-170},{176,-170}}, color={0,0,127}));
      connect(variableLimiter.y, Iqcmd)
        annotation (Line(points={{285,80},{292,80},{292,170},{310,170}},
                                                     color={0,0,127}));
      connect(Pqflag_logic.y, ccl.Pqflag)
        annotation (Line(points={{241,-30},{258,-30}}, color={255,0,255}));
      connect(ccl.Iqcmd, Iqcmd) annotation (Line(points={{282,-25},{292,-25},{292,170},{310,170}},
                         color={0,0,127}));
      connect(ccl.Ipcmd, Ipcmd) annotation (Line(points={{282,-35},{292,-35},{292,-170},{310,-170}},
                          color={0,0,127}));
      connect(variableLimiter2.y, variableLimiter.u) annotation (Line(points={{
              183,48},{232,48},{232,80},{262,80}}, color={0,0,127}));
      connect(limiter2.y, add4.u1)
        annotation (Line(points={{13,54},{13,60},{58,60}}, color={0,0,127}));
      connect(PI.y, limiter2.u)
        annotation (Line(points={{-39,54},{-10,54}}, color={0,0,127}));
      connect(add1.y, PI.u)
        annotation (Line(points={{-111,60},{-111,54},{-62,54}}, color={0,0,127}));
      connect(PI1.y, variableLimiter2.u)
        annotation (Line(points={{135,50},{135,48},{160,48}}, color={0,0,127}));
      connect(PI1.u, add4.y)
        annotation (Line(points={{112,50},{112,54},{81,54}}, color={0,0,127}));
      connect(Pref, add6.u1) annotation (Line(points={{-320,-160},{-258,-160},{-258,
              -256},{50,-256}}, color={0,0,127}));
      connect(Qext, limiter1.u) annotation (Line(points={{-320,-80},{-180,-80},{-180,
              66},{-164,66}}, color={0,0,127}));
      connect(add6.y, PI2.u) annotation (Line(points={{73,-262},{88,-262}},
                          color={0,0,127}));
      connect(Vt_sensor.u, Vt)
        annotation (Line(points={{-282,160},{-320,160}}, color={0,0,127}));
      connect(Vt_sensor.y, add4.u2) annotation (Line(points={{-259,160},{34,160},{34,
              48},{58,48}}, color={0,0,127}));
      connect(Vt_sensor.y, limiter5.u) annotation (Line(points={{-259,160},{-188,160},
              {-188,-210},{-134,-210}}, color={0,0,127}));
      connect(Pe, P_sensor.u)
        annotation (Line(points={{-320,80},{-282,80}}, color={0,0,127}));
      connect(P_sensor.y, add6.u2) annotation (Line(points={{-259,80},{-214,80},{-214,
              -268},{50,-268}}, color={0,0,127}));
      connect(Qgen, Q_sensor.u)
        annotation (Line(points={{-320,0},{-280,0}}, color={0,0,127}));
      connect(Q_sensor.y, add1.u2)
        annotation (Line(points={{-257,0},{-134,0},{-134,54}}, color={0,0,127}));
      connect(Filter.y, limiter8.u)
        annotation (Line(points={{-89,-166},{-72,-166}}, color={0,0,127}));
      connect(PI2.y, Filter.u) annotation (Line(points={{111,-262},{126,-262},{126,-224},
              {-162,-224},{-162,-166},{-112,-166}}, color={0,0,127}));
      annotation (Documentation(info="<html>
<p>
The REECB1 component used to represent the electrical controls of photovoltaic generation. The electrical controller actuates on the active and reactive power
reference from either the plant controller component or from power flow power reference values (in the case where there is no plant controller),
with feedback variables that original from the inverter interface component, specifically terminal voltage and generator power output,
and provides real (Ipcmd) and reactive current (Iqcmd) commands to the REGC types module.
</p>
<p>
For initialization purposes, there are 5 inputs that are derived from the inverter component: initial real and reactive injection currents (IP0 and IQ0), initial terminal voltage (v_0), and initial active and reactive power
injections (p_0 and q_0).
</p>
<p>
In terms of connectivity with other components to form the renewable source, the REECB1 component has five inputs, three of which are connected to the inverter component
(for instance REGCA1), and two more that can either be constant values from the power flow initialization or come from the connection to the plant controller.
The three REECB1 inputs that take in values from the output of the inverter model
are Vt, Pgen, and Qgen while the two inputs that could potentially be constant valued or come from the plant controller are Pref, and Qext.
</p>
<p>The modelling of such devices is based, mainly, on the following references:</p>
<ul>
<li>Siemens: \"PSS&reg;E Model Library\"
<a href=\"modelica://OpenIPSL.UsersGuide.References\">[PSSE-MODELS]</a>,</li>
<li>WECC: \"Solar Photovoltaic Power Plant Modeling and Validation Guideline\"
<a href=\"modelica://OpenIPSL.UsersGuide.References\">[WECCPhotovoltaic]</a>.</li>
</ul>
</html>"));
    end REECB1_Local_V_Q_Control_PI_OBSERVABILITY;

    model REECCU1_Local_V_Q_Control_for_Linearization_OBSERVABILITY
      "Electrical control model for utility scale battery energy storage"
      extends
        OpenIPSL.Electrical.Renewables.PSSE.ElectricalController.BaseClasses.BaseREECC(
         Iqcmd, Ipcmd);

      parameter OpenIPSL.Types.PerUnit Vdip = -99 "Low voltage threshold to activate reactive current injection logic (0.85 - 0.9)";
      parameter OpenIPSL.Types.PerUnit Vup = 99 "Voltage above which reactive current injection logic is activated (>1.1)";
      parameter OpenIPSL.Types.Time Trv = 0.01 "Filter time constant for voltage measurement (0.01 - 0.02)";
      parameter OpenIPSL.Types.PerUnit dbd1 = 0 "Voltage error dead band lower threshold (-0.1 - 0)";
      parameter OpenIPSL.Types.PerUnit dbd2 = 0 "Voltage error dead band upper threshold (0 - 0.1)";
      parameter Real Kqv = 0 "Reactive current injection gain during over and undervoltage conditions (0 - 10)";
      parameter OpenIPSL.Types.PerUnit Iqh1 = 1 "Upper limit on reactive current injection Iqinj (1 - 1.1)";
      parameter OpenIPSL.Types.PerUnit Iql1 = -1 "Lower limit on reactive current injection Iqinj (-1.1 - 1)";
      parameter OpenIPSL.Types.PerUnit vref0 = 1 "User defined voltage reference (0.95 - 1.05)";
      parameter OpenIPSL.Types.Time Tp = 0.01 "Filter time constant for electrical power (0.01 - 0.1)";
      parameter OpenIPSL.Types.PerUnit Qmax = 1 "Upper limits of the limit for reactive power regulator (0.4 - 1.0)";
      parameter OpenIPSL.Types.PerUnit Qmin = -1 "Lower limits of the limit for reactive power regulator (-1.0 - -0.4)";
      parameter OpenIPSL.Types.PerUnit Vmax = 1.1 "Maximum limit for voltage control (1.05 - 1.1)";
      parameter OpenIPSL.Types.PerUnit Vmin = 0.9 "Lower limits of input signals (0.9 - 0.95)";
      parameter Real Kqp = 0 "Reactive power regulator proportional gain (No predefined range)";
      parameter Real Kqi = 0.1 "Reactive power regulator integral gain (No predefined range)";
      parameter Real Kvp = 0 "Voltage regulator proportional gain (No predefined range)";
      parameter Real Kvi = 40 "Voltage regulator integral gain (No predefined range)";
      parameter Real Kpp = 1 "Voltage regulator proportional gain (No predefined range)";
      parameter Real Kpi = 1 "Voltage regulator integral gain (No predefined range)";
      parameter OpenIPSL.Types.Time Tiq = 0.01 "Time constant on lag delay (0.01 - 0.02)";
      parameter Real dPmax = 99 "Power reference maximum ramp rate (No predefined range)";
      parameter Real dPmin = -99 "Lower limits of input signals (No predefined range)";
      parameter OpenIPSL.Types.PerUnit Pmax = 1 "Maximum power limit";
      parameter OpenIPSL.Types.PerUnit Pmin = 0 "Minimum power limit";
      parameter OpenIPSL.Types.PerUnit Imax = 1.1 "Maximum limit on total converter current (1.1 - 1.3)";
      parameter OpenIPSL.Types.Time Tpord = 0.02 "Power filter time constant (0.01 - 0.02) ";
      parameter OpenIPSL.Types.PerUnit Vq1 = 0.2 "Reactive Power V-I pair, voltage (user defined)";
      parameter OpenIPSL.Types.PerUnit Iq1 = 0.75 "Reactive Power V-I pair, current (user defined)";
      parameter OpenIPSL.Types.PerUnit Vq2 = 0.5 "Reactive Power V-I pair, voltage (user defined)";
      parameter OpenIPSL.Types.PerUnit Iq2 = 0.75 "Reactive Power V-I pair, current (user defined)";
      parameter OpenIPSL.Types.PerUnit Vq3 = 0.75 "Reactive Power V-I pair, voltage (user defined)";
      parameter OpenIPSL.Types.PerUnit Iq3 = 0.75 "Reactive Power V-I pair, current (user defined)";
      parameter OpenIPSL.Types.PerUnit Vq4 = 1 "Reactive Power V-I pair, voltage (user defined)";
      parameter OpenIPSL.Types.PerUnit Iq4 = 0.75 "Reactive Power V-I pair, current (user defined)";
      parameter OpenIPSL.Types.PerUnit Vp1 = 0.2 "Real Power V-I pair, voltage (user defined)";
      parameter OpenIPSL.Types.PerUnit Ip1 = 1.11 "Real Power V-I pair, current (user defined)";
      parameter OpenIPSL.Types.PerUnit Vp2 = 0.5 "Real Power V-I pair, voltage (user defined)";
      parameter OpenIPSL.Types.PerUnit Ip2 = 1.11 "Real Power V-I pair, current (user defined)";
      parameter OpenIPSL.Types.PerUnit Vp3 = 0.75 "Real Power V-I pair, voltage (user defined)";
      parameter OpenIPSL.Types.PerUnit Ip3 = 1.11 "Real Power V-I pair, current (user defined)";
      parameter OpenIPSL.Types.PerUnit Vp4 = 1 "Real Power V-I pair, voltage (user defined)";
      parameter OpenIPSL.Types.PerUnit Ip4 = 1.11 "Real Power V-I pair, current (user defined)";
      parameter Modelica.Units.SI.Time T = 999 "Battery discharge time";
      parameter OpenIPSL.Types.PerUnit SOCini = 0.5 "Initial state of charge";
      parameter OpenIPSL.Types.PerUnit SOCmax = 0.8 "Maximum allowable state of charge";
      parameter OpenIPSL.Types.PerUnit SOCmin = 0.2 "Minimum allowable state of charge";

      Integer Voltage_dip;

      Modelica.Blocks.Nonlinear.Limiter limiter5(uMax=Modelica.Constants.inf, uMin=0.01)
        annotation (Placement(transformation(extent={{-100,-90},{-80,-70}})));
      Modelica.Blocks.Nonlinear.Limiter limiter8(uMax=Pmax, uMin=Pmin)
        annotation (Placement(transformation(extent={{-102,-136},{-82,-116}})));
      Modelica.Blocks.Math.Add add7(k1=+1, k2=+1)
        annotation (Placement(transformation(extent={{-18,-140},{2,-120}})));
      Modelica.Blocks.Nonlinear.VariableLimiter variableLimiter2
        annotation (Placement(transformation(extent={{228,-170},{248,-150}})));
      Modelica.Blocks.Sources.RealExpression IPMAX(y=ccl_reecc.Ipmax) annotation (
          Placement(transformation(
            extent={{-10,10},{10,-10}},
            rotation=180,
            origin={240,-120})));
      Modelica.Blocks.Sources.RealExpression IPMIN(y=ccl_reecc.Ipmin) annotation (
          Placement(transformation(
            extent={{-10,10},{10,-10}},
            rotation=180,
            origin={240,-184})));
      Modelica.Blocks.Math.Product product2
        annotation (Placement(transformation(extent={{224,-136},{204,-116}})));
      Modelica.Blocks.Math.Product product3
        annotation (Placement(transformation(extent={{-10,-10},{10,10}},
            rotation=180,
            origin={214,-190})));
      Modelica.Blocks.Sources.RealExpression SOC_ipmax(y=1)
        annotation (Placement(transformation(extent={{250,-122},{230,-142}})));
      Modelica.Blocks.Sources.RealExpression SOC_ipmin(y=1)
        annotation (Placement(transformation(extent={{250,-186},{230,-206}})));
      Modelica.Blocks.Nonlinear.Limiter limiter2(uMax=Qmax, uMin=Qmin)
        annotation (Placement(transformation(extent={{-164,136},{-144,156}})));
      Modelica.Blocks.Math.Add add2(k2=-1)
        annotation (Placement(transformation(extent={{-134,130},{-114,150}})));
      Modelica.Blocks.Nonlinear.Limiter limiter3(uMax=Vmax, uMin=Vmin)
        annotation (Placement(transformation(extent={{-40,124},{-20,144}})));
      Modelica.Blocks.Nonlinear.Limiter limiter4(uMax=Vmax, uMin=Vmin)
        annotation (Placement(transformation(extent={{26,124},{46,144}})));
      Modelica.Blocks.Math.Add add5(k2=-1)
        annotation (Placement(transformation(extent={{58,124},{78,144}})));
      Modelica.Blocks.Nonlinear.VariableLimiter variableLimiter1
        annotation (Placement(transformation(extent={{158,120},{178,140}})));
      Modelica.Blocks.Sources.RealExpression IQMAX_(y=ccl_reecc.Iqmax) annotation (
          Placement(transformation(
            extent={{-10,10},{10,-10}},
            rotation=180,
            origin={170,154})));
      Modelica.Blocks.Sources.RealExpression IQMIN_(y=ccl_reecc.Iqmin) annotation (
          Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=180,
            origin={170,104})));
      Modelica.Blocks.Nonlinear.VariableLimiter variableLimiter
        annotation (Placement(transformation(extent={{266,150},{286,170}})));
      Modelica.Blocks.Sources.RealExpression IQMIN(y=ccl_reecc.Iqmin)
        annotation (Placement(transformation(extent={{286,150},{266,130}})));
      Modelica.Blocks.Sources.RealExpression IQMAX(y=ccl_reecc.Iqmax)
        annotation (Placement(transformation(extent={{286,174},{266,194}})));
      Modelica.Blocks.Tables.CombiTable1Ds VDL1(table=[Vq1,Iq1; Vq2,Iq2; Vq3,Iq3;
            Vq4,Iq4],
        smoothness=Modelica.Blocks.Types.Smoothness.LinearSegments,
        extrapolation=Modelica.Blocks.Types.Extrapolation.HoldLastPoint)
        annotation (Placement(transformation(extent={{56,-60},{76,-40}})));
      Modelica.Blocks.Tables.CombiTable1Ds VDL2(table=[Vp1,Ip1; Vp2,Ip2; Vp3,Ip3;
            Vp4,Ip4],
        smoothness=Modelica.Blocks.Types.Smoothness.LinearSegments,
        extrapolation=Modelica.Blocks.Types.Extrapolation.HoldLastPoint)
        annotation (Placement(transformation(extent={{56,-60},{76,-80}})));
      OpenIPSL.Electrical.Renewables.PSSE.ElectricalController.BaseClasses.CurrentLimitLogicREECC
        ccl_reecc(
        start_ii=-Iq0,
        start_ir=Ip0,
        Imax=Imax)
        annotation (Placement(transformation(extent={{92,-76},{124,-44}})));
      Modelica.Blocks.Sources.RealExpression IQCMD(y=Iqcmd)
        annotation (Placement(transformation(extent={{168,-48},{148,-28}})));
      Modelica.Blocks.Sources.BooleanConstant PQFLAG(k=pqflag)
        annotation (Placement(transformation(extent={{168,-50},{148,-70}})));
      Modelica.Blocks.Sources.RealExpression IPCMD(y=Ipcmd)
        annotation (Placement(transformation(extent={{168,-72},{148,-92}})));

      Modelica.Blocks.Math.Division division1
        annotation (Placement(transformation(extent={{-60,-110},{-40,-130}})));
      Modelica.Blocks.Math.Add add6(k2=-1)
        annotation (Placement(transformation(extent={{14,-210},{34,-190}})));
      Modelica.Blocks.Continuous.PI PI(
        k=Kqp,
        T=Kqp/Kqi,
        initType=Modelica.Blocks.Types.Init.InitialOutput,
        y_start=V0)
        annotation (Placement(transformation(extent={{-80,124},{-60,144}})));
      Modelica.Blocks.Continuous.PI PI1(
        k=Kvp,
        T=Kvp/Kvi,
        initType=Modelica.Blocks.Types.Init.InitialOutput,
        y_start=-Iq0)
        annotation (Placement(transformation(extent={{100,124},{120,144}})));
      Modelica.Blocks.Continuous.PI PI2(
        k=Kpp,
        T=Kpp/Kpi,
        initType=Modelica.Blocks.Types.Init.InitialOutput,
        y_start=Ip0*V0)
        annotation (Placement(transformation(extent={{50,-210},{70,-190}})));
      Modelica.Blocks.Continuous.FirstOrder Vt_sensor(
        k=1,
        T=Trv,
        initType=Modelica.Blocks.Types.Init.InitialOutput,
        y_start=V0)
        annotation (Placement(transformation(extent={{-280,230},{-260,250}})));
      Modelica.Blocks.Continuous.FirstOrder P_sensor(
        k=1,
        T=Tp,
        initType=Modelica.Blocks.Types.Init.InitialOutput,
        y_start=p00)
        annotation (Placement(transformation(extent={{-278,150},{-258,170}})));
      Modelica.Blocks.Continuous.FirstOrder Q_sensor(
        k=1,
        T=Tp,
        initType=Modelica.Blocks.Types.Init.InitialOutput,
        y_start=q00)
        annotation (Placement(transformation(extent={{-282,70},{-262,90}})));
      Modelica.Blocks.Continuous.FirstOrder Filter(
        k=1,
        T=Tpord,
        initType=Modelica.Blocks.Types.Init.InitialOutput,
        y_start=Ip0*V0)
        annotation (Placement(transformation(extent={{-144,-136},{-124,-116}})));
    protected
      parameter Real pfaref=p00/sqrt(p00^2 +q00^2) "Power Factor of choice.";
      parameter OpenIPSL.Types.Angle pfangle = if q00 > 0 then acos(pfaref) else -acos(pfaref);
      parameter OpenIPSL.Types.PerUnit Ip0(fixed=false);
      parameter OpenIPSL.Types.PerUnit Iq0(fixed=false);
      parameter OpenIPSL.Types.PerUnit V0(fixed=false);
      parameter OpenIPSL.Types.PerUnit p00(fixed=false);
      parameter OpenIPSL.Types.PerUnit q00(fixed=false);
      parameter OpenIPSL.Types.PerUnit Vref0 = if vref0 == 0 then V0 else vref0;

    initial equation

      Ip0 = ip0;
      Iq0 = iq0;
      V0 = v0;
      p00 = p0;
      q00 = q0;
    equation

      Voltage_dip = if Vt<Vdip or Vt>Vup then 1 else 0;

      connect(Paux, add7.u2) annotation (Line(points={{-320,-160},{-26,-160},{-26,-136},
              {-20,-136}}, color={0,0,127}));
      connect(variableLimiter2.y, Ipcmd)
        annotation (Line(points={{249,-160},{288,-160},{288,-170},{310,-170}},
                                                         color={0,0,127}));
      connect(add7.y,variableLimiter2. u) annotation (Line(points={{3,-130},{114,-130},
              {114,-160},{226,-160}}, color={0,0,127}));
      connect(product2.y,variableLimiter2. limit1) annotation (Line(points={{203,-126},
              {180,-126},{180,-152},{226,-152}},
                                      color={0,0,127}));
      connect(IPMAX.y,product2. u1)
        annotation (Line(points={{229,-120},{226,-120}}, color={0,0,127}));
      connect(product3.u2,IPMIN. y)
        annotation (Line(points={{226,-184},{229,-184}}, color={0,0,127}));
      connect(variableLimiter2.limit2,product3. y) annotation (Line(points={{226,-168},
              {180,-168},{180,-190},{203,-190}}, color={0,0,127}));
      connect(product2.u2,SOC_ipmax. y)
        annotation (Line(points={{226,-132},{229,-132}},
                                                       color={0,0,127}));
      connect(product3.u1,SOC_ipmin. y)
        annotation (Line(points={{226,-196},{229,-196}}, color={0,0,127}));
      connect(limiter2.y,add2. u1)
        annotation (Line(points={{-143,146},{-136,146}}, color={0,0,127}));
      connect(limiter4.y,add5. u1) annotation (Line(points={{47,134},{52,134},{52,140},
              {56,140}}, color={0,0,127}));
      connect(IQMAX_.y,variableLimiter1. limit1) annotation (Line(points={{159,154},
              {152,154},{152,138},{156,138}}, color={0,0,127}));
      connect(IQMIN_.y,variableLimiter1. limit2) annotation (Line(points={{159,104},
              {152,104},{152,122},{156,122}},
                                            color={0,0,127}));
      connect(IQMIN.y,variableLimiter. limit2) annotation (Line(points={{265,140},{258,
              140},{258,152},{264,152}},
                                      color={0,0,127}));
      connect(IQMAX.y,variableLimiter. limit1) annotation (Line(points={{265,184},{258,
              184},{258,168},{264,168}},
                                       color={0,0,127}));
      connect(VDL2.y[1], ccl_reecc.VDL2_out)
        annotation (Line(points={{77,-70},{88.8,-69.6}}, color={0,0,127}));
      connect(VDL1.y[1], ccl_reecc.VDL1_out) annotation (Line(points={{77,-50},{77,-50.4},
              {88.8,-50.4}}, color={0,0,127}));
      connect(PQFLAG.y, ccl_reecc.pqflag)
        annotation (Line(points={{147,-60},{88.8,-60}},  color={255,0,255}));
      connect(IQCMD.y, ccl_reecc.Iqcmd) annotation (Line(points={{147,-38},{132,-38},{132,-50.4},{127.2,-50.4}},
                                          color={0,0,127}));
      connect(IPCMD.y, ccl_reecc.Ipcmd) annotation (Line(points={{147,-82},{132,-82},{132,-69.6},{127.2,-69.6}},
                                          color={0,0,127}));
      connect(variableLimiter.y, Iqcmd)
        annotation (Line(points={{287,160},{294,160},{294,170},{310,170}},
                                                     color={0,0,127}));
      connect(limiter3.y, limiter4.u)
        annotation (Line(points={{-19,134},{24,134}}, color={0,0,127}));
      connect(variableLimiter1.y, variableLimiter.u) annotation (Line(points={{
              179,130},{202,130},{202,132},{228,132},{228,160},{264,160}},
            color={0,0,127}));
      connect(VDL2.u, VDL1.u) annotation (Line(points={{54,-70},{20,-70},{20,
              -50},{54,-50}}, color={0,0,127}));
      connect(limiter8.y, division1.u1)
        annotation (Line(points={{-81,-126},{-62,-126}}, color={0,0,127}));
      connect(limiter5.y, division1.u2) annotation (Line(points={{-79,-80},{-70,
              -80},{-70,-114},{-62,-114}}, color={0,0,127}));
      connect(division1.y, add7.u1) annotation (Line(points={{-39,-120},{-39,
              -124},{-20,-124}}, color={0,0,127}));
      connect(add6.u1, Pref) annotation (Line(points={{12,-194},{-280,-194},{
              -280,-80},{-320,-80}}, color={0,0,127}));
      connect(Qext, limiter2.u) annotation (Line(points={{-320,0},{-196,0},{
              -196,146},{-166,146}}, color={0,0,127}));
      connect(PI.y, limiter3.u)
        annotation (Line(points={{-59,134},{-42,134}}, color={0,0,127}));
      connect(PI.u, add2.y) annotation (Line(points={{-82,134},{-82,140},{-113,
              140}}, color={0,0,127}));
      connect(add5.y, PI1.u)
        annotation (Line(points={{79,134},{98,134}}, color={0,0,127}));
      connect(PI1.y, variableLimiter1.u) annotation (Line(points={{121,134},{
              121,130},{156,130}}, color={0,0,127}));
      connect(add6.y, PI2.u)
        annotation (Line(points={{35,-200},{48,-200}}, color={0,0,127}));
      connect(Vt, Vt_sensor.u)
        annotation (Line(points={{-320,240},{-282,240}}, color={0,0,127}));
      connect(Vt_sensor.y, add5.u2) annotation (Line(points={{-259,240},{-106,
              240},{-106,238},{48,238},{48,128},{56,128}}, color={0,0,127}));
      connect(Vt_sensor.y, VDL1.u) annotation (Line(points={{-259,240},{-100,
              240},{-100,-50},{54,-50}}, color={0,0,127}));
      connect(limiter5.u, VDL1.u) annotation (Line(points={{-102,-80},{-122,-80},
              {-122,-78},{-142,-78},{-142,-18},{-100,-18},{-100,-50},{54,-50}},
            color={0,0,127}));
      connect(Pe, P_sensor.u)
        annotation (Line(points={{-320,160},{-280,160}}, color={0,0,127}));
      connect(P_sensor.y, add6.u2) annotation (Line(points={{-257,160},{-230,
              160},{-230,-206},{12,-206}}, color={0,0,127}));
      connect(Qgen, Q_sensor.u)
        annotation (Line(points={{-320,80},{-284,80}}, color={0,0,127}));
      connect(Q_sensor.y, add2.u2) annotation (Line(points={{-261,80},{-136,80},
              {-136,134}}, color={0,0,127}));
      connect(Filter.y, limiter8.u)
        annotation (Line(points={{-123,-126},{-104,-126}}, color={0,0,127}));
      connect(Filter.u, PI2.y) annotation (Line(points={{-146,-126},{-170,-126},
              {-170,-128},{-178,-128},{-178,-172},{100,-172},{100,-200},{71,
              -200}}, color={0,0,127}));
      annotation (Documentation(info="<html>
<p>
The REECCU1 component is an augmented version of the existing renewable energy electrical control (REECA1) model, and can be utilized to represent
both type 3 and type 4 wind turbine electrical controllers as well as photovoltaic electrical controllers. The REECCU1 component can be connected to the
plant controller (REPCA1). This electrical controller provides real (Ipcmd) and reactive (Iqcmd) current commands to the REGCA1 component, which are the outputs
of this component.
</p>
<p>
For initialization purposes, there are 5 inputs that are derived from the inverter component: initial real and reactive injection currents (IP0 and IQ0), initial terminal voltage (v_0), and initial active and reactive power
injections (p_0 and q_0).
</p>
<p>
In terms of connectivity with other components to form the renewable source, the REECCU1 component has six inputs, three of which are connected to the inverter component
(for instance REGCA1), two more that can either be constant values from the power flow initialization or come from the connection to the plant controller, and
an auxiliary input variable that is rarely used (usually constant and zero). The three REECCU1 inputs that take in values from the output of the inverter model
are Vt, Pgen, and Qgen while the two inputs that could potentially be constant valued or come from the plant controller are Pref, and Qext.
</p>
<p>The modelling of such devices is based, mainly, on the following references:</p>
<ul>
<li>Siemens: \"PSS&reg;E Model Library\"
<a href=\"modelica://OpenIPSL.UsersGuide.References\">[PSSE-MODELS]</a>,</li>
<li>WECC: \"Battery Storage Dynamic Modeling Guideline\"
<a href=\"modelica://OpenIPSL.UsersGuide.References\">[WECCBattery]</a>.</li>
</ul>

</html>"));
    end REECCU1_Local_V_Q_Control_for_Linearization_OBSERVABILITY;

    model BESS_SYS_ID "Renewable energy generator/converter model A"
      extends Electrical.Renewables.PSSE.InverterInterface.BaseClasses.BaseREGC;
      Modelica.Blocks.Continuous.TransferFunction Reactive_Power_TF(
        b={3.428822928964258,8.574859520083768e+02},
        a={1,17.538254500590522,8.554044057853242e+02},
        initType=Modelica.Blocks.Types.Init.InitialOutput,
        y_start=0)
        annotation (Placement(transformation(extent={{-80,70},{-60,90}})));
      Modelica.Blocks.Continuous.TransferFunction Active_Power_TF(
        b={4.063164721520125,6.451600975259250e+02},
        a={1,7.667559167447216,6.421894365118068e+02},
        initType=Modelica.Blocks.Types.Init.InitialOutput,
        y_start=0)
        annotation (Placement(transformation(extent={{-80,-90},{-60,-70}})));
      Modelica.Blocks.Math.Division division
        annotation (Placement(transformation(extent={{0,60},{20,80}})));
      Modelica.Blocks.Math.Division division1
        annotation (Placement(transformation(extent={{0,-60},{20,-80}})));
      Modelica.Blocks.Sources.RealExpression Vt(y=VT)
        annotation (Placement(transformation(extent={{-120,-10},{-100,10}})));
      Modelica.Blocks.Math.Gain IP(k=1)
        annotation (Placement(transformation(extent={{84,-86},{104,-66}})));
      Modelica.Blocks.Sources.Constant const(k=q0)
        annotation (Placement(transformation(extent={{-88,40},{-68,60}})));
      Modelica.Blocks.Math.Add sum
        annotation (Placement(transformation(extent={{-46,-96},{-26,-76}})));
      Modelica.Blocks.Sources.Constant const1(k=p0)
        annotation (Placement(transformation(extent={{-80,-124},{-60,-104}})));
      Modelica.Blocks.Math.Gain IQ(k=-1)
        annotation (Placement(transformation(extent={{82,60},{102,80}})));
      Modelica.Blocks.Math.Add sum1
        annotation (Placement(transformation(extent={{-48,64},{-28,84}})));
    equation
      [IP.y; IQ.y] = -[cos(delta),sin(delta); -sin(delta),cos(delta)]*[p.ir; p.ii];
      V_t = VT;
      Pgen = -((p.vr*p.ir + p.vi*p.ii));
      Qgen = -((p.vi*p.ir - p.vr*p.ii));
      IQ0 = Iq0;
      IP0 = Ip0;
      V_0 = v_0;
      p_0 = p0;
      q_0 = q0;
      //Pgen = p0 + Active_Power_TF.y;
      //Qgen = q0 + Reactive_Power_TF.y;

      connect(Iqcmd, Reactive_Power_TF.u)
        annotation (Line(points={{-160,80},{-82,80}}, color={0,0,127}));
      connect(Ipcmd, Active_Power_TF.u)
        annotation (Line(points={{-160,-80},{-82,-80}}, color={0,0,127}));
      connect(Vt.y, division.u2) annotation (Line(points={{-99,0},{-16,0},{-16,64},{
              -2,64}}, color={0,0,127}));
      connect(division1.u2, division.u2) annotation (Line(points={{-2,-64},{-16,-64},
              {-16,64},{-2,64}}, color={0,0,127}));
      connect(const.y, sum1.u2) annotation (Line(points={{-67,50},{-50,50},{-50,
              68}}, color={0,0,127}));
      connect(const1.y, sum.u2) annotation (Line(points={{-59,-114},{-56,-114},
              {-56,-92},{-48,-92}}, color={0,0,127}));
      connect(sum1.y, division.u1)
        annotation (Line(points={{-27,74},{-27,76},{-2,76}}, color={0,0,127}));
      connect(Reactive_Power_TF.y, sum1.u1)
        annotation (Line(points={{-59,80},{-50,80}}, color={0,0,127}));
      connect(division.y, IQ.u)
        annotation (Line(points={{21,70},{80,70}}, color={0,0,127}));
      connect(Active_Power_TF.y, sum.u1)
        annotation (Line(points={{-59,-80},{-48,-80}}, color={0,0,127}));
      connect(sum.y, division1.u1) annotation (Line(points={{-25,-86},{-10,-86},
              {-10,-76},{-2,-76}}, color={0,0,127}));
      connect(division1.y, IP.u) annotation (Line(points={{21,-70},{72,-70},{72,
              -76},{82,-76}}, color={0,0,127}));
      annotation (Icon(graphics={Text(
              extent={{-82,70},{98,-70}},
              textColor={0,0,255},
              textString="REGCA")}), Documentation(info="<html>
<p>The REGCA1 component is used to represent the renewable source (inverter) interface with the grid. It takes in as input the real current command
(Ipcmd) and the reactive current command (Iqcmd) from the electrical controller, and outputs real (Ip) and reactive (Iq) injected currents to the grid through
OpenIPSL's proprietary pwpin connector.</p>
<p>In order to properly initialize all the components that form the renewable energy source, the REGC_A component has five initialization outputs, which its constant output originates from the
starting power flow: initial real and reactive injection currents (IP0 and IQ0), initial terminal voltage (v_0), and initial active and reactive power
injections (p_0 and q_0). This method reduces repetitiveness of initialization calculation, being calculated once at the REGCA1 component.</p>
<p>The connection with other components requires a closed loop through terminal voltage variable (V_t), and active and reactive power generation (Pgen and Qgen).</p>
<p>The modelling of such devices is based, mainly, on the following reference:</p>
<ul>
<li><p>Siemens: \"PSS&reg;E Model Library\"
<a href=\"modelica://OpenIPSL.UsersGuide.References\">[PSSE-MODELS]</a>.</p>
</li>
</ul>
</html>"));
    end BESS_SYS_ID;

    model PV_SYS_ID "Renewable energy generator/converter model A"
      extends Electrical.Renewables.PSSE.InverterInterface.BaseClasses.BaseREGC;
      Modelica.Blocks.Continuous.TransferFunction Reactive_Power_TF(
        b={21.916251174645980,3.778205257510669e+02},
        a={1,47.183073739791580,3.760117118304910e+02},
        initType=Modelica.Blocks.Types.Init.InitialOutput,
        y_start=0)
        annotation (Placement(transformation(extent={{-80,70},{-60,90}})));
      Modelica.Blocks.Continuous.TransferFunction Active_Power_TF(
        b={4.124637082873321,6.427072745480649e+02},
        a={1,7.654218691334363,6.417212936877655e+02},
        initType=Modelica.Blocks.Types.Init.InitialOutput,
        y_start=p0)
        annotation (Placement(transformation(extent={{-80,-90},{-60,-70}})));
      Modelica.Blocks.Math.Division division
        annotation (Placement(transformation(extent={{0,60},{20,80}})));
      Modelica.Blocks.Math.Division division1
        annotation (Placement(transformation(extent={{0,-60},{20,-80}})));
      Modelica.Blocks.Sources.RealExpression Vt(y=VT)
        annotation (Placement(transformation(extent={{-120,-10},{-100,10}})));
      Modelica.Blocks.Math.Gain IP(k=1)
        annotation (Placement(transformation(extent={{84,-86},{104,-66}})));
      Modelica.Blocks.Sources.Constant const(k=q0)
        annotation (Placement(transformation(extent={{-88,40},{-68,60}})));
      Modelica.Blocks.Math.Gain IQ(k=-1)
        annotation (Placement(transformation(extent={{82,60},{102,80}})));
      Modelica.Blocks.Math.Add sum1
        annotation (Placement(transformation(extent={{-48,64},{-28,84}})));
    equation
      [IP.y; IQ.y] = -[cos(delta),sin(delta); -sin(delta),cos(delta)]*[p.ir; p.ii];
      V_t = VT;
      Pgen = -((p.vr*p.ir + p.vi*p.ii));
      Qgen = -((p.vi*p.ir - p.vr*p.ii));
      IQ0 = Iq0;
      IP0 = Ip0;
      V_0 = v_0;
      p_0 = p0;
      q_0 = q0;
      //Pgen = p0 + Active_Power_TF.y;
      //Qgen = q0 + Reactive_Power_TF.y;

      connect(Iqcmd, Reactive_Power_TF.u)
        annotation (Line(points={{-160,80},{-82,80}}, color={0,0,127}));
      connect(Ipcmd, Active_Power_TF.u)
        annotation (Line(points={{-160,-80},{-82,-80}}, color={0,0,127}));
      connect(Vt.y, division.u2) annotation (Line(points={{-99,0},{-16,0},{-16,64},{
              -2,64}}, color={0,0,127}));
      connect(division1.u2, division.u2) annotation (Line(points={{-2,-64},{-16,-64},
              {-16,64},{-2,64}}, color={0,0,127}));
      connect(const.y, sum1.u2) annotation (Line(points={{-67,50},{-50,50},{-50,
              68}}, color={0,0,127}));
      connect(sum1.y, division.u1)
        annotation (Line(points={{-27,74},{-27,76},{-2,76}}, color={0,0,127}));
      connect(Reactive_Power_TF.y, sum1.u1)
        annotation (Line(points={{-59,80},{-50,80}}, color={0,0,127}));
      connect(division.y, IQ.u)
        annotation (Line(points={{21,70},{80,70}}, color={0,0,127}));
      connect(division1.y, IP.u) annotation (Line(points={{21,-70},{72,-70},{72,
              -76},{82,-76}}, color={0,0,127}));
      connect(Active_Power_TF.y, division1.u1) annotation (Line(points={{-59,
              -80},{-12,-80},{-12,-76},{-2,-76}}, color={0,0,127}));
      annotation (Icon(graphics={Text(
              extent={{-82,70},{98,-70}},
              textColor={0,0,255},
              textString="REGCA")}), Documentation(info="<html>
<p>The REGCA1 component is used to represent the renewable source (inverter) interface with the grid. It takes in as input the real current command
(Ipcmd) and the reactive current command (Iqcmd) from the electrical controller, and outputs real (Ip) and reactive (Iq) injected currents to the grid through
OpenIPSL's proprietary pwpin connector.</p>
<p>In order to properly initialize all the components that form the renewable energy source, the REGC_A component has five initialization outputs, which its constant output originates from the
starting power flow: initial real and reactive injection currents (IP0 and IQ0), initial terminal voltage (v_0), and initial active and reactive power
injections (p_0 and q_0). This method reduces repetitiveness of initialization calculation, being calculated once at the REGCA1 component.</p>
<p>The connection with other components requires a closed loop through terminal voltage variable (V_t), and active and reactive power generation (Pgen and Qgen).</p>
<p>The modelling of such devices is based, mainly, on the following reference:</p>
<ul>
<li><p>Siemens: \"PSS&reg;E Model Library\"
<a href=\"modelica://OpenIPSL.UsersGuide.References\">[PSSE-MODELS]</a>.</p>
</li>
</ul>
</html>"));
    end PV_SYS_ID;

    package PSSE
      model G1 "Generation unit connected to bus BG1"
        outer OpenIPSL.Electrical.SystemBase SysData;
        extends OpenIPSL.Electrical.Essentials.pfComponent;

        OpenIPSL.Interfaces.PwPin conn annotation (Placement(transformation(extent={{
                  100,-10},{120,10}}), iconTransformation(extent={{100,-10},{120,10}})));
        OpenIPSL.Electrical.Machines.PSSE.GENROE gen(
          M_b=100000000,
          Tpd0=5,
          Tppd0=0.07,
          Tppq0=0.09,
          H=4.28,
          D=0,
          Xd=1.84,
          Xq=1.75,
          Xpd=0.41,
          Xppd=0.2,
          Xl=0.12,
          S10=0.11,
          S12=0.39,
          Xppq=0.2,
          R_a=0,
          V_b=V_b,
          v_0=v_0,
          angle_0=angle_0,
          P_0=P_0,
          Q_0=Q_0,
          Xpq=0.1,
          Tpq0=2)  annotation (Placement(transformation(extent={{32,-20},{72,20}})));
        OpenIPSL.Electrical.Controls.PSSE.ES.SEXS SEXS(T_E=0.1)
          annotation (Placement(transformation(extent={{-10,0},{10,20}})));
        OpenIPSL.Electrical.Controls.PSSE.TG.IEESGO IEESGO
          annotation (Placement(transformation(extent={{-6,-52},{14,-32}})));
        Modelica.Blocks.Sources.Constant non_active_inputs(k=0)
          annotation (Placement(transformation(extent={{-60,-20},{-40,0}})));
      equation
        connect(gen.p, conn)
          annotation (Line(points={{72,0},{110,0}}, color={0,0,255}));
        connect(SEXS.EFD0, gen.EFD0) annotation (Line(points={{-11,6},{-20,6},{-20,-24},
                {80,-24},{80,-10},{74,-10}}, color={0,0,127}));
        connect(SEXS.ECOMP, gen.ETERM) annotation (Line(points={{-11,10},{-20,10},{-20,
                28},{80,28},{80,-6},{74,-6}}, color={0,0,127}));
        connect(IEESGO.SPEED, gen.SPEED) annotation (Line(points={{-4,-36},{-24,-36},
                {-24,32},{84,32},{84,14},{74,14}}, color={0,0,127}));
        connect(IEESGO.PMECH0, gen.PMECH0) annotation (Line(points={{-4,-48},{-10,-48},
                {-10,-56},{84,-56},{84,10},{74,10}}, color={0,0,127}));
        connect(non_active_inputs.y, SEXS.VOTHSG) annotation (Line(points={{-39,-10},
                {-16,-10},{-16,14},{-11,14}}, color={0,0,127}));
        connect(IEESGO.PMECH, gen.PMECH) annotation (Line(points={{15,-42},{20,-42},{
                20,12},{28,12}}, color={0,0,127}));
        connect(SEXS.EFD, gen.EFD) annotation (Line(points={{11,10},{16,10},{16,-12},
                {28,-12}}, color={0,0,127}));
        connect(gen.XADIFD, SEXS.XADIFD) annotation (Line(points={{74,-18},{78,-18},{
                78,-22},{8,-22},{8,-1}}, color={0,0,127}));
        connect(non_active_inputs.y, SEXS.VUEL)
          annotation (Line(points={{-39,-10},{-4,-10},{-4,-1}}, color={0,0,127}));
        connect(non_active_inputs.y, SEXS.VOEL)
          annotation (Line(points={{-39,-10},{0,-10},{0,-1}}, color={0,0,127}));
        annotation (Icon(coordinateSystem(preserveAspectRatio=false), graphics={
                Ellipse(
                extent={{-100,100},{100,-100}},
                lineColor={0,0,0},
                fillColor={255,255,255},
                fillPattern=FillPattern.Solid),Line(
                points={{-48,2},{-20,56},{2,4},{24,-28},{48,22}},
                color={0,0,0},
                smooth=Smooth.Bezier),Text(
                extent={{-52,-18},{56,-66}},
                lineColor={0,0,0},
                fillColor={255,255,255},
                fillPattern=FillPattern.Solid,
                textString="%name")}),
          Documentation(info="<html>
<p>24kV/100MVA generation unit connected to bus BG1, and composed of the following component models:</p>
<ul>
<li><strong>Machine</strong>: GENSAL, a salient pole synchronous machine from PSSE.</li>
<li><strong>Exciter</strong>: SEXS, a simplified excitation system from PSSE.</li>
<li><strong>Turbine/Governor</strong>: HYGOV, a hydro-turbine governor from PSSE.</li>
</ul>
</html>"));
      end G1;

      model G2_1INPUT_Pref "Generation unit connected to bus B5"
        outer OpenIPSL.Electrical.SystemBase SysData;
        extends OpenIPSL.Electrical.Essentials.pfComponent;

        OpenIPSL.Interfaces.PwPin conn annotation (Placement(transformation(extent={{
                  100,-10},{120,10}}), iconTransformation(extent={{100,-10},{120,10}})));
        Electrical.Machines.PSSE.GENSAL          gen(
          M_b=100000000,
          Tpd0=5,
          Tppd0=0.07,
          Tppq0=0.09,
          H=4.28,
          D=0,
          Xd=1.84,
          Xq=1.75,
          Xpd=0.41,
          Xppd=0.2,
          Xl=0.12,
          S10=0.11,
          S12=0.39,
          Xppq=0.2,
          R_a=0,
          V_b=V_b,
          v_0=v_0,
          angle_0=angle_0,
          P_0=P_0,
          Q_0=Q_0) annotation (Placement(transformation(extent={{38,-20},{78,20}})));
        OpenIPSL.Electrical.Controls.PSSE.ES.SEXS sEXS(
          T_AT_B=0.2,
          K=50,
          E_MIN=0,
          E_MAX=1.26,
          T_E=0.01,
          T_B=10) annotation (Placement(transformation(extent={{-16,-22},{4,-2}})));
        Modelica.Blocks.Sources.Constant non_active_limits(k=0)
          annotation (Placement(transformation(extent={{80,-60},{60,-40}})));
        Modelica.Blocks.Interfaces.RealInput P_ref
          "Connector of Real input signal 2"
          annotation (Placement(transformation(extent={{-140,-20},{-100,20}})));
        Electrical.Controls.PSSE.TG.IEESGO          iEESGO(P_MAX=1.5, P_MIN=0)
          annotation (Placement(transformation(extent={{-20,20},{0,40}})));
        Modelica.Blocks.Math.Add add
          annotation (Placement(transformation(extent={{-72,50},{-52,30}})));
        Modelica.Blocks.Interfaces.RealOutput SPEED1
          "Machine speed deviation from nominal [pu]"
          annotation (Placement(transformation(extent={{100,50},{120,70}})));
      equation
        connect(gen.p, conn)
          annotation (Line(points={{78,0},{110,0}}, color={0,0,255}));
        connect(sEXS.EFD, gen.EFD)
          annotation (Line(points={{5,-12},{34,-12}}, color={0,0,127}));
        connect(sEXS.ECOMP, gen.ETERM) annotation (Line(points={{-17,-12},{-32,-12},{
                -32,-72},{92,-72},{92,-6},{80,-6}}, color={0,0,127}));
        connect(gen.EFD0, sEXS.EFD0) annotation (Line(points={{80,-10},{88,-10},{88,
                -68},{-28,-68},{-28,-16},{-17,-16}}, color={0,0,127}));
        connect(non_active_limits.y, sEXS.VOEL)
          annotation (Line(points={{59,-50},{-6,-50},{-6,-23}}, color={0,0,127}));
        connect(sEXS.VUEL, sEXS.VOEL) annotation (Line(points={{-10,-23},{-10,-32},{
                -6,-32},{-6,-23}}, color={0,0,127}));
        connect(gen.XADIFD, sEXS.XADIFD) annotation (Line(points={{80,-18},{84,-18},{
                84,-34},{2,-34},{2,-23}}, color={0,0,127}));
        connect(sEXS.VOTHSG, sEXS.VOEL) annotation (Line(points={{-17,-8},{-22,-8},{
                -22,-32},{-6,-32},{-6,-23}}, color={0,0,127}));
        connect(gen.SPEED, iEESGO.SPEED) annotation (Line(points={{80,14},{86,14},{
                86,54},{-28,54},{-28,36},{-18,36}}, color={0,0,127}));
        connect(iEESGO.PMECH, gen.PMECH) annotation (Line(points={{1,30},{24,30},{
                24,12},{34,12}}, color={0,0,127}));
        connect(add.u1, P_ref) annotation (Line(points={{-74,34},{-94,34},{-94,0},{
                -120,0}}, color={0,0,127}));
        connect(gen.PMECH0, add.u2) annotation (Line(points={{80,10},{90,10},{90,64},
                {-82,64},{-82,46},{-74,46}}, color={0,0,127}));
        connect(add.y, iEESGO.PMECH0) annotation (Line(points={{-51,40},{-40,40},{
                -40,24},{-18,24}}, color={0,0,127}));
        connect(gen.SPEED, SPEED1) annotation (Line(points={{80,14},{86,14},{86,66},
                {96,66},{96,60},{110,60}}, color={0,0,127}));
        annotation (Icon(coordinateSystem(preserveAspectRatio=false, extent={{-100,-100},
                  {100,100}}), graphics={Ellipse(
                extent={{-100,100},{100,-100}},
                lineColor={0,0,0},
                fillColor={255,255,255},
                fillPattern=FillPattern.Solid),Line(
                points={{-48,2},{-20,56},{2,4},{24,-28},{48,22}},
                color={0,0,0},
                smooth=Smooth.Bezier),Text(
                extent={{-52,-18},{56,-66}},
                lineColor={0,0,0},
                fillColor={255,255,255},
                fillPattern=FillPattern.Solid,
                textString="%name")}),
          Documentation(info="<html>
<p>24kV/100MVA generation unit connected to bus BG1, and composed of the following component models:</p>
<ul>
<li><strong>Machine</strong>: GENSAL, a salient pole synchronous machine from PSSE.</li>
<li><strong>Exciter</strong>: SEXS, a simplified excitation system from PSSE.</li>
<li><strong>Turbine/Governor</strong>: IEESGO, a standard turbine/governor from PSSE.</li>
</ul>
<p>This generation unit is supposed to be disconnected in all experiments and, then, to be resynchronized to the whole system.</p>
</html>"));
      end G2_1INPUT_Pref;

      model G2_for_PID "Generation unit connected to bus B5"
        outer OpenIPSL.Electrical.SystemBase SysData;
        extends OpenIPSL.Electrical.Essentials.pfComponent;

        OpenIPSL.Interfaces.PwPin conn annotation (Placement(transformation(extent={{
                  100,-10},{120,10}}), iconTransformation(extent={{100,-10},{120,10}})));
        OpenIPSL.Electrical.Machines.PSSE.GENROE gen(
          M_b=100000000,
          Tpd0=5,
          Tppd0=0.07,
          Tppq0=0.09,
          H=4.28,
          D=0,
          Xd=1.84,
          Xq=1.75,
          Xpd=0.41,
          Xppd=0.2,
          Xl=0.12,
          S10=0.11,
          S12=0.39,
          Xppq=0.2,
          R_a=0,
          V_b=V_b,
          v_0=v_0,
          angle_0=angle_0,
          P_0=P_0,
          Q_0=Q_0,
          Xpq=0.41,
          Tpq0=1)  annotation (Placement(transformation(extent={{38,-20},{78,20}})));
        Modelica.Blocks.Interfaces.RealInput Padd "Connector of Real input signal 2"
          annotation (Placement(transformation(extent={{-140,60},{-100,100}})));
        Modelica.Blocks.Interfaces.RealInput EfdAdd
          "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-140,-100},{-100,-60}})));
        Modelica.Blocks.Interfaces.RealOutput PELEC1
                                   "Machine electrical power (machine base)"
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={90,110})));
        Modelica.Blocks.Interfaces.RealOutput ETERM1
                                    "Machine terminal voltage [pu]" annotation (
            Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=270,
              origin={90,-110})));
      equation
        connect(gen.p, conn)
          annotation (Line(points={{78,0},{110,0}}, color={0,0,255}));
        connect(gen.PELEC, PELEC1) annotation (Line(points={{80,6},{92,6},{92,96},{90,
                96},{90,110}}, color={0,0,127}));
        connect(gen.ETERM, ETERM1) annotation (Line(points={{80,-6},{94,-6},{94,-96},
                {90,-96},{90,-110}}, color={0,0,127}));
        connect(Padd, gen.PMECH) annotation (Line(points={{-120,80},{24,80},{24,12},{
                34,12}}, color={0,0,127}));
        connect(EfdAdd, gen.EFD) annotation (Line(points={{-120,-80},{24,-80},{24,-12},
                {34,-12}}, color={0,0,127}));
        annotation (Icon(coordinateSystem(preserveAspectRatio=false, extent={{-100,-100},
                  {100,100}}), graphics={Ellipse(
                extent={{-100,100},{100,-100}},
                lineColor={0,0,0},
                fillColor={255,255,255},
                fillPattern=FillPattern.Solid),Line(
                points={{-48,2},{-20,56},{2,4},{24,-28},{48,22}},
                color={0,0,0},
                smooth=Smooth.Bezier),Text(
                extent={{-52,-18},{56,-66}},
                lineColor={0,0,0},
                fillColor={255,255,255},
                fillPattern=FillPattern.Solid,
                textString="%name")}),
          Documentation(info="<html>
<p>24kV/100MVA generation unit connected to bus BG1, and composed of the following component models:</p>
<ul>
<li><strong>Machine</strong>: GENSAL, a salient pole synchronous machine from PSSE.</li>
<li><strong>Exciter</strong>: SEXS, a simplified excitation system from PSSE.</li>
<li><strong>Turbine/Governor</strong>: IEESGO, a standard turbine/governor from PSSE.</li>
</ul>
<p>This generation unit is supposed to be disconnected in all experiments and, then, to be resynchronized to the whole system.</p>
</html>"));
      end G2_for_PID;

      model G2_no_controls "Generation unit connected to bus B5"
        outer OpenIPSL.Electrical.SystemBase SysData;
        extends OpenIPSL.Electrical.Essentials.pfComponent;

        OpenIPSL.Interfaces.PwPin conn annotation (Placement(transformation(extent={{
                  100,-10},{120,10}}), iconTransformation(extent={{100,-10},{120,10}})));
        OpenIPSL.Electrical.Machines.PSSE.GENSAL gen(
          M_b=100000000,
          Tpd0=5,
          Tppd0=0.07,
          Tppq0=0.09,
          H=4.28,
          D=0,
          Xd=1.84,
          Xq=1.75,
          Xpd=0.41,
          Xppd=0.2,
          Xl=0.12,
          S10=0.11,
          S12=0.39,
          Xppq=0.2,
          R_a=0,
          V_b=V_b,
          v_0=v_0,
          angle_0=angle_0,
          P_0=P_0,
          Q_0=Q_0) annotation (Placement(transformation(extent={{38,-20},{78,20}})));
        Modelica.Blocks.Interfaces.RealInput Padd "Connector of Real input signal 2"
          annotation (Placement(transformation(extent={{-140,4},{-100,44}})));
        Modelica.Blocks.Interfaces.RealInput EfdAdd
          "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-140,-40},{-100,0}})));
      equation
        connect(gen.p, conn)
          annotation (Line(points={{78,0},{110,0}}, color={0,0,255}));
        connect(EfdAdd, gen.EFD) annotation (Line(points={{-120,-20},{24,-20},{24,-12},
                {34,-12}}, color={0,0,127}));
        connect(Padd, gen.PMECH) annotation (Line(points={{-120,24},{24,24},{24,12},{
                34,12}}, color={0,0,127}));
        annotation (Icon(coordinateSystem(preserveAspectRatio=false, extent={{-100,-100},
                  {100,100}}), graphics={Ellipse(
                extent={{-100,100},{100,-100}},
                lineColor={0,0,0},
                fillColor={255,255,255},
                fillPattern=FillPattern.Solid),Line(
                points={{-48,2},{-20,56},{2,4},{24,-28},{48,22}},
                color={0,0,0},
                smooth=Smooth.Bezier),Text(
                extent={{-52,-18},{56,-66}},
                lineColor={0,0,0},
                fillColor={255,255,255},
                fillPattern=FillPattern.Solid,
                textString="%name")}),
          Documentation(info="<html>
<p>24kV/100MVA generation unit connected to bus BG1, and composed of the following component models:</p>
<ul>
<li><strong>Machine</strong>: GENSAL, a salient pole synchronous machine from PSSE.</li>
<li><strong>Exciter</strong>: SEXS, a simplified excitation system from PSSE.</li>
<li><strong>Turbine/Governor</strong>: IEESGO, a standard turbine/governor from PSSE.</li>
</ul>
<p>This generation unit is supposed to be disconnected in all experiments and, then, to be resynchronized to the whole system.</p>
</html>"));
      end G2_no_controls;

      model G2_1INPUT_Pref_NO_TurbGov "Generation unit connected to bus B5"
        outer OpenIPSL.Electrical.SystemBase SysData;
        extends OpenIPSL.Electrical.Essentials.pfComponent;

        OpenIPSL.Interfaces.PwPin conn annotation (Placement(transformation(extent={{
                  100,-10},{120,10}}), iconTransformation(extent={{100,-10},{120,10}})));
        Electrical.Machines.PSSE.GENSAL          gen(
          M_b=100000000,
          Tpd0=5,
          Tppd0=0.07,
          Tppq0=0.09,
          H=4.28,
          D=0,
          Xd=1.84,
          Xq=1.75,
          Xpd=0.41,
          Xppd=0.2,
          Xl=0.12,
          S10=0.11,
          S12=0.39,
          Xppq=0.2,
          R_a=0,
          V_b=V_b,
          v_0=v_0,
          angle_0=angle_0,
          P_0=P_0,
          Q_0=Q_0) annotation (Placement(transformation(extent={{38,-20},{78,20}})));
        OpenIPSL.Electrical.Controls.PSSE.ES.SEXS sEXS(
          T_AT_B=0.2,
          K=50,
          E_MIN=0,
          E_MAX=1.26,
          T_E=0.01,
          T_B=10) annotation (Placement(transformation(extent={{-16,-22},{4,-2}})));
        Modelica.Blocks.Sources.Constant non_active_limits(k=0)
          annotation (Placement(transformation(extent={{80,-60},{60,-40}})));
        Modelica.Blocks.Interfaces.RealInput P_ref
          "Connector of Real input signal 2"
          annotation (Placement(transformation(extent={{-140,-20},{-100,20}})));
        Modelica.Blocks.Interfaces.RealOutput SPEED1
          "Machine speed deviation from nominal [pu]"
          annotation (Placement(transformation(extent={{100,50},{120,70}})));
        Modelica.Blocks.Math.Add add
          annotation (Placement(transformation(extent={{-60,20},{-40,40}})));
      equation
        connect(gen.p, conn)
          annotation (Line(points={{78,0},{110,0}}, color={0,0,255}));
        connect(sEXS.EFD, gen.EFD)
          annotation (Line(points={{5,-12},{34,-12}}, color={0,0,127}));
        connect(sEXS.ECOMP, gen.ETERM) annotation (Line(points={{-17,-12},{-32,-12},{
                -32,-72},{92,-72},{92,-6},{80,-6}}, color={0,0,127}));
        connect(gen.EFD0, sEXS.EFD0) annotation (Line(points={{80,-10},{88,-10},{88,
                -68},{-28,-68},{-28,-16},{-17,-16}}, color={0,0,127}));
        connect(non_active_limits.y, sEXS.VOEL)
          annotation (Line(points={{59,-50},{-6,-50},{-6,-23}}, color={0,0,127}));
        connect(sEXS.VUEL, sEXS.VOEL) annotation (Line(points={{-10,-23},{-10,-32},{
                -6,-32},{-6,-23}}, color={0,0,127}));
        connect(gen.XADIFD, sEXS.XADIFD) annotation (Line(points={{80,-18},{84,-18},{
                84,-34},{2,-34},{2,-23}}, color={0,0,127}));
        connect(sEXS.VOTHSG, sEXS.VOEL) annotation (Line(points={{-17,-8},{-22,-8},{
                -22,-32},{-6,-32},{-6,-23}}, color={0,0,127}));
        connect(gen.SPEED, SPEED1) annotation (Line(points={{80,14},{86,14},{86,66},
                {96,66},{96,60},{110,60}}, color={0,0,127}));
        connect(P_ref, add.u2) annotation (Line(points={{-120,0},{-80,0},{-80,24},{
                -62,24}}, color={0,0,127}));
        connect(gen.PMECH0, add.u1) annotation (Line(points={{80,10},{92,10},{92,52},
                {-70,52},{-70,36},{-62,36}}, color={0,0,127}));
        connect(add.y, gen.PMECH) annotation (Line(points={{-39,30},{24,30},{24,12},
                {34,12}}, color={0,0,127}));
        annotation (Icon(coordinateSystem(preserveAspectRatio=false, extent={{-100,-100},
                  {100,100}}), graphics={Ellipse(
                extent={{-100,100},{100,-100}},
                lineColor={0,0,0},
                fillColor={255,255,255},
                fillPattern=FillPattern.Solid),Line(
                points={{-48,2},{-20,56},{2,4},{24,-28},{48,22}},
                color={0,0,0},
                smooth=Smooth.Bezier),Text(
                extent={{-52,-18},{56,-66}},
                lineColor={0,0,0},
                fillColor={255,255,255},
                fillPattern=FillPattern.Solid,
                textString="%name")}),
          Documentation(info="<html>
<p>24kV/100MVA generation unit connected to bus BG1, and composed of the following component models:</p>
<ul>
<li><strong>Machine</strong>: GENSAL, a salient pole synchronous machine from PSSE.</li>
<li><strong>Exciter</strong>: SEXS, a simplified excitation system from PSSE.</li>
<li><strong>Turbine/Governor</strong>: IEESGO, a standard turbine/governor from PSSE.</li>
</ul>
<p>This generation unit is supposed to be disconnected in all experiments and, then, to be resynchronized to the whole system.</p>
</html>"));
      end G2_1INPUT_Pref_NO_TurbGov;

      model G2_2INPUT_Pref_Efdref_NO_TurbGov_NO_Exci
        "Generation unit connected to bus B5"
        outer OpenIPSL.Electrical.SystemBase SysData;
        extends OpenIPSL.Electrical.Essentials.pfComponent;

        OpenIPSL.Interfaces.PwPin conn annotation (Placement(transformation(extent={{
                  100,-10},{120,10}}), iconTransformation(extent={{100,-10},{120,10}})));
        Electrical.Machines.PSSE.GENSAL          gen(
          M_b=100000000,
          Tpd0=5,
          Tppd0=0.07,
          Tppq0=0.09,
          H=2,
          D=0,
          Xd=1.84,
          Xq=1.75,
          Xpd=0.41,
          Xppd=0.2,
          Xl=0.12,
          S10=0.11,
          S12=0.39,
          Xppq=0.2,
          R_a=0,
          V_b=V_b,
          v_0=v_0,
          angle_0=angle_0,
          P_0=P_0,
          Q_0=Q_0) annotation (Placement(transformation(extent={{38,-20},{78,20}})));
        Modelica.Blocks.Interfaces.RealInput P_ref
          "Connector of Real input signal 2"
          annotation (Placement(transformation(extent={{-140,20},{-100,60}})));
        Modelica.Blocks.Math.Add add
          annotation (Placement(transformation(extent={{-72,56},{-52,36}})));
        Modelica.Blocks.Interfaces.RealInput Efd_ref
          "Connector of Real input signal 2"
          annotation (Placement(transformation(extent={{-140,-60},{-100,-20}})));
        Modelica.Blocks.Math.Add add1
          annotation (Placement(transformation(extent={{-72,-36},{-52,-56}})));
      equation
        connect(gen.p, conn)
          annotation (Line(points={{78,0},{110,0}}, color={0,0,255}));
        connect(add.u1, P_ref) annotation (Line(points={{-74,40},{-120,40}},
                          color={0,0,127}));
        connect(gen.PMECH0, add.u2) annotation (Line(points={{80,10},{90,10},{90,64},
                {-82,64},{-82,52},{-74,52}}, color={0,0,127}));
        connect(add.y, gen.PMECH) annotation (Line(points={{-51,46},{24,46},{24,12},
                {34,12}}, color={0,0,127}));
        connect(Efd_ref, add1.u2)
          annotation (Line(points={{-120,-40},{-74,-40}}, color={0,0,127}));
        connect(gen.EFD0, add1.u1) annotation (Line(points={{80,-10},{96,-10},{96,
                -70},{-86,-70},{-86,-52},{-74,-52}}, color={0,0,127}));
        connect(add1.y, gen.EFD) annotation (Line(points={{-51,-46},{24,-46},{24,
                -12},{34,-12}}, color={0,0,127}));
        annotation (Icon(coordinateSystem(preserveAspectRatio=false, extent={{-100,-100},
                  {100,100}}), graphics={Ellipse(
                extent={{-100,100},{100,-100}},
                lineColor={0,0,0},
                fillColor={255,255,255},
                fillPattern=FillPattern.Solid),Line(
                points={{-48,2},{-20,56},{2,4},{24,-28},{48,22}},
                color={0,0,0},
                smooth=Smooth.Bezier),Text(
                extent={{-52,-18},{56,-66}},
                lineColor={0,0,0},
                fillColor={255,255,255},
                fillPattern=FillPattern.Solid,
                textString="%name")}),
          Documentation(info="<html>
<p>24kV/100MVA generation unit connected to bus BG1, and composed of the following component models:</p>
<ul>
<li><strong>Machine</strong>: GENSAL, a salient pole synchronous machine from PSSE.</li>
<li><strong>Exciter</strong>: SEXS, a simplified excitation system from PSSE.</li>
<li><strong>Turbine/Governor</strong>: IEESGO, a standard turbine/governor from PSSE.</li>
</ul>
<p>This generation unit is supposed to be disconnected in all experiments and, then, to be resynchronized to the whole system.</p>
</html>"));
      end G2_2INPUT_Pref_Efdref_NO_TurbGov_NO_Exci;

      model G2_1INPUT_Pref_WITH_TurbGov "Generation unit connected to bus B5"
        outer OpenIPSL.Electrical.SystemBase SysData;
        extends OpenIPSL.Electrical.Essentials.pfComponent;

        OpenIPSL.Interfaces.PwPin conn annotation (Placement(transformation(extent={{
                  100,-10},{120,10}}), iconTransformation(extent={{100,-10},{120,10}})));
        Electrical.Machines.PSSE.GENSAL          gen(
          M_b=100000000,
          Tpd0=5,
          Tppd0=0.07,
          Tppq0=0.09,
          H=4.28,
          D=0,
          Xd=1.84,
          Xq=1.75,
          Xpd=0.41,
          Xppd=0.2,
          Xl=0.12,
          S10=0.11,
          S12=0.39,
          Xppq=0.2,
          R_a=0,
          V_b=V_b,
          v_0=v_0,
          angle_0=angle_0,
          P_0=P_0,
          Q_0=Q_0) annotation (Placement(transformation(extent={{38,-20},{78,20}})));
        OpenIPSL.Electrical.Controls.PSSE.ES.SEXS sEXS(
          T_AT_B=0.2,
          K=50,
          E_MIN=0,
          E_MAX=1.26,
          T_E=0.01,
          T_B=10) annotation (Placement(transformation(extent={{-16,-22},{4,-2}})));
        Modelica.Blocks.Sources.Constant non_active_limits(k=0)
          annotation (Placement(transformation(extent={{80,-60},{60,-40}})));
        Modelica.Blocks.Interfaces.RealInput P_ref
          "Connector of Real input signal 2"
          annotation (Placement(transformation(extent={{-140,-20},{-100,20}})));
        Modelica.Blocks.Interfaces.RealOutput SPEED1
          "Machine speed deviation from nominal [pu]"
          annotation (Placement(transformation(extent={{100,50},{120,70}})));
        GASTMPC gASTMPC(T_3=0.01, D_turb=0.1)
          annotation (Placement(transformation(extent={{-18,14},{2,34}})));
        Modelica.Blocks.Interfaces.RealOutput PMECH1
          annotation (Placement(transformation(extent={{100,30},{120,50}})));
        Modelica.Blocks.Interfaces.RealOutput EFD1
                                                  "Excitation Voltage [pu]"
          annotation (Placement(transformation(extent={{100,-40},{120,-20}})));
        Modelica.Blocks.Interfaces.RealOutput ETERM1
                                    "Machine terminal voltage [pu]"
          annotation (Placement(transformation(extent={{100,-70},{120,-50}})));
        Modelica.Blocks.Interfaces.RealOutput PELEC1
                                   "Machine electrical power (machine base)"
          annotation (Placement(transformation(extent={{100,12},{120,32}})));
        Modelica.Blocks.Interfaces.RealOutput TF2_out1
          "Connector of Real output signal"
          annotation (Placement(transformation(extent={{100,76},{120,96}})));
      equation
        connect(gen.p, conn)
          annotation (Line(points={{78,0},{110,0}}, color={0,0,255}));
        connect(sEXS.EFD, gen.EFD)
          annotation (Line(points={{5,-12},{34,-12}}, color={0,0,127}));
        connect(sEXS.ECOMP, gen.ETERM) annotation (Line(points={{-17,-12},{-32,-12},{
                -32,-72},{92,-72},{92,-6},{80,-6}}, color={0,0,127}));
        connect(gen.EFD0, sEXS.EFD0) annotation (Line(points={{80,-10},{88,-10},{88,
                -68},{-28,-68},{-28,-16},{-17,-16}}, color={0,0,127}));
        connect(non_active_limits.y, sEXS.VOEL)
          annotation (Line(points={{59,-50},{-6,-50},{-6,-23}}, color={0,0,127}));
        connect(sEXS.VUEL, sEXS.VOEL) annotation (Line(points={{-10,-23},{-10,-32},{
                -6,-32},{-6,-23}}, color={0,0,127}));
        connect(gen.XADIFD, sEXS.XADIFD) annotation (Line(points={{80,-18},{84,-18},{
                84,-34},{2,-34},{2,-23}}, color={0,0,127}));
        connect(sEXS.VOTHSG, sEXS.VOEL) annotation (Line(points={{-17,-8},{-22,-8},{
                -22,-32},{-6,-32},{-6,-23}}, color={0,0,127}));
        connect(gen.SPEED, SPEED1) annotation (Line(points={{80,14},{86,14},{86,66},
                {96,66},{96,60},{110,60}}, color={0,0,127}));
        connect(gASTMPC.SPEED, SPEED1) annotation (Line(points={{-16,30},{-32,30},{
                -32,54},{86,54},{86,66},{96,66},{96,60},{110,60}}, color={0,0,127}));
        connect(gASTMPC.PMECH0, gen.PMECH0) annotation (Line(points={{-16,18},{-28,
                18},{-28,44},{92,44},{92,10},{80,10}}, color={0,0,127}));
        connect(P_ref, gASTMPC.PMECHControllable) annotation (Line(points={{-120,0},
                {-40,0},{-40,8},{-8,8},{-8,12}}, color={0,0,127}));
        connect(gASTMPC.PMECH, gen.PMECH) annotation (Line(points={{3,24},{22,24},{
                22,12},{34,12}}, color={0,0,127}));
        connect(gASTMPC.PMECH, PMECH1) annotation (Line(points={{3,24},{52,24},{52,
                40},{110,40}}, color={0,0,127}));
        connect(sEXS.EFD, EFD1) annotation (Line(points={{5,-12},{26,-12},{26,-36},
                {94,-36},{94,-30},{110,-30}}, color={0,0,127}));
        connect(gen.ETERM, ETERM1) annotation (Line(points={{80,-6},{92,-6},{92,-60},
                {110,-60}}, color={0,0,127}));
        connect(gen.PELEC, PELEC1) annotation (Line(points={{80,6},{94,6},{94,22},{
                110,22}}, color={0,0,127}));
        connect(gASTMPC.TF2_out, TF2_out1) annotation (Line(points={{1,35},{16,35},
                {16,86},{110,86}}, color={0,0,127}));
        annotation (Icon(coordinateSystem(preserveAspectRatio=false, extent={{-100,-100},
                  {100,100}}), graphics={Ellipse(
                extent={{-100,100},{100,-100}},
                lineColor={0,0,0},
                fillColor={255,255,255},
                fillPattern=FillPattern.Solid),Line(
                points={{-48,2},{-20,56},{2,4},{24,-28},{48,22}},
                color={0,0,0},
                smooth=Smooth.Bezier),Text(
                extent={{-52,-18},{56,-66}},
                lineColor={0,0,0},
                fillColor={255,255,255},
                fillPattern=FillPattern.Solid,
                textString="%name")}),
          Documentation(info="<html>
<p>24kV/100MVA generation unit connected to bus BG1, and composed of the following component models:</p>
<ul>
<li><strong>Machine</strong>: GENSAL, a salient pole synchronous machine from PSSE.</li>
<li><strong>Exciter</strong>: SEXS, a simplified excitation system from PSSE.</li>
<li><strong>Turbine/Governor</strong>: IEESGO, a standard turbine/governor from PSSE.</li>
</ul>
<p>This generation unit is supposed to be disconnected in all experiments and, then, to be resynchronized to the whole system.</p>
</html>"));
      end G2_1INPUT_Pref_WITH_TurbGov;

      model G2_2INPUTS "Generation unit connected to bus B5"
        outer OpenIPSL.Electrical.SystemBase SysData;
        extends OpenIPSL.Electrical.Essentials.pfComponent;

        OpenIPSL.Interfaces.PwPin conn annotation (Placement(transformation(extent={{
                  100,-10},{120,10}}), iconTransformation(extent={{100,-10},{120,10}})));
        Electrical.Machines.PSSE.GENSAL          gen(
          M_b=100000000,
          Tpd0=5,
          Tppd0=0.07,
          Tppq0=0.09,
          H=4.28,
          D=0,
          Xd=1.84,
          Xq=1.75,
          Xpd=0.41,
          Xppd=0.2,
          Xl=0.12,
          S10=0.11,
          S12=0.39,
          Xppq=0.2,
          R_a=0,
          V_b=V_b,
          v_0=v_0,
          angle_0=angle_0,
          P_0=P_0,
          Q_0=Q_0) annotation (Placement(transformation(extent={{38,-20},{78,20}})));
        SEXSMPC                                   sEXSMPC(
          T_AT_B=0.2,
          K=50,
          E_MIN=0,
          E_MAX=10,
          T_E=0.01,
          T_B=10) annotation (Placement(transformation(extent={{-16,-22},{4,-2}})));
        Modelica.Blocks.Sources.Constant non_active_limits(k=0)
          annotation (Placement(transformation(extent={{80,-60},{60,-40}})));
        Modelica.Blocks.Interfaces.RealInput P_ref
          "Connector of Real input signal 2"
          annotation (Placement(transformation(extent={{-140,20},{-100,60}})));
        Modelica.Blocks.Interfaces.RealOutput SPEED1
          "Machine speed deviation from nominal [pu]"
          annotation (Placement(transformation(extent={{100,50},{120,70}})));
        GASTMPC gASTMPC(T_3=0.01, D_turb=0.1)
          annotation (Placement(transformation(extent={{-18,14},{2,34}})));
        Modelica.Blocks.Interfaces.RealOutput PMECH1
          annotation (Placement(transformation(extent={{100,30},{120,50}})));
        Modelica.Blocks.Interfaces.RealOutput EFD1
                                                  "Excitation Voltage [pu]"
          annotation (Placement(transformation(extent={{100,-40},{120,-20}})));
        Modelica.Blocks.Interfaces.RealOutput ETERM1
                                    "Machine terminal voltage [pu]"
          annotation (Placement(transformation(extent={{100,-70},{120,-50}})));
        Modelica.Blocks.Interfaces.RealOutput PELEC1
                                   "Machine electrical power (machine base)"
          annotation (Placement(transformation(extent={{100,12},{120,32}})));
        Modelica.Blocks.Interfaces.RealOutput TF2_out1
          "Connector of Real output signal"
          annotation (Placement(transformation(extent={{100,76},{120,96}})));
        Modelica.Blocks.Interfaces.RealInput Efd_ref
          "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-140,-40},{-100,0}})));
      equation
        connect(gen.p, conn)
          annotation (Line(points={{78,0},{110,0}}, color={0,0,255}));
        connect(sEXSMPC.EFD, gen.EFD)
          annotation (Line(points={{5,-12},{34,-12}}, color={0,0,127}));
        connect(sEXSMPC.ECOMP, gen.ETERM) annotation (Line(points={{-17,-12},{-32,-12},
                {-32,-72},{92,-72},{92,-6},{80,-6}}, color={0,0,127}));
        connect(gen.EFD0, sEXSMPC.EFD0) annotation (Line(points={{80,-10},{88,-10},
                {88,-68},{-28,-68},{-28,-16},{-17,-16}}, color={0,0,127}));
        connect(non_active_limits.y, sEXSMPC.VOEL)
          annotation (Line(points={{59,-50},{-6,-50},{-6,-23}}, color={0,0,127}));
        connect(sEXSMPC.VUEL, sEXSMPC.VOEL) annotation (Line(points={{-10,-23},{-10,
                -32},{-6,-32},{-6,-23}}, color={0,0,127}));
        connect(gen.XADIFD, sEXSMPC.XADIFD) annotation (Line(points={{80,-18},{84,-18},
                {84,-34},{2,-34},{2,-23}}, color={0,0,127}));
        connect(sEXSMPC.VOTHSG, sEXSMPC.VOEL) annotation (Line(points={{-17,-8},{-22,
                -8},{-22,-32},{-6,-32},{-6,-23}}, color={0,0,127}));
        connect(gen.SPEED, SPEED1) annotation (Line(points={{80,14},{86,14},{86,66},
                {96,66},{96,60},{110,60}}, color={0,0,127}));
        connect(gASTMPC.SPEED, SPEED1) annotation (Line(points={{-16,30},{-32,30},{
                -32,54},{86,54},{86,66},{96,66},{96,60},{110,60}}, color={0,0,127}));
        connect(gASTMPC.PMECH0, gen.PMECH0) annotation (Line(points={{-16,18},{-28,
                18},{-28,44},{92,44},{92,10},{80,10}}, color={0,0,127}));
        connect(P_ref, gASTMPC.PMECHControllable) annotation (Line(points={{-120,40},
                {-34,40},{-34,8},{-8,8},{-8,12}},color={0,0,127}));
        connect(gASTMPC.PMECH, gen.PMECH) annotation (Line(points={{3,24},{22,24},{
                22,12},{34,12}}, color={0,0,127}));
        connect(gASTMPC.PMECH, PMECH1) annotation (Line(points={{3,24},{52,24},{52,
                40},{110,40}}, color={0,0,127}));
        connect(sEXSMPC.EFD, EFD1) annotation (Line(points={{5,-12},{26,-12},{26,-36},
                {94,-36},{94,-30},{110,-30}}, color={0,0,127}));
        connect(gen.ETERM, ETERM1) annotation (Line(points={{80,-6},{92,-6},{92,-60},
                {110,-60}}, color={0,0,127}));
        connect(gen.PELEC, PELEC1) annotation (Line(points={{80,6},{94,6},{94,22},{
                110,22}}, color={0,0,127}));
        connect(gASTMPC.TF2_out, TF2_out1) annotation (Line(points={{1,35},{16,35},
                {16,86},{110,86}}, color={0,0,127}));
        connect(sEXSMPC.EFd_input, Efd_ref) annotation (Line(points={{-17,-4},{-94,
                -4},{-94,-20},{-120,-20}}, color={0,0,127}));
        annotation (Icon(coordinateSystem(preserveAspectRatio=false, extent={{-100,-100},
                  {100,100}}), graphics={Ellipse(
                extent={{-100,100},{100,-100}},
                lineColor={0,0,0},
                fillColor={255,255,255},
                fillPattern=FillPattern.Solid),Line(
                points={{-48,2},{-20,56},{2,4},{24,-28},{48,22}},
                color={0,0,0},
                smooth=Smooth.Bezier),Text(
                extent={{-52,-18},{56,-66}},
                lineColor={0,0,0},
                fillColor={255,255,255},
                fillPattern=FillPattern.Solid,
                textString="%name")}),
          Documentation(info="<html>
<p>24kV/100MVA generation unit connected to bus BG1, and composed of the following component models:</p>
<ul>
<li><strong>Machine</strong>: GENSAL, a salient pole synchronous machine from PSSE.</li>
<li><strong>Exciter</strong>: SEXS, a simplified excitation system from PSSE.</li>
<li><strong>Turbine/Governor</strong>: IEESGO, a standard turbine/governor from PSSE.</li>
</ul>
<p>This generation unit is supposed to be disconnected in all experiments and, then, to be resynchronized to the whole system.</p>
</html>"));
      end G2_2INPUTS;

      model G2_3INPUTS "Generation unit connected to bus B5"
        outer OpenIPSL.Electrical.SystemBase SysData;
        extends OpenIPSL.Electrical.Essentials.pfComponent;

        OpenIPSL.Interfaces.PwPin conn annotation (Placement(transformation(extent={{
                  100,-10},{120,10}}), iconTransformation(extent={{100,-10},{120,10}})));
        Electrical.Machines.PSSE.GENSAL          gen(
          M_b=100000000,
          Tpd0=5,
          Tppd0=0.07,
          Tppq0=0.09,
          H=4.28,
          D=0.1,
          Xd=1.84,
          Xq=1.75,
          Xpd=0.41,
          Xppd=0.2,
          Xl=0.12,
          S10=0.11,
          S12=0.39,
          Xppq=0.2,
          R_a=0,
          V_b=V_b,
          v_0=v_0,
          angle_0=angle_0,
          P_0=P_0,
          Q_0=Q_0) annotation (Placement(transformation(extent={{38,-20},{78,20}})));
        SEXSMPC                                   sEXSMPC(
          T_AT_B=0.2,
          K=50,
          E_MIN=0,
          E_MAX=5,
          T_E=0.01,
          T_B=10) annotation (Placement(transformation(extent={{-16,-22},{4,-2}})));
        Modelica.Blocks.Sources.Constant non_active_limits(k=0)
          annotation (Placement(transformation(extent={{80,-60},{60,-40}})));
        Modelica.Blocks.Interfaces.RealInput P_ref1
          "Connector of Real input signal 2"
          annotation (Placement(transformation(extent={{-140,40},{-100,80}})));
        GASTMPC gASTMPC(T_3=0.01,
          V_MAX=1,                D_turb=0.1)
          annotation (Placement(transformation(extent={{-18,14},{2,34}})));
        Modelica.Blocks.Interfaces.RealInput Efd_ref
          "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-140,-80},{-100,-40}})));
      equation
        connect(gen.p, conn)
          annotation (Line(points={{78,0},{110,0}}, color={0,0,255}));
        connect(sEXSMPC.EFD, gen.EFD)
          annotation (Line(points={{5,-12},{34,-12}}, color={0,0,127}));
        connect(sEXSMPC.ECOMP, gen.ETERM) annotation (Line(points={{-17,-12},{-32,-12},
                {-32,-72},{92,-72},{92,-6},{80,-6}}, color={0,0,127}));
        connect(gen.EFD0, sEXSMPC.EFD0) annotation (Line(points={{80,-10},{88,-10},
                {88,-68},{-28,-68},{-28,-16},{-17,-16}}, color={0,0,127}));
        connect(non_active_limits.y, sEXSMPC.VOEL)
          annotation (Line(points={{59,-50},{-6,-50},{-6,-23}}, color={0,0,127}));
        connect(sEXSMPC.VUEL, sEXSMPC.VOEL) annotation (Line(points={{-10,-23},{-10,
                -32},{-6,-32},{-6,-23}}, color={0,0,127}));
        connect(gen.XADIFD, sEXSMPC.XADIFD) annotation (Line(points={{80,-18},{84,-18},
                {84,-34},{2,-34},{2,-23}}, color={0,0,127}));
        connect(sEXSMPC.VOTHSG, sEXSMPC.VOEL) annotation (Line(points={{-17,-8},{-22,
                -8},{-22,-32},{-6,-32},{-6,-23}}, color={0,0,127}));
        connect(gASTMPC.PMECH0, gen.PMECH0) annotation (Line(points={{-16,18},{-28,
                18},{-28,44},{92,44},{92,10},{80,10}}, color={0,0,127}));
        connect(gASTMPC.PMECH, gen.PMECH) annotation (Line(points={{3,24},{22,24},{
                22,12},{34,12}}, color={0,0,127}));
        connect(sEXSMPC.EFd_input, Efd_ref) annotation (Line(points={{-17,-4},{-94,
                -4},{-94,-60},{-120,-60}}, color={0,0,127}));
        connect(P_ref1, gASTMPC.PMECHControllable) annotation (Line(points={{-120,
                60},{-60,60},{-60,8},{-8,8},{-8,12}}, color={0,0,127}));
        connect(gen.SPEED, gASTMPC.SPEED) annotation (Line(points={{80,14},{84,14},
                {84,40},{-24,40},{-24,30},{-16,30}}, color={0,0,127}));
        annotation (Icon(coordinateSystem(preserveAspectRatio=false, extent={{-100,-100},
                  {100,100}}), graphics={Ellipse(
                extent={{-100,100},{100,-100}},
                lineColor={0,0,0},
                fillColor={255,255,255},
                fillPattern=FillPattern.Solid),Line(
                points={{-48,2},{-20,56},{2,4},{24,-28},{48,22}},
                color={0,0,0},
                smooth=Smooth.Bezier),Text(
                extent={{-52,-18},{56,-66}},
                lineColor={0,0,0},
                fillColor={255,255,255},
                fillPattern=FillPattern.Solid,
                textString="%name")}),
          Documentation(info="<html>
<p>24kV/100MVA generation unit connected to bus BG1, and composed of the following component models:</p>
<ul>
<li><strong>Machine</strong>: GENSAL, a salient pole synchronous machine from PSSE.</li>
<li><strong>Exciter</strong>: SEXS, a simplified excitation system from PSSE.</li>
<li><strong>Turbine/Governor</strong>: IEESGO, a standard turbine/governor from PSSE.</li>
</ul>
<p>This generation unit is supposed to be disconnected in all experiments and, then, to be resynchronized to the whole system.</p>
</html>"));
      end G2_3INPUTS;

      model G2_16MVA "Generation unit connected to bus B5"
        outer OpenIPSL.Electrical.SystemBase SysData;
        extends OpenIPSL.Electrical.Essentials.pfComponent;

        OpenIPSL.Interfaces.PwPin conn annotation (Placement(transformation(extent={{
                  100,-10},{120,10}}), iconTransformation(extent={{100,-10},{120,10}})));
        Electrical.Machines.PSSE.GENSAL          gen(
          M_b=16667000,
          Tpd0=4.822,
          Tppd0=0.023,
          Tppq0=0.065,
          H=8.75,
          D=2,
          Xd=1.897,
          Xq=1.78,
          Xpd=0.23,
          Xppd=0.156,
          Xl=0.123,
          S10=0.12,
          S12=0.4,
          Xppq=0.156,
          R_a=0,
          V_b=V_b,
          v_0=v_0,
          angle_0=angle_0,
          P_0=P_0,
          Q_0=Q_0) annotation (Placement(transformation(extent={{38,-20},{78,20}})));
        SEXSMPC                                   sEXSMPC(
          T_AT_B=0.2,
          K=50,
          E_MIN=0,
          E_MAX=5,
          T_E=0.01,
          T_B=10) annotation (Placement(transformation(extent={{-16,-22},{4,-2}})));
        Modelica.Blocks.Sources.Constant non_active_limits(k=0)
          annotation (Placement(transformation(extent={{80,-60},{60,-40}})));
        Modelica.Blocks.Interfaces.RealInput P_ref1
          "Connector of Real input signal 2"
          annotation (Placement(transformation(extent={{-140,40},{-100,80}})));
        GASTMPC gASTMPC(
          R=0.05,
          T_3=1,        V_MAX=1,
          D_turb=1)
          annotation (Placement(transformation(extent={{-18,14},{2,34}})));
        Modelica.Blocks.Interfaces.RealInput Efd_ref
          "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-140,-80},{-100,-40}})));
      equation
        connect(gen.p, conn)
          annotation (Line(points={{78,0},{110,0}}, color={0,0,255}));
        connect(sEXSMPC.EFD, gen.EFD)
          annotation (Line(points={{5,-12},{34,-12}}, color={0,0,127}));
        connect(sEXSMPC.ECOMP, gen.ETERM) annotation (Line(points={{-17,-12},{-32,-12},
                {-32,-72},{92,-72},{92,-6},{80,-6}}, color={0,0,127}));
        connect(gen.EFD0, sEXSMPC.EFD0) annotation (Line(points={{80,-10},{88,-10},
                {88,-68},{-28,-68},{-28,-16},{-17,-16}}, color={0,0,127}));
        connect(non_active_limits.y, sEXSMPC.VOEL)
          annotation (Line(points={{59,-50},{-6,-50},{-6,-23}}, color={0,0,127}));
        connect(sEXSMPC.VUEL, sEXSMPC.VOEL) annotation (Line(points={{-10,-23},{-10,
                -32},{-6,-32},{-6,-23}}, color={0,0,127}));
        connect(gen.XADIFD, sEXSMPC.XADIFD) annotation (Line(points={{80,-18},{84,-18},
                {84,-34},{2,-34},{2,-23}}, color={0,0,127}));
        connect(sEXSMPC.VOTHSG, sEXSMPC.VOEL) annotation (Line(points={{-17,-8},{-22,
                -8},{-22,-32},{-6,-32},{-6,-23}}, color={0,0,127}));
        connect(gASTMPC.PMECH0, gen.PMECH0) annotation (Line(points={{-16,18},{-28,
                18},{-28,44},{92,44},{92,10},{80,10}}, color={0,0,127}));
        connect(gASTMPC.PMECH, gen.PMECH) annotation (Line(points={{3,24},{22,24},{
                22,12},{34,12}}, color={0,0,127}));
        connect(sEXSMPC.EFd_input, Efd_ref) annotation (Line(points={{-17,-4},{-94,
                -4},{-94,-60},{-120,-60}}, color={0,0,127}));
        connect(P_ref1, gASTMPC.PMECHControllable) annotation (Line(points={{-120,
                60},{-60,60},{-60,8},{-8,8},{-8,12}}, color={0,0,127}));
        connect(gen.SPEED, gASTMPC.SPEED) annotation (Line(points={{80,14},{84,14},
                {84,40},{-24,40},{-24,30},{-16,30}}, color={0,0,127}));
        annotation (Icon(coordinateSystem(preserveAspectRatio=false, extent={{-100,-100},
                  {100,100}}), graphics={Ellipse(
                extent={{-100,100},{100,-100}},
                lineColor={0,0,0},
                fillColor={255,255,255},
                fillPattern=FillPattern.Solid),Line(
                points={{-48,2},{-20,56},{2,4},{24,-28},{48,22}},
                color={0,0,0},
                smooth=Smooth.Bezier),Text(
                extent={{-52,-18},{56,-66}},
                lineColor={0,0,0},
                fillColor={255,255,255},
                fillPattern=FillPattern.Solid,
                textString="%name")}),
          Documentation(info="<html>
<p>24kV/100MVA generation unit connected to bus BG1, and composed of the following component models:</p>
<ul>
<li><strong>Machine</strong>: GENSAL, a salient pole synchronous machine from PSSE.</li>
<li><strong>Exciter</strong>: SEXS, a simplified excitation system from PSSE.</li>
<li><strong>Turbine/Governor</strong>: IEESGO, a standard turbine/governor from PSSE.</li>
</ul>
<p>This generation unit is supposed to be disconnected in all experiments and, then, to be resynchronized to the whole system.</p>
</html>"));
      end G2_16MVA;

      model G2_GENROE "Generation unit connected to bus B5"
        outer OpenIPSL.Electrical.SystemBase SysData;
        extends OpenIPSL.Electrical.Essentials.pfComponent;

        OpenIPSL.Interfaces.PwPin conn annotation (Placement(transformation(extent={{
                  100,-10},{120,10}}), iconTransformation(extent={{100,-10},{120,10}})));
        Electrical.Machines.PSSE.GENROU          gen(
          M_b=16667000,
          Tpd0=4.822,
          Tppd0=0.023,
          Tppq0=0.065,
          H=8.75,
          D=2,
          Xd=1.897,
          Xq=1.78,
          Xpd=0.23,
          Xppd=0.156,
          Xl=0.123,
          S10=0.12,
          S12=0.4,
          Xppq=0.156,
          R_a=0,
          V_b=V_b,
          v_0=v_0,
          angle_0=angle_0,
          P_0=P_0,
          Q_0=Q_0,
          Xpq=0.23,
          Tpq0=4.822)
                   annotation (Placement(transformation(extent={{38,-20},{78,20}})));
        SEXSMPC                                   sEXSMPC(
          T_AT_B=0.2,
          K=50,
          E_MIN=0,
          E_MAX=5,
          T_E=0.01,
          T_B=10) annotation (Placement(transformation(extent={{-16,-22},{4,-2}})));
        Modelica.Blocks.Sources.Constant non_active_limits(k=0)
          annotation (Placement(transformation(extent={{80,-60},{60,-40}})));
        Modelica.Blocks.Interfaces.RealInput P_ref1
          "Connector of Real input signal 2"
          annotation (Placement(transformation(extent={{-140,40},{-100,80}})));
        GASTMPC gASTMPC(V_MAX=1,  D_turb=0.1)
          annotation (Placement(transformation(extent={{-18,14},{2,34}})));
        Modelica.Blocks.Interfaces.RealInput Efd_ref
          "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-140,-80},{-100,-40}})));
      equation
        connect(gen.p, conn)
          annotation (Line(points={{78,0},{110,0}}, color={0,0,255}));
        connect(sEXSMPC.EFD, gen.EFD)
          annotation (Line(points={{5,-12},{34,-12}}, color={0,0,127}));
        connect(sEXSMPC.ECOMP, gen.ETERM) annotation (Line(points={{-17,-12},{-32,-12},
                {-32,-72},{92,-72},{92,-6},{80,-6}}, color={0,0,127}));
        connect(gen.EFD0, sEXSMPC.EFD0) annotation (Line(points={{80,-10},{88,-10},
                {88,-68},{-28,-68},{-28,-16},{-17,-16}}, color={0,0,127}));
        connect(non_active_limits.y, sEXSMPC.VOEL)
          annotation (Line(points={{59,-50},{-6,-50},{-6,-23}}, color={0,0,127}));
        connect(sEXSMPC.VUEL, sEXSMPC.VOEL) annotation (Line(points={{-10,-23},{-10,
                -32},{-6,-32},{-6,-23}}, color={0,0,127}));
        connect(gen.XADIFD, sEXSMPC.XADIFD) annotation (Line(points={{80,-18},{84,-18},
                {84,-34},{2,-34},{2,-23}}, color={0,0,127}));
        connect(sEXSMPC.VOTHSG, sEXSMPC.VOEL) annotation (Line(points={{-17,-8},{-22,
                -8},{-22,-32},{-6,-32},{-6,-23}}, color={0,0,127}));
        connect(gASTMPC.PMECH0, gen.PMECH0) annotation (Line(points={{-16,18},{-28,
                18},{-28,44},{92,44},{92,10},{80,10}}, color={0,0,127}));
        connect(gASTMPC.PMECH, gen.PMECH) annotation (Line(points={{3,24},{22,24},{
                22,12},{34,12}}, color={0,0,127}));
        connect(sEXSMPC.EFd_input, Efd_ref) annotation (Line(points={{-17,-4},{-94,
                -4},{-94,-60},{-120,-60}}, color={0,0,127}));
        connect(P_ref1, gASTMPC.PMECHControllable) annotation (Line(points={{-120,
                60},{-60,60},{-60,8},{-8,8},{-8,12}}, color={0,0,127}));
        connect(gen.SPEED, gASTMPC.SPEED) annotation (Line(points={{80,14},{84,14},
                {84,40},{-24,40},{-24,30},{-16,30}}, color={0,0,127}));
        annotation (Icon(coordinateSystem(preserveAspectRatio=false, extent={{-100,-100},
                  {100,100}}), graphics={Ellipse(
                extent={{-100,100},{100,-100}},
                lineColor={0,0,0},
                fillColor={255,255,255},
                fillPattern=FillPattern.Solid),Line(
                points={{-48,2},{-20,56},{2,4},{24,-28},{48,22}},
                color={0,0,0},
                smooth=Smooth.Bezier),Text(
                extent={{-52,-18},{56,-66}},
                lineColor={0,0,0},
                fillColor={255,255,255},
                fillPattern=FillPattern.Solid,
                textString="%name")}),
          Documentation(info="<html>
<p>24kV/100MVA generation unit connected to bus BG1, and composed of the following component models:</p>
<ul>
<li><strong>Machine</strong>: GENSAL, a salient pole synchronous machine from PSSE.</li>
<li><strong>Exciter</strong>: SEXS, a simplified excitation system from PSSE.</li>
<li><strong>Turbine/Governor</strong>: IEESGO, a standard turbine/governor from PSSE.</li>
</ul>
<p>This generation unit is supposed to be disconnected in all experiments and, then, to be resynchronized to the whole system.</p>
</html>"));
      end G2_GENROE;

      model G2_16MVA_THERMAL "Generation unit connected to bus B5"
        outer OpenIPSL.Electrical.SystemBase SysData;
        extends OpenIPSL.Electrical.Essentials.pfComponent;

        OpenIPSL.Interfaces.PwPin conn annotation (Placement(transformation(extent={{
                  100,-10},{120,10}}), iconTransformation(extent={{100,-10},{120,10}})));
        Electrical.Machines.PSSE.GENSAL          gen(
          M_b=16667000,
          Tpd0=4.822,
          Tppd0=0.023,
          Tppq0=0.065,
          H=8.75,
          D=2,
          Xd=1.897,
          Xq=1.78,
          Xpd=0.23,
          Xppd=0.156,
          Xl=0.123,
          S10=0.12,
          S12=0.4,
          Xppq=0.156,
          R_a=0,
          V_b=V_b,
          v_0=v_0,
          angle_0=angle_0,
          P_0=P_0,
          Q_0=Q_0) annotation (Placement(transformation(extent={{38,-20},{78,20}})));
        SEXSMPC                                   sEXSMPC(
          T_AT_B=0.2,
          K=50,
          E_MIN=0,
          E_MAX=5,
          T_E=0.01,
          T_B=10) annotation (Placement(transformation(extent={{-16,-22},{4,-2}})));
        Modelica.Blocks.Sources.Constant non_active_limits(k=0)
          annotation (Placement(transformation(extent={{80,-60},{60,-40}})));
        Modelica.Blocks.Interfaces.RealInput P_ref1
          "Connector of Real input signal 2"
          annotation (Placement(transformation(extent={{-140,40},{-100,80}})));
        GASTMPC gASTMPC(V_MAX=1,  D_turb=0.1)
          annotation (Placement(transformation(extent={{-18,14},{2,34}})));
        Modelica.Blocks.Interfaces.RealInput Efd_ref
          "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-140,-80},{-100,-40}})));
      equation
        connect(gen.p, conn)
          annotation (Line(points={{78,0},{110,0}}, color={0,0,255}));
        connect(sEXSMPC.EFD, gen.EFD)
          annotation (Line(points={{5,-12},{34,-12}}, color={0,0,127}));
        connect(sEXSMPC.ECOMP, gen.ETERM) annotation (Line(points={{-17,-12},{-32,-12},
                {-32,-72},{92,-72},{92,-6},{80,-6}}, color={0,0,127}));
        connect(gen.EFD0, sEXSMPC.EFD0) annotation (Line(points={{80,-10},{88,-10},
                {88,-68},{-28,-68},{-28,-16},{-17,-16}}, color={0,0,127}));
        connect(non_active_limits.y, sEXSMPC.VOEL)
          annotation (Line(points={{59,-50},{-6,-50},{-6,-23}}, color={0,0,127}));
        connect(sEXSMPC.VUEL, sEXSMPC.VOEL) annotation (Line(points={{-10,-23},{-10,
                -32},{-6,-32},{-6,-23}}, color={0,0,127}));
        connect(gen.XADIFD, sEXSMPC.XADIFD) annotation (Line(points={{80,-18},{84,-18},
                {84,-34},{2,-34},{2,-23}}, color={0,0,127}));
        connect(sEXSMPC.VOTHSG, sEXSMPC.VOEL) annotation (Line(points={{-17,-8},{-22,
                -8},{-22,-32},{-6,-32},{-6,-23}}, color={0,0,127}));
        connect(gASTMPC.PMECH0, gen.PMECH0) annotation (Line(points={{-16,18},{-28,
                18},{-28,44},{92,44},{92,10},{80,10}}, color={0,0,127}));
        connect(gASTMPC.PMECH, gen.PMECH) annotation (Line(points={{3,24},{22,24},{
                22,12},{34,12}}, color={0,0,127}));
        connect(sEXSMPC.EFd_input, Efd_ref) annotation (Line(points={{-17,-4},{-94,
                -4},{-94,-60},{-120,-60}}, color={0,0,127}));
        connect(P_ref1, gASTMPC.PMECHControllable) annotation (Line(points={{-120,
                60},{-60,60},{-60,8},{-8,8},{-8,12}}, color={0,0,127}));
        connect(gen.SPEED, gASTMPC.SPEED) annotation (Line(points={{80,14},{84,14},
                {84,40},{-24,40},{-24,30},{-16,30}}, color={0,0,127}));
        annotation (Icon(coordinateSystem(preserveAspectRatio=false, extent={{-100,-100},
                  {100,100}}), graphics={Ellipse(
                extent={{-100,100},{100,-100}},
                lineColor={0,0,0},
                fillColor={255,255,255},
                fillPattern=FillPattern.Solid),Line(
                points={{-48,2},{-20,56},{2,4},{24,-28},{48,22}},
                color={0,0,0},
                smooth=Smooth.Bezier),Text(
                extent={{-52,-18},{56,-66}},
                lineColor={0,0,0},
                fillColor={255,255,255},
                fillPattern=FillPattern.Solid,
                textString="%name")}),
          Documentation(info="<html>
<p>24kV/100MVA generation unit connected to bus BG1, and composed of the following component models:</p>
<ul>
<li><strong>Machine</strong>: GENSAL, a salient pole synchronous machine from PSSE.</li>
<li><strong>Exciter</strong>: SEXS, a simplified excitation system from PSSE.</li>
<li><strong>Turbine/Governor</strong>: IEESGO, a standard turbine/governor from PSSE.</li>
</ul>
<p>This generation unit is supposed to be disconnected in all experiments and, then, to be resynchronized to the whole system.</p>
</html>"));
      end G2_16MVA_THERMAL;

      package Solar_Units
        model SolarMPCLocalVControl
          Interfaces.PwPin p1
            annotation (Placement(transformation(extent={{90,-10},{110,10}})));
          Electrical.Renewables.PSSE.InverterInterface.REGCA1 rEGCA1_1(V_b=V_base,
            P_0=P_0,
            Q_0=Q_0,
            v_0=v_0,
            angle_0=angle_0,
            Lvplsw=false)
            annotation (Placement(transformation(extent={{20,-10},{40,10}})));
          REECB1_Local_V_Control                                 rEECB1_Local_V_Control(
            pfflag=false,
            vflag=false,
            qflag=false,
            pqflag=false,
            Trv=0.02,
            Kqv=0.01,
            Tp=0.1,
            Vmax=1.05,
            Vmin=0.95,
            Kqp=1,
            Kvp=1,
            Kvi=1,
            dPmax=999,
            dPmin=-999,
            Pmin=0.000001,
            Imax=1.2)
                   annotation (Placement(transformation(extent={{-16,-10},{4,10}})));
          Modelica.Blocks.Interfaces.RealInput VINPUT "Reactive Power Reference"
            annotation (Placement(transformation(extent={{-140,-20},{-100,20}})));
          parameter Modelica.Units.SI.Voltage V_base = 480;
          extends OpenIPSL.Electrical.Essentials.pfComponent;
          Modelica.Blocks.Sources.Ramp ramp(
            height=-0.005,
            duration=10,
            startTime=15)
                         annotation (Placement(transformation(extent={{-80,-60},
                    {-60,-40}})));
          Modelica.Blocks.Math.Add PBUNDA annotation (Placement(transformation(
                  extent={{-50,-66},{-30,-46}})));
        equation
          connect(rEECB1_Local_V_Control.Iqcmd, rEGCA1_1.Iqcmd) annotation (Line(points={{4.33333,
                  5.66667},{11.4524,5.66667},{11.4524,5.71429},{18.5714,5.71429}},
                color={0,0,127}));
          connect(rEECB1_Local_V_Control.Ipcmd, rEGCA1_1.Ipcmd) annotation (Line(points={{4.33333,
                  -5.66667},{11.4524,-5.66667},{11.4524,-5.71429},{18.5714,
                  -5.71429}},
                color={0,0,127}));
          connect(rEECB1_Local_V_Control.iq0, rEGCA1_1.IQ0) annotation (Line(points={{2,
                  -10.6667},{2,-18},{22,-18},{22,-10},{21.4286,-10},{21.4286,
                  -10.7143}},
                color={0,0,127}));
          connect(rEECB1_Local_V_Control.ip0, rEGCA1_1.IP0) annotation (Line(points={{-2,
                  -10.6667},{-2,-20},{26,-20},{26,-10.7143},{25.7143,-10.7143}}, color={
                  0,0,127}));
          connect(rEECB1_Local_V_Control.v0, rEGCA1_1.V_0) annotation (Line(points={{-6,
                  -10.6667},{-6,-22},{30,-22},{30,-10.7143}}, color={0,0,127}));
          connect(rEECB1_Local_V_Control.q0, rEGCA1_1.q_0) annotation (Line(points={{-10,
                  -10.6667},{-10,-26},{34,-26},{34,-10.7143},{34.2857,-10.7143}}, color
                ={0,0,127}));
          connect(rEECB1_Local_V_Control.p0, rEGCA1_1.p_0) annotation (Line(points={{-14,
                  -10.6667},{-14,-24},{38,-24},{38,-10.7143},{38.5714,-10.7143}}, color
                ={0,0,127}));
          connect(rEGCA1_1.V_t, rEECB1_Local_V_Control.Vt) annotation (Line(points={{24.2857,
                  10.7143},{24.2857,16},{-28,16},{-28,5.33333},{-16.6667,
                  5.33333}},
                color={0,0,127}));
          connect(rEGCA1_1.Pgen, rEECB1_Local_V_Control.Pe) annotation (Line(points={{30,
                  10.7143},{30,20},{-22,20},{-22,2.66667},{-16.6667,2.66667}}, color={0,
                  0,127}));
          connect(rEGCA1_1.Qgen, rEECB1_Local_V_Control.Qgen) annotation (Line(points={{35.7143,
                  10.7143},{35.7143,24},{-20,24},{-20,0},{-16.6667,0}},         color={0,
                  0,127}));
          connect(rEGCA1_1.p, p1)
            annotation (Line(points={{40,0},{100,0}}, color={0,0,255}));
          connect(rEGCA1_1.q_0, rEECB1_Local_V_Control.Qext) annotation (Line(points={{34.2857,
                  -10.7143},{34.2857,-32},{-22,-32},{-22,-2.66667},{-16.6667,
                  -2.66667}},
                color={0,0,127}));
          connect(VINPUT, rEECB1_Local_V_Control.Vref_input) annotation (Line(points={{-120,0},
                  {-42,0},{-42,8.66667},{-16.6667,8.66667}},    color={0,0,127}));
          connect(ramp.y, PBUNDA.u1)
            annotation (Line(points={{-59,-50},{-52,-50}}, color={0,0,127}));
          connect(PBUNDA.u2, rEGCA1_1.p_0) annotation (Line(points={{-52,-62},{
                  -56,-62},{-56,-74},{38.5714,-74},{38.5714,-10.7143}}, color={
                  0,0,127}));
          connect(PBUNDA.y, rEECB1_Local_V_Control.Pref) annotation (Line(
                points={{-29,-56},{-20,-56},{-20,-5.33333},{-16.6667,-5.33333}},
                color={0,0,127}));
          annotation (Icon(coordinateSystem(preserveAspectRatio=false), graphics={
                                           Ellipse(
                  extent={{-100,100},{100,-100}},
                  lineColor={0,0,0},
                  fillColor={255,255,85},
                  fillPattern=FillPattern.Solid),Line(
                  points={{-48,2},{-20,56},{2,4},{24,-28},{48,22}},
                  color={0,0,0},
                  smooth=Smooth.Bezier),Text(
                  extent={{-52,-18},{56,-66}},
                  lineColor={0,0,0},
                  fillColor={255,255,255},
                  fillPattern=FillPattern.Solid,
                  textString="%name")}), Diagram(coordinateSystem(preserveAspectRatio=false)));
        end SolarMPCLocalVControl;

        model SolarMPCLocalQControl
          Interfaces.PwPin p1
            annotation (Placement(transformation(extent={{90,-10},{110,10}})));
          Electrical.Renewables.PSSE.InverterInterface.REGCA1 rEGCA1_1(V_b=V_base,
            P_0=P_0,
            Q_0=Q_0,
            v_0=v_0,
            angle_0=angle_0)
            annotation (Placement(transformation(extent={{20,-10},{40,10}})));
          REECB_Constant_Q_Control                               rEECB_Constant_Q_Control(
            pfflag=false,
            vflag=false,
            qflag=false,
            pqflag=true,
            Trv=0.02,
            Kqv=0.01,
            Tp=0.1,
            Kqp=1,
            Kvp=1,
            Pmin=0.01,
            Imax=1.2)
                   annotation (Placement(transformation(extent={{-16,-10},{4,10}})));
          Modelica.Blocks.Interfaces.RealInput QINPUT "Reactive Power Reference"
            annotation (Placement(transformation(extent={{-140,-20},{-100,20}})));
          parameter Modelica.Units.SI.Voltage V_base = 480;
          extends OpenIPSL.Electrical.Essentials.pfComponent;
          Modelica.Blocks.Math.Add add1
            annotation (Placement(transformation(extent={{-80,-16},{-60,4}})));
        equation
          connect(rEECB_Constant_Q_Control.Iqcmd, rEGCA1_1.Iqcmd) annotation (Line(
                points={{4.33333,5.66667},{11.4524,5.66667},{11.4524,5.71429},{
                  18.5714,5.71429}},
                color={0,0,127}));
          connect(rEECB_Constant_Q_Control.Ipcmd, rEGCA1_1.Ipcmd) annotation (Line(
                points={{4.33333,-5.66667},{11.4524,-5.66667},{11.4524,-5.71429},
                  {18.5714,-5.71429}},
                              color={0,0,127}));
          connect(rEECB_Constant_Q_Control.iq0, rEGCA1_1.IQ0) annotation (Line(points={{2,
                  -10.6667},{2,-18},{22,-18},{22,-10},{21.4286,-10},{21.4286,
                  -10.7143}},
                color={0,0,127}));
          connect(rEECB_Constant_Q_Control.ip0, rEGCA1_1.IP0) annotation (Line(points={{-2,
                  -10.6667},{-2,-20},{26,-20},{26,-10.7143},{25.7143,-10.7143}},
                color={0,0,127}));
          connect(rEECB_Constant_Q_Control.v0, rEGCA1_1.V_0) annotation (Line(points={{-6,
                  -10.6667},{-6,-22},{30,-22},{30,-10.7143}}, color={0,0,127}));
          connect(rEECB_Constant_Q_Control.q0, rEGCA1_1.q_0) annotation (Line(points={{-10,
                  -10.6667},{-10,-26},{34,-26},{34,-10.7143},{34.2857,-10.7143}}, color
                ={0,0,127}));
          connect(rEECB_Constant_Q_Control.p0, rEGCA1_1.p_0) annotation (Line(points={{-14,
                  -10.6667},{-14,-24},{38,-24},{38,-10.7143},{38.5714,-10.7143}}, color
                ={0,0,127}));
          connect(rEGCA1_1.V_t, rEECB_Constant_Q_Control.Vt) annotation (Line(points={{24.2857,
                  10.7143},{24.2857,16},{-28,16},{-28,5.33333},{-16.6667,
                  5.33333}},
                color={0,0,127}));
          connect(rEGCA1_1.Pgen, rEECB_Constant_Q_Control.Pe) annotation (Line(points={{30,
                  10.7143},{30,20},{-22,20},{-22,2.66667},{-16.6667,2.66667}},    color
                ={0,0,127}));
          connect(rEGCA1_1.Qgen, rEECB_Constant_Q_Control.Qgen) annotation (Line(points={{35.7143,
                  10.7143},{35.7143,24},{-20,24},{-20,0},{-16.6667,0}},          color={
                  0,0,127}));
          connect(rEGCA1_1.p, p1)
            annotation (Line(points={{40,0},{100,0}}, color={0,0,255}));
          connect(rEECB_Constant_Q_Control.Pref, rEGCA1_1.p_0) annotation (Line(points={{
                  -16.6667,-5.33333},{-20,-5.33333},{-20,-38},{38.5714,-38},{
                  38.5714,-10.7143}},
                color={0,0,127}));
          connect(QINPUT, add1.u1)
            annotation (Line(points={{-120,0},{-82,0}}, color={0,0,127}));
          connect(rEGCA1_1.q_0, add1.u2) annotation (Line(points={{34.2857,
                  -10.7143},{34.2857,-52},{-90,-52},{-90,-12},{-82,-12}},
                                                       color={0,0,127}));
          connect(add1.y, rEECB_Constant_Q_Control.Qext) annotation (Line(points={{-59,-6},
                  {-22,-6},{-22,-2.66667},{-16.6667,-2.66667}}, color={0,0,127}));
          annotation (Icon(coordinateSystem(preserveAspectRatio=false), graphics={
                                           Ellipse(
                  extent={{-100,100},{100,-100}},
                  lineColor={0,0,0},
                  fillColor={255,255,85},
                  fillPattern=FillPattern.Solid),Line(
                  points={{-48,2},{-20,56},{2,4},{24,-28},{48,22}},
                  color={0,0,0},
                  smooth=Smooth.Bezier),Text(
                  extent={{-52,-18},{56,-66}},
                  lineColor={0,0,0},
                  fillColor={255,255,255},
                  fillPattern=FillPattern.Solid,
                  textString="%name")}), Diagram(coordinateSystem(preserveAspectRatio=false)));
        end SolarMPCLocalQControl;

        model SolarMPCLocalVQControl
          Interfaces.PwPin p1
            annotation (Placement(transformation(extent={{90,-10},{110,10}})));
          Electrical.Renewables.PSSE.InverterInterface.REGCA1 rEGCA1_1(V_b=V_base,
            P_0=P_0,
            Q_0=Q_0,
            v_0=v_0,
            angle_0=angle_0)
            annotation (Placement(transformation(extent={{20,-10},{40,10}})));
          REECB1_Local_V_Q_Control_PI EC(
            pfflag=false,
            vflag=false,
            qflag=false,
            pqflag=true,
            Trv=0.02,
            Kqv=0.01,
            Tp=0.05,
            Kqp=1,
            Kqi=10,
            Kvp=1,
            Kvi=10,
            Kpp=1,
            Kpi=20,
            Pmin=0.001,
            Imax=1.3)
            annotation (Placement(transformation(extent={{-16,-10},{4,10}})));
          Modelica.Blocks.Interfaces.RealInput QINPUT
            "Reactive Power Reference"
            annotation (Placement(transformation(extent={{-140,-20},{-100,20}})));
          parameter Modelica.Units.SI.Voltage V_base = 480;
          extends OpenIPSL.Electrical.Essentials.pfComponent;
          Modelica.Blocks.Math.Add add1
            annotation (Placement(transformation(extent={{-54,-12},{-34,8}})));
        equation
          connect(EC.Iqcmd, rEGCA1_1.Iqcmd) annotation (Line(points={{4.33333,
                  5.66667},{11.4524,5.66667},{11.4524,5.71429},{18.5714,5.71429}},
                color={0,0,127}));
          connect(EC.Ipcmd, rEGCA1_1.Ipcmd) annotation (Line(points={{4.33333,
                  -5.66667},{11.4524,-5.66667},{11.4524,-5.71429},{18.5714,
                  -5.71429}}, color={0,0,127}));
          connect(EC.iq0, rEGCA1_1.IQ0) annotation (Line(points={{2,-10.6667},{
                  2,-18},{22,-18},{22,-10},{21.4286,-10},{21.4286,-10.7143}},
                color={0,0,127}));
          connect(EC.ip0, rEGCA1_1.IP0) annotation (Line(points={{-2,-10.6667},
                  {-2,-20},{26,-20},{26,-10.7143},{25.7143,-10.7143}}, color={0,
                  0,127}));
          connect(EC.v0, rEGCA1_1.V_0) annotation (Line(points={{-6,-10.6667},{
                  -6,-22},{30,-22},{30,-10.7143}}, color={0,0,127}));
          connect(EC.q0, rEGCA1_1.q_0) annotation (Line(points={{-10,-10.6667},
                  {-10,-26},{34,-26},{34,-10.7143},{34.2857,-10.7143}}, color={
                  0,0,127}));
          connect(EC.p0, rEGCA1_1.p_0) annotation (Line(points={{-14,-10.6667},
                  {-14,-24},{38,-24},{38,-10.7143},{38.5714,-10.7143}}, color={
                  0,0,127}));
          connect(rEGCA1_1.V_t, EC.Vt) annotation (Line(points={{24.2857,
                  10.7143},{24.2857,16},{-28,16},{-28,5.33333},{-16.6667,
                  5.33333}}, color={0,0,127}));
          connect(rEGCA1_1.Pgen, EC.Pe) annotation (Line(points={{30,10.7143},{
                  30,20},{-22,20},{-22,2.66667},{-16.6667,2.66667}}, color={0,0,
                  127}));
          connect(rEGCA1_1.Qgen, EC.Qgen) annotation (Line(points={{35.7143,
                  10.7143},{35.7143,24},{-20,24},{-20,0},{-16.6667,0}}, color={
                  0,0,127}));
          connect(rEGCA1_1.p, p1)
            annotation (Line(points={{40,0},{100,0}}, color={0,0,255}));
          connect(QINPUT, add1.u1)
            annotation (Line(points={{-120,0},{-66,0},{-66,4},{-56,4}},
                                                        color={0,0,127}));
          connect(rEGCA1_1.q_0, add1.u2) annotation (Line(points={{34.2857,
                  -10.7143},{34.2857,-46},{-56,-46},{-56,-8}},
                                                       color={0,0,127}));
          connect(add1.y, EC.Qext) annotation (Line(points={{-33,-2},{-24.8333,
                  -2},{-24.8333,-2.66667},{-16.6667,-2.66667}}, color={0,0,127}));
          connect(EC.Pref, rEGCA1_1.p_0) annotation (Line(points={{-16.6667,
                  -5.33333},{-22,-5.33333},{-22,-34},{38.5714,-34},{38.5714,
                  -10.7143}}, color={0,0,127}));
          annotation (Icon(coordinateSystem(preserveAspectRatio=false), graphics={
                                           Ellipse(
                  extent={{-100,100},{100,-100}},
                  lineColor={0,0,0},
                  fillColor={255,255,85},
                  fillPattern=FillPattern.Solid),Line(
                  points={{-48,2},{-20,56},{2,4},{24,-28},{48,22}},
                  color={0,0,0},
                  smooth=Smooth.Bezier),Text(
                  extent={{-52,-18},{56,-66}},
                  lineColor={0,0,0},
                  fillColor={255,255,255},
                  fillPattern=FillPattern.Solid,
                  textString="%name")}), Diagram(coordinateSystem(preserveAspectRatio=false)));
        end SolarMPCLocalVQControl;

        model SolarMPCLocalVQControl_NOCONTROL
          Interfaces.PwPin p1
            annotation (Placement(transformation(extent={{90,-10},{110,10}})));
          Electrical.Renewables.PSSE.InverterInterface.REGCA1 rEGCA1_1(V_b=V_base,
            P_0=P_0,
            Q_0=Q_0,
            v_0=v_0,
            angle_0=angle_0)
            annotation (Placement(transformation(extent={{20,-10},{40,10}})));
          REECB1_Local_V_Q_Control                               rEECB1_Local_V_Q_Control(
            pfflag=false,
            vflag=false,
            qflag=false,
            pqflag=true,
            Trv=0.02,
            Kqv=0.01,
            Tp=0.1,
            Kqp=1,
            Kqi=1,
            Kvp=1,
            Kvi=1,
            Pmin=0.001,
            Imax=1.2)
                   annotation (Placement(transformation(extent={{-16,-10},{4,10}})));
          parameter Modelica.Units.SI.Voltage V_base = 480;
          extends OpenIPSL.Electrical.Essentials.pfComponent;
          Modelica.Blocks.Math.Add add1
            annotation (Placement(transformation(extent={{-64,-14},{-44,6}})));
          Modelica.Blocks.Interfaces.RealInput u1
            "Connector of Real input signal 1" annotation (Placement(
                transformation(extent={{-140,-20},{-100,20}})));
        equation
          connect(rEECB1_Local_V_Q_Control.Iqcmd, rEGCA1_1.Iqcmd) annotation (Line(
                points={{4.33333,5.66667},{11.4524,5.66667},{11.4524,5.71429},{
                  18.5714,5.71429}},
                color={0,0,127}));
          connect(rEECB1_Local_V_Q_Control.Ipcmd, rEGCA1_1.Ipcmd) annotation (Line(
                points={{4.33333,-5.66667},{11.4524,-5.66667},{11.4524,-5.71429},
                  {18.5714,-5.71429}},
                              color={0,0,127}));
          connect(rEECB1_Local_V_Q_Control.iq0, rEGCA1_1.IQ0) annotation (Line(points={{2,
                  -10.6667},{2,-18},{22,-18},{22,-10},{21.4286,-10},{21.4286,
                  -10.7143}},
                color={0,0,127}));
          connect(rEECB1_Local_V_Q_Control.ip0, rEGCA1_1.IP0) annotation (Line(points={{-2,
                  -10.6667},{-2,-20},{26,-20},{26,-10.7143},{25.7143,-10.7143}},
                color={0,0,127}));
          connect(rEECB1_Local_V_Q_Control.v0, rEGCA1_1.V_0) annotation (Line(points={{-6,
                  -10.6667},{-6,-22},{30,-22},{30,-10.7143}}, color={0,0,127}));
          connect(rEECB1_Local_V_Q_Control.q0, rEGCA1_1.q_0) annotation (Line(points={{-10,
                  -10.6667},{-10,-26},{34,-26},{34,-10.7143},{34.2857,-10.7143}}, color
                ={0,0,127}));
          connect(rEECB1_Local_V_Q_Control.p0, rEGCA1_1.p_0) annotation (Line(points={{-14,
                  -10.6667},{-14,-24},{38,-24},{38,-10.7143},{38.5714,-10.7143}}, color
                ={0,0,127}));
          connect(rEGCA1_1.V_t,rEECB1_Local_V_Q_Control. Vt) annotation (Line(points={{24.2857,
                  10.7143},{24.2857,16},{-28,16},{-28,5.33333},{-16.6667,
                  5.33333}},
                color={0,0,127}));
          connect(rEGCA1_1.Pgen,rEECB1_Local_V_Q_Control. Pe) annotation (Line(points={{30,
                  10.7143},{30,20},{-22,20},{-22,2.66667},{-16.6667,2.66667}},    color
                ={0,0,127}));
          connect(rEGCA1_1.Qgen,rEECB1_Local_V_Q_Control. Qgen) annotation (Line(points={{35.7143,
                  10.7143},{35.7143,24},{-20,24},{-20,0},{-16.6667,0}},          color={
                  0,0,127}));
          connect(rEGCA1_1.p, p1)
            annotation (Line(points={{40,0},{100,0}}, color={0,0,255}));
          connect(rEGCA1_1.q_0, add1.u2) annotation (Line(points={{34.2857,
                  -10.7143},{34.2857,-32},{-78,-32},{-78,-10},{-66,-10}}, color
                ={0,0,127}));
          connect(add1.y, rEECB1_Local_V_Q_Control.Qext) annotation (Line(
                points={{-43,-4},{-43,-2.66667},{-16.6667,-2.66667}}, color={0,
                  0,127}));
          connect(add1.u1, u1) annotation (Line(points={{-66,2},{-96,2},{-96,0},
                  {-120,0}}, color={0,0,127}));
          connect(rEGCA1_1.p_0, rEECB1_Local_V_Q_Control.Pref) annotation (Line(
                points={{38.5714,-10.7143},{38.5714,-42},{-24,-42},{-24,
                  -5.33333},{-16.6667,-5.33333}}, color={0,0,127}));
          annotation (Icon(coordinateSystem(preserveAspectRatio=false), graphics={
                                           Ellipse(
                  extent={{-100,100},{100,-100}},
                  lineColor={0,0,0},
                  fillColor={255,255,85},
                  fillPattern=FillPattern.Solid),Line(
                  points={{-48,2},{-20,56},{2,4},{24,-28},{48,22}},
                  color={0,0,0},
                  smooth=Smooth.Bezier),Text(
                  extent={{-52,-18},{56,-66}},
                  lineColor={0,0,0},
                  fillColor={255,255,255},
                  fillPattern=FillPattern.Solid,
                  textString="%name")}), Diagram(coordinateSystem(preserveAspectRatio=false)));
        end SolarMPCLocalVQControl_NOCONTROL;

        model SolarMPCLocalVQControl_PYTHON
          Interfaces.PwPin p1
            annotation (Placement(transformation(extent={{90,-10},{110,10}})));
          Electrical.Renewables.PSSE.InverterInterface.REGCA1 rEGCA1_1(V_b=V_base,
            P_0=P_0,
            Q_0=Q_0,
            v_0=v_0,
            angle_0=angle_0)
            annotation (Placement(transformation(extent={{20,-10},{40,10}})));
          REECB1_Local_V_Q_Control_PI rEECB1_Local_V_Q_Control_PI_PYTHON(
            pfflag=false,
            vflag=false,
            qflag=false,
            pqflag=true,
            Trv=0.02,
            Kqv=0.01,
            Tp=0.05,
            Kqp=1,
            Kqi=1,
            Kvp=1,
            Kvi=1,
            Kpp=1,
            Kpi=1,
            Pmin=0.001,
            Imax=1.3)
            annotation (Placement(transformation(extent={{-16,-10},{4,10}})));
          Modelica.Blocks.Interfaces.RealInput QINPUT "Reactive Power Reference"
            annotation (Placement(transformation(extent={{-140,-20},{-100,20}})));
          parameter Modelica.Units.SI.Voltage V_base = 480;
          extends OpenIPSL.Electrical.Essentials.pfComponent;
          Modelica.Blocks.Math.Add add1
            annotation (Placement(transformation(extent={{-54,-12},{-34,8}})));
        equation
          connect(rEECB1_Local_V_Q_Control_PI_PYTHON.Iqcmd, rEGCA1_1.Iqcmd)
            annotation (Line(points={{4.33333,5.66667},{11.4524,5.66667},{
                  11.4524,5.71429},{18.5714,5.71429}}, color={0,0,127}));
          connect(rEECB1_Local_V_Q_Control_PI_PYTHON.Ipcmd, rEGCA1_1.Ipcmd)
            annotation (Line(points={{4.33333,-5.66667},{11.4524,-5.66667},{
                  11.4524,-5.71429},{18.5714,-5.71429}}, color={0,0,127}));
          connect(rEECB1_Local_V_Q_Control_PI_PYTHON.iq0, rEGCA1_1.IQ0)
            annotation (Line(points={{2,-10.6667},{2,-18},{22,-18},{22,-10},{
                  21.4286,-10},{21.4286,-10.7143}}, color={0,0,127}));
          connect(rEECB1_Local_V_Q_Control_PI_PYTHON.ip0, rEGCA1_1.IP0)
            annotation (Line(points={{-2,-10.6667},{-2,-20},{26,-20},{26,
                  -10.7143},{25.7143,-10.7143}}, color={0,0,127}));
          connect(rEECB1_Local_V_Q_Control_PI_PYTHON.v0, rEGCA1_1.V_0)
            annotation (Line(points={{-6,-10.6667},{-6,-22},{30,-22},{30,
                  -10.7143}}, color={0,0,127}));
          connect(rEECB1_Local_V_Q_Control_PI_PYTHON.q0, rEGCA1_1.q_0)
            annotation (Line(points={{-10,-10.6667},{-10,-26},{34,-26},{34,
                  -10.7143},{34.2857,-10.7143}}, color={0,0,127}));
          connect(rEECB1_Local_V_Q_Control_PI_PYTHON.p0, rEGCA1_1.p_0)
            annotation (Line(points={{-14,-10.6667},{-14,-24},{38,-24},{38,
                  -10.7143},{38.5714,-10.7143}}, color={0,0,127}));
          connect(rEGCA1_1.V_t, rEECB1_Local_V_Q_Control_PI_PYTHON.Vt)
            annotation (Line(points={{24.2857,10.7143},{24.2857,16},{-28,16},{
                  -28,5.33333},{-16.6667,5.33333}}, color={0,0,127}));
          connect(rEGCA1_1.Pgen, rEECB1_Local_V_Q_Control_PI_PYTHON.Pe)
            annotation (Line(points={{30,10.7143},{30,20},{-22,20},{-22,2.66667},
                  {-16.6667,2.66667}}, color={0,0,127}));
          connect(rEGCA1_1.Qgen, rEECB1_Local_V_Q_Control_PI_PYTHON.Qgen)
            annotation (Line(points={{35.7143,10.7143},{35.7143,24},{-20,24},{
                  -20,0},{-16.6667,0}}, color={0,0,127}));
          connect(rEGCA1_1.p, p1)
            annotation (Line(points={{40,0},{100,0}}, color={0,0,255}));
          connect(QINPUT, add1.u1)
            annotation (Line(points={{-120,0},{-66,0},{-66,4},{-56,4}},
                                                        color={0,0,127}));
          connect(rEGCA1_1.q_0, add1.u2) annotation (Line(points={{34.2857,
                  -10.7143},{34.2857,-46},{-56,-46},{-56,-8}},
                                                       color={0,0,127}));
          connect(add1.y, rEECB1_Local_V_Q_Control_PI_PYTHON.Qext) annotation (
              Line(points={{-33,-2},{-24.8333,-2},{-24.8333,-2.66667},{-16.6667,
                  -2.66667}}, color={0,0,127}));
          connect(rEECB1_Local_V_Q_Control_PI_PYTHON.Pref, rEGCA1_1.p_0)
            annotation (Line(points={{-16.6667,-5.33333},{-22,-5.33333},{-22,
                  -34},{38.5714,-34},{38.5714,-10.7143}}, color={0,0,127}));
          annotation (Icon(coordinateSystem(preserveAspectRatio=false), graphics={
                                           Ellipse(
                  extent={{-100,100},{100,-100}},
                  lineColor={0,0,0},
                  fillColor={255,255,85},
                  fillPattern=FillPattern.Solid),Line(
                  points={{-48,2},{-20,56},{2,4},{24,-28},{48,22}},
                  color={0,0,0},
                  smooth=Smooth.Bezier),Text(
                  extent={{-52,-18},{56,-66}},
                  lineColor={0,0,0},
                  fillColor={255,255,255},
                  fillPattern=FillPattern.Solid,
                  textString="%name")}), Diagram(coordinateSystem(preserveAspectRatio=false)));
        end SolarMPCLocalVQControl_PYTHON;

        model SolarMPCLocalVQControl_OBSERVABILITY
          Interfaces.PwPin p1
            annotation (Placement(transformation(extent={{90,-10},{110,10}})));
          REGCA1_OBSERVABILITY                                rEGCA1_OBSERVABILITY(
                                                                       V_b=V_base,
            P_0=P_0,
            Q_0=Q_0,
            v_0=v_0,
            angle_0=angle_0)
            annotation (Placement(transformation(extent={{20,-10},{40,10}})));
          REECB1_Local_V_Q_Control_PI_OBSERVABILITY EC(
            pfflag=false,
            vflag=false,
            qflag=false,
            pqflag=true,
            Trv=0.02,
            Kqv=0.01,
            Tp=0.05,
            Kqp=1,
            Kqi=10,
            Kvp=1,
            Kvi=10,
            Kpp=1,
            Kpi=20,
            Pmin=0.001,
            Imax=1.3) annotation (Placement(transformation(extent={{-16,-10},{4,10}})));
          Modelica.Blocks.Interfaces.RealInput QINPUT "Reactive Power Reference"
            annotation (Placement(transformation(extent={{-140,-20},{-100,20}})));
          parameter Modelica.Units.SI.Voltage V_base = 480;
          extends OpenIPSL.Electrical.Essentials.pfComponent;
          Modelica.Blocks.Math.Add add1
            annotation (Placement(transformation(extent={{-54,-12},{-34,8}})));
        equation
          connect(EC.Iqcmd, rEGCA1_OBSERVABILITY.Iqcmd) annotation (Line(points={{4.33333,
                  5.66667},{11.4524,5.66667},{11.4524,5.71429},{18.5714,5.71429}},
                color={0,0,127}));
          connect(EC.Ipcmd, rEGCA1_OBSERVABILITY.Ipcmd) annotation (Line(points={{4.33333,
                  -5.66667},{11.4524,-5.66667},{11.4524,-5.71429},{18.5714,
                  -5.71429}},
                color={0,0,127}));
          connect(EC.iq0, rEGCA1_OBSERVABILITY.IQ0) annotation (Line(points={{2,
                  -10.6667},{2,-18},{22,-18},{22,-10},{21.4286,-10},{21.4286,
                  -10.7143}},                                                  color={0,
                  0,127}));
          connect(EC.ip0, rEGCA1_OBSERVABILITY.IP0) annotation (Line(points={{-2,
                  -10.6667},{-2,-20},{26,-20},{26,-10.7143},{25.7143,-10.7143}},
                                                                       color={0,0,127}));
          connect(EC.v0, rEGCA1_OBSERVABILITY.V_0) annotation (Line(points={{-6,
                  -10.6667},{-6,-22},{30,-22},{30,-10.7143}},
                                                    color={0,0,127}));
          connect(EC.q0, rEGCA1_OBSERVABILITY.q_0) annotation (Line(points={{-10,
                  -10.6667},{-10,-26},{34,-26},{34,-10.7143},{34.2857,-10.7143}},
                                                                        color={0,0,127}));
          connect(EC.p0, rEGCA1_OBSERVABILITY.p_0) annotation (Line(points={{-14,
                  -10.6667},{-14,-24},{38,-24},{38,-10.7143},{38.5714,-10.7143}},
                                                                        color={0,0,127}));
          connect(rEGCA1_OBSERVABILITY.V_t, EC.Vt) annotation (Line(points={{24.2857,
                  10.7143},{24.2857,16},{-28,16},{-28,5.33333},{-16.6667,
                  5.33333}},                                               color={0,0,127}));
          connect(rEGCA1_OBSERVABILITY.Pgen, EC.Pe) annotation (Line(points={{30,
                  10.7143},{30,20},{-22,20},{-22,2.66667},{-16.6667,2.66667}},
                                                                      color={0,0,127}));
          connect(rEGCA1_OBSERVABILITY.Qgen, EC.Qgen) annotation (Line(points={{35.7143,
                  10.7143},{35.7143,24},{-20,24},{-20,0},{-16.6667,0}}, color={0,0,127}));
          connect(rEGCA1_OBSERVABILITY.p, p1)
            annotation (Line(points={{40,0},{100,0}}, color={0,0,255}));
          connect(QINPUT, add1.u1)
            annotation (Line(points={{-120,0},{-66,0},{-66,4},{-56,4}},
                                                        color={0,0,127}));
          connect(rEGCA1_OBSERVABILITY.q_0, add1.u2) annotation (Line(points={{34.2857,
                  -10.7143},{34.2857,-46},{-56,-46},{-56,-8}},
                                                     color={0,0,127}));
          connect(add1.y, EC.Qext) annotation (Line(points={{-33,-2},{-24.8333,
                  -2},{-24.8333,-2.66667},{-16.6667,-2.66667}}, color={0,0,127}));
          connect(EC.Pref, rEGCA1_OBSERVABILITY.p_0) annotation (Line(points={{
                  -16.6667,-5.33333},{-22,-5.33333},{-22,-34},{38.5714,-34},{
                  38.5714,-10.7143}},
                color={0,0,127}));
          annotation (Icon(coordinateSystem(preserveAspectRatio=false), graphics={
                                           Ellipse(
                  extent={{-100,100},{100,-100}},
                  lineColor={0,0,0},
                  fillColor={255,255,85},
                  fillPattern=FillPattern.Solid),Line(
                  points={{-48,2},{-20,56},{2,4},{24,-28},{48,22}},
                  color={0,0,0},
                  smooth=Smooth.Bezier),Text(
                  extent={{-52,-18},{56,-66}},
                  lineColor={0,0,0},
                  fillColor={255,255,255},
                  fillPattern=FillPattern.Solid,
                  textString="%name")}), Diagram(coordinateSystem(preserveAspectRatio=false)));
        end SolarMPCLocalVQControl_OBSERVABILITY;

        model SolarMPCSysIdentification
          Interfaces.PwPin p1
            annotation (Placement(transformation(extent={{90,-10},{110,10}})));
          parameter Modelica.Units.SI.Voltage V_base = 480;
          extends OpenIPSL.Electrical.Essentials.pfComponent;
          PV_SYS_ID rEGCA1_1(
            V_b=V_base,
            P_0=P_0,
            Q_0=Q_0,
            v_0=v_0,
            angle_0=angle_0)
            annotation (Placement(transformation(extent={{-14,-14},{14,14}})));
          Modelica.Blocks.Interfaces.RealInput Qref "Reactive Power Reference"
            annotation (Placement(transformation(extent={{-140,-80},{-100,-40}})));
        equation
          connect(Qref, rEGCA1_1.Iqcmd) annotation (Line(points={{-120,-60},{-48,
                  -60},{-48,8},{-16,8}}, color={0,0,127}));
          connect(rEGCA1_1.p, p1)
            annotation (Line(points={{14,0},{100,0}}, color={0,0,255}));
          connect(rEGCA1_1.p_0, rEGCA1_1.Ipcmd) annotation (Line(points={{12,-15},
                  {12,-26},{-24,-26},{-24,-8},{-16,-8}}, color={0,0,127}));
          annotation (Icon(coordinateSystem(preserveAspectRatio=false), graphics={
                                           Ellipse(
                  extent={{-100,100},{100,-100}},
                  lineColor={0,0,0},
                  fillColor={255,255,85},
                  fillPattern=FillPattern.Solid),Line(
                  points={{-48,2},{-20,56},{2,4},{24,-28},{48,22}},
                  color={0,0,0},
                  smooth=Smooth.Bezier),Text(
                  extent={{-52,-18},{56,-66}},
                  lineColor={0,0,0},
                  fillColor={255,255,255},
                  fillPattern=FillPattern.Solid,
                  textString="%name")}), Diagram(coordinateSystem(preserveAspectRatio=false)));
        end SolarMPCSysIdentification;
      end Solar_Units;

      package Battery_Units

        model BESSMPCLocalVControl
          Interfaces.PwPin p1
            annotation (Placement(transformation(extent={{90,-10},{110,10}})));
          Electrical.Renewables.PSSE.InverterInterface.REGCA1 rEGCA1_1(V_b=V_base,
            P_0=P_0,
            Q_0=Q_0,
            v_0=v_0,
            angle_0=angle_0)
            annotation (Placement(transformation(extent={{20,-10},{40,10}})));
          REECCU1_Local_V_Control                                 rEECCU1_Local_V_Control(
            pfflag=false,
            vflag=false,
            qflag=false,
            pqflag=false,
            Trv=0.02,
            dbd1=0,
            dbd2=0,
            Kqv=0.01,
            Kqp=1,
            Kvp=1,
            Kvi=1,
            Pmin=-1)
                   annotation (Placement(transformation(extent={{-16,-10},{4,10}})));
          Modelica.Blocks.Interfaces.RealInput Vinput
            "Reactive Power Reference" annotation (Placement(transformation(
                  extent={{-140,-80},{-100,-40}})));
          parameter Modelica.Units.SI.Voltage V_base;
          extends OpenIPSL.Electrical.Essentials.pfComponent;
          Modelica.Blocks.Interfaces.RealInput Pinput
            "Auxiliary Signal for Active Power" annotation (Placement(
                transformation(extent={{-140,40},{-100,80}})));
          Modelica.Blocks.Math.Add add1(k1=+1)
            annotation (Placement(transformation(extent={{-60,64},{-40,44}})));
          Modelica.Blocks.Sources.Constant Paux(k=0)
            annotation (Placement(transformation(extent={{-80,-14},{-60,6}})));
        equation
          connect(rEGCA1_1.p, p1)
            annotation (Line(points={{40,0},{100,0}}, color={0,0,255}));
          connect(add1.u2, Pinput)
            annotation (Line(points={{-62,60},{-120,60}}, color={0,0,127}));
          connect(rEGCA1_1.V_t, rEECCU1_Local_V_Control.Vt) annotation (Line(
                points={{24.2857,10.7143},{24.2857,16},{-20,16},{-20,8},{
                  -16.6667,8}}, color={0,0,127}));
          connect(rEGCA1_1.Pgen, rEECCU1_Local_V_Control.Pe) annotation (Line(
                points={{30,10.7143},{30,18},{-22,18},{-22,5.33333},{-16.6667,
                  5.33333}}, color={0,0,127}));
          connect(rEGCA1_1.Qgen, rEECCU1_Local_V_Control.Qgen) annotation (Line(
                points={{35.7143,10.7143},{35.7143,20},{-24,20},{-24,2.66667},{
                  -16.6667,2.66667}}, color={0,0,127}));
          connect(rEGCA1_1.p_0, add1.u1) annotation (Line(points={{38.5714,
                  -10.7143},{38.5714,-20},{56,-20},{56,28},{-72,28},{-72,48},{
                  -62,48}}, color={0,0,127}));
          connect(add1.y, rEECCU1_Local_V_Control.Pref) annotation (Line(points={{-39,54},
                  {-28,54},{-28,-2.66667},{-16.6667,-2.66667}},          color=
                  {0,0,127}));
          connect(rEECCU1_Local_V_Control.Qext, rEGCA1_1.q_0) annotation (Line(
                points={{-16.6667,0},{-20,0},{-20,-20},{34.2857,-20},{34.2857,
                  -10.7143}}, color={0,0,127}));
          connect(rEECCU1_Local_V_Control.iq0, rEGCA1_1.IQ0) annotation (Line(
                points={{2,-10.6667},{2,-12},{21.4286,-12},{21.4286,-10.7143}},
                color={0,0,127}));
          connect(rEECCU1_Local_V_Control.ip0, rEGCA1_1.IP0) annotation (Line(
                points={{-2,-10.6667},{-2,-14},{25.7143,-14},{25.7143,-10.7143}},
                color={0,0,127}));
          connect(rEECCU1_Local_V_Control.v0, rEGCA1_1.V_0) annotation (Line(
                points={{-6,-10.6667},{-6,-16},{30,-16},{30,-10.7143}}, color={
                  0,0,127}));
          connect(rEECCU1_Local_V_Control.q0, rEGCA1_1.q_0) annotation (Line(
                points={{-10,-10.6667},{-10,-18},{34.2857,-18},{34.2857,
                  -10.7143}}, color={0,0,127}));
          connect(rEECCU1_Local_V_Control.p0, rEGCA1_1.p_0) annotation (Line(
                points={{-14,-10.6667},{-14,-22},{38.5714,-22},{38.5714,
                  -10.7143}}, color={0,0,127}));
          connect(Paux.y, rEECCU1_Local_V_Control.Paux) annotation (Line(points={{-59,-4},
                  {-37.8333,-4},{-37.8333,-5.33333},{-16.6667,-5.33333}},
                color={0,0,127}));
          connect(Vinput, rEECCU1_Local_V_Control.Vref_input) annotation (Line(
                points={{-120,-60},{72,-60},{72,48},{-6,48},{-6,10.6667}},
                color={0,0,127}));
          connect(rEECCU1_Local_V_Control.Iqcmd, rEGCA1_1.Iqcmd) annotation (
              Line(points={{4.33333,5.66667},{11.4524,5.66667},{11.4524,5.71429},
                  {18.5714,5.71429}}, color={0,0,127}));
          connect(rEECCU1_Local_V_Control.Ipcmd, rEGCA1_1.Ipcmd) annotation (
              Line(points={{4.33333,-5.66667},{11.4524,-5.66667},{11.4524,
                  -5.71429},{18.5714,-5.71429}}, color={0,0,127}));
          annotation (Icon(coordinateSystem(preserveAspectRatio=false), graphics={
                                           Ellipse(
                  extent={{-100,100},{100,-100}},
                  lineColor={0,0,0},
                  fillColor={170,255,85},
                  fillPattern=FillPattern.Solid),Line(
                  points={{-48,2},{-20,56},{2,4},{24,-28},{48,22}},
                  color={0,0,0},
                  smooth=Smooth.Bezier),Text(
                  extent={{-52,-18},{56,-66}},
                  lineColor={0,0,0},
                  fillColor={255,255,255},
                  fillPattern=FillPattern.Solid,
                  textString="%name")}), Diagram(coordinateSystem(preserveAspectRatio=false)));
        end BESSMPCLocalVControl;

        model BESSMPCLocalQControl
          Interfaces.PwPin p1
            annotation (Placement(transformation(extent={{90,-10},{110,10}})));
          Electrical.Renewables.PSSE.InverterInterface.REGCA1 rEGCA1_1(V_b=V_base,
            P_0=P_0,
            Q_0=Q_0,
            v_0=v_0,
            angle_0=angle_0)
            annotation (Placement(transformation(extent={{20,-10},{40,10}})));
          REECCU1_Constant_Q_Control                              rEECCU1_Constant_Q_Control(
            pfflag=false,
            vflag=false,
            qflag=false,
            pqflag=true,
            dbd1=0,
            dbd2=0,
            Kqv=0.01,
            Kqp=1,
            Kvp=1,
            Pmin=-1,
            T=50)  annotation (Placement(transformation(extent={{-16,-10},{4,10}})));
          Modelica.Blocks.Interfaces.RealInput Qext1 "Reactive Power Reference"
            annotation (Placement(transformation(extent={{-140,-80},{-100,-40}})));
          parameter Modelica.Units.SI.Voltage V_base;
          extends OpenIPSL.Electrical.Essentials.pfComponent;
          Modelica.Blocks.Interfaces.RealInput Paux1
            "Auxiliary Signal for Active Power"
            annotation (Placement(transformation(extent={{-140,40},{-100,80}})));
          Modelica.Blocks.Math.Add add1(k1=+1)
            annotation (Placement(transformation(extent={{-60,64},{-40,44}})));
          Modelica.Blocks.Sources.Constant Paux(k=0)
            annotation (Placement(transformation(extent={{-80,-20},{-60,0}})));
          Modelica.Blocks.Math.Add add2(k1=+1)
            annotation (Placement(transformation(extent={{-60,-50},{-40,-70}})));
        equation
          connect(rEECCU1_Constant_Q_Control.Iqcmd, rEGCA1_1.Iqcmd) annotation (
             Line(points={{4.33333,5.66667},{11.4524,5.66667},{11.4524,5.71429},
                  {18.5714,5.71429}}, color={0,0,127}));
          connect(rEECCU1_Constant_Q_Control.Ipcmd, rEGCA1_1.Ipcmd) annotation (
             Line(points={{4.33333,-5.66667},{11.4524,-5.66667},{11.4524,
                  -5.71429},{18.5714,-5.71429}}, color={0,0,127}));
          connect(rEGCA1_1.V_t, rEECCU1_Constant_Q_Control.Vt) annotation (Line(
                points={{24.2857,10.7143},{24.2857,12},{-20,12},{-20,8},{
                  -16.6667,8}}, color={0,0,127}));
          connect(rEGCA1_1.Pgen, rEECCU1_Constant_Q_Control.Pe) annotation (
              Line(points={{30,10.7143},{30,18},{-22,18},{-22,5.33333},{
                  -16.6667,5.33333}}, color={0,0,127}));
          connect(rEGCA1_1.Qgen, rEECCU1_Constant_Q_Control.Qgen) annotation (
              Line(points={{35.7143,10.7143},{35.7143,20},{-24,20},{-24,2.66667},
                  {-16.6667,2.66667}}, color={0,0,127}));
          connect(rEGCA1_1.p, p1)
            annotation (Line(points={{40,0},{100,0}}, color={0,0,255}));
          connect(add1.u2, Paux1)
            annotation (Line(points={{-62,60},{-120,60}}, color={0,0,127}));
          connect(rEGCA1_1.p_0, add1.u1) annotation (Line(points={{38.5714,
                  -10.7143},{38.5714,-28},{60,-28},{60,26},{-78,26},{-78,48},{
                  -62,48}},
                        color={0,0,127}));
          connect(Paux.y, rEECCU1_Constant_Q_Control.Paux) annotation (Line(
                points={{-59,-10},{-59,-5.33333},{-16.6667,-5.33333}}, color={0,
                  0,127}));
          connect(rEGCA1_1.IQ0, rEECCU1_Constant_Q_Control.iq0) annotation (
              Line(points={{21.4286,-10.7143},{21.4286,-14},{2,-14},{2,-10.6667}},
                color={0,0,127}));
          connect(rEECCU1_Constant_Q_Control.ip0, rEGCA1_1.IP0) annotation (
              Line(points={{-2,-10.6667},{-2,-16},{25.7143,-16},{25.7143,
                  -10.7143}}, color={0,0,127}));
          connect(rEECCU1_Constant_Q_Control.v0, rEGCA1_1.V_0) annotation (Line(
                points={{-6,-10.6667},{-6,-18},{30,-18},{30,-10.7143}}, color={
                  0,0,127}));
          connect(rEECCU1_Constant_Q_Control.q0, rEGCA1_1.q_0) annotation (Line(
                points={{-10,-10.6667},{-10,-20},{34.2857,-20},{34.2857,
                  -10.7143}}, color={0,0,127}));
          connect(rEECCU1_Constant_Q_Control.p0, rEGCA1_1.p_0) annotation (Line(
                points={{-14,-10.6667},{-14,-22},{38.5714,-22},{38.5714,
                  -10.7143}}, color={0,0,127}));
          connect(add1.y, rEECCU1_Constant_Q_Control.Pref) annotation (Line(
                points={{-39,54},{-36,54},{-36,-2.66667},{-16.6667,-2.66667}},
                color={0,0,127}));
          connect(Qext1, add2.u2) annotation (Line(points={{-120,-60},{-72,-60},
                  {-72,-54},{-62,-54}}, color={0,0,127}));
          connect(add2.u1, rEGCA1_1.q_0) annotation (Line(points={{-62,-66},{
                  -68,-66},{-68,-84},{34.2857,-84},{34.2857,-10.7143}}, color={
                  0,0,127}));
          connect(add2.y, rEECCU1_Constant_Q_Control.Qext) annotation (Line(
                points={{-39,-60},{-22,-60},{-22,0},{-16.6667,0}}, color={0,0,
                  127}));
          annotation (Icon(coordinateSystem(preserveAspectRatio=false), graphics={
                                           Ellipse(
                  extent={{-100,100},{100,-100}},
                  lineColor={0,0,0},
                  fillColor={170,255,85},
                  fillPattern=FillPattern.Solid),Line(
                  points={{-48,2},{-20,56},{2,4},{24,-28},{48,22}},
                  color={0,0,0},
                  smooth=Smooth.Bezier),Text(
                  extent={{-52,-18},{56,-66}},
                  lineColor={0,0,0},
                  fillColor={255,255,255},
                  fillPattern=FillPattern.Solid,
                  textString="%name")}), Diagram(coordinateSystem(preserveAspectRatio=false)));
        end BESSMPCLocalQControl;

        model BESSMPCLocalVQControl
          Interfaces.PwPin p1
            annotation (Placement(transformation(extent={{90,-10},{110,10}})));
          Electrical.Renewables.PSSE.InverterInterface.REGCA1 rEGCA1_1(V_b=V_base,
            P_0=P_0,
            Q_0=Q_0,
            v_0=v_0,
            angle_0=angle_0)
            annotation (Placement(transformation(extent={{20,-10},{40,10}})));
          REECCU1_Local_V_Q_Control2 EC(
            pfflag=false,
            vflag=false,
            qflag=false,
            pqflag=true,
            Trv=0.02,
            Kqp=1,
            Kqi=30,
            Kvp=1,
            Kvi=25,
            Kpp=1,
            Kpi=35,
            Pmin=-1,
            T=999)
            annotation (Placement(transformation(extent={{-16,-10},{4,10}})));
          Modelica.Blocks.Interfaces.RealInput Qext1 "Reactive Power Reference"
            annotation (Placement(transformation(extent={{-140,-80},{-100,-40}})));
          parameter Modelica.Units.SI.Voltage V_base;
          extends OpenIPSL.Electrical.Essentials.pfComponent;
          Modelica.Blocks.Interfaces.RealInput Paux1
            "Auxiliary Signal for Active Power"
            annotation (Placement(transformation(extent={{-140,40},{-100,80}})));
          Modelica.Blocks.Math.Add add1(k1=+1)
            annotation (Placement(transformation(extent={{-60,64},{-40,44}})));
          Modelica.Blocks.Sources.Constant Paux(k=0)
            annotation (Placement(transformation(extent={{-80,-16},{-60,4}})));
          Modelica.Blocks.Math.Add add2(k1=+1)
            annotation (Placement(transformation(extent={{-60,-56},{-40,-76}})));
        equation
          connect(EC.Iqcmd, rEGCA1_1.Iqcmd) annotation (Line(points={{4.33333,
                  5.66667},{11.4524,5.66667},{11.4524,5.71429},{18.5714,5.71429}},
                color={0,0,127}));
          connect(EC.Ipcmd, rEGCA1_1.Ipcmd) annotation (Line(points={{4.33333,
                  -5.66667},{11.4524,-5.66667},{11.4524,-5.71429},{18.5714,
                  -5.71429}}, color={0,0,127}));
          connect(rEGCA1_1.V_t, EC.Vt) annotation (Line(points={{24.2857,
                  10.7143},{24.2857,12},{-20,12},{-20,8},{-16.6667,8}}, color={
                  0,0,127}));
          connect(rEGCA1_1.Pgen, EC.Pe) annotation (Line(points={{30,10.7143},{
                  30,18},{-22,18},{-22,5.33333},{-16.6667,5.33333}}, color={0,0,
                  127}));
          connect(rEGCA1_1.Qgen, EC.Qgen) annotation (Line(points={{35.7143,
                  10.7143},{35.7143,20},{-24,20},{-24,2.66667},{-16.6667,
                  2.66667}}, color={0,0,127}));
          connect(rEGCA1_1.p, p1)
            annotation (Line(points={{40,0},{100,0}}, color={0,0,255}));
          connect(add1.u2, Paux1)
            annotation (Line(points={{-62,60},{-120,60}}, color={0,0,127}));
          connect(rEGCA1_1.p_0, add1.u1) annotation (Line(points={{38.5714,
                  -10.7143},{38.5714,-28},{60,-28},{60,26},{-78,26},{-78,48},{
                  -62,48}},
                        color={0,0,127}));
          connect(Paux.y, EC.Paux) annotation (Line(points={{-59,-6},{-59,
                  -5.33333},{-16.6667,-5.33333}}, color={0,0,127}));
          connect(rEGCA1_1.IQ0, EC.iq0) annotation (Line(points={{21.4286,
                  -10.7143},{21.4286,-14},{2,-14},{2,-10.6667}}, color={0,0,127}));
          connect(EC.ip0, rEGCA1_1.IP0) annotation (Line(points={{-2,-10.6667},
                  {-2,-16},{25.7143,-16},{25.7143,-10.7143}}, color={0,0,127}));
          connect(EC.v0, rEGCA1_1.V_0) annotation (Line(points={{-6,-10.6667},{
                  -6,-18},{30,-18},{30,-10.7143}}, color={0,0,127}));
          connect(EC.q0, rEGCA1_1.q_0) annotation (Line(points={{-10,-10.6667},
                  {-10,-20},{34.2857,-20},{34.2857,-10.7143}}, color={0,0,127}));
          connect(EC.p0, rEGCA1_1.p_0) annotation (Line(points={{-14,-10.6667},
                  {-14,-22},{38.5714,-22},{38.5714,-10.7143}}, color={0,0,127}));
          connect(add1.y, EC.Pref) annotation (Line(points={{-39,54},{-36,54},{
                  -36,-2.66667},{-16.6667,-2.66667}}, color={0,0,127}));
          connect(Qext1, add2.u2)
            annotation (Line(points={{-120,-60},{-62,-60}}, color={0,0,127}));
          connect(rEGCA1_1.q_0, add2.u1) annotation (Line(points={{34.2857,
                  -10.7143},{34.2857,-90},{-70,-90},{-70,-72},{-62,-72}}, color
                ={0,0,127}));
          connect(add2.y, EC.Qext) annotation (Line(points={{-39,-66},{-22,-66},
                  {-22,0},{-16.6667,0}}, color={0,0,127}));
          annotation (Icon(coordinateSystem(preserveAspectRatio=false), graphics={
                                           Ellipse(
                  extent={{-100,100},{100,-100}},
                  lineColor={0,0,0},
                  fillColor={170,255,85},
                  fillPattern=FillPattern.Solid),Line(
                  points={{-48,2},{-20,56},{2,4},{24,-28},{48,22}},
                  color={0,0,0},
                  smooth=Smooth.Bezier),Text(
                  extent={{-52,-18},{56,-66}},
                  lineColor={0,0,0},
                  fillColor={255,255,255},
                  fillPattern=FillPattern.Solid,
                  textString="%name")}), Diagram(coordinateSystem(preserveAspectRatio=false)));
        end BESSMPCLocalVQControl;

        model BESSMPCLocalVQControlLinearized
          Interfaces.PwPin p1
            annotation (Placement(transformation(extent={{90,-10},{110,10}})));
          Electrical.Renewables.PSSE.InverterInterface.REGCA1 rEGCA1_1(V_b=V_base,
            P_0=P_0,
            Q_0=Q_0,
            v_0=v_0,
            angle_0=angle_0)
            annotation (Placement(transformation(extent={{20,-10},{40,10}})));
          REECCU1_Local_V_Q_Control_for_Linearization EC(
            pfflag=false,
            vflag=false,
            qflag=false,
            pqflag=false,
            Trv=0.02,
            Tp=0.05,
            Kqp=1,
            Kqi=30,
            Kvp=1,
            Kvi=25,
            Kpp=1,
            Kpi=35,
            Pmin=-1,
            T=999)
            annotation (Placement(transformation(extent={{-16,-10},{4,10}})));
          Modelica.Blocks.Interfaces.RealInput Qext1 "Reactive Power Reference"
            annotation (Placement(transformation(extent={{-140,-80},{-100,-40}})));
          parameter Modelica.Units.SI.Voltage V_base;
          extends OpenIPSL.Electrical.Essentials.pfComponent;
          Modelica.Blocks.Interfaces.RealInput Paux1
            "Auxiliary Signal for Active Power"
            annotation (Placement(transformation(extent={{-140,40},{-100,80}})));
          Modelica.Blocks.Math.Add add1(k1=+1)
            annotation (Placement(transformation(extent={{-60,64},{-40,44}})));
          Modelica.Blocks.Sources.Constant Paux(k=0)
            annotation (Placement(transformation(extent={{-80,-16},{-60,4}})));
          Modelica.Blocks.Math.Add add2(k1=+1)
            annotation (Placement(transformation(extent={{-60,-56},{-40,-76}})));
        equation
          connect(EC.Iqcmd, rEGCA1_1.Iqcmd) annotation (Line(points={{4.33333,
                  5.66667},{11.4524,5.66667},{11.4524,5.71429},{18.5714,5.71429}},
                color={0,0,127}));
          connect(EC.Ipcmd, rEGCA1_1.Ipcmd) annotation (Line(points={{4.33333,
                  -5.66667},{11.4524,-5.66667},{11.4524,-5.71429},{18.5714,
                  -5.71429}}, color={0,0,127}));
          connect(rEGCA1_1.V_t, EC.Vt) annotation (Line(points={{24.2857,
                  10.7143},{24.2857,12},{-20,12},{-20,8},{-16.6667,8}}, color={
                  0,0,127}));
          connect(rEGCA1_1.Pgen, EC.Pe) annotation (Line(points={{30,10.7143},{
                  30,18},{-22,18},{-22,5.33333},{-16.6667,5.33333}}, color={0,0,
                  127}));
          connect(rEGCA1_1.Qgen, EC.Qgen) annotation (Line(points={{35.7143,
                  10.7143},{35.7143,20},{-24,20},{-24,2.66667},{-16.6667,
                  2.66667}}, color={0,0,127}));
          connect(rEGCA1_1.p, p1)
            annotation (Line(points={{40,0},{100,0}}, color={0,0,255}));
          connect(add1.u2, Paux1)
            annotation (Line(points={{-62,60},{-120,60}}, color={0,0,127}));
          connect(rEGCA1_1.p_0, add1.u1) annotation (Line(points={{38.5714,
                  -10.7143},{38.5714,-28},{60,-28},{60,26},{-78,26},{-78,48},{
                  -62,48}},
                        color={0,0,127}));
          connect(Paux.y, EC.Paux) annotation (Line(points={{-59,-6},{-59,
                  -5.33333},{-16.6667,-5.33333}}, color={0,0,127}));
          connect(rEGCA1_1.IQ0, EC.iq0) annotation (Line(points={{21.4286,
                  -10.7143},{21.4286,-14},{2,-14},{2,-10.6667}}, color={0,0,127}));
          connect(EC.ip0, rEGCA1_1.IP0) annotation (Line(points={{-2,-10.6667},
                  {-2,-16},{25.7143,-16},{25.7143,-10.7143}}, color={0,0,127}));
          connect(EC.v0, rEGCA1_1.V_0) annotation (Line(points={{-6,-10.6667},{
                  -6,-18},{30,-18},{30,-10.7143}}, color={0,0,127}));
          connect(EC.q0, rEGCA1_1.q_0) annotation (Line(points={{-10,-10.6667},
                  {-10,-20},{34.2857,-20},{34.2857,-10.7143}}, color={0,0,127}));
          connect(EC.p0, rEGCA1_1.p_0) annotation (Line(points={{-14,-10.6667},
                  {-14,-22},{38.5714,-22},{38.5714,-10.7143}}, color={0,0,127}));
          connect(add1.y, EC.Pref) annotation (Line(points={{-39,54},{-36,54},{
                  -36,-2.66667},{-16.6667,-2.66667}}, color={0,0,127}));
          connect(Qext1, add2.u2)
            annotation (Line(points={{-120,-60},{-62,-60}}, color={0,0,127}));
          connect(rEGCA1_1.q_0, add2.u1) annotation (Line(points={{34.2857,
                  -10.7143},{34.2857,-90},{-70,-90},{-70,-72},{-62,-72}}, color
                ={0,0,127}));
          connect(add2.y, EC.Qext) annotation (Line(points={{-39,-66},{-22,-66},
                  {-22,0},{-16.6667,0}}, color={0,0,127}));
          annotation (Icon(coordinateSystem(preserveAspectRatio=false), graphics={
                                           Ellipse(
                  extent={{-100,100},{100,-100}},
                  lineColor={0,0,0},
                  fillColor={170,255,85},
                  fillPattern=FillPattern.Solid),Line(
                  points={{-48,2},{-20,56},{2,4},{24,-28},{48,22}},
                  color={0,0,0},
                  smooth=Smooth.Bezier),Text(
                  extent={{-52,-18},{56,-66}},
                  lineColor={0,0,0},
                  fillColor={255,255,255},
                  fillPattern=FillPattern.Solid,
                  textString="%name")}), Diagram(coordinateSystem(preserveAspectRatio=false)));
        end BESSMPCLocalVQControlLinearized;

        model BESSMPCLocalVQControlLinearized_PYTHON
          Interfaces.PwPin p1
            annotation (Placement(transformation(extent={{90,-10},{110,10}})));
          Electrical.Renewables.PSSE.InverterInterface.REGCA1 rEGCA1_1(V_b=V_base,
            P_0=P_0,
            Q_0=Q_0,
            v_0=v_0,
            angle_0=angle_0)
            annotation (Placement(transformation(extent={{20,-10},{40,10}})));
          REECCU1_Local_V_Q_Control_for_LinearizationPYTHON
            rEECCU1_Local_V_Q_Control(
            pfflag=false,
            vflag=false,
            qflag=false,
            pqflag=false,
            dbd1=0,
            dbd2=0,
            Kqv=0,
            Kqp=5,
            Kqi=40,
            Kvp=10,
            Kvi=20,
            Pmin=-1,
            T=999)
            annotation (Placement(transformation(extent={{-16,-10},{4,10}})));
          Modelica.Blocks.Interfaces.RealInput Qext1 "Reactive Power Reference"
            annotation (Placement(transformation(extent={{-140,-80},{-100,-40}})));
          parameter Modelica.Units.SI.Voltage V_base;
          extends OpenIPSL.Electrical.Essentials.pfComponent;
          Modelica.Blocks.Interfaces.RealInput Paux1
            "Auxiliary Signal for Active Power"
            annotation (Placement(transformation(extent={{-140,40},{-100,80}})));
          Modelica.Blocks.Math.Add add1(k1=+1)
            annotation (Placement(transformation(extent={{-60,64},{-40,44}})));
          Modelica.Blocks.Sources.Constant Paux(k=0)
            annotation (Placement(transformation(extent={{-80,-16},{-60,4}})));
          Modelica.Blocks.Math.Add add2(k1=+1)
            annotation (Placement(transformation(extent={{-60,-56},{-40,-76}})));
        equation
          connect(rEECCU1_Local_V_Q_Control.Iqcmd, rEGCA1_1.Iqcmd) annotation (
              Line(points={{4.33333,5.66667},{11.4524,5.66667},{11.4524,5.71429},
                  {18.5714,5.71429}}, color={0,0,127}));
          connect(rEECCU1_Local_V_Q_Control.Ipcmd, rEGCA1_1.Ipcmd) annotation (
              Line(points={{4.33333,-5.66667},{11.4524,-5.66667},{11.4524,
                  -5.71429},{18.5714,-5.71429}}, color={0,0,127}));
          connect(rEGCA1_1.V_t, rEECCU1_Local_V_Q_Control.Vt) annotation (Line(
                points={{24.2857,10.7143},{24.2857,12},{-20,12},{-20,8},{
                  -16.6667,8}}, color={0,0,127}));
          connect(rEGCA1_1.Pgen, rEECCU1_Local_V_Q_Control.Pe) annotation (Line(
                points={{30,10.7143},{30,18},{-22,18},{-22,5.33333},{-16.6667,
                  5.33333}}, color={0,0,127}));
          connect(rEGCA1_1.Qgen, rEECCU1_Local_V_Q_Control.Qgen) annotation (
              Line(points={{35.7143,10.7143},{35.7143,20},{-24,20},{-24,2.66667},
                  {-16.6667,2.66667}}, color={0,0,127}));
          connect(rEGCA1_1.p, p1)
            annotation (Line(points={{40,0},{100,0}}, color={0,0,255}));
          connect(add1.u2, Paux1)
            annotation (Line(points={{-62,60},{-120,60}}, color={0,0,127}));
          connect(rEGCA1_1.p_0, add1.u1) annotation (Line(points={{38.5714,
                  -10.7143},{38.5714,-28},{60,-28},{60,26},{-78,26},{-78,48},{
                  -62,48}},
                        color={0,0,127}));
          connect(Paux.y, rEECCU1_Local_V_Q_Control.Paux) annotation (Line(
                points={{-59,-6},{-59,-5.33333},{-16.6667,-5.33333}}, color={0,
                  0,127}));
          connect(rEGCA1_1.IQ0, rEECCU1_Local_V_Q_Control.iq0) annotation (Line(
                points={{21.4286,-10.7143},{21.4286,-14},{2,-14},{2,-10.6667}},
                color={0,0,127}));
          connect(rEECCU1_Local_V_Q_Control.ip0, rEGCA1_1.IP0) annotation (Line(
                points={{-2,-10.6667},{-2,-16},{25.7143,-16},{25.7143,-10.7143}},
                color={0,0,127}));
          connect(rEECCU1_Local_V_Q_Control.v0, rEGCA1_1.V_0) annotation (Line(
                points={{-6,-10.6667},{-6,-18},{30,-18},{30,-10.7143}}, color={
                  0,0,127}));
          connect(rEECCU1_Local_V_Q_Control.q0, rEGCA1_1.q_0) annotation (Line(
                points={{-10,-10.6667},{-10,-20},{34.2857,-20},{34.2857,
                  -10.7143}}, color={0,0,127}));
          connect(rEECCU1_Local_V_Q_Control.p0, rEGCA1_1.p_0) annotation (Line(
                points={{-14,-10.6667},{-14,-22},{38.5714,-22},{38.5714,
                  -10.7143}}, color={0,0,127}));
          connect(add1.y, rEECCU1_Local_V_Q_Control.Pref) annotation (Line(
                points={{-39,54},{-36,54},{-36,-2.66667},{-16.6667,-2.66667}},
                color={0,0,127}));
          connect(Qext1, add2.u2)
            annotation (Line(points={{-120,-60},{-62,-60}}, color={0,0,127}));
          connect(rEGCA1_1.q_0, add2.u1) annotation (Line(points={{34.2857,
                  -10.7143},{34.2857,-90},{-70,-90},{-70,-72},{-62,-72}}, color
                ={0,0,127}));
          connect(add2.y, rEECCU1_Local_V_Q_Control.Qext) annotation (Line(
                points={{-39,-66},{-22,-66},{-22,0},{-16.6667,0}}, color={0,0,
                  127}));
          annotation (Icon(coordinateSystem(preserveAspectRatio=false), graphics={
                                           Ellipse(
                  extent={{-100,100},{100,-100}},
                  lineColor={0,0,0},
                  fillColor={170,255,85},
                  fillPattern=FillPattern.Solid),Line(
                  points={{-48,2},{-20,56},{2,4},{24,-28},{48,22}},
                  color={0,0,0},
                  smooth=Smooth.Bezier),Text(
                  extent={{-52,-18},{56,-66}},
                  lineColor={0,0,0},
                  fillColor={255,255,255},
                  fillPattern=FillPattern.Solid,
                  textString="%name")}), Diagram(coordinateSystem(preserveAspectRatio=false)));
        end BESSMPCLocalVQControlLinearized_PYTHON;

        model BESSMPCLocalVQControlLinearized_OBSERVABILITY
          Interfaces.PwPin p1
            annotation (Placement(transformation(extent={{90,-10},{110,10}})));
          REGCA1_OBSERVABILITY                                rEGCA1_OBSERVABILITY(
                                                                       V_b=V_base,
            P_0=P_0,
            Q_0=Q_0,
            v_0=v_0,
            angle_0=angle_0)
            annotation (Placement(transformation(extent={{20,-10},{40,10}})));
          REECCU1_Local_V_Q_Control_for_Linearization_OBSERVABILITY
                                                      EC(
            pfflag=false,
            vflag=false,
            qflag=false,
            pqflag=false,
            Trv=0.02,
            Tp=0.05,
            Kqp=1,
            Kqi=30,
            Kvp=1,
            Kvi=25,
            Kpp=1,
            Kpi=35,
            Pmin=-1,
            T=999)
            annotation (Placement(transformation(extent={{-16,-10},{4,10}})));
          Modelica.Blocks.Interfaces.RealInput Qext1 "Reactive Power Reference"
            annotation (Placement(transformation(extent={{-140,-80},{-100,-40}})));
          parameter Modelica.Units.SI.Voltage V_base;
          extends OpenIPSL.Electrical.Essentials.pfComponent;
          Modelica.Blocks.Interfaces.RealInput Paux1
            "Auxiliary Signal for Active Power"
            annotation (Placement(transformation(extent={{-140,40},{-100,80}})));
          Modelica.Blocks.Math.Add add1(k1=+1)
            annotation (Placement(transformation(extent={{-60,64},{-40,44}})));
          Modelica.Blocks.Sources.Constant Paux(k=0)
            annotation (Placement(transformation(extent={{-80,-16},{-60,4}})));
          Modelica.Blocks.Math.Add add2(k1=+1)
            annotation (Placement(transformation(extent={{-60,-56},{-40,-76}})));
        equation
          connect(EC.Iqcmd, rEGCA1_OBSERVABILITY.Iqcmd) annotation (Line(points
                ={{4.33333,5.66667},{11.4524,5.66667},{11.4524,5.71429},{
                  18.5714,5.71429}}, color={0,0,127}));
          connect(EC.Ipcmd, rEGCA1_OBSERVABILITY.Ipcmd) annotation (Line(points
                ={{4.33333,-5.66667},{11.4524,-5.66667},{11.4524,-5.71429},{
                  18.5714,-5.71429}}, color={0,0,127}));
          connect(rEGCA1_OBSERVABILITY.V_t, EC.Vt) annotation (Line(points={{
                  24.2857,10.7143},{24.2857,12},{-20,12},{-20,8},{-16.6667,8}},
                color={0,0,127}));
          connect(rEGCA1_OBSERVABILITY.Pgen, EC.Pe) annotation (Line(points={{
                  30,10.7143},{30,18},{-22,18},{-22,5.33333},{-16.6667,5.33333}},
                color={0,0,127}));
          connect(rEGCA1_OBSERVABILITY.Qgen, EC.Qgen) annotation (Line(points={
                  {35.7143,10.7143},{35.7143,20},{-24,20},{-24,2.66667},{
                  -16.6667,2.66667}}, color={0,0,127}));
          connect(rEGCA1_OBSERVABILITY.p, p1)
            annotation (Line(points={{40,0},{100,0}}, color={0,0,255}));
          connect(add1.u2, Paux1)
            annotation (Line(points={{-62,60},{-120,60}}, color={0,0,127}));
          connect(rEGCA1_OBSERVABILITY.p_0, add1.u1) annotation (Line(points={{
                  38.5714,-10.7143},{38.5714,-28},{60,-28},{60,26},{-78,26},{
                  -78,48},{-62,48}}, color={0,0,127}));
          connect(Paux.y, EC.Paux) annotation (Line(points={{-59,-6},{-59,
                  -5.33333},{-16.6667,-5.33333}}, color={0,0,127}));
          connect(rEGCA1_OBSERVABILITY.IQ0, EC.iq0) annotation (Line(points={{
                  21.4286,-10.7143},{21.4286,-14},{2,-14},{2,-10.6667}}, color=
                  {0,0,127}));
          connect(EC.ip0, rEGCA1_OBSERVABILITY.IP0) annotation (Line(points={{
                  -2,-10.6667},{-2,-16},{25.7143,-16},{25.7143,-10.7143}},
                color={0,0,127}));
          connect(EC.v0, rEGCA1_OBSERVABILITY.V_0) annotation (Line(points={{-6,
                  -10.6667},{-6,-18},{30,-18},{30,-10.7143}}, color={0,0,127}));
          connect(EC.q0, rEGCA1_OBSERVABILITY.q_0) annotation (Line(points={{
                  -10,-10.6667},{-10,-20},{34.2857,-20},{34.2857,-10.7143}},
                color={0,0,127}));
          connect(EC.p0, rEGCA1_OBSERVABILITY.p_0) annotation (Line(points={{
                  -14,-10.6667},{-14,-22},{38.5714,-22},{38.5714,-10.7143}},
                color={0,0,127}));
          connect(add1.y, EC.Pref) annotation (Line(points={{-39,54},{-36,54},{
                  -36,-2.66667},{-16.6667,-2.66667}}, color={0,0,127}));
          connect(Qext1, add2.u2)
            annotation (Line(points={{-120,-60},{-62,-60}}, color={0,0,127}));
          connect(rEGCA1_OBSERVABILITY.q_0, add2.u1) annotation (Line(points={{
                  34.2857,-10.7143},{34.2857,-90},{-70,-90},{-70,-72},{-62,-72}},
                color={0,0,127}));
          connect(add2.y, EC.Qext) annotation (Line(points={{-39,-66},{-22,-66},
                  {-22,0},{-16.6667,0}}, color={0,0,127}));
          annotation (Icon(coordinateSystem(preserveAspectRatio=false), graphics={
                                           Ellipse(
                  extent={{-100,100},{100,-100}},
                  lineColor={0,0,0},
                  fillColor={170,255,85},
                  fillPattern=FillPattern.Solid),Line(
                  points={{-48,2},{-20,56},{2,4},{24,-28},{48,22}},
                  color={0,0,0},
                  smooth=Smooth.Bezier),Text(
                  extent={{-52,-18},{56,-66}},
                  lineColor={0,0,0},
                  fillColor={255,255,255},
                  fillPattern=FillPattern.Solid,
                  textString="%name")}), Diagram(coordinateSystem(preserveAspectRatio=false)));
        end BESSMPCLocalVQControlLinearized_OBSERVABILITY;

        model BESSMPCSysIdentification
          Interfaces.PwPin p1
            annotation (Placement(transformation(extent={{90,-10},{110,10}})));
          Modelica.Blocks.Interfaces.RealInput Qext1 "Reactive Power Reference"
            annotation (Placement(transformation(extent={{-140,-80},{-100,-40}})));
          parameter Modelica.Units.SI.Voltage V_base;
          extends OpenIPSL.Electrical.Essentials.pfComponent;
          Modelica.Blocks.Interfaces.RealInput Paux1
            "Auxiliary Signal for Active Power"
            annotation (Placement(transformation(extent={{-140,40},{-100,80}})));
          BESS_SYS_ID rEGCA1_1(
            V_b=V_base,
            P_0=P_0,
            Q_0=Q_0,
            v_0=v_0,
            angle_0=angle_0)
            annotation (Placement(transformation(extent={{-14,-14},{14,14}})));
        equation
          connect(rEGCA1_1.p, p1)
            annotation (Line(points={{14,0},{100,0}}, color={0,0,255}));
          connect(Paux1, rEGCA1_1.Ipcmd) annotation (Line(points={{-120,60},{-80,
                  60},{-80,-8},{-16,-8}}, color={0,0,127}));
          connect(Qext1, rEGCA1_1.Iqcmd) annotation (Line(points={{-120,-60},{-60,
                  -60},{-60,8},{-16,8}}, color={0,0,127}));
          annotation (Icon(coordinateSystem(preserveAspectRatio=false), graphics={
                                           Ellipse(
                  extent={{-100,100},{100,-100}},
                  lineColor={0,0,0},
                  fillColor={170,255,85},
                  fillPattern=FillPattern.Solid),Line(
                  points={{-48,2},{-20,56},{2,4},{24,-28},{48,22}},
                  color={0,0,0},
                  smooth=Smooth.Bezier),Text(
                  extent={{-52,-18},{56,-66}},
                  lineColor={0,0,0},
                  fillColor={255,255,255},
                  fillPattern=FillPattern.Solid,
                  textString="%name")}), Diagram(coordinateSystem(preserveAspectRatio=false)));
        end BESSMPCSysIdentification;
      end Battery_Units;
    end PSSE;

  end GenerationUnits;

  package PSSE
    extends Modelica.Icons.ExamplesPackage;

    model Reconnection_Microgrid_PSSE_1_INPUT_WITH_INF_BUS
      "Base network for testing MPC control over the islanded generator"
      extends Modelica.Icons.Example;
      OpenIPSL.Electrical.Buses.Bus BG1(v_0=0.998855, angle_0=0.15699114448641)
        annotation (Placement(transformation(extent={{-90,60},{-70,80}})));
      OpenIPSL.Electrical.Buses.Bus B1(v_0=0.992504, angle_0=0.076251672237088)
        annotation (Placement(transformation(extent={{-50,60},{-30,80}})));
      OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
        R=0.001,
        X=0.2,
        G=0,
        B=0,
        VNOM1=220000,
        VB1=220000,
        VNOM2=24000,
        VB2=24000) annotation (Placement(transformation(
            extent={{-6,-4},{6,4}},
            rotation=180,
            origin={-60,70})));
      OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
        v_0=0.998855,
        angle_0=0.15699114448641,
        P_0=40000000,
        Q_0=4547321,
        V_b=24000)
        annotation (Placement(transformation(extent={{-112,60},{-92,80}})));
      OpenIPSL.Electrical.Branches.PwLine L1(
        R=0.001,
        X=0.2,
        G=0,
        B=0) annotation (Placement(transformation(extent={{-26,66},{-14,74}})));
      OpenIPSL.Electrical.Buses.Bus B2(v_0=0.992681, angle_0=-0.0049879590159821)
        annotation (Placement(transformation(extent={{-10,60},{10,80}})));
      OpenIPSL.Electrical.Buses.Bus B3(v_0=0.998705, angle_0=9.4873305611609e-06)
        annotation (Placement(transformation(extent={{50,60},{70,80}})));
      OpenIPSL.Electrical.Branches.PwLine L2_1(
        R=0.0005,
        X=0.1,
        G=0,
        B=0) annotation (Placement(transformation(extent={{24,86},{36,94}})));
      OpenIPSL.Electrical.Branches.PwLine L2_2(
        R=0.0005,
        X=0.1,
        G=0,
        B=0) annotation (Placement(transformation(extent={{24,46},{36,54}})));
      OpenIPSL.Electrical.Buses.Bus B4(angle_0=-0.00014475935348966,
                                                              v_0=0.997342)
        annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=90,
            origin={80,10})));
      OpenIPSL.Electrical.Branches.PwLine L3(
        R=0.001,
        X=0.2,
        G=0,
        B=0) annotation (Placement(transformation(
            extent={{-6,-4},{6,4}},
            rotation=-90,
            origin={80,40})));
      OpenIPSL.Electrical.Buses.Bus B5(v_0=1.0074, angle_0=0.0093371449790267)
                                       annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=90,
            origin={60,-20})));
      OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
        G=0,
        B=0,
        VNOM1=220000,
        VB1=220000,
        VNOM2=24000,
        VB2=24000,
        R=0.005,
        X=0.1) annotation (Placement(transformation(
            extent={{-6,-4},{6,4}},
            rotation=270,
            origin={60,-10})));
      OpenIPSL.Examples.ModelPredictiveControl.GenerationUnits.PSSE.G2_1INPUT_Pref
        G2(
        v_0=1.0074,
        angle_0=0.0093371449790267,
        V_b=24000,
        P_0=10010220,
        Q_0=10204330) annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=90,
            origin={60,-40})));
      inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000,
                                                            fn=50)
        annotation (Placement(transformation(extent={{-140,100},{-80,120}})));
      OpenIPSL.Electrical.Loads.PSSE.Load LD1(
        V_b=220000,
        v_0=0.992681,
        angle_0=-0.0049879590159821,
        P_0=50000000,
        Q_0=10000000) annotation (Placement(transformation(extent={{-12,18},{0,30}})));
      Electrical.Events.Breaker breaker(enableTrigger=false, t_o=1)
                                               annotation (Placement(transformation(
            extent={{-4,-4},{4,4}},
            rotation=90,
            origin={80,22})));

      Modelica.Blocks.Interfaces.RealInput IN1(start=0)
        "Connector of Real input signal 2" annotation (Placement(transformation(
            extent={{-20,-20},{20,20}},
            rotation=0,
            origin={-160,0})));
      Electrical.Loads.PSSE.Load_variation load_variation(
        V_b=220000,
        P_0=10000000,
        Q_0=10000000,
        v_0=0.997342,
        angle_0=-0.00014475935348966,
        d_P=0.1,
        t1=1000,
        d_t=2000)
        annotation (Placement(transformation(extent={{90,-40},{110,-20}})));
      Electrical.Machines.PSSE.GENCLS          IB(
        V_b=220000,
        v_0=1,
        angle_0=0,
        P_0=10067010,
        Q_0=12058260,
        M_b=100000000,
        X_d=0.2) annotation (Placement(transformation(extent={{112,60},{102,80}})));
      Modelica.Blocks.Interfaces.RealOutput OUT2
        annotation (Placement(transformation(extent={{140,50},{160,70}})));
      Modelica.Blocks.Sources.Constant IN11(k=0)
        annotation (Placement(transformation(extent={{-120,-40},{-100,-20}})));
      Modelica.Blocks.Math.Add AddU1
        annotation (Placement(transformation(extent={{-80,-16},{-60,4}})));
      OpenCPS.Controls.FREQ_CALC fREQ_CALC(
        T_w=2,
        T_f=1,
        fi_0=0.0093371449790267)
                annotation (Placement(transformation(extent={{-100,-80},{-80,-60}})));
      Modelica.Blocks.Sources.RealExpression realExpression(y=B5.angle)
        annotation (Placement(transformation(extent={{-130,-80},{-110,-60}})));
      Modelica.Blocks.Interfaces.RealOutput frequency
        annotation (Placement(transformation(extent={{-28,-86},{-8,-66}})));
    equation
      //OUT1 = softPMU.freq;
      OUT2 = B4.v;

      connect(T1.p, B1.p)
        annotation (Line(points={{-53.4,70},{-40,70}},        color={0,0,255}));
      connect(BG1.p, T1.n)
        annotation (Line(points={{-80,70},{-66.6,70}},
                                                     color={0,0,255}));
      connect(G1.conn, BG1.p)
        annotation (Line(points={{-91,70},{-80,70}},          color={0,0,255}));
      connect(L1.n, B2.p)
        annotation (Line(points={{-14.6,70},{0,70}},            color={0,0,255}));
      connect(L1.p, B1.p) annotation (Line(points={{-25.4,70},{-40,70}},
            color={0,0,255}));
      connect(L2_2.n, B3.p) annotation (Line(points={{35.4,50},{56,50},{56,70},{60,
              70}}, color={0,0,255}));
      connect(L2_1.n, B3.p) annotation (Line(points={{35.4,90},{56,90},{56,70},{60,
              70}}, color={0,0,255}));
      connect(L2_1.p, B2.p) annotation (Line(points={{24.6,90},{4,90},{4,70},{0,70}},
                           color={0,0,255}));
      connect(L2_2.p, B2.p) annotation (Line(points={{24.6,50},{4,50},{4,70},{0,70}},
            color={0,0,255}));
      connect(G2.conn, B5.p)
        annotation (Line(points={{60,-29},{60,-20}}, color={0,0,255}));
      connect(LD1.p, B2.p)
        annotation (Line(points={{-6,30},{-6,70},{0,70}},color={0,0,255}));
      connect(L3.p, B3.p) annotation (Line(points={{80,45.4},{80,70},{60,70}},
                                 color={0,0,255}));
      connect(breaker.s, B4.p)
        annotation (Line(points={{80,18},{80,10}},   color={0,0,255}));
      connect(breaker.r, L3.n)
        annotation (Line(points={{80,26},{80,34.6}},color={0,0,255}));
      connect(T2.n, B5.p)
        annotation (Line(points={{60,-16.6},{60,-20}}, color={0,0,255}));
      connect(load_variation.p, B4.p) annotation (Line(points={{100,-20},{100,0},
              {80,0},{80,10}},      color={0,0,255}));
      connect(IB.p, B3.p)
        annotation (Line(points={{102,70},{60,70}}, color={0,0,255}));
      connect(IN11.y, AddU1.u2) annotation (Line(points={{-99,-30},{-90,-30},{-90,
              -12},{-82,-12}},
                          color={0,0,127}));
      connect(IN1, AddU1.u1) annotation (Line(points={{-160,0},{-82,0}},
                         color={0,0,127}));
      connect(AddU1.y, G2.P_ref) annotation (Line(points={{-59,-6},{44,-6},{44,
              -62},{60,-62},{60,-52}},
                                  color={0,0,127}));
      connect(T2.p, B4.p) annotation (Line(points={{60,-3.4},{60,0},{80,0},{80,10}},
                            color={0,0,255}));
      connect(realExpression.y,fREQ_CALC. ANGLE)
        annotation (Line(points={{-109,-70},{-99,-70}},color={0,0,127}));
      connect(frequency, fREQ_CALC.d_FREQ) annotation (Line(points={{-18,-76},{
              -74,-76},{-74,-66},{-79,-66}}, color={0,0,127}));
      annotation ( Diagram(coordinateSystem(preserveAspectRatio=false,
              extent={{-140,-120},{140,120}})),
        Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),
        experiment(StopTime=50, __Dymola_Algorithm="Dassl"));
    end Reconnection_Microgrid_PSSE_1_INPUT_WITH_INF_BUS;

    model Reconnection_Microgrid_PSSE_1_INPUT_WITH_INF_BUS2
      "Base network for testing MPC control over the islanded generator"
      extends Modelica.Icons.Example;
      OpenIPSL.Electrical.Buses.Bus BG1(v_0=0.998855, angle_0=0.15699114448641)
        annotation (Placement(transformation(extent={{-90,60},{-70,80}})));
      OpenIPSL.Electrical.Buses.Bus B1(v_0=0.992504, angle_0=0.076251672237088)
        annotation (Placement(transformation(extent={{-50,60},{-30,80}})));
      OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
        R=0.001,
        X=0.2,
        G=0,
        B=0,
        VNOM1=220000,
        VB1=220000,
        VNOM2=24000,
        VB2=24000) annotation (Placement(transformation(
            extent={{-6,-4},{6,4}},
            rotation=180,
            origin={-60,70})));
      OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
        v_0=0.998855,
        angle_0=0.15699114448641,
        P_0=40000000,
        Q_0=4547321,
        V_b=24000)
        annotation (Placement(transformation(extent={{-112,60},{-92,80}})));
      OpenIPSL.Electrical.Branches.PwLine L1(
        R=0.001,
        X=0.2,
        G=0,
        B=0) annotation (Placement(transformation(extent={{-26,66},{-14,74}})));
      OpenIPSL.Electrical.Buses.Bus B2(v_0=0.992681, angle_0=-0.0049879590159821)
        annotation (Placement(transformation(extent={{-10,60},{10,80}})));
      OpenIPSL.Electrical.Buses.Bus B3(v_0=0.998705, angle_0=9.4873305611609e-06)
        annotation (Placement(transformation(extent={{50,60},{70,80}})));
      OpenIPSL.Electrical.Branches.PwLine L2_1(
        R=0.0005,
        X=0.1,
        G=0,
        B=0) annotation (Placement(transformation(extent={{24,86},{36,94}})));
      OpenIPSL.Electrical.Branches.PwLine L2_2(
        R=0.0005,
        X=0.1,
        G=0,
        B=0) annotation (Placement(transformation(extent={{24,46},{36,54}})));
      OpenIPSL.Electrical.Buses.Bus B4(angle_0=-0.00014475935348966,
                                                              v_0=0.997342)
        annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=90,
            origin={80,10})));
      OpenIPSL.Electrical.Branches.PwLine L3(
        R=0.001,
        X=0.2,
        G=0,
        B=0) annotation (Placement(transformation(
            extent={{-6,-4},{6,4}},
            rotation=-90,
            origin={80,40})));
      OpenIPSL.Electrical.Buses.Bus B5(v_0=1.0074, angle_0=0.0093371449790267)
                                       annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=90,
            origin={60,-20})));
      OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
        G=0,
        B=0,
        VNOM1=220000,
        VB1=220000,
        VNOM2=24000,
        VB2=24000,
        R=0.005,
        X=0.1) annotation (Placement(transformation(
            extent={{-6,-4},{6,4}},
            rotation=270,
            origin={60,-10})));
      OpenIPSL.Examples.ModelPredictiveControl.GenerationUnits.PSSE.G2_1INPUT_Pref
        G2(
        v_0=1.0074,
        angle_0=0.0093371449790267,
        V_b=24000,
        P_0=10010220,
        Q_0=10204330) annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=90,
            origin={60,-40})));
      inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000,
                                                            fn=50)
        annotation (Placement(transformation(extent={{-140,100},{-80,120}})));
      OpenIPSL.Electrical.Loads.PSSE.Load LD1(
        V_b=220000,
        v_0=0.992681,
        angle_0=-0.0049879590159821,
        P_0=50000000,
        Q_0=10000000) annotation (Placement(transformation(extent={{-12,18},{0,30}})));
      Electrical.Events.Breaker breaker(enableTrigger=false, t_o=1)
                                               annotation (Placement(transformation(
            extent={{-4,-4},{4,4}},
            rotation=90,
            origin={80,22})));

      Modelica.Blocks.Interfaces.RealInput IN1(start=0)
        "Connector of Real input signal 2" annotation (Placement(transformation(
            extent={{-20,-20},{20,20}},
            rotation=0,
            origin={-160,0})));
      Electrical.Loads.PSSE.Load_variation load_variation(
        V_b=220000,
        P_0=10000000,
        Q_0=10000000,
        v_0=0.997342,
        angle_0=-0.00014475935348966,
        d_P=0.1,
        t1=1000,
        d_t=2000)
        annotation (Placement(transformation(extent={{90,-40},{110,-20}})));
      Electrical.Machines.PSSE.GENCLS          IB(
        V_b=220000,
        v_0=1,
        angle_0=0,
        P_0=10067010,
        Q_0=12058260,
        M_b=100000000,
        H=1000,
        X_d=0.2) annotation (Placement(transformation(extent={{112,60},{102,80}})));
      Modelica.Blocks.Interfaces.RealOutput OUT2
        annotation (Placement(transformation(extent={{140,50},{160,70}})));
      Modelica.Blocks.Sources.Constant IN11(k=0)
        annotation (Placement(transformation(extent={{-120,-40},{-100,-20}})));
      Modelica.Blocks.Math.Add AddU1
        annotation (Placement(transformation(extent={{-80,-16},{-60,4}})));
      Modelica.Blocks.Interfaces.RealOutput OUT1
        "Machine speed deviation from nominal [pu]"
        annotation (Placement(transformation(extent={{140,-90},{160,-70}})));
    equation

      OUT2 = B4.v;

      connect(T1.p, B1.p)
        annotation (Line(points={{-53.4,70},{-40,70}},        color={0,0,255}));
      connect(BG1.p, T1.n)
        annotation (Line(points={{-80,70},{-66.6,70}},
                                                     color={0,0,255}));
      connect(G1.conn, BG1.p)
        annotation (Line(points={{-91,70},{-80,70}},          color={0,0,255}));
      connect(L1.n, B2.p)
        annotation (Line(points={{-14.6,70},{0,70}},            color={0,0,255}));
      connect(L1.p, B1.p) annotation (Line(points={{-25.4,70},{-40,70}},
            color={0,0,255}));
      connect(L2_2.n, B3.p) annotation (Line(points={{35.4,50},{56,50},{56,70},{60,
              70}}, color={0,0,255}));
      connect(L2_1.n, B3.p) annotation (Line(points={{35.4,90},{56,90},{56,70},{60,
              70}}, color={0,0,255}));
      connect(L2_1.p, B2.p) annotation (Line(points={{24.6,90},{4,90},{4,70},{0,70}},
                           color={0,0,255}));
      connect(L2_2.p, B2.p) annotation (Line(points={{24.6,50},{4,50},{4,70},{0,70}},
            color={0,0,255}));
      connect(G2.conn, B5.p)
        annotation (Line(points={{60,-29},{60,-20}}, color={0,0,255}));
      connect(LD1.p, B2.p)
        annotation (Line(points={{-6,30},{-6,70},{0,70}},color={0,0,255}));
      connect(L3.p, B3.p) annotation (Line(points={{80,45.4},{80,70},{60,70}},
                                 color={0,0,255}));
      connect(breaker.s, B4.p)
        annotation (Line(points={{80,18},{80,10}},   color={0,0,255}));
      connect(breaker.r, L3.n)
        annotation (Line(points={{80,26},{80,34.6}},color={0,0,255}));
      connect(T2.n, B5.p)
        annotation (Line(points={{60,-16.6},{60,-20}}, color={0,0,255}));
      connect(load_variation.p, B4.p) annotation (Line(points={{100,-20},{100,0},{80,
              0},{80,10}},          color={0,0,255}));
      connect(IB.p, B3.p)
        annotation (Line(points={{102,70},{60,70}}, color={0,0,255}));
      connect(IN11.y, AddU1.u2) annotation (Line(points={{-99,-30},{-90,-30},{-90,-12},
              {-82,-12}}, color={0,0,127}));
      connect(IN1, AddU1.u1) annotation (Line(points={{-160,0},{-82,0}},
                         color={0,0,127}));
      connect(AddU1.y, G2.P_ref) annotation (Line(points={{-59,-6},{44,-6},{44,-62},
              {60,-62},{60,-52}}, color={0,0,127}));
      connect(T2.p, B4.p) annotation (Line(points={{60,-3.4},{60,0},{80,0},{80,10}},
                            color={0,0,255}));
      connect(G2.SPEED1, OUT1) annotation (Line(points={{54,-29},{54,-30},{42,-30},{
              42,-80},{150,-80}}, color={0,0,127}));
      annotation ( Diagram(coordinateSystem(preserveAspectRatio=false,
              extent={{-140,-120},{140,120}})),
        Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),
        experiment(StopTime=50, __Dymola_Algorithm="Dassl"));
    end Reconnection_Microgrid_PSSE_1_INPUT_WITH_INF_BUS2;

    model Reconnection_Microgrid_PSSE_1_INPUT_WITH_CONST_V_SOURCE
      "Base network for testing MPC control over the islanded generator"
      extends Modelica.Icons.Example;
      OpenIPSL.Electrical.Buses.Bus BG1(v_0=0.998855, angle_0=0.15699114448641)
        annotation (Placement(transformation(extent={{-90,60},{-70,80}})));
      OpenIPSL.Electrical.Buses.Bus B1(v_0=0.992504, angle_0=0.076251672237088)
        annotation (Placement(transformation(extent={{-50,60},{-30,80}})));
      OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
        R=0.001,
        X=0.2,
        G=0,
        B=0,
        VNOM1=220000,
        VB1=220000,
        VNOM2=24000,
        VB2=24000) annotation (Placement(transformation(
            extent={{-6,-4},{6,4}},
            rotation=180,
            origin={-60,70})));
      OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
        v_0=0.998855,
        angle_0=0.15699114448641,
        P_0=40000000,
        Q_0=4547321,
        V_b=24000)
        annotation (Placement(transformation(extent={{-112,60},{-92,80}})));
      OpenIPSL.Electrical.Branches.PwLine L1(
        R=0.001,
        X=0.2,
        G=0,
        B=0) annotation (Placement(transformation(extent={{-26,66},{-14,74}})));
      OpenIPSL.Electrical.Buses.Bus B2(v_0=0.992681, angle_0=-0.0049879590159821)
        annotation (Placement(transformation(extent={{-10,60},{10,80}})));
      OpenIPSL.Electrical.Buses.Bus B3(v_0=0.998705, angle_0=9.4873305611609e-06)
        annotation (Placement(transformation(extent={{50,60},{70,80}})));
      OpenIPSL.Electrical.Branches.PwLine L2_1(
        R=0.0005,
        X=0.1,
        G=0,
        B=0) annotation (Placement(transformation(extent={{24,86},{36,94}})));
      OpenIPSL.Electrical.Branches.PwLine L2_2(
        R=0.0005,
        X=0.1,
        G=0,
        B=0) annotation (Placement(transformation(extent={{24,46},{36,54}})));
      OpenIPSL.Electrical.Buses.Bus B4(angle_0=-0.00014475935348966,
                                                              v_0=0.997342)
        annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=90,
            origin={80,10})));
      OpenIPSL.Electrical.Branches.PwLine L3(
        R=0.001,
        X=0.2,
        G=0,
        B=0) annotation (Placement(transformation(
            extent={{-6,-4},{6,4}},
            rotation=-90,
            origin={80,40})));
      OpenIPSL.Electrical.Buses.Bus B5(v_0=1.0074, angle_0=0.0093371449790267)
                                       annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=90,
            origin={60,-20})));
      OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
        G=0,
        B=0,
        VNOM1=220000,
        VB1=220000,
        VNOM2=24000,
        VB2=24000,
        R=0.005,
        X=0.1) annotation (Placement(transformation(
            extent={{-6,-4},{6,4}},
            rotation=270,
            origin={60,-6})));
      OpenIPSL.Examples.ModelPredictiveControl.GenerationUnits.PSSE.G2_1INPUT_Pref
        G2(
        v_0=1.0074,
        angle_0=0.0093371449790267,
        V_b=24000,
        P_0=10010220,
        Q_0=10204330) annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=90,
            origin={60,-40})));
      inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000,
                                                            fn=50)
        annotation (Placement(transformation(extent={{-140,100},{-80,120}})));
      OpenIPSL.Electrical.Loads.PSSE.Load LD1(
        V_b=220000,
        v_0=0.992681,
        angle_0=-0.0049879590159821,
        P_0=50000000,
        Q_0=10000000) annotation (Placement(transformation(extent={{-12,18},{0,30}})));
      Electrical.Events.Breaker breaker(enableTrigger=false, t_o=1)
                                               annotation (Placement(transformation(
            extent={{-4,-4},{4,4}},
            rotation=90,
            origin={80,22})));

      Modelica.Blocks.Interfaces.RealInput IN1(start=0)
        "Connector of Real input signal 2" annotation (Placement(transformation(
            extent={{-20,-20},{20,20}},
            rotation=0,
            origin={-160,0})));
      Electrical.Loads.PSSE.Load_variation load_variation(
        V_b=220000,
        P_0=10000000,
        Q_0=10000000,
        v_0=0.997342,
        angle_0=-0.00014475935348966,
        d_P=0.1,
        t1=1000,
        d_t=2000)
        annotation (Placement(transformation(extent={{90,-40},{110,-20}})));
      Electrical.Sensors.SoftPMU softPMU(v_0=0.997342, angle_0=-0.00014475935348966)
        annotation (Placement(transformation(extent={{26,0},{46,20}})));
      Modelica.Blocks.Interfaces.RealOutput OUT1
        annotation (Placement(transformation(extent={{140,-70},{160,-50}})));
      Modelica.Blocks.Interfaces.RealOutput OUT2
        annotation (Placement(transformation(extent={{140,50},{160,70}})));
      Electrical.Sources.VoltageSourceReImInput voltageSourceReImInput
        annotation (Placement(transformation(
            extent={{-10,10},{10,-10}},
            rotation=180,
            origin={86,96})));
      Modelica.Blocks.Sources.Constant VR(k=0.998726)
        annotation (Placement(transformation(extent={{130,90},{110,110}})));
      Modelica.Blocks.Sources.Constant VI(k=3.7730e-5)
        annotation (Placement(transformation(extent={{132,56},{112,76}})));
      Modelica.Blocks.Sources.Constant IN11(k=0)
        annotation (Placement(transformation(extent={{-120,-60},{-100,-40}})));
      Modelica.Blocks.Math.Add AddU1
        annotation (Placement(transformation(extent={{-80,-40},{-60,-20}})));
    equation
      OUT1 = softPMU.freq;
      OUT2 = B4.v;

      connect(T1.p, B1.p)
        annotation (Line(points={{-53.4,70},{-40,70}},        color={0,0,255}));
      connect(BG1.p, T1.n)
        annotation (Line(points={{-80,70},{-66.6,70}},
                                                     color={0,0,255}));
      connect(G1.conn, BG1.p)
        annotation (Line(points={{-91,70},{-80,70}},          color={0,0,255}));
      connect(L1.n, B2.p)
        annotation (Line(points={{-14.6,70},{0,70}},            color={0,0,255}));
      connect(L1.p, B1.p) annotation (Line(points={{-25.4,70},{-40,70}},
            color={0,0,255}));
      connect(L2_2.n, B3.p) annotation (Line(points={{35.4,50},{56,50},{56,70},{60,
              70}}, color={0,0,255}));
      connect(L2_1.n, B3.p) annotation (Line(points={{35.4,90},{56,90},{56,70},{60,
              70}}, color={0,0,255}));
      connect(L2_1.p, B2.p) annotation (Line(points={{24.6,90},{4,90},{4,70},{0,70}},
                           color={0,0,255}));
      connect(L2_2.p, B2.p) annotation (Line(points={{24.6,50},{4,50},{4,70},{0,70}},
            color={0,0,255}));
      connect(G2.conn, B5.p)
        annotation (Line(points={{60,-29},{60,-20}}, color={0,0,255}));
      connect(LD1.p, B2.p)
        annotation (Line(points={{-6,30},{-6,70},{0,70}},color={0,0,255}));
      connect(L3.p, B3.p) annotation (Line(points={{80,45.4},{80,70},{60,70}},
                                 color={0,0,255}));
      connect(breaker.s, B4.p)
        annotation (Line(points={{80,18},{80,10}},   color={0,0,255}));
      connect(breaker.r, L3.n)
        annotation (Line(points={{80,26},{80,34.6}},color={0,0,255}));
      connect(T2.n, B5.p)
        annotation (Line(points={{60,-12.6},{60,-20}}, color={0,0,255}));
      connect(load_variation.p, B4.p) annotation (Line(points={{100,-20},{100,-8},{
              80,-8},{80,10}},      color={0,0,255}));
      connect(softPMU.n, B4.p)
        annotation (Line(points={{43,10},{80,10}}, color={0,0,255}));
      connect(T2.p, softPMU.p) annotation (Line(points={{60,0.6},{40,0.6},{40,0},{
              20,0},{20,10},{29,10}}, color={0,0,255}));
      connect(VR.y,voltageSourceReImInput. vRe)
        annotation (Line(points={{109,100},{98,100}},  color={0,0,127}));
      connect(VI.y,voltageSourceReImInput. vIm) annotation (Line(points={{111,66},
              {106,66},{106,92},{98,92}},  color={0,0,127}));
      connect(voltageSourceReImInput.p, B3.p)
        annotation (Line(points={{75,96},{60,96},{60,70}}, color={0,0,255}));
      connect(IN11.y, AddU1.u2) annotation (Line(points={{-99,-50},{-90,-50},{-90,
              -36},{-82,-36}}, color={0,0,127}));
      connect(IN1, AddU1.u1) annotation (Line(points={{-160,0},{-92,0},{-92,-24},
              {-82,-24}}, color={0,0,127}));
      connect(AddU1.y, G2.P_ref) annotation (Line(points={{-59,-30},{44,-30},{44,
              -62},{60,-62},{60,-52}}, color={0,0,127}));
      annotation ( Diagram(coordinateSystem(preserveAspectRatio=false,
              extent={{-140,-120},{140,120}})),
        Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),
        experiment(StopTime=10, __Dymola_Algorithm="Dassl"));
    end Reconnection_Microgrid_PSSE_1_INPUT_WITH_CONST_V_SOURCE;

    package OBSERVABLE_CONTROLLABLE_STABLE

      model Reconnection_Microgrid_PSSE_1_INPUT_WITH_CONST_V_SOURCE2_NO_TG
        "THIS ONE IS STABLE, CONTROLLABLE, OBSERVABLE!!!!!!!"
        extends Modelica.Icons.Example;
        OpenIPSL.Electrical.Buses.Bus BG1(v_0=0.998855, angle_0=0.15699114448641)
          annotation (Placement(transformation(extent={{-90,60},{-70,80}})));
        OpenIPSL.Electrical.Buses.Bus B1(v_0=0.992504, angle_0=0.076251672237088)
          annotation (Placement(transformation(extent={{-50,60},{-30,80}})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
          R=0.001,
          X=0.2,
          G=0,
          B=0,
          VNOM1=220000,
          VB1=220000,
          VNOM2=24000,
          VB2=24000) annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=180,
              origin={-60,70})));
        OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
          v_0=0.998855,
          angle_0=0.15699114448641,
          P_0=40000000,
          Q_0=4547321,
          V_b=24000)
          annotation (Placement(transformation(extent={{-112,60},{-92,80}})));
        OpenIPSL.Electrical.Branches.PwLine L1(
          R=0.001,
          X=0.2,
          G=0,
          B=0) annotation (Placement(transformation(extent={{-26,66},{-14,74}})));
        OpenIPSL.Electrical.Buses.Bus B2(v_0=0.992681, angle_0=-0.0049879590159821)
          annotation (Placement(transformation(extent={{-10,60},{10,80}})));
        OpenIPSL.Electrical.Buses.Bus B3(v_0=0.998705, angle_0=
              9.4873305611609e-06)
          annotation (Placement(transformation(extent={{50,60},{70,80}})));
        OpenIPSL.Electrical.Branches.PwLine L2_1(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) annotation (Placement(transformation(extent={{24,86},{36,94}})));
        OpenIPSL.Electrical.Branches.PwLine L2_2(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) annotation (Placement(transformation(extent={{24,46},{36,54}})));
        OpenIPSL.Electrical.Buses.Bus B4(angle_0=-0.00014475935348966,
                                                                v_0=0.997342)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={80,10})));
        OpenIPSL.Electrical.Branches.PwLine L3(
          R=0.001,
          X=0.2,
          G=0,
          B=0) annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=-90,
              origin={80,40})));
        OpenIPSL.Electrical.Buses.Bus B5(v_0=1.0074, angle_0=0.0093371449790267)
                                         annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={60,-20})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
          G=0,
          B=0,
          VNOM1=220000,
          VB1=220000,
          VNOM2=24000,
          VB2=24000,
          R=0.005,
          X=0.1) annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=270,
              origin={60,-6})));
        OpenIPSL.Examples.ModelPredictiveControl.GenerationUnits.PSSE.G2_1INPUT_Pref_NO_TurbGov
          G2(
          v_0=1.0074,
          angle_0=0.0093371449790267,
          V_b=24000,
          P_0=10010220,
          Q_0=10204330) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={60,-40})));
        inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000,
                                                              fn=50)
          annotation (Placement(transformation(extent={{-140,100},{-80,120}})));
        OpenIPSL.Electrical.Loads.PSSE.Load LD1(
          V_b=220000,
          v_0=0.992681,
          angle_0=-0.0049879590159821,
          P_0=50000000,
          Q_0=10000000) annotation (Placement(transformation(extent={{-12,18},{0,30}})));
        Electrical.Events.Breaker breaker(enableTrigger=false, t_o=0.25)
                                                 annotation (Placement(transformation(
              extent={{-4,-4},{4,4}},
              rotation=90,
              origin={80,22})));

        Modelica.Blocks.Interfaces.RealInput IN1(start=0)
          "Connector of Real input signal 2" annotation (Placement(transformation(
              extent={{-20,-20},{20,20}},
              rotation=0,
              origin={-160,0})));
        Electrical.Loads.PSSE.Load_variation load_variation(
          V_b=220000,
          P_0=15000000,
          Q_0=10000000,
          v_0=0.997342,
          angle_0=-0.00014475935348966,
          d_P=0.05,
          t1=5,
          d_t=1)
          annotation (Placement(transformation(extent={{90,-40},{110,-20}})));
        Modelica.Blocks.Interfaces.RealOutput OUT1
          annotation (Placement(transformation(extent={{140,-70},{160,-50}})));
        Electrical.Sources.VoltageSourceReImInput voltageSourceReImInput
          annotation (Placement(transformation(
              extent={{-10,10},{10,-10}},
              rotation=180,
              origin={86,96})));
        Modelica.Blocks.Sources.Constant VR(k=0.998726)
          annotation (Placement(transformation(extent={{130,90},{110,110}})));
        Modelica.Blocks.Sources.Constant VI(k=3.7730e-5)
          annotation (Placement(transformation(extent={{132,56},{112,76}})));
        Modelica.Blocks.Sources.Constant IN11(k=0)
          annotation (Placement(transformation(extent={{-120,-46},{-100,-26}})));
        Modelica.Blocks.Math.Add AddU1
          annotation (Placement(transformation(extent={{-80,-40},{-60,-20}})));
        Modelica.Blocks.Interfaces.RealOutput OUT2
          annotation (Placement(transformation(extent={{140,-10},{160,10}})));
      equation
        OUT1 = G2.SPEED1;
        OUT2 = B4.v;

        connect(T1.p, B1.p)
          annotation (Line(points={{-53.4,70},{-40,70}},        color={0,0,255}));
        connect(BG1.p, T1.n)
          annotation (Line(points={{-80,70},{-66.6,70}},
                                                       color={0,0,255}));
        connect(G1.conn, BG1.p)
          annotation (Line(points={{-91,70},{-80,70}},          color={0,0,255}));
        connect(L1.n, B2.p)
          annotation (Line(points={{-14.6,70},{0,70}},            color={0,0,255}));
        connect(L1.p, B1.p) annotation (Line(points={{-25.4,70},{-40,70}},
              color={0,0,255}));
        connect(L2_2.n, B3.p) annotation (Line(points={{35.4,50},{56,50},{56,70},{60,
                70}}, color={0,0,255}));
        connect(L2_1.n, B3.p) annotation (Line(points={{35.4,90},{56,90},{56,70},{60,
                70}}, color={0,0,255}));
        connect(L2_1.p, B2.p) annotation (Line(points={{24.6,90},{4,90},{4,70},{0,70}},
                             color={0,0,255}));
        connect(L2_2.p, B2.p) annotation (Line(points={{24.6,50},{4,50},{4,70},{0,70}},
              color={0,0,255}));
        connect(G2.conn, B5.p)
          annotation (Line(points={{60,-29},{60,-20}}, color={0,0,255}));
        connect(LD1.p, B2.p)
          annotation (Line(points={{-6,30},{-6,70},{0,70}},color={0,0,255}));
        connect(L3.p, B3.p) annotation (Line(points={{80,45.4},{80,70},{60,70}},
                                   color={0,0,255}));
        connect(breaker.s, B4.p)
          annotation (Line(points={{80,18},{80,10}},   color={0,0,255}));
        connect(breaker.r, L3.n)
          annotation (Line(points={{80,26},{80,34.6}},color={0,0,255}));
        connect(T2.n, B5.p)
          annotation (Line(points={{60,-12.6},{60,-20}}, color={0,0,255}));
        connect(load_variation.p, B4.p) annotation (Line(points={{100,-20},{100,2},{80,
                2},{80,10}},          color={0,0,255}));
        connect(VR.y,voltageSourceReImInput. vRe)
          annotation (Line(points={{109,100},{98,100}},  color={0,0,127}));
        connect(VI.y,voltageSourceReImInput. vIm) annotation (Line(points={{111,66},{106,
                66},{106,92},{98,92}},       color={0,0,127}));
        connect(voltageSourceReImInput.p, B3.p)
          annotation (Line(points={{75,96},{60,96},{60,70}}, color={0,0,255}));
        connect(IN11.y, AddU1.u2) annotation (Line(points={{-99,-36},{-82,-36}},
                            color={0,0,127}));
        connect(IN1, AddU1.u1) annotation (Line(points={{-160,0},{-92,0},{-92,-24},{-82,
                -24}}, color={0,0,127}));
        connect(T2.p, B4.p) annotation (Line(points={{60,0.6},{60,2},{80,2},{80,10}},
                              color={0,0,255}));
        connect(AddU1.y, G2.P_ref) annotation (Line(points={{-59,-30},{-20,-30},{
                -20,-78},{60,-78},{60,-52}}, color={0,0,127}));
        annotation ( Diagram(coordinateSystem(preserveAspectRatio=false,
                extent={{-140,-120},{140,120}})),
          Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),experiment(StopTime=10, __Dymola_Algorithm="Dassl"));
      end Reconnection_Microgrid_PSSE_1_INPUT_WITH_CONST_V_SOURCE2_NO_TG;

      model Reconnection_Microgrid_PSSE_1_INPUT_WITH_CONST_V_SOURCE2
        "THIS ONE IS STABLE, CONTROLLABLE, OBSERVABLE!!!!!!!"
        extends Modelica.Icons.Example;
        OpenIPSL.Electrical.Buses.Bus BG1(v_0=0.998855, angle_0=0.15699114448641)
          annotation (Placement(transformation(extent={{-90,60},{-70,80}})));
        OpenIPSL.Electrical.Buses.Bus B1(v_0=0.992504, angle_0=0.076251672237088)
          annotation (Placement(transformation(extent={{-50,60},{-30,80}})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
          R=0.001,
          X=0.2,
          G=0,
          B=0,
          VNOM1=220000,
          VB1=220000,
          VNOM2=24000,
          VB2=24000) annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=180,
              origin={-60,70})));
        OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
          v_0=0.998855,
          angle_0=0.15699114448641,
          P_0=40000000,
          Q_0=4547321,
          V_b=24000)
          annotation (Placement(transformation(extent={{-112,60},{-92,80}})));
        OpenIPSL.Electrical.Branches.PwLine L1(
          R=0.001,
          X=0.2,
          G=0,
          B=0) annotation (Placement(transformation(extent={{-26,66},{-14,74}})));
        OpenIPSL.Electrical.Buses.Bus B2(v_0=0.992681, angle_0=-0.0049879590159821)
          annotation (Placement(transformation(extent={{-10,60},{10,80}})));
        OpenIPSL.Electrical.Buses.Bus B3(v_0=0.998705, angle_0=9.4873305611609e-06)
          annotation (Placement(transformation(extent={{50,60},{70,80}})));
        OpenIPSL.Electrical.Branches.PwLine L2_1(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) annotation (Placement(transformation(extent={{24,86},{36,94}})));
        OpenIPSL.Electrical.Branches.PwLine L2_2(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) annotation (Placement(transformation(extent={{24,46},{36,54}})));
        OpenIPSL.Electrical.Buses.Bus B4(angle_0=-0.00014475935348966,
                                                                v_0=0.997342)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={80,10})));
        OpenIPSL.Electrical.Branches.PwLine L3(
          R=0.001,
          X=0.2,
          G=0,
          B=0) annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=-90,
              origin={80,40})));
        OpenIPSL.Electrical.Buses.Bus B5(v_0=1.0074, angle_0=0.0093371449790267)
                                         annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={60,-20})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
          G=0,
          B=0,
          VNOM1=220000,
          VB1=220000,
          VNOM2=24000,
          VB2=24000,
          R=0.005,
          X=0.1) annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=270,
              origin={60,-6})));
        OpenIPSL.Examples.ModelPredictiveControl.GenerationUnits.PSSE.G2_1INPUT_Pref
          G2(
          v_0=1.0074,
          angle_0=0.0093371449790267,
          V_b=24000,
          P_0=10010220,
          Q_0=10204330) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={60,-40})));
        inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000,
                                                              fn=50)
          annotation (Placement(transformation(extent={{-140,100},{-80,120}})));
        OpenIPSL.Electrical.Loads.PSSE.Load LD1(
          V_b=220000,
          v_0=0.992681,
          angle_0=-0.0049879590159821,
          P_0=50000000,
          Q_0=10000000) annotation (Placement(transformation(extent={{-12,18},{0,30}})));
        Electrical.Events.Breaker breaker(enableTrigger=false, t_o=0.1)
                                                 annotation (Placement(transformation(
              extent={{-4,-4},{4,4}},
              rotation=90,
              origin={80,22})));

        Modelica.Blocks.Interfaces.RealInput IN1(start=0)
          "Connector of Real input signal 2" annotation (Placement(transformation(
              extent={{-20,-20},{20,20}},
              rotation=0,
              origin={-160,0})));
        Electrical.Loads.PSSE.Load_variation load_variation(
          V_b=220000,
          P_0=15000000,
          Q_0=15000000,
          v_0=0.997342,
          angle_0=-0.00014475935348966,
          d_P=0.1,
          t1=1000,
          d_t=2000)
          annotation (Placement(transformation(extent={{90,-40},{110,-20}})));
        Modelica.Blocks.Interfaces.RealOutput OUT1
          annotation (Placement(transformation(extent={{140,-70},{160,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT2
          annotation (Placement(transformation(extent={{140,50},{160,70}})));
        Electrical.Sources.VoltageSourceReImInput voltageSourceReImInput
          annotation (Placement(transformation(
              extent={{-10,10},{10,-10}},
              rotation=180,
              origin={86,96})));
        Modelica.Blocks.Sources.Constant VR(k=0.998726)
          annotation (Placement(transformation(extent={{130,90},{110,110}})));
        Modelica.Blocks.Sources.Constant VI(k=3.7730e-5)
          annotation (Placement(transformation(extent={{132,56},{112,76}})));
        Modelica.Blocks.Sources.Constant IN11(k=0)
          annotation (Placement(transformation(extent={{-120,-46},{-100,-26}})));
        Modelica.Blocks.Math.Add AddU1
          annotation (Placement(transformation(extent={{-80,-40},{-60,-20}})));
        OpenCPS.Controls.FREQ_CALC fREQ_CALC(
          T_w=2,
          T_f=1,
          fi_0=0.0093371449790267)
                  annotation (Placement(transformation(extent={{-20,-80},{0,-60}})));
        Modelica.Blocks.Sources.RealExpression realExpression(y=B5.angle)
          annotation (Placement(transformation(extent={{-50,-80},{-30,-60}})));
        Modelica.Blocks.Sources.Constant constant_freq(k=SysData.fn)
          annotation (Placement(transformation(extent={{-20,-110},{0,-90}})));
        Modelica.Blocks.Math.Add AddU2
          annotation (Placement(transformation(extent={{20,-94},{40,-74}})));
      equation
        OUT1 = AddU2.y;
        OUT2 = B4.v;

        connect(T1.p, B1.p)
          annotation (Line(points={{-53.4,70},{-40,70}},        color={0,0,255}));
        connect(BG1.p, T1.n)
          annotation (Line(points={{-80,70},{-66.6,70}},
                                                       color={0,0,255}));
        connect(G1.conn, BG1.p)
          annotation (Line(points={{-91,70},{-80,70}},          color={0,0,255}));
        connect(L1.n, B2.p)
          annotation (Line(points={{-14.6,70},{0,70}},            color={0,0,255}));
        connect(L1.p, B1.p) annotation (Line(points={{-25.4,70},{-40,70}},
              color={0,0,255}));
        connect(L2_2.n, B3.p) annotation (Line(points={{35.4,50},{56,50},{56,70},{60,
                70}}, color={0,0,255}));
        connect(L2_1.n, B3.p) annotation (Line(points={{35.4,90},{56,90},{56,70},{60,
                70}}, color={0,0,255}));
        connect(L2_1.p, B2.p) annotation (Line(points={{24.6,90},{4,90},{4,70},{0,70}},
                             color={0,0,255}));
        connect(L2_2.p, B2.p) annotation (Line(points={{24.6,50},{4,50},{4,70},{0,70}},
              color={0,0,255}));
        connect(G2.conn, B5.p)
          annotation (Line(points={{60,-29},{60,-20}}, color={0,0,255}));
        connect(LD1.p, B2.p)
          annotation (Line(points={{-6,30},{-6,70},{0,70}},color={0,0,255}));
        connect(L3.p, B3.p) annotation (Line(points={{80,45.4},{80,70},{60,70}},
                                   color={0,0,255}));
        connect(breaker.s, B4.p)
          annotation (Line(points={{80,18},{80,10}},   color={0,0,255}));
        connect(breaker.r, L3.n)
          annotation (Line(points={{80,26},{80,34.6}},color={0,0,255}));
        connect(T2.n, B5.p)
          annotation (Line(points={{60,-12.6},{60,-20}}, color={0,0,255}));
        connect(load_variation.p, B4.p) annotation (Line(points={{100,-20},{100,2},
                {80,2},{80,10}}, color={0,0,255}));
        connect(VR.y,voltageSourceReImInput. vRe)
          annotation (Line(points={{109,100},{98,100}},  color={0,0,127}));
        connect(VI.y,voltageSourceReImInput. vIm) annotation (Line(points={{111,66},{106,
                66},{106,92},{98,92}},       color={0,0,127}));
        connect(voltageSourceReImInput.p, B3.p)
          annotation (Line(points={{75,96},{60,96},{60,70}}, color={0,0,255}));
        connect(IN11.y, AddU1.u2) annotation (Line(points={{-99,-36},{-82,-36}},
                            color={0,0,127}));
        connect(IN1, AddU1.u1) annotation (Line(points={{-160,0},{-92,0},{-92,-24},{-82,
                -24}}, color={0,0,127}));
        connect(AddU1.y, G2.P_ref) annotation (Line(points={{-59,-30},{44,-30},{44,-62},
                {60,-62},{60,-52}}, color={0,0,127}));
        connect(T2.p, B4.p) annotation (Line(points={{60,0.6},{60,2},{80,2},{80,10}},
                              color={0,0,255}));
        connect(realExpression.y,fREQ_CALC. ANGLE)
          annotation (Line(points={{-29,-70},{-19,-70}}, color={0,0,127}));
        connect(constant_freq.y, AddU2.u2) annotation (Line(points={{1,-100},{10,-100},
                {10,-90},{18,-90}}, color={0,0,127}));
        connect(fREQ_CALC.d_FREQ, AddU2.u1) annotation (Line(points={{1,-66},{10,-66},
                {10,-78},{18,-78}}, color={0,0,127}));
        annotation ( Diagram(coordinateSystem(preserveAspectRatio=false,
                extent={{-140,-120},{140,120}})),
          Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),experiment(StopTime=10, __Dymola_Algorithm="Dassl"));
      end Reconnection_Microgrid_PSSE_1_INPUT_WITH_CONST_V_SOURCE2;

      model Reconnection_Microgrid_PSSE_1_INPUT_WITH_CONST_V_SOURCE2_WITH_TG
        "THIS ONE IS STABLE, CONTROLLABLE, OBSERVABLE!!!!!!!"
        extends Modelica.Icons.Example;
        OpenIPSL.Electrical.Buses.Bus BG1(v_0=0.998718, angle_0=0.15701226297036)
          annotation (Placement(transformation(extent={{-90,60},{-70,80}})));
        OpenIPSL.Electrical.Buses.Bus B1(v_0=0.99243, angle_0=0.076256751145211)
          annotation (Placement(transformation(extent={{-50,60},{-30,80}})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
          R=0.001,
          X=0.2,
          G=0,
          B=0,
          VNOM1=220000,
          VB1=220000,
          VNOM2=24000,
          VB2=24000) annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=180,
              origin={-60,70})));
        OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
          v_0=0.998855,
          angle_0=0.15699114448641,
          P_0=40000000,
          Q_0=4547321,
          V_b=24000)
          annotation (Placement(transformation(extent={{-112,60},{-92,80}})));
        OpenIPSL.Electrical.Branches.PwLine L1(
          R=0.001,
          X=0.2,
          G=0,
          B=0) annotation (Placement(transformation(extent={{-26,66},{-14,74}})));
        OpenIPSL.Electrical.Buses.Bus B2(v_0=0.992672, angle_0=-0.0049916242074113)
          annotation (Placement(transformation(extent={{-10,60},{10,80}})));
        OpenIPSL.Electrical.Buses.Bus B3(v_0=0.998726, angle_0=
              3.7778175258193e-05)
          annotation (Placement(transformation(extent={{50,60},{70,80}})));
        OpenIPSL.Electrical.Branches.PwLine L2_1(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) annotation (Placement(transformation(extent={{24,86},{36,94}})));
        OpenIPSL.Electrical.Branches.PwLine L2_2(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) annotation (Placement(transformation(extent={{24,46},{36,54}})));
        OpenIPSL.Electrical.Buses.Bus B4(angle_0=-0.010019446543509, v_0=0.998323)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={80,10})));
        OpenIPSL.Electrical.Branches.PwLine L3(
          R=0.001,
          X=0.2,
          G=0,
          B=0) annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=-90,
              origin={80,40})));
        OpenIPSL.Electrical.Buses.Bus B5(v_0=1.00875, angle_0=-0.00057912293509199)
                                         annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={60,-20})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
          G=0,
          B=0,
          VNOM1=220000,
          VB1=220000,
          VNOM2=24000,
          VB2=24000,
          R=0.005,
          X=0.1) annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=270,
              origin={60,-6})));
        OpenIPSL.Examples.ModelPredictiveControl.GenerationUnits.PSSE.G2_1INPUT_Pref_WITH_TurbGov
          G2(
          v_0=1.0074,
          angle_0=0.0093371449790267,
          V_b=24000,
          P_0=10010220,
          Q_0=10204330) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={60,-40})));
        inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000,
                                                              fn=50)
          annotation (Placement(transformation(extent={{-140,100},{-80,120}})));
        OpenIPSL.Electrical.Loads.PSSE.Load LD1(
          V_b=220000,
          v_0=0.992681,
          angle_0=-0.0049879590159821,
          P_0=50000000,
          Q_0=10000000) annotation (Placement(transformation(extent={{-12,18},{0,30}})));
        Electrical.Events.Breaker breaker(enableTrigger=false, t_o=5)
                                                 annotation (Placement(transformation(
              extent={{-4,-4},{4,4}},
              rotation=90,
              origin={80,22})));

        Modelica.Blocks.Interfaces.RealInput IN1(start=0)
          "Connector of Real input signal 2" annotation (Placement(transformation(
              extent={{-20,-20},{20,20}},
              rotation=0,
              origin={-160,0})));
        Electrical.Loads.PSSE.Load_variation load_variation(
          V_b=220000,
          P_0=15000000,
          Q_0=10000000,
          v_0=0.997342,
          angle_0=-0.00014475935348966,
          d_P=0.05,
          t1=10000,
          d_t=1000001)
          annotation (Placement(transformation(extent={{90,-40},{110,-20}})));
        Electrical.Sources.VoltageSourceReImInput voltageSourceReImInput
          annotation (Placement(transformation(
              extent={{-10,10},{10,-10}},
              rotation=180,
              origin={86,96})));
        Modelica.Blocks.Sources.Constant VR(k=0.999211)
          annotation (Placement(transformation(extent={{130,90},{110,110}})));
        Modelica.Blocks.Sources.Constant VI(k=-0.00980921)
          annotation (Placement(transformation(extent={{132,56},{112,76}})));
        Modelica.Blocks.Sources.Constant IN11(k=0)
          annotation (Placement(transformation(extent={{-120,-46},{-100,-26}})));
        Modelica.Blocks.Math.Add AddU1
          annotation (Placement(transformation(extent={{-80,-40},{-60,-20}})));
        Modelica.Blocks.Interfaces.RealOutput OUT1
          annotation (Placement(transformation(extent={{140,-50},{160,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT2
          annotation (Placement(transformation(extent={{140,-10},{160,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT3
          annotation (Placement(transformation(extent={{140,50},{160,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT4
          annotation (Placement(transformation(extent={{140,-90},{160,-70}})));
      equation
        OUT1 = G2.SPEED1;
        OUT2 = G2.PMECH1;
        OUT3 = B4.v;
        OUT4 = G2.TF2_out1;

        connect(T1.p, B1.p)
          annotation (Line(points={{-53.4,70},{-40,70}},        color={0,0,255}));
        connect(BG1.p, T1.n)
          annotation (Line(points={{-80,70},{-66.6,70}},
                                                       color={0,0,255}));
        connect(G1.conn, BG1.p)
          annotation (Line(points={{-91,70},{-80,70}},          color={0,0,255}));
        connect(L1.n, B2.p)
          annotation (Line(points={{-14.6,70},{0,70}},            color={0,0,255}));
        connect(L1.p, B1.p) annotation (Line(points={{-25.4,70},{-40,70}},
              color={0,0,255}));
        connect(L2_2.n, B3.p) annotation (Line(points={{35.4,50},{56,50},{56,70},{60,
                70}}, color={0,0,255}));
        connect(L2_1.n, B3.p) annotation (Line(points={{35.4,90},{56,90},{56,70},{60,
                70}}, color={0,0,255}));
        connect(L2_1.p, B2.p) annotation (Line(points={{24.6,90},{4,90},{4,70},{0,70}},
                             color={0,0,255}));
        connect(L2_2.p, B2.p) annotation (Line(points={{24.6,50},{4,50},{4,70},{0,70}},
              color={0,0,255}));
        connect(G2.conn, B5.p)
          annotation (Line(points={{60,-29},{60,-20}}, color={0,0,255}));
        connect(LD1.p, B2.p)
          annotation (Line(points={{-6,30},{-6,70},{0,70}},color={0,0,255}));
        connect(L3.p, B3.p) annotation (Line(points={{80,45.4},{80,70},{60,70}},
                                   color={0,0,255}));
        connect(breaker.s, B4.p)
          annotation (Line(points={{80,18},{80,10}},   color={0,0,255}));
        connect(breaker.r, L3.n)
          annotation (Line(points={{80,26},{80,34.6}},color={0,0,255}));
        connect(T2.n, B5.p)
          annotation (Line(points={{60,-12.6},{60,-20}}, color={0,0,255}));
        connect(load_variation.p, B4.p) annotation (Line(points={{100,-20},{100,2},{80,
                2},{80,10}},          color={0,0,255}));
        connect(VR.y,voltageSourceReImInput. vRe)
          annotation (Line(points={{109,100},{98,100}},  color={0,0,127}));
        connect(VI.y,voltageSourceReImInput. vIm) annotation (Line(points={{111,66},{106,
                66},{106,92},{98,92}},       color={0,0,127}));
        connect(voltageSourceReImInput.p, B3.p)
          annotation (Line(points={{75,96},{60,96},{60,70}}, color={0,0,255}));
        connect(IN11.y, AddU1.u2) annotation (Line(points={{-99,-36},{-82,-36}},
                            color={0,0,127}));
        connect(IN1, AddU1.u1) annotation (Line(points={{-160,0},{-92,0},{-92,-24},{-82,
                -24}}, color={0,0,127}));
        connect(T2.p, B4.p) annotation (Line(points={{60,0.6},{60,2},{80,2},{80,10}},
                              color={0,0,255}));
        connect(AddU1.y, G2.P_ref) annotation (Line(points={{-59,-30},{-20,-30},{
                -20,-78},{60,-78},{60,-52}}, color={0,0,127}));
        annotation ( Diagram(coordinateSystem(preserveAspectRatio=false,
                extent={{-140,-120},{140,120}})),
          Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),experiment(
            StopTime=10,
            Tolerance=1e-09,
            __Dymola_Algorithm="Dassl"));
      end Reconnection_Microgrid_PSSE_1_INPUT_WITH_CONST_V_SOURCE2_WITH_TG;

      model Reconnection_Microgrid_PSSE_1_INPUT_WITH_INF_WITH_TG
        "THIS ONE IS STABLE, CONTROLLABLE, OBSERVABLE!!!!!!!"
        extends Modelica.Icons.Example;
        OpenIPSL.Electrical.Buses.Bus BG1(v_0=0.997684, angle_0=0.14741399928195)
          annotation (Placement(transformation(extent={{-90,60},{-70,80}})));
        OpenIPSL.Electrical.Buses.Bus B1(v_0=0.991863, angle_0=0.066525318834866)
          annotation (Placement(transformation(extent={{-50,60},{-30,80}})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
          R=0.001,
          X=0.2,
          G=0,
          B=0,
          VNOM1=220000,
          VB1=220000,
          VNOM2=24000,
          VB2=24000) annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=180,
              origin={-60,70})));
        OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
          v_0=0.997684, angle_0=0.14741399928195,
          P_0=40000000,
          Q_0=4547321,
          V_b=24000)
          annotation (Placement(transformation(extent={{-112,60},{-92,80}})));
        OpenIPSL.Electrical.Branches.PwLine L1(
          R=0.001,
          X=0.2,
          G=0,
          B=0) annotation (Placement(transformation(extent={{-26,66},{-14,74}})));
        OpenIPSL.Electrical.Buses.Bus B2(v_0=0.992584, angle_0=-0.014780076424419)
          annotation (Placement(transformation(extent={{-10,60},{10,80}})));
        OpenIPSL.Electrical.Buses.Bus B3(v_0=0.998758, angle_0=-0.0097534060056274)
          annotation (Placement(transformation(extent={{50,60},{70,80}})));
        OpenIPSL.Electrical.Branches.PwLine L2_1(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) annotation (Placement(transformation(extent={{24,86},{36,94}})));
        OpenIPSL.Electrical.Branches.PwLine L2_2(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) annotation (Placement(transformation(extent={{24,46},{36,54}})));
        OpenIPSL.Electrical.Buses.Bus B4(angle_0=-0.01980931247721, v_0=0.998291)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={80,10})));
        OpenIPSL.Electrical.Branches.PwLine L3(
          R=0.001,
          X=0.2,
          G=0,
          B=0) annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=-90,
              origin={80,40})));
        OpenIPSL.Electrical.Buses.Bus B5(v_0=1.00869, angle_0=-0.01036638309222)
                                         annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={60,-18})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
          G=0,
          B=0,
          VNOM1=220000,
          VB1=220000,
          VNOM2=24000,
          VB2=24000,
          R=0.005,
          X=0.1) annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=270,
              origin={60,-6})));
        OpenIPSL.Examples.ModelPredictiveControl.GenerationUnits.PSSE.G2_1INPUT_Pref_WITH_TurbGov
          G2(
          v_0=1.00869,
          angle_0=-0.01036638309222,
          V_b=24000,
          P_0=10010220,
          Q_0=10204330) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={60,-40})));
        inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000,
                                                              fn=50)
          annotation (Placement(transformation(extent={{-140,100},{-80,120}})));
        OpenIPSL.Electrical.Loads.PSSE.Load LD1(
          V_b=220000,
          v_0=0.992681,
          angle_0=-0.0049879590159821,
          P_0=50000000,
          Q_0=10000000) annotation (Placement(transformation(extent={{-12,18},{0,30}})));
        Electrical.Events.Breaker breaker(enableTrigger=false, t_o=0.25)
                                                 annotation (Placement(transformation(
              extent={{-4,-4},{4,4}},
              rotation=90,
              origin={80,22})));

        Modelica.Blocks.Interfaces.RealInput IN1(start=0)
          "Connector of Real input signal 2" annotation (Placement(transformation(
              extent={{-20,-20},{20,20}},
              rotation=0,
              origin={-160,0})));
        Electrical.Loads.PSSE.Load_variation load_variation(
          V_b=220000,
          P_0=15000000,
          Q_0=10000000,
          v_0=0.997342,
          angle_0=-0.00014475935348966,
          d_P=0.05,
          t1=10000,
          d_t=1000001)
          annotation (Placement(transformation(extent={{90,-40},{110,-20}})));
        Modelica.Blocks.Sources.Constant IN11(k=0)
          annotation (Placement(transformation(extent={{-120,-46},{-100,-26}})));
        Modelica.Blocks.Math.Add AddU1
          annotation (Placement(transformation(extent={{-80,-40},{-60,-20}})));
        Modelica.Blocks.Interfaces.RealOutput OUT1
          annotation (Placement(transformation(extent={{140,-50},{160,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT2
          annotation (Placement(transformation(extent={{140,-10},{160,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT3
          annotation (Placement(transformation(extent={{140,50},{160,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT4
          annotation (Placement(transformation(extent={{140,-90},{160,-70}})));
        Electrical.Machines.PSSE.GENCLS          IB(
          V_b=220000,
          v_0=0.998758,
          angle_0=-0.0097534060056274,
          P_0=15042100,
          Q_0=12541100,
          M_b=100000000,
          X_d=0.2) annotation (Placement(transformation(extent={{104,60},{94,80}})));
      equation
        OUT1 = G2.SPEED1;
        OUT2 = G2.PMECH1;
        OUT3 = B4.v;
        OUT4 = G2.TF2_out1;

        connect(T1.p, B1.p)
          annotation (Line(points={{-53.4,70},{-40,70}},        color={0,0,255}));
        connect(BG1.p, T1.n)
          annotation (Line(points={{-80,70},{-66.6,70}},
                                                       color={0,0,255}));
        connect(G1.conn, BG1.p)
          annotation (Line(points={{-91,70},{-80,70}},          color={0,0,255}));
        connect(L1.n, B2.p)
          annotation (Line(points={{-14.6,70},{0,70}},            color={0,0,255}));
        connect(L1.p, B1.p) annotation (Line(points={{-25.4,70},{-40,70}},
              color={0,0,255}));
        connect(L2_2.n, B3.p) annotation (Line(points={{35.4,50},{56,50},{56,70},{60,
                70}}, color={0,0,255}));
        connect(L2_1.n, B3.p) annotation (Line(points={{35.4,90},{56,90},{56,70},{60,
                70}}, color={0,0,255}));
        connect(L2_1.p, B2.p) annotation (Line(points={{24.6,90},{4,90},{4,70},{0,70}},
                             color={0,0,255}));
        connect(L2_2.p, B2.p) annotation (Line(points={{24.6,50},{4,50},{4,70},{0,70}},
              color={0,0,255}));
        connect(G2.conn, B5.p)
          annotation (Line(points={{60,-29},{60,-18}}, color={0,0,255}));
        connect(LD1.p, B2.p)
          annotation (Line(points={{-6,30},{-6,70},{0,70}},color={0,0,255}));
        connect(L3.p, B3.p) annotation (Line(points={{80,45.4},{80,70},{60,70}},
                                   color={0,0,255}));
        connect(breaker.s, B4.p)
          annotation (Line(points={{80,18},{80,10}},   color={0,0,255}));
        connect(breaker.r, L3.n)
          annotation (Line(points={{80,26},{80,34.6}},color={0,0,255}));
        connect(T2.n, B5.p)
          annotation (Line(points={{60,-12.6},{60,-18}}, color={0,0,255}));
        connect(load_variation.p, B4.p) annotation (Line(points={{100,-20},{100,2},{80,
                2},{80,10}},          color={0,0,255}));
        connect(IN11.y, AddU1.u2) annotation (Line(points={{-99,-36},{-82,-36}},
                            color={0,0,127}));
        connect(IN1, AddU1.u1) annotation (Line(points={{-160,0},{-92,0},{-92,-24},{-82,
                -24}}, color={0,0,127}));
        connect(T2.p, B4.p) annotation (Line(points={{60,0.6},{60,2},{80,2},{80,10}},
                              color={0,0,255}));
        connect(AddU1.y, G2.P_ref) annotation (Line(points={{-59,-30},{-20,-30},{
                -20,-78},{60,-78},{60,-52}}, color={0,0,127}));
        connect(IB.p, B3.p)
          annotation (Line(points={{94,70},{60,70}}, color={0,0,255}));
        annotation ( Diagram(coordinateSystem(preserveAspectRatio=false,
                extent={{-140,-120},{140,120}})),
          Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),experiment(StopTime=10, __Dymola_Algorithm="Dassl"));
      end Reconnection_Microgrid_PSSE_1_INPUT_WITH_INF_WITH_TG;

      model Reconnection_Microgrid_PSSE_2_INPUT_WITH_CONST_V_SOURCE2
        "THIS ONE IS STABLE, CONTROLLABLE, OBSERVABLE!!!!!!!"
        extends Modelica.Icons.Example;
        OpenIPSL.Electrical.Buses.Bus BG1(v_0=0.998718, angle_0=0.15701226297036)
          annotation (Placement(transformation(extent={{-90,60},{-70,80}})));
        OpenIPSL.Electrical.Buses.Bus B1(v_0=0.99243, angle_0=0.076256751145211)
          annotation (Placement(transformation(extent={{-50,60},{-30,80}})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
          R=0.001,
          X=0.2,
          G=0,
          B=0,
          VNOM1=220000,
          VB1=220000,
          VNOM2=24000,
          VB2=24000) annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=180,
              origin={-60,70})));
        OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
          v_0=0.998855,
          angle_0=0.15699114448641,
          P_0=40000000,
          Q_0=4547321,
          V_b=24000)
          annotation (Placement(transformation(extent={{-112,60},{-92,80}})));
        OpenIPSL.Electrical.Branches.PwLine L1(
          R=0.001,
          X=0.2,
          G=0,
          B=0) annotation (Placement(transformation(extent={{-26,66},{-14,74}})));
        OpenIPSL.Electrical.Buses.Bus B2(v_0=0.992672, angle_0=-0.0049916242074113)
          annotation (Placement(transformation(extent={{-10,60},{10,80}})));
        OpenIPSL.Electrical.Buses.Bus B3(v_0=0.998726, angle_0=
              3.7778175258193e-05)
          annotation (Placement(transformation(extent={{50,60},{70,80}})));
        OpenIPSL.Electrical.Branches.PwLine L2_1(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) annotation (Placement(transformation(extent={{24,86},{36,94}})));
        OpenIPSL.Electrical.Branches.PwLine L2_2(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) annotation (Placement(transformation(extent={{24,46},{36,54}})));
        OpenIPSL.Electrical.Buses.Bus B4(angle_0=-0.010019446543509, v_0=0.998323)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={80,10})));
        OpenIPSL.Electrical.Branches.PwLine L3(
          R=0.001,
          X=0.2,
          G=0,
          B=0) annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=-90,
              origin={80,40})));
        OpenIPSL.Electrical.Buses.Bus B5(v_0=1.00875, angle_0=-0.00057912293509199)
                                         annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={60,-20})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
          G=0,
          B=0,
          VNOM1=220000,
          VB1=220000,
          VNOM2=24000,
          VB2=24000,
          R=0.005,
          X=0.1) annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=270,
              origin={60,-6})));
        OpenIPSL.Examples.ModelPredictiveControl.GenerationUnits.PSSE.G2_2INPUTS
          G2(
          v_0=1.0074,
          angle_0=0.0093371449790267,
          V_b=24000,
          P_0=10010220,
          Q_0=10204330) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={60,-40})));
        inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000,
                                                              fn=50)
          annotation (Placement(transformation(extent={{-140,100},{-80,120}})));
        OpenIPSL.Electrical.Loads.PSSE.Load LD1(
          V_b=220000,
          v_0=0.992681,
          angle_0=-0.0049879590159821,
          P_0=50000000,
          Q_0=10000000) annotation (Placement(transformation(extent={{-12,18},{0,30}})));
        Electrical.Events.Breaker breaker(enableTrigger=false, t_o=0.1)
                                                 annotation (Placement(transformation(
              extent={{-4,-4},{4,4}},
              rotation=90,
              origin={80,22})));

        Modelica.Blocks.Interfaces.RealInput IN1(start=0)
          "Connector of Real input signal 2" annotation (Placement(transformation(
              extent={{-20,-20},{20,20}},
              rotation=0,
              origin={-160,0})));
        Electrical.Loads.PSSE.Load_variation load_variation(
          V_b=220000,
          P_0=15000000,
          Q_0=10000000,
          v_0=0.997342,
          angle_0=-0.00014475935348966,
          d_P=0.05,
          t1=10000,
          d_t=1000001)
          annotation (Placement(transformation(extent={{90,-40},{110,-20}})));
        Electrical.Sources.VoltageSourceReImInput voltageSourceReImInput
          annotation (Placement(transformation(
              extent={{-10,10},{10,-10}},
              rotation=180,
              origin={86,96})));
        Modelica.Blocks.Sources.Constant VR(k=0.999211)
          annotation (Placement(transformation(extent={{130,90},{110,110}})));
        Modelica.Blocks.Sources.Constant VI(k=-0.00980921)
          annotation (Placement(transformation(extent={{132,56},{112,76}})));
        Modelica.Blocks.Sources.Constant IN11(k=0)
          annotation (Placement(transformation(extent={{-120,-46},{-100,-26}})));
        Modelica.Blocks.Math.Add AddU1
          annotation (Placement(transformation(extent={{-80,-40},{-60,-20}})));
            Modelica.Blocks.Sources.Constant IN22(k=0)
          annotation (Placement(transformation(extent={{-120,-100},{-100,-80}})));
        Modelica.Blocks.Math.Add AddU2
          annotation (Placement(transformation(extent={{-80,-94},{-60,-74}})));
        Modelica.Blocks.Interfaces.RealInput IN2(start=0)
          "Connector of Real input signal 2" annotation (Placement(transformation(
              extent={{-20,-20},{20,20}},
              rotation=0,
              origin={-160,-54})));
        Modelica.Blocks.Interfaces.RealOutput OUT1
          annotation (Placement(transformation(extent={{140,-50},{160,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT2
          annotation (Placement(transformation(extent={{140,-10},{160,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT3
          annotation (Placement(transformation(extent={{140,50},{160,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT4
          annotation (Placement(transformation(extent={{140,-90},{160,-70}})));
           Modelica.Blocks.Interfaces.RealOutput OUT5
          annotation (Placement(transformation(extent={{124,-142},{144,-122}})));
           Modelica.Blocks.Interfaces.RealOutput OUT6
          annotation (Placement(transformation(extent={{140,-120},{160,-100}})));
               Modelica.Blocks.Interfaces.RealOutput OUT7
          annotation (Placement(transformation(extent={{124,-142},{144,-122}})));
           Modelica.Blocks.Interfaces.RealOutput OUT8
          annotation (Placement(transformation(extent={{140,-120},{160,-100}})));
               Modelica.Blocks.Interfaces.RealOutput OUT9
          annotation (Placement(transformation(extent={{124,-142},{144,-122}})));
           Modelica.Blocks.Interfaces.RealOutput OUT10
          annotation (Placement(transformation(extent={{140,-120},{160,-100}})));
           Modelica.Blocks.Interfaces.RealOutput OUT11
          annotation (Placement(transformation(extent={{140,-120},{160,-100}})));

      equation
        OUT1 = G2.SPEED1;
        OUT2 = G2.PMECH1;
        OUT3 = G2.gen.ANGLE;
        OUT4 = G2.TF2_out1;
        OUT5 = B3.angle;
        OUT6 = B3.v;
        OUT7 = B4.angle;
        OUT8 = B4.v;
        OUT9 = B4.p.vr;
        OUT10 = B4.p.vi;
        OUT11 = G2.gen.PELEC;

        connect(T1.p, B1.p)
          annotation (Line(points={{-53.4,70},{-40,70}},        color={0,0,255}));
        connect(BG1.p, T1.n)
          annotation (Line(points={{-80,70},{-66.6,70}},
                                                       color={0,0,255}));
        connect(G1.conn, BG1.p)
          annotation (Line(points={{-91,70},{-80,70}},          color={0,0,255}));
        connect(L1.n, B2.p)
          annotation (Line(points={{-14.6,70},{0,70}},            color={0,0,255}));
        connect(L1.p, B1.p) annotation (Line(points={{-25.4,70},{-40,70}},
              color={0,0,255}));
        connect(L2_2.n, B3.p) annotation (Line(points={{35.4,50},{56,50},{56,70},{60,
                70}}, color={0,0,255}));
        connect(L2_1.n, B3.p) annotation (Line(points={{35.4,90},{56,90},{56,70},{60,
                70}}, color={0,0,255}));
        connect(L2_1.p, B2.p) annotation (Line(points={{24.6,90},{4,90},{4,70},{0,70}},
                             color={0,0,255}));
        connect(L2_2.p, B2.p) annotation (Line(points={{24.6,50},{4,50},{4,70},{0,70}},
              color={0,0,255}));
        connect(G2.conn, B5.p)
          annotation (Line(points={{60,-29},{60,-20}}, color={0,0,255}));
        connect(LD1.p, B2.p)
          annotation (Line(points={{-6,30},{-6,70},{0,70}},color={0,0,255}));
        connect(L3.p, B3.p) annotation (Line(points={{80,45.4},{80,70},{60,70}},
                                   color={0,0,255}));
        connect(breaker.s, B4.p)
          annotation (Line(points={{80,18},{80,10}},   color={0,0,255}));
        connect(breaker.r, L3.n)
          annotation (Line(points={{80,26},{80,34.6}},color={0,0,255}));
        connect(T2.n, B5.p)
          annotation (Line(points={{60,-12.6},{60,-20}}, color={0,0,255}));
        connect(load_variation.p, B4.p) annotation (Line(points={{100,-20},{100,2},{80,
                2},{80,10}},          color={0,0,255}));
        connect(VR.y,voltageSourceReImInput. vRe)
          annotation (Line(points={{109,100},{98,100}},  color={0,0,127}));
        connect(VI.y,voltageSourceReImInput. vIm) annotation (Line(points={{111,66},{106,
                66},{106,92},{98,92}},       color={0,0,127}));
        connect(voltageSourceReImInput.p, B3.p)
          annotation (Line(points={{75,96},{60,96},{60,70}}, color={0,0,255}));
        connect(IN11.y, AddU1.u2) annotation (Line(points={{-99,-36},{-82,-36}},
                            color={0,0,127}));
        connect(IN1, AddU1.u1) annotation (Line(points={{-160,0},{-92,0},{-92,-24},{-82,
                -24}}, color={0,0,127}));
        connect(T2.p, B4.p) annotation (Line(points={{60,0.6},{60,2},{80,2},{80,10}},
                              color={0,0,255}));
        connect(AddU1.y, G2.P_ref) annotation (Line(points={{-59,-30},{-20,-30},{-20,-78},
                {56,-78},{56,-52}},          color={0,0,127}));
        connect(IN22.y, AddU2.u2)
          annotation (Line(points={{-99,-90},{-82,-90}}, color={0,0,127}));
        connect(IN2,AddU2. u1) annotation (Line(points={{-160,-54},{-90,-54},{-90,-78},
                {-82,-78}},
                       color={0,0,127}));
        connect(AddU2.y, G2.Efd_ref)
          annotation (Line(points={{-59,-84},{62,-84},{62,-52}}, color={0,0,127}));

        annotation ( Diagram(coordinateSystem(preserveAspectRatio=false,
                extent={{-140,-120},{140,120}})),
          Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),experiment(
            StopTime=10,
            Tolerance=1e-09,
            __Dymola_Algorithm="Dassl"));
      end Reconnection_Microgrid_PSSE_2_INPUT_WITH_CONST_V_SOURCE2;

      model Reconnection_Microgrid_PSSE_2_INPUT_WITH_CONST_V_SOURCE2_V2
        "THIS ONE IS STABLE, CONTROLLABLE, OBSERVABLE!!!!!!!"
        extends Modelica.Icons.Example;
        OpenIPSL.Electrical.Buses.Bus BG1(v_0=0.998718, angle_0=0.15701226297036)
          annotation (Placement(transformation(extent={{-90,60},{-70,80}})));
        OpenIPSL.Electrical.Buses.Bus B1(v_0=0.99243, angle_0=0.076256751145211)
          annotation (Placement(transformation(extent={{-50,60},{-30,80}})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
          R=0.001,
          X=0.2,
          G=0,
          B=0,
          VNOM1=220000,
          VB1=220000,
          VNOM2=24000,
          VB2=24000) annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=180,
              origin={-60,70})));
        OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
          v_0=0.998855,
          angle_0=0.15699114448641,
          P_0=40000000,
          Q_0=4547321,
          V_b=24000)
          annotation (Placement(transformation(extent={{-112,60},{-92,80}})));
        OpenIPSL.Electrical.Branches.PwLine L1(
          R=0.001,
          X=0.2,
          G=0,
          B=0) annotation (Placement(transformation(extent={{-26,66},{-14,74}})));
        OpenIPSL.Electrical.Buses.Bus B2(v_0=0.992672, angle_0=-0.0049916242074113)
          annotation (Placement(transformation(extent={{-10,60},{10,80}})));
        OpenIPSL.Electrical.Buses.Bus B3(v_0=0.998726, angle_0=3.7778175258193e-05)
          annotation (Placement(transformation(extent={{50,60},{70,80}})));
        OpenIPSL.Electrical.Branches.PwLine L2_1(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) annotation (Placement(transformation(extent={{24,86},{36,94}})));
        OpenIPSL.Electrical.Branches.PwLine L2_2(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) annotation (Placement(transformation(extent={{24,46},{36,54}})));
        OpenIPSL.Electrical.Buses.Bus B4(angle_0=-0.010019446543509, v_0=0.998323)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={80,10})));
        OpenIPSL.Electrical.Branches.PwLine L3(
          R=0.001,
          X=0.2,
          G=0,
          B=0) annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=-90,
              origin={80,40})));
        OpenIPSL.Electrical.Buses.Bus B5(v_0=1.00875, angle_0=-0.00057912293509199)
                                         annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={60,-20})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
          G=0,
          B=0,
          VNOM1=220000,
          VB1=220000,
          VNOM2=24000,
          VB2=24000,
          R=0.005,
          X=0.1) annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=270,
              origin={60,-6})));
        OpenIPSL.Examples.ModelPredictiveControl.GenerationUnits.PSSE.G2_2INPUTS
          G2(
          v_0=1.0074,
          angle_0=0.0093371449790267,
          V_b=24000,
          P_0=10010220,
          Q_0=10204330) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={60,-40})));
        inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000,
                                                              fn=50)
          annotation (Placement(transformation(extent={{-140,100},{-80,120}})));
        OpenIPSL.Electrical.Loads.PSSE.Load LD1(
          V_b=220000,
          v_0=0.992681,
          angle_0=-0.0049879590159821,
          P_0=50000000,
          Q_0=10000000) annotation (Placement(transformation(extent={{-12,18},{0,30}})));
        Electrical.Events.Breaker breaker(enableTrigger=false, t_o=0.1)
                                                 annotation (Placement(transformation(
              extent={{-4,-4},{4,4}},
              rotation=90,
              origin={80,22})));

        Modelica.Blocks.Interfaces.RealInput IN1(start=0)
          "Connector of Real input signal 2" annotation (Placement(transformation(
              extent={{-20,-20},{20,20}},
              rotation=0,
              origin={-160,0})));
        Electrical.Loads.PSSE.Load_variation load_variation(
          V_b=220000,
          P_0=15000000,
          Q_0=10000000,
          v_0=0.997342,
          angle_0=-0.00014475935348966,
          d_P=0.05,
          t1=10000,
          d_t=1000001)
          annotation (Placement(transformation(extent={{90,-40},{110,-20}})));
        Electrical.Sources.VoltageSourceReImInput voltageSourceReImInput
          annotation (Placement(transformation(
              extent={{-10,10},{10,-10}},
              rotation=180,
              origin={86,96})));
        Modelica.Blocks.Sources.Constant VR(k=0.999211)
          annotation (Placement(transformation(extent={{130,90},{110,110}})));
        Modelica.Blocks.Sources.Constant VI(k=-0.00980921)
          annotation (Placement(transformation(extent={{132,56},{112,76}})));
        Modelica.Blocks.Sources.Constant IN11(k=0)
          annotation (Placement(transformation(extent={{-120,-46},{-100,-26}})));
        Modelica.Blocks.Math.Add AddU1
          annotation (Placement(transformation(extent={{-80,-40},{-60,-20}})));
            Modelica.Blocks.Sources.Constant IN22(k=0)
          annotation (Placement(transformation(extent={{-120,-100},{-100,-80}})));
        Modelica.Blocks.Math.Add AddU2
          annotation (Placement(transformation(extent={{-80,-94},{-60,-74}})));
        Modelica.Blocks.Interfaces.RealInput IN2(start=0)
          "Connector of Real input signal 2" annotation (Placement(transformation(
              extent={{-20,-20},{20,20}},
              rotation=0,
              origin={-160,-54})));
        Modelica.Blocks.Interfaces.RealOutput OUT1
          annotation (Placement(transformation(extent={{140,-50},{160,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT2
          annotation (Placement(transformation(extent={{140,-10},{160,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT3
          annotation (Placement(transformation(extent={{140,50},{160,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT4
          annotation (Placement(transformation(extent={{140,-90},{160,-70}})));
           Modelica.Blocks.Interfaces.RealOutput OUT5
          annotation (Placement(transformation(extent={{124,-142},{144,-122}})));
           Modelica.Blocks.Interfaces.RealOutput OUT6
          annotation (Placement(transformation(extent={{140,-120},{160,-100}})));
               Modelica.Blocks.Interfaces.RealOutput OUT7
          annotation (Placement(transformation(extent={{124,-142},{144,-122}})));
           Modelica.Blocks.Interfaces.RealOutput OUT8
          annotation (Placement(transformation(extent={{140,-120},{160,-100}})));
          Modelica.Blocks.Interfaces.RealOutput OUT9
          annotation (Placement(transformation(extent={{140,-120},{160,-100}})));

      equation
        OUT1 = G2.SPEED1;
        OUT2 = G2.PMECH1;
        OUT3 = B4.v;
        OUT4 = G2.TF2_out1;
        OUT5 = B3.p.vr;
        OUT6 = B3.p.vi;
        OUT7 = B4.p.vr;
        OUT8 = B4.p.vi;
        OUT9 = G2.gen.delta;

        connect(T1.p, B1.p)
          annotation (Line(points={{-53.4,70},{-40,70}},        color={0,0,255}));
        connect(BG1.p, T1.n)
          annotation (Line(points={{-80,70},{-66.6,70}},
                                                       color={0,0,255}));
        connect(G1.conn, BG1.p)
          annotation (Line(points={{-91,70},{-80,70}},          color={0,0,255}));
        connect(L1.n, B2.p)
          annotation (Line(points={{-14.6,70},{0,70}},            color={0,0,255}));
        connect(L1.p, B1.p) annotation (Line(points={{-25.4,70},{-40,70}},
              color={0,0,255}));
        connect(L2_2.n, B3.p) annotation (Line(points={{35.4,50},{56,50},{56,70},{60,
                70}}, color={0,0,255}));
        connect(L2_1.n, B3.p) annotation (Line(points={{35.4,90},{56,90},{56,70},{60,
                70}}, color={0,0,255}));
        connect(L2_1.p, B2.p) annotation (Line(points={{24.6,90},{4,90},{4,70},{0,70}},
                             color={0,0,255}));
        connect(L2_2.p, B2.p) annotation (Line(points={{24.6,50},{4,50},{4,70},{0,70}},
              color={0,0,255}));
        connect(G2.conn, B5.p)
          annotation (Line(points={{60,-29},{60,-20}}, color={0,0,255}));
        connect(LD1.p, B2.p)
          annotation (Line(points={{-6,30},{-6,70},{0,70}},color={0,0,255}));
        connect(L3.p, B3.p) annotation (Line(points={{80,45.4},{80,70},{60,70}},
                                   color={0,0,255}));
        connect(breaker.s, B4.p)
          annotation (Line(points={{80,18},{80,10}},   color={0,0,255}));
        connect(breaker.r, L3.n)
          annotation (Line(points={{80,26},{80,34.6}},color={0,0,255}));
        connect(T2.n, B5.p)
          annotation (Line(points={{60,-12.6},{60,-20}}, color={0,0,255}));
        connect(load_variation.p, B4.p) annotation (Line(points={{100,-20},{100,2},{80,
                2},{80,10}},          color={0,0,255}));
        connect(VR.y,voltageSourceReImInput. vRe)
          annotation (Line(points={{109,100},{98,100}},  color={0,0,127}));
        connect(VI.y,voltageSourceReImInput. vIm) annotation (Line(points={{111,66},{106,
                66},{106,92},{98,92}},       color={0,0,127}));
        connect(voltageSourceReImInput.p, B3.p)
          annotation (Line(points={{75,96},{60,96},{60,70}}, color={0,0,255}));
        connect(IN11.y, AddU1.u2) annotation (Line(points={{-99,-36},{-82,-36}},
                            color={0,0,127}));
        connect(IN1, AddU1.u1) annotation (Line(points={{-160,0},{-92,0},{-92,-24},{-82,
                -24}}, color={0,0,127}));
        connect(T2.p, B4.p) annotation (Line(points={{60,0.6},{60,2},{80,2},{80,10}},
                              color={0,0,255}));
        connect(AddU1.y, G2.P_ref) annotation (Line(points={{-59,-30},{-20,-30},{-20,-78},
                {56,-78},{56,-52}},          color={0,0,127}));
        connect(IN22.y, AddU2.u2)
          annotation (Line(points={{-99,-90},{-82,-90}}, color={0,0,127}));
        connect(IN2,AddU2. u1) annotation (Line(points={{-160,-54},{-90,-54},{-90,-78},
                {-82,-78}},
                       color={0,0,127}));
        connect(AddU2.y, G2.Efd_ref)
          annotation (Line(points={{-59,-84},{62,-84},{62,-52}}, color={0,0,127}));

        annotation ( Diagram(coordinateSystem(preserveAspectRatio=false,
                extent={{-140,-120},{140,120}})),
          Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),experiment(
            StopTime=10,
            Tolerance=1e-09,
            __Dymola_Algorithm="Dassl"));
      end Reconnection_Microgrid_PSSE_2_INPUT_WITH_CONST_V_SOURCE2_V2;

      model Reconnection_Microgrid_PSSE_3_INPUT_WITH_CONST_V_SOURCE3
        "THIS ONE IS STABLE, CONTROLLABLE, OBSERVABLE!!!!!!!"
        extends Modelica.Icons.Example;
        OpenIPSL.Electrical.Buses.Bus B1(v_0=powerFlow.powerflow.bus.V1, angle_0=
              powerFlow.powerflow.bus.A1)
          annotation (Placement(transformation(extent={{-90,60},{-70,80}})));
        OpenIPSL.Electrical.Buses.Bus B2(v_0=powerFlow.powerflow.bus.V2, angle_0=
              powerFlow.powerflow.bus.A1)
          annotation (Placement(transformation(extent={{-50,60},{-30,80}})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
          R=0.001,
          X=0.2,
          G=0,
          B=0,
          VNOM1=220000,
          VB1=220000,
          VNOM2=24000,
          VB2=24000) annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=180,
              origin={-60,70})));
        OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
          v_0=powerFlow.powerflow.bus.V1,
          angle_0=powerFlow.powerflow.bus.A1,
          P_0=powerFlow.powerflow.machines.PG1,
          Q_0=powerFlow.powerflow.machines.QG1,
          V_b=24000)
          annotation (Placement(transformation(extent={{-112,60},{-92,80}})));
        OpenIPSL.Electrical.Branches.PwLine L1(
          R=0.001,
          X=0.2,
          G=0,
          B=0) annotation (Placement(transformation(extent={{-26,66},{-14,74}})));
        OpenIPSL.Electrical.Buses.Bus B3(v_0=powerFlow.powerflow.bus.V3, angle_0=
              powerFlow.powerflow.bus.A3)
          annotation (Placement(transformation(extent={{-10,60},{10,80}})));
        OpenIPSL.Electrical.Buses.Bus B4(v_0=powerFlow.powerflow.bus.V4, angle_0=
              powerFlow.powerflow.bus.V4)
          annotation (Placement(transformation(extent={{50,60},{70,80}})));
        OpenIPSL.Electrical.Branches.PwLine L2_1(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) annotation (Placement(transformation(extent={{24,76},{36,84}})));
        OpenIPSL.Electrical.Branches.PwLine L2_2(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) annotation (Placement(transformation(extent={{24,56},{36,64}})));
        OpenIPSL.Electrical.Buses.Bus B5(angle_0=powerFlow.powerflow.bus.A5, v_0=
              powerFlow.powerflow.bus.V5)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={80,10})));
        OpenIPSL.Electrical.Branches.PwLine L3(
          R=0.001,
          X=0.2,
          G=0,
          B=0) annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=-90,
              origin={80,40})));
        OpenIPSL.Electrical.Buses.Bus B6(v_0=powerFlow.powerflow.bus.V6, angle_0=
              powerFlow.powerflow.bus.A6)
                                         annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={60,-20})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
          G=0,
          B=0,
          VNOM1=220000,
          VB1=220000,
          VNOM2=24000,
          VB2=24000,
          R=0.005,
          X=0.1) annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=270,
              origin={60,-6})));
        GenerationUnits.PSSE.G2_3INPUTS                       G2(
          enableV_b=true,
          enableP_0=true,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V6,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A6,
          V_b=24000,
          P_0=powerFlow.powerflow.machines.PG2,
          Q_0=powerFlow.powerflow.machines.QG2,
          enableangle_0=true)
                        annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={60,-40})));
        inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000,
                                                              fn=50)
          annotation (Placement(transformation(extent={{-140,100},{-80,120}})));
        OpenIPSL.Electrical.Loads.PSSE.Load Load1(
          V_b=220000,
          P_0=powerFlow.powerflow.loads.PL1,
          Q_0=powerFlow.powerflow.loads.QL1,
          v_0=powerFlow.powerflow.bus.V3,
          angle_0=powerFlow.powerflow.bus.A3)
          annotation (Placement(transformation(extent={{-20,20},{0,40}})));
        Electrical.Events.Breaker breaker(enableTrigger=false,
          t_o=101,
          rc_enabled=false)                      annotation (Placement(transformation(
              extent={{-4,-4},{4,4}},
              rotation=90,
              origin={80,22})));

        Modelica.Blocks.Interfaces.RealInput IN1(start=0)
          "Connector of Real input signal 2" annotation (Placement(transformation(
              extent={{-20,-20},{20,20}},
              rotation=0,
              origin={-160,-40})));
        Electrical.Loads.PSSE.Load_variation Load2(
          V_b=220000,
          P_0=powerFlow.powerflow.loads.PL2,
          Q_0=powerFlow.powerflow.loads.QL2,
          v_0=powerFlow.powerflow.bus.V5,
          angle_0=powerFlow.powerflow.bus.A5,
          d_P=0,
          t1=0,
          d_t=0)
          annotation (Placement(transformation(extent={{90,-40},{110,-20}})));
        Modelica.Blocks.Sources.Constant IN11(k=0)
          annotation (Placement(transformation(extent={{-120,-70},{-100,-50}})));
        Modelica.Blocks.Math.Add AddU1
          annotation (Placement(transformation(extent={{-80,-56},{-60,-36}})));
        Modelica.Blocks.Sources.Constant IN22(k=0)
          annotation (Placement(transformation(extent={{-120,-110},{-100,-90}})));
        Modelica.Blocks.Math.Add AddU2
          annotation (Placement(transformation(extent={{-80,-96},{-60,-76}})));
        Modelica.Blocks.Interfaces.RealInput IN2(start=0)
          "Connector of Real input signal 2" annotation (Placement(transformation(
              extent={{-20,-20},{20,20}},
              rotation=0,
              origin={-160,-80})));
      Modelica.Blocks.Interfaces.RealOutput OUT1
          annotation (Placement(transformation(extent={{140,100},{160,120}})));
        Modelica.Blocks.Interfaces.RealOutput OUT2
          annotation (Placement(transformation(extent={{140,80},{160,100}})));
        Modelica.Blocks.Interfaces.RealOutput OUT3
          annotation (Placement(transformation(extent={{140,60},{160,80}})));
        Modelica.Blocks.Interfaces.RealOutput OUT4
          annotation (Placement(transformation(extent={{140,40},{160,60}})));
           Modelica.Blocks.Interfaces.RealOutput OUT5
          annotation (Placement(transformation(extent={{140,20},{160,40}})));
           Modelica.Blocks.Interfaces.RealOutput OUT6
          annotation (Placement(transformation(extent={{140,0},{160,20}})));
               Modelica.Blocks.Interfaces.RealOutput OUT7
          annotation (Placement(transformation(extent={{140,-20},{160,0}})));
           Modelica.Blocks.Interfaces.RealOutput OUT8
          annotation (Placement(transformation(extent={{140,-40},{160,-20}})));
               Modelica.Blocks.Interfaces.RealOutput OUT9
          annotation (Placement(transformation(extent={{140,-60},{160,-40}})));
           Modelica.Blocks.Interfaces.RealOutput OUT10
          annotation (Placement(transformation(extent={{140,-80},{160,-60}})));
           Modelica.Blocks.Interfaces.RealOutput OUT11
          annotation (Placement(transformation(extent={{140,-100},{160,-80}})));

        PFData.PowerFlow powerFlow(redeclare record PowerFlow =
              OpenIPSL.Examples.ModelPredictiveControl.PFData.PF01)
          annotation (Placement(transformation(extent={{-68,104},{-54,118}})));
        Electrical.Sources.VoltageSourceReImInput voltageSourceReImInput
          annotation (Placement(transformation(
              extent={{-10,10},{10,-10}},
              rotation=180,
              origin={88,96})));
        Modelica.Blocks.Sources.Constant VR(k=0.999211)
          annotation (Placement(transformation(extent={{132,90},{112,110}})));
        Modelica.Blocks.Sources.Constant VI(k=-0.00980921)
          annotation (Placement(transformation(extent={{134,56},{114,76}})));
      equation
        OUT1 = G2.SPEED1;
        OUT2 = G2.PMECH1;
        OUT3 = G2.gen.ANGLE;
        OUT4 = G2.TF2_out1;
        OUT5 =B4.angle;
        OUT6 =B4.v;
        OUT7 =B5.angle;
        OUT8 =B5.v;
        OUT9 =B5.p.vr;
        OUT10 =B5.p.vi;
        OUT11 = G2.gen.PELEC;
        connect(T1.p,B2. p)
          annotation (Line(points={{-53.4,70},{-40,70}},        color={0,0,255}));
        connect(B1.p, T1.n)
          annotation (Line(points={{-80,70},{-66.6,70}}, color={0,0,255}));
        connect(G1.conn, B1.p)
          annotation (Line(points={{-91,70},{-80,70}}, color={0,0,255}));
        connect(L1.n,B3. p)
          annotation (Line(points={{-14.6,70},{0,70}},            color={0,0,255}));
        connect(L1.p,B2. p) annotation (Line(points={{-25.4,70},{-40,70}},
              color={0,0,255}));
        connect(L2_2.n,B4. p) annotation (Line(points={{35.4,60},{44,60},{44,70},
                {60,70}},
                      color={0,0,255}));
        connect(L2_1.n,B4. p) annotation (Line(points={{35.4,80},{44,80},{44,70},
                {60,70}},
                      color={0,0,255}));
        connect(L2_1.p,B3. p) annotation (Line(points={{24.6,80},{16,80},{16,70},
                {0,70}},     color={0,0,255}));
        connect(L2_2.p,B3. p) annotation (Line(points={{24.6,60},{16,60},{16,70},
                {0,70}},
              color={0,0,255}));
        connect(G2.conn,B6. p)
          annotation (Line(points={{60,-29},{60,-20}}, color={0,0,255}));
        connect(Load1.p, B3.p)
          annotation (Line(points={{-10,40},{-10,70},{0,70}}, color={0,0,255}));
        connect(L3.p,B4. p) annotation (Line(points={{80,45.4},{80,70},{60,70}},
                                   color={0,0,255}));
        connect(breaker.s,B5. p)
          annotation (Line(points={{80,18},{80,10}},   color={0,0,255}));
        connect(breaker.r, L3.n)
          annotation (Line(points={{80,26},{80,34.6}},color={0,0,255}));
        connect(T2.n,B6. p)
          annotation (Line(points={{60,-12.6},{60,-20}}, color={0,0,255}));
        connect(Load2.p, B5.p) annotation (Line(points={{100,-20},{100,2},{80,2},
                {80,10}}, color={0,0,255}));
        connect(IN11.y, AddU1.u2) annotation (Line(points={{-99,-60},{-82,-60},{
                -82,-52}},  color={0,0,127}));
        connect(IN1, AddU1.u1) annotation (Line(points={{-160,-40},{-82,-40}},
                       color={0,0,127}));
        connect(T2.p,B5. p) annotation (Line(points={{60,0.6},{60,2},{80,2},{80,10}},
                              color={0,0,255}));

        connect(IN22.y,AddU2. u2) annotation (Line(points={{-99,-100},{-82,-100},{-82,
                -92}}, color={0,0,127}));
        connect(IN2,AddU2. u1) annotation (Line(points={{-160,-80},{-82,-80}},
                       color={0,0,127}));
        connect(AddU2.y, G2.Efd_ref)
          annotation (Line(points={{-59,-86},{66,-86},{66,-52}}, color={0,0,127}));
        connect(AddU1.y, G2.P_ref1) annotation (Line(points={{-59,-46},{44,-46},{
                44,-52},{54,-52}},                  color={0,0,127}));
        connect(VI.y, voltageSourceReImInput.vIm) annotation (Line(points={{113,
                66},{110,66},{110,86},{108,86},{108,92},{100,92}}, color={0,0,127}));
        connect(VR.y, voltageSourceReImInput.vRe)
          annotation (Line(points={{111,100},{100,100}}, color={0,0,127}));
        connect(voltageSourceReImInput.p, B4.p) annotation (Line(points={{77,96},
                {70,96},{70,70},{60,70}}, color={0,0,255}));
        annotation ( Diagram(coordinateSystem(preserveAspectRatio=false,
                extent={{-140,-120},{140,120}})),
          Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),experiment(
            StopTime=10,
            Tolerance=1e-09,
            __Dymola_Algorithm="Dassl"));
      end Reconnection_Microgrid_PSSE_3_INPUT_WITH_CONST_V_SOURCE3;

      model Reconnection_Microgrid_PSSE_3_INPUT_WITH_INF_BUS
        "THIS ONE IS STABLE, CONTROLLABLE, OBSERVABLE!!!!!!!"
        extends Modelica.Icons.Example;

        OpenIPSL.Electrical.Buses.Bus B1(v_0=powerFlow.powerflow.bus.V1, angle_0=
              powerFlow.powerflow.bus.A1)
          annotation (Placement(transformation(extent={{-90,60},{-70,80}})));
        OpenIPSL.Electrical.Buses.Bus B2(v_0=powerFlow.powerflow.bus.V2, angle_0=
              powerFlow.powerflow.bus.A1)
          annotation (Placement(transformation(extent={{-50,60},{-30,80}})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
          R=0.001,
          X=0.2,
          G=0,
          B=0,
          VNOM1=220000,
          VB1=220000,
          VNOM2=24000,
          VB2=24000) annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=180,
              origin={-60,70})));
        OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
          v_0=powerFlow.powerflow.bus.V1,
          angle_0=powerFlow.powerflow.bus.A1,
          P_0=powerFlow.powerflow.machines.PG1,
          Q_0=powerFlow.powerflow.machines.QG1,
          V_b=24000)
          annotation (Placement(transformation(extent={{-112,60},{-92,80}})));
        OpenIPSL.Electrical.Branches.PwLine L1(
          R=0.001,
          X=0.2,
          G=0,
          B=0) annotation (Placement(transformation(extent={{-26,66},{-14,74}})));
        OpenIPSL.Electrical.Buses.Bus B3(v_0=powerFlow.powerflow.bus.V3, angle_0=
              powerFlow.powerflow.bus.A3)
          annotation (Placement(transformation(extent={{-10,60},{10,80}})));
        OpenIPSL.Electrical.Buses.Bus B4(v_0=powerFlow.powerflow.bus.V4, angle_0=
              powerFlow.powerflow.bus.V4)
          annotation (Placement(transformation(extent={{50,60},{70,80}})));
        OpenIPSL.Electrical.Branches.PwLine L2_1(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) annotation (Placement(transformation(extent={{24,76},{36,84}})));
        OpenIPSL.Electrical.Branches.PwLine L2_2(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) annotation (Placement(transformation(extent={{24,56},{36,64}})));
        OpenIPSL.Electrical.Buses.Bus B5(angle_0=powerFlow.powerflow.bus.A5, v_0=
              powerFlow.powerflow.bus.V5)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={80,10})));
        OpenIPSL.Electrical.Branches.PwLine L3(
          R=0.001,
          X=0.2,
          G=0,
          B=0) annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=-90,
              origin={80,40})));
        OpenIPSL.Electrical.Buses.Bus B6(v_0=powerFlow.powerflow.bus.V6, angle_0=
              powerFlow.powerflow.bus.A6)
                                         annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={60,-20})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
          G=0,
          B=0,
          VNOM1=220000,
          VB1=220000,
          VNOM2=24000,
          VB2=24000,
          R=0.005,
          X=0.1) annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=270,
              origin={60,-6})));
        GenerationUnits.PSSE.G2_3INPUTS                       G2(
          enableV_b=true,
          enableP_0=true,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V6,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A6,
          V_b=24000,
          P_0=powerFlow.powerflow.machines.PG2,
          Q_0=powerFlow.powerflow.machines.QG2,
          enableangle_0=true)
                        annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={60,-40})));
        inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000,
                                                              fn=50)
          annotation (Placement(transformation(extent={{-140,100},{-80,120}})));
        OpenIPSL.Electrical.Loads.PSSE.Load Load1(
          V_b=220000,
          P_0=powerFlow.powerflow.loads.PL1,
          Q_0=powerFlow.powerflow.loads.QL1,
          v_0=powerFlow.powerflow.bus.V3,
          angle_0=powerFlow.powerflow.bus.A3)
          annotation (Placement(transformation(extent={{-20,20},{0,40}})));
        Electrical.Events.Breaker breaker(enableTrigger=false,
          t_o=101,
          rc_enabled=false)                      annotation (Placement(transformation(
              extent={{-4,-4},{4,4}},
              rotation=90,
              origin={80,22})));

        Modelica.Blocks.Interfaces.RealInput IN1(start=0)
          "Connector of Real input signal 2" annotation (Placement(transformation(
              extent={{-20,-20},{20,20}},
              rotation=0,
              origin={-160,-40})));
        Electrical.Loads.PSSE.Load_variation Load2(
          V_b=220000,
          P_0=powerFlow.powerflow.loads.PL2,
          Q_0=powerFlow.powerflow.loads.QL2,
          v_0=powerFlow.powerflow.bus.V5,
          angle_0=powerFlow.powerflow.bus.A5,
          d_P=0,
          t1=0,
          d_t=0)
          annotation (Placement(transformation(extent={{90,-40},{110,-20}})));
        Modelica.Blocks.Sources.Constant IN11(k=0)
          annotation (Placement(transformation(extent={{-120,-70},{-100,-50}})));
        Modelica.Blocks.Math.Add AddU1
          annotation (Placement(transformation(extent={{-80,-56},{-60,-36}})));
        Modelica.Blocks.Sources.Constant IN22(k=0)
          annotation (Placement(transformation(extent={{-120,-110},{-100,-90}})));
        Modelica.Blocks.Math.Add AddU2
          annotation (Placement(transformation(extent={{-80,-96},{-60,-76}})));
        Modelica.Blocks.Interfaces.RealInput IN2(start=0)
          "Connector of Real input signal 2" annotation (Placement(transformation(
              extent={{-20,-20},{20,20}},
              rotation=0,
              origin={-160,-80})));
      Modelica.Blocks.Interfaces.RealOutput OUT1
          annotation (Placement(transformation(extent={{140,100},{160,120}})));
        Modelica.Blocks.Interfaces.RealOutput OUT2
          annotation (Placement(transformation(extent={{140,80},{160,100}})));
        Modelica.Blocks.Interfaces.RealOutput OUT3
          annotation (Placement(transformation(extent={{140,60},{160,80}})));
        Modelica.Blocks.Interfaces.RealOutput OUT4
          annotation (Placement(transformation(extent={{140,40},{160,60}})));
           Modelica.Blocks.Interfaces.RealOutput OUT5
          annotation (Placement(transformation(extent={{140,20},{160,40}})));
           Modelica.Blocks.Interfaces.RealOutput OUT6
          annotation (Placement(transformation(extent={{140,0},{160,20}})));
               Modelica.Blocks.Interfaces.RealOutput OUT7
          annotation (Placement(transformation(extent={{140,-20},{160,0}})));
           Modelica.Blocks.Interfaces.RealOutput OUT8
          annotation (Placement(transformation(extent={{140,-40},{160,-20}})));
               Modelica.Blocks.Interfaces.RealOutput OUT9
          annotation (Placement(transformation(extent={{140,-60},{160,-40}})));
           Modelica.Blocks.Interfaces.RealOutput OUT10
          annotation (Placement(transformation(extent={{140,-80},{160,-60}})));
           Modelica.Blocks.Interfaces.RealOutput OUT11
          annotation (Placement(transformation(extent={{140,-100},{160,-80}})));

        PFData.PowerFlow powerFlow(redeclare record PowerFlow =
              OpenIPSL.Examples.ModelPredictiveControl.PFData.PF01)
          annotation (Placement(transformation(extent={{-68,104},{-54,118}})));
        Electrical.Machines.PSSE.GENCLS          IB(
          V_b=220000,
          v_0=powerFlow.powerflow.bus.V4,
          angle_0=powerFlow.powerflow.bus.A4,
          P_0=powerFlow.powerflow.machines.Pinf,
          Q_0=powerFlow.powerflow.machines.Qinf,
          M_b=100000000,
          X_d=1)   annotation (Placement(transformation(extent={{110,60},{100,80}})));
      equation
        OUT1 = G2.SPEED1;
        OUT2 = G2.PMECH1;
        OUT3 = G2.gen.ANGLE;
        OUT4 = G2.TF2_out1;
        OUT5 =B4.angle;
        OUT6 =B4.v;
        OUT7 =B5.angle;
        OUT8 =B5.v;
        OUT9 =B5.p.vr;
        OUT10 =B5.p.vi;
        OUT11 = G2.gen.PELEC;
        connect(T1.p,B2. p)
          annotation (Line(points={{-53.4,70},{-40,70}},        color={0,0,255}));
        connect(B1.p, T1.n)
          annotation (Line(points={{-80,70},{-66.6,70}}, color={0,0,255}));
        connect(G1.conn, B1.p)
          annotation (Line(points={{-91,70},{-80,70}}, color={0,0,255}));
        connect(L1.n,B3. p)
          annotation (Line(points={{-14.6,70},{0,70}},            color={0,0,255}));
        connect(L1.p,B2. p) annotation (Line(points={{-25.4,70},{-40,70}},
              color={0,0,255}));
        connect(L2_2.n,B4. p) annotation (Line(points={{35.4,60},{44,60},{44,70},
                {60,70}},
                      color={0,0,255}));
        connect(L2_1.n,B4. p) annotation (Line(points={{35.4,80},{44,80},{44,70},
                {60,70}},
                      color={0,0,255}));
        connect(L2_1.p,B3. p) annotation (Line(points={{24.6,80},{16,80},{16,70},
                {0,70}},     color={0,0,255}));
        connect(L2_2.p,B3. p) annotation (Line(points={{24.6,60},{16,60},{16,70},
                {0,70}},
              color={0,0,255}));
        connect(G2.conn,B6. p)
          annotation (Line(points={{60,-29},{60,-20}}, color={0,0,255}));
        connect(Load1.p, B3.p)
          annotation (Line(points={{-10,40},{-10,70},{0,70}}, color={0,0,255}));
        connect(L3.p,B4. p) annotation (Line(points={{80,45.4},{80,70},{60,70}},
                                   color={0,0,255}));
        connect(breaker.s,B5. p)
          annotation (Line(points={{80,18},{80,10}},   color={0,0,255}));
        connect(breaker.r, L3.n)
          annotation (Line(points={{80,26},{80,34.6}},color={0,0,255}));
        connect(T2.n,B6. p)
          annotation (Line(points={{60,-12.6},{60,-20}}, color={0,0,255}));
        connect(Load2.p, B5.p) annotation (Line(points={{100,-20},{100,2},{80,2},
                {80,10}}, color={0,0,255}));
        connect(IN11.y, AddU1.u2) annotation (Line(points={{-99,-60},{-82,-60},{
                -82,-52}},  color={0,0,127}));
        connect(IN1, AddU1.u1) annotation (Line(points={{-160,-40},{-82,-40}},
                       color={0,0,127}));
        connect(T2.p,B5. p) annotation (Line(points={{60,0.6},{60,2},{80,2},{80,10}},
                              color={0,0,255}));

        connect(IN22.y,AddU2. u2) annotation (Line(points={{-99,-100},{-82,-100},{-82,
                -92}}, color={0,0,127}));
        connect(IN2,AddU2. u1) annotation (Line(points={{-160,-80},{-82,-80}},
                       color={0,0,127}));
        connect(AddU2.y, G2.Efd_ref)
          annotation (Line(points={{-59,-86},{66,-86},{66,-52}}, color={0,0,127}));
        connect(AddU1.y, G2.P_ref1) annotation (Line(points={{-59,-46},{44,-46},{
                44,-52},{54,-52}},                  color={0,0,127}));
        connect(IB.p, B4.p)
          annotation (Line(points={{100,70},{60,70}}, color={0,0,255}));
        annotation ( Diagram(coordinateSystem(preserveAspectRatio=false,
                extent={{-140,-120},{140,120}})),
          Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),experiment(
            StopTime=10,
            Tolerance=1e-09,
            __Dymola_Algorithm="Dassl"));
      end Reconnection_Microgrid_PSSE_3_INPUT_WITH_INF_BUS;
    end OBSERVABLE_CONTROLLABLE_STABLE;

    package NOTCONTROLLABLE_NOTOBSERVABLE_STABLE

      model
        Reconnection_Microgrid_PSSE_1_INPUT_1_OUTPUT_WITH_CONST_V_SOURCE2_NO_TG
        "THIS ONE IS STABLE, CONTROLLABLE, OBSERVABLE!!!!!!!"
        extends Modelica.Icons.Example;
        OpenIPSL.Electrical.Buses.Bus BG1(v_0=0.998855, angle_0=0.15699114448641)
          annotation (Placement(transformation(extent={{-90,60},{-70,80}})));
        OpenIPSL.Electrical.Buses.Bus B1(v_0=0.992504, angle_0=0.076251672237088)
          annotation (Placement(transformation(extent={{-50,60},{-30,80}})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
          R=0.001,
          X=0.2,
          G=0,
          B=0,
          VNOM1=220000,
          VB1=220000,
          VNOM2=24000,
          VB2=24000) annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=180,
              origin={-60,70})));
        OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
          v_0=0.998855,
          angle_0=0.15699114448641,
          P_0=40000000,
          Q_0=4547321,
          V_b=24000)
          annotation (Placement(transformation(extent={{-112,60},{-92,80}})));
        OpenIPSL.Electrical.Branches.PwLine L1(
          R=0.001,
          X=0.2,
          G=0,
          B=0) annotation (Placement(transformation(extent={{-26,66},{-14,74}})));
        OpenIPSL.Electrical.Buses.Bus B2(v_0=0.992681, angle_0=-0.0049879590159821)
          annotation (Placement(transformation(extent={{-10,60},{10,80}})));
        OpenIPSL.Electrical.Buses.Bus B3(v_0=0.998705, angle_0=9.4873305611609e-06)
          annotation (Placement(transformation(extent={{50,60},{70,80}})));
        OpenIPSL.Electrical.Branches.PwLine L2_1(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) annotation (Placement(transformation(extent={{24,86},{36,94}})));
        OpenIPSL.Electrical.Branches.PwLine L2_2(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) annotation (Placement(transformation(extent={{24,46},{36,54}})));
        OpenIPSL.Electrical.Buses.Bus B4(angle_0=-0.00014475935348966,
                                                                v_0=0.997342)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={80,10})));
        OpenIPSL.Electrical.Branches.PwLine L3(
          R=0.001,
          X=0.2,
          G=0,
          B=0) annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=-90,
              origin={80,40})));
        OpenIPSL.Electrical.Buses.Bus B5(v_0=1.0074, angle_0=0.0093371449790267)
                                         annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={60,-20})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
          G=0,
          B=0,
          VNOM1=220000,
          VB1=220000,
          VNOM2=24000,
          VB2=24000,
          R=0.005,
          X=0.1) annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=270,
              origin={60,-6})));
        OpenIPSL.Examples.ModelPredictiveControl.GenerationUnits.PSSE.G2_1INPUT_Pref_NO_TurbGov
          G2(
          v_0=1.0074,
          angle_0=0.0093371449790267,
          V_b=24000,
          P_0=10010220,
          Q_0=10204330) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={60,-40})));
        inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000,
                                                              fn=50)
          annotation (Placement(transformation(extent={{-140,100},{-80,120}})));
        OpenIPSL.Electrical.Loads.PSSE.Load LD1(
          V_b=220000,
          v_0=0.992681,
          angle_0=-0.0049879590159821,
          P_0=50000000,
          Q_0=10000000) annotation (Placement(transformation(extent={{-12,18},{0,30}})));
        Electrical.Events.Breaker breaker(enableTrigger=false, t_o=0.1)
                                                 annotation (Placement(transformation(
              extent={{-4,-4},{4,4}},
              rotation=90,
              origin={80,22})));

        Modelica.Blocks.Interfaces.RealInput IN1(start=0)
          "Connector of Real input signal 2" annotation (Placement(transformation(
              extent={{-20,-20},{20,20}},
              rotation=0,
              origin={-160,0})));
        Electrical.Loads.PSSE.Load_variation load_variation(
          V_b=220000,
          P_0=15000000,
          Q_0=15000000,
          v_0=0.997342,
          angle_0=-0.00014475935348966,
          d_P=0.1,
          t1=1000,
          d_t=2000)
          annotation (Placement(transformation(extent={{90,-40},{110,-20}})));
        Modelica.Blocks.Interfaces.RealOutput OUT1
          annotation (Placement(transformation(extent={{140,-70},{160,-50}})));
        Electrical.Sources.VoltageSourceReImInput voltageSourceReImInput
          annotation (Placement(transformation(
              extent={{-10,10},{10,-10}},
              rotation=180,
              origin={86,96})));
        Modelica.Blocks.Sources.Constant VR(k=0.998726)
          annotation (Placement(transformation(extent={{130,90},{110,110}})));
        Modelica.Blocks.Sources.Constant VI(k=3.7730e-5)
          annotation (Placement(transformation(extent={{132,56},{112,76}})));
        Modelica.Blocks.Sources.Constant IN11(k=0)
          annotation (Placement(transformation(extent={{-120,-46},{-100,-26}})));
        Modelica.Blocks.Math.Add AddU1
          annotation (Placement(transformation(extent={{-80,-40},{-60,-20}})));
      equation
        OUT1 = G2.gen.w;

        connect(T1.p, B1.p)
          annotation (Line(points={{-53.4,70},{-40,70}},        color={0,0,255}));
        connect(BG1.p, T1.n)
          annotation (Line(points={{-80,70},{-66.6,70}},
                                                       color={0,0,255}));
        connect(G1.conn, BG1.p)
          annotation (Line(points={{-91,70},{-80,70}},          color={0,0,255}));
        connect(L1.n, B2.p)
          annotation (Line(points={{-14.6,70},{0,70}},            color={0,0,255}));
        connect(L1.p, B1.p) annotation (Line(points={{-25.4,70},{-40,70}},
              color={0,0,255}));
        connect(L2_2.n, B3.p) annotation (Line(points={{35.4,50},{56,50},{56,70},{60,
                70}}, color={0,0,255}));
        connect(L2_1.n, B3.p) annotation (Line(points={{35.4,90},{56,90},{56,70},{60,
                70}}, color={0,0,255}));
        connect(L2_1.p, B2.p) annotation (Line(points={{24.6,90},{4,90},{4,70},{0,70}},
                             color={0,0,255}));
        connect(L2_2.p, B2.p) annotation (Line(points={{24.6,50},{4,50},{4,70},{0,70}},
              color={0,0,255}));
        connect(G2.conn, B5.p)
          annotation (Line(points={{60,-29},{60,-20}}, color={0,0,255}));
        connect(LD1.p, B2.p)
          annotation (Line(points={{-6,30},{-6,70},{0,70}},color={0,0,255}));
        connect(L3.p, B3.p) annotation (Line(points={{80,45.4},{80,70},{60,70}},
                                   color={0,0,255}));
        connect(breaker.s, B4.p)
          annotation (Line(points={{80,18},{80,10}},   color={0,0,255}));
        connect(breaker.r, L3.n)
          annotation (Line(points={{80,26},{80,34.6}},color={0,0,255}));
        connect(T2.n, B5.p)
          annotation (Line(points={{60,-12.6},{60,-20}}, color={0,0,255}));
        connect(load_variation.p, B4.p) annotation (Line(points={{100,-20},{100,2},{80,
                2},{80,10}},          color={0,0,255}));
        connect(VR.y,voltageSourceReImInput. vRe)
          annotation (Line(points={{109,100},{98,100}},  color={0,0,127}));
        connect(VI.y,voltageSourceReImInput. vIm) annotation (Line(points={{111,66},{106,
                66},{106,92},{98,92}},       color={0,0,127}));
        connect(voltageSourceReImInput.p, B3.p)
          annotation (Line(points={{75,96},{60,96},{60,70}}, color={0,0,255}));
        connect(IN11.y, AddU1.u2) annotation (Line(points={{-99,-36},{-82,-36}},
                            color={0,0,127}));
        connect(IN1, AddU1.u1) annotation (Line(points={{-160,0},{-92,0},{-92,-24},{-82,
                -24}}, color={0,0,127}));
        connect(T2.p, B4.p) annotation (Line(points={{60,0.6},{60,2},{80,2},{80,10}},
                              color={0,0,255}));
        connect(AddU1.y, G2.P_ref) annotation (Line(points={{-59,-30},{-20,-30},{
                -20,-78},{60,-78},{60,-52}}, color={0,0,127}));
        annotation ( Diagram(coordinateSystem(preserveAspectRatio=false,
                extent={{-140,-120},{140,120}})),
          Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),experiment(StopTime=10, __Dymola_Algorithm="Dassl"));
      end
        Reconnection_Microgrid_PSSE_1_INPUT_1_OUTPUT_WITH_CONST_V_SOURCE2_NO_TG;

      model Reconnection_Microgrid_PSSE_2_INPUT_WITH_CONST_V_SOURCE2_NO_TG
        "THIS ONE IS STABLE, CONTROLLABLE, OBSERVABLE!!!!!!!"
        extends Modelica.Icons.Example;
        OpenIPSL.Electrical.Buses.Bus BG1(v_0=0.998855, angle_0=0.15699114448641)
          annotation (Placement(transformation(extent={{-90,60},{-70,80}})));
        OpenIPSL.Electrical.Buses.Bus B1(v_0=0.992504, angle_0=0.076251672237088)
          annotation (Placement(transformation(extent={{-50,60},{-30,80}})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
          R=0.001,
          X=0.2,
          G=0,
          B=0,
          VNOM1=220000,
          VB1=220000,
          VNOM2=24000,
          VB2=24000) annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=180,
              origin={-60,70})));
        OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
          v_0=0.998855,
          angle_0=0.15699114448641,
          P_0=40000000,
          Q_0=4547321,
          V_b=24000)
          annotation (Placement(transformation(extent={{-112,60},{-92,80}})));
        OpenIPSL.Electrical.Branches.PwLine L1(
          R=0.001,
          X=0.2,
          G=0,
          B=0) annotation (Placement(transformation(extent={{-26,66},{-14,74}})));
        OpenIPSL.Electrical.Buses.Bus B2(v_0=0.992681, angle_0=-0.0049879590159821)
          annotation (Placement(transformation(extent={{-10,60},{10,80}})));
        OpenIPSL.Electrical.Buses.Bus B3(v_0=0.998705, angle_0=9.4873305611609e-06)
          annotation (Placement(transformation(extent={{50,60},{70,80}})));
        OpenIPSL.Electrical.Branches.PwLine L2_1(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) annotation (Placement(transformation(extent={{24,86},{36,94}})));
        OpenIPSL.Electrical.Branches.PwLine L2_2(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) annotation (Placement(transformation(extent={{24,46},{36,54}})));
        OpenIPSL.Electrical.Buses.Bus B4(angle_0=-0.00014475935348966,
                                                                v_0=0.997342)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={80,10})));
        OpenIPSL.Electrical.Branches.PwLine L3(
          R=0.001,
          X=0.2,
          G=0,
          B=0) annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=-90,
              origin={80,40})));
        OpenIPSL.Electrical.Buses.Bus B5(v_0=1.0074, angle_0=0.0093371449790267)
                                         annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={60,-20})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
          G=0,
          B=0,
          VNOM1=220000,
          VB1=220000,
          VNOM2=24000,
          VB2=24000,
          R=0.005,
          X=0.1) annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=270,
              origin={60,-6})));
        OpenIPSL.Examples.ModelPredictiveControl.GenerationUnits.PSSE.G2_2INPUT_Pref_Efdref_NO_TurbGov_NO_Exci
          G2(
          v_0=1.0074,
          angle_0=0.0093371449790267,
          V_b=24000,
          P_0=10010220,
          Q_0=10204330) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={60,-40})));
        inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000,
                                                              fn=50)
          annotation (Placement(transformation(extent={{-140,100},{-80,120}})));
        OpenIPSL.Electrical.Loads.PSSE.Load LD1(
          V_b=220000,
          v_0=0.992681,
          angle_0=-0.0049879590159821,
          P_0=50000000,
          Q_0=10000000) annotation (Placement(transformation(extent={{-12,18},{0,30}})));
        Electrical.Events.Breaker breaker(enableTrigger=false, t_o=0.1)
                                                 annotation (Placement(transformation(
              extent={{-4,-4},{4,4}},
              rotation=90,
              origin={80,22})));

        Modelica.Blocks.Interfaces.RealInput IN1(start=0)
          "Connector of Real input signal 2" annotation (Placement(transformation(
              extent={{-20,-20},{20,20}},
              rotation=0,
              origin={-160,0})));
              Modelica.Blocks.Interfaces.RealInput IN2(start=0)
          "Connector of Real input signal 2" annotation (Placement(transformation(
              extent={{-20,-20},{20,20}},
              rotation=0,
              origin={-160,-84})));
        Electrical.Loads.PSSE.Load_variation load_variation(
          V_b=220000,
          P_0=15000000,
          Q_0=15000000,
          v_0=0.997342,
          angle_0=-0.00014475935348966,
          d_P=0.1,
          t1=1000,
          d_t=2000)
          annotation (Placement(transformation(extent={{90,-40},{110,-20}})));
        Modelica.Blocks.Interfaces.RealOutput OUT1
          annotation (Placement(transformation(extent={{140,-70},{160,-50}})));
        Electrical.Sources.VoltageSourceReImInput voltageSourceReImInput
          annotation (Placement(transformation(
              extent={{-10,10},{10,-10}},
              rotation=180,
              origin={86,96})));
        Modelica.Blocks.Sources.Constant VR(k=0.998726)
          annotation (Placement(transformation(extent={{130,90},{110,110}})));
        Modelica.Blocks.Sources.Constant VI(k=3.7730e-5)
          annotation (Placement(transformation(extent={{132,56},{112,76}})));
        Modelica.Blocks.Sources.Constant IN11(k=0)
          annotation (Placement(transformation(extent={{-120,-30},{-100,-10}})));
        Modelica.Blocks.Math.Add AddU1
          annotation (Placement(transformation(extent={{-80,-16},{-60,4}})));
        Modelica.Blocks.Sources.Constant IN22(k=0)
          annotation (Placement(transformation(extent={{-120,-114},{-100,-94}})));
        Modelica.Blocks.Math.Add AddU3
          annotation (Placement(transformation(extent={{-80,-100},{-60,-80}})));
        Modelica.Blocks.Interfaces.RealOutput OUT2
          annotation (Placement(transformation(extent={{140,-10},{160,10}})));
      equation
        OUT1 = G2.gen.w;
        OUT2 = B4.v;

        connect(T1.p, B1.p)
          annotation (Line(points={{-53.4,70},{-40,70}},        color={0,0,255}));
        connect(BG1.p, T1.n)
          annotation (Line(points={{-80,70},{-66.6,70}},
                                                       color={0,0,255}));
        connect(G1.conn, BG1.p)
          annotation (Line(points={{-91,70},{-80,70}},          color={0,0,255}));
        connect(L1.n, B2.p)
          annotation (Line(points={{-14.6,70},{0,70}},            color={0,0,255}));
        connect(L1.p, B1.p) annotation (Line(points={{-25.4,70},{-40,70}},
              color={0,0,255}));
        connect(L2_2.n, B3.p) annotation (Line(points={{35.4,50},{56,50},{56,70},{60,
                70}}, color={0,0,255}));
        connect(L2_1.n, B3.p) annotation (Line(points={{35.4,90},{56,90},{56,70},{60,
                70}}, color={0,0,255}));
        connect(L2_1.p, B2.p) annotation (Line(points={{24.6,90},{4,90},{4,70},{0,70}},
                             color={0,0,255}));
        connect(L2_2.p, B2.p) annotation (Line(points={{24.6,50},{4,50},{4,70},{0,70}},
              color={0,0,255}));
        connect(G2.conn, B5.p)
          annotation (Line(points={{60,-29},{60,-20}}, color={0,0,255}));
        connect(LD1.p, B2.p)
          annotation (Line(points={{-6,30},{-6,70},{0,70}},color={0,0,255}));
        connect(L3.p, B3.p) annotation (Line(points={{80,45.4},{80,70},{60,70}},
                                   color={0,0,255}));
        connect(breaker.s, B4.p)
          annotation (Line(points={{80,18},{80,10}},   color={0,0,255}));
        connect(breaker.r, L3.n)
          annotation (Line(points={{80,26},{80,34.6}},color={0,0,255}));
        connect(T2.n, B5.p)
          annotation (Line(points={{60,-12.6},{60,-20}}, color={0,0,255}));
        connect(load_variation.p, B4.p) annotation (Line(points={{100,-20},{100,2},{80,
                2},{80,10}},          color={0,0,255}));
        connect(VR.y,voltageSourceReImInput. vRe)
          annotation (Line(points={{109,100},{98,100}},  color={0,0,127}));
        connect(VI.y,voltageSourceReImInput. vIm) annotation (Line(points={{111,66},{106,
                66},{106,92},{98,92}},       color={0,0,127}));
        connect(voltageSourceReImInput.p, B3.p)
          annotation (Line(points={{75,96},{60,96},{60,70}}, color={0,0,255}));
        connect(IN11.y, AddU1.u2) annotation (Line(points={{-99,-20},{-82,-20},{-82,-12}},
                            color={0,0,127}));
        connect(IN1, AddU1.u1) annotation (Line(points={{-160,0},{-82,0}},
                       color={0,0,127}));
        connect(AddU1.y, G2.P_ref) annotation (Line(points={{-59,-6},{40,-6},{40,-60},
                {56,-60},{56,-52}}, color={0,0,127}));
        connect(T2.p, B4.p) annotation (Line(points={{60,0.6},{60,2},{80,2},{80,10}},
                              color={0,0,255}));
        connect(IN2, AddU3.u1)
          annotation (Line(points={{-160,-84},{-82,-84}}, color={0,0,127}));
        connect(IN22.y, AddU3.u2) annotation (Line(points={{-99,-104},{-90,-104},{-90,
                -96},{-82,-96}}, color={0,0,127}));
        connect(AddU3.y, G2.Efd_ref)
          annotation (Line(points={{-59,-90},{64,-90},{64,-52}}, color={0,0,127}));
        annotation ( Diagram(coordinateSystem(preserveAspectRatio=false,
                extent={{-140,-120},{140,120}})),
          Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),experiment(StopTime=10, __Dymola_Algorithm="Dassl"));
      end Reconnection_Microgrid_PSSE_2_INPUT_WITH_CONST_V_SOURCE2_NO_TG;
    end NOTCONTROLLABLE_NOTOBSERVABLE_STABLE;

    package EquipmentOnlyLinearization

      model OptimizationModel03 "THIS ONE IS STABLE, CONTROLLABLE, OBSERVABLE!!!!!!!"
        extends Modelica.Icons.Example;

        parameter Boolean equivalentGRID = false;
        parameter Boolean equivalentInfBUS = false;
        parameter Real T = 5;

        OpenIPSL.Electrical.Buses.Bus Bus1(v_0=powerFlow.powerflow.bus.V1, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-90,60},{-70,80}})));
        OpenIPSL.Electrical.Buses.Bus Bus2(v_0=powerFlow.powerflow.bus.V2, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-50,60},{-30,80}})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
          R=0.001,
          X=0.2,
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000)  if not equivalentGRID annotation (Placement(transformation(
              extent={{-8,-8},{8,8}},
              rotation=180,
              origin={-60,70})));
        OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
          enableV_b=true,
          v_0=powerFlow.powerflow.bus.V1,
          angle_0=powerFlow.powerflow.bus.A1,
          P_0=powerFlow.powerflow.machines.PG1,
          Q_0=powerFlow.powerflow.machines.QG1,
          V_b=6000)  if not equivalentGRID
          annotation (Placement(transformation(extent={{-112,60},{-92,80}})));
        OpenIPSL.Electrical.Branches.PwLine L1(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{-26,66},{-14,74}})));
        OpenIPSL.Electrical.Buses.Bus Bus3(v_0=powerFlow.powerflow.bus.V3, angle_0=
              powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-10,60},{10,80}})));
        OpenIPSL.Electrical.Buses.Bus Bus4(v_0=powerFlow.powerflow.bus.V4, angle_0=
              powerFlow.powerflow.bus.V4) if not equivalentGRID
          annotation (Placement(transformation(extent={{50,60},{70,80}})));
        OpenIPSL.Electrical.Branches.PwLine L2_1(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,76},{36,84}})));
        OpenIPSL.Electrical.Branches.PwLine L2_2(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,56},{36,64}})));
        OpenIPSL.Electrical.Buses.Bus Bus5(angle_0=powerFlow.powerflow.bus.A5, v_0=
              powerFlow.powerflow.bus.V5)  annotation (Placement(
              transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={80,6})));
        OpenIPSL.Electrical.Branches.PwLine L3(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=-90,
              origin={80,50})));
        OpenIPSL.Electrical.Buses.Bus Bus6(v_0=powerFlow.powerflow.bus.V6, angle_0=
              powerFlow.powerflow.bus.A6) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={34,-36})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000,
          R=0.005,
          X=0.1)  annotation (Placement(transformation(
              extent={{-8,-8},{8,8}},
              rotation=270,
              origin={50,-16})));
        GenerationUnits.PSSE.G2_3INPUTS                       G2(
          enableV_b=true,
          enableP_0=true,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V6,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A6,
          V_b=6000,
          P_0=powerFlow.powerflow.machines.PG2,
          Q_0=powerFlow.powerflow.machines.QG2,
          enableangle_0=true)
                        annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={10,-36})));
        inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000, fn=60)
          annotation (Placement(transformation(extent={{-128,94},{-74,114}})));
        OpenIPSL.Electrical.Loads.PSSE.Load Load1(
          V_b=220000,
          P_0=powerFlow.powerflow.loads.PL1,
          Q_0=powerFlow.powerflow.loads.QL1,
          v_0=powerFlow.powerflow.bus.V3,
          angle_0=powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-20,38},{0,58}})));
        Electrical.Events.Breaker breaker(enableTrigger=false,
          t_o=0.001,
          rc_enabled=false,
          t_rc=30.01)       if not equivalentGRID                     annotation (Placement(transformation(
              extent={{-4,-4},{4,4}},
              rotation=90,
              origin={80,16})));

        Modelica.Blocks.Interfaces.RealInput IN1(start=0)
          "Connector of Real input signal 2" annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-150,0}), iconTransformation(extent={{-10,-10},{10,10}}, origin=
                 {-150,0})));
        Modelica.Blocks.Math.Add AddU1
          annotation (Placement(transformation(extent={{-80,-16},{-60,4}})));
        Modelica.Blocks.Math.Add AddU2
          annotation (Placement(transformation(extent={{-80,-76},{-60,-56}})));
        Modelica.Blocks.Interfaces.RealInput IN2(start=0)
          "Connector of Real input signal 2" annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-150,-60}), iconTransformation(extent={{-10,-10},{10,10}},
                origin={-150,-60})));
        Modelica.Blocks.Interfaces.RealOutput OUT1
          annotation (Placement(transformation(extent={{140,58},{160,78}})));
        Modelica.Blocks.Interfaces.RealOutput OUT2
          annotation (Placement(transformation(extent={{140,38},{160,58}})));
        Modelica.Blocks.Interfaces.RealOutput OUT3
          annotation (Placement(transformation(extent={{140,18},{160,38}})));
        Modelica.Blocks.Interfaces.RealOutput OUT4
          annotation (Placement(transformation(extent={{140,-2},{160,18}})));
        Modelica.Blocks.Interfaces.RealOutput OUT5
          annotation (Placement(transformation(extent={{140,-22},{160,-2}})));
        Modelica.Blocks.Interfaces.RealOutput OUT6
          annotation (Placement(transformation(extent={{140,-42},{160,-22}})));
        Modelica.Blocks.Interfaces.RealOutput OUT7
          annotation (Placement(transformation(extent={{140,-62},
                  {160,-42}})));
        Modelica.Blocks.Interfaces.RealOutput OUT8
          annotation (Placement(transformation(extent={{140,-82},
                  {160,-62}})));
        Modelica.Blocks.Interfaces.RealOutput OUT9    annotation (Placement(transformation(extent={{140,-42},{160,-22}})));
        Modelica.Blocks.Interfaces.RealOutput OUT10   annotation (Placement(transformation(extent={{140,-62},{160,-42}})));
        Modelica.Blocks.Interfaces.RealOutput OUT11  annotation (Placement(transformation(extent={{140,-82},{160,-62}})));

        PFData.PowerFlow powerFlow(redeclare record PowerFlow =
              OpenIPSL.Examples.ModelPredictiveControl.PFData.PF04)
          annotation (Placement(transformation(extent={{-68,94},{-48,114}})));
        Electrical.Machines.PSSE.GENCLS IB(
          V_b=220000,
          v_0=powerFlow.powerflow.bus.V4,
          angle_0=powerFlow.powerflow.bus.A4,
          P_0=powerFlow.powerflow.machines.Pinf,
          Q_0=powerFlow.powerflow.machines.Qinf,
          M_b=100000000,
          X_d=1) if not equivalentGRID annotation (Placement(transformation(extent={{110,60},{100,80}})));
        Electrical.Loads.PSSE.Load_ExtInput Load2(
          P_0=powerFlow.powerflow.loads.PL2,
          Q_0=powerFlow.powerflow.loads.QL2,
          v_0=powerFlow.powerflow.bus.V5,
          angle_0=powerFlow.powerflow.bus.A5,
          d_P=0,
          t1=100,
          d_t=1000)
          annotation (Placement(transformation(extent={{100,-40},{120,-20}})));
        Electrical.Loads.NoiseInjections.WhiteNoiseInjection whiteNoiseInjection(
            active_sigma=0.00000002,
                                  samplePeriod=0.02)
          annotation (Placement(transformation(extent={{70,-28},{82,-16}})));

        inner Modelica.Blocks.Noise.GlobalSeed globalSeed(useAutomaticSeed=false,
            fixedSeed=10000)
          annotation (Placement(transformation(extent={{-42,92},{-22,112}})));
        Modelica.Blocks.Sources.Sine sine(
          amplitude=0,
          f=1/200,
          phase=3.1415926535898,
          startTime=3)
          annotation (Placement(transformation(extent={{72,-44},{82,-34}})));
        Modelica.Blocks.Math.Add add
          annotation (Placement(transformation(extent={{86,-30},{94,-22}})));

        Modelica.Blocks.Continuous.StateSpace stateSpace(
          A=[-0.0350467319011269,-0.390562612800037,-0.0220982102141145,-0.0580078018245206,
              0.381444455935434,0,0,0,0.116822429908667,0; 376.991118430775,0,0,0,0,0,
              0,0,0,0; 0,-0.0454184390776668,-0.986678228156109,0.523762754571772,-0.00438192488056084,
              0.199999999965295,0,0,0,0; 0,-2.38492178606947,10.4772483822384,-24.2829372788823,
              -0.230094818710897,0,0,0,0,0; 0,56.5367251635352,0.263868804467372,
              0.692655615925671,-68.5025764464478,0,0,0,0,0; 0,-4.10404377522038,-91.0705533888705,
              -239.060202328028,-48.6994875566102,-99.9999999826474,4000.00000016301,
              0,0,0; 0,-0.000410404377522038,-0.00910705533888706,-0.0239060202328028,
              -0.00486994875566103,0,-0.0999999999912857,0,0,0; -49.9999999736822,0,0,
              0,0,0,0,-2.50000000005815,0,0; 0,0,0,0,0,0,0,10.0000000002326,-10.0000000002326,
              0; 0,0,0,0,0,0,0,0,100.000000002326,-100.000000002326],
          B=[0,0; 0,0; 0,0; 0,0; 0,0; 0,20.0000016548074; 0,0.00200000016548074;
              2.49999999868411,0; 0,0; 0,0],
          C=[1,0,0,0,0,0,0,0,0,0; 0,1.00000000011134,0,0,0,0,0,0,0,0; 0,0,
              0.99999999999927,0,0,0,0,0,0,0; 0,0,0,1.00000000006264,0,0,0,0,0,0; 0,0,
              0,0,1.00000000004757,0,0,0,0,0; 0,0,0,0,0,0.999999999826474,0,0,0,0; 0,
              0,0,0,0,0,0.999999999912857,0,0,0; 0,0,0,0,0,0,0,1.00000000002326,0,0;
              0,0,0,0,0,0,0,0,1.00000000002326,0; 0,0,0,0,0,0,0,0,0,1.00000000002326;
              -0.100000008274037,0,0,0,0,0,0,0,1.00000000002326,0; 0,0,0,0,0,
              0.999999999826474,0,0,0,0; 0,0.00410404377522038,0.0910705533888705,
              0.239060202328028,0.0486994875566102,0,0,0,0,0; 0,0.334312313394889,
              0.0134167311163422,0.0352189191907436,-0.329697998696702,0,0,0,0,0],
          D=[0,0; 0,0; 0,0; 0,0; 0,0; 0,0; 0,0; 0,0; 0,0; 0,0; 0,0; 0,0; 0,0; 0,0],
          initType=Modelica.Blocks.Types.Init.InitialState,
          x_start={0.00253744713495376,3.965136266559,1.00531875113478,
              0.999279443199617,0.0750069322894724,1.03445704234505,
              0.0207763178888415,0.0501355939918311,0.0504208497418196,
              0.0504500114912884})
          annotation (Placement(transformation(extent={{34,-84},{54,-64}})));
        Modelica.Blocks.Routing.Multiplex2     multiplex2_1
          annotation (Placement(transformation(extent={{-2,-84},{18,-64}})));
        Modelica.Blocks.Sources.Pulse pulse4(
          amplitude=-0.01,
          period=T,
          offset=0,
          startTime=0.001)
          annotation (Placement(transformation(extent={{-114,-20},{-104,-10}})));
        Modelica.Blocks.Sources.Constant IN22(k=0)
          annotation (Placement(transformation(extent={{-118,-88},{-98,-68}})));
      equation
        OUT1 = G2.gen.SPEED;
        OUT2 = G2.gASTMPC.PMECH;
        OUT3 = G2.gen.ANGLE;
        OUT4 = G2.gASTMPC.TF2_out;
        OUT5 =Bus6.angle;
        OUT6 =Bus6.v;
        OUT7 =Bus6.p.vr;
        OUT8 =Bus6.p.vi;
        OUT9 = Bus5.v;
        OUT10 = Bus5.angle;
        OUT11 = G2.gen.PELEC;
        connect(T1.p, Bus2.p)
          annotation (Line(points={{-51.2,70},{-40,70}}, color={0,0,255}));
        connect(Bus1.p, T1.n)
          annotation (Line(points={{-80,70},{-68.8,70}}, color={0,0,255}));
        connect(G1.conn, Bus1.p)
          annotation (Line(points={{-91,70},{-80,70}}, color={0,0,255}));
        connect(L1.n, Bus3.p)
          annotation (Line(points={{-14.6,70},{0,70}}, color={0,0,255}));
        connect(L1.p, Bus2.p)
          annotation (Line(points={{-25.4,70},{-40,70}}, color={0,0,255}));
        connect(L2_2.n, Bus4.p) annotation (Line(points={{35.4,60},{44,60},{44,70},{
                60,70}},
                      color={0,0,255}));
        connect(L2_1.n, Bus4.p) annotation (Line(points={{35.4,80},{44,80},{44,70},{
                60,70}},
                      color={0,0,255}));
        connect(L2_1.p, Bus3.p) annotation (Line(points={{24.6,80},{16,80},{16,70},{0,
                70}}, color={0,0,255}));
        connect(L2_2.p, Bus3.p) annotation (Line(points={{24.6,60},{16,60},{16,70},{0,
                70}}, color={0,0,255}));
        connect(G2.conn, Bus6.p)
          annotation (Line(points={{21,-36},{34,-36}}, color={0,0,255}));
        connect(Load1.p, Bus3.p)
          annotation (Line(points={{-10,58},{-10,70},{0,70}}, color={0,0,255}));
        connect(L3.p, Bus4.p)
          annotation (Line(points={{80,55.4},{80,70},{60,70}}, color={0,0,255}));
        connect(breaker.s, Bus5.p)
          annotation (Line(points={{80,12},{80,6}}, color={0,0,255}));
        connect(breaker.r, L3.n)
          annotation (Line(points={{80,20},{80,44.6}},color={0,0,255}));
        connect(T2.n, Bus6.p)
          annotation (Line(points={{50,-24.8},{50,-36},{34,-36}}, color={0,0,255}));
        connect(IN1, AddU1.u1) annotation (Line(points={{-150,0},{-82,0}},
                       color={0,0,127}));
        connect(T2.p, Bus5.p) annotation (Line(points={{50,-7.2},{50,0},{80,0},{80,6}},
              color={0,0,255}));

        connect(IN2,AddU2. u1) annotation (Line(points={{-150,-60},{-82,-60}},
                       color={0,0,127}));
        connect(AddU2.y, G2.Efd_ref)
          annotation (Line(points={{-59,-66},{-10,-66},{-10,-42},{-2,-42}},
                                                                 color={0,0,127}));
        connect(AddU1.y, G2.P_ref1) annotation (Line(points={{-59,-6},{-10,-6},{-10,-30},
                {-2,-30}},                          color={0,0,127}));
        connect(IB.p, Bus4.p)
          annotation (Line(points={{100,70},{60,70}}, color={0,0,255}));
        connect(Load2.p, Bus5.p) annotation (Line(points={{110,-20},{110,0},{80,0},{80,
                6}}, color={0,0,255}));
        connect(sine.y, add.u2) annotation (Line(points={{82.5,-39},{82.5,-34},{85.2,-34},
                {85.2,-28.4}}, color={0,0,127}));
        connect(whiteNoiseInjection.y, add.u1) annotation (Line(points={{82.54,-22.06},
                {82.54,-23.6},{85.2,-23.6}}, color={0,0,127}));
        connect(add.y, Load2.u) annotation (Line(points={{94.4,-26},{94.4,-24.5},{101.9,
                -24.5}}, color={0,0,127}));
        connect(multiplex2_1.y, stateSpace.u)
          annotation (Line(points={{19,-74},{32,-74}}, color={0,0,127}));
        connect(pulse4.y, AddU1.u2) annotation (Line(points={{-103.5,-15},{-88,-15},{-88,
                -12},{-82,-12}}, color={0,0,127}));
        connect(multiplex2_1.u1[1], pulse4.y) annotation (Line(points={{-4,-68},{-50,-68},
                {-50,-30},{-94,-30},{-94,-16},{-98,-16},{-98,-15},{-103.5,-15}},
              color={0,0,127}));
        connect(IN22.y, AddU2.u2) annotation (Line(points={{-97,-78},{-90,-78},{-90,-72},
                {-82,-72}}, color={0,0,127}));
        connect(multiplex2_1.u2[1], IN22.y) annotation (Line(points={{-4,-80},{-90,-80},
                {-90,-78},{-97,-78}}, color={0,0,127}));
          annotation (Placement(transformation(extent={{140,-20},{160,0}})),
                      Placement(transformation(extent={{140,-40},{160,-20}})),
                      Placement(transformation(extent={{140,-60},{160,-40}})),
                      Placement(transformation(extent={{140,-80},{160,-60}})),
                     Diagram(coordinateSystem(preserveAspectRatio=false,
                extent={{-140,-120},{140,120}}), graphics={
              Rectangle(
                extent={{130,88},{166,-112}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Rectangle(
                extent={{-158,20},{-134,-80}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,26},{124,-112}},
                lineColor={238,46,47},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,88},{124,28}},
                lineColor={0,128,255},
                lineThickness=0.5),
              Polygon(
                points={{-124,20},{-124,-108},{72,-108},{72,-60},{0,20},{-124,20}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Text(
                extent={{74,-88},{122,-108}},
                textColor={238,46,47},
                textString="Microgrid"),
              Text(
                extent={{76,48},{128,24}},
                textColor={28,108,200},
                textString="Utility Grid"),
              Text(
                extent={{-16,-84},{70,-112}},
                textColor={0,140,72},
                textString="Linearization Unit"),
              Text(
                extent={{-164,40},{-132,20}},
                textColor={0,140,72},
                textString="Inputs"),
              Text(
                extent={{128,108},{168,88}},
                textColor={0,140,72},
                textString="Outputs")}),
          Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),experiment(
            StopTime=3,
            __Dymola_NumberOfIntervals=5000,
            __Dymola_Algorithm="Dassl"));
      end OptimizationModel03;

      model OptimizationModel04
        "THIS ONE IS STABLE, CONTROLLABLE, OBSERVABLE!!!!!!!"
        extends Modelica.Icons.Example;

        parameter Boolean equivalentGRID= true;
        parameter Boolean equivalentInfBUS = false;

        OpenIPSL.Electrical.Buses.Bus B1(v_0=powerFlow.powerflow.bus.V1, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-90,60},{-70,80}})));
        OpenIPSL.Electrical.Buses.Bus B2(v_0=powerFlow.powerflow.bus.V2, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-50,60},{-30,80}})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
          R=0.001,
          X=0.2,
          G=0,
          B=0,
          VNOM1=220000,
          VB1=220000,
          VNOM2=24000,
          VB2=24000) if not equivalentGRID annotation (Placement(transformation(
              extent={{-8,-8},{8,8}},
              rotation=180,
              origin={-60,70})));
        OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
          v_0=powerFlow.powerflow.bus.V1,
          angle_0=powerFlow.powerflow.bus.A1,
          P_0=powerFlow.powerflow.machines.PG1,
          Q_0=powerFlow.powerflow.machines.QG1,
          V_b=24000) if not equivalentGRID
          annotation (Placement(transformation(extent={{-112,60},{-92,80}})));
        OpenIPSL.Electrical.Branches.PwLine L1(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{-26,66},{-14,74}})));
        OpenIPSL.Electrical.Buses.Bus B3(v_0=powerFlow.powerflow.bus.V3, angle_0=
              powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-10,60},{10,80}})));
        OpenIPSL.Electrical.Buses.Bus B4(v_0=powerFlow.powerflow.bus.V4, angle_0=
              powerFlow.powerflow.bus.V4) if not equivalentGRID
          annotation (Placement(transformation(extent={{50,60},{70,80}})));
        OpenIPSL.Electrical.Branches.PwLine L2_1(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,76},{36,84}})));
        OpenIPSL.Electrical.Branches.PwLine L2_2(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,56},{36,64}})));
        OpenIPSL.Electrical.Buses.Bus B5(angle_0=powerFlow.powerflow.bus.A5, v_0=
              powerFlow.powerflow.bus.V5) if not equivalentGRID
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={80,6})));
        OpenIPSL.Electrical.Branches.PwLine L3(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=-90,
              origin={80,50})));
        OpenIPSL.Electrical.Buses.Bus B6(v_0=powerFlow.powerflow.bus.V6, angle_0=
              powerFlow.powerflow.bus.A6)
                                         annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={34,-36})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
          G=0,
          B=0,
          VNOM1=220000,
          VB1=220000,
          VNOM2=24000,
          VB2=24000,
          R=0.005,
          X=0.1) if not equivalentGRID annotation (Placement(transformation(
              extent={{-8,-8},{8,8}},
              rotation=270,
              origin={52,-16})));
        GenerationUnits.PSSE.G2_3INPUTS                       G2(
          enableV_b=true,
          enableP_0=true,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V6,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A6,
          V_b=24000,
          P_0=powerFlow.powerflow.machines.PG2,
          Q_0=powerFlow.powerflow.machines.QG2,
          enableangle_0=true)
                        annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={10,-36})));
        inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000, fn=60)
          annotation (Placement(transformation(extent={{-128,94},{-74,114}})));
        OpenIPSL.Electrical.Loads.PSSE.Load Load1(
          V_b=220000,
          P_0=powerFlow.powerflow.loads.PL1,
          Q_0=powerFlow.powerflow.loads.QL1,
          v_0=powerFlow.powerflow.bus.V3,
          angle_0=powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-20,36},{0,56}})));
        Electrical.Events.Breaker breaker(enableTrigger=false,
          t_o=1.01,
          rc_enabled=false) if not equivalentGRID                     annotation (Placement(transformation(
              extent={{-4,-4},{4,4}},
              rotation=90,
              origin={80,16})));

        Modelica.Blocks.Interfaces.RealInput IN1(start=0)
          "Connector of Real input signal 2" annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-150,0}), iconTransformation(extent={{-10,-10},{10,10}}, origin=
                 {-150,0})));
        Modelica.Blocks.Sources.Constant IN11(k=0)
          annotation (Placement(transformation(extent={{-120,-40},{-100,-20}})));
        Modelica.Blocks.Math.Add AddU1
          annotation (Placement(transformation(extent={{-80,-16},{-60,4}})));
        Modelica.Blocks.Sources.Constant IN22(k=0)
          annotation (Placement(transformation(extent={{-120,-100},{-100,-80}})));
        Modelica.Blocks.Math.Add AddU2
          annotation (Placement(transformation(extent={{-80,-76},{-60,-56}})));
        Modelica.Blocks.Interfaces.RealInput IN2(start=0)
          "Connector of Real input signal 2" annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-150,-60}), iconTransformation(extent={{-10,-10},{10,10}},
                origin={-150,-60})));
      Modelica.Blocks.Interfaces.RealOutput OUT1
          annotation (Placement(transformation(extent={{140,58},{160,78}})));
        Modelica.Blocks.Interfaces.RealOutput OUT2
          annotation (Placement(transformation(extent={{140,38},{160,58}})));
        Modelica.Blocks.Interfaces.RealOutput OUT3
          annotation (Placement(transformation(extent={{140,18},{160,38}})));
        Modelica.Blocks.Interfaces.RealOutput OUT4 annotation (Placement(transformation(extent={{140,-2},{160,18}})));
           Modelica.Blocks.Interfaces.RealOutput OUT5 annotation (Placement(transformation(extent={{140,-22},{160,-2}})));
           Modelica.Blocks.Interfaces.RealOutput OUT6 annotation (Placement(transformation(extent={{140,-42},{160,-22}})));
           Modelica.Blocks.Interfaces.RealOutput OUT7 annotation (Placement(transformation(extent={{140,-60},
                  {160,-40}})));
           Modelica.Blocks.Interfaces.RealOutput OUT8 annotation (Placement(transformation(extent={{140,-80},
                  {160,-60}})));
           Modelica.Blocks.Interfaces.RealOutput OUT9 annotation (Placement(transformation(extent={{140,
                  -100},{160,-80}})));

        PFData.PowerFlow powerFlow(redeclare record PowerFlow =
              OpenIPSL.Examples.ModelPredictiveControl.PFData.PF04)
          annotation (Placement(transformation(extent={{-68,94},{-48,114}})));
        Electrical.Machines.PSSE.GENCLS IB(
          V_b=220000,
          v_0=powerFlow.powerflow.bus.V4,
          angle_0=powerFlow.powerflow.bus.A4,
          P_0=powerFlow.powerflow.machines.Pinf,
          Q_0=powerFlow.powerflow.machines.Qinf,
          M_b=100000000,
          X_d=1) if not equivalentGRID annotation (Placement(transformation(extent={{110,60},{100,80}})));
        Electrical.Loads.PSSE.Load          Load2(
          P_0=powerFlow.powerflow.loads.PL2,
          Q_0=powerFlow.powerflow.loads.QL2,
          v_0=powerFlow.powerflow.bus.V5,
          angle_0=powerFlow.powerflow.bus.A5)
                    if not equivalentGRID
          annotation (Placement(transformation(extent={{98,-40},{118,-20}})));
        inner Modelica.Blocks.Noise.GlobalSeed globalSeed(useAutomaticSeed=false,
            fixedSeed=10000)
          annotation (Placement(transformation(extent={{-42,92},{-22,112}})));
      equation
        OUT1 = G2.gen.SPEED;
        OUT2 = G2.gASTMPC.PMECH;
        OUT3 = G2.gen.ANGLE;
        OUT4 = G2.gASTMPC.TF2_out;
        OUT5 = B6.angle;
        OUT6 = B6.v;
        OUT7 = B6.p.vr;
        OUT8 = B6.p.vi;
        OUT9 = G2.gen.PELEC;
        connect(T1.p,B2. p)
          annotation (Line(points={{-51.2,70},{-40,70}},        color={0,0,255}));
        connect(B1.p, T1.n)
          annotation (Line(points={{-80,70},{-68.8,70}}, color={0,0,255}));
        connect(G1.conn, B1.p)
          annotation (Line(points={{-91,70},{-80,70}}, color={0,0,255}));
        connect(L1.n,B3. p)
          annotation (Line(points={{-14.6,70},{0,70}},            color={0,0,255}));
        connect(L1.p,B2. p) annotation (Line(points={{-25.4,70},{-40,70}},
              color={0,0,255}));
        connect(L2_2.n,B4. p) annotation (Line(points={{35.4,60},{44,60},{44,70},
                {60,70}},
                      color={0,0,255}));
        connect(L2_1.n,B4. p) annotation (Line(points={{35.4,80},{44,80},{44,70},
                {60,70}},
                      color={0,0,255}));
        connect(L2_1.p,B3. p) annotation (Line(points={{24.6,80},{16,80},{16,70},
                {0,70}},     color={0,0,255}));
        connect(L2_2.p,B3. p) annotation (Line(points={{24.6,60},{16,60},{16,70},
                {0,70}},
              color={0,0,255}));
        connect(G2.conn,B6. p)
          annotation (Line(points={{21,-36},{34,-36}}, color={0,0,255}));
        connect(Load1.p, B3.p)
          annotation (Line(points={{-10,56},{-10,70},{0,70}}, color={0,0,255}));
        connect(L3.p,B4. p) annotation (Line(points={{80,55.4},{80,70},{60,70}},
                                   color={0,0,255}));
        connect(breaker.s,B5. p)
          annotation (Line(points={{80,12},{80,6}},    color={0,0,255}));
        connect(breaker.r, L3.n)
          annotation (Line(points={{80,20},{80,44.6}},color={0,0,255}));
        connect(T2.n,B6. p)
          annotation (Line(points={{52,-24.8},{52,-36},{34,-36}},
                                                         color={0,0,255}));
        connect(IN11.y, AddU1.u2) annotation (Line(points={{-99,-30},{-90,-30},{-90,-12},
                {-82,-12}}, color={0,0,127}));
        connect(IN1, AddU1.u1) annotation (Line(points={{-150,0},{-82,0}},
                       color={0,0,127}));
        connect(T2.p,B5. p) annotation (Line(points={{52,-7.2},{52,0},{80,0},{80,6}},
                              color={0,0,255}));

        connect(IN22.y,AddU2. u2) annotation (Line(points={{-99,-90},{-90,-90},{-90,-72},
                {-82,-72}},
                       color={0,0,127}));
        connect(IN2,AddU2. u1) annotation (Line(points={{-150,-60},{-82,-60}},
                       color={0,0,127}));
        connect(AddU2.y, G2.Efd_ref)
          annotation (Line(points={{-59,-66},{-10,-66},{-10,-42},{-2,-42}},
                                                                 color={0,0,127}));
        connect(AddU1.y, G2.P_ref1) annotation (Line(points={{-59,-6},{-10,-6},{-10,-30},
                {-2,-30}},                          color={0,0,127}));
        connect(IB.p, B4.p)
          annotation (Line(points={{100,70},{60,70}}, color={0,0,255}));
        connect(Load2.p, B5.p) annotation (Line(points={{108,-20},{108,0},{80,0},{80,
                6}},
              color={0,0,255}));
          annotation (Placement(transformation(extent={{140,-20},{160,0}})),
                      Placement(transformation(extent={{140,-40},{160,-20}})),
                      Placement(transformation(extent={{140,-60},{160,-40}})),
                      Placement(transformation(extent={{140,-80},{160,-60}})),
                     Diagram(coordinateSystem(preserveAspectRatio=false,
                extent={{-140,-120},{140,120}}), graphics={
              Rectangle(
                extent={{130,88},{166,-112}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Rectangle(
                extent={{-158,20},{-134,-80}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,26},{124,-112}},
                lineColor={238,46,47},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,88},{124,28}},
                lineColor={0,128,255},
                lineThickness=0.5),
              Polygon(
                points={{-124,20},{-124,-108},{72,-108},{72,-60},{0,20},{-124,20}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Text(
                extent={{74,-88},{122,-108}},
                textColor={238,46,47},
                textString="Microgrid"),
              Text(
                extent={{76,48},{128,24}},
                textColor={28,108,200},
                textString="Utility Grid"),
              Text(
                extent={{12,-84},{68,-112}},
                textColor={0,140,72},
                textString="DER Plant"),
              Text(
                extent={{-164,40},{-132,20}},
                textColor={0,140,72},
                textString="Inputs"),
              Text(
                extent={{128,108},{168,88}},
                textColor={0,140,72},
                textString="Outputs")}),
          Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),experiment(StopTime=10, __Dymola_Algorithm="Dassl"));
      end OptimizationModel04;

      model OptimizationModel05
        "THIS ONE IS STABLE, CONTROLLABLE, OBSERVABLE!!!!!!!"
        extends Modelica.Icons.Example;

        parameter Boolean equivalentGRID = true;
        parameter Boolean equivalentsystem = false;

        OpenIPSL.Electrical.Buses.Bus Bus1(v_0=powerFlow.powerflow.bus.V1, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-90,60},{-70,80}})));
        OpenIPSL.Electrical.Buses.Bus Bus2(v_0=powerFlow.powerflow.bus.V2, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-50,60},{-30,80}})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
          R=0.001,
          X=0.2,
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000)  if not equivalentGRID annotation (Placement(transformation(
              extent={{-8,-8},{8,8}},
              rotation=180,
              origin={-60,70})));
        OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
          enableV_b=true,
          v_0=powerFlow.powerflow.bus.V1,
          angle_0=powerFlow.powerflow.bus.A1,
          P_0=powerFlow.powerflow.machines.PG1,
          Q_0=powerFlow.powerflow.machines.QG1,
          V_b=6000)  if not equivalentGRID
          annotation (Placement(transformation(extent={{-112,60},{-92,80}})));
        OpenIPSL.Electrical.Branches.PwLine L1(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{-26,66},{-14,74}})));
        OpenIPSL.Electrical.Buses.Bus Bus3(v_0=powerFlow.powerflow.bus.V3, angle_0=
              powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-10,60},{10,80}})));
        OpenIPSL.Electrical.Buses.Bus Bus4(v_0=powerFlow.powerflow.bus.V4, angle_0=
              powerFlow.powerflow.bus.V4) if not equivalentGRID
          annotation (Placement(transformation(extent={{50,60},{70,80}})));
        OpenIPSL.Electrical.Branches.PwLine L2_1(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,76},{36,84}})));
        OpenIPSL.Electrical.Branches.PwLine L2_2(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,56},{36,64}})));
        OpenIPSL.Electrical.Buses.Bus Bus5(angle_0=powerFlow.powerflow.bus.A5, v_0=
              powerFlow.powerflow.bus.V5)  annotation (Placement(
              transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={80,6})));
        OpenIPSL.Electrical.Branches.PwLine L3(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=-90,
              origin={80,50})));
        OpenIPSL.Electrical.Buses.Bus Bus6(v_0=powerFlow.powerflow.bus.V6, angle_0=
              powerFlow.powerflow.bus.A6) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={34,-36})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000,
          R=0.005,
          X=0.1)  annotation (Placement(transformation(
              extent={{-8,-8},{8,8}},
              rotation=270,
              origin={50,-16})));
        GenerationUnits.PSSE.G2_16MVA                         G2(
          enableV_b=true,
          enableP_0=true,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V6,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A6,
          V_b=6000,
          P_0=powerFlow.powerflow.machines.PG2,
          Q_0=powerFlow.powerflow.machines.QG2,
          enableangle_0=true)
                        annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={10,-36})));
        inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000, fn=60)
          annotation (Placement(transformation(extent={{-128,94},{-74,114}})));
        OpenIPSL.Electrical.Loads.PSSE.Load Load1(
          V_b=220000,
          P_0=powerFlow.powerflow.loads.PL1,
          Q_0=powerFlow.powerflow.loads.QL1,
          v_0=powerFlow.powerflow.bus.V3,
          angle_0=powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-20,38},{0,58}})));
        Electrical.Events.Breaker breaker(enableTrigger=false,
          t_o=1.01,
          rc_enabled=true,
          t_rc=800.01)      if not equivalentGRID                     annotation (Placement(transformation(
              extent={{-4,-4},{4,4}},
              rotation=90,
              origin={80,16})));

        Modelica.Blocks.Interfaces.RealInput IN1(start=0)
          "Connector of Real input signal 2" annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-150,0}), iconTransformation(extent={{-10,-10},{10,10}}, origin=
                 {-150,0})));
        Modelica.Blocks.Interfaces.RealInput IN2(start=0)
          "Connector of Real input signal 2" annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-150,-60}), iconTransformation(extent={{-10,-10},{10,10}},
                origin={-150,-60})));
        Modelica.Blocks.Interfaces.RealOutput OUT1
          annotation (Placement(transformation(extent={{140,58},{160,78}})));
       Modelica.Blocks.Interfaces.RealOutput OUT2
          annotation (Placement(transformation(extent={{140,38},{160,58}})));
        Modelica.Blocks.Interfaces.RealOutput OUT3
          annotation (Placement(transformation(extent={{140,18},{160,38}})));
        Modelica.Blocks.Interfaces.RealOutput OUT4
          annotation (Placement(transformation(extent={{140,-2},{160,18}})));
        Modelica.Blocks.Interfaces.RealOutput OUT5
          annotation (Placement(transformation(extent={{140,-22},{160,-2}})));
        Modelica.Blocks.Interfaces.RealOutput OUT6
          annotation (Placement(transformation(extent={{140,-42},{160,-22}})));
        Modelica.Blocks.Interfaces.RealOutput OUT7
          annotation (Placement(transformation(extent={{140,-62},
                  {160,-42}})));
        Modelica.Blocks.Interfaces.RealOutput OUT8
          annotation (Placement(transformation(extent={{140,-82},
                  {160,-62}})));
        Modelica.Blocks.Interfaces.RealOutput OUT9    annotation (Placement(transformation(extent={{140,-42},{160,-22}})));
        Modelica.Blocks.Interfaces.RealOutput OUT10   annotation (Placement(transformation(extent={{140,-62},{160,-42}})));
        Modelica.Blocks.Interfaces.RealOutput OUT11  annotation (Placement(transformation(extent={{140,-82},{160,-62}})));
        Modelica.Blocks.Interfaces.RealOutput OUT12    annotation (Placement(transformation(extent={{140,-42},{160,-22}})));
        Modelica.Blocks.Interfaces.RealOutput OUT13   annotation (Placement(transformation(extent={{140,-62},{160,-42}})));
        Modelica.Blocks.Interfaces.RealOutput OUT14  annotation (Placement(transformation(extent={{140,-82},{160,-62}})));
        Modelica.Blocks.Interfaces.RealOutput OUT15  annotation (Placement(transformation(extent={{140,-82},{160,-62}})));

        PFData.PowerFlow powerFlow(redeclare record PowerFlow =
              OpenIPSL.Examples.ModelPredictiveControl.PFData.PF02)
          annotation (Placement(transformation(extent={{-68,94},{-48,114}})));
        Electrical.Machines.PSSE.GENCLS IB(
          V_b=220000,
          v_0=powerFlow.powerflow.bus.V4,
          angle_0=powerFlow.powerflow.bus.A4,
          P_0=powerFlow.powerflow.machines.Pinf,
          Q_0=powerFlow.powerflow.machines.Qinf,
          M_b=100000000,
          X_d=1) if not equivalentGRID annotation (Placement(transformation(extent={{110,60},{100,80}})));

        inner Modelica.Blocks.Noise.GlobalSeed globalSeed(useAutomaticSeed=false,
            fixedSeed=10000)
          annotation (Placement(transformation(extent={{-42,92},{-22,112}})));

        Electrical.Loads.PSSE.Load          Load3(
          P_0=powerFlow.powerflow.loads.PL2,
          Q_0=powerFlow.powerflow.loads.QL2,
          v_0=powerFlow.powerflow.bus.V5,
          angle_0=powerFlow.powerflow.bus.A5)
                    if not equivalentGRID
          annotation (Placement(transformation(extent={{90,-40},{110,-20}})));
      equation

        OUT1 = gen.w;
        OUT2 = G2.gen.delta;
        OUT3 = G2.gen.Epq;
        OUT4 = G2.gen.PSIkd;
        OUT5 = G2.gen.PSIppq;
        OUT6 = G2.sEXSMPC.simpleLagLim.state;
        OUT7 = G2.sEXSMPC.leadLag.TF.x[1];
        OUT8 = G2.gASTMPC.simpleLagLim.state;
        OUT9 = G2.gASTMPC.simpleLag.state;
        OUT10 = G2.gASTMPC.simpleLag1.state;
        OUT11 = G2.gASTMPC.PMECH;
        OUT12 = G2.sEXSMPC.EFD;
        OUT13 = Bus5.v;
        OUT14 = Bus5.angle;
        OUT15 = G2.gen.P;

        connect(T1.p, Bus2.p)
          annotation (Line(points={{-51.2,70},{-40,70}}, color={0,0,255}));
        connect(Bus1.p, T1.n)
          annotation (Line(points={{-80,70},{-68.8,70}}, color={0,0,255}));
        connect(G1.conn, Bus1.p)
          annotation (Line(points={{-91,70},{-80,70}}, color={0,0,255}));
        connect(L1.n, Bus3.p)
          annotation (Line(points={{-14.6,70},{0,70}}, color={0,0,255}));
        connect(L1.p, Bus2.p)
          annotation (Line(points={{-25.4,70},{-40,70}}, color={0,0,255}));
        connect(L2_2.n, Bus4.p) annotation (Line(points={{35.4,60},{44,60},{44,70},{
                60,70}},
                      color={0,0,255}));
        connect(L2_1.n, Bus4.p) annotation (Line(points={{35.4,80},{44,80},{44,70},{
                60,70}},
                      color={0,0,255}));
        connect(L2_1.p, Bus3.p) annotation (Line(points={{24.6,80},{16,80},{16,70},{0,
                70}}, color={0,0,255}));
        connect(L2_2.p, Bus3.p) annotation (Line(points={{24.6,60},{16,60},{16,70},{0,
                70}}, color={0,0,255}));
        connect(G2.conn, Bus6.p)
          annotation (Line(points={{21,-36},{34,-36}}, color={0,0,255}));
        connect(Load1.p, Bus3.p)
          annotation (Line(points={{-10,58},{-10,70},{0,70}}, color={0,0,255}));
        connect(L3.p, Bus4.p)
          annotation (Line(points={{80,55.4},{80,70},{60,70}}, color={0,0,255}));
        connect(breaker.s, Bus5.p)
          annotation (Line(points={{80,12},{80,6}}, color={0,0,255}));
        connect(breaker.r, L3.n)
          annotation (Line(points={{80,20},{80,44.6}},color={0,0,255}));
        connect(T2.n, Bus6.p)
          annotation (Line(points={{50,-24.8},{50,-36},{34,-36}}, color={0,0,255}));
        connect(T2.p, Bus5.p) annotation (Line(points={{50,-7.2},{50,0},{80,0},{80,6}},
              color={0,0,255}));

        connect(IB.p, Bus4.p)
          annotation (Line(points={{100,70},{60,70}}, color={0,0,255}));
        connect(Load3.p, Bus5.p) annotation (Line(points={{100,-20},{100,-2},{50,-2},{
                50,0},{80,0},{80,6}}, color={0,0,255}));
        connect(IN1, G2.P_ref1)
          annotation (Line(points={{-150,0},{-150,-30},{-2,-30}}, color={0,0,127}));
        connect(IN2, G2.Efd_ref) annotation (Line(points={{-150,-60},{-150,-42},{-2,-42}},
              color={0,0,127}));
          annotation (Placement(transformation(extent={{140,-20},{160,0}})),
                      Placement(transformation(extent={{140,-40},{160,-20}})),
                      Placement(transformation(extent={{140,-60},{160,-40}})),
                      Placement(transformation(extent={{140,-80},{160,-60}})),
                     Diagram(coordinateSystem(preserveAspectRatio=false,
                extent={{-140,-120},{140,120}}), graphics={
              Rectangle(
                extent={{130,88},{166,-112}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Rectangle(
                extent={{-158,20},{-134,-80}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,26},{124,-112}},
                lineColor={238,46,47},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,88},{124,28}},
                lineColor={0,128,255},
                lineThickness=0.5),
              Polygon(
                points={{-124,20},{-124,-108},{72,-108},{72,-60},{0,20},{-124,20}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Text(
                extent={{74,-88},{122,-108}},
                textColor={238,46,47},
                textString="Microgrid"),
              Text(
                extent={{76,48},{128,24}},
                textColor={28,108,200},
                textString="Utility Grid"),
              Text(
                extent={{-16,-84},{70,-112}},
                textColor={0,140,72},
                textString="Linearization Unit"),
              Text(
                extent={{-164,40},{-132,20}},
                textColor={0,140,72},
                textString="Inputs"),
              Text(
                extent={{128,108},{168,88}},
                textColor={0,140,72},
                textString="Outputs")}),
          Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),experiment(StopTime=3, __Dymola_Algorithm="Dassl"));
      end OptimizationModel05;

      model OptimizationModel06
        "THIS ONE IS STABLE, CONTROLLABLE, OBSERVABLE!!!!!!!"
        extends Modelica.Icons.Example;

        parameter Boolean equivalentGRID = false;
        parameter Boolean equivalentsystem = false;

        OpenIPSL.Electrical.Buses.Bus Bus1(v_0=powerFlow.powerflow.bus.V1, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-90,60},{-70,80}})));
        OpenIPSL.Electrical.Buses.Bus Bus2(v_0=powerFlow.powerflow.bus.V2, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-50,60},{-30,80}})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
          R=0.001,
          X=0.2,
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000)  if not equivalentGRID annotation (Placement(transformation(
              extent={{-8,-8},{8,8}},
              rotation=180,
              origin={-60,70})));
        OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
          enableV_b=true,
          v_0=powerFlow.powerflow.bus.V1,
          angle_0=powerFlow.powerflow.bus.A1,
          P_0=powerFlow.powerflow.machines.PG1,
          Q_0=powerFlow.powerflow.machines.QG1,
          V_b=6000)  if not equivalentGRID
          annotation (Placement(transformation(extent={{-112,60},{-92,80}})));
        OpenIPSL.Electrical.Branches.PwLine L1(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{-26,66},{-14,74}})));
        OpenIPSL.Electrical.Buses.Bus Bus3(v_0=powerFlow.powerflow.bus.V3, angle_0=
              powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-10,60},{10,80}})));
        OpenIPSL.Electrical.Buses.Bus Bus4(v_0=powerFlow.powerflow.bus.V4, angle_0=
              powerFlow.powerflow.bus.V4) if not equivalentGRID
          annotation (Placement(transformation(extent={{50,60},{70,80}})));
        OpenIPSL.Electrical.Branches.PwLine L2_1(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,76},{36,84}})));
        OpenIPSL.Electrical.Branches.PwLine L2_2(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,56},{36,64}})));
        inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000, fn=60)
          annotation (Placement(transformation(extent={{-128,94},{-74,114}})));
        OpenIPSL.Electrical.Loads.PSSE.Load Load1(
          V_b=220000,
          P_0=powerFlow.powerflow.loads.PL1,
          Q_0=powerFlow.powerflow.loads.QL1,
          v_0=powerFlow.powerflow.bus.V3,
          angle_0=powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-20,38},{0,58}})));

        PFData.PowerFlow powerFlow(redeclare record PowerFlow =
              OpenIPSL.Examples.ModelPredictiveControl.PFData.PF06)
          annotation (Placement(transformation(extent={{-68,94},{-48,114}})));
        Electrical.Machines.PSSE.GENCLS IB(
          V_b=220000,
          v_0=powerFlow.powerflow.bus.V4,
          angle_0=powerFlow.powerflow.bus.A4,
          P_0=powerFlow.powerflow.machines.Pinf,
          Q_0=powerFlow.powerflow.machines.Qinf,
          M_b=100000000,
          X_d=1) if not equivalentGRID annotation (Placement(transformation(extent={{110,60},{100,80}})));

        inner Modelica.Blocks.Noise.GlobalSeed globalSeed(useAutomaticSeed=false,
            fixedSeed=10000)
          annotation (Placement(transformation(extent={{-42,92},{-22,112}})));

      equation

        connect(T1.p, Bus2.p)
          annotation (Line(points={{-51.2,70},{-40,70}}, color={0,0,255}));
        connect(Bus1.p, T1.n)
          annotation (Line(points={{-80,70},{-68.8,70}}, color={0,0,255}));
        connect(G1.conn, Bus1.p)
          annotation (Line(points={{-91,70},{-80,70}}, color={0,0,255}));
        connect(L1.n, Bus3.p)
          annotation (Line(points={{-14.6,70},{0,70}}, color={0,0,255}));
        connect(L1.p, Bus2.p)
          annotation (Line(points={{-25.4,70},{-40,70}}, color={0,0,255}));
        connect(L2_2.n, Bus4.p) annotation (Line(points={{35.4,60},{44,60},{44,70},{
                60,70}},
                      color={0,0,255}));
        connect(L2_1.n, Bus4.p) annotation (Line(points={{35.4,80},{44,80},{44,70},{
                60,70}},
                      color={0,0,255}));
        connect(L2_1.p, Bus3.p) annotation (Line(points={{24.6,80},{16,80},{16,70},{0,
                70}}, color={0,0,255}));
        connect(L2_2.p, Bus3.p) annotation (Line(points={{24.6,60},{16,60},{16,70},{0,
                70}}, color={0,0,255}));
        connect(Load1.p, Bus3.p)
          annotation (Line(points={{-10,58},{-10,70},{0,70}}, color={0,0,255}));

        connect(IB.p, Bus4.p)
          annotation (Line(points={{100,70},{60,70}}, color={0,0,255}));
          annotation (Placement(transformation(extent={{140,-20},{160,0}})),
                      Placement(transformation(extent={{140,-40},{160,-20}})),
                      Placement(transformation(extent={{140,-60},{160,-40}})),
                      Placement(transformation(extent={{140,-80},{160,-60}})),
                     Diagram(coordinateSystem(preserveAspectRatio=false,
                extent={{-140,-120},{140,120}}), graphics={
              Rectangle(
                extent={{130,88},{166,-112}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Rectangle(
                extent={{-158,20},{-134,-80}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,88},{124,28}},
                lineColor={0,128,255},
                lineThickness=0.5),
              Polygon(
                points={{-124,20},{-124,-108},{72,-108},{72,-60},{0,20},{-124,20}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Text(
                extent={{74,-88},{122,-108}},
                textColor={238,46,47},
                textString="Microgrid"),
              Text(
                extent={{76,48},{128,24}},
                textColor={28,108,200},
                textString="Utility Grid"),
              Text(
                extent={{-16,-84},{70,-112}},
                textColor={0,140,72},
                textString="Linearization Unit"),
              Text(
                extent={{-164,40},{-132,20}},
                textColor={0,140,72},
                textString="Inputs"),
              Text(
                extent={{128,108},{168,88}},
                textColor={0,140,72},
                textString="Outputs")}),
          Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),experiment(StopTime=10, __Dymola_Algorithm="Dassl"));
      end OptimizationModel06;

      model OptimizationModel07
        "THIS ONE IS STABLE, CONTROLLABLE, OBSERVABLE!!!!!!!"
        extends Modelica.Icons.Example;

        parameter Boolean equivalentGRID = true;
        parameter Boolean equivalentsystem = false;

        OpenIPSL.Electrical.Buses.Bus Bus1(v_0=powerFlow.powerflow.bus.V1, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-90,60},{-70,80}})));
        OpenIPSL.Electrical.Buses.Bus Bus2(v_0=powerFlow.powerflow.bus.V2, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-50,60},{-30,80}})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
          R=0.001,
          X=0.2,
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000)  if not equivalentGRID annotation (Placement(transformation(
              extent={{-8,-8},{8,8}},
              rotation=180,
              origin={-60,70})));
        OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
          enableV_b=true,
          v_0=powerFlow.powerflow.bus.V1,
          angle_0=powerFlow.powerflow.bus.A1,
          P_0=powerFlow.powerflow.machines.PG1,
          Q_0=powerFlow.powerflow.machines.QG1,
          V_b=6000)  if not equivalentGRID
          annotation (Placement(transformation(extent={{-112,60},{-92,80}})));
        OpenIPSL.Electrical.Branches.PwLine L1(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{-26,66},{-14,74}})));
        OpenIPSL.Electrical.Buses.Bus Bus3(v_0=powerFlow.powerflow.bus.V3, angle_0=
              powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-10,60},{10,80}})));
        OpenIPSL.Electrical.Buses.Bus Bus4(v_0=powerFlow.powerflow.bus.V4, angle_0=
              powerFlow.powerflow.bus.V4) if not equivalentGRID
          annotation (Placement(transformation(extent={{50,60},{70,80}})));
        OpenIPSL.Electrical.Branches.PwLine L2_1(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,76},{36,84}})));
        OpenIPSL.Electrical.Branches.PwLine L2_2(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,56},{36,64}})));
        OpenIPSL.Electrical.Buses.Bus Bus5(angle_0=powerFlow.powerflow.bus.A5, v_0=
              powerFlow.powerflow.bus.V5)  annotation (Placement(
              transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={80,6})));
        OpenIPSL.Electrical.Branches.PwLine L3(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=-90,
              origin={80,50})));
        OpenIPSL.Electrical.Buses.Bus Bus6(v_0=powerFlow.powerflow.bus.V6, angle_0=
              powerFlow.powerflow.bus.A6) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={34,-36})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000,
          R=0.005,
          X=0.1)  annotation (Placement(transformation(
              extent={{-8,-8},{8,8}},
              rotation=270,
              origin={50,-16})));
        GenerationUnits.PSSE.G2_16MVA                         G2(
          enableV_b=true,
          enableP_0=true,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V6,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A6,
          V_b=6000,
          P_0=powerFlow.powerflow.machines.PG2,
          Q_0=powerFlow.powerflow.machines.QG2,
          enableangle_0=true)
                        annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={10,-36})));
        inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000, fn=60)
          annotation (Placement(transformation(extent={{-128,94},{-74,114}})));
        OpenIPSL.Electrical.Loads.PSSE.Load Load1(
          V_b=220000,
          P_0=powerFlow.powerflow.loads.PL1,
          Q_0=powerFlow.powerflow.loads.QL1,
          v_0=powerFlow.powerflow.bus.V3,
          angle_0=powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-20,38},{0,58}})));
        Electrical.Events.Breaker breaker(enableTrigger=false,
          t_o=5.01,
          rc_enabled=true,
          t_rc=80.01)       if not equivalentGRID                     annotation (Placement(transformation(
              extent={{-4,-4},{4,4}},
              rotation=90,
              origin={80,16})));

        Modelica.Blocks.Interfaces.RealInput IN1(start=0)
          "Connector of Real input signal 2" annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-150,0}), iconTransformation(extent={{-10,-10},{10,10}}, origin=
                 {-150,0})));
        Modelica.Blocks.Sources.Constant IN11(k=0)
          annotation (Placement(transformation(extent={{-120,-40},{-100,-20}})));
        Modelica.Blocks.Math.Add AddU1
          annotation (Placement(transformation(extent={{-80,-16},{-60,4}})));
        Modelica.Blocks.Sources.Constant IN22(k=0)
          annotation (Placement(transformation(extent={{-120,-100},{-100,-80}})));
        Modelica.Blocks.Math.Add AddU2
          annotation (Placement(transformation(extent={{-80,-76},{-60,-56}})));
        Modelica.Blocks.Interfaces.RealInput IN2(start=0)
          "Connector of Real input signal 2" annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-150,-60}), iconTransformation(extent={{-10,-10},{10,10}},
                origin={-150,-60})));
        Modelica.Blocks.Interfaces.RealOutput OUT1
          annotation (Placement(transformation(extent={{140,58},{160,78}})));
       Modelica.Blocks.Interfaces.RealOutput OUT2
          annotation (Placement(transformation(extent={{140,38},{160,58}})));
        Modelica.Blocks.Interfaces.RealOutput OUT3
          annotation (Placement(transformation(extent={{140,18},{160,38}})));
        Modelica.Blocks.Interfaces.RealOutput OUT4
          annotation (Placement(transformation(extent={{140,-2},{160,18}})));
        Modelica.Blocks.Interfaces.RealOutput OUT5
          annotation (Placement(transformation(extent={{140,-22},{160,-2}})));
        Modelica.Blocks.Interfaces.RealOutput OUT6
          annotation (Placement(transformation(extent={{140,-42},{160,-22}})));
        Modelica.Blocks.Interfaces.RealOutput OUT7
          annotation (Placement(transformation(extent={{140,-62},
                  {160,-42}})));
        Modelica.Blocks.Interfaces.RealOutput OUT8
          annotation (Placement(transformation(extent={{140,-82},{160,-62}})));
        Modelica.Blocks.Interfaces.RealOutput OUT9    annotation (Placement(transformation(extent={{140,-42},{160,-22}})));
        Modelica.Blocks.Interfaces.RealOutput OUT10   annotation (Placement(transformation(extent={{140,-62},{160,-42}})));
        Modelica.Blocks.Interfaces.RealOutput OUT11  annotation (Placement(transformation(extent={{140,-82},{160,-62}})));
        Modelica.Blocks.Interfaces.RealOutput OUT12    annotation (Placement(transformation(extent={{140,-42},{160,-22}})));
        Modelica.Blocks.Interfaces.RealOutput OUT13   annotation (Placement(transformation(extent={{140,-62},{160,-42}})));
        Modelica.Blocks.Interfaces.RealOutput OUT14  annotation (Placement(transformation(extent={{140,-82},{160,-62}})));
        Modelica.Blocks.Interfaces.RealOutput OUT15  annotation (Placement(transformation(extent={{140,-82},{160,-62}})));

        PFData.PowerFlow powerFlow(redeclare record PowerFlow =
              OpenIPSL.Examples.ModelPredictiveControl.PFData.PF01)
          annotation (Placement(transformation(extent={{-68,94},{-48,114}})));
        Electrical.Machines.PSSE.GENCLS IB(
          V_b=220000,
          v_0=powerFlow.powerflow.bus.V4,
          angle_0=powerFlow.powerflow.bus.A4,
          P_0=powerFlow.powerflow.machines.Pinf,
          Q_0=powerFlow.powerflow.machines.Qinf,
          M_b=100000000,
          X_d=1) if not equivalentGRID annotation (Placement(transformation(extent={{110,60},{100,80}})));
        Electrical.Loads.PSSE.Load_ExtInput Load2(
          P_0=powerFlow.powerflow.loads.PL2,
          Q_0=powerFlow.powerflow.loads.QL2,
          v_0=powerFlow.powerflow.bus.V5,
          angle_0=powerFlow.powerflow.bus.A5,
          d_P=0,
          t1=100,
          d_t=1000)
          annotation (Placement(transformation(extent={{100,-40},{120,-20}})));
        Electrical.Loads.NoiseInjections.WhiteNoiseInjection whiteNoiseInjection(
            active_sigma=0.0005,  samplePeriod=0.02)
          annotation (Placement(transformation(extent={{70,-30},{82,-18}})));

        inner Modelica.Blocks.Noise.GlobalSeed globalSeed(useAutomaticSeed=false,
            fixedSeed=10000)
          annotation (Placement(transformation(extent={{-42,92},{-22,112}})));
        Modelica.Blocks.Sources.Sine sine(
          amplitude=0.01,
          f=1/260,
          phase=3.1415926535898,
          startTime=5.5)
          annotation (Placement(transformation(extent={{72,-44},{82,-34}})));
        Modelica.Blocks.Math.Add add
          annotation (Placement(transformation(extent={{86,-30},{94,-22}})));

        Modelica.Blocks.Continuous.Filter filter(order=2, f_cut=0.1)
          annotation (Placement(transformation(extent={{-116,-150},{-96,-130}})));
        Modelica.Blocks.Sources.RealExpression realExpression(y=G2.gen.w)
          annotation (Placement(transformation(extent={{-152,-150},{-132,-130}})));
        Modelica.Blocks.Continuous.Filter filter1(order=2, f_cut=0.1)
          annotation (Placement(transformation(extent={{-116,-184},{-96,-164}})));
        Modelica.Blocks.Sources.RealExpression realExpression1(y=G2.sEXSMPC.leadLag.TF.x[
              1])
          annotation (Placement(transformation(extent={{-152,-184},{-132,-164}})));
        Modelica.Blocks.Continuous.Filter filter2(order=2, f_cut=0.1)
          annotation (Placement(transformation(extent={{-40,-150},{-20,-130}})));
        Modelica.Blocks.Sources.RealExpression realExpression2(y=G2.gASTMPC.simpleLag1.state)
          annotation (Placement(transformation(extent={{-76,-148},{-56,-128}})));
        Modelica.Blocks.Continuous.Filter filter3(order=2, f_cut=0.1)
          annotation (Placement(transformation(extent={{-40,-184},{-20,-164}})));
        Modelica.Blocks.Sources.RealExpression realExpression3(y=G2.gASTMPC.PMECH)
          annotation (Placement(transformation(extent={{-76,-184},{-56,-164}})));
        Modelica.Blocks.Continuous.Filter filter4(order=2, f_cut=0.1)
          annotation (Placement(transformation(extent={{36,-150},{56,-130}})));
        Modelica.Blocks.Sources.RealExpression realExpression4(y=G2.sEXSMPC.EFD)
          annotation (Placement(transformation(extent={{0,-150},{20,-130}})));
        Modelica.Blocks.Continuous.Filter filter5(order=2, f_cut=0.1)
          annotation (Placement(transformation(extent={{38,-184},{58,-164}})));
        Modelica.Blocks.Sources.RealExpression realExpression5(y=Bus5.v)
          annotation (Placement(transformation(extent={{0,-184},{20,-164}})));
        Modelica.Blocks.Continuous.Filter filter6(order=2, f_cut=0.1)
          annotation (Placement(transformation(extent={{108,-150},{128,-130}})));
        Modelica.Blocks.Sources.RealExpression realExpression6(y=Bus5.angle)
          annotation (Placement(transformation(extent={{70,-150},{90,-130}})));
        Modelica.Blocks.Continuous.Filter filter7(order=2, f_cut=0.1)
          annotation (Placement(transformation(extent={{110,-184},{130,-164}})));
        Modelica.Blocks.Sources.RealExpression realExpression7(y=G2.gen.P)
          annotation (Placement(transformation(extent={{72,-184},{92,-164}})));
          Modelica.Blocks.Continuous.Filter filter8(order=2, f_cut=0.1)
          annotation (Placement(transformation(extent={{38,-222},{58,-202}})));
        Modelica.Blocks.Sources.RealExpression realExpression8(y=G2.gen.P)
          annotation (Placement(transformation(extent={{2,-222},{22,-202}})));
          Modelica.Blocks.Continuous.Filter filter9(order=2, f_cut=0.1)
          annotation (Placement(transformation(extent={{114,-222},{134,-202}})));
        Modelica.Blocks.Sources.RealExpression realExpression9(y=G2.gen.P)
          annotation (Placement(transformation(extent={{70,-222},{90,-202}})));
      equation

        OUT1 = G2.gen.w;
        OUT2 = G2.gen.delta;
        OUT3 = G2.gen.Epq;
        OUT4 = G2.gen.PSIkd;
        OUT5 = G2.gen.PSIppq;
        OUT6 = G2.sEXSMPC.simpleLagLim.state;
        OUT7 = G2.sEXSMPC.leadLag.TF.x[1];
        OUT8 = G2.gASTMPC.simpleLagLim.state;
        OUT9 = G2.gASTMPC.simpleLag.state;
        OUT10 = G2.gASTMPC.simpleLag1.state;
        OUT11 = G2.gASTMPC.PMECH;
        OUT12 = G2.sEXSMPC.EFD;
        OUT13 = Bus5.v;
        OUT14 = Bus5.angle;
        OUT15 = G2.gen.P;

        connect(T1.p, Bus2.p)
          annotation (Line(points={{-51.2,70},{-40,70}}, color={0,0,255}));
        connect(Bus1.p, T1.n)
          annotation (Line(points={{-80,70},{-68.8,70}}, color={0,0,255}));
        connect(G1.conn, Bus1.p)
          annotation (Line(points={{-91,70},{-80,70}}, color={0,0,255}));
        connect(L1.n, Bus3.p)
          annotation (Line(points={{-14.6,70},{0,70}}, color={0,0,255}));
        connect(L1.p, Bus2.p)
          annotation (Line(points={{-25.4,70},{-40,70}}, color={0,0,255}));
        connect(L2_2.n, Bus4.p) annotation (Line(points={{35.4,60},{44,60},{44,70},{
                60,70}},
                      color={0,0,255}));
        connect(L2_1.n, Bus4.p) annotation (Line(points={{35.4,80},{44,80},{44,70},{
                60,70}},
                      color={0,0,255}));
        connect(L2_1.p, Bus3.p) annotation (Line(points={{24.6,80},{16,80},{16,70},{0,
                70}}, color={0,0,255}));
        connect(L2_2.p, Bus3.p) annotation (Line(points={{24.6,60},{16,60},{16,70},{0,
                70}}, color={0,0,255}));
        connect(G2.conn, Bus6.p)
          annotation (Line(points={{21,-36},{34,-36}}, color={0,0,255}));
        connect(Load1.p, Bus3.p)
          annotation (Line(points={{-10,58},{-10,70},{0,70}}, color={0,0,255}));
        connect(L3.p, Bus4.p)
          annotation (Line(points={{80,55.4},{80,70},{60,70}}, color={0,0,255}));
        connect(breaker.s, Bus5.p)
          annotation (Line(points={{80,12},{80,6}}, color={0,0,255}));
        connect(breaker.r, L3.n)
          annotation (Line(points={{80,20},{80,44.6}},color={0,0,255}));
        connect(T2.n, Bus6.p)
          annotation (Line(points={{50,-24.8},{50,-36},{34,-36}}, color={0,0,255}));
        connect(IN11.y, AddU1.u2) annotation (Line(points={{-99,-30},{-90,-30},{-90,-12},
                {-82,-12}}, color={0,0,127}));
        connect(IN1, AddU1.u1) annotation (Line(points={{-150,0},{-82,0}},
                       color={0,0,127}));
        connect(T2.p, Bus5.p) annotation (Line(points={{50,-7.2},{50,0},{80,0},{80,6}},
              color={0,0,255}));

        connect(IN22.y,AddU2. u2) annotation (Line(points={{-99,-90},{-90,-90},{-90,-72},
                {-82,-72}},
                       color={0,0,127}));
        connect(IN2,AddU2. u1) annotation (Line(points={{-150,-60},{-82,-60}},
                       color={0,0,127}));
        connect(AddU2.y, G2.Efd_ref)
          annotation (Line(points={{-59,-66},{-10,-66},{-10,-42},{-2,-42}},
                                                                 color={0,0,127}));
        connect(AddU1.y, G2.P_ref1) annotation (Line(points={{-59,-6},{-10,-6},{-10,-30},
                {-2,-30}},                          color={0,0,127}));
        connect(IB.p, Bus4.p)
          annotation (Line(points={{100,70},{60,70}}, color={0,0,255}));
        connect(Load2.p, Bus5.p) annotation (Line(points={{110,-20},{110,0},{80,0},{80,
                6}}, color={0,0,255}));
        connect(sine.y, add.u2) annotation (Line(points={{82.5,-39},{82.5,-34},{85.2,-34},
                {85.2,-28.4}}, color={0,0,127}));
        connect(whiteNoiseInjection.y, add.u1) annotation (Line(points={{82.54,-24.06},
                {82.54,-23.6},{85.2,-23.6}}, color={0,0,127}));
        connect(add.y, Load2.u) annotation (Line(points={{94.4,-26},{94.4,-24.5},{101.9,
                -24.5}}, color={0,0,127}));
        connect(realExpression.y, filter.u)
          annotation (Line(points={{-131,-140},{-118,-140}}, color={0,0,127}));
        connect(realExpression1.y, filter1.u)
          annotation (Line(points={{-131,-174},{-118,-174}}, color={0,0,127}));
        connect(realExpression2.y, filter2.u)
          annotation (Line(points={{-55,-138},{-48,-138},{-48,-140},{-42,-140}},
                                                           color={0,0,127}));
        connect(realExpression3.y, filter3.u)
          annotation (Line(points={{-55,-174},{-42,-174}}, color={0,0,127}));
        connect(realExpression4.y, filter4.u)
          annotation (Line(points={{21,-140},{34,-140}}, color={0,0,127}));
        connect(realExpression5.y, filter5.u)
          annotation (Line(points={{21,-174},{36,-174}}, color={0,0,127}));
        connect(realExpression6.y, filter6.u)
          annotation (Line(points={{91,-140},{106,-140}}, color={0,0,127}));
        connect(realExpression7.y, filter7.u)
          annotation (Line(points={{93,-174},{108,-174}}, color={0,0,127}));
        connect(realExpression9.y, filter9.u)
          annotation (Line(points={{91,-212},{112,-212}}, color={0,0,127}));
        connect(realExpression8.y, filter8.u)
          annotation (Line(points={{23,-212},{36,-212}}, color={0,0,127}));
          annotation (Placement(transformation(extent={{140,-20},{160,0}})),
                      Placement(transformation(extent={{140,-40},{160,-20}})),
                      Placement(transformation(extent={{140,-60},{160,-40}})),
                      Placement(transformation(extent={{140,-80},{160,-60}})),
                     Diagram(coordinateSystem(preserveAspectRatio=false,
                extent={{-140,-160},{140,120}}), graphics={
              Rectangle(
                extent={{130,88},{166,-112}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Rectangle(
                extent={{-158,20},{-134,-80}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,26},{124,-112}},
                lineColor={238,46,47},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,88},{124,28}},
                lineColor={0,128,255},
                lineThickness=0.5),
              Polygon(
                points={{-124,20},{-124,-108},{72,-108},{72,-60},{0,20},{-124,20}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Text(
                extent={{74,-88},{122,-108}},
                textColor={238,46,47},
                textString="Microgrid"),
              Text(
                extent={{76,48},{128,24}},
                textColor={28,108,200},
                textString="Utility Grid"),
              Text(
                extent={{-16,-84},{70,-112}},
                textColor={0,140,72},
                textString="Linearization Unit"),
              Text(
                extent={{-164,40},{-132,20}},
                textColor={0,140,72},
                textString="Inputs"),
              Text(
                extent={{128,108},{168,88}},
                textColor={0,140,72},
                textString="Outputs")}),
          Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),experiment(
            StopTime=10,
            __Dymola_NumberOfIntervals=100,
            __Dymola_Algorithm="Dassl"),
          Icon(coordinateSystem(extent={{-140,-160},{140,120}})));
      end OptimizationModel07;

      model OptimizationModel08
        "THIS ONE IS STABLE, CONTROLLABLE, OBSERVABLE!!!!!!!"
        extends Modelica.Icons.Example;

        parameter Boolean equivalentGRID = false;
        parameter Boolean equivalentsystem = false;

        OpenIPSL.Electrical.Buses.Bus Bus1(v_0=powerFlow.powerflow.bus.V1, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-90,60},{-70,80}})));
        OpenIPSL.Electrical.Buses.Bus Bus2(v_0=powerFlow.powerflow.bus.V2, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-50,60},{-30,80}})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
          R=0.001,
          X=0.2,
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000)  if not equivalentGRID annotation (Placement(transformation(
              extent={{-8,-8},{8,8}},
              rotation=180,
              origin={-60,70})));
        OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
          enableV_b=true,
          v_0=powerFlow.powerflow.bus.V1,
          angle_0=powerFlow.powerflow.bus.A1,
          P_0=powerFlow.powerflow.machines.PG1,
          Q_0=powerFlow.powerflow.machines.QG1,
          V_b=6000)  if not equivalentGRID
          annotation (Placement(transformation(extent={{-112,60},{-92,80}})));
        OpenIPSL.Electrical.Branches.PwLine L1(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{-26,66},{-14,74}})));
        OpenIPSL.Electrical.Buses.Bus Bus3(v_0=powerFlow.powerflow.bus.V3, angle_0=
              powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-10,60},{10,80}})));
        OpenIPSL.Electrical.Buses.Bus Bus4(v_0=powerFlow.powerflow.bus.V4, angle_0=
              powerFlow.powerflow.bus.V4) if not equivalentGRID
          annotation (Placement(transformation(extent={{50,60},{70,80}})));
        OpenIPSL.Electrical.Branches.PwLine L2_1(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,76},{36,84}})));
        OpenIPSL.Electrical.Branches.PwLine L2_2(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,56},{36,64}})));
        OpenIPSL.Electrical.Buses.Bus Bus5(angle_0=powerFlow.powerflow.bus.A5, v_0=
              powerFlow.powerflow.bus.V5)  annotation (Placement(
              transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={80,6})));
        OpenIPSL.Electrical.Branches.PwLine L3(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=-90,
              origin={80,50})));
        OpenIPSL.Electrical.Buses.Bus Bus6(v_0=powerFlow.powerflow.bus.V6, angle_0=
              powerFlow.powerflow.bus.A6) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={34,-36})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000,
          R=0.005,
          X=0.1)  annotation (Placement(transformation(
              extent={{-8,-8},{8,8}},
              rotation=270,
              origin={50,-16})));
        GenerationUnits.PSSE.G2_16MVA                         G2(
          enableV_b=true,
          enableP_0=true,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V6,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A6,
          V_b=6000,
          P_0=powerFlow.powerflow.machines.PG2,
          Q_0=powerFlow.powerflow.machines.QG2,
          enableangle_0=true)
                        annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={10,-36})));
        inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000, fn=60)
          annotation (Placement(transformation(extent={{-128,94},{-74,114}})));
        OpenIPSL.Electrical.Loads.PSSE.Load Load1(
          V_b=220000,
          P_0=powerFlow.powerflow.loads.PL1,
          Q_0=powerFlow.powerflow.loads.QL1,
          v_0=powerFlow.powerflow.bus.V3,
          angle_0=powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-20,38},{0,58}})));
        Electrical.Events.Breaker breaker(enableTrigger=false,
          t_o=5.01,
          rc_enabled=true,
          t_rc=80.01)       if not equivalentGRID                     annotation (Placement(transformation(
              extent={{-4,-4},{4,4}},
              rotation=90,
              origin={80,16})));

        Modelica.Blocks.Interfaces.RealInput IN1(start=0)
          "Connector of Real input signal 2" annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-150,0}), iconTransformation(extent={{-10,-10},{10,10}}, origin=
                 {-150,0})));
        Modelica.Blocks.Sources.Constant IN11(k=0)
          annotation (Placement(transformation(extent={{-120,-40},{-100,-20}})));
        Modelica.Blocks.Math.Add AddU1
          annotation (Placement(transformation(extent={{-80,-16},{-60,4}})));
        Modelica.Blocks.Sources.Constant IN22(k=0)
          annotation (Placement(transformation(extent={{-120,-100},{-100,-80}})));
        Modelica.Blocks.Math.Add AddU2
          annotation (Placement(transformation(extent={{-80,-76},{-60,-56}})));
        Modelica.Blocks.Interfaces.RealInput IN2(start=0)
          "Connector of Real input signal 2" annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-150,-60}), iconTransformation(extent={{-10,-10},{10,10}},
                origin={-150,-60})));
        Modelica.Blocks.Interfaces.RealOutput OUT1
          annotation (Placement(transformation(extent={{140,58},{160,78}})));
       //Modelica.Blocks.Interfaces.RealOutput OUT2
       //   annotation (Placement(transformation(extent={{140,38},{160,58}})));
       // Modelica.Blocks.Interfaces.RealOutput OUT3
        //  annotation (Placement(transformation(extent={{140,18},{160,38}})));
        //Modelica.Blocks.Interfaces.RealOutput OUT4
         // annotation (Placement(transformation(extent={{140,-2},{160,18}})));
        //Modelica.Blocks.Interfaces.RealOutput OUT5
         // annotation (Placement(transformation(extent={{140,-22},{160,-2}})));
       // Modelica.Blocks.Interfaces.RealOutput OUT6
        //  annotation (Placement(transformation(extent={{140,-42},{160,-22}})));
        Modelica.Blocks.Interfaces.RealOutput OUT7
          annotation (Placement(transformation(extent={{140,-62},
                  {160,-42}})));
       // Modelica.Blocks.Interfaces.RealOutput OUT8
       //   annotation (Placement(transformation(extent={{140,-82},
              //    {160,-62}})));
        //Modelica.Blocks.Interfaces.RealOutput OUT9    annotation (Placement(transformation(extent={{140,-42},{160,-22}})));
        Modelica.Blocks.Interfaces.RealOutput OUT10   annotation (Placement(transformation(extent={{140,-62},{160,-42}})));
        Modelica.Blocks.Interfaces.RealOutput OUT11  annotation (Placement(transformation(extent={{140,-82},{160,-62}})));
        Modelica.Blocks.Interfaces.RealOutput OUT12    annotation (Placement(transformation(extent={{140,-42},{160,-22}})));
        Modelica.Blocks.Interfaces.RealOutput OUT13   annotation (Placement(transformation(extent={{140,-62},{160,-42}})));
        Modelica.Blocks.Interfaces.RealOutput OUT14  annotation (Placement(transformation(extent={{140,-82},{160,-62}})));
        Modelica.Blocks.Interfaces.RealOutput OUT15  annotation (Placement(transformation(extent={{140,-82},{160,-62}})));

        PFData.PowerFlow powerFlow(redeclare record PowerFlow =
              OpenIPSL.Examples.ModelPredictiveControl.PFData.PF01)
          annotation (Placement(transformation(extent={{-68,94},{-48,114}})));
        Electrical.Machines.PSSE.GENCLS IB(
          V_b=220000,
          v_0=powerFlow.powerflow.bus.V4,
          angle_0=powerFlow.powerflow.bus.A4,
          P_0=powerFlow.powerflow.machines.Pinf,
          Q_0=powerFlow.powerflow.machines.Qinf,
          M_b=100000000,
          X_d=1) if not equivalentGRID annotation (Placement(transformation(extent={{110,60},{100,80}})));
        Electrical.Loads.PSSE.Load_ExtInput Load2(
          P_0=powerFlow.powerflow.loads.PL2,
          Q_0=powerFlow.powerflow.loads.QL2,
          v_0=powerFlow.powerflow.bus.V5,
          angle_0=powerFlow.powerflow.bus.A5,
          d_P=0,
          t1=100,
          d_t=1000)
          annotation (Placement(transformation(extent={{100,-40},{120,-20}})));
        Electrical.Loads.NoiseInjections.WhiteNoiseInjection whiteNoiseInjection(
            active_sigma=0.0005,  samplePeriod=0.02)
          annotation (Placement(transformation(extent={{70,-30},{82,-18}})));

        inner Modelica.Blocks.Noise.GlobalSeed globalSeed(useAutomaticSeed=false,
            fixedSeed=10000)
          annotation (Placement(transformation(extent={{-42,92},{-22,112}})));
        Modelica.Blocks.Sources.Sine sine(
          amplitude=0.01,
          f=1/260,
          phase=3.1415926535898,
          startTime=5.5)
          annotation (Placement(transformation(extent={{72,-44},{82,-34}})));
        Modelica.Blocks.Math.Add add
          annotation (Placement(transformation(extent={{86,-30},{94,-22}})));

      equation

        OUT1 = G2.gen.w;
        OUT2 = G2.gen.delta;
        OUT3 = G2.gen.Epq;
        OUT4 = G2.gen.PSIkd;
        OUT5 = G2.gen.PSIppq;
        OUT6 = G2.sEXSMPC.simpleLagLim.state;
        OUT7 = G2.sEXSMPC.leadLag.TF.x[1];
        OUT8 = G2.gASTMPC.simpleLagLim.state;
        OUT9 = G2.gASTMPC.simpleLag.state;
        OUT10 = G2.gASTMPC.simpleLag1.state;
        OUT11 = G2.gASTMPC.PMECH;
        OUT12 = G2.sEXSMPC.EFD;
        OUT13 = Bus5.v;
        OUT14 = Bus5.angle;
        OUT15 = G2.gen.P;

        connect(T1.p, Bus2.p)
          annotation (Line(points={{-51.2,70},{-40,70}}, color={0,0,255}));
        connect(Bus1.p, T1.n)
          annotation (Line(points={{-80,70},{-68.8,70}}, color={0,0,255}));
        connect(G1.conn, Bus1.p)
          annotation (Line(points={{-91,70},{-80,70}}, color={0,0,255}));
        connect(L1.n, Bus3.p)
          annotation (Line(points={{-14.6,70},{0,70}}, color={0,0,255}));
        connect(L1.p, Bus2.p)
          annotation (Line(points={{-25.4,70},{-40,70}}, color={0,0,255}));
        connect(L2_2.n, Bus4.p) annotation (Line(points={{35.4,60},{44,60},{44,70},{
                60,70}},
                      color={0,0,255}));
        connect(L2_1.n, Bus4.p) annotation (Line(points={{35.4,80},{44,80},{44,70},{
                60,70}},
                      color={0,0,255}));
        connect(L2_1.p, Bus3.p) annotation (Line(points={{24.6,80},{16,80},{16,70},{0,
                70}}, color={0,0,255}));
        connect(L2_2.p, Bus3.p) annotation (Line(points={{24.6,60},{16,60},{16,70},{0,
                70}}, color={0,0,255}));
        connect(G2.conn, Bus6.p)
          annotation (Line(points={{21,-36},{34,-36}}, color={0,0,255}));
        connect(Load1.p, Bus3.p)
          annotation (Line(points={{-10,58},{-10,70},{0,70}}, color={0,0,255}));
        connect(L3.p, Bus4.p)
          annotation (Line(points={{80,55.4},{80,70},{60,70}}, color={0,0,255}));
        connect(breaker.s, Bus5.p)
          annotation (Line(points={{80,12},{80,6}}, color={0,0,255}));
        connect(breaker.r, L3.n)
          annotation (Line(points={{80,20},{80,44.6}},color={0,0,255}));
        connect(T2.n, Bus6.p)
          annotation (Line(points={{50,-24.8},{50,-36},{34,-36}}, color={0,0,255}));
        connect(IN11.y, AddU1.u2) annotation (Line(points={{-99,-30},{-90,-30},{-90,-12},
                {-82,-12}}, color={0,0,127}));
        connect(IN1, AddU1.u1) annotation (Line(points={{-150,0},{-82,0}},
                       color={0,0,127}));
        connect(T2.p, Bus5.p) annotation (Line(points={{50,-7.2},{50,0},{80,0},{80,6}},
              color={0,0,255}));

        connect(IN22.y,AddU2. u2) annotation (Line(points={{-99,-90},{-90,-90},{-90,-72},
                {-82,-72}},
                       color={0,0,127}));
        connect(IN2,AddU2. u1) annotation (Line(points={{-150,-60},{-82,-60}},
                       color={0,0,127}));
        connect(AddU2.y, G2.Efd_ref)
          annotation (Line(points={{-59,-66},{-10,-66},{-10,-42},{-2,-42}},
                                                                 color={0,0,127}));
        connect(AddU1.y, G2.P_ref1) annotation (Line(points={{-59,-6},{-10,-6},{-10,-30},
                {-2,-30}},                          color={0,0,127}));
        connect(IB.p, Bus4.p)
          annotation (Line(points={{100,70},{60,70}}, color={0,0,255}));
        connect(Load2.p, Bus5.p) annotation (Line(points={{110,-20},{110,0},{80,0},{80,
                6}}, color={0,0,255}));
        connect(sine.y, add.u2) annotation (Line(points={{82.5,-39},{82.5,-34},{85.2,-34},
                {85.2,-28.4}}, color={0,0,127}));
        connect(whiteNoiseInjection.y, add.u1) annotation (Line(points={{82.54,-24.06},
                {82.54,-23.6},{85.2,-23.6}}, color={0,0,127}));
        connect(add.y, Load2.u) annotation (Line(points={{94.4,-26},{94.4,-24.5},{101.9,
                -24.5}}, color={0,0,127}));
          annotation (Placement(transformation(extent={{140,-20},{160,0}})),
                      Placement(transformation(extent={{140,-40},{160,-20}})),
                      Placement(transformation(extent={{140,-60},{160,-40}})),
                      Placement(transformation(extent={{140,-80},{160,-60}})),
                     Diagram(coordinateSystem(preserveAspectRatio=false,
                extent={{-140,-120},{140,120}}), graphics={
              Rectangle(
                extent={{130,88},{166,-112}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Rectangle(
                extent={{-158,20},{-134,-80}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,26},{124,-112}},
                lineColor={238,46,47},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,88},{124,28}},
                lineColor={0,128,255},
                lineThickness=0.5),
              Polygon(
                points={{-124,20},{-124,-108},{72,-108},{72,-60},{0,20},{-124,20}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Text(
                extent={{74,-88},{122,-108}},
                textColor={238,46,47},
                textString="Microgrid"),
              Text(
                extent={{76,48},{128,24}},
                textColor={28,108,200},
                textString="Utility Grid"),
              Text(
                extent={{-16,-84},{70,-112}},
                textColor={0,140,72},
                textString="Linearization Unit"),
              Text(
                extent={{-164,40},{-132,20}},
                textColor={0,140,72},
                textString="Inputs"),
              Text(
                extent={{128,108},{168,88}},
                textColor={0,140,72},
                textString="Outputs")}),
          Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),experiment(
            StopTime=10,
            __Dymola_NumberOfIntervals=100,
            __Dymola_Algorithm="Dassl"));
      end OptimizationModel08;

      model OptimizationCheck "THIS ONE IS STABLE, CONTROLLABLE, OBSERVABLE!!!!!!!"
        extends Modelica.Icons.Example;

        parameter Boolean equivalentGRID = false;
        parameter Boolean equivalentInfBUS = false;

        OpenIPSL.Electrical.Buses.Bus B1(v_0=powerFlow.powerflow.bus.V1, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-90,60},{-70,80}})));
        OpenIPSL.Electrical.Buses.Bus B2(v_0=powerFlow.powerflow.bus.V2, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-50,60},{-30,80}})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
          R=0.001,
          X=0.2,
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000)  if not equivalentGRID annotation (Placement(transformation(
              extent={{-8,-8},{8,8}},
              rotation=180,
              origin={-60,70})));
        OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
          enableV_b=true,
          v_0=powerFlow.powerflow.bus.V1,
          angle_0=powerFlow.powerflow.bus.A1,
          P_0=powerFlow.powerflow.machines.PG1,
          Q_0=powerFlow.powerflow.machines.QG1,
          V_b=6000)  if not equivalentGRID
          annotation (Placement(transformation(extent={{-112,60},{-92,80}})));
        OpenIPSL.Electrical.Branches.PwLine L1(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{-26,66},{-14,74}})));
        OpenIPSL.Electrical.Buses.Bus B3(v_0=powerFlow.powerflow.bus.V3, angle_0=
              powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-10,60},{10,80}})));
        OpenIPSL.Electrical.Buses.Bus B4(v_0=powerFlow.powerflow.bus.V4, angle_0=
              powerFlow.powerflow.bus.V4) if not equivalentGRID
          annotation (Placement(transformation(extent={{50,60},{70,80}})));
        OpenIPSL.Electrical.Branches.PwLine L2_1(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,76},{36,84}})));
        OpenIPSL.Electrical.Branches.PwLine L2_2(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,56},{36,64}})));
        OpenIPSL.Electrical.Buses.Bus B5(angle_0=powerFlow.powerflow.bus.A5, v_0=
              powerFlow.powerflow.bus.V5) if not equivalentGRID
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={80,6})));
        OpenIPSL.Electrical.Branches.PwLine L3(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=-90,
              origin={80,50})));
        OpenIPSL.Electrical.Buses.Bus B6(v_0=powerFlow.powerflow.bus.V6, angle_0=
              powerFlow.powerflow.bus.A6)
                                         annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={34,-36})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000,
          R=0.005,
          X=0.1) if not equivalentGRID annotation (Placement(transformation(
              extent={{-8,-8},{8,8}},
              rotation=270,
              origin={50,-16})));
        GenerationUnits.PSSE.G2_16MVA                         G2(
          enableV_b=true,
          enableP_0=true,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V6,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A6,
          V_b=6000,
          P_0=powerFlow.powerflow.machines.PG2,
          Q_0=powerFlow.powerflow.machines.QG2,
          enableangle_0=true)
                        annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={10,-36})));
        inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000, fn=60)
          annotation (Placement(transformation(extent={{-128,94},{-74,114}})));
        OpenIPSL.Electrical.Loads.PSSE.Load Load1(
          V_b=220000,
          P_0=powerFlow.powerflow.loads.PL1,
          Q_0=powerFlow.powerflow.loads.QL1,
          v_0=powerFlow.powerflow.bus.V3,
          angle_0=powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-20,36},{0,56}})));
        Electrical.Events.Breaker breaker(enableTrigger=false,
          t_o=1.01,
          rc_enabled=true,
          t_rc=80.01)       if not equivalentGRID                     annotation (Placement(transformation(
              extent={{-4,-4},{4,4}},
              rotation=90,
              origin={80,16})));

        //       Modelica.Blocks.Interfaces.RealOutput OUT9 annotation (Placement(transformation(extent={{140,-60},{160,-40}})));
        //   Modelica.Blocks.Interfaces.RealOutput OUT10 annotation (Placement(transformation(extent={{140,-80}, {160,-60}})));
         //      Modelica.Blocks.Interfaces.RealOutput OUT10
         // annotation (Placement(transformation(extent={{140,-116},{160,-96}})));

        PFData.PowerFlow powerFlow(redeclare record PowerFlow =
              OpenIPSL.Examples.ModelPredictiveControl.PFData.PF03)
          annotation (Placement(transformation(extent={{-68,96},{-48,116}})));
        Electrical.Machines.PSSE.GENCLS IB(
          V_b=220000,
          v_0=powerFlow.powerflow.bus.V4,
          angle_0=powerFlow.powerflow.bus.A4,
          P_0=powerFlow.powerflow.machines.Pinf,
          Q_0=powerFlow.powerflow.machines.Qinf,
          M_b=100000000,
          X_d=1) if not equivalentGRID annotation (Placement(transformation(extent={{110,60},{100,80}})));
        Electrical.Loads.PSSE.Load_ExtInput Load2(
          P_0=powerFlow.powerflow.loads.PL2,
          Q_0=powerFlow.powerflow.loads.QL2,
          v_0=powerFlow.powerflow.bus.V5,
          angle_0=powerFlow.powerflow.bus.A5,
          d_P=0,
          t1=100,
          d_t=1000) if not equivalentGRID
          annotation (Placement(transformation(extent={{100,-40},{120,-20}})));
        Electrical.Loads.NoiseInjections.WhiteNoiseInjection whiteNoiseInjection(
            active_sigma=0.0000000005,
                                  samplePeriod=0.02)
                                 if not equivalentGRID
          annotation (Placement(transformation(extent={{70,-28},{82,-16}})));
        inner Modelica.Blocks.Noise.GlobalSeed globalSeed(useAutomaticSeed=false,
            fixedSeed=10000)
          annotation (Placement(transformation(extent={{-42,92},{-22,112}})));
        Electrical.Loads.PSSE.Load Load_for_Lin(
          V_b=220000,
          P_0=powerFlow.powerflow.machines.PG2,
          Q_0=powerFlow.powerflow.machines.QG2,
          v_0=powerFlow.powerflow.bus.V6,
          angle_0=powerFlow.powerflow.bus.A6) if equivalentGRID annotation (Placement(
              transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={42,-70})));
        Modelica.Blocks.Sources.Sine sine(
          amplitude=0,
          f=1/260,
          phase=3.1415926535898,
          startTime=5.5)
                       if not equivalentGRID
          annotation (Placement(transformation(extent={{72,-44},{82,-34}})));
        Modelica.Blocks.Math.Add add if not equivalentGRID
          annotation (Placement(transformation(extent={{86,-30},{94,-22}})));
        Modelica.Blocks.Sources.CombiTimeTable combiTimeTable(table=[0,0; 0.5,-2.74e-16;
              1,1.23e-16; 1.5,-0.023553414; 2,0.00226445; 2.5,-0.000819532; 3,-0.000893047;
              3.5,-0.000556498; 4,0.000878186; 4.5,0.000122204; 5,0.000654087; 5.5,
              0.001129671; 6,0.00068535; 6.5,0.001316455; 7,0.00113267; 7.5,
              0.001340342; 8,0.001660903; 8.5,0.001058399; 9,0.001485748; 9.5,
              0.001592657; 10,0.001172465; 10.5,0.001786355; 11,0.001258804; 11.5,
              0.001414307; 12,0.001851642; 12.5,0.001654247; 13,0.001478177; 13.5,
              0.001573347; 14,0.00144412; 14.5,0.001425876; 15,0.001481962; 15.5,
              0.001685424; 16,0.001280223; 16.5,0.002188429; 17,0.001212146; 17.5,
              0.001057434; 18,0.002316195; 18.5,0.000823138; 19,0.001872715; 19.5,
              0.002281925; 20,0.000212087; 20.5,0.00178869; 21,0.001550175; 21.5,
              0.001323849; 22,0.001369638; 22.5,0.00158283; 23,0.001811996; 23.5,
              0.00161486; 24,0.001157025; 24.5,0.001801794],
            smoothness=Modelica.Blocks.Types.Smoothness.ConstantSegments)
          annotation (Placement(transformation(extent={{-100,-22},{-80,-2}})));
        Modelica.Blocks.Sources.CombiTimeTable combiTimeTable1(table=[0,0; 0.5,
              1.8e-12; 1,3.6e-12; 1.5,0.05; 2,0.1; 2.5,0.15; 3,0.2; 3.5,0.25; 4,
              0.263776487; 4.5,0.248614171; 5,0.25716742; 5.5,0.260606863; 6,
              0.265122641; 6.5,0.267769058; 7,0.270142912; 7.5,0.272213427; 8,
              0.273112005; 8.5,0.274493162; 9,0.275297708; 9.5,0.275799832; 10,
              0.276775287; 10.5,0.27692303; 11,0.277860691; 11.5,0.277428421; 12,
              0.277819019; 12.5,0.277601462; 13,0.278020966; 13.5,0.277941926; 14,
              0.277907842; 14.5,0.279245122; 15,0.277951751; 15.5,0.278432571; 16,
              0.277688224; 16.5,0.2780227; 17,0.278208204; 17.5,0.278856276; 18,
              0.277871199; 18.5,0.278786755; 19,0.278471166; 19.5,0.277629014; 20,
              0.278792724; 20.5,0.278436379; 21,0.278419601; 21.5,0.278409225; 22,
              0.278597382; 22.5,0.278101802; 23,0.278311091; 23.5,0.278380683; 24,
              0.279124937; 24.5,0.278239024],
            smoothness=Modelica.Blocks.Types.Smoothness.ConstantSegments)
          annotation (Placement(transformation(extent={{-100,-80},{-80,-60}})));
      equation
        connect(T1.p,B2. p)
          annotation (Line(points={{-51.2,70},{-40,70}},        color={0,0,255}));
        connect(B1.p, T1.n)
          annotation (Line(points={{-80,70},{-68.8,70}}, color={0,0,255}));
        connect(G1.conn, B1.p)
          annotation (Line(points={{-91,70},{-80,70}}, color={0,0,255}));
        connect(L1.n,B3. p)
          annotation (Line(points={{-14.6,70},{0,70}},            color={0,0,255}));
        connect(L1.p,B2. p) annotation (Line(points={{-25.4,70},{-40,70}},
              color={0,0,255}));
        connect(L2_2.n,B4. p) annotation (Line(points={{35.4,60},{44,60},{44,70},
                {60,70}},
                      color={0,0,255}));
        connect(L2_1.n,B4. p) annotation (Line(points={{35.4,80},{44,80},{44,70},
                {60,70}},
                      color={0,0,255}));
        connect(L2_1.p,B3. p) annotation (Line(points={{24.6,80},{16,80},{16,70},
                {0,70}},     color={0,0,255}));
        connect(L2_2.p,B3. p) annotation (Line(points={{24.6,60},{16,60},{16,70},
                {0,70}},
              color={0,0,255}));
        connect(G2.conn,B6. p)
          annotation (Line(points={{21,-36},{34,-36}}, color={0,0,255}));
        connect(Load1.p, B3.p)
          annotation (Line(points={{-10,56},{-10,70},{0,70}}, color={0,0,255}));
        connect(L3.p,B4. p) annotation (Line(points={{80,55.4},{80,70},{60,70}},
                                   color={0,0,255}));
        connect(breaker.s,B5. p)
          annotation (Line(points={{80,12},{80,6}},    color={0,0,255}));
        connect(breaker.r, L3.n)
          annotation (Line(points={{80,20},{80,44.6}},color={0,0,255}));
        connect(T2.n,B6. p)
          annotation (Line(points={{50,-24.8},{50,-36},{34,-36}},
                                                         color={0,0,255}));
        connect(T2.p,B5. p) annotation (Line(points={{50,-7.2},{50,0},{80,0},{80,6}},
                              color={0,0,255}));

        connect(IB.p, B4.p)
          annotation (Line(points={{100,70},{60,70}}, color={0,0,255}));
        connect(Load2.p, B5.p) annotation (Line(points={{110,-20},{110,0},{80,0},{80,6}},
              color={0,0,255}));
        connect(Load_for_Lin.p, B6.p)
          annotation (Line(points={{42,-60},{42,-36},{34,-36}}, color={0,0,255}));
        connect(sine.y, add.u2) annotation (Line(points={{82.5,-39},{82.5,-34},{85.2,-34},
                {85.2,-28.4}}, color={0,0,127}));
        connect(whiteNoiseInjection.y, add.u1) annotation (Line(points={{82.54,-22.06},
                {82.54,-23.6},{85.2,-23.6}}, color={0,0,127}));
        connect(add.y, Load2.u) annotation (Line(points={{94.4,-26},{94.4,-24.5},{101.9,
                -24.5}}, color={0,0,127}));
        connect(combiTimeTable.y[1], G2.P_ref1) annotation (Line(points={{-79,-12},{
                -10,-12},{-10,-30},{-2,-30}}, color={0,0,127}));
        connect(combiTimeTable1.y[1], G2.Efd_ref) annotation (Line(points={{-79,-70},
                {-10,-70},{-10,-42},{-2,-42}}, color={0,0,127}));
          annotation (Placement(transformation(extent={{140,-20},{160,0}})),
                      Placement(transformation(extent={{140,-40},{160,-20}})),
                      Placement(transformation(extent={{140,-60},{160,-40}})),
                      Placement(transformation(extent={{140,-80},{160,-60}})),
                     Diagram(coordinateSystem(preserveAspectRatio=false,
                extent={{-140,-120},{140,120}}), graphics={
              Rectangle(
                extent={{-128,26},{124,-112}},
                lineColor={238,46,47},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,88},{124,28}},
                lineColor={0,128,255},
                lineThickness=0.5),
              Polygon(
                points={{-124,20},{-124,-108},{72,-108},{72,-60},{0,20},{-124,20}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Text(
                extent={{74,-88},{122,-108}},
                textColor={238,46,47},
                textString="Microgrid"),
              Text(
                extent={{76,48},{128,24}},
                textColor={28,108,200},
                textString="Utility Grid"),
              Text(
                extent={{-16,-84},{70,-112}},
                textColor={0,140,72},
                textString="Linearization Unit")}),
          Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),experiment(
            StopTime=25,
            __Dymola_NumberOfIntervals=1000,
            __Dymola_Algorithm="Dassl"));
      end OptimizationCheck;

      model OptimizationModel10 "THIS ONE IS STABLE, CONTROLLABLE, OBSERVABLE!!!!!!!"
        extends Modelica.Icons.Example;

        parameter Boolean equivalentGRID = false;
        parameter Boolean equivalentsystem = false;

        OpenIPSL.Electrical.Buses.Bus Bus1(v_0=powerFlow.powerflow.bus.V1, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-90,60},{-70,80}})));
        OpenIPSL.Electrical.Buses.Bus Bus2(v_0=powerFlow.powerflow.bus.V2, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-50,60},{-30,80}})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
          R=0.001,
          X=0.2,
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000)  if not equivalentGRID annotation (Placement(transformation(
              extent={{-8,-8},{8,8}},
              rotation=180,
              origin={-60,70})));
        OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
          enableV_b=true,
          v_0=powerFlow.powerflow.bus.V1,
          angle_0=powerFlow.powerflow.bus.A1,
          P_0=powerFlow.powerflow.machines.PG1,
          Q_0=powerFlow.powerflow.machines.QG1,
          V_b=6000)  if not equivalentGRID
          annotation (Placement(transformation(extent={{-112,60},{-92,80}})));
        OpenIPSL.Electrical.Branches.PwLine L1(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{-26,66},{-14,74}})));
        OpenIPSL.Electrical.Buses.Bus Bus3(v_0=powerFlow.powerflow.bus.V3, angle_0=
              powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-10,60},{10,80}})));
        OpenIPSL.Electrical.Buses.Bus Bus4(v_0=powerFlow.powerflow.bus.V4, angle_0=
              powerFlow.powerflow.bus.V4) if not equivalentGRID
          annotation (Placement(transformation(extent={{50,60},{70,80}})));
        OpenIPSL.Electrical.Branches.PwLine L2_1(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,76},{36,84}})));
        OpenIPSL.Electrical.Branches.PwLine L2_2(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,56},{36,64}})));
        OpenIPSL.Electrical.Buses.Bus Bus5(angle_0=powerFlow.powerflow.bus.A5, v_0=
              powerFlow.powerflow.bus.V5)  annotation (Placement(
              transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={80,6})));
        OpenIPSL.Electrical.Branches.PwLine L3(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=-90,
              origin={80,50})));
        OpenIPSL.Electrical.Buses.Bus Bus6(v_0=powerFlow.powerflow.bus.V6, angle_0=
              powerFlow.powerflow.bus.A6) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={34,-36})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000,
          R=0.005,
          X=0.1)  annotation (Placement(transformation(
              extent={{-8,-8},{8,8}},
              rotation=270,
              origin={50,-16})));
        GenerationUnits.PSSE.G2_16MVA                         G2(
          enableV_b=true,
          enableP_0=true,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V6,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A6,
          V_b=6000,
          P_0=powerFlow.powerflow.machines.PG2,
          Q_0=powerFlow.powerflow.machines.QG2,
          enableangle_0=true)
                        annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={10,-36})));
        inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000, fn=60)
          annotation (Placement(transformation(extent={{-128,94},{-74,114}})));
        OpenIPSL.Electrical.Loads.PSSE.Load Load1(
          V_b=220000,
          P_0=powerFlow.powerflow.loads.PL1,
          Q_0=powerFlow.powerflow.loads.QL1,
          v_0=powerFlow.powerflow.bus.V3,
          angle_0=powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-20,38},{0,58}})));
        Electrical.Events.Breaker breaker(enableTrigger=false,
          t_o=5.01,
          rc_enabled=true,
          t_rc=80.01)       if not equivalentGRID                     annotation (Placement(transformation(
              extent={{-4,-4},{4,4}},
              rotation=90,
              origin={80,16})));

        Modelica.Blocks.Interfaces.RealInput IN1(start=0)
          "Connector of Real input signal 2" annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-150,0}), iconTransformation(extent={{-10,-10},{10,10}}, origin=
                 {-150,0})));
        Modelica.Blocks.Sources.Constant IN11(k=0)
          annotation (Placement(transformation(extent={{-120,-40},{-100,-20}})));
        Modelica.Blocks.Math.Add AddU1
          annotation (Placement(transformation(extent={{-80,-16},{-60,4}})));
        Modelica.Blocks.Sources.Constant IN22(k=0)
          annotation (Placement(transformation(extent={{-120,-100},{-100,-80}})));
        Modelica.Blocks.Math.Add AddU2
          annotation (Placement(transformation(extent={{-80,-76},{-60,-56}})));
        Modelica.Blocks.Interfaces.RealInput IN2(start=0)
          "Connector of Real input signal 2" annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-150,-60}), iconTransformation(extent={{-10,-10},{10,10}},
                origin={-150,-60})));
        Modelica.Blocks.Interfaces.RealOutput OUT1
          annotation (Placement(transformation(extent={{140,58},{160,78}})));
       Modelica.Blocks.Interfaces.RealOutput OUT2
          annotation (Placement(transformation(extent={{140,38},{160,58}})));
        Modelica.Blocks.Interfaces.RealOutput OUT3
          annotation (Placement(transformation(extent={{140,18},{160,38}})));
        Modelica.Blocks.Interfaces.RealOutput OUT4
          annotation (Placement(transformation(extent={{140,-2},{160,18}})));
        Modelica.Blocks.Interfaces.RealOutput OUT5
          annotation (Placement(transformation(extent={{140,-22},{160,-2}})));
        Modelica.Blocks.Interfaces.RealOutput OUT6
          annotation (Placement(transformation(extent={{140,-42},{160,-22}})));
        Modelica.Blocks.Interfaces.RealOutput OUT7
          annotation (Placement(transformation(extent={{140,-62},
                  {160,-42}})));
        Modelica.Blocks.Interfaces.RealOutput OUT8
          annotation (Placement(transformation(extent={{140,-82},
                  {160,-62}})));
        Modelica.Blocks.Interfaces.RealOutput OUT9    annotation (Placement(transformation(extent={{140,-42},{160,-22}})));
        Modelica.Blocks.Interfaces.RealOutput OUT10   annotation (Placement(transformation(extent={{140,-62},{160,-42}})));
        Modelica.Blocks.Interfaces.RealOutput OUT11  annotation (Placement(transformation(extent={{140,-82},{160,-62}})));
        Modelica.Blocks.Interfaces.RealOutput OUT12    annotation (Placement(transformation(extent={{140,-42},{160,-22}})));
        Modelica.Blocks.Interfaces.RealOutput OUT13   annotation (Placement(transformation(extent={{140,-62},{160,-42}})));
        Modelica.Blocks.Interfaces.RealOutput OUT14  annotation (Placement(transformation(extent={{140,-82},{160,-62}})));
        Modelica.Blocks.Interfaces.RealOutput OUT15  annotation (Placement(transformation(extent={{140,-82},{160,-62}})));

        PFData.PowerFlow powerFlow(redeclare record PowerFlow =
              OpenIPSL.Examples.ModelPredictiveControl.PFData.PF01)
          annotation (Placement(transformation(extent={{-68,94},{-48,114}})));
        Electrical.Machines.PSSE.GENCLS IB(
          V_b=220000,
          v_0=powerFlow.powerflow.bus.V4,
          angle_0=powerFlow.powerflow.bus.A4,
          P_0=powerFlow.powerflow.machines.Pinf,
          Q_0=powerFlow.powerflow.machines.Qinf,
          M_b=100000000,
          X_d=1) if not equivalentGRID annotation (Placement(transformation(extent={{110,60},{100,80}})));
        Electrical.Loads.PSSE.Load_ExtInput Load2(
          P_0=powerFlow.powerflow.loads.PL2,
          Q_0=powerFlow.powerflow.loads.QL2,
          v_0=powerFlow.powerflow.bus.V5,
          angle_0=powerFlow.powerflow.bus.A5,
          d_P=0,
          t1=100,
          d_t=1000)
          annotation (Placement(transformation(extent={{100,-40},{120,-20}})));
        Electrical.Loads.NoiseInjections.WhiteNoiseInjection whiteNoiseInjection(
            active_sigma=0.0005,  samplePeriod=0.02)
          annotation (Placement(transformation(extent={{70,-30},{82,-18}})));

        inner Modelica.Blocks.Noise.GlobalSeed globalSeed(useAutomaticSeed=false,
            fixedSeed=10000)
          annotation (Placement(transformation(extent={{-42,92},{-22,112}})));
        Modelica.Blocks.Sources.Sine sine(
          amplitude=0.01,
          f=1/260,
          phase=3.1415926535898,
          startTime=5.5)
          annotation (Placement(transformation(extent={{72,-44},{82,-34}})));
        Modelica.Blocks.Math.Add add
          annotation (Placement(transformation(extent={{86,-30},{94,-22}})));

      equation

        OUT1 = G2.gen.w;
        OUT2 = G2.gen.delta;
        OUT3 = G2.gen.Epq;
        OUT4 = G2.gen.PSIkd;
        OUT5 = G2.gen.PSIppq;
        OUT6 = G2.sEXSMPC.simpleLagLim.state;
        OUT7 = G2.sEXSMPC.leadLag.TF.x[1];
        OUT8 = G2.gASTMPC.simpleLagLim.state;
        OUT9 = G2.gASTMPC.simpleLag.state;
        OUT10 = G2.gASTMPC.simpleLag1.state;
        OUT11 = G2.gASTMPC.PMECH;
        OUT12 = G2.sEXSMPC.EFD;
        OUT13 = Bus5.v;
        OUT14 = Bus5.angle;
        OUT15 = G2.gen.P;

        connect(T1.p, Bus2.p)
          annotation (Line(points={{-51.2,70},{-40,70}}, color={0,0,255}));
        connect(Bus1.p, T1.n)
          annotation (Line(points={{-80,70},{-68.8,70}}, color={0,0,255}));
        connect(G1.conn, Bus1.p)
          annotation (Line(points={{-91,70},{-80,70}}, color={0,0,255}));
        connect(L1.n, Bus3.p)
          annotation (Line(points={{-14.6,70},{0,70}}, color={0,0,255}));
        connect(L1.p, Bus2.p)
          annotation (Line(points={{-25.4,70},{-40,70}}, color={0,0,255}));
        connect(L2_2.n, Bus4.p) annotation (Line(points={{35.4,60},{44,60},{44,70},{
                60,70}},
                      color={0,0,255}));
        connect(L2_1.n, Bus4.p) annotation (Line(points={{35.4,80},{44,80},{44,70},{
                60,70}},
                      color={0,0,255}));
        connect(L2_1.p, Bus3.p) annotation (Line(points={{24.6,80},{16,80},{16,70},{0,
                70}}, color={0,0,255}));
        connect(L2_2.p, Bus3.p) annotation (Line(points={{24.6,60},{16,60},{16,70},{0,
                70}}, color={0,0,255}));
        connect(G2.conn, Bus6.p)
          annotation (Line(points={{21,-36},{34,-36}}, color={0,0,255}));
        connect(Load1.p, Bus3.p)
          annotation (Line(points={{-10,58},{-10,70},{0,70}}, color={0,0,255}));
        connect(L3.p, Bus4.p)
          annotation (Line(points={{80,55.4},{80,70},{60,70}}, color={0,0,255}));
        connect(breaker.s, Bus5.p)
          annotation (Line(points={{80,12},{80,6}}, color={0,0,255}));
        connect(breaker.r, L3.n)
          annotation (Line(points={{80,20},{80,44.6}},color={0,0,255}));
        connect(T2.n, Bus6.p)
          annotation (Line(points={{50,-24.8},{50,-36},{34,-36}}, color={0,0,255}));
        connect(IN11.y, AddU1.u2) annotation (Line(points={{-99,-30},{-90,-30},{-90,-12},
                {-82,-12}}, color={0,0,127}));
        connect(IN1, AddU1.u1) annotation (Line(points={{-150,0},{-82,0}},
                       color={0,0,127}));
        connect(T2.p, Bus5.p) annotation (Line(points={{50,-7.2},{50,0},{80,0},{80,6}},
              color={0,0,255}));

        connect(IN22.y,AddU2. u2) annotation (Line(points={{-99,-90},{-90,-90},{-90,-72},
                {-82,-72}},
                       color={0,0,127}));
        connect(IN2,AddU2. u1) annotation (Line(points={{-150,-60},{-82,-60}},
                       color={0,0,127}));
        connect(AddU2.y, G2.Efd_ref)
          annotation (Line(points={{-59,-66},{-10,-66},{-10,-42},{-2,-42}},
                                                                 color={0,0,127}));
        connect(AddU1.y, G2.P_ref1) annotation (Line(points={{-59,-6},{-10,-6},{-10,-30},
                {-2,-30}},                          color={0,0,127}));
        connect(IB.p, Bus4.p)
          annotation (Line(points={{100,70},{60,70}}, color={0,0,255}));
        connect(Load2.p, Bus5.p) annotation (Line(points={{110,-20},{110,0},{80,0},{80,
                6}}, color={0,0,255}));
        connect(sine.y, add.u2) annotation (Line(points={{82.5,-39},{82.5,-34},{85.2,-34},
                {85.2,-28.4}}, color={0,0,127}));
        connect(whiteNoiseInjection.y, add.u1) annotation (Line(points={{82.54,-24.06},
                {82.54,-23.6},{85.2,-23.6}}, color={0,0,127}));
        connect(add.y, Load2.u) annotation (Line(points={{94.4,-26},{94.4,-24.5},{101.9,
                -24.5}}, color={0,0,127}));
          annotation (Placement(transformation(extent={{140,-20},{160,0}})),
                      Placement(transformation(extent={{140,-40},{160,-20}})),
                      Placement(transformation(extent={{140,-60},{160,-40}})),
                      Placement(transformation(extent={{140,-80},{160,-60}})),
                     Diagram(coordinateSystem(preserveAspectRatio=false,
                extent={{-140,-120},{140,120}}), graphics={
              Rectangle(
                extent={{130,88},{166,-112}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Rectangle(
                extent={{-158,20},{-134,-80}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,26},{124,-112}},
                lineColor={238,46,47},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,88},{124,28}},
                lineColor={0,128,255},
                lineThickness=0.5),
              Polygon(
                points={{-124,20},{-124,-108},{72,-108},{72,-60},{0,20},{-124,20}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Text(
                extent={{74,-88},{122,-108}},
                textColor={238,46,47},
                textString="Microgrid"),
              Text(
                extent={{76,48},{128,24}},
                textColor={28,108,200},
                textString="Utility Grid"),
              Text(
                extent={{-16,-84},{70,-112}},
                textColor={0,140,72},
                textString="Linearization Unit"),
              Text(
                extent={{-164,40},{-132,20}},
                textColor={0,140,72},
                textString="Inputs"),
              Text(
                extent={{128,108},{168,88}},
                textColor={0,140,72},
                textString="Outputs")}),
          Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),experiment(
            StopTime=10,
            __Dymola_NumberOfIntervals=100,
            __Dymola_Algorithm="Dassl"));
      end OptimizationModel10;

      model OptimizationModel05_lessoutputs
        "THIS ONE IS STABLE, CONTROLLABLE, OBSERVABLE!!!!!!!"
        extends Modelica.Icons.Example;

        parameter Boolean equivalentGRID = true;
        parameter Boolean equivalentsystem = false;

        OpenIPSL.Electrical.Buses.Bus Bus1(v_0=powerFlow.powerflow.bus.V1, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-90,60},{-70,80}})));
        OpenIPSL.Electrical.Buses.Bus Bus2(v_0=powerFlow.powerflow.bus.V2, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-50,60},{-30,80}})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
          R=0.001,
          X=0.2,
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000)  if not equivalentGRID annotation (Placement(transformation(
              extent={{-8,-8},{8,8}},
              rotation=180,
              origin={-60,70})));
        OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
          enableV_b=true,
          v_0=powerFlow.powerflow.bus.V1,
          angle_0=powerFlow.powerflow.bus.A1,
          P_0=powerFlow.powerflow.machines.PG1,
          Q_0=powerFlow.powerflow.machines.QG1,
          V_b=6000)  if not equivalentGRID
          annotation (Placement(transformation(extent={{-112,60},{-92,80}})));
        OpenIPSL.Electrical.Branches.PwLine L1(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{-26,66},{-14,74}})));
        OpenIPSL.Electrical.Buses.Bus Bus3(v_0=powerFlow.powerflow.bus.V3, angle_0=
              powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-10,60},{10,80}})));
        OpenIPSL.Electrical.Buses.Bus Bus4(v_0=powerFlow.powerflow.bus.V4, angle_0=
              powerFlow.powerflow.bus.V4) if not equivalentGRID
          annotation (Placement(transformation(extent={{50,60},{70,80}})));
        OpenIPSL.Electrical.Branches.PwLine L2_1(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,76},{36,84}})));
        OpenIPSL.Electrical.Branches.PwLine L2_2(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,56},{36,64}})));
        OpenIPSL.Electrical.Buses.Bus Bus5(angle_0=powerFlow.powerflow.bus.A5, v_0=
              powerFlow.powerflow.bus.V5)  annotation (Placement(
              transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={80,6})));
        OpenIPSL.Electrical.Branches.PwLine L3(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=-90,
              origin={80,50})));
        OpenIPSL.Electrical.Buses.Bus Bus6(v_0=powerFlow.powerflow.bus.V6, angle_0=
              powerFlow.powerflow.bus.A6) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={34,-36})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000,
          R=0.005,
          X=0.1)  annotation (Placement(transformation(
              extent={{-8,-8},{8,8}},
              rotation=270,
              origin={50,-16})));
        GenerationUnits.PSSE.G2_16MVA                         G2(
          enableV_b=true,
          enableP_0=true,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V6,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A6,
          V_b=6000,
          P_0=powerFlow.powerflow.machines.PG2,
          Q_0=powerFlow.powerflow.machines.QG2,
          enableangle_0=true)
                        annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={10,-36})));
        inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000, fn=60)
          annotation (Placement(transformation(extent={{-128,94},{-74,114}})));
        OpenIPSL.Electrical.Loads.PSSE.Load Load1(
          V_b=220000,
          P_0=powerFlow.powerflow.loads.PL1,
          Q_0=powerFlow.powerflow.loads.QL1,
          v_0=powerFlow.powerflow.bus.V3,
          angle_0=powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-20,38},{0,58}})));
        Electrical.Events.Breaker breaker(enableTrigger=false,
          t_o=100.01,
          rc_enabled=true,
          t_rc=800.01)      if not equivalentGRID                     annotation (Placement(transformation(
              extent={{-4,-4},{4,4}},
              rotation=90,
              origin={80,16})));

        Modelica.Blocks.Interfaces.RealInput IN1(start=0)
          "Connector of Real input signal 2" annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-150,0}), iconTransformation(extent={{-10,-10},{10,10}}, origin=
                 {-150,0})));
        Modelica.Blocks.Sources.Constant IN11(k=0)
          annotation (Placement(transformation(extent={{-120,-40},{-100,-20}})));
        Modelica.Blocks.Math.Add AddU1
          annotation (Placement(transformation(extent={{-80,-16},{-60,4}})));
        Modelica.Blocks.Sources.Constant IN22(k=0)
          annotation (Placement(transformation(extent={{-120,-100},{-100,-80}})));
        Modelica.Blocks.Math.Add AddU2
          annotation (Placement(transformation(extent={{-80,-76},{-60,-56}})));
        Modelica.Blocks.Interfaces.RealInput IN2(start=0)
          "Connector of Real input signal 2" annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-150,-60}), iconTransformation(extent={{-10,-10},{10,10}},
                origin={-150,-60})));
        Modelica.Blocks.Interfaces.RealOutput OUT1
          annotation (Placement(transformation(extent={{140,58},{160,78}})));
        Modelica.Blocks.Interfaces.RealOutput OUT3
          annotation (Placement(transformation(extent={{140,18},{160,38}})));

        PFData.PowerFlow powerFlow(redeclare record PowerFlow =
              OpenIPSL.Examples.ModelPredictiveControl.PFData.PF02)
          annotation (Placement(transformation(extent={{-68,94},{-48,114}})));
        Electrical.Machines.PSSE.GENCLS IB(
          V_b=220000,
          v_0=powerFlow.powerflow.bus.V4,
          angle_0=powerFlow.powerflow.bus.A4,
          P_0=powerFlow.powerflow.machines.Pinf,
          Q_0=powerFlow.powerflow.machines.Qinf,
          M_b=100000000,
          X_d=1) if not equivalentGRID annotation (Placement(transformation(extent={{110,60},{100,80}})));
        Electrical.Loads.PSSE.Load_ExtInput Load2(
          P_0=powerFlow.powerflow.loads.PL2,
          Q_0=powerFlow.powerflow.loads.QL2,
          v_0=powerFlow.powerflow.bus.V5,
          angle_0=powerFlow.powerflow.bus.A5,
          d_P=0,
          t1=100,
          d_t=1000)
          annotation (Placement(transformation(extent={{100,-40},{120,-20}})));
        Electrical.Loads.NoiseInjections.WhiteNoiseInjection whiteNoiseInjection(
            active_sigma=0.0000000005,
                                  samplePeriod=0.02)
          annotation (Placement(transformation(extent={{70,-30},{82,-18}})));

        inner Modelica.Blocks.Noise.GlobalSeed globalSeed(useAutomaticSeed=false,
            fixedSeed=10000)
          annotation (Placement(transformation(extent={{-42,92},{-22,112}})));
        Modelica.Blocks.Sources.Sine sine(
          amplitude=0,
          f=1/260,
          phase=3.1415926535898,
          startTime=5.5)
          annotation (Placement(transformation(extent={{72,-44},{82,-34}})));
        Modelica.Blocks.Math.Add add
          annotation (Placement(transformation(extent={{86,-30},{94,-22}})));

        Modelica.Blocks.Interfaces.RealOutput OUT4
          annotation (Placement(transformation(extent={{140,0},{160,20}})));
      equation

        OUT1 = G2.gen.SPEED;
        //OUT2 = G2.gASTMPC.PMECH;
        OUT3 = G2.sEXSMPC.EFD;
        OUT4 = G2.gASTMPC.simpleLag1.state;



        connect(T1.p, Bus2.p)
          annotation (Line(points={{-51.2,70},{-40,70}}, color={0,0,255}));
        connect(Bus1.p, T1.n)
          annotation (Line(points={{-80,70},{-68.8,70}}, color={0,0,255}));
        connect(G1.conn, Bus1.p)
          annotation (Line(points={{-91,70},{-80,70}}, color={0,0,255}));
        connect(L1.n, Bus3.p)
          annotation (Line(points={{-14.6,70},{0,70}}, color={0,0,255}));
        connect(L1.p, Bus2.p)
          annotation (Line(points={{-25.4,70},{-40,70}}, color={0,0,255}));
        connect(L2_2.n, Bus4.p) annotation (Line(points={{35.4,60},{44,60},{44,70},{
                60,70}},
                      color={0,0,255}));
        connect(L2_1.n, Bus4.p) annotation (Line(points={{35.4,80},{44,80},{44,70},{
                60,70}},
                      color={0,0,255}));
        connect(L2_1.p, Bus3.p) annotation (Line(points={{24.6,80},{16,80},{16,70},{0,
                70}}, color={0,0,255}));
        connect(L2_2.p, Bus3.p) annotation (Line(points={{24.6,60},{16,60},{16,70},{0,
                70}}, color={0,0,255}));
        connect(G2.conn, Bus6.p)
          annotation (Line(points={{21,-36},{34,-36}}, color={0,0,255}));
        connect(Load1.p, Bus3.p)
          annotation (Line(points={{-10,58},{-10,70},{0,70}}, color={0,0,255}));
        connect(L3.p, Bus4.p)
          annotation (Line(points={{80,55.4},{80,70},{60,70}}, color={0,0,255}));
        connect(breaker.s, Bus5.p)
          annotation (Line(points={{80,12},{80,6}}, color={0,0,255}));
        connect(breaker.r, L3.n)
          annotation (Line(points={{80,20},{80,44.6}},color={0,0,255}));
        connect(T2.n, Bus6.p)
          annotation (Line(points={{50,-24.8},{50,-36},{34,-36}}, color={0,0,255}));
        connect(IN11.y, AddU1.u2) annotation (Line(points={{-99,-30},{-90,-30},{-90,-12},
                {-82,-12}}, color={0,0,127}));
        connect(IN1, AddU1.u1) annotation (Line(points={{-150,0},{-82,0}},
                       color={0,0,127}));
        connect(T2.p, Bus5.p) annotation (Line(points={{50,-7.2},{50,0},{80,0},{80,6}},
              color={0,0,255}));

        connect(IN22.y,AddU2. u2) annotation (Line(points={{-99,-90},{-90,-90},{-90,-72},
                {-82,-72}},
                       color={0,0,127}));
        connect(IN2,AddU2. u1) annotation (Line(points={{-150,-60},{-82,-60}},
                       color={0,0,127}));
        connect(AddU2.y, G2.Efd_ref)
          annotation (Line(points={{-59,-66},{-10,-66},{-10,-42},{-2,-42}},
                                                                 color={0,0,127}));
        connect(AddU1.y, G2.P_ref1) annotation (Line(points={{-59,-6},{-10,-6},{-10,-30},
                {-2,-30}},                          color={0,0,127}));
        connect(IB.p, Bus4.p)
          annotation (Line(points={{100,70},{60,70}}, color={0,0,255}));
        connect(Load2.p, Bus5.p) annotation (Line(points={{110,-20},{110,0},{80,0},{80,
                6}}, color={0,0,255}));
        connect(sine.y, add.u2) annotation (Line(points={{82.5,-39},{82.5,-34},{85.2,-34},
                {85.2,-28.4}}, color={0,0,127}));
        connect(whiteNoiseInjection.y, add.u1) annotation (Line(points={{82.54,-24.06},
                {82.54,-23.6},{85.2,-23.6}}, color={0,0,127}));
        connect(add.y, Load2.u) annotation (Line(points={{94.4,-26},{94.4,-24.5},{101.9,
                -24.5}}, color={0,0,127}));
          annotation (Placement(transformation(extent={{140,-20},{160,0}})),
                      Placement(transformation(extent={{140,-40},{160,-20}})),
                      Placement(transformation(extent={{140,-60},{160,-40}})),
                      Placement(transformation(extent={{140,-80},{160,-60}})),
                     Diagram(coordinateSystem(preserveAspectRatio=false,
                extent={{-140,-120},{140,120}}), graphics={
              Rectangle(
                extent={{130,88},{166,-112}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Rectangle(
                extent={{-158,20},{-134,-80}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,26},{124,-112}},
                lineColor={238,46,47},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,88},{124,28}},
                lineColor={0,128,255},
                lineThickness=0.5),
              Polygon(
                points={{-124,20},{-124,-108},{72,-108},{72,-60},{0,20},{-124,20}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Text(
                extent={{74,-88},{122,-108}},
                textColor={238,46,47},
                textString="Microgrid"),
              Text(
                extent={{76,48},{128,24}},
                textColor={28,108,200},
                textString="Utility Grid"),
              Text(
                extent={{-16,-84},{70,-112}},
                textColor={0,140,72},
                textString="Linearization Unit"),
              Text(
                extent={{-164,40},{-132,20}},
                textColor={0,140,72},
                textString="Inputs"),
              Text(
                extent={{128,108},{168,88}},
                textColor={0,140,72},
                textString="Outputs")}),
          Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),experiment(Interval=0.5, __Dymola_Algorithm="Dassl"));
      end OptimizationModel05_lessoutputs;

      model MPCMicrogridRenewablesIncluded
        "THIS ONE IS STABLE, CONTROLLABLE, OBSERVABLE!!!!!!!"
        extends Modelica.Icons.Example;

        parameter Boolean equivalentGRID = false;
        parameter Boolean equivalentsystem = false;

        OpenIPSL.Electrical.Buses.Bus Bus1(v_0=powerFlow.powerflow.bus.V1, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-90,70},{-70,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus2(v_0=powerFlow.powerflow.bus.V2, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-50,70},{-30,90}})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
          R=0.001,
          X=0.2,
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000)  if not equivalentGRID annotation (Placement(transformation(
              extent={{-8,-8},{8,8}},
              rotation=180,
              origin={-60,80})));
        OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
          enableV_b=true,
          v_0=powerFlow.powerflow.bus.V1,
          angle_0=powerFlow.powerflow.bus.A1,
          P_0=powerFlow.powerflow.machines.PG1,
          Q_0=powerFlow.powerflow.machines.QG1,
          V_b=6000)  if not equivalentGRID
          annotation (Placement(transformation(extent={{-112,70},{-92,90}})));
        OpenIPSL.Electrical.Branches.PwLine L1(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{-26,76},
                  {-14,84}})));
        OpenIPSL.Electrical.Buses.Bus Bus3(v_0=powerFlow.powerflow.bus.V3, angle_0=
              powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-10,70},{10,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus4(v_0=powerFlow.powerflow.bus.V4, angle_0=
              powerFlow.powerflow.bus.V4) if not equivalentGRID
          annotation (Placement(transformation(extent={{50,70},{70,90}})));
        OpenIPSL.Electrical.Branches.PwLine L2_1(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,86},
                  {36,94}})));
        OpenIPSL.Electrical.Branches.PwLine L2_2(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,66},
                  {36,74}})));
        OpenIPSL.Electrical.Buses.Bus Bus5(angle_0=powerFlow.powerflow.bus.A5, v_0=
              powerFlow.powerflow.bus.V5)  annotation (Placement(
              transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={80,16})));
        OpenIPSL.Electrical.Branches.PwLine L3(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=-90,
              origin={80,60})));
        OpenIPSL.Electrical.Buses.Bus Bus6(v_0=powerFlow.powerflow.bus.V6, angle_0=
              powerFlow.powerflow.bus.A6) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={0,10})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000,
          R=0.005,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={40,10})));
        GenerationUnits.PSSE.G2_16MVA                         G2(
          enableV_b=true,
          enableP_0=true,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V6,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A6,
          V_b=6000,
          P_0=powerFlow.powerflow.machines.PG2,
          Q_0=powerFlow.powerflow.machines.QG2,
          enableangle_0=true)
                        annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-30,10})));
        inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000, fn=60)
          annotation (Placement(transformation(extent={{-128,104},{-74,124}})));
        OpenIPSL.Electrical.Loads.PSSE.Load Load1(
          V_b=220000,
          P_0=powerFlow.powerflow.loads.PL1,
          Q_0=powerFlow.powerflow.loads.QL1,
          v_0=powerFlow.powerflow.bus.V3,
          angle_0=powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-20,48},{0,68}})));
        Electrical.Events.Breaker breaker(enableTrigger=false,
          t_o=1.01,
          rc_enabled=true,
          t_rc=80.01)       if not equivalentGRID                     annotation (Placement(transformation(
              extent={{-4,-4},{4,4}},
              rotation=90,
              origin={80,26})));

        Modelica.Blocks.Interfaces.RealInput IN1(start=0)
          "Connector of Real input signal 2" annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-150,10}),iconTransformation(extent={{-10,-10},{10,10}}, origin={-150,10})));
        Modelica.Blocks.Sources.Constant IN11(k=0)
          annotation (Placement(transformation(extent={{-108,-2},{-96,10}})));
        Modelica.Blocks.Math.Add AddU1
          annotation (Placement(transformation(extent={{-80,0},{-60,20}})));
        Modelica.Blocks.Sources.Constant IN22(k=0)
          annotation (Placement(transformation(extent={{-108,-32},{-96,-20}})));
        Modelica.Blocks.Math.Add AddU2
          annotation (Placement(transformation(extent={{-80,-30},{-60,-10}})));
        Modelica.Blocks.Interfaces.RealInput IN2(start=0)
          "Connector of Real input signal 2"
                 annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-150,-12}), iconTransformation(extent={{-10,-10},{10,10}},
                origin={-150,-12})));
        Modelica.Blocks.Interfaces.RealInput IN3(start = 0) "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-44},{-140,-24}}),
              iconTransformation(extent={{-160,-44},{-140,-24}})));
        Modelica.Blocks.Interfaces.RealInput IN4(start = 0) "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-66},{-140,-46}}),
              iconTransformation(extent={{-160,-66},{-140,-46}})));
        Modelica.Blocks.Interfaces.RealInput IN5(start = 0) "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-88},{-140,-68}}),
              iconTransformation(extent={{-160,-88},{-140,-68}})));

        Modelica.Blocks.Interfaces.RealOutput OUT1
          annotation (Placement(transformation(extent={{140,70},{160,90}})));
       Modelica.Blocks.Interfaces.RealOutput OUT2
          annotation (Placement(transformation(extent={{140,50},{160,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT3
          annotation (Placement(transformation(extent={{140,30},{160,50}})));

        PFData.PowerFlow powerFlow(redeclare record PowerFlow =
              OpenIPSL.Examples.ModelPredictiveControl.PFData.PF13)
          annotation (Placement(transformation(extent={{-68,104},{-48,124}})));
        Electrical.Machines.PSSE.GENCLS IB(
          V_b=220000,
          v_0=powerFlow.powerflow.bus.V4,
          angle_0=powerFlow.powerflow.bus.A4,
          P_0=powerFlow.powerflow.machines.Pinf,
          Q_0=powerFlow.powerflow.machines.Qinf,
          M_b=100000000,
          X_d=1) if not equivalentGRID annotation (Placement(transformation(extent={{110,70},
                  {100,90}})));
        Electrical.Loads.PSSE.Load_ExtInput Load2(
          P_0=powerFlow.powerflow.loads.PL2,
          Q_0=powerFlow.powerflow.loads.QL2,
          v_0=powerFlow.powerflow.bus.V5,
          angle_0=powerFlow.powerflow.bus.A5,
          d_P=0,
          t1=100,
          d_t=1000)
          annotation (Placement(transformation(extent={{100,-30},{120,-10}})));
        Electrical.Loads.NoiseInjections.WhiteNoiseInjection whiteNoiseInjection(
            active_sigma=0.0000000005,
                                  samplePeriod=0.02)
          annotation (Placement(transformation(extent={{76,-14},{82,-8}})));

        inner Modelica.Blocks.Noise.GlobalSeed globalSeed(useAutomaticSeed=false,
            fixedSeed=10000)
          annotation (Placement(transformation(extent={{-42,102},{-22,122}})));
        Modelica.Blocks.Sources.Sine sine(
          amplitude=0,
          f=1/260,
          phase=3.1415926535898,
          startTime=1000)
          annotation (Placement(transformation(extent={{76,-26},{82,-20}})));
        Modelica.Blocks.Math.Add add
          annotation (Placement(transformation(extent={{86,-18},{94,-10}})));

        Electrical.Buses.Bus          Bus7(v_0=powerFlow.powerflow.bus.V7, angle_0=
              powerFlow.powerflow.bus.A7) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={0,-76})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T3(
          G=0,
          B=0,
          CW=1,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=270,
              origin={60,-20})));
        GenerationUnits.PSSE.Solar_Units.SolarMPCLocalVQControl PV(
          V_b=480,
          P_0=powerFlow.powerflow.machines.PPV,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QPV,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V7,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A7,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-70},{-20,-50}})));
        Modelica.Blocks.Math.Add AddU3
          annotation (Placement(transformation(extent={{-80,-60},{-60,-40}})));
        Modelica.Blocks.Sources.Constant IN33(k=0)
          annotation (Placement(transformation(extent={{-108,-62},{-96,-50}})));

        Modelica.Blocks.Math.Add AddU4
          annotation (Placement(transformation(extent={{-80,-90},{-60,-70}})));
        Modelica.Blocks.Math.Add AddU5
          annotation (Placement(transformation(extent={{-80,-116},{-60,-96}})));
        Modelica.Blocks.Sources.Constant IN44(k=0)
          annotation (Placement(transformation(extent={{-108,-92},{-96,-80}})));
        Modelica.Blocks.Sources.Constant IN55(k=0)
          annotation (Placement(transformation(extent={{-108,-118},{-96,-106}})));
        Modelica.Blocks.Interfaces.RealOutput OUT4
          annotation (Placement(transformation(extent={{140,10},{160,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT5
          annotation (Placement(transformation(extent={{140,-10},{160,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT6
          annotation (Placement(transformation(extent={{140,-30},{160,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT7
          annotation (Placement(transformation(extent={{140,-50},{160,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT8
          annotation (Placement(transformation(extent={{140,-70},{160,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT9
          annotation (Placement(transformation(extent={{140,-90},{160,-70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT10
          annotation (Placement(transformation(extent={{140,-110},{160,-90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT11
          annotation (Placement(transformation(extent={{164,70},{184,90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT12
          annotation (Placement(transformation(extent={{164,50},{184,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT13
          annotation (Placement(transformation(extent={{164,30},{184,50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT14
          annotation (Placement(transformation(extent={{164,10},{184,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT15
          annotation (Placement(transformation(extent={{164,-10},{184,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT16
          annotation (Placement(transformation(extent={{164,-30},{184,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT17
          annotation (Placement(transformation(extent={{164,-50},{184,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT18
          annotation (Placement(transformation(extent={{164,-70},{184,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT19
          annotation (Placement(transformation(extent={{164,-90},{184,-70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT20
          annotation (Placement(transformation(extent={{164,-110},{184,-90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT21
          annotation (Placement(transformation(extent={{184,70},{204,90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT22
          annotation (Placement(transformation(extent={{184,50},{204,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT23
          annotation (Placement(transformation(extent={{184,30},{204,50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT24
          annotation (Placement(transformation(extent={{184,10},{204,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT25
          annotation (Placement(transformation(extent={{184,-10},{204,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT26
          annotation (Placement(transformation(extent={{184,-30},{204,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT27
          annotation (Placement(transformation(extent={{184,-50},{204,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT28
          annotation (Placement(transformation(extent={{184,-70},{204,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT29
          annotation (Placement(transformation(extent={{184,-90},{204,-70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT30
          annotation (Placement(transformation(extent={{184,-110},{204,-90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT31
          annotation (Placement(transformation(extent={{204,70},{224,90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT32
          annotation (Placement(transformation(extent={{204,50},{224,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT33
          annotation (Placement(transformation(extent={{204,30},{224,50}})));
        GenerationUnits.PSSE.Battery_Units.BESSMPCLocalVQControl BESS(
          V_base=480,
          V_b(displayUnit="kV") = 480,
          enableV_b=true,
          P_0=powerFlow.powerflow.machines.PBESS,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QBESS,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V7,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A7,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-102},{-20,-82}})));
        Modelica.Blocks.Interfaces.RealOutput OUT34
          annotation (Placement(transformation(extent={{204,10},{224,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT35
          annotation (Placement(transformation(extent={{206,-10},{226,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT36
          annotation (Placement(transformation(extent={{206,-30},{226,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT37
          annotation (Placement(transformation(extent={{206,-50},{226,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT38
          annotation (Placement(transformation(extent={{206,-70},{226,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT39
          annotation (Placement(transformation(extent={{206,-90},{226,-70}})));
      equation

      //   OUT1 = G2.gen.w;
      //   OUT2 = G2.gen.delta;
      //   OUT3 = G2.gen.Epq;
      //   OUT4 = G2.gen.PSIkd;
      //   OUT5 = G2.gen.PSIppq;
      //   OUT6 = G2.sEXSMPC.simpleLagLim.state;
      //   OUT7 = G2.sEXSMPC.leadLag.TF.x_scaled[1];
      //   OUT8 = G2.gASTMPC.simpleLagLim.state;
      //   OUT9 = G2.gASTMPC.simpleLag.state;
      //   OUT10 = G2.gASTMPC.simpleLag1.state;
      //   OUT11 = PV.rEGCA1_1.simpleLag.state;
      //   OUT12 = PV.rEGCA1_1.integrator.y;
      //   OUT13 = PV.rEGCA1_1.integrator1.y;
      //   OUT14 = PV.rEECB1_Local_V_Q_Control.integrator.y;
      //   OUT15 = PV.rEECB1_Local_V_Q_Control.integrator1.y;
      //   OUT16 = PV.rEECB1_Local_V_Q_Control.simpleLag.state;
      //   OUT17 = PV.rEECB1_Local_V_Q_Control.integrator3.y;
      //   OUT18 = PV.rEECB1_Local_V_Q_Control.simpleLag1.state;
      //   OUT19 = PV.rEECB1_Local_V_Q_Control.simpleLag2.state;
      //   OUT20 = PV.rEECB1_Local_V_Q_Control.IGP.y;
      //   OUT21 = PV.rEECB1_Local_V_Q_Control.simpleLag3.state;
      //   OUT22 = BESS.rEGCA1_1.simpleLag.state;
      //   OUT23 = BESS.rEGCA1_1.integrator.y;
      //   OUT24 = BESS.rEGCA1_1.integrator1.y;
      //   OUT25 =BESS.rEECCU1_Local_V_Q_Control3_1.integrator3.y;
      //   OUT26 =BESS.rEECCU1_Local_V_Q_Control3_1.integrator1.y;
      //   OUT27 =BESS.rEECCU1_Local_V_Q_Control3_1.simpleLag.state;
      //   OUT28 =BESS.rEECCU1_Local_V_Q_Control3_1.IGQ.y;
      //   OUT29 =BESS.rEECCU1_Local_V_Q_Control3_1.IGV.y;
      //   OUT30 =BESS.rEECCU1_Local_V_Q_Control3_1.IGP.y;
      //   OUT31 =BESS.rEECCU1_Local_V_Q_Control3_1.simpleLag1.state;
      //   OUT32 =BESS.rEECCU1_Local_V_Q_Control3_1.simpleLag2.state;

      OUT1 = G2.gen.w;
      OUT2 = G2.gen.delta;
      OUT3 = G2.gen.Epq;
      OUT4 = G2.gen.PSIkd;
      OUT5 = G2.gen.PSIppq;
      OUT6 = G2.sEXSMPC.simpleLagLim.state;
      OUT7 = G2.sEXSMPC.leadLag.TF.x_scaled[1];
      OUT8 = G2.gASTMPC.simpleLagLim.state;
      OUT9 = G2.gASTMPC.simpleLag.state;
      OUT10 = G2.gASTMPC.simpleLag1.state;
      OUT11 = PV.rEGCA1_1.simpleLag.state;
      OUT12 = PV.rEGCA1_1.integrator.y;
      OUT13 = PV.rEGCA1_1.integrator1.y;
      OUT14 =PV.EC.IGQ.y;
      OUT15 =PV.EC.IGV.y;
      OUT16 =PV.EC.simpleLag.state;
      OUT17 =PV.EC.integrator3.y;
      OUT18 =PV.EC.simpleLag1.state;
      OUT19 =PV.EC.simpleLag2.state;
      OUT20 =PV.EC.IGP.y;
      OUT21 =PV.EC.simpleLag3.state;
      OUT22 = BESS.rEGCA1_1.simpleLag.state;
      OUT23 = BESS.rEGCA1_1.integrator.y;
      OUT24 = BESS.rEGCA1_1.integrator1.y;
      OUT25 =BESS.EC.integrator3.y;
      OUT26 =BESS.EC.simpleLag.state;
      OUT27 =BESS.EC.IGQ.y;
      OUT28 =BESS.EC.IGV.y;
      OUT29 =BESS.EC.IGP.y;
      OUT30 =BESS.EC.simpleLag1.state;
      OUT31 =BESS.EC.simpleLag2.state;

        OUT32 = G2.gen.PMECH;
        OUT33 = G2.sEXSMPC.EFD;
        OUT34 = BESS.rEGCA1_1.Pgen;
        OUT35 = BESS.rEGCA1_1.Qgen;
        OUT36 = PV.rEGCA1_1.Pgen;
        OUT37 = PV.rEGCA1_1.Qgen;
        OUT38 = Bus5.v;
        OUT39 = Bus5.angle;
        connect(T1.p, Bus2.p)
          annotation (Line(points={{-51.2,80},{-40,80}}, color={0,0,255}));
        connect(Bus1.p, T1.n)
          annotation (Line(points={{-80,80},{-68.8,80}}, color={0,0,255}));
        connect(G1.conn, Bus1.p)
          annotation (Line(points={{-91,80},{-80,80}}, color={0,0,255}));
        connect(L1.n, Bus3.p)
          annotation (Line(points={{-14.6,80},{0,80}}, color={0,0,255}));
        connect(L1.p, Bus2.p)
          annotation (Line(points={{-25.4,80},{-40,80}}, color={0,0,255}));
        connect(L2_2.n, Bus4.p) annotation (Line(points={{35.4,70},{44,70},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.n, Bus4.p) annotation (Line(points={{35.4,90},{44,90},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.p, Bus3.p) annotation (Line(points={{24.6,90},{16,90},{16,80},{0,
                80}}, color={0,0,255}));
        connect(L2_2.p, Bus3.p) annotation (Line(points={{24.6,70},{16,70},{16,80},{0,
                80}}, color={0,0,255}));
        connect(Load1.p, Bus3.p)
          annotation (Line(points={{-10,68},{-10,80},{0,80}}, color={0,0,255}));
        connect(L3.p, Bus4.p)
          annotation (Line(points={{80,65.4},{80,80},{60,80}}, color={0,0,255}));
        connect(breaker.s, Bus5.p)
          annotation (Line(points={{80,22},{80,16}},color={0,0,255}));
        connect(breaker.r, L3.n)
          annotation (Line(points={{80,30},{80,54.6}},color={0,0,255}));
        connect(IN11.y, AddU1.u2) annotation (Line(points={{-95.4,4},{-82,4}},
                            color={0,0,127}));
        connect(IN1, AddU1.u1) annotation (Line(points={{-150,10},{-116,10},{-116,16},
                {-82,16}},
                       color={0,0,127}));
        connect(T2.p, Bus5.p) annotation (Line(points={{51,10},{80,10},{80,16}},
              color={0,0,255}));

        connect(IN22.y,AddU2. u2) annotation (Line(points={{-95.4,-26},{-82,-26}},
                       color={0,0,127}));
        connect(IN2,AddU2. u1) annotation (Line(points={{-150,-12},{-118,-12},{-118,-14},
                {-82,-14}},
                       color={0,0,127}));
        connect(AddU2.y, G2.Efd_ref)
          annotation (Line(points={{-59,-20},{-52,-20},{-52,4},{-42,4}},
                                                                 color={0,0,127}));
        connect(AddU1.y, G2.P_ref1) annotation (Line(points={{-59,10},{-52,10},{-52,16},
                {-42,16}},                          color={0,0,127}));
        connect(IB.p, Bus4.p)
          annotation (Line(points={{100,80},{60,80}}, color={0,0,255}));
        connect(Load2.p, Bus5.p) annotation (Line(points={{110,-10},{110,10},{80,10},{
                80,16}},
                     color={0,0,255}));
        connect(sine.y, add.u2) annotation (Line(points={{82.3,-23},{82.3,-24},{85.2,-24},
                {85.2,-16.4}}, color={0,0,127}));
        connect(whiteNoiseInjection.y, add.u1) annotation (Line(points={{82.27,-11.03},
                {82.27,-11.6},{85.2,-11.6}}, color={0,0,127}));
        connect(add.y, Load2.u) annotation (Line(points={{94.4,-14},{94.4,-14.5},{101.9,
                -14.5}}, color={0,0,127}));
        connect(T3.n, Bus7.p) annotation (Line(points={{60,-31},{60,-76},{0,-76}},
                       color={0,0,255}));
        connect(T3.p, Bus5.p) annotation (Line(points={{60,-9},{60,10},{80,10},{80,16}},
              color={0,0,255}));
        connect(Bus6.p, T2.n)
          annotation (Line(points={{4.996e-16,10},{29,10}},
                                                  color={0,0,255}));
        connect(PV.p1, Bus7.p)
          annotation (Line(points={{-20,-60},{-6,-60},{-6,-76},{0,-76}},
                                                               color={0,0,255}));
        connect(AddU3.y, PV.QINPUT) annotation (Line(points={{-59,-50},{-50,-50},{-50,
                -60},{-42,-60}}, color={0,0,127}));
        connect(IN33.y,AddU3. u2)
          annotation (Line(points={{-95.4,-56},{-82,-56}}, color={0,0,127}));
        connect(IN3,AddU3. u1) annotation (Line(points={{-150,-34},{-114,-34},{-114,-44},
                {-82,-44}}, color={0,0,127}));
        connect(BESS.p1, Bus7.p) annotation (Line(points={{-20,-92},{-6,-92},{-6,-76},
                {4.996e-16,-76}},
                          color={0,0,255}));
        connect(BESS.Paux1, AddU4.y) annotation (Line(points={{-42,-86},{-54,-86},{-54,
                -80},{-59,-80}}, color={0,0,127}));
        connect(IN55.y, AddU5.u2)
          annotation (Line(points={{-95.4,-112},{-82,-112}}, color={0,0,127}));
        connect(AddU5.y, BESS.Qext1) annotation (Line(points={{-59,-106},{-52,-106},{-52,
                -98},{-42,-98}},   color={0,0,127}));
        connect(IN44.y, AddU4.u2)
          annotation (Line(points={{-95.4,-86},{-82,-86}}, color={0,0,127}));
        connect(AddU4.u1, IN4) annotation (Line(points={{-82,-74},{-100,-74},{-100,-70},
                {-116,-70},{-116,-56},{-150,-56}}, color={0,0,127}));
        connect(AddU5.u1, IN5) annotation (Line(points={{-82,-100},{-116,-100},{-116,-78},
                {-150,-78}}, color={0,0,127}));
        connect(G2.conn, Bus6.p) annotation (Line(points={{-19,10},{4.996e-16,10}},
                                           color={0,0,255}));
          annotation (Placement(transformation(extent={{140,-20},{160,0}})),
                      Placement(transformation(extent={{140,-40},{160,-20}})),
                      Placement(transformation(extent={{140,-60},{160,-40}})),
                      Placement(transformation(extent={{140,-80},{160,-60}})),
                     Diagram(coordinateSystem(preserveAspectRatio=false,
                extent={{-140,-140},{140,140}}), graphics={
              Rectangle(
                extent={{130,98},{232,-124}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Rectangle(
                extent={{-160,30},{-134,-90}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,36},{124,-124}},
                lineColor={238,46,47},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,98},{124,38}},
                lineColor={0,128,255},
                lineThickness=0.5),
              Polygon(
                points={{-124,30},{-124,-120},{72,-120},{72,-50},{0,30},{-124,30}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Text(
                extent={{78,-106},{114,-120}},
                textColor={238,46,47},
                textString="Microgrid"),
              Text(
                extent={{76,58},{128,34}},
                textColor={28,108,200},
                textString="Utility Grid"),
              Text(
                extent={{6,-102},{70,-124}},
                textColor={0,140,72},
                textString="Linearization Unit"),
              Text(
                extent={{-164,50},{-132,30}},
                textColor={0,140,72},
                textString="Inputs"),
              Text(
                extent={{128,118},{168,98}},
                textColor={0,140,72},
                textString="Outputs")}),
          Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),experiment(StopTime=10, __Dymola_Algorithm="Dassl"),
          Icon(coordinateSystem(extent={{-140,-140},{140,140}})));
      end MPCMicrogridRenewablesIncluded;

      model MPCMicrogridRenewablesIncludedPMU
        "THIS ONE IS STABLE, CONTROLLABLE, OBSERVABLE!!!!!!!"
        extends Modelica.Icons.Example;

        parameter Boolean equivalentGRID = true;
        parameter Boolean equivalentsystem = false;

        OpenIPSL.Electrical.Buses.Bus Bus1(v_0=powerFlow.powerflow.bus.V1, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-90,60},{-70,80}})));
        OpenIPSL.Electrical.Buses.Bus Bus2(v_0=powerFlow.powerflow.bus.V2, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-50,60},{-30,80}})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
          R=0.001,
          X=0.2,
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000)  if not equivalentGRID annotation (Placement(transformation(
              extent={{-8,-8},{8,8}},
              rotation=180,
              origin={-60,70})));
        OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
          enableV_b=true,
          v_0=powerFlow.powerflow.bus.V1,
          angle_0=powerFlow.powerflow.bus.A1,
          P_0=powerFlow.powerflow.machines.PG1,
          Q_0=powerFlow.powerflow.machines.QG1,
          V_b=6000)  if not equivalentGRID
          annotation (Placement(transformation(extent={{-112,60},{-92,80}})));
        OpenIPSL.Electrical.Branches.PwLine L1(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{-26,66},{-14,74}})));
        OpenIPSL.Electrical.Buses.Bus Bus3(v_0=powerFlow.powerflow.bus.V3, angle_0=
              powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-10,60},{10,80}})));
        OpenIPSL.Electrical.Buses.Bus Bus4(v_0=powerFlow.powerflow.bus.V4, angle_0=
              powerFlow.powerflow.bus.V4) if not equivalentGRID
          annotation (Placement(transformation(extent={{50,60},{70,80}})));
        OpenIPSL.Electrical.Branches.PwLine L2_1(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,76},{36,84}})));
        OpenIPSL.Electrical.Branches.PwLine L2_2(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,56},{36,64}})));
        OpenIPSL.Electrical.Buses.Bus Bus5(angle_0=powerFlow.powerflow.bus.A5, v_0=
              powerFlow.powerflow.bus.V5)  annotation (Placement(
              transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={80,6})));
        OpenIPSL.Electrical.Branches.PwLine L3(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=-90,
              origin={80,50})));
        OpenIPSL.Electrical.Buses.Bus Bus6(v_0=powerFlow.powerflow.bus.V6, angle_0=
              powerFlow.powerflow.bus.A6) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180)));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000,
          R=0.005,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={40,0})));
        GenerationUnits.PSSE.G2_16MVA                         G2(
          enableV_b=true,
          enableP_0=true,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V6,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A6,
          V_b=6000,
          P_0=powerFlow.powerflow.machines.PG2,
          Q_0=powerFlow.powerflow.machines.QG2,
          enableangle_0=true)
                        annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-30,0})));
        inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000, fn=60)
          annotation (Placement(transformation(extent={{-128,94},{-74,114}})));
        OpenIPSL.Electrical.Loads.PSSE.Load Load1(
          V_b=220000,
          P_0=powerFlow.powerflow.loads.PL1,
          Q_0=powerFlow.powerflow.loads.QL1,
          v_0=powerFlow.powerflow.bus.V3,
          angle_0=powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-20,38},{0,58}})));
        Electrical.Events.Breaker breaker(enableTrigger=false,
          t_o=1.01,
          rc_enabled=true,
          t_rc=80.01)       if not equivalentGRID                     annotation (Placement(transformation(
              extent={{-4,-4},{4,4}},
              rotation=90,
              origin={80,16})));

        Modelica.Blocks.Interfaces.RealInput IN1(start=0)
          "Connector of Real input signal 2" annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-150,0}), iconTransformation(extent={{-10,-10},{10,10}}, origin=
                 {-150,0})));
        Modelica.Blocks.Sources.Constant IN11(k=0)
          annotation (Placement(transformation(extent={{-108,-12},{-96,0}})));
        Modelica.Blocks.Math.Add AddU1
          annotation (Placement(transformation(extent={{-80,-10},{-60,10}})));
        Modelica.Blocks.Sources.Constant IN22(k=0)
          annotation (Placement(transformation(extent={{-108,-42},{-96,-30}})));
        Modelica.Blocks.Math.Add AddU2
          annotation (Placement(transformation(extent={{-80,-40},{-60,-20}})));
        Modelica.Blocks.Interfaces.RealInput IN2(start=0)
          "Connector of Real input signal 2"
                 annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-150,-22}), iconTransformation(extent={{-10,-10},{10,10}},
                origin={-150,-22})));
        Modelica.Blocks.Interfaces.RealInput IN3(start = 0) "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-54},{-140,-34}}),
              iconTransformation(extent={{-160,-54},{-140,-34}})));
        Modelica.Blocks.Interfaces.RealInput IN4(start = 0) "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-76},{-140,-56}}),
              iconTransformation(extent={{-160,-76},{-140,-56}})));
        Modelica.Blocks.Interfaces.RealInput IN5(start = 0) "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-98},{-140,-78}}),
              iconTransformation(extent={{-160,-98},{-140,-78}})));

        Modelica.Blocks.Interfaces.RealOutput OUT1
          annotation (Placement(transformation(extent={{140,60},{160,80}})));
       Modelica.Blocks.Interfaces.RealOutput OUT2
          annotation (Placement(transformation(extent={{140,40},{160,60}})));
        Modelica.Blocks.Interfaces.RealOutput OUT3
          annotation (Placement(transformation(extent={{140,20},{160,40}})));

        PFData.PowerFlow powerFlow(redeclare record PowerFlow =
              OpenIPSL.Examples.ModelPredictiveControl.PFData.PF13)
          annotation (Placement(transformation(extent={{-68,94},{-48,114}})));
        Electrical.Machines.PSSE.GENCLS IB(
          V_b=220000,
          v_0=powerFlow.powerflow.bus.V4,
          angle_0=powerFlow.powerflow.bus.A4,
          P_0=powerFlow.powerflow.machines.Pinf,
          Q_0=powerFlow.powerflow.machines.Qinf,
          M_b=100000000,
          X_d=1) if not equivalentGRID annotation (Placement(transformation(extent={{110,60},{100,80}})));

        inner Modelica.Blocks.Noise.GlobalSeed globalSeed(useAutomaticSeed=false,
            fixedSeed=10000)
          annotation (Placement(transformation(extent={{-42,92},{-22,112}})));

        Electrical.Buses.Bus          Bus7(v_0=powerFlow.powerflow.bus.V7, angle_0=
              powerFlow.powerflow.bus.A7) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={0,-86})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T3(
          G=0,
          B=0,
          CW=1,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=270,
              origin={60,-30})));
        GenerationUnits.PSSE.Solar_Units.SolarMPCLocalQControl PV(
          V_b=480,
          P_0=powerFlow.powerflow.machines.PPV,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QPV,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V7,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A7,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-80},{-20,-60}})));
        Modelica.Blocks.Math.Add AddU3
          annotation (Placement(transformation(extent={{-80,-70},{-60,-50}})));
        Modelica.Blocks.Sources.Constant IN33(k=0)
          annotation (Placement(transformation(extent={{-108,-72},{-96,-60}})));

        Modelica.Blocks.Math.Add AddU4
          annotation (Placement(transformation(extent={{-80,-100},{-60,-80}})));
        Modelica.Blocks.Math.Add AddU5
          annotation (Placement(transformation(extent={{-80,-126},{-60,-106}})));
        Modelica.Blocks.Sources.Constant IN44(k=0)
          annotation (Placement(transformation(extent={{-108,-102},{-96,-90}})));
        Modelica.Blocks.Sources.Constant IN55(k=0)
          annotation (Placement(transformation(extent={{-108,-128},{-96,-116}})));
        Modelica.Blocks.Interfaces.RealOutput OUT4
          annotation (Placement(transformation(extent={{140,0},{160,20}})));
        Modelica.Blocks.Interfaces.RealOutput OUT5
          annotation (Placement(transformation(extent={{140,-20},{160,0}})));
        Modelica.Blocks.Interfaces.RealOutput OUT6
          annotation (Placement(transformation(extent={{140,-40},{160,-20}})));
        Modelica.Blocks.Interfaces.RealOutput OUT7
          annotation (Placement(transformation(extent={{140,-60},{160,-40}})));
        Modelica.Blocks.Interfaces.RealOutput OUT8
          annotation (Placement(transformation(extent={{140,-80},{160,-60}})));
        Modelica.Blocks.Interfaces.RealOutput OUT9
          annotation (Placement(transformation(extent={{140,-100},{160,-80}})));
        Modelica.Blocks.Interfaces.RealOutput OUT10
          annotation (Placement(transformation(extent={{140,-120},{160,-100}})));
        Modelica.Blocks.Interfaces.RealOutput OUT11
          annotation (Placement(transformation(extent={{164,60},{184,80}})));
        Modelica.Blocks.Interfaces.RealOutput OUT12
          annotation (Placement(transformation(extent={{164,40},{184,60}})));
        Modelica.Blocks.Interfaces.RealOutput OUT13
          annotation (Placement(transformation(extent={{164,20},{184,40}})));
        Modelica.Blocks.Interfaces.RealOutput OUT14
          annotation (Placement(transformation(extent={{164,0},{184,20}})));
        Modelica.Blocks.Interfaces.RealOutput OUT15
          annotation (Placement(transformation(extent={{164,-20},{184,0}})));
        Modelica.Blocks.Interfaces.RealOutput OUT16
          annotation (Placement(transformation(extent={{164,-40},{184,-20}})));
        Modelica.Blocks.Interfaces.RealOutput OUT17
          annotation (Placement(transformation(extent={{164,-60},{184,-40}})));
        Modelica.Blocks.Interfaces.RealOutput OUT18
          annotation (Placement(transformation(extent={{164,-80},{184,-60}})));
        Modelica.Blocks.Interfaces.RealOutput OUT19
          annotation (Placement(transformation(extent={{164,-100},{184,-80}})));
        Modelica.Blocks.Interfaces.RealOutput OUT20
          annotation (Placement(transformation(extent={{164,-120},{184,-100}})));
        Modelica.Blocks.Interfaces.RealOutput OUT21
          annotation (Placement(transformation(extent={{184,60},{204,80}})));
        Modelica.Blocks.Interfaces.RealOutput OUT22
          annotation (Placement(transformation(extent={{184,40},{204,60}})));
        Modelica.Blocks.Interfaces.RealOutput OUT23
          annotation (Placement(transformation(extent={{184,20},{204,40}})));
        Modelica.Blocks.Interfaces.RealOutput OUT24
          annotation (Placement(transformation(extent={{184,0},{204,20}})));
        Modelica.Blocks.Interfaces.RealOutput OUT25
          annotation (Placement(transformation(extent={{184,-20},{204,0}})));
        Modelica.Blocks.Interfaces.RealOutput OUT26
          annotation (Placement(transformation(extent={{184,-40},{204,-20}})));
        Modelica.Blocks.Interfaces.RealOutput OUT27
          annotation (Placement(transformation(extent={{184,-60},{204,-40}})));
        Modelica.Blocks.Interfaces.RealOutput OUT28
          annotation (Placement(transformation(extent={{184,-80},{204,-60}})));
        Modelica.Blocks.Interfaces.RealOutput OUT29
          annotation (Placement(transformation(extent={{184,-100},{204,-80}})));
        Modelica.Blocks.Interfaces.RealOutput OUT30
          annotation (Placement(transformation(extent={{184,-120},{204,-100}})));
        Modelica.Blocks.Interfaces.RealOutput OUT31
          annotation (Placement(transformation(extent={{204,60},{224,80}})));
        Modelica.Blocks.Interfaces.RealOutput OUT32
          annotation (Placement(transformation(extent={{204,40},{224,60}})));
        Modelica.Blocks.Interfaces.RealOutput OUT33
          annotation (Placement(transformation(extent={{204,20},{224,40}})));
        Electrical.Buses.Bus          Bus8(angle_0=powerFlow.powerflow.bus.A5, v_0=
              powerFlow.powerflow.bus.V5)  annotation (Placement(
              transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={110,-32})));
        Electrical.Loads.PSSE.Load          Load3(
          V_b=220000,
          P_0=powerFlow.powerflow.loads.PL2,
          Q_0=powerFlow.powerflow.loads.QL2,
          v_0=powerFlow.powerflow.bus.V5,
          angle_0=powerFlow.powerflow.bus.A5) if not equivalentGRID
          annotation (Placement(transformation(extent={{100,-80},{120,-60}})));
        Electrical.Sensors.SoftPMU softPMU annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={110,-18})));
      equation

        OUT1 = G2.gen.w;
        OUT2 = G2.gen.delta;
        OUT3 = G2.gen.Epq;
        OUT4 = G2.gen.PSIkd;
        OUT5 = G2.gen.PSIppq;
        OUT6 = G2.sEXSMPC.simpleLagLim.state;
        OUT7 = G2.sEXSMPC.leadLag.TF.x[1];
        OUT8 = G2.gASTMPC.simpleLagLim.state;
        OUT9 = G2.gASTMPC.simpleLag.state;
        OUT10 = G2.gASTMPC.simpleLag1.state;
        OUT11 = G2.gASTMPC.PMECH;
        OUT12 = G2.sEXSMPC.EFD;
        OUT13 = PV.rEGCA1_1.simpleLag.state;
        OUT14 = PV.rEGCA1_1.integrator.y;
        OUT15 = PV.rEGCA1_1.integrator1.y;
        OUT16 =PV.rEECB_Constant_Q_Control.integrator.y;
        OUT17 =PV.rEECB_Constant_Q_Control.integrator1.y;
        OUT18 =PV.rEECB_Constant_Q_Control.integrator2.y;
        OUT19 =PV.rEECB_Constant_Q_Control.simpleLag.state;
        OUT20 =PV.rEECB_Constant_Q_Control.simpleLag1.state;
        OUT21 =PV.rEECB_Constant_Q_Control.integrator3.y;
        OUT22 = BESS.rEGCA1_1.simpleLag.state;
        OUT23 = BESS.rEGCA1_1.integrator.y;
        OUT24 = BESS.rEGCA1_1.integrator1.y;
        OUT25 =BESS.rEECCU1_Local_V_Control.integrator3.y;
        OUT26 =BESS.rEECCU1_Local_V_Control.integrator1.y;
        OUT27 =BESS.rEECCU1_Local_V_Control.integrator.y;
        OUT28 =BESS.rEECCU1_Local_V_Control.IGQ.y;
        OUT29 =BESS.rEECCU1_Local_V_Control.integrator4.y;
        OUT30 =BESS.rEECCU1_Local_V_Control.simpleLag.state;
        OUT31 =BESS.rEECCU1_Local_V_Control.simpleLag1.state;
        OUT32 = Bus5.v;
        OUT33 = Bus5.angle;

        connect(T1.p, Bus2.p)
          annotation (Line(points={{-51.2,70},{-40,70}}, color={0,0,255}));
        connect(Bus1.p, T1.n)
          annotation (Line(points={{-80,70},{-68.8,70}}, color={0,0,255}));
        connect(G1.conn, Bus1.p)
          annotation (Line(points={{-91,70},{-80,70}}, color={0,0,255}));
        connect(L1.n, Bus3.p)
          annotation (Line(points={{-14.6,70},{0,70}}, color={0,0,255}));
        connect(L1.p, Bus2.p)
          annotation (Line(points={{-25.4,70},{-40,70}}, color={0,0,255}));
        connect(L2_2.n, Bus4.p) annotation (Line(points={{35.4,60},{44,60},{44,70},{
                60,70}},
                      color={0,0,255}));
        connect(L2_1.n, Bus4.p) annotation (Line(points={{35.4,80},{44,80},{44,70},{
                60,70}},
                      color={0,0,255}));
        connect(L2_1.p, Bus3.p) annotation (Line(points={{24.6,80},{16,80},{16,70},{0,
                70}}, color={0,0,255}));
        connect(L2_2.p, Bus3.p) annotation (Line(points={{24.6,60},{16,60},{16,70},{0,
                70}}, color={0,0,255}));
        connect(Load1.p, Bus3.p)
          annotation (Line(points={{-10,58},{-10,70},{0,70}}, color={0,0,255}));
        connect(L3.p, Bus4.p)
          annotation (Line(points={{80,55.4},{80,70},{60,70}}, color={0,0,255}));
        connect(breaker.s, Bus5.p)
          annotation (Line(points={{80,12},{80,6}}, color={0,0,255}));
        connect(breaker.r, L3.n)
          annotation (Line(points={{80,20},{80,44.6}},color={0,0,255}));
        connect(IN11.y, AddU1.u2) annotation (Line(points={{-95.4,-6},{-82,-6}},
                            color={0,0,127}));
        connect(IN1, AddU1.u1) annotation (Line(points={{-150,0},{-116,0},{-116,6},{-82,
                6}},   color={0,0,127}));
        connect(T2.p, Bus5.p) annotation (Line(points={{51,-1.38778e-15},{58,-1.38778e-15},
                {58,0},{80,0},{80,6}},
              color={0,0,255}));

        connect(IN22.y,AddU2. u2) annotation (Line(points={{-95.4,-36},{-82,-36}},
                       color={0,0,127}));
        connect(IN2,AddU2. u1) annotation (Line(points={{-150,-22},{-118,-22},{-118,-24},
                {-82,-24}},
                       color={0,0,127}));
        connect(AddU2.y, G2.Efd_ref)
          annotation (Line(points={{-59,-30},{-52,-30},{-52,-6},{-42,-6}},
                                                                 color={0,0,127}));
        connect(AddU1.y, G2.P_ref1) annotation (Line(points={{-59,0},{-52,0},{-52,6},{
                -42,6}},                            color={0,0,127}));
        connect(IB.p, Bus4.p)
          annotation (Line(points={{100,70},{60,70}}, color={0,0,255}));
        connect(T3.n, Bus7.p) annotation (Line(points={{60,-41},{60,-86},{0,-86}},
                       color={0,0,255}));
        connect(T3.p, Bus5.p) annotation (Line(points={{60,-19},{60,0},{80,0},{80,6}},
              color={0,0,255}));
        connect(Bus6.p, T2.n)
          annotation (Line(points={{4.996e-16,-5.55112e-16},{0,-5.55112e-16},{0,0},{24,
                0},{24,1.38778e-15},{29,1.38778e-15}},
                                                  color={0,0,255}));
        connect(PV.p1, Bus7.p)
          annotation (Line(points={{-20,-70},{-6,-70},{-6,-86},{0,-86}},
                                                               color={0,0,255}));
        connect(AddU3.y, PV.QINPUT) annotation (Line(points={{-59,-60},{-50,-60},
                {-50,-70},{-42,-70}}, color={0,0,127}));
        connect(IN33.y,AddU3. u2)
          annotation (Line(points={{-95.4,-66},{-82,-66}}, color={0,0,127}));
        connect(IN3,AddU3. u1) annotation (Line(points={{-150,-44},{-114,-44},{-114,-54},
                {-82,-54}}, color={0,0,127}));
        connect(BESS.p1, Bus7.p) annotation (Line(points={{-20,-104},{-6,-104},{-6,-86},
                {0,-86}}, color={0,0,255}));
        connect(BESS.Paux1, AddU4.y) annotation (Line(points={{-42,-98},{-50,-98},{-50,
                -90},{-59,-90}}, color={0,0,127}));
        connect(IN55.y, AddU5.u2)
          annotation (Line(points={{-95.4,-122},{-82,-122}}, color={0,0,127}));
        connect(AddU5.y, BESS.Qext1) annotation (Line(points={{-59,-116},{-50,-116},{-50,
                -110},{-42,-110}}, color={0,0,127}));
        connect(IN44.y, AddU4.u2)
          annotation (Line(points={{-95.4,-96},{-82,-96}}, color={0,0,127}));
        connect(AddU4.u1, IN4) annotation (Line(points={{-82,-84},{-100,-84},{-100,-80},
                {-116,-80},{-116,-66},{-150,-66}}, color={0,0,127}));
        connect(AddU5.u1, IN5) annotation (Line(points={{-82,-110},{-116,-110},{-116,-88},
                {-150,-88}}, color={0,0,127}));
        connect(G2.conn, Bus6.p) annotation (Line(points={{-19,0},{-9.5,0},{-9.5,-5.55112e-16},
                {4.996e-16,-5.55112e-16}}, color={0,0,255}));
        connect(Load3.p, Bus8.p)
          annotation (Line(points={{110,-60},{110,-32}}, color={0,0,255}));
        connect(Bus8.p, softPMU.p)
          annotation (Line(points={{110,-32},{110,-25}}, color={0,0,255}));
        connect(softPMU.n, Bus5.p) annotation (Line(points={{110,-11},{110,0},{80,0},{
                80,6}}, color={0,0,255}));
          annotation (Placement(transformation(extent={{140,-20},{160,0}})),
                      Placement(transformation(extent={{140,-40},{160,-20}})),
                      Placement(transformation(extent={{140,-60},{160,-40}})),
                      Placement(transformation(extent={{140,-80},{160,-60}})),
                     Diagram(coordinateSystem(preserveAspectRatio=false,
                extent={{-140,-140},{140,120}}), graphics={
              Rectangle(
                extent={{130,88},{232,-134}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Rectangle(
                extent={{-160,20},{-134,-100}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,26},{124,-134}},
                lineColor={238,46,47},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,88},{124,28}},
                lineColor={0,128,255},
                lineThickness=0.5),
              Polygon(
                points={{-124,20},{-124,-130},{72,-130},{72,-60},{0,20},{-124,20}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Text(
                extent={{78,-116},{114,-130}},
                textColor={238,46,47},
                textString="Microgrid"),
              Text(
                extent={{76,48},{128,24}},
                textColor={28,108,200},
                textString="Utility Grid"),
              Text(
                extent={{6,-112},{70,-134}},
                textColor={0,140,72},
                textString="Linearization Unit"),
              Text(
                extent={{-164,40},{-132,20}},
                textColor={0,140,72},
                textString="Inputs"),
              Text(
                extent={{128,108},{168,88}},
                textColor={0,140,72},
                textString="Outputs")}),
          Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),experiment(StopTime=0.5, __Dymola_Algorithm="Dassl"),
          Icon(coordinateSystem(extent={{-140,-140},{140,120}})));
      end MPCMicrogridRenewablesIncludedPMU;

      model MPCMicrogridRenewablesZEROOUTPUTS
        "THIS ONE IS STABLE, CONTROLLABLE, OBSERVABLE!!!!!!!"
        extends Modelica.Icons.Example;

        parameter Boolean equivalentGRID = true;
        parameter Boolean equivalentsystem = false;

        OpenIPSL.Electrical.Buses.Bus Bus1(v_0=powerFlow.powerflow.bus.V1, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-90,60},{-70,80}})));
        OpenIPSL.Electrical.Buses.Bus Bus2(v_0=powerFlow.powerflow.bus.V2, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-50,60},{-30,80}})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
          R=0.001,
          X=0.2,
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000)  if not equivalentGRID annotation (Placement(transformation(
              extent={{-8,-8},{8,8}},
              rotation=180,
              origin={-60,70})));
        OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
          enableV_b=true,
          v_0=powerFlow.powerflow.bus.V1,
          angle_0=powerFlow.powerflow.bus.A1,
          P_0=powerFlow.powerflow.machines.PG1,
          Q_0=powerFlow.powerflow.machines.QG1,
          V_b=6000)  if not equivalentGRID
          annotation (Placement(transformation(extent={{-112,60},{-92,80}})));
        OpenIPSL.Electrical.Branches.PwLine L1(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{-26,66},{-14,74}})));
        OpenIPSL.Electrical.Buses.Bus Bus3(v_0=powerFlow.powerflow.bus.V3, angle_0=
              powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-10,60},{10,80}})));
        OpenIPSL.Electrical.Buses.Bus Bus4(v_0=powerFlow.powerflow.bus.V4, angle_0=
              powerFlow.powerflow.bus.V4) if not equivalentGRID
          annotation (Placement(transformation(extent={{50,60},{70,80}})));
        OpenIPSL.Electrical.Branches.PwLine L2_1(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,76},{36,84}})));
        OpenIPSL.Electrical.Branches.PwLine L2_2(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,56},{36,64}})));
        OpenIPSL.Electrical.Buses.Bus Bus5(angle_0=powerFlow.powerflow.bus.A5, v_0=
              powerFlow.powerflow.bus.V5)  annotation (Placement(
              transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={80,6})));
        OpenIPSL.Electrical.Branches.PwLine L3(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=-90,
              origin={80,50})));
        OpenIPSL.Electrical.Buses.Bus Bus6(v_0=powerFlow.powerflow.bus.V6, angle_0=
              powerFlow.powerflow.bus.A6) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180)));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000,
          R=0.005,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={40,0})));
        GenerationUnits.PSSE.G2_16MVA                         G2(
          enableV_b=true,
          enableP_0=true,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V6,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A6,
          V_b=6000,
          P_0=powerFlow.powerflow.machines.PG2,
          Q_0=powerFlow.powerflow.machines.QG2,
          enableangle_0=true)
                        annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-30,0})));
        inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000, fn=60)
          annotation (Placement(transformation(extent={{-128,94},{-74,114}})));
        OpenIPSL.Electrical.Loads.PSSE.Load Load1(
          V_b=220000,
          P_0=powerFlow.powerflow.loads.PL1,
          Q_0=powerFlow.powerflow.loads.QL1,
          v_0=powerFlow.powerflow.bus.V3,
          angle_0=powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-20,38},{0,58}})));
        Electrical.Events.Breaker breaker(enableTrigger=false,
          t_o=1.01,
          rc_enabled=true,
          t_rc=80.01)       if not equivalentGRID                     annotation (Placement(transformation(
              extent={{-4,-4},{4,4}},
              rotation=90,
              origin={80,16})));

        Modelica.Blocks.Interfaces.RealInput IN1(start=0)
          "Connector of Real input signal 2" annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-150,0}), iconTransformation(extent={{-10,-10},{10,10}}, origin=
                 {-150,0})));
        Modelica.Blocks.Sources.Constant IN11(k=0)
          annotation (Placement(transformation(extent={{-108,-12},{-96,0}})));
        Modelica.Blocks.Math.Add AddU1
          annotation (Placement(transformation(extent={{-80,-10},{-60,10}})));
        Modelica.Blocks.Sources.Constant IN22(k=0)
          annotation (Placement(transformation(extent={{-108,-42},{-96,-30}})));
        Modelica.Blocks.Math.Add AddU2
          annotation (Placement(transformation(extent={{-80,-40},{-60,-20}})));
        Modelica.Blocks.Interfaces.RealInput IN2(start=0)
          "Connector of Real input signal 2"
                 annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-150,-22}), iconTransformation(extent={{-10,-10},{10,10}},
                origin={-150,-22})));
        Modelica.Blocks.Interfaces.RealInput IN3(start = 0) "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-54},{-140,-34}}),
              iconTransformation(extent={{-160,-54},{-140,-34}})));
        Modelica.Blocks.Interfaces.RealInput IN4(start = 0) "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-76},{-140,-56}}),
              iconTransformation(extent={{-160,-76},{-140,-56}})));
        Modelica.Blocks.Interfaces.RealInput IN5(start = 0) "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-98},{-140,-78}}),
              iconTransformation(extent={{-160,-98},{-140,-78}})));

        Modelica.Blocks.Interfaces.RealOutput OUT1
          annotation (Placement(transformation(extent={{140,60},{160,80}})));
       Modelica.Blocks.Interfaces.RealOutput OUT2
          annotation (Placement(transformation(extent={{140,40},{160,60}})));
        Modelica.Blocks.Interfaces.RealOutput OUT3
          annotation (Placement(transformation(extent={{140,20},{160,40}})));

        PFData.PowerFlow powerFlow(redeclare record PowerFlow =
              OpenIPSL.Examples.ModelPredictiveControl.PFData.PF13)
          annotation (Placement(transformation(extent={{-68,94},{-48,114}})));
        Electrical.Machines.PSSE.GENCLS IB(
          V_b=220000,
          v_0=powerFlow.powerflow.bus.V4,
          angle_0=powerFlow.powerflow.bus.A4,
          P_0=powerFlow.powerflow.machines.Pinf,
          Q_0=powerFlow.powerflow.machines.Qinf,
          M_b=100000000,
          X_d=1) if not equivalentGRID annotation (Placement(transformation(extent={{110,60},{100,80}})));
        Electrical.Loads.PSSE.Load_ExtInput Load2(
          P_0=powerFlow.powerflow.loads.PL2,
          Q_0=powerFlow.powerflow.loads.QL2,
          v_0=powerFlow.powerflow.bus.V5,
          angle_0=powerFlow.powerflow.bus.A5,
          d_P=0,
          t1=100,
          d_t=1000)
          annotation (Placement(transformation(extent={{100,-40},{120,-20}})));
        Electrical.Loads.NoiseInjections.WhiteNoiseInjection whiteNoiseInjection(
            active_sigma=0.0000000005,
                                  samplePeriod=0.02)
          annotation (Placement(transformation(extent={{76,-24},{82,-18}})));

        inner Modelica.Blocks.Noise.GlobalSeed globalSeed(useAutomaticSeed=false,
            fixedSeed=10000)
          annotation (Placement(transformation(extent={{-42,92},{-22,112}})));
        Modelica.Blocks.Sources.Sine sine(
          amplitude=0,
          f=1/260,
          phase=3.1415926535898,
          startTime=1000)
          annotation (Placement(transformation(extent={{76,-36},{82,-30}})));
        Modelica.Blocks.Math.Add add
          annotation (Placement(transformation(extent={{86,-28},{94,-20}})));

        Electrical.Buses.Bus          Bus7(v_0=powerFlow.powerflow.bus.V7, angle_0=
              powerFlow.powerflow.bus.A7) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={0,-86})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T3(
          G=0,
          B=0,
          CW=1,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=270,
              origin={60,-30})));
        GenerationUnits.PSSE.Solar_Units.SolarMPCLocalQControl PV(
          V_b=480,
          P_0=powerFlow.powerflow.machines.PPV,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QPV,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V7,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A7,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-80},{-20,-60}})));
        Modelica.Blocks.Math.Add AddU3
          annotation (Placement(transformation(extent={{-80,-70},{-60,-50}})));
        Modelica.Blocks.Sources.Constant IN33(k=0)
          annotation (Placement(transformation(extent={{-108,-72},{-96,-60}})));

        Modelica.Blocks.Math.Add AddU4
          annotation (Placement(transformation(extent={{-80,-100},{-60,-80}})));
        Modelica.Blocks.Math.Add AddU5
          annotation (Placement(transformation(extent={{-80,-126},{-60,-106}})));
        Modelica.Blocks.Sources.Constant IN44(k=0)
          annotation (Placement(transformation(extent={{-108,-102},{-96,-90}})));
        Modelica.Blocks.Sources.Constant IN55(k=0)
          annotation (Placement(transformation(extent={{-108,-128},{-96,-116}})));
      equation

        OUT1 = G2.gen.w;
        OUT2 = G2.gen.delta;
        OUT3 = G2.gen.Epq;
      //   OUT4 = G2.gen.PSIkd;
      //   OUT5 = G2.gen.PSIppq;
      //   OUT6 = G2.sEXSMPC.simpleLagLim.state;
      //   OUT7 = G2.sEXSMPC.leadLag.TF.x[1];
      //   OUT8 = G2.gASTMPC.simpleLagLim.state;
      //   OUT9 = G2.gASTMPC.simpleLag.state;
      //   OUT10 = G2.gASTMPC.simpleLag1.state;
      //   OUT11 = G2.gASTMPC.PMECH;
      //   OUT12 = G2.sEXSMPC.EFD;
      //   OUT13 = PV.rEGCA1_1.simpleLag.state;
      //   OUT14 = PV.rEGCA1_1.integrator.y;
      //   OUT15 = PV.rEGCA1_1.integrator1.y;
      //   OUT16 = PV.rEECB1_1.integrator.y;
      //   OUT17 = PV.rEECB1_1.integrator1.y;
      //   OUT18 = PV.rEECB1_1.integrator2.y;
      //   OUT19 = PV.rEECB1_1.simpleLag.state;
      //   OUT20 = PV.rEECB1_1.simpleLag1.state;
      //   OUT21 = PV.rEECB1_1.integrator3.y;
      //   OUT22 = BESS.rEGCA1_1.simpleLag.state;
      //   OUT23 = BESS.rEGCA1_1.integrator.y;
      //   OUT24 = BESS.rEGCA1_1.integrator1.y;
      //   OUT25 = BESS.rEECCU1_1.integrator3.y;
      //   OUT26 = BESS.rEECCU1_1.integrator1.y;
      //   OUT27 = BESS.rEECCU1_1.integrator.y;
      //   OUT28 = BESS.rEECCU1_1.integrator2.y;
      //   OUT29 = BESS.rEECCU1_1.integrator4.y;
      //   OUT30 = BESS.rEECCU1_1.simpleLag.state;
      //   OUT31 = BESS.rEECCU1_1.simpleLag1.state;
      //   OUT32 = Bus5.v;
      //   OUT33 = Bus5.angle;

        connect(T1.p, Bus2.p)
          annotation (Line(points={{-51.2,70},{-40,70}}, color={0,0,255}));
        connect(Bus1.p, T1.n)
          annotation (Line(points={{-80,70},{-68.8,70}}, color={0,0,255}));
        connect(G1.conn, Bus1.p)
          annotation (Line(points={{-91,70},{-80,70}}, color={0,0,255}));
        connect(L1.n, Bus3.p)
          annotation (Line(points={{-14.6,70},{0,70}}, color={0,0,255}));
        connect(L1.p, Bus2.p)
          annotation (Line(points={{-25.4,70},{-40,70}}, color={0,0,255}));
        connect(L2_2.n, Bus4.p) annotation (Line(points={{35.4,60},{44,60},{44,70},{
                60,70}},
                      color={0,0,255}));
        connect(L2_1.n, Bus4.p) annotation (Line(points={{35.4,80},{44,80},{44,70},{
                60,70}},
                      color={0,0,255}));
        connect(L2_1.p, Bus3.p) annotation (Line(points={{24.6,80},{16,80},{16,70},{0,
                70}}, color={0,0,255}));
        connect(L2_2.p, Bus3.p) annotation (Line(points={{24.6,60},{16,60},{16,70},{0,
                70}}, color={0,0,255}));
        connect(Load1.p, Bus3.p)
          annotation (Line(points={{-10,58},{-10,70},{0,70}}, color={0,0,255}));
        connect(L3.p, Bus4.p)
          annotation (Line(points={{80,55.4},{80,70},{60,70}}, color={0,0,255}));
        connect(breaker.s, Bus5.p)
          annotation (Line(points={{80,12},{80,6}}, color={0,0,255}));
        connect(breaker.r, L3.n)
          annotation (Line(points={{80,20},{80,44.6}},color={0,0,255}));
        connect(IN11.y, AddU1.u2) annotation (Line(points={{-95.4,-6},{-82,-6}},
                            color={0,0,127}));
        connect(IN1, AddU1.u1) annotation (Line(points={{-150,0},{-116,0},{-116,6},{-82,
                6}},   color={0,0,127}));
        connect(T2.p, Bus5.p) annotation (Line(points={{51,-1.38778e-15},{58,-1.38778e-15},
                {58,0},{80,0},{80,6}},
              color={0,0,255}));

        connect(IN22.y,AddU2. u2) annotation (Line(points={{-95.4,-36},{-82,-36}},
                       color={0,0,127}));
        connect(IN2,AddU2. u1) annotation (Line(points={{-150,-22},{-118,-22},{-118,-24},
                {-82,-24}},
                       color={0,0,127}));
        connect(AddU2.y, G2.Efd_ref)
          annotation (Line(points={{-59,-30},{-52,-30},{-52,-6},{-42,-6}},
                                                                 color={0,0,127}));
        connect(AddU1.y, G2.P_ref1) annotation (Line(points={{-59,0},{-52,0},{-52,6},{
                -42,6}},                            color={0,0,127}));
        connect(IB.p, Bus4.p)
          annotation (Line(points={{100,70},{60,70}}, color={0,0,255}));
        connect(Load2.p, Bus5.p) annotation (Line(points={{110,-20},{110,0},{80,0},{80,
                6}}, color={0,0,255}));
        connect(sine.y, add.u2) annotation (Line(points={{82.3,-33},{82.3,-34},{85.2,-34},
                {85.2,-26.4}}, color={0,0,127}));
        connect(whiteNoiseInjection.y, add.u1) annotation (Line(points={{82.27,-21.03},
                {82.27,-21.6},{85.2,-21.6}}, color={0,0,127}));
        connect(add.y, Load2.u) annotation (Line(points={{94.4,-24},{94.4,-24.5},{101.9,
                -24.5}}, color={0,0,127}));
        connect(T3.n, Bus7.p) annotation (Line(points={{60,-41},{60,-86},{0,-86}},
                       color={0,0,255}));
        connect(T3.p, Bus5.p) annotation (Line(points={{60,-19},{60,0},{80,0},{80,6}},
              color={0,0,255}));
        connect(Bus6.p, T2.n)
          annotation (Line(points={{4.996e-16,-5.55112e-16},{0,-5.55112e-16},{0,0},{24,
                0},{24,1.38778e-15},{29,1.38778e-15}},
                                                  color={0,0,255}));
        connect(PV.p1, Bus7.p)
          annotation (Line(points={{-20,-70},{-6,-70},{-6,-86},{0,-86}},
                                                               color={0,0,255}));
        connect(AddU3.y, PV.QINPUT) annotation (Line(points={{-59,-60},{-50,-60},{-50,
                -70},{-42,-70}}, color={0,0,127}));
        connect(IN33.y,AddU3. u2)
          annotation (Line(points={{-95.4,-66},{-82,-66}}, color={0,0,127}));
        connect(IN3,AddU3. u1) annotation (Line(points={{-150,-44},{-114,-44},{-114,-54},
                {-82,-54}}, color={0,0,127}));
        connect(BESS.p1, Bus7.p) annotation (Line(points={{-20,-104},{-6,-104},{-6,-86},
                {0,-86}}, color={0,0,255}));
        connect(BESS.Paux1, AddU4.y) annotation (Line(points={{-42,-98},{-50,-98},{-50,
                -90},{-59,-90}}, color={0,0,127}));
        connect(IN55.y, AddU5.u2)
          annotation (Line(points={{-95.4,-122},{-82,-122}}, color={0,0,127}));
        connect(AddU5.y, BESS.Qext1) annotation (Line(points={{-59,-116},{-50,-116},{-50,
                -110},{-42,-110}}, color={0,0,127}));
        connect(IN44.y, AddU4.u2)
          annotation (Line(points={{-95.4,-96},{-82,-96}}, color={0,0,127}));
        connect(AddU4.u1, IN4) annotation (Line(points={{-82,-84},{-100,-84},{-100,-80},
                {-116,-80},{-116,-66},{-150,-66}}, color={0,0,127}));
        connect(AddU5.u1, IN5) annotation (Line(points={{-82,-110},{-116,-110},{-116,-88},
                {-150,-88}}, color={0,0,127}));
        connect(G2.conn, Bus6.p) annotation (Line(points={{-19,0},{-9.5,0},{-9.5,-5.55112e-16},
                {4.996e-16,-5.55112e-16}}, color={0,0,255}));
          annotation (Placement(transformation(extent={{140,-20},{160,0}})),
                      Placement(transformation(extent={{140,-40},{160,-20}})),
                      Placement(transformation(extent={{140,-60},{160,-40}})),
                      Placement(transformation(extent={{140,-80},{160,-60}})),
                     Diagram(coordinateSystem(preserveAspectRatio=false,
                extent={{-140,-140},{140,120}}), graphics={
              Rectangle(
                extent={{130,88},{232,-134}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Rectangle(
                extent={{-160,20},{-134,-100}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,26},{124,-134}},
                lineColor={238,46,47},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,88},{124,28}},
                lineColor={0,128,255},
                lineThickness=0.5),
              Polygon(
                points={{-124,20},{-124,-130},{72,-130},{72,-60},{0,20},{-124,20}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Text(
                extent={{78,-116},{114,-130}},
                textColor={238,46,47},
                textString="Microgrid"),
              Text(
                extent={{76,48},{128,24}},
                textColor={28,108,200},
                textString="Utility Grid"),
              Text(
                extent={{6,-112},{70,-134}},
                textColor={0,140,72},
                textString="Linearization Unit"),
              Text(
                extent={{-164,40},{-132,20}},
                textColor={0,140,72},
                textString="Inputs"),
              Text(
                extent={{128,108},{168,88}},
                textColor={0,140,72},
                textString="Outputs")}),
          Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),experiment(StopTime=0.5, __Dymola_Algorithm="Dassl"),
          Icon(coordinateSystem(extent={{-140,-140},{140,120}})));
      end MPCMicrogridRenewablesZEROOUTPUTS;

      model MPCMicrogridGasPV_01 "Microgrid with G2 and PV on Q Control"
        extends Modelica.Icons.Example;

        parameter Boolean equivalentGRID = false;
        parameter Boolean equivalentsystem = false;

        OpenIPSL.Electrical.Buses.Bus Bus1(v_0=powerFlow.powerflow.bus.V1, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-90,70},{-70,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus2(v_0=powerFlow.powerflow.bus.V2, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-50,70},{-30,90}})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
          R=0.001,
          X=0.2,
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000)  if not equivalentGRID annotation (Placement(transformation(
              extent={{-8,-8},{8,8}},
              rotation=180,
              origin={-60,80})));
        OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
          enableV_b=true,
          v_0=powerFlow.powerflow.bus.V1,
          angle_0=powerFlow.powerflow.bus.A1,
          P_0=powerFlow.powerflow.machines.PG1,
          Q_0=powerFlow.powerflow.machines.QG1,
          V_b=6000)  if not equivalentGRID
          annotation (Placement(transformation(extent={{-112,70},{-92,90}})));
        OpenIPSL.Electrical.Branches.PwLine L1(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{-26,76},
                  {-14,84}})));
        OpenIPSL.Electrical.Buses.Bus Bus3(v_0=powerFlow.powerflow.bus.V3, angle_0=
              powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-10,70},{10,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus4(v_0=powerFlow.powerflow.bus.V4, angle_0=
              powerFlow.powerflow.bus.V4) if not equivalentGRID
          annotation (Placement(transformation(extent={{50,70},{70,90}})));
        OpenIPSL.Electrical.Branches.PwLine L2_1(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,86},
                  {36,94}})));
        OpenIPSL.Electrical.Branches.PwLine L2_2(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,66},
                  {36,74}})));
        OpenIPSL.Electrical.Buses.Bus Bus5(angle_0=powerFlow.powerflow.bus.A5, v_0=
              powerFlow.powerflow.bus.V5)  annotation (Placement(
              transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={80,16})));
        OpenIPSL.Electrical.Branches.PwLine L3(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=-90,
              origin={80,60})));
        OpenIPSL.Electrical.Buses.Bus Bus6(v_0=powerFlow.powerflow.bus.V6, angle_0=
              powerFlow.powerflow.bus.A6) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={0,10})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000,
          R=0.005,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={40,10})));
        GenerationUnits.PSSE.G2_16MVA                         G2(
          enableV_b=true,
          enableP_0=true,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V6,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A6,
          V_b=6000,
          P_0=powerFlow.powerflow.machines.PG2,
          Q_0=powerFlow.powerflow.machines.QG2,
          enableangle_0=true)
                        annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-30,10})));
        inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000, fn=60)
          annotation (Placement(transformation(extent={{-128,104},{-74,124}})));
        OpenIPSL.Electrical.Loads.PSSE.Load Load1(
          V_b=220000,
          P_0=powerFlow.powerflow.loads.PL1,
          Q_0=powerFlow.powerflow.loads.QL1,
          v_0=powerFlow.powerflow.bus.V3,
          angle_0=powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-20,48},{0,68}})));
        Electrical.Events.Breaker breaker(enableTrigger=false,
          t_o=1.01,
          rc_enabled=true,
          t_rc=80.01)       if not equivalentGRID                     annotation (Placement(transformation(
              extent={{-4,-4},{4,4}},
              rotation=90,
              origin={80,26})));

        Modelica.Blocks.Interfaces.RealInput IN1(start=0)
          "Connector of Real input signal 2" annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-150,10}),iconTransformation(extent={{-10,-10},{10,10}}, origin={-150,10})));
        Modelica.Blocks.Sources.Constant IN11(k=0)
          annotation (Placement(transformation(extent={{-108,-2},{-96,10}})));
        Modelica.Blocks.Math.Add AddU1
          annotation (Placement(transformation(extent={{-80,0},{-60,20}})));
        Modelica.Blocks.Sources.Constant IN22(k=0)
          annotation (Placement(transformation(extent={{-108,-32},{-96,-20}})));
        Modelica.Blocks.Math.Add AddU2
          annotation (Placement(transformation(extent={{-80,-30},{-60,-10}})));
        Modelica.Blocks.Interfaces.RealInput IN2(start=0)
          "Connector of Real input signal 2"
                 annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-150,-12}), iconTransformation(extent={{-10,-10},{10,10}},
                origin={-150,-12})));
        Modelica.Blocks.Interfaces.RealInput IN3(start = 0) "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-44},{-140,-24}}),
              iconTransformation(extent={{-160,-44},{-140,-24}})));

        Modelica.Blocks.Interfaces.RealOutput OUT1
          annotation (Placement(transformation(extent={{140,70},{160,90}})));
       Modelica.Blocks.Interfaces.RealOutput OUT2
          annotation (Placement(transformation(extent={{140,50},{160,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT3
          annotation (Placement(transformation(extent={{140,30},{160,50}})));

        PFData.PowerFlow powerFlow(redeclare record PowerFlow =
              OpenIPSL.Examples.ModelPredictiveControl.PFData.PF14)
          annotation (Placement(transformation(extent={{-68,104},{-48,124}})));
        Electrical.Machines.PSSE.GENCLS IB(
          V_b=220000,
          v_0=powerFlow.powerflow.bus.V4,
          angle_0=powerFlow.powerflow.bus.A4,
          P_0=powerFlow.powerflow.machines.Pinf,
          Q_0=powerFlow.powerflow.machines.Qinf,
          M_b=100000000,
          X_d=1) if not equivalentGRID annotation (Placement(transformation(extent={{110,70},
                  {100,90}})));
        Electrical.Loads.PSSE.Load_ExtInput Load2(
          P_0=powerFlow.powerflow.loads.PL2,
          Q_0=powerFlow.powerflow.loads.QL2,
          v_0=powerFlow.powerflow.bus.V5,
          angle_0=powerFlow.powerflow.bus.A5,
          d_P=0,
          t1=100,
          d_t=1000)
          annotation (Placement(transformation(extent={{100,-30},{120,-10}})));
        Electrical.Loads.NoiseInjections.WhiteNoiseInjection whiteNoiseInjection(
            active_sigma=0.0000000005,
                                  samplePeriod=0.02)
          annotation (Placement(transformation(extent={{76,-14},{82,-8}})));

        inner Modelica.Blocks.Noise.GlobalSeed globalSeed(useAutomaticSeed=false,
            fixedSeed=10000)
          annotation (Placement(transformation(extent={{-42,102},{-22,122}})));
        Modelica.Blocks.Sources.Sine sine(
          amplitude=0,
          f=1/260,
          phase=3.1415926535898,
          startTime=1000)
          annotation (Placement(transformation(extent={{76,-26},{82,-20}})));
        Modelica.Blocks.Math.Add add
          annotation (Placement(transformation(extent={{86,-18},{94,-10}})));

        Electrical.Buses.Bus          Bus7(v_0=powerFlow.powerflow.bus.V7, angle_0=
              powerFlow.powerflow.bus.A7) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={0,-76})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T3(
          G=0,
          B=0,
          CW=1,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=270,
              origin={60,-20})));
        GenerationUnits.PSSE.Solar_Units.SolarMPCLocalQControl PV(
          V_b=480,
          P_0=powerFlow.powerflow.machines.PPV,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QPV,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V7,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A7,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-86},{-20,-66}})));
        Modelica.Blocks.Math.Add AddU3
          annotation (Placement(transformation(extent={{-80,-60},{-60,-40}})));
        Modelica.Blocks.Sources.Constant IN33(k=0)
          annotation (Placement(transformation(extent={{-108,-62},{-96,-50}})));

        Modelica.Blocks.Interfaces.RealOutput OUT4
          annotation (Placement(transformation(extent={{140,10},{160,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT5
          annotation (Placement(transformation(extent={{140,-10},{160,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT6
          annotation (Placement(transformation(extent={{140,-30},{160,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT7
          annotation (Placement(transformation(extent={{140,-50},{160,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT8
          annotation (Placement(transformation(extent={{140,-70},{160,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT9
          annotation (Placement(transformation(extent={{140,-90},{160,-70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT10
          annotation (Placement(transformation(extent={{140,-110},{160,-90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT11
          annotation (Placement(transformation(extent={{164,70},{184,90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT12
          annotation (Placement(transformation(extent={{164,50},{184,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT13
          annotation (Placement(transformation(extent={{164,30},{184,50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT14
          annotation (Placement(transformation(extent={{164,10},{184,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT15
          annotation (Placement(transformation(extent={{164,-10},{184,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT16
          annotation (Placement(transformation(extent={{164,-30},{184,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT17
          annotation (Placement(transformation(extent={{164,-50},{184,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT18
          annotation (Placement(transformation(extent={{164,-70},{184,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT19
          annotation (Placement(transformation(extent={{164,-90},{184,-70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT20
          annotation (Placement(transformation(extent={{164,-110},{184,-90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT21
          annotation (Placement(transformation(extent={{184,70},{204,90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT22
          annotation (Placement(transformation(extent={{184,50},{204,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT23
          annotation (Placement(transformation(extent={{184,30},{204,50}})));
      equation

        OUT1 = G2.gen.w;
        OUT2 = G2.gen.delta;
        OUT3 = G2.gen.Epq;
        OUT4 = G2.gen.PSIkd;
        OUT5 = G2.gen.PSIppq;
        OUT6 = G2.sEXSMPC.simpleLagLim.state;
        OUT7 = G2.sEXSMPC.leadLag.TF.x[1];
        OUT8 = G2.gASTMPC.simpleLagLim.state;
        OUT9 = G2.gASTMPC.simpleLag.state;
        OUT10 = G2.gASTMPC.simpleLag1.state;
        OUT11 = PV.rEGCA1_1.simpleLag.state;
        OUT12 = PV.rEGCA1_1.integrator.y;
        OUT13 = PV.rEGCA1_1.integrator1.y;
        OUT14 = PV.rEECB_Constant_Q_Control.simpleLag.state;
        OUT15 = PV.rEECB_Constant_Q_Control.integrator3.y;
        OUT16 = PV.rEECB_Constant_Q_Control.simpleLag1.state;
        OUT17 = PV.rEECB_Constant_Q_Control.simpleLag2.state;
        OUT18 = G2.gen.PMECH;
        OUT19 = G2.sEXSMPC.EFD;
        OUT20 = Bus7.v;
        OUT21 = Bus7.angle;
        OUT22 = Bus5.v;
        OUT23 = Bus5.angle;

        connect(T1.p, Bus2.p)
          annotation (Line(points={{-51.2,80},{-40,80}}, color={0,0,255}));
        connect(Bus1.p, T1.n)
          annotation (Line(points={{-80,80},{-68.8,80}}, color={0,0,255}));
        connect(G1.conn, Bus1.p)
          annotation (Line(points={{-91,80},{-80,80}}, color={0,0,255}));
        connect(L1.n, Bus3.p)
          annotation (Line(points={{-14.6,80},{0,80}}, color={0,0,255}));
        connect(L1.p, Bus2.p)
          annotation (Line(points={{-25.4,80},{-40,80}}, color={0,0,255}));
        connect(L2_2.n, Bus4.p) annotation (Line(points={{35.4,70},{44,70},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.n, Bus4.p) annotation (Line(points={{35.4,90},{44,90},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.p, Bus3.p) annotation (Line(points={{24.6,90},{16,90},{16,80},{0,
                80}}, color={0,0,255}));
        connect(L2_2.p, Bus3.p) annotation (Line(points={{24.6,70},{16,70},{16,80},{0,
                80}}, color={0,0,255}));
        connect(Load1.p, Bus3.p)
          annotation (Line(points={{-10,68},{-10,80},{0,80}}, color={0,0,255}));
        connect(L3.p, Bus4.p)
          annotation (Line(points={{80,65.4},{80,80},{60,80}}, color={0,0,255}));
        connect(breaker.s, Bus5.p)
          annotation (Line(points={{80,22},{80,16}},color={0,0,255}));
        connect(breaker.r, L3.n)
          annotation (Line(points={{80,30},{80,54.6}},color={0,0,255}));
        connect(IN11.y, AddU1.u2) annotation (Line(points={{-95.4,4},{-82,4}},
                            color={0,0,127}));
        connect(IN1, AddU1.u1) annotation (Line(points={{-150,10},{-116,10},{-116,16},
                {-82,16}},
                       color={0,0,127}));
        connect(T2.p, Bus5.p) annotation (Line(points={{51,10},{80,10},{80,16}},
              color={0,0,255}));

        connect(IN22.y,AddU2. u2) annotation (Line(points={{-95.4,-26},{-82,-26}},
                       color={0,0,127}));
        connect(IN2,AddU2. u1) annotation (Line(points={{-150,-12},{-118,-12},{-118,-14},
                {-82,-14}},
                       color={0,0,127}));
        connect(AddU2.y, G2.Efd_ref)
          annotation (Line(points={{-59,-20},{-52,-20},{-52,4},{-42,4}},
                                                                 color={0,0,127}));
        connect(AddU1.y, G2.P_ref1) annotation (Line(points={{-59,10},{-52,10},{-52,16},
                {-42,16}},                          color={0,0,127}));
        connect(IB.p, Bus4.p)
          annotation (Line(points={{100,80},{60,80}}, color={0,0,255}));
        connect(Load2.p, Bus5.p) annotation (Line(points={{110,-10},{110,10},{80,10},{
                80,16}},
                     color={0,0,255}));
        connect(sine.y, add.u2) annotation (Line(points={{82.3,-23},{82.3,-24},{85.2,-24},
                {85.2,-16.4}}, color={0,0,127}));
        connect(whiteNoiseInjection.y, add.u1) annotation (Line(points={{82.27,-11.03},
                {82.27,-11.6},{85.2,-11.6}}, color={0,0,127}));
        connect(add.y, Load2.u) annotation (Line(points={{94.4,-14},{94.4,-14.5},{101.9,
                -14.5}}, color={0,0,127}));
        connect(T3.n, Bus7.p) annotation (Line(points={{60,-31},{60,-76},{0,-76}},
                       color={0,0,255}));
        connect(T3.p, Bus5.p) annotation (Line(points={{60,-9},{60,10},{80,10},{80,16}},
              color={0,0,255}));
        connect(Bus6.p, T2.n)
          annotation (Line(points={{4.996e-16,10},{29,10}},
                                                  color={0,0,255}));
        connect(PV.p1, Bus7.p)
          annotation (Line(points={{-20,-76},{4.996e-16,-76}}, color={0,0,255}));
        connect(AddU3.y, PV.QINPUT) annotation (Line(points={{-59,-50},{-50,-50},{-50,
                -76},{-42,-76}}, color={0,0,127}));
        connect(IN33.y,AddU3. u2)
          annotation (Line(points={{-95.4,-56},{-82,-56}}, color={0,0,127}));
        connect(IN3,AddU3. u1) annotation (Line(points={{-150,-34},{-114,-34},{-114,-44},
                {-82,-44}}, color={0,0,127}));
        connect(G2.conn, Bus6.p) annotation (Line(points={{-19,10},{4.996e-16,10}},
                                           color={0,0,255}));
          annotation (Placement(transformation(extent={{140,-20},{160,0}})),
                      Placement(transformation(extent={{140,-40},{160,-20}})),
                      Placement(transformation(extent={{140,-60},{160,-40}})),
                      Placement(transformation(extent={{140,-80},{160,-60}})),
                     Diagram(coordinateSystem(preserveAspectRatio=false,
                extent={{-140,-140},{140,140}}), graphics={
              Rectangle(
                extent={{130,98},{232,-124}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Rectangle(
                extent={{-160,30},{-136,-60}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,36},{124,-124}},
                lineColor={238,46,47},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,98},{124,38}},
                lineColor={0,128,255},
                lineThickness=0.5),
              Polygon(
                points={{-124,30},{-124,-120},{72,-120},{72,-50},{0,30},{-124,30}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Text(
                extent={{78,-106},{114,-120}},
                textColor={238,46,47},
                textString="Microgrid"),
              Text(
                extent={{76,58},{128,34}},
                textColor={28,108,200},
                textString="Utility Grid"),
              Text(
                extent={{6,-102},{70,-124}},
                textColor={0,140,72},
                textString="Linearization Unit"),
              Text(
                extent={{-164,50},{-132,30}},
                textColor={0,140,72},
                textString="Inputs"),
              Text(
                extent={{128,118},{168,98}},
                textColor={0,140,72},
                textString="Outputs")}),
          Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),experiment(StopTime=0.9, __Dymola_Algorithm="Dassl"),
          Icon(coordinateSystem(extent={{-140,-140},{140,140}})));
      end MPCMicrogridGasPV_01;

      model MPCMicrogridGasPV_02
        "Microgrid with G2 and PV on Local V Control"
        extends Modelica.Icons.Example;

        parameter Boolean equivalentGRID = false;
        parameter Boolean equivalentsystem = false;

        OpenIPSL.Electrical.Buses.Bus Bus1(v_0=powerFlow.powerflow.bus.V1, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-90,70},{-70,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus2(v_0=powerFlow.powerflow.bus.V2, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-50,70},{-30,90}})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
          R=0.001,
          X=0.2,
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000)  if not equivalentGRID annotation (Placement(transformation(
              extent={{-8,-8},{8,8}},
              rotation=180,
              origin={-60,80})));
        OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
          enableV_b=true,
          v_0=powerFlow.powerflow.bus.V1,
          angle_0=powerFlow.powerflow.bus.A1,
          P_0=powerFlow.powerflow.machines.PG1,
          Q_0=powerFlow.powerflow.machines.QG1,
          V_b=6000)  if not equivalentGRID
          annotation (Placement(transformation(extent={{-112,70},{-92,90}})));
        OpenIPSL.Electrical.Branches.PwLine L1(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{-26,76},
                  {-14,84}})));
        OpenIPSL.Electrical.Buses.Bus Bus3(v_0=powerFlow.powerflow.bus.V3, angle_0=
              powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-10,70},{10,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus4(v_0=powerFlow.powerflow.bus.V4, angle_0=
              powerFlow.powerflow.bus.V4) if not equivalentGRID
          annotation (Placement(transformation(extent={{50,70},{70,90}})));
        OpenIPSL.Electrical.Branches.PwLine L2_1(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,86},
                  {36,94}})));
        OpenIPSL.Electrical.Branches.PwLine L2_2(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,66},
                  {36,74}})));
        OpenIPSL.Electrical.Buses.Bus Bus5(angle_0=powerFlow.powerflow.bus.A5, v_0=
              powerFlow.powerflow.bus.V5)  annotation (Placement(
              transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={80,16})));
        OpenIPSL.Electrical.Branches.PwLine L3(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=-90,
              origin={80,60})));
        OpenIPSL.Electrical.Buses.Bus Bus6(v_0=powerFlow.powerflow.bus.V6, angle_0=
              powerFlow.powerflow.bus.A6) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={0,10})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000,
          R=0.005,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={40,10})));
        GenerationUnits.PSSE.G2_16MVA                         G2(
          enableV_b=true,
          enableP_0=true,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V6,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A6,
          V_b=6000,
          P_0=powerFlow.powerflow.machines.PG2,
          Q_0=powerFlow.powerflow.machines.QG2,
          enableangle_0=true)
                        annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-30,10})));
        inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000, fn=60)
          annotation (Placement(transformation(extent={{-128,104},{-74,124}})));
        OpenIPSL.Electrical.Loads.PSSE.Load Load1(
          V_b=220000,
          P_0=powerFlow.powerflow.loads.PL1,
          Q_0=powerFlow.powerflow.loads.QL1,
          v_0=powerFlow.powerflow.bus.V3,
          angle_0=powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-20,48},{0,68}})));
        Electrical.Events.Breaker breaker(enableTrigger=false,
          t_o=1.01,
          rc_enabled=true,
          t_rc=800.01)      if not equivalentGRID                     annotation (Placement(transformation(
              extent={{-4,-4},{4,4}},
              rotation=90,
              origin={80,26})));

        Modelica.Blocks.Interfaces.RealInput IN1(start=0)
          "Connector of Real input signal 2" annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-150,10}),iconTransformation(extent={{-10,-10},{10,10}}, origin={-150,10})));
        Modelica.Blocks.Sources.Constant IN11(k=0)
          annotation (Placement(transformation(extent={{-108,-2},{-96,10}})));
        Modelica.Blocks.Math.Add AddU1
          annotation (Placement(transformation(extent={{-80,0},{-60,20}})));
        Modelica.Blocks.Sources.Constant IN22(k=0)
          annotation (Placement(transformation(extent={{-108,-32},{-96,-20}})));
        Modelica.Blocks.Math.Add AddU2
          annotation (Placement(transformation(extent={{-80,-30},{-60,-10}})));
        Modelica.Blocks.Interfaces.RealInput IN2(start=0)
          "Connector of Real input signal 2"
                 annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-150,-12}), iconTransformation(extent={{-10,-10},{10,10}},
                origin={-150,-12})));
        Modelica.Blocks.Interfaces.RealInput IN3(start = 0) "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-44},{-140,-24}}),
              iconTransformation(extent={{-160,-44},{-140,-24}})));

        PFData.PowerFlow powerFlow(redeclare record PowerFlow =
              OpenIPSL.Examples.ModelPredictiveControl.PFData.PF14)
          annotation (Placement(transformation(extent={{-68,104},{-48,124}})));
        Electrical.Machines.PSSE.GENCLS IB(
          V_b=220000,
          v_0=powerFlow.powerflow.bus.V4,
          angle_0=powerFlow.powerflow.bus.A4,
          P_0=powerFlow.powerflow.machines.Pinf,
          Q_0=powerFlow.powerflow.machines.Qinf,
          M_b=100000000,
          X_d=1) if not equivalentGRID annotation (Placement(transformation(extent={{110,70},
                  {100,90}})));
        Electrical.Loads.PSSE.Load_ExtInput Load2(
          P_0=powerFlow.powerflow.loads.PL2,
          Q_0=powerFlow.powerflow.loads.QL2,
          v_0=powerFlow.powerflow.bus.V5,
          angle_0=powerFlow.powerflow.bus.A5,
          d_P=0,
          t1=100,
          d_t=1000)
          annotation (Placement(transformation(extent={{100,-30},{120,-10}})));

        inner Modelica.Blocks.Noise.GlobalSeed globalSeed(useAutomaticSeed=false,
            fixedSeed=10000)
          annotation (Placement(transformation(extent={{-42,102},{-22,122}})));
        Modelica.Blocks.Sources.Sine sine(
          amplitude=0,
          f=1/260,
          phase=3.1415926535898,
          startTime=1000)
          annotation (Placement(transformation(extent={{76,-26},{82,-20}})));
        Modelica.Blocks.Math.Add add
          annotation (Placement(transformation(extent={{86,-18},{94,-10}})));

        Electrical.Buses.Bus          Bus7(v_0=powerFlow.powerflow.bus.V7, angle_0=
              powerFlow.powerflow.bus.A7) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={0,-76})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T3(
          G=0,
          B=0,
          CW=1,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=270,
              origin={60,-20})));
        GenerationUnits.PSSE.Solar_Units.SolarMPCLocalVControl PV(
          V_b=480,
          P_0=powerFlow.powerflow.machines.PPV,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QPV,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V7,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A7,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-44,-86},{-24,-66}})));
        Modelica.Blocks.Math.Add AddU3
          annotation (Placement(transformation(extent={{-80,-60},{-60,-40}})));
        Modelica.Blocks.Sources.Constant IN33(k=0)
          annotation (Placement(transformation(extent={{-108,-62},{-96,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT1
          annotation (Placement(transformation(extent={{140,70},{160,90}})));
       Modelica.Blocks.Interfaces.RealOutput OUT2
          annotation (Placement(transformation(extent={{140,50},{160,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT3
          annotation (Placement(transformation(extent={{140,30},{160,50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT4
          annotation (Placement(transformation(extent={{140,10},{160,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT5
          annotation (Placement(transformation(extent={{140,-10},{160,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT6
          annotation (Placement(transformation(extent={{140,-30},{160,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT7
          annotation (Placement(transformation(extent={{140,-50},{160,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT8
          annotation (Placement(transformation(extent={{140,-70},{160,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT9
          annotation (Placement(transformation(extent={{140,-90},{160,-70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT10
          annotation (Placement(transformation(extent={{140,-110},{160,-90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT11
          annotation (Placement(transformation(extent={{164,70},{184,90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT12
          annotation (Placement(transformation(extent={{164,50},{184,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT13
          annotation (Placement(transformation(extent={{164,30},{184,50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT14
          annotation (Placement(transformation(extent={{164,10},{184,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT15
          annotation (Placement(transformation(extent={{164,-10},{184,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT16
          annotation (Placement(transformation(extent={{164,-30},{184,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT17
          annotation (Placement(transformation(extent={{164,-50},{184,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT18
          annotation (Placement(transformation(extent={{164,-70},{184,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT19
          annotation (Placement(transformation(extent={{164,-90},{184,-70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT20
          annotation (Placement(transformation(extent={{164,-110},{184,-90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT21
          annotation (Placement(transformation(extent={{184,70},{204,90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT22
          annotation (Placement(transformation(extent={{184,50},{204,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT23
          annotation (Placement(transformation(extent={{184,30},{204,50}})));
      equation

        OUT1 = G2.gen.w;
        OUT2 = G2.gen.delta;
        OUT3 = G2.gen.Epq;
        OUT4 = G2.gen.PSIkd;
        OUT5 = G2.gen.PSIppq;
        OUT6 = G2.sEXSMPC.simpleLagLim.state;
        OUT7 = G2.sEXSMPC.leadLag.TF.x[1];
        OUT8 = G2.gASTMPC.simpleLagLim.state;
        OUT9 = G2.gASTMPC.simpleLag.state;
        OUT10 = G2.gASTMPC.simpleLag1.state;
        OUT11 = PV.rEGCA1_1.simpleLag.state;
        OUT12 = PV.rEGCA1_1.integrator.y;
        OUT13 = PV.rEGCA1_1.integrator1.y;
        OUT14 = PV.rEECB1_Local_V_Control.integrator1.y;
        OUT15 = PV.rEECB1_Local_V_Control.simpleLag.state;
        OUT16 = PV.rEECB1_Local_V_Control.integrator3.y;
        OUT17 = PV.rEECB1_Local_V_Control.simpleLag1.state;
        OUT18 = PV.rEGCA1_1.Qgen;
        OUT19 = PV.rEGCA1_1.Pgen;
        OUT20 = G2.gen.PMECH;
        OUT21 = G2.sEXSMPC.EFD;
        OUT22 = Bus5.v;
        OUT23 = Bus5.angle;


        connect(T1.p, Bus2.p)
          annotation (Line(points={{-51.2,80},{-40,80}}, color={0,0,255}));
        connect(Bus1.p, T1.n)
          annotation (Line(points={{-80,80},{-68.8,80}}, color={0,0,255}));
        connect(G1.conn, Bus1.p)
          annotation (Line(points={{-91,80},{-80,80}}, color={0,0,255}));
        connect(L1.n, Bus3.p)
          annotation (Line(points={{-14.6,80},{0,80}}, color={0,0,255}));
        connect(L1.p, Bus2.p)
          annotation (Line(points={{-25.4,80},{-40,80}}, color={0,0,255}));
        connect(L2_2.n, Bus4.p) annotation (Line(points={{35.4,70},{44,70},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.n, Bus4.p) annotation (Line(points={{35.4,90},{44,90},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.p, Bus3.p) annotation (Line(points={{24.6,90},{16,90},{16,80},{0,
                80}}, color={0,0,255}));
        connect(L2_2.p, Bus3.p) annotation (Line(points={{24.6,70},{16,70},{16,80},{0,
                80}}, color={0,0,255}));
        connect(Load1.p, Bus3.p)
          annotation (Line(points={{-10,68},{-10,80},{0,80}}, color={0,0,255}));
        connect(L3.p, Bus4.p)
          annotation (Line(points={{80,65.4},{80,80},{60,80}}, color={0,0,255}));
        connect(breaker.s, Bus5.p)
          annotation (Line(points={{80,22},{80,16}},color={0,0,255}));
        connect(breaker.r, L3.n)
          annotation (Line(points={{80,30},{80,54.6}},color={0,0,255}));
        connect(IN11.y, AddU1.u2) annotation (Line(points={{-95.4,4},{-82,4}},
                            color={0,0,127}));
        connect(IN1, AddU1.u1) annotation (Line(points={{-150,10},{-116,10},{-116,16},
                {-82,16}},
                       color={0,0,127}));
        connect(T2.p, Bus5.p) annotation (Line(points={{51,10},{80,10},{80,16}},
              color={0,0,255}));

        connect(IN22.y,AddU2. u2) annotation (Line(points={{-95.4,-26},{-82,-26}},
                       color={0,0,127}));
        connect(IN2,AddU2. u1) annotation (Line(points={{-150,-12},{-118,-12},{-118,-14},
                {-82,-14}},
                       color={0,0,127}));
        connect(AddU2.y, G2.Efd_ref)
          annotation (Line(points={{-59,-20},{-52,-20},{-52,4},{-42,4}},
                                                                 color={0,0,127}));
        connect(AddU1.y, G2.P_ref1) annotation (Line(points={{-59,10},{-52,10},{-52,16},
                {-42,16}},                          color={0,0,127}));
        connect(IB.p, Bus4.p)
          annotation (Line(points={{100,80},{60,80}}, color={0,0,255}));
        connect(sine.y, add.u2) annotation (Line(points={{82.3,-23},{82.3,-24},{85.2,-24},
                {85.2,-16.4}}, color={0,0,127}));
        connect(add.y, Load2.u) annotation (Line(points={{94.4,-14},{94.4,-14.5},{101.9,
                -14.5}}, color={0,0,127}));
        connect(T3.n, Bus7.p) annotation (Line(points={{60,-31},{60,-76},{0,-76}},
                       color={0,0,255}));
        connect(T3.p, Bus5.p) annotation (Line(points={{60,-9},{60,10},{80,10},{80,16}},
              color={0,0,255}));
        connect(Bus6.p, T2.n)
          annotation (Line(points={{4.996e-16,10},{29,10}},
                                                  color={0,0,255}));
        connect(IN33.y,AddU3. u2)
          annotation (Line(points={{-95.4,-56},{-82,-56}}, color={0,0,127}));
        connect(IN3,AddU3. u1) annotation (Line(points={{-150,-34},{-114,-34},{-114,-44},
                {-82,-44}}, color={0,0,127}));
        connect(G2.conn, Bus6.p) annotation (Line(points={{-19,10},{4.996e-16,10}},
                                           color={0,0,255}));
        connect(PV.VINPUT, AddU3.y) annotation (Line(points={{-46,-76},{-50,-76},
                {-50,-50},{-59,-50}},
                                 color={0,0,127}));
        connect(add.u1, sine.y) annotation (Line(points={{85.2,-11.6},{85.2,-16},
                {82.3,-16},{82.3,-23}}, color={0,0,127}));
        connect(Load2.p, Bus5.p) annotation (Line(points={{110,-10},{110,8},{80,
                8},{80,16}}, color={0,0,255}));
        connect(PV.p1, Bus7.p) annotation (Line(points={{-24,-76},{4.996e-16,
                -76}}, color={0,0,255}));
          annotation (Placement(transformation(extent={{140,-20},{160,0}})),
                      Placement(transformation(extent={{140,-40},{160,-20}})),
                      Placement(transformation(extent={{140,-60},{160,-40}})),
                      Placement(transformation(extent={{140,-80},{160,-60}})),
                     Diagram(coordinateSystem(preserveAspectRatio=false,
                extent={{-140,-140},{140,140}}), graphics={
              Rectangle(
                extent={{130,98},{232,-124}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Rectangle(
                extent={{-160,30},{-136,-60}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,36},{124,-124}},
                lineColor={238,46,47},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,98},{124,38}},
                lineColor={0,128,255},
                lineThickness=0.5),
              Polygon(
                points={{-124,30},{-124,-120},{72,-120},{72,-50},{0,30},{-124,30}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Text(
                extent={{78,-106},{114,-120}},
                textColor={238,46,47},
                textString="Microgrid"),
              Text(
                extent={{76,58},{128,34}},
                textColor={28,108,200},
                textString="Utility Grid"),
              Text(
                extent={{6,-102},{70,-124}},
                textColor={0,140,72},
                textString="Linearization Unit"),
              Text(
                extent={{-164,50},{-132,30}},
                textColor={0,140,72},
                textString="Inputs"),
              Text(
                extent={{128,118},{168,98}},
                textColor={0,140,72},
                textString="Outputs")}),
          Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),experiment(StopTime=20, __Dymola_Algorithm="Dassl"),
          Icon(coordinateSystem(extent={{-140,-140},{140,140}})));
      end MPCMicrogridGasPV_02;

      model MPCMicrogridGasPV_03 "Microgrid with G2 and PV on Q Control"
        extends Modelica.Icons.Example;

        parameter Boolean equivalentGRID = false;
        parameter Boolean equivalentsystem = false;

        OpenIPSL.Electrical.Buses.Bus Bus1(v_0=powerFlow.powerflow.bus.V1, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-90,70},{-70,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus2(v_0=powerFlow.powerflow.bus.V2, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-50,70},{-30,90}})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
          R=0.001,
          X=0.2,
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000)  if not equivalentGRID annotation (Placement(transformation(
              extent={{-8,-8},{8,8}},
              rotation=180,
              origin={-60,80})));
        OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
          enableV_b=true,
          v_0=powerFlow.powerflow.bus.V1,
          angle_0=powerFlow.powerflow.bus.A1,
          P_0=powerFlow.powerflow.machines.PG1,
          Q_0=powerFlow.powerflow.machines.QG1,
          V_b=6000)  if not equivalentGRID
          annotation (Placement(transformation(extent={{-112,70},{-92,90}})));
        OpenIPSL.Electrical.Branches.PwLine L1(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{-26,76},
                  {-14,84}})));
        OpenIPSL.Electrical.Buses.Bus Bus3(v_0=powerFlow.powerflow.bus.V3, angle_0=
              powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-10,70},{10,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus4(v_0=powerFlow.powerflow.bus.V4, angle_0=
              powerFlow.powerflow.bus.V4) if not equivalentGRID
          annotation (Placement(transformation(extent={{50,70},{70,90}})));
        OpenIPSL.Electrical.Branches.PwLine L2_1(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,86},
                  {36,94}})));
        OpenIPSL.Electrical.Branches.PwLine L2_2(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,66},
                  {36,74}})));
        OpenIPSL.Electrical.Buses.Bus Bus5(angle_0=powerFlow.powerflow.bus.A5, v_0=
              powerFlow.powerflow.bus.V5)  annotation (Placement(
              transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={80,16})));
        OpenIPSL.Electrical.Branches.PwLine L3(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=-90,
              origin={80,60})));
        OpenIPSL.Electrical.Buses.Bus Bus6(v_0=powerFlow.powerflow.bus.V6, angle_0=
              powerFlow.powerflow.bus.A6) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={0,10})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000,
          R=0.005,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={40,10})));
        GenerationUnits.PSSE.G2_16MVA                         G2(
          enableV_b=true,
          enableP_0=true,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V6,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A6,
          V_b=6000,
          P_0=powerFlow.powerflow.machines.PG2,
          Q_0=powerFlow.powerflow.machines.QG2,
          enableangle_0=true)
                        annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-30,10})));
        inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000, fn=60)
          annotation (Placement(transformation(extent={{-128,104},{-74,124}})));
        OpenIPSL.Electrical.Loads.PSSE.Load Load1(
          V_b=220000,
          P_0=powerFlow.powerflow.loads.PL1,
          Q_0=powerFlow.powerflow.loads.QL1,
          v_0=powerFlow.powerflow.bus.V3,
          angle_0=powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-20,48},{0,68}})));
        Electrical.Events.Breaker breaker(enableTrigger=false,
          t_o=10.01,
          rc_enabled=true,
          t_rc=80.01)       if not equivalentGRID                     annotation (Placement(transformation(
              extent={{-4,-4},{4,4}},
              rotation=90,
              origin={80,26})));

        Modelica.Blocks.Interfaces.RealInput IN1(start=0)
          "Connector of Real input signal 2" annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-150,10}),iconTransformation(extent={{-10,-10},{10,10}}, origin={-150,10})));
        Modelica.Blocks.Sources.Constant IN11(k=0)
          annotation (Placement(transformation(extent={{-108,-2},{-96,10}})));
        Modelica.Blocks.Math.Add AddU1
          annotation (Placement(transformation(extent={{-80,0},{-60,20}})));
        Modelica.Blocks.Sources.Constant IN22(k=0)
          annotation (Placement(transformation(extent={{-108,-32},{-96,-20}})));
        Modelica.Blocks.Math.Add AddU2
          annotation (Placement(transformation(extent={{-80,-30},{-60,-10}})));
        Modelica.Blocks.Interfaces.RealInput IN2(start=0)
          "Connector of Real input signal 2"
                 annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-150,-12}), iconTransformation(extent={{-10,-10},{10,10}},
                origin={-150,-12})));
        Modelica.Blocks.Interfaces.RealInput IN3(start = 0) "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-44},{-140,-24}}),
              iconTransformation(extent={{-160,-44},{-140,-24}})));

        Modelica.Blocks.Interfaces.RealOutput OUT1
          annotation (Placement(transformation(extent={{140,70},{160,90}})));
       Modelica.Blocks.Interfaces.RealOutput OUT2
          annotation (Placement(transformation(extent={{140,50},{160,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT3
          annotation (Placement(transformation(extent={{140,30},{160,50}})));

        PFData.PowerFlow powerFlow(redeclare record PowerFlow =
              OpenIPSL.Examples.ModelPredictiveControl.PFData.PF14)
          annotation (Placement(transformation(extent={{-68,104},{-48,124}})));
        Electrical.Machines.PSSE.GENCLS IB(
          V_b=220000,
          v_0=powerFlow.powerflow.bus.V4,
          angle_0=powerFlow.powerflow.bus.A4,
          P_0=powerFlow.powerflow.machines.Pinf,
          Q_0=powerFlow.powerflow.machines.Qinf,
          M_b=100000000,
          X_d=1) if not equivalentGRID annotation (Placement(transformation(extent={{110,70},
                  {100,90}})));
        Electrical.Loads.PSSE.Load_ExtInput Load2(
          P_0=powerFlow.powerflow.loads.PL2,
          Q_0=powerFlow.powerflow.loads.QL2,
          v_0=powerFlow.powerflow.bus.V5,
          angle_0=powerFlow.powerflow.bus.A5,
          d_P=0,
          t1=100,
          d_t=1000)
          annotation (Placement(transformation(extent={{100,-30},{120,-10}})));
        Electrical.Loads.NoiseInjections.WhiteNoiseInjection whiteNoiseInjection(
            active_sigma=0.0000000005,
                                  samplePeriod=0.02)
          annotation (Placement(transformation(extent={{76,-14},{82,-8}})));

        inner Modelica.Blocks.Noise.GlobalSeed globalSeed(useAutomaticSeed=false,
            fixedSeed=10000)
          annotation (Placement(transformation(extent={{-42,102},{-22,122}})));
        Modelica.Blocks.Sources.Sine sine(
          amplitude=0,
          f=1/260,
          phase=3.1415926535898,
          startTime=1000)
          annotation (Placement(transformation(extent={{76,-26},{82,-20}})));
        Modelica.Blocks.Math.Add add
          annotation (Placement(transformation(extent={{86,-18},{94,-10}})));

        Electrical.Buses.Bus          Bus7(v_0=powerFlow.powerflow.bus.V7, angle_0=
              powerFlow.powerflow.bus.A7) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={0,-76})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T3(
          G=0,
          B=0,
          CW=1,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=270,
              origin={60,-20})));
        GenerationUnits.PSSE.Solar_Units.SolarMPCLocalVQControl_NOCONTROL
                                                                PV(
          V_b=480,
          P_0=powerFlow.powerflow.machines.PPV,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QPV,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V7,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A7,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-86},{-20,-66}})));
        Modelica.Blocks.Math.Add AddU3
          annotation (Placement(transformation(extent={{-80,-60},{-60,-40}})));
        Modelica.Blocks.Sources.Constant IN33(k=0)
          annotation (Placement(transformation(extent={{-108,-62},{-96,-50}})));

        Modelica.Blocks.Interfaces.RealOutput OUT4
          annotation (Placement(transformation(extent={{140,10},{160,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT5
          annotation (Placement(transformation(extent={{140,-10},{160,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT6
          annotation (Placement(transformation(extent={{140,-30},{160,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT7
          annotation (Placement(transformation(extent={{140,-50},{160,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT8
          annotation (Placement(transformation(extent={{140,-70},{160,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT9
          annotation (Placement(transformation(extent={{140,-90},{160,-70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT10
          annotation (Placement(transformation(extent={{140,-110},{160,-90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT11
          annotation (Placement(transformation(extent={{164,70},{184,90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT12
          annotation (Placement(transformation(extent={{164,50},{184,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT13
          annotation (Placement(transformation(extent={{164,30},{184,50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT14
          annotation (Placement(transformation(extent={{164,10},{184,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT15
          annotation (Placement(transformation(extent={{164,-10},{184,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT16
          annotation (Placement(transformation(extent={{164,-30},{184,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT17
          annotation (Placement(transformation(extent={{164,-50},{184,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT18
          annotation (Placement(transformation(extent={{164,-70},{184,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT19
          annotation (Placement(transformation(extent={{164,-90},{184,-70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT20
          annotation (Placement(transformation(extent={{164,-110},{184,-90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT21
          annotation (Placement(transformation(extent={{184,70},{204,90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT22
          annotation (Placement(transformation(extent={{184,50},{204,70}})));
      //   Modelica.Blocks.Interfaces.RealOutput OUT23
      //     annotation (Placement(transformation(extent={{184,30},{204,50}})));
      equation

        OUT1 = G2.gen.w;
        OUT2 = G2.gen.delta;
        OUT3 = G2.gen.Epq;
        OUT4 = G2.gen.PSIkd;
        OUT5 = G2.gen.PSIppq;
        OUT6 = G2.sEXSMPC.simpleLagLim.state;
        OUT7 = G2.sEXSMPC.leadLag.TF.x[1];
        OUT8 = G2.gASTMPC.simpleLagLim.state;
        OUT9 = G2.gASTMPC.simpleLag.state;
        OUT10 = G2.gASTMPC.simpleLag1.state;
        OUT11 = PV.rEGCA1_1.simpleLag.state;
        OUT12 = PV.rEGCA1_1.integrator.y;
        OUT13 = PV.rEGCA1_1.integrator1.y;
        OUT14 =PV.rEECB1_Local_V_Q_Control_PI.integrator.y;
        OUT15 =PV.rEECB1_Local_V_Q_Control_PI.integrator1.y;
        OUT16 =PV.rEECB1_Local_V_Q_Control_PI.simpleLag.state;
        OUT17 =PV.rEECB1_Local_V_Q_Control_PI.integrator3.y;
        OUT18 =PV.rEECB1_Local_V_Q_Control_PI.simpleLag1.state;
        OUT19 = G2.gen.PMECH;
        OUT20 = G2.sEXSMPC.EFD;
        OUT21 = Bus5.v;
        OUT22 = Bus5.angle;

        connect(T1.p, Bus2.p)
          annotation (Line(points={{-51.2,80},{-40,80}}, color={0,0,255}));
        connect(Bus1.p, T1.n)
          annotation (Line(points={{-80,80},{-68.8,80}}, color={0,0,255}));
        connect(G1.conn, Bus1.p)
          annotation (Line(points={{-91,80},{-80,80}}, color={0,0,255}));
        connect(L1.n, Bus3.p)
          annotation (Line(points={{-14.6,80},{0,80}}, color={0,0,255}));
        connect(L1.p, Bus2.p)
          annotation (Line(points={{-25.4,80},{-40,80}}, color={0,0,255}));
        connect(L2_2.n, Bus4.p) annotation (Line(points={{35.4,70},{44,70},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.n, Bus4.p) annotation (Line(points={{35.4,90},{44,90},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.p, Bus3.p) annotation (Line(points={{24.6,90},{16,90},{16,80},{0,
                80}}, color={0,0,255}));
        connect(L2_2.p, Bus3.p) annotation (Line(points={{24.6,70},{16,70},{16,80},{0,
                80}}, color={0,0,255}));
        connect(Load1.p, Bus3.p)
          annotation (Line(points={{-10,68},{-10,80},{0,80}}, color={0,0,255}));
        connect(L3.p, Bus4.p)
          annotation (Line(points={{80,65.4},{80,80},{60,80}}, color={0,0,255}));
        connect(breaker.s, Bus5.p)
          annotation (Line(points={{80,22},{80,16}},color={0,0,255}));
        connect(breaker.r, L3.n)
          annotation (Line(points={{80,30},{80,54.6}},color={0,0,255}));
        connect(IN11.y, AddU1.u2) annotation (Line(points={{-95.4,4},{-82,4}},
                            color={0,0,127}));
        connect(IN1, AddU1.u1) annotation (Line(points={{-150,10},{-116,10},{-116,16},
                {-82,16}},
                       color={0,0,127}));
        connect(T2.p, Bus5.p) annotation (Line(points={{51,10},{80,10},{80,16}},
              color={0,0,255}));

        connect(IN22.y,AddU2. u2) annotation (Line(points={{-95.4,-26},{-82,-26}},
                       color={0,0,127}));
        connect(IN2,AddU2. u1) annotation (Line(points={{-150,-12},{-118,-12},{-118,-14},
                {-82,-14}},
                       color={0,0,127}));
        connect(AddU2.y, G2.Efd_ref)
          annotation (Line(points={{-59,-20},{-52,-20},{-52,4},{-42,4}},
                                                                 color={0,0,127}));
        connect(AddU1.y, G2.P_ref1) annotation (Line(points={{-59,10},{-52,10},{-52,16},
                {-42,16}},                          color={0,0,127}));
        connect(IB.p, Bus4.p)
          annotation (Line(points={{100,80},{60,80}}, color={0,0,255}));
        connect(Load2.p, Bus5.p) annotation (Line(points={{110,-10},{110,10},{80,10},{
                80,16}},
                     color={0,0,255}));
        connect(sine.y, add.u2) annotation (Line(points={{82.3,-23},{82.3,-24},{85.2,-24},
                {85.2,-16.4}}, color={0,0,127}));
        connect(whiteNoiseInjection.y, add.u1) annotation (Line(points={{82.27,-11.03},
                {82.27,-11.6},{85.2,-11.6}}, color={0,0,127}));
        connect(add.y, Load2.u) annotation (Line(points={{94.4,-14},{94.4,-14.5},{101.9,
                -14.5}}, color={0,0,127}));
        connect(T3.n, Bus7.p) annotation (Line(points={{60,-31},{60,-76},{0,-76}},
                       color={0,0,255}));
        connect(T3.p, Bus5.p) annotation (Line(points={{60,-9},{60,10},{80,10},{80,16}},
              color={0,0,255}));
        connect(Bus6.p, T2.n)
          annotation (Line(points={{4.996e-16,10},{29,10}},
                                                  color={0,0,255}));
        connect(PV.p1, Bus7.p)
          annotation (Line(points={{-20,-76},{4.996e-16,-76}}, color={0,0,255}));
        connect(IN33.y,AddU3. u2)
          annotation (Line(points={{-95.4,-56},{-82,-56}}, color={0,0,127}));
        connect(IN3,AddU3. u1) annotation (Line(points={{-150,-34},{-114,-34},{-114,-44},
                {-82,-44}}, color={0,0,127}));
        connect(G2.conn, Bus6.p) annotation (Line(points={{-19,10},{4.996e-16,10}},
                                           color={0,0,255}));
        connect(AddU3.y, PV.u1) annotation (Line(points={{-59,-50},{-54,-50},{
                -54,-76},{-42,-76}}, color={0,0,127}));
          annotation (Placement(transformation(extent={{140,-20},{160,0}})),
                      Placement(transformation(extent={{140,-40},{160,-20}})),
                      Placement(transformation(extent={{140,-60},{160,-40}})),
                      Placement(transformation(extent={{140,-80},{160,-60}})),
                     Diagram(coordinateSystem(preserveAspectRatio=false,
                extent={{-140,-140},{140,140}}), graphics={
              Rectangle(
                extent={{130,98},{232,-124}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Rectangle(
                extent={{-160,30},{-136,-60}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,36},{124,-124}},
                lineColor={238,46,47},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,98},{124,38}},
                lineColor={0,128,255},
                lineThickness=0.5),
              Polygon(
                points={{-124,30},{-124,-120},{72,-120},{72,-50},{0,30},{-124,30}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Text(
                extent={{78,-106},{114,-120}},
                textColor={238,46,47},
                textString="Microgrid"),
              Text(
                extent={{84,54},{120,36}},
                textColor={28,108,200},
                textString="Utility Grid"),
              Text(
                extent={{6,-102},{70,-124}},
                textColor={0,140,72},
                textString="Linearization Unit"),
              Text(
                extent={{-164,50},{-132,30}},
                textColor={0,140,72},
                textString="Inputs"),
              Text(
                extent={{128,118},{168,98}},
                textColor={0,140,72},
                textString="Outputs")}),
          Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),experiment(StopTime=0.9, __Dymola_Algorithm="Dassl"),
          Icon(coordinateSystem(extent={{-140,-140},{140,140}})));
      end MPCMicrogridGasPV_03;

      model MPCMicrogridGasBESS_02
        "Microgrid with G2 and PV on Local V Control"
        extends Modelica.Icons.Example;

        parameter Boolean equivalentGRID = false;
        parameter Boolean equivalentsystem = false;

        OpenIPSL.Electrical.Buses.Bus Bus1(v_0=powerFlow.powerflow.bus.V1, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-90,70},{-70,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus2(v_0=powerFlow.powerflow.bus.V2, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-50,70},{-30,90}})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
          R=0.001,
          X=0.2,
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000)  if not equivalentGRID annotation (Placement(transformation(
              extent={{-8,-8},{8,8}},
              rotation=180,
              origin={-60,80})));
        OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
          enableV_b=true,
          v_0=powerFlow.powerflow.bus.V1,
          angle_0=powerFlow.powerflow.bus.A1,
          P_0=powerFlow.powerflow.machines.PG1,
          Q_0=powerFlow.powerflow.machines.QG1,
          V_b=6000)  if not equivalentGRID
          annotation (Placement(transformation(extent={{-112,70},{-92,90}})));
        OpenIPSL.Electrical.Branches.PwLine L1(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{-26,76},
                  {-14,84}})));
        OpenIPSL.Electrical.Buses.Bus Bus3(v_0=powerFlow.powerflow.bus.V3, angle_0=
              powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-10,70},{10,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus4(v_0=powerFlow.powerflow.bus.V4, angle_0=
              powerFlow.powerflow.bus.V4) if not equivalentGRID
          annotation (Placement(transformation(extent={{50,70},{70,90}})));
        OpenIPSL.Electrical.Branches.PwLine L2_1(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,86},
                  {36,94}})));
        OpenIPSL.Electrical.Branches.PwLine L2_2(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,66},
                  {36,74}})));
        OpenIPSL.Electrical.Buses.Bus Bus5(angle_0=powerFlow.powerflow.bus.A5, v_0=
              powerFlow.powerflow.bus.V5)  annotation (Placement(
              transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={80,16})));
        OpenIPSL.Electrical.Branches.PwLine L3(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=-90,
              origin={80,60})));
        OpenIPSL.Electrical.Buses.Bus Bus6(v_0=powerFlow.powerflow.bus.V6, angle_0=
              powerFlow.powerflow.bus.A6) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={0,10})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000,
          R=0.005,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={40,10})));
        GenerationUnits.PSSE.G2_16MVA                         G2(
          enableV_b=true,
          enableP_0=true,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V6,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A6,
          V_b=6000,
          P_0=powerFlow.powerflow.machines.PG2,
          Q_0=powerFlow.powerflow.machines.QG2,
          enableangle_0=true)
                        annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-30,10})));
        inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000, fn=60)
          annotation (Placement(transformation(extent={{-128,104},{-74,124}})));
        OpenIPSL.Electrical.Loads.PSSE.Load Load1(
          V_b=220000,
          P_0=powerFlow.powerflow.loads.PL1,
          Q_0=powerFlow.powerflow.loads.QL1,
          v_0=powerFlow.powerflow.bus.V3,
          angle_0=powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-20,48},{0,68}})));
        Electrical.Events.Breaker breaker(enableTrigger=false,
          t_o=1.01,
          rc_enabled=true,
          t_rc=800.01)      if not equivalentGRID                     annotation (Placement(transformation(
              extent={{-4,-4},{4,4}},
              rotation=90,
              origin={80,26})));

        Modelica.Blocks.Interfaces.RealInput IN1(start=0)
          "Connector of Real input signal 2" annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-150,14}),iconTransformation(extent={{-10,-10},{10,10}}, origin={-150,14})));
        Modelica.Blocks.Sources.Constant IN11(k=0)
          annotation (Placement(transformation(extent={{-108,-2},{-96,10}})));
        Modelica.Blocks.Math.Add AddU1
          annotation (Placement(transformation(extent={{-80,0},{-60,20}})));
        Modelica.Blocks.Sources.Constant IN22(k=0)
          annotation (Placement(transformation(extent={{-108,-32},{-96,-20}})));
        Modelica.Blocks.Math.Add AddU2
          annotation (Placement(transformation(extent={{-80,-30},{-60,-10}})));
        Modelica.Blocks.Interfaces.RealInput IN2(start=0)
          "Connector of Real input signal 2"
                 annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-150,-8}),  iconTransformation(extent={{-10,-10},{10,10}},
                origin={-150,-8})));
        Modelica.Blocks.Interfaces.RealInput IN3(start = 0) "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-40},{-140,-20}}),
              iconTransformation(extent={{-160,-40},{-140,-20}})));

        Modelica.Blocks.Interfaces.RealOutput OUT1
          annotation (Placement(transformation(extent={{140,70},{160,90}})));
       Modelica.Blocks.Interfaces.RealOutput OUT2
          annotation (Placement(transformation(extent={{140,50},{160,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT3
          annotation (Placement(transformation(extent={{140,30},{160,50}})));

        PFData.PowerFlow powerFlow(redeclare record PowerFlow =
              OpenIPSL.Examples.ModelPredictiveControl.PFData.PF15)
          annotation (Placement(transformation(extent={{-68,104},{-48,124}})));
        Electrical.Machines.PSSE.GENCLS IB(
          V_b=220000,
          v_0=powerFlow.powerflow.bus.V4,
          angle_0=powerFlow.powerflow.bus.A4,
          P_0=powerFlow.powerflow.machines.Pinf,
          Q_0=powerFlow.powerflow.machines.Qinf,
          M_b=100000000,
          X_d=1) if not equivalentGRID annotation (Placement(transformation(extent={{110,70},
                  {100,90}})));
        Electrical.Loads.PSSE.Load_ExtInput Load2(
          P_0=powerFlow.powerflow.loads.PL2,
          Q_0=powerFlow.powerflow.loads.QL2,
          v_0=powerFlow.powerflow.bus.V5,
          angle_0=powerFlow.powerflow.bus.A5,
          d_P=0,
          t1=0,
          d_t=0)
          annotation (Placement(transformation(extent={{100,-30},{120,-10}})));
        Electrical.Loads.NoiseInjections.WhiteNoiseInjection whiteNoiseInjection(
            active_sigma=0.0000000005,
                                  samplePeriod=0.02)
          annotation (Placement(transformation(extent={{76,-14},{82,-8}})));

        inner Modelica.Blocks.Noise.GlobalSeed globalSeed(useAutomaticSeed=false,
            fixedSeed=10000)
          annotation (Placement(transformation(extent={{-42,102},{-22,122}})));
        Modelica.Blocks.Sources.Sine sine(
          amplitude=0,
          f=1/260,
          phase=3.1415926535898,
          startTime=1000)
          annotation (Placement(transformation(extent={{76,-26},{82,-20}})));
        Modelica.Blocks.Math.Add add
          annotation (Placement(transformation(extent={{86,-18},{94,-10}})));

        Electrical.Buses.Bus          Bus7(v_0=powerFlow.powerflow.bus.V7, angle_0=
              powerFlow.powerflow.bus.A7) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={0,-76})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T3(
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.05) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=270,
              origin={60,-20})));
        Modelica.Blocks.Math.Add AddU3
          annotation (Placement(transformation(extent={{-80,-60},{-60,-40}})));
        Modelica.Blocks.Sources.Constant IN33(k=0)
          annotation (Placement(transformation(extent={{-108,-62},{-96,-50}})));

        Modelica.Blocks.Interfaces.RealOutput OUT4
          annotation (Placement(transformation(extent={{140,10},{160,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT5
          annotation (Placement(transformation(extent={{140,-10},{160,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT6
          annotation (Placement(transformation(extent={{140,-30},{160,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT7
          annotation (Placement(transformation(extent={{140,-50},{160,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT8
          annotation (Placement(transformation(extent={{140,-70},{160,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT9
          annotation (Placement(transformation(extent={{140,-90},{160,-70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT10
          annotation (Placement(transformation(extent={{140,-110},{160,-90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT11
          annotation (Placement(transformation(extent={{164,70},{184,90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT12
          annotation (Placement(transformation(extent={{164,50},{184,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT13
          annotation (Placement(transformation(extent={{164,30},{184,50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT14
          annotation (Placement(transformation(extent={{164,10},{184,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT15
          annotation (Placement(transformation(extent={{164,-10},{184,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT16
          annotation (Placement(transformation(extent={{164,-30},{184,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT17
          annotation (Placement(transformation(extent={{164,-50},{184,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT18
          annotation (Placement(transformation(extent={{164,-70},{184,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT19
          annotation (Placement(transformation(extent={{164,-90},{184,-70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT20
          annotation (Placement(transformation(extent={{164,-110},{184,-90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT21
          annotation (Placement(transformation(extent={{184,70},{204,90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT22
          annotation (Placement(transformation(extent={{184,50},{204,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT23
          annotation (Placement(transformation(extent={{184,30},{204,50}})));
        GenerationUnits.PSSE.Battery_Units.BESSMPCLocalVControl BESS(
          V_base=480,
          V_b(displayUnit="kV") = 480,
          enableV_b=true,
          P_0=powerFlow.powerflow.machines.PBESS,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QBESS,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V7,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A7,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-86},{-20,-66}})));
        Modelica.Blocks.Sources.Constant IN44(k=0)
          annotation (Placement(transformation(extent={{-108,-102},{-96,-90}})));
        Modelica.Blocks.Math.Add AddU4
          annotation (Placement(transformation(extent={{-80,-100},{-60,-80}})));
        Modelica.Blocks.Interfaces.RealInput IN4 "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-60},{-140,-40}}),
              iconTransformation(extent={{-160,-60},{-140,-40}})));
        Modelica.Blocks.Interfaces.RealOutput OUT24
          annotation (Placement(transformation(extent={{184,12},{204,32}})));
        Modelica.Blocks.Interfaces.RealOutput OUT25
          annotation (Placement(transformation(extent={{184,-10},{204,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT26
          annotation (Placement(transformation(extent={{184,-30},{204,-10}})));
      equation

        OUT1 = G2.gen.w;
        OUT2 = G2.gen.delta;
        OUT3 = G2.gen.Epq;
        OUT4 = G2.gen.PSIkd;
        OUT5 = G2.gen.PSIppq;
        OUT6 = G2.sEXSMPC.simpleLagLim.state;
        OUT7 = G2.sEXSMPC.leadLag.TF.x[1];
        OUT8 = G2.gASTMPC.simpleLagLim.state;
        OUT9 = G2.gASTMPC.simpleLag.state;
        OUT10 = G2.gASTMPC.simpleLag1.state;
        OUT11 = BESS.rEGCA1_1.simpleLag.state;
        OUT12 = BESS.rEGCA1_1.integrator.y;
        OUT13 = BESS.rEGCA1_1.integrator1.y;
        OUT14 = BESS.rEECCU1_Local_V_Control.integrator3.y;
        OUT15 = BESS.rEECCU1_Local_V_Control.integrator1.y;
        OUT16 = BESS.rEECCU1_Local_V_Control.simpleLag.state;
        OUT17 =BESS.rEECCU1_Local_V_Control.IGQ.y;
        OUT18 = BESS.rEECCU1_Local_V_Control.simpleLag2.state;
        OUT19 =BESS.rEECCU1_Local_V_Control.IGP.y;
        OUT20 = BESS.rEECCU1_Local_V_Control.simpleLag1.state;
        OUT21 = BESS.rEGCA1_1.Qgen;
        OUT22 = BESS.rEGCA1_1.Pgen;
        OUT23 = G2.gen.PMECH;
        OUT24 = G2.sEXSMPC.EFD;
        OUT25 = Bus5.v;
        OUT26 = Bus5.angle;

        connect(T1.p, Bus2.p)
          annotation (Line(points={{-51.2,80},{-40,80}}, color={0,0,255}));
        connect(Bus1.p, T1.n)
          annotation (Line(points={{-80,80},{-68.8,80}}, color={0,0,255}));
        connect(G1.conn, Bus1.p)
          annotation (Line(points={{-91,80},{-80,80}}, color={0,0,255}));
        connect(L1.n, Bus3.p)
          annotation (Line(points={{-14.6,80},{0,80}}, color={0,0,255}));
        connect(L1.p, Bus2.p)
          annotation (Line(points={{-25.4,80},{-40,80}}, color={0,0,255}));
        connect(L2_2.n, Bus4.p) annotation (Line(points={{35.4,70},{44,70},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.n, Bus4.p) annotation (Line(points={{35.4,90},{44,90},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.p, Bus3.p) annotation (Line(points={{24.6,90},{16,90},{16,80},{0,
                80}}, color={0,0,255}));
        connect(L2_2.p, Bus3.p) annotation (Line(points={{24.6,70},{16,70},{16,80},{0,
                80}}, color={0,0,255}));
        connect(Load1.p, Bus3.p)
          annotation (Line(points={{-10,68},{-10,80},{0,80}}, color={0,0,255}));
        connect(L3.p, Bus4.p)
          annotation (Line(points={{80,65.4},{80,80},{60,80}}, color={0,0,255}));
        connect(breaker.s, Bus5.p)
          annotation (Line(points={{80,22},{80,16}},color={0,0,255}));
        connect(breaker.r, L3.n)
          annotation (Line(points={{80,30},{80,54.6}},color={0,0,255}));
        connect(IN11.y, AddU1.u2) annotation (Line(points={{-95.4,4},{-82,4}},
                            color={0,0,127}));
        connect(IN1, AddU1.u1) annotation (Line(points={{-150,14},{-116,14},{-116,16},
                {-82,16}},
                       color={0,0,127}));
        connect(T2.p, Bus5.p) annotation (Line(points={{51,10},{80,10},{80,16}},
              color={0,0,255}));

        connect(IN22.y,AddU2. u2) annotation (Line(points={{-95.4,-26},{-82,-26}},
                       color={0,0,127}));
        connect(IN2,AddU2. u1) annotation (Line(points={{-150,-8},{-118,-8},{-118,-14},
                {-82,-14}},
                       color={0,0,127}));
        connect(AddU2.y, G2.Efd_ref)
          annotation (Line(points={{-59,-20},{-52,-20},{-52,4},{-42,4}},
                                                                 color={0,0,127}));
        connect(AddU1.y, G2.P_ref1) annotation (Line(points={{-59,10},{-52,10},{-52,16},
                {-42,16}},                          color={0,0,127}));
        connect(IB.p, Bus4.p)
          annotation (Line(points={{100,80},{60,80}}, color={0,0,255}));
        connect(Load2.p, Bus5.p) annotation (Line(points={{110,-10},{110,10},{80,10},{
                80,16}},
                     color={0,0,255}));
        connect(sine.y, add.u2) annotation (Line(points={{82.3,-23},{82.3,-24},{85.2,-24},
                {85.2,-16.4}}, color={0,0,127}));
        connect(whiteNoiseInjection.y, add.u1) annotation (Line(points={{82.27,-11.03},
                {82.27,-11.6},{85.2,-11.6}}, color={0,0,127}));
        connect(add.y, Load2.u) annotation (Line(points={{94.4,-14},{94.4,-14.5},{101.9,
                -14.5}}, color={0,0,127}));
        connect(T3.n, Bus7.p) annotation (Line(points={{60,-31},{60,-76},{0,-76}},
                       color={0,0,255}));
        connect(T3.p, Bus5.p) annotation (Line(points={{60,-9},{60,10},{80,10},{80,16}},
              color={0,0,255}));
        connect(Bus6.p, T2.n)
          annotation (Line(points={{4.996e-16,10},{29,10}},
                                                  color={0,0,255}));
        connect(IN33.y,AddU3. u2)
          annotation (Line(points={{-95.4,-56},{-82,-56}}, color={0,0,127}));
        connect(IN3,AddU3. u1) annotation (Line(points={{-150,-30},{-114,-30},{-114,-44},
                {-82,-44}}, color={0,0,127}));
        connect(G2.conn, Bus6.p) annotation (Line(points={{-19,10},{4.996e-16,10}},
                                           color={0,0,255}));
        connect(BESS.p1, Bus7.p)
          annotation (Line(points={{-20,-76},{4.996e-16,-76}}, color={0,0,255}));
        connect(AddU3.y, BESS.Pinput) annotation (Line(points={{-59,-50},{-50,-50},{-50,
                -70},{-42,-70}}, color={0,0,127}));
        connect(IN44.y, AddU4.u2)
          annotation (Line(points={{-95.4,-96},{-82,-96}}, color={0,0,127}));
        connect(AddU4.u1, IN4) annotation (Line(points={{-82,-84},{-120,-84},{-120,-50},
                {-150,-50}}, color={0,0,127}));
        connect(AddU4.y, BESS.Vinput) annotation (Line(points={{-59,-90},{-52,-90},{-52,
                -82},{-42,-82}}, color={0,0,127}));
          annotation (Placement(transformation(extent={{140,-20},{160,0}})),
                      Placement(transformation(extent={{140,-40},{160,-20}})),
                      Placement(transformation(extent={{140,-60},{160,-40}})),
                      Placement(transformation(extent={{140,-80},{160,-60}})),
                     Diagram(coordinateSystem(preserveAspectRatio=false,
                extent={{-140,-140},{140,140}}), graphics={
              Rectangle(
                extent={{130,98},{232,-124}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Rectangle(
                extent={{-160,30},{-136,-60}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,36},{124,-124}},
                lineColor={238,46,47},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,98},{124,38}},
                lineColor={0,128,255},
                lineThickness=0.5),
              Polygon(
                points={{-124,30},{-124,-120},{72,-120},{72,-50},{0,30},{-124,30}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Text(
                extent={{78,-106},{114,-120}},
                textColor={238,46,47},
                textString="Microgrid"),
              Text(
                extent={{76,58},{128,34}},
                textColor={28,108,200},
                textString="Utility Grid"),
              Text(
                extent={{6,-102},{70,-124}},
                textColor={0,140,72},
                textString="Linearization Unit"),
              Text(
                extent={{-164,50},{-132,30}},
                textColor={0,140,72},
                textString="Inputs"),
              Text(
                extent={{128,118},{168,98}},
                textColor={0,140,72},
                textString="Outputs")}),
          Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),experiment(StopTime=50, __Dymola_Algorithm="Dassl"),
          Icon(coordinateSystem(extent={{-140,-140},{140,140}})));
      end MPCMicrogridGasBESS_02;

      model MPCMicrogridGasBESS_01
        "Microgrid with G2 and PV on Local V Control"
        extends Modelica.Icons.Example;

        parameter Boolean equivalentGRID = true;
        parameter Boolean equivalentsystem = false;

        OpenIPSL.Electrical.Buses.Bus Bus1(v_0=powerFlow.powerflow.bus.V1, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-90,70},{-70,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus2(v_0=powerFlow.powerflow.bus.V2, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-50,70},{-30,90}})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
          R=0.001,
          X=0.2,
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000)  if not equivalentGRID annotation (Placement(transformation(
              extent={{-8,-8},{8,8}},
              rotation=180,
              origin={-60,80})));
        OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
          enableV_b=true,
          v_0=powerFlow.powerflow.bus.V1,
          angle_0=powerFlow.powerflow.bus.A1,
          P_0=powerFlow.powerflow.machines.PG1,
          Q_0=powerFlow.powerflow.machines.QG1,
          V_b=6000)  if not equivalentGRID
          annotation (Placement(transformation(extent={{-112,70},{-92,90}})));
        OpenIPSL.Electrical.Branches.PwLine L1(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{-26,76},
                  {-14,84}})));
        OpenIPSL.Electrical.Buses.Bus Bus3(v_0=powerFlow.powerflow.bus.V3, angle_0=
              powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-10,70},{10,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus4(v_0=powerFlow.powerflow.bus.V4, angle_0=
              powerFlow.powerflow.bus.V4) if not equivalentGRID
          annotation (Placement(transformation(extent={{50,70},{70,90}})));
        OpenIPSL.Electrical.Branches.PwLine L2_1(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,86},
                  {36,94}})));
        OpenIPSL.Electrical.Branches.PwLine L2_2(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,66},
                  {36,74}})));
        OpenIPSL.Electrical.Buses.Bus Bus5(angle_0=powerFlow.powerflow.bus.A5, v_0=
              powerFlow.powerflow.bus.V5)  annotation (Placement(
              transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={80,16})));
        OpenIPSL.Electrical.Branches.PwLine L3(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=-90,
              origin={80,60})));
        OpenIPSL.Electrical.Buses.Bus Bus6(v_0=powerFlow.powerflow.bus.V6, angle_0=
              powerFlow.powerflow.bus.A6) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={0,10})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000,
          R=0.005,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={40,10})));
        GenerationUnits.PSSE.G2_16MVA                         G2(
          enableV_b=true,
          enableP_0=true,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V6,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A6,
          V_b=6000,
          P_0=powerFlow.powerflow.machines.PG2,
          Q_0=powerFlow.powerflow.machines.QG2,
          enableangle_0=true)
                        annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-30,10})));
        inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000, fn=60)
          annotation (Placement(transformation(extent={{-128,104},{-74,124}})));
        OpenIPSL.Electrical.Loads.PSSE.Load Load1(
          V_b=220000,
          P_0=powerFlow.powerflow.loads.PL1,
          Q_0=powerFlow.powerflow.loads.QL1,
          v_0=powerFlow.powerflow.bus.V3,
          angle_0=powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-20,48},{0,68}})));
        Electrical.Events.Breaker breaker(enableTrigger=false,
          t_o=1.01,
          rc_enabled=true,
          t_rc=800.01)      if not equivalentGRID                     annotation (Placement(transformation(
              extent={{-4,-4},{4,4}},
              rotation=90,
              origin={80,26})));

        Modelica.Blocks.Interfaces.RealInput IN1(start=0)
          "Connector of Real input signal 2" annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-150,14}),iconTransformation(extent={{-10,-10},{10,10}}, origin={-150,14})));
        Modelica.Blocks.Sources.Constant IN11(k=0)
          annotation (Placement(transformation(extent={{-108,-2},{-96,10}})));
        Modelica.Blocks.Math.Add AddU1
          annotation (Placement(transformation(extent={{-80,0},{-60,20}})));
        Modelica.Blocks.Sources.Constant IN22(k=0)
          annotation (Placement(transformation(extent={{-108,-32},{-96,-20}})));
        Modelica.Blocks.Math.Add AddU2
          annotation (Placement(transformation(extent={{-80,-30},{-60,-10}})));
        Modelica.Blocks.Interfaces.RealInput IN2(start=0)
          "Connector of Real input signal 2"
                 annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-150,-8}),  iconTransformation(extent={{-10,-10},{10,10}},
                origin={-150,-8})));
        Modelica.Blocks.Interfaces.RealInput IN3(start = 0) "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-40},{-140,-20}}),
              iconTransformation(extent={{-160,-40},{-140,-20}})));

        Modelica.Blocks.Interfaces.RealOutput OUT1
          annotation (Placement(transformation(extent={{140,70},{160,90}})));
       Modelica.Blocks.Interfaces.RealOutput OUT2
          annotation (Placement(transformation(extent={{140,50},{160,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT3
          annotation (Placement(transformation(extent={{140,30},{160,50}})));

        PFData.PowerFlow powerFlow(redeclare record PowerFlow =
              OpenIPSL.Examples.ModelPredictiveControl.PFData.PF15)
          annotation (Placement(transformation(extent={{-68,104},{-48,124}})));
        Electrical.Machines.PSSE.GENCLS IB(
          V_b=220000,
          v_0=powerFlow.powerflow.bus.V4,
          angle_0=powerFlow.powerflow.bus.A4,
          P_0=powerFlow.powerflow.machines.Pinf,
          Q_0=powerFlow.powerflow.machines.Qinf,
          M_b=100000000,
          X_d=1) if not equivalentGRID annotation (Placement(transformation(extent={{110,70},
                  {100,90}})));
        Electrical.Loads.PSSE.Load_ExtInput Load2(
          P_0=powerFlow.powerflow.loads.PL2,
          Q_0=powerFlow.powerflow.loads.QL2,
          v_0=powerFlow.powerflow.bus.V5,
          angle_0=powerFlow.powerflow.bus.A5,
          d_P=0,
          t1=0,
          d_t=0)
          annotation (Placement(transformation(extent={{100,-30},{120,-10}})));
        Electrical.Loads.NoiseInjections.WhiteNoiseInjection whiteNoiseInjection(
            active_sigma=0.0000000005,
                                  samplePeriod=0.02)
          annotation (Placement(transformation(extent={{76,-14},{82,-8}})));

        inner Modelica.Blocks.Noise.GlobalSeed globalSeed(useAutomaticSeed=false,
            fixedSeed=10000)
          annotation (Placement(transformation(extent={{-42,102},{-22,122}})));
        Modelica.Blocks.Sources.Sine sine(
          amplitude=0,
          f=1/260,
          phase=3.1415926535898,
          startTime=1000)
          annotation (Placement(transformation(extent={{76,-26},{82,-20}})));
        Modelica.Blocks.Math.Add add
          annotation (Placement(transformation(extent={{86,-18},{94,-10}})));

        Electrical.Buses.Bus          Bus7(v_0=powerFlow.powerflow.bus.V7, angle_0=
              powerFlow.powerflow.bus.A7) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={0,-76})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T3(
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.05) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=270,
              origin={60,-20})));
        Modelica.Blocks.Math.Add AddU3
          annotation (Placement(transformation(extent={{-80,-60},{-60,-40}})));
        Modelica.Blocks.Sources.Constant IN33(k=0)
          annotation (Placement(transformation(extent={{-108,-62},{-96,-50}})));

        Modelica.Blocks.Interfaces.RealOutput OUT4
          annotation (Placement(transformation(extent={{140,10},{160,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT5
          annotation (Placement(transformation(extent={{140,-10},{160,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT6
          annotation (Placement(transformation(extent={{140,-30},{160,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT7
          annotation (Placement(transformation(extent={{140,-50},{160,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT8
          annotation (Placement(transformation(extent={{140,-70},{160,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT9
          annotation (Placement(transformation(extent={{140,-90},{160,-70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT10
          annotation (Placement(transformation(extent={{140,-110},{160,-90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT11
          annotation (Placement(transformation(extent={{164,70},{184,90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT12
          annotation (Placement(transformation(extent={{164,50},{184,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT13
          annotation (Placement(transformation(extent={{164,30},{184,50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT14
          annotation (Placement(transformation(extent={{164,10},{184,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT15
          annotation (Placement(transformation(extent={{164,-10},{184,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT16
          annotation (Placement(transformation(extent={{164,-30},{184,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT17
          annotation (Placement(transformation(extent={{164,-50},{184,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT18
          annotation (Placement(transformation(extent={{164,-70},{184,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT19
          annotation (Placement(transformation(extent={{164,-90},{184,-70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT20
          annotation (Placement(transformation(extent={{164,-110},{184,-90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT21
          annotation (Placement(transformation(extent={{184,70},{204,90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT22
          annotation (Placement(transformation(extent={{184,50},{204,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT23
          annotation (Placement(transformation(extent={{184,30},{204,50}})));
            Modelica.Blocks.Interfaces.RealOutput OUT24
          annotation (Placement(transformation(extent={{184,12},{204,32}})));
        GenerationUnits.PSSE.Battery_Units.BESSMPCLocalQControl BESS(
          V_base=480,
          V_b(displayUnit="kV") = 480,
          enableV_b=true,
          P_0=powerFlow.powerflow.machines.PBESS,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QBESS,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V7,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A7,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-86},{-20,-66}})));
        Modelica.Blocks.Sources.Constant IN44(k=0)
          annotation (Placement(transformation(extent={{-108,-102},{-96,-90}})));
        Modelica.Blocks.Math.Add AddU4
          annotation (Placement(transformation(extent={{-80,-100},{-60,-80}})));
        Modelica.Blocks.Interfaces.RealInput IN4 "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-60},{-140,-40}}),
              iconTransformation(extent={{-160,-60},{-140,-40}})));

      equation

        OUT1 = G2.gen.w;
        OUT2 = G2.gen.delta;
        OUT3 = G2.gen.Epq;
        OUT4 = G2.gen.PSIkd;
        OUT5 = G2.gen.PSIppq;
        OUT6 = G2.sEXSMPC.simpleLagLim.state;
        OUT7 = G2.sEXSMPC.leadLag.TF.x[1];
        OUT8 = G2.gASTMPC.simpleLagLim.state;
        OUT9 = G2.gASTMPC.simpleLag.state;
        OUT10 = G2.gASTMPC.simpleLag1.state;
        OUT11 = BESS.rEGCA1_1.simpleLag.state;
        OUT12 = BESS.rEGCA1_1.integrator.y;
        OUT13 = BESS.rEGCA1_1.integrator1.y;
        OUT14 = BESS.rEECCU1_Constant_Q_Control.integrator3.y;
        OUT15 = BESS.rEECCU1_Constant_Q_Control.integrator1.y;
        OUT16 = BESS.rEECCU1_Constant_Q_Control.simpleLag.state;
        OUT17 = BESS.rEECCU1_Constant_Q_Control.simpleLag1.state;
        OUT18 = BESS.rEECCU1_Constant_Q_Control.simpleLag2.state;
        OUT19 = BESS.rEGCA1_1.Qgen;
        OUT20 = BESS.rEGCA1_1.Pgen;
        OUT21 = G2.gen.PMECH;
        OUT22 = G2.sEXSMPC.EFD;
        OUT23 = Bus5.v;
        OUT24 = Bus5.angle;

        connect(T1.p, Bus2.p)
          annotation (Line(points={{-51.2,80},{-40,80}}, color={0,0,255}));
        connect(Bus1.p, T1.n)
          annotation (Line(points={{-80,80},{-68.8,80}}, color={0,0,255}));
        connect(G1.conn, Bus1.p)
          annotation (Line(points={{-91,80},{-80,80}}, color={0,0,255}));
        connect(L1.n, Bus3.p)
          annotation (Line(points={{-14.6,80},{0,80}}, color={0,0,255}));
        connect(L1.p, Bus2.p)
          annotation (Line(points={{-25.4,80},{-40,80}}, color={0,0,255}));
        connect(L2_2.n, Bus4.p) annotation (Line(points={{35.4,70},{44,70},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.n, Bus4.p) annotation (Line(points={{35.4,90},{44,90},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.p, Bus3.p) annotation (Line(points={{24.6,90},{16,90},{16,80},{0,
                80}}, color={0,0,255}));
        connect(L2_2.p, Bus3.p) annotation (Line(points={{24.6,70},{16,70},{16,80},{0,
                80}}, color={0,0,255}));
        connect(Load1.p, Bus3.p)
          annotation (Line(points={{-10,68},{-10,80},{0,80}}, color={0,0,255}));
        connect(L3.p, Bus4.p)
          annotation (Line(points={{80,65.4},{80,80},{60,80}}, color={0,0,255}));
        connect(breaker.s, Bus5.p)
          annotation (Line(points={{80,22},{80,16}},color={0,0,255}));
        connect(breaker.r, L3.n)
          annotation (Line(points={{80,30},{80,54.6}},color={0,0,255}));
        connect(IN11.y, AddU1.u2) annotation (Line(points={{-95.4,4},{-82,4}},
                            color={0,0,127}));
        connect(IN1, AddU1.u1) annotation (Line(points={{-150,14},{-116,14},{-116,16},
                {-82,16}},
                       color={0,0,127}));
        connect(T2.p, Bus5.p) annotation (Line(points={{51,10},{80,10},{80,16}},
              color={0,0,255}));

        connect(IN22.y,AddU2. u2) annotation (Line(points={{-95.4,-26},{-82,-26}},
                       color={0,0,127}));
        connect(IN2,AddU2. u1) annotation (Line(points={{-150,-8},{-118,-8},{-118,-14},
                {-82,-14}},
                       color={0,0,127}));
        connect(AddU2.y, G2.Efd_ref)
          annotation (Line(points={{-59,-20},{-52,-20},{-52,4},{-42,4}},
                                                                 color={0,0,127}));
        connect(AddU1.y, G2.P_ref1) annotation (Line(points={{-59,10},{-52,10},{-52,16},
                {-42,16}},                          color={0,0,127}));
        connect(IB.p, Bus4.p)
          annotation (Line(points={{100,80},{60,80}}, color={0,0,255}));
        connect(Load2.p, Bus5.p) annotation (Line(points={{110,-10},{110,10},{80,10},{
                80,16}},
                     color={0,0,255}));
        connect(sine.y, add.u2) annotation (Line(points={{82.3,-23},{82.3,-24},{85.2,-24},
                {85.2,-16.4}}, color={0,0,127}));
        connect(whiteNoiseInjection.y, add.u1) annotation (Line(points={{82.27,-11.03},
                {82.27,-11.6},{85.2,-11.6}}, color={0,0,127}));
        connect(add.y, Load2.u) annotation (Line(points={{94.4,-14},{94.4,-14.5},{101.9,
                -14.5}}, color={0,0,127}));
        connect(T3.n, Bus7.p) annotation (Line(points={{60,-31},{60,-76},{0,-76}},
                       color={0,0,255}));
        connect(T3.p, Bus5.p) annotation (Line(points={{60,-9},{60,10},{80,10},{80,16}},
              color={0,0,255}));
        connect(Bus6.p, T2.n)
          annotation (Line(points={{4.996e-16,10},{29,10}},
                                                  color={0,0,255}));
        connect(IN33.y,AddU3. u2)
          annotation (Line(points={{-95.4,-56},{-82,-56}}, color={0,0,127}));
        connect(IN3,AddU3. u1) annotation (Line(points={{-150,-30},{-114,-30},{-114,-44},
                {-82,-44}}, color={0,0,127}));
        connect(G2.conn, Bus6.p) annotation (Line(points={{-19,10},{4.996e-16,10}},
                                           color={0,0,255}));
        connect(BESS.p1, Bus7.p)
          annotation (Line(points={{-20,-76},{4.996e-16,-76}}, color={0,0,255}));
        connect(IN44.y, AddU4.u2)
          annotation (Line(points={{-95.4,-96},{-82,-96}}, color={0,0,127}));
        connect(AddU4.u1, IN4) annotation (Line(points={{-82,-84},{-120,-84},{-120,-50},
                {-150,-50}}, color={0,0,127}));
        connect(AddU3.y, BESS.Paux1) annotation (Line(points={{-59,-50},{-54,-50},{-54,
                -70},{-42,-70}}, color={0,0,127}));
        connect(AddU4.y, BESS.Qext1) annotation (Line(points={{-59,-90},{-54,-90},{-54,
                -82},{-42,-82}}, color={0,0,127}));
          annotation (Placement(transformation(extent={{140,-20},{160,0}})),
                      Placement(transformation(extent={{140,-40},{160,-20}})),
                      Placement(transformation(extent={{140,-60},{160,-40}})),
                      Placement(transformation(extent={{140,-80},{160,-60}})),
                     Diagram(coordinateSystem(preserveAspectRatio=false,
                extent={{-140,-140},{140,140}}), graphics={
              Rectangle(
                extent={{130,98},{232,-124}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Rectangle(
                extent={{-160,30},{-136,-60}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,36},{124,-124}},
                lineColor={238,46,47},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,98},{124,38}},
                lineColor={0,128,255},
                lineThickness=0.5),
              Polygon(
                points={{-124,30},{-124,-120},{72,-120},{72,-50},{0,30},{-124,30}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Text(
                extent={{78,-106},{114,-120}},
                textColor={238,46,47},
                textString="Microgrid"),
              Text(
                extent={{76,58},{128,34}},
                textColor={28,108,200},
                textString="Utility Grid"),
              Text(
                extent={{6,-102},{70,-124}},
                textColor={0,140,72},
                textString="Linearization Unit"),
              Text(
                extent={{-164,50},{-132,30}},
                textColor={0,140,72},
                textString="Inputs"),
              Text(
                extent={{128,118},{168,98}},
                textColor={0,140,72},
                textString="Outputs")}),
          Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),experiment(StopTime=10, __Dymola_Algorithm="Dassl"),
          Icon(coordinateSystem(extent={{-140,-140},{140,140}})));
      end MPCMicrogridGasBESS_01;

      model MPCMicrogridGasBESS_02_TABLE
        "Microgrid with G2 and PV on Local V Control"
        extends Modelica.Icons.Example;

        parameter Boolean equivalentGRID = false;
        parameter Boolean equivalentsystem = false;

        OpenIPSL.Electrical.Buses.Bus Bus1(v_0=powerFlow.powerflow.bus.V1, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-90,70},{-70,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus2(v_0=powerFlow.powerflow.bus.V2, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-50,70},{-30,90}})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
          R=0.001,
          X=0.2,
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000)  if not equivalentGRID annotation (Placement(transformation(
              extent={{-8,-8},{8,8}},
              rotation=180,
              origin={-60,80})));
        OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
          enableV_b=true,
          v_0=powerFlow.powerflow.bus.V1,
          angle_0=powerFlow.powerflow.bus.A1,
          P_0=powerFlow.powerflow.machines.PG1,
          Q_0=powerFlow.powerflow.machines.QG1,
          V_b=6000)  if not equivalentGRID
          annotation (Placement(transformation(extent={{-112,70},{-92,90}})));
        OpenIPSL.Electrical.Branches.PwLine L1(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{-26,76},
                  {-14,84}})));
        OpenIPSL.Electrical.Buses.Bus Bus3(v_0=powerFlow.powerflow.bus.V3, angle_0=
              powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-10,70},{10,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus4(v_0=powerFlow.powerflow.bus.V4, angle_0=
              powerFlow.powerflow.bus.V4) if not equivalentGRID
          annotation (Placement(transformation(extent={{50,70},{70,90}})));
        OpenIPSL.Electrical.Branches.PwLine L2_1(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,86},
                  {36,94}})));
        OpenIPSL.Electrical.Branches.PwLine L2_2(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,66},
                  {36,74}})));
        OpenIPSL.Electrical.Buses.Bus Bus5(angle_0=powerFlow.powerflow.bus.A5, v_0=
              powerFlow.powerflow.bus.V5)  annotation (Placement(
              transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={80,16})));
        OpenIPSL.Electrical.Branches.PwLine L3(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=-90,
              origin={80,60})));
        OpenIPSL.Electrical.Buses.Bus Bus6(v_0=powerFlow.powerflow.bus.V6, angle_0=
              powerFlow.powerflow.bus.A6) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={0,10})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000,
          R=0.005,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={40,10})));
        GenerationUnits.PSSE.G2_16MVA                         G2(
          enableV_b=true,
          enableP_0=true,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V6,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A6,
          V_b=6000,
          P_0=powerFlow.powerflow.machines.PG2,
          Q_0=powerFlow.powerflow.machines.QG2,
          enableangle_0=true)
                        annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-30,10})));
        inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000, fn=60)
          annotation (Placement(transformation(extent={{-128,104},{-74,124}})));
        OpenIPSL.Electrical.Loads.PSSE.Load Load1(
          V_b=220000,
          P_0=powerFlow.powerflow.loads.PL1,
          Q_0=powerFlow.powerflow.loads.QL1,
          v_0=powerFlow.powerflow.bus.V3,
          angle_0=powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-20,48},{0,68}})));
        Electrical.Events.Breaker breaker(enableTrigger=false,
          t_o=1.01,
          rc_enabled=true,
          t_rc=800.01)      if not equivalentGRID                     annotation (Placement(transformation(
              extent={{-4,-4},{4,4}},
              rotation=90,
              origin={80,26})));

        PFData.PowerFlow powerFlow(redeclare record PowerFlow =
              OpenIPSL.Examples.ModelPredictiveControl.PFData.PF15)
          annotation (Placement(transformation(extent={{-68,104},{-48,124}})));
        Electrical.Machines.PSSE.GENCLS IB(
          V_b=220000,
          v_0=powerFlow.powerflow.bus.V4,
          angle_0=powerFlow.powerflow.bus.A4,
          P_0=powerFlow.powerflow.machines.Pinf,
          Q_0=powerFlow.powerflow.machines.Qinf,
          M_b=100000000,
          X_d=1) if not equivalentGRID annotation (Placement(transformation(extent={{110,70},
                  {100,90}})));
        Electrical.Loads.PSSE.Load_ExtInput Load2(
          P_0=powerFlow.powerflow.loads.PL2,
          Q_0=powerFlow.powerflow.loads.QL2,
          v_0=powerFlow.powerflow.bus.V5,
          angle_0=powerFlow.powerflow.bus.A5,
          d_P=0,
          t1=0,
          d_t=0)
          annotation (Placement(transformation(extent={{100,-30},{120,-10}})));
        Electrical.Loads.NoiseInjections.WhiteNoiseInjection whiteNoiseInjection(
            active_sigma=0.0000000005,
                                  samplePeriod=0.02)
          annotation (Placement(transformation(extent={{76,-14},{82,-8}})));

        inner Modelica.Blocks.Noise.GlobalSeed globalSeed(useAutomaticSeed=false,
            fixedSeed=10000)
          annotation (Placement(transformation(extent={{-42,102},{-22,122}})));
        Modelica.Blocks.Sources.Sine sine(
          amplitude=0,
          f=1/260,
          phase=3.1415926535898,
          startTime=1000)
          annotation (Placement(transformation(extent={{76,-26},{82,-20}})));
        Modelica.Blocks.Math.Add add
          annotation (Placement(transformation(extent={{86,-18},{94,-10}})));

        Electrical.Buses.Bus          Bus7(v_0=powerFlow.powerflow.bus.V7, angle_0=
              powerFlow.powerflow.bus.A7) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={0,-76})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T3(
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.05) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=270,
              origin={60,-20})));

      //   Modelica.Blocks.Interfaces.RealOutput OUT23
      //     annotation (Placement(transformation(extent={{184,30},{204,50}})));
        GenerationUnits.PSSE.Battery_Units.BESSMPCLocalVControl BESS(
          V_base=480,
          V_b(displayUnit="kV") = 480,
          enableV_b=true,
          P_0=powerFlow.powerflow.machines.PBESS,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QBESS,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V7,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A7,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-86},{-20,-66}})));
        Modelica.Blocks.Sources.TimeTable timeTable(table=[0,0; 0.5,-1.24264918032404e-14;
              1,-6.94396099437037e-15; 1.5,0.0109239876041676; 2,
              0.00809042787337886; 2.5,0.0183516175970573; 3,0.0178060228576788;
              3.5,0.0251760661526197; 4,0.026767658761367; 4.5,
              0.029211200367593; 5,0.0310996081802506; 5.5,0.0348832584909024;
              6,0.0341878619451228; 6.5,0.0373237392536458; 7,
              0.0376798059691856; 7.5,0.0388565993037793; 8,0.0400120868092364;
              8.5,0.0404609863570278; 9,0.0410265916223926; 9.5,
              0.0421280786672702; 10,0.0418992054660754; 10.5,
              0.0427900135062151; 11,0.0430500239165445; 11.5,
              0.0431658701429802; 12,0.0436896963234636; 12.5,
              0.0437900522087153; 13,0.0439108114281004; 13.5,
              0.0443182246232487; 14,0.0442328465839188; 14.5,0.044481321930258;
              15,0.044640523610534; 15.5,0.0446137427525548; 16,
              0.044820998425289; 16.5,0.0448724304330972; 17,0.0448825999159317;
              17.5,0.0450497958710889; 18,0.0450281152248613; 18.5,
              0.0450942232528553; 19,0.0451835944012748; 19.5,0.045162013705218;
              20,0.0452390248226015; 20.5,0.045276210326117; 21,
              0.0452698257996735; 21.5,0.0453402001186964; 22,
              0.0453430046656058; 22.5,0.0453594543435633; 23,
              0.0454063349693945; 23.5,0.0454000361672035; 24,
              0.0454278380939377; 24.5,0.0454527509151126; 25,
              0.0454491300394386; 25.5,0.0454787435675519; 26,
              0.0454873571129985; 26.5,0.0454916579412645; 27,
              0.0455150485768547; 27.5,0.0455162386164238; 28,0.045526463903139;
              28.5,0.0455414676520951; 29,0.0455413412483614; 29.5,
              0.045553869181129; 30,0.0455614989401403; 30.5,0.0455633385485845;
              31,0.0455746478862073; 31.5,0.0455778160329692; 32,
              0.0455819656684986; 32.5,0.0455903374235709; 33,
              0.0455917277115054; 33.5,0.0455971908336059; 34,
              0.0456024086513003; 34.5,0.0456037945995027; 35,
              0.0456092194913842; 35.5,0.0456120900069001; 36,
              0.0456141049517973; 36.5,0.0456185624338039; 37,
              0.0456201478729474; 37.5,0.0456226842127256; 38,
              0.0456258531597788; 38.5,0.0456270022199752; 39,
              0.0456296252046988; 39.5,0.0456316575512672])
          annotation (Placement(transformation(extent={{-120,-20},{-100,0}})));
        Modelica.Blocks.Sources.TimeTable timeTable1(table=[0,0; 0.5,-8.13839869011426e-12;
              1,-4.54811451008586e-12; 1.5,-0.00671806961118269; 2,-0.00348767229361689;
              2.5,-0.00552326595875817; 3,-0.00414900572145958; 3.5,-0.00577987295601266;
              4,-0.00563317429392006; 4.5,-0.00541367793989954; 5,-0.00585022758510055;
              5.5,-0.00658744868822301; 6,-0.00580640225992189; 6.5,-0.00673789887277186;
              7,-0.00650205491776111; 7.5,-0.00665931602207413; 8,-0.00698383939364864;
              8.5,-0.00685556747975445; 9,-0.0070135222039419; 9.5,-0.00730537052317968;
              10,-0.00707175092618227; 10.5,-0.00739583333251912; 11,-0.00740901180160845;
              11.5,-0.00738393138505953; 12,-0.00759439312144648; 12.5,-0.00755977458545485;
              13,-0.00760276137545444; 13.5,-0.00775524903227063; 14,-0.00768365892370935;
              14.5,-0.00779560390242238; 15,-0.00784880400307429; 15.5,-0.00782359854342416;
              16,-0.00792533529850679; 16.5,-0.00793336195604631; 17,-0.00794257204172531;
              17.5,-0.00802176082547255; 18,-0.00800639320711248; 18.5,-0.00804543529636291;
              19,-0.00808795381676873; 19.5,-0.00807856773659608; 20,-0.00812352916616575;
              20.5,-0.00814087200206557; 21,-0.00814332225020507; 21.5,-0.00818264719890869;
              22,-0.00818533940486553; 22.5,-0.00819973876843192; 23,-0.00822608050860239;
              23.5,-0.00822581234692109; 24,-0.00824528090835606; 24.5,-0.00825983529273998;
              25,-0.00826198309383784; 25.5,-0.00828094584862025; 26,-0.00828737244392595;
              26.5,-0.00829355223090498; 27,-0.00830823916318777; 27.5,-0.00831113028339324;
              28,-0.00831982477757563; 28.5,-0.00832949111566115; 29,-0.00833188115616622;
              29.5,-0.0083409831475739; 30,-0.00834655462959986; 30.5,-0.00834984635541445;
              31,-0.00835763705184288; 31.5,-0.00836079076871275; 32,-0.00836497439837501;
              32.5,-0.00837074272259018; 33,-0.00837291477910083; 33.5,-0.00837737615832555;
              34,-0.008381211954385; 34.5,-0.00838326822813405; 35,-0.0083873278915839;
              35.5,-0.00838978034988256; 36,-0.0083919897886656; 36.5,-0.0083952462394684;
              37,-0.00839692402138224; 37.5,-0.00839919670370813; 38,-0.00840157378213733;
              38.5,-0.00840292907639904; 39,-0.00840504596042289; 39.5,-0.00840669457719488])
          annotation (Placement(transformation(extent={{-120,20},{-100,40}})));
        Modelica.Blocks.Sources.TimeTable timeTable2(table=[0,0; 0.5,
              4.00978769957539e-12; 1,2.25702788003177e-12; 1.5,
              0.0027301314201461; 2,0.00326119359123799; 2.5,
              0.00314027370000735; 3,0.00324308791609928; 3.5,
              0.00310215230289633; 4,0.00316178923844267; 4.5,
              0.00318314994000934; 5,0.00317591572695851; 5.5,
              0.0031266462552063; 6,0.00319722945663391; 6.5,
              0.00314887307638988; 7,0.0031738596839107; 7.5,
              0.00316620947229761; 8,0.003161255126214; 8.5,0.00317302833364607;
              9,0.00317100838129313; 9.5,0.00315815313619649; 10,
              0.00317920370316426; 10.5,0.00316417466374063; 11,
              0.00316872611534734; 11.5,0.00317354972329819; 12,
              0.00316629542725832; 12.5,0.00317149258028359; 13,
              0.00317257677974491; 13.5,0.00316680182651523; 14,
              0.00317421232173358; 14.5,0.00317023319299592; 15,
              0.00316995894598904; 15.5,0.00317367051406059; 16,
              0.00317017414400578; 16.5,0.00317176714638557; 17,
              0.0031732075422446; 17.5,0.00317046728149773; 18,
              0.00317312954730065; 18.5,0.00317241566325; 19,
              0.00317152903165364; 19.5,0.003173450672191; 20,
              0.00317218432344646; 20.5,0.00317242938254859; 21,
              0.00317343680794813; 21.5,0.00317225140790545; 22,
              0.00317312899094969; 22.5,0.00317322834802103; 23,
              0.00317261720386997; 23.5,0.00317346445234934; 24,
              0.00317311939091181; 24.5,0.00317302229144856; 25,
              0.00317358181392769; 25.5,0.00317313066189296; 26,
              0.00317337149750963; 26.5,0.00317357377819805; 27,
              0.00317326148390041; 27.5,0.0031735932383098; 28,
              0.00317355410991844; 28.5,0.00317343749787924; 29,
              0.00317370811415163; 29.5,0.00317356527540891; 30,
              0.00317360704296644; 30.5,0.00317375179222091; 31,
              0.00317361906852027; 31.5,0.00317373458117904; 32,
              0.00317376877479542; 32.5,0.0031736974087776; 33,
              0.00317381573429882; 33.5,0.00317378547700615; 34,
              0.00317377943310543; 34.5,0.00317386030381109; 35,
              0.00317381359299432; 35.5,0.00317384861090001; 36,
              0.00317388482590595; 36.5,0.00317385141954879; 37,
              0.00317389908777336; 37.5,0.00317390243379421; 38,
              0.00317389219800353; 38.5,0.00317393213852394; 39,
              0.00317392047452779; 39.5,0.00317392933787575]) annotation (
            Placement(transformation(extent={{-120,-100},{-100,-80}})));
        Modelica.Blocks.Sources.TimeTable timeTable3(table=[0,0; 0.5,-3.23585556339542e-11;
              1,-1.80913989824356e-11; 1.5,0.000790408288731436; 2,
              0.00152078774149299; 2.5,0.00130538145338687; 3,
              0.00160064414813587; 3.5,0.00150068407024616; 4,
              0.00173176207855828; 4.5,0.00162982329857751; 5,
              0.00178789169041803; 5.5,0.00177462663912419; 6,
              0.00186201114150318; 6.5,0.0018597945872315; 7,0.00193494710023;
              7.5,0.0019341686932458; 8,0.00199839775202136; 8.5,
              0.0019995609399691; 9,0.00204346597429371; 9.5,
              0.00206139503133472; 10,0.0020874713532507; 10.5,
              0.00210430027143681; 11,0.00213165464072206; 11.5,
              0.0021414761786046; 12,0.00216656790863566; 12.5,
              0.00217755696299725; 13,0.0021942733105914; 13.5,
              0.00220892466098964; 14,0.00222109866453178; 14.5,
              0.00223281502517105; 15,0.00224631152339051; 15.5,0.0022542755631;
              16,0.00226633704301628; 16.5,0.00227488594501059; 17,
              0.00228319474686868; 17.5,0.00229226138566809; 18,
              0.00229935253330606; 18.5,0.00230629229549696; 19,
              0.00231383883758486; 19.5,0.00231917609943601; 20,
              0.00232559767515496; 20.5,0.00233114216510834; 21,
              0.00233587942540527; 21.5,0.00234116208915682; 22,
              0.00234552767664655; 22.5,0.00234959199246933; 23,
              0.00235395081739411; 23.5,0.00235735604830646; 24,
              0.00236095730154475; 24.5,0.00236436103419004; 25,
              0.00236720575762285; 25.5,0.0023702525627365; 26,
              0.00237293599982815; 26.5,0.00237534425702681; 27,
              0.00237787776897382; 27.5,0.00237999888790931; 28,
              0.00238207615794752; 28.5,0.0023841146460465; 29,
              0.00238584622007433; 29.5,0.00238760975909287; 30,
              0.0023892375706039; 30.5,0.00239067769753961; 31,
              0.0023921526854291; 31.5,0.00239345008983406; 32,
              0.00239466803344642; 32.5,0.00239587283699107; 33,
              0.00239692272605914; 33.5,0.00239794980212001; 34,
              0.00239892255026826; 34.5,0.00239978515054308; 35,
              0.00240064230828428; 35.5,0.00240142485695226; 36,
              0.00240214245359398; 36.5,0.00240284858494312; 37,
              0.00240347957137162; 37.5,0.00240407843742245; 38,
              0.00240465278524725; 38.5,0.00240516604346929; 39,
              0.00240566473576502; 39.5,0.00240612790713239]) annotation (
            Placement(transformation(extent={{-120,-60},{-100,-40}})));
      equation

        OUT1 = G2.gen.w;
        OUT2 = G2.gen.delta;
        OUT3 = G2.gen.Epq;
        OUT4 = G2.gen.PSIkd;
        OUT5 = G2.gen.PSIppq;
        OUT6 = G2.sEXSMPC.simpleLagLim.state;
        OUT7 = G2.sEXSMPC.leadLag.TF.x[1];
        OUT8 = G2.gASTMPC.simpleLagLim.state;
        OUT9 = G2.gASTMPC.simpleLag.state;
        OUT10 = G2.gASTMPC.simpleLag1.state;
        OUT11 = BESS.rEGCA1_1.simpleLag.state;
        OUT12 = BESS.rEGCA1_1.integrator.y;
        OUT13 = BESS.rEGCA1_1.integrator1.y;
        OUT14 = BESS.rEECCU1_Local_V_Control.integrator3.y;
        OUT15 = BESS.rEECCU1_Local_V_Control.integrator1.y;
        OUT16 = BESS.rEECCU1_Local_V_Control.simpleLag.state;
        OUT17 =BESS.rEECCU1_Local_V_Control.IGQ.y;
        OUT18 = BESS.rEECCU1_Local_V_Control.simpleLag2.state;
        OUT19 = G2.gen.PMECH;
        OUT20 = G2.sEXSMPC.EFD;
        OUT21 = Bus5.v;
        OUT22 = Bus5.angle;

        connect(T1.p, Bus2.p)
          annotation (Line(points={{-51.2,80},{-40,80}}, color={0,0,255}));
        connect(Bus1.p, T1.n)
          annotation (Line(points={{-80,80},{-68.8,80}}, color={0,0,255}));
        connect(G1.conn, Bus1.p)
          annotation (Line(points={{-91,80},{-80,80}}, color={0,0,255}));
        connect(L1.n, Bus3.p)
          annotation (Line(points={{-14.6,80},{0,80}}, color={0,0,255}));
        connect(L1.p, Bus2.p)
          annotation (Line(points={{-25.4,80},{-40,80}}, color={0,0,255}));
        connect(L2_2.n, Bus4.p) annotation (Line(points={{35.4,70},{44,70},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.n, Bus4.p) annotation (Line(points={{35.4,90},{44,90},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.p, Bus3.p) annotation (Line(points={{24.6,90},{16,90},{16,80},{0,
                80}}, color={0,0,255}));
        connect(L2_2.p, Bus3.p) annotation (Line(points={{24.6,70},{16,70},{16,80},{0,
                80}}, color={0,0,255}));
        connect(Load1.p, Bus3.p)
          annotation (Line(points={{-10,68},{-10,80},{0,80}}, color={0,0,255}));
        connect(L3.p, Bus4.p)
          annotation (Line(points={{80,65.4},{80,80},{60,80}}, color={0,0,255}));
        connect(breaker.s, Bus5.p)
          annotation (Line(points={{80,22},{80,16}},color={0,0,255}));
        connect(breaker.r, L3.n)
          annotation (Line(points={{80,30},{80,54.6}},color={0,0,255}));
        connect(T2.p, Bus5.p) annotation (Line(points={{51,10},{80,10},{80,16}},
              color={0,0,255}));

        connect(IB.p, Bus4.p)
          annotation (Line(points={{100,80},{60,80}}, color={0,0,255}));
        connect(Load2.p, Bus5.p) annotation (Line(points={{110,-10},{110,10},{80,10},{
                80,16}},
                     color={0,0,255}));
        connect(sine.y, add.u2) annotation (Line(points={{82.3,-23},{82.3,-24},{85.2,-24},
                {85.2,-16.4}}, color={0,0,127}));
        connect(whiteNoiseInjection.y, add.u1) annotation (Line(points={{82.27,-11.03},
                {82.27,-11.6},{85.2,-11.6}}, color={0,0,127}));
        connect(add.y, Load2.u) annotation (Line(points={{94.4,-14},{94.4,-14.5},{101.9,
                -14.5}}, color={0,0,127}));
        connect(T3.n, Bus7.p) annotation (Line(points={{60,-31},{60,-76},{0,-76}},
                       color={0,0,255}));
        connect(T3.p, Bus5.p) annotation (Line(points={{60,-9},{60,10},{80,10},{80,16}},
              color={0,0,255}));
        connect(Bus6.p, T2.n)
          annotation (Line(points={{4.996e-16,10},{29,10}},
                                                  color={0,0,255}));
        connect(G2.conn, Bus6.p) annotation (Line(points={{-19,10},{4.996e-16,10}},
                                           color={0,0,255}));
        connect(BESS.p1, Bus7.p)
          annotation (Line(points={{-20,-76},{4.996e-16,-76}}, color={0,0,255}));
        connect(timeTable1.y, G2.P_ref1) annotation (Line(points={{-99,30},{-50,
                30},{-50,16},{-42,16}}, color={0,0,127}));
        connect(timeTable.y, G2.Efd_ref) annotation (Line(points={{-99,-10},{
                -50,-10},{-50,4},{-42,4}}, color={0,0,127}));
        connect(timeTable3.y, BESS.Pinput) annotation (Line(points={{-99,-50},{
                -50,-50},{-50,-70},{-42,-70}}, color={0,0,127}));
        connect(timeTable2.y, BESS.Vinput) annotation (Line(points={{-99,-90},{
                -42,-90},{-42,-82}}, color={0,0,127}));
          annotation (Placement(transformation(extent={{140,-20},{160,0}})),
                      Placement(transformation(extent={{140,-40},{160,-20}})),
                      Placement(transformation(extent={{140,-60},{160,-40}})),
                      Placement(transformation(extent={{140,-80},{160,-60}})),
                     Diagram(coordinateSystem(preserveAspectRatio=false,
                extent={{-140,-140},{140,140}})),
          Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),experiment(StopTime=50, __Dymola_Algorithm="Dassl"),
          Icon(coordinateSystem(extent={{-140,-140},{140,140}})));
      end MPCMicrogridGasBESS_02_TABLE;

      model MPCMicrogridGasPV_02_rootlocus
        "Microgrid with G2 and PV on Local V Control"
        extends Modelica.Icons.Example;

        parameter Boolean equivalentGRID = true;
        parameter Boolean equivalentsystem = false;

        OpenIPSL.Electrical.Buses.Bus Bus1(v_0=powerFlow.powerflow.bus.V1, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-90,70},{-70,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus2(v_0=powerFlow.powerflow.bus.V2, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-50,70},{-30,90}})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
          R=0.001,
          X=0.2,
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000)  if not equivalentGRID annotation (Placement(transformation(
              extent={{-8,-8},{8,8}},
              rotation=180,
              origin={-60,80})));
        OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
          enableV_b=true,
          v_0=powerFlow.powerflow.bus.V1,
          angle_0=powerFlow.powerflow.bus.A1,
          P_0=powerFlow.powerflow.machines.PG1,
          Q_0=powerFlow.powerflow.machines.QG1,
          V_b=6000)  if not equivalentGRID
          annotation (Placement(transformation(extent={{-112,70},{-92,90}})));
        OpenIPSL.Electrical.Branches.PwLine L1(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{-26,76},
                  {-14,84}})));
        OpenIPSL.Electrical.Buses.Bus Bus3(v_0=powerFlow.powerflow.bus.V3, angle_0=
              powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-10,70},{10,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus4(v_0=powerFlow.powerflow.bus.V4, angle_0=
              powerFlow.powerflow.bus.V4) if not equivalentGRID
          annotation (Placement(transformation(extent={{50,70},{70,90}})));
        OpenIPSL.Electrical.Branches.PwLine L2_1(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,86},
                  {36,94}})));
        OpenIPSL.Electrical.Branches.PwLine L2_2(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,66},
                  {36,74}})));
        OpenIPSL.Electrical.Buses.Bus Bus5(angle_0=powerFlow.powerflow.bus.A5, v_0=
              powerFlow.powerflow.bus.V5)  annotation (Placement(
              transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={80,16})));
        OpenIPSL.Electrical.Branches.PwLine L3(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=-90,
              origin={80,60})));
        OpenIPSL.Electrical.Buses.Bus Bus6(v_0=powerFlow.powerflow.bus.V6, angle_0=
              powerFlow.powerflow.bus.A6) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={0,10})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000,
          R=0.005,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={40,10})));
        GenerationUnits.PSSE.G2_16MVA                         G2(
          enableV_b=true,
          enableP_0=true,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V6,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A6,
          V_b=6000,
          P_0=powerFlow.powerflow.machines.PG2,
          Q_0=powerFlow.powerflow.machines.QG2,
          enableangle_0=true)
                        annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-30,10})));
        inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000, fn=60)
          annotation (Placement(transformation(extent={{-128,104},{-74,124}})));
        OpenIPSL.Electrical.Loads.PSSE.Load Load1(
          V_b=220000,
          P_0=powerFlow.powerflow.loads.PL1,
          Q_0=powerFlow.powerflow.loads.QL1,
          v_0=powerFlow.powerflow.bus.V3,
          angle_0=powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-20,48},{0,68}})));
        Electrical.Events.Breaker breaker(enableTrigger=false,
          t_o=1.01,
          rc_enabled=true,
          t_rc=800.01)      if not equivalentGRID                     annotation (Placement(transformation(
              extent={{-4,-4},{4,4}},
              rotation=90,
              origin={80,26})));

        Modelica.Blocks.Sources.Constant IN11(k=0)
          annotation (Placement(transformation(extent={{-108,-2},{-96,10}})));
        Modelica.Blocks.Math.Add AddU1
          annotation (Placement(transformation(extent={{-80,0},{-60,20}})));
        Modelica.Blocks.Sources.Constant IN22(k=0)
          annotation (Placement(transformation(extent={{-108,-32},{-96,-20}})));
        Modelica.Blocks.Math.Add AddU2
          annotation (Placement(transformation(extent={{-80,-30},{-60,-10}})));

        PFData.PowerFlow powerFlow(redeclare record PowerFlow =
              OpenIPSL.Examples.ModelPredictiveControl.PFData.PF14)
          annotation (Placement(transformation(extent={{-68,104},{-48,124}})));
        Electrical.Machines.PSSE.GENCLS IB(
          V_b=220000,
          v_0=powerFlow.powerflow.bus.V4,
          angle_0=powerFlow.powerflow.bus.A4,
          P_0=powerFlow.powerflow.machines.Pinf,
          Q_0=powerFlow.powerflow.machines.Qinf,
          M_b=100000000,
          X_d=1) if not equivalentGRID annotation (Placement(transformation(extent={{110,70},
                  {100,90}})));
        Electrical.Loads.PSSE.Load_ExtInput Load2(
          P_0=powerFlow.powerflow.loads.PL2,
          Q_0=powerFlow.powerflow.loads.QL2,
          v_0=powerFlow.powerflow.bus.V5,
          angle_0=powerFlow.powerflow.bus.A5,
          d_P=0,
          t1=100,
          d_t=1000)
          annotation (Placement(transformation(extent={{100,-30},{120,-10}})));
        Electrical.Loads.NoiseInjections.WhiteNoiseInjection whiteNoiseInjection(
            active_sigma=0.0000000005,
                                  samplePeriod=0.02)
          annotation (Placement(transformation(extent={{76,-14},{82,-8}})));

        inner Modelica.Blocks.Noise.GlobalSeed globalSeed(useAutomaticSeed=false,
            fixedSeed=10000)
          annotation (Placement(transformation(extent={{-42,102},{-22,122}})));
        Modelica.Blocks.Sources.Sine sine(
          amplitude=0,
          f=1/260,
          phase=3.1415926535898,
          startTime=1000)
          annotation (Placement(transformation(extent={{76,-26},{82,-20}})));
        Modelica.Blocks.Math.Add add
          annotation (Placement(transformation(extent={{86,-18},{94,-10}})));

        Electrical.Buses.Bus          Bus7(v_0=powerFlow.powerflow.bus.V7, angle_0=
              powerFlow.powerflow.bus.A7) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={0,-76})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T3(
          G=0,
          B=0,
          CW=1,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=270,
              origin={60,-20})));
        GenerationUnits.PSSE.Solar_Units.SolarMPCLocalVControl PV(
          V_b=480,
          P_0=powerFlow.powerflow.machines.PPV,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QPV,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V7,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A7,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-86},{-20,-66}})));
        Modelica.Blocks.Math.Add AddU3
          annotation (Placement(transformation(extent={{-80,-60},{-60,-40}})));
        Modelica.Blocks.Sources.Constant IN33(k=0)
          annotation (Placement(transformation(extent={{-108,-62},{-96,-50}})));
        Modelica.Blocks.Interfaces.RealInput u1
                     "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-180,-4},{-140,36}})));
        Modelica.Blocks.Interfaces.RealInput u2
                     "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-180,-34},{-140,6}})));
        Modelica.Blocks.Interfaces.RealInput u3
                     "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-180,-64},{-140,-24}})));
        Modelica.Blocks.Interfaces.RealOutput OUT1
          annotation (Placement(transformation(extent={{140,38},{160,60}})));
        Modelica.Blocks.Interfaces.RealOutput OUT2
          annotation (Placement(transformation(extent={{140,18},{160,40}})));
        Modelica.Blocks.Interfaces.RealOutput OUT3
          annotation (Placement(transformation(extent={{140,-42},{160,-20}})));
      equation

         OUT1 = G2.gen.w;
         OUT2 = Bus5.v;
         OUT3 = Bus5.angle;
        // OUT4 = PV.rEGCA1_1.Qgen;
      //   OUT5 = G2.gen.PSIppq;
      //   OUT6 = G2.sEXSMPC.simpleLagLim.state;
      //   OUT7 = G2.sEXSMPC.leadLag.TF.x[1];
      //   OUT8 = G2.gASTMPC.simpleLagLim.state;
      //   OUT9 = G2.gASTMPC.simpleLag.state;
      //   OUT10 = G2.gASTMPC.simpleLag1.state;
      //   OUT11 = PV.rEGCA1_1.simpleLag.state;
      //   OUT12 = PV.rEGCA1_1.integrator.y;
      //   OUT13 = PV.rEGCA1_1.integrator1.y;
      //   OUT14 = PV.rEECB1_Local_V_Control.integrator1.y;
      //   OUT15 = PV.rEECB1_Local_V_Control.simpleLag.state;
      //   OUT16 = PV.rEECB1_Local_V_Control.integrator3.y;
      //   OUT17 = PV.rEECB1_Local_V_Control.simpleLag1.state;
      //   OUT18 = PV.rEGCA1_1.Qgen;
      //   OUT19 = PV.rEGCA1_1.Pgen;
      //   OUT20 = G2.gen.PMECH;
      //   OUT21 = G2.sEXSMPC.EFD;
      //   OUT22 = Bus5.v;
      //   OUT23 = Bus5.angle;

        connect(T1.p, Bus2.p)
          annotation (Line(points={{-51.2,80},{-40,80}}, color={0,0,255}));
        connect(Bus1.p, T1.n)
          annotation (Line(points={{-80,80},{-68.8,80}}, color={0,0,255}));
        connect(G1.conn, Bus1.p)
          annotation (Line(points={{-91,80},{-80,80}}, color={0,0,255}));
        connect(L1.n, Bus3.p)
          annotation (Line(points={{-14.6,80},{0,80}}, color={0,0,255}));
        connect(L1.p, Bus2.p)
          annotation (Line(points={{-25.4,80},{-40,80}}, color={0,0,255}));
        connect(L2_2.n, Bus4.p) annotation (Line(points={{35.4,70},{44,70},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.n, Bus4.p) annotation (Line(points={{35.4,90},{44,90},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.p, Bus3.p) annotation (Line(points={{24.6,90},{16,90},{16,80},{0,
                80}}, color={0,0,255}));
        connect(L2_2.p, Bus3.p) annotation (Line(points={{24.6,70},{16,70},{16,80},{0,
                80}}, color={0,0,255}));
        connect(Load1.p, Bus3.p)
          annotation (Line(points={{-10,68},{-10,80},{0,80}}, color={0,0,255}));
        connect(L3.p, Bus4.p)
          annotation (Line(points={{80,65.4},{80,80},{60,80}}, color={0,0,255}));
        connect(breaker.s, Bus5.p)
          annotation (Line(points={{80,22},{80,16}},color={0,0,255}));
        connect(breaker.r, L3.n)
          annotation (Line(points={{80,30},{80,54.6}},color={0,0,255}));
        connect(IN11.y, AddU1.u2) annotation (Line(points={{-95.4,4},{-82,4}},
                            color={0,0,127}));
        connect(T2.p, Bus5.p) annotation (Line(points={{51,10},{80,10},{80,16}},
              color={0,0,255}));

        connect(IN22.y,AddU2. u2) annotation (Line(points={{-95.4,-26},{-82,-26}},
                       color={0,0,127}));
        connect(AddU2.y, G2.Efd_ref)
          annotation (Line(points={{-59,-20},{-52,-20},{-52,4},{-42,4}},
                                                                 color={0,0,127}));
        connect(AddU1.y, G2.P_ref1) annotation (Line(points={{-59,10},{-52,10},{-52,16},
                {-42,16}},                          color={0,0,127}));
        connect(IB.p, Bus4.p)
          annotation (Line(points={{100,80},{60,80}}, color={0,0,255}));
        connect(Load2.p, Bus5.p) annotation (Line(points={{110,-10},{110,10},{80,10},{
                80,16}},
                     color={0,0,255}));
        connect(sine.y, add.u2) annotation (Line(points={{82.3,-23},{82.3,-24},{85.2,-24},
                {85.2,-16.4}}, color={0,0,127}));
        connect(whiteNoiseInjection.y, add.u1) annotation (Line(points={{82.27,-11.03},
                {82.27,-11.6},{85.2,-11.6}}, color={0,0,127}));
        connect(add.y, Load2.u) annotation (Line(points={{94.4,-14},{94.4,-14.5},{101.9,
                -14.5}}, color={0,0,127}));
        connect(T3.n, Bus7.p) annotation (Line(points={{60,-31},{60,-76},{0,-76}},
                       color={0,0,255}));
        connect(T3.p, Bus5.p) annotation (Line(points={{60,-9},{60,10},{80,10},{80,16}},
              color={0,0,255}));
        connect(Bus6.p, T2.n)
          annotation (Line(points={{4.996e-16,10},{29,10}},
                                                  color={0,0,255}));
        connect(PV.p1, Bus7.p)
          annotation (Line(points={{-20,-76},{4.996e-16,-76}}, color={0,0,255}));
        connect(IN33.y,AddU3. u2)
          annotation (Line(points={{-95.4,-56},{-82,-56}}, color={0,0,127}));
        connect(G2.conn, Bus6.p) annotation (Line(points={{-19,10},{4.996e-16,10}},
                                           color={0,0,255}));
        connect(PV.VINPUT, AddU3.y) annotation (Line(points={{-42,-76},{-50,-76},{-50,
                -50},{-59,-50}}, color={0,0,127}));
        connect(AddU1.u1, u1)
          annotation (Line(points={{-82,16},{-160,16}}, color={0,0,127}));
        connect(AddU2.u1, u2)
          annotation (Line(points={{-82,-14},{-160,-14}}, color={0,0,127}));
        connect(AddU3.u1, u3)
          annotation (Line(points={{-82,-44},{-160,-44}}, color={0,0,127}));
          annotation (Placement(transformation(extent={{140,-20},{160,0}})),
                      Placement(transformation(extent={{140,-40},{160,-20}})),
                      Placement(transformation(extent={{140,-60},{160,-40}})),
                      Placement(transformation(extent={{140,-80},{160,-60}})),
                     Diagram(coordinateSystem(preserveAspectRatio=false,
                extent={{-140,-140},{140,140}}), graphics={
              Rectangle(
                extent={{-160,30},{-136,-60}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,36},{124,-124}},
                lineColor={238,46,47},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,98},{124,38}},
                lineColor={0,128,255},
                lineThickness=0.5),
              Polygon(
                points={{-124,30},{-124,-120},{72,-120},{72,-50},{0,30},{-124,30}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Text(
                extent={{78,-106},{114,-120}},
                textColor={238,46,47},
                textString="Microgrid"),
              Text(
                extent={{76,58},{128,34}},
                textColor={28,108,200},
                textString="Utility Grid"),
              Text(
                extent={{6,-102},{70,-124}},
                textColor={0,140,72},
                textString="Linearization Unit"),
              Text(
                extent={{-164,50},{-132,30}},
                textColor={0,140,72},
                textString="Inputs"),
              Text(
                extent={{128,118},{168,98}},
                textColor={0,140,72},
                textString="Outputs")}),
          Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),experiment(StopTime=100, __Dymola_Algorithm="Dassl"),
          Icon(coordinateSystem(extent={{-140,-140},{140,140}})));
      end MPCMicrogridGasPV_02_rootlocus;

      model MPCMicrogridGasBESS_02_rootlocus2
        "Microgrid with G2 and PV on Local V Control"
        extends Modelica.Icons.Example;

        parameter Boolean equivalentGRID = true;
        parameter Boolean equivalentsystem = false;

        OpenIPSL.Electrical.Buses.Bus Bus1(v_0=powerFlow.powerflow.bus.V1, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-90,70},{-70,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus2(v_0=powerFlow.powerflow.bus.V2, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-50,70},{-30,90}})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
          R=0.001,
          X=0.2,
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000)  if not equivalentGRID annotation (Placement(transformation(
              extent={{-8,-8},{8,8}},
              rotation=180,
              origin={-60,80})));
        OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
          enableV_b=true,
          v_0=powerFlow.powerflow.bus.V1,
          angle_0=powerFlow.powerflow.bus.A1,
          P_0=powerFlow.powerflow.machines.PG1,
          Q_0=powerFlow.powerflow.machines.QG1,
          V_b=6000)  if not equivalentGRID
          annotation (Placement(transformation(extent={{-112,70},{-92,90}})));
        OpenIPSL.Electrical.Branches.PwLine L1(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{-26,76},
                  {-14,84}})));
        OpenIPSL.Electrical.Buses.Bus Bus3(v_0=powerFlow.powerflow.bus.V3, angle_0=
              powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-10,70},{10,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus4(v_0=powerFlow.powerflow.bus.V4, angle_0=
              powerFlow.powerflow.bus.V4) if not equivalentGRID
          annotation (Placement(transformation(extent={{50,70},{70,90}})));
        OpenIPSL.Electrical.Branches.PwLine L2_1(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,86},
                  {36,94}})));
        OpenIPSL.Electrical.Branches.PwLine L2_2(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,66},
                  {36,74}})));
        OpenIPSL.Electrical.Buses.Bus Bus5(angle_0=powerFlow.powerflow.bus.A5, v_0=
              powerFlow.powerflow.bus.V5)  annotation (Placement(
              transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={80,16})));
        OpenIPSL.Electrical.Branches.PwLine L3(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=-90,
              origin={80,60})));
        OpenIPSL.Electrical.Buses.Bus Bus6(v_0=powerFlow.powerflow.bus.V6, angle_0=
              powerFlow.powerflow.bus.A6) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={0,10})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000,
          R=0.005,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={40,10})));
        GenerationUnits.PSSE.G2_16MVA                         G2(
          enableV_b=true,
          enableP_0=true,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V6,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A6,
          V_b=6000,
          P_0=powerFlow.powerflow.machines.PG2,
          Q_0=powerFlow.powerflow.machines.QG2,
          enableangle_0=true)
                        annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-30,10})));
        inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000, fn=60)
          annotation (Placement(transformation(extent={{-128,104},{-74,124}})));
        OpenIPSL.Electrical.Loads.PSSE.Load Load1(
          V_b=220000,
          P_0=powerFlow.powerflow.loads.PL1,
          Q_0=powerFlow.powerflow.loads.QL1,
          v_0=powerFlow.powerflow.bus.V3,
          angle_0=powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-20,48},{0,68}})));
        Electrical.Events.Breaker breaker(enableTrigger=false,
          t_o=1.01,
          rc_enabled=true,
          t_rc=800.01)      if not equivalentGRID                     annotation (Placement(transformation(
              extent={{-4,-4},{4,4}},
              rotation=90,
              origin={80,26})));

        Modelica.Blocks.Sources.Constant IN11(k=0)
          annotation (Placement(transformation(extent={{-108,-2},{-96,10}})));
        Modelica.Blocks.Math.Add AddU1
          annotation (Placement(transformation(extent={{-80,0},{-60,20}})));
        Modelica.Blocks.Sources.Constant IN22(k=0)
          annotation (Placement(transformation(extent={{-108,-32},{-96,-20}})));
        Modelica.Blocks.Math.Add AddU2
          annotation (Placement(transformation(extent={{-80,-30},{-60,-10}})));

        PFData.PowerFlow powerFlow(redeclare record PowerFlow =
              OpenIPSL.Examples.ModelPredictiveControl.PFData.PF15)
          annotation (Placement(transformation(extent={{-68,104},{-48,124}})));
        Electrical.Machines.PSSE.GENCLS IB(
          V_b=220000,
          v_0=powerFlow.powerflow.bus.V4,
          angle_0=powerFlow.powerflow.bus.A4,
          P_0=powerFlow.powerflow.machines.Pinf,
          Q_0=powerFlow.powerflow.machines.Qinf,
          M_b=100000000,
          X_d=1) if not equivalentGRID annotation (Placement(transformation(extent={{110,70},
                  {100,90}})));
        Electrical.Loads.PSSE.Load_ExtInput Load2(
          P_0=powerFlow.powerflow.loads.PL2,
          Q_0=powerFlow.powerflow.loads.QL2,
          v_0=powerFlow.powerflow.bus.V5,
          angle_0=powerFlow.powerflow.bus.A5,
          d_P=0,
          t1=0,
          d_t=0)
          annotation (Placement(transformation(extent={{100,-30},{120,-10}})));
        Electrical.Loads.NoiseInjections.WhiteNoiseInjection whiteNoiseInjection(
            active_sigma=0.0000000005,
                                  samplePeriod=0.02)
          annotation (Placement(transformation(extent={{76,-14},{82,-8}})));

        inner Modelica.Blocks.Noise.GlobalSeed globalSeed(useAutomaticSeed=false,
            fixedSeed=10000)
          annotation (Placement(transformation(extent={{-42,102},{-22,122}})));
        Modelica.Blocks.Sources.Sine sine(
          amplitude=0,
          f=1/260,
          phase=3.1415926535898,
          startTime=1000)
          annotation (Placement(transformation(extent={{76,-26},{82,-20}})));
        Modelica.Blocks.Math.Add add
          annotation (Placement(transformation(extent={{86,-18},{94,-10}})));

        Electrical.Buses.Bus          Bus7(v_0=powerFlow.powerflow.bus.V7, angle_0=
              powerFlow.powerflow.bus.A7) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={0,-76})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T3(
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.05) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=270,
              origin={60,-20})));
        Modelica.Blocks.Math.Add AddU3
          annotation (Placement(transformation(extent={{-80,-60},{-60,-40}})));
        Modelica.Blocks.Sources.Constant IN33(k=0)
          annotation (Placement(transformation(extent={{-108,-62},{-96,-50}})));

        GenerationUnits.PSSE.Battery_Units.BESSMPCLocalVControl BESS(
          V_base=480,
          V_b(displayUnit="kV") = 480,
          enableV_b=true,
          P_0=powerFlow.powerflow.machines.PBESS,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QBESS,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V7,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A7,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-86},{-20,-66}})));
        Modelica.Blocks.Sources.Constant IN44(k=0)
          annotation (Placement(transformation(extent={{-108,-102},{-96,-90}})));
        Modelica.Blocks.Math.Add AddU4
          annotation (Placement(transformation(extent={{-80,-100},{-60,-80}})));
        Modelica.Blocks.Interfaces.RealInput u1
                     "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-180,-4},{-140,36}})));
        Modelica.Blocks.Interfaces.RealInput u2
                     "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-180,-34},{-140,6}})));
        Modelica.Blocks.Interfaces.RealInput u3
                     "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-180,-64},{-140,-24}})));
        Modelica.Blocks.Interfaces.RealInput u4
                     "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-180,-104},{-140,-64}})));
        Modelica.Blocks.Interfaces.RealOutput OUT1
          annotation (Placement(transformation(extent={{140,50},{160,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT3
          annotation (Placement(transformation(extent={{140,10},{160,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT2
          annotation (Placement(transformation(extent={{140,30},{160,50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT4
          annotation (Placement(transformation(extent={{140,-10},{160,10}})));
      equation

         OUT1 = G2.gen.PMECH;
      //   OUT2 = G2.gen.delta;
         OUT2 = G2.gen.Q;
      //   OUT4 = G2.gen.PSIkd;
      //   OUT5 = G2.gen.PSIppq;
      //   OUT6 = G2.sEXSMPC.simpleLagLim.state;
      //   OUT7 = G2.sEXSMPC.leadLag.TF.x[1];
      //   OUT8 = G2.gASTMPC.simpleLagLim.state;
      //   OUT9 = G2.gASTMPC.simpleLag.state;
      //   OUT10 = G2.gASTMPC.simpleLag1.state;
      //   OUT11 = BESS.rEGCA1_1.simpleLag.state;
      //   OUT12 = BESS.rEGCA1_1.integrator.y;
      //   OUT13 = BESS.rEGCA1_1.integrator1.y;
      //   OUT14 = BESS.rEECCU1_Local_V_Control.integrator3.y;
      //   OUT15 = BESS.rEECCU1_Local_V_Control.integrator1.y;
      //   OUT16 = BESS.rEECCU1_Local_V_Control.simpleLag.state;
      //   OUT17 = BESS.rEECCU1_Local_V_Control.integrator2.y;
      //   OUT18 = BESS.rEECCU1_Local_V_Control.simpleLag2.state;
        OUT3  = BESS.rEGCA1_1.Qgen;
         OUT4 = BESS.rEGCA1_1.Pgen;
      //   OUT21 = G2.gen.PMECH;
      //   OUT22 = G2.sEXSMPC.EFD;
         //OUT23 = Bus5.v;
         //OUT24 = Bus5.angle;

        connect(T1.p, Bus2.p)
          annotation (Line(points={{-51.2,80},{-40,80}}, color={0,0,255}));
        connect(Bus1.p, T1.n)
          annotation (Line(points={{-80,80},{-68.8,80}}, color={0,0,255}));
        connect(G1.conn, Bus1.p)
          annotation (Line(points={{-91,80},{-80,80}}, color={0,0,255}));
        connect(L1.n, Bus3.p)
          annotation (Line(points={{-14.6,80},{0,80}}, color={0,0,255}));
        connect(L1.p, Bus2.p)
          annotation (Line(points={{-25.4,80},{-40,80}}, color={0,0,255}));
        connect(L2_2.n, Bus4.p) annotation (Line(points={{35.4,70},{44,70},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.n, Bus4.p) annotation (Line(points={{35.4,90},{44,90},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.p, Bus3.p) annotation (Line(points={{24.6,90},{16,90},{16,80},{0,
                80}}, color={0,0,255}));
        connect(L2_2.p, Bus3.p) annotation (Line(points={{24.6,70},{16,70},{16,80},{0,
                80}}, color={0,0,255}));
        connect(Load1.p, Bus3.p)
          annotation (Line(points={{-10,68},{-10,80},{0,80}}, color={0,0,255}));
        connect(L3.p, Bus4.p)
          annotation (Line(points={{80,65.4},{80,80},{60,80}}, color={0,0,255}));
        connect(breaker.s, Bus5.p)
          annotation (Line(points={{80,22},{80,16}},color={0,0,255}));
        connect(breaker.r, L3.n)
          annotation (Line(points={{80,30},{80,54.6}},color={0,0,255}));
        connect(IN11.y, AddU1.u2) annotation (Line(points={{-95.4,4},{-82,4}},
                            color={0,0,127}));
        connect(T2.p, Bus5.p) annotation (Line(points={{51,10},{80,10},{80,16}},
              color={0,0,255}));

        connect(IN22.y,AddU2. u2) annotation (Line(points={{-95.4,-26},{-82,-26}},
                       color={0,0,127}));
        connect(AddU2.y, G2.Efd_ref)
          annotation (Line(points={{-59,-20},{-52,-20},{-52,4},{-42,4}},
                                                                 color={0,0,127}));
        connect(AddU1.y, G2.P_ref1) annotation (Line(points={{-59,10},{-52,10},{-52,16},
                {-42,16}},                          color={0,0,127}));
        connect(IB.p, Bus4.p)
          annotation (Line(points={{100,80},{60,80}}, color={0,0,255}));
        connect(Load2.p, Bus5.p) annotation (Line(points={{110,-10},{110,10},{80,10},{
                80,16}},
                     color={0,0,255}));
        connect(sine.y, add.u2) annotation (Line(points={{82.3,-23},{82.3,-24},{85.2,-24},
                {85.2,-16.4}}, color={0,0,127}));
        connect(whiteNoiseInjection.y, add.u1) annotation (Line(points={{82.27,-11.03},
                {82.27,-11.6},{85.2,-11.6}}, color={0,0,127}));
        connect(add.y, Load2.u) annotation (Line(points={{94.4,-14},{94.4,-14.5},{101.9,
                -14.5}}, color={0,0,127}));
        connect(T3.n, Bus7.p) annotation (Line(points={{60,-31},{60,-76},{0,-76}},
                       color={0,0,255}));
        connect(T3.p, Bus5.p) annotation (Line(points={{60,-9},{60,10},{80,10},{80,16}},
              color={0,0,255}));
        connect(Bus6.p, T2.n)
          annotation (Line(points={{4.996e-16,10},{29,10}},
                                                  color={0,0,255}));
        connect(IN33.y,AddU3. u2)
          annotation (Line(points={{-95.4,-56},{-82,-56}}, color={0,0,127}));
        connect(G2.conn, Bus6.p) annotation (Line(points={{-19,10},{4.996e-16,10}},
                                           color={0,0,255}));
        connect(BESS.p1, Bus7.p)
          annotation (Line(points={{-20,-76},{4.996e-16,-76}}, color={0,0,255}));
        connect(AddU3.y, BESS.Pinput) annotation (Line(points={{-59,-50},{-50,-50},{-50,
                -70},{-42,-70}}, color={0,0,127}));
        connect(IN44.y, AddU4.u2)
          annotation (Line(points={{-95.4,-96},{-82,-96}}, color={0,0,127}));
        connect(AddU4.y, BESS.Vinput) annotation (Line(points={{-59,-90},{-52,-90},{-52,
                -82},{-42,-82}}, color={0,0,127}));
        connect(AddU1.u1, u1)
          annotation (Line(points={{-82,16},{-160,16}}, color={0,0,127}));
        connect(AddU2.u1, u2)
          annotation (Line(points={{-82,-14},{-160,-14}}, color={0,0,127}));
        connect(AddU3.u1, u3)
          annotation (Line(points={{-82,-44},{-160,-44}}, color={0,0,127}));
        connect(AddU4.u1, u4)
          annotation (Line(points={{-82,-84},{-160,-84}}, color={0,0,127}));
          annotation (Placement(transformation(extent={{140,-20},{160,0}})),
                      Placement(transformation(extent={{140,-40},{160,-20}})),
                      Placement(transformation(extent={{140,-60},{160,-40}})),
                      Placement(transformation(extent={{140,-80},{160,-60}})),
                     Diagram(coordinateSystem(preserveAspectRatio=false,
                extent={{-140,-140},{140,140}}), graphics={
              Rectangle(
                extent={{-128,36},{124,-124}},
                lineColor={238,46,47},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,98},{124,38}},
                lineColor={0,128,255},
                lineThickness=0.5),
              Polygon(
                points={{-124,30},{-124,-120},{72,-120},{72,-50},{0,30},{-124,30}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Text(
                extent={{78,-106},{114,-120}},
                textColor={238,46,47},
                textString="Microgrid"),
              Text(
                extent={{84,56},{120,34}},
                textColor={28,108,200},
                textString="Utility Grid"),
              Text(
                extent={{6,-102},{70,-124}},
                textColor={0,140,72},
                textString="Linearization Unit")}),
          Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),experiment(StopTime=50, __Dymola_Algorithm="Dassl"),
          Icon(coordinateSystem(extent={{-140,-140},{140,140}})));
      end MPCMicrogridGasBESS_02_rootlocus2;

      model MPCMicrogridGasBESS_02_rootlocus
        "Microgrid with G2 and PV on Local V Control"
        extends Modelica.Icons.Example;

        parameter Boolean equivalentGRID = true;
        parameter Boolean equivalentsystem = false;

        OpenIPSL.Electrical.Buses.Bus Bus1(v_0=powerFlow.powerflow.bus.V1, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-90,70},{-70,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus2(v_0=powerFlow.powerflow.bus.V2, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-50,70},{-30,90}})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
          R=0.001,
          X=0.2,
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000)  if not equivalentGRID annotation (Placement(transformation(
              extent={{-8,-8},{8,8}},
              rotation=180,
              origin={-60,80})));
        OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
          enableV_b=true,
          v_0=powerFlow.powerflow.bus.V1,
          angle_0=powerFlow.powerflow.bus.A1,
          P_0=powerFlow.powerflow.machines.PG1,
          Q_0=powerFlow.powerflow.machines.QG1,
          V_b=6000)  if not equivalentGRID
          annotation (Placement(transformation(extent={{-112,70},{-92,90}})));
        OpenIPSL.Electrical.Branches.PwLine L1(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{-26,76},
                  {-14,84}})));
        OpenIPSL.Electrical.Buses.Bus Bus3(v_0=powerFlow.powerflow.bus.V3, angle_0=
              powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-10,70},{10,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus4(v_0=powerFlow.powerflow.bus.V4, angle_0=
              powerFlow.powerflow.bus.V4) if not equivalentGRID
          annotation (Placement(transformation(extent={{50,70},{70,90}})));
        OpenIPSL.Electrical.Branches.PwLine L2_1(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,86},
                  {36,94}})));
        OpenIPSL.Electrical.Branches.PwLine L2_2(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,66},
                  {36,74}})));
        OpenIPSL.Electrical.Buses.Bus Bus5(angle_0=powerFlow.powerflow.bus.A5, v_0=
              powerFlow.powerflow.bus.V5)  annotation (Placement(
              transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={80,16})));
        OpenIPSL.Electrical.Branches.PwLine L3(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=-90,
              origin={80,60})));
        OpenIPSL.Electrical.Buses.Bus Bus6(v_0=powerFlow.powerflow.bus.V6, angle_0=
              powerFlow.powerflow.bus.A6) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={0,10})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000,
          R=0.005,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={40,10})));
        GenerationUnits.PSSE.G2_16MVA                         G2(
          enableV_b=true,
          enableP_0=true,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V6,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A6,
          V_b=6000,
          P_0=powerFlow.powerflow.machines.PG2,
          Q_0=powerFlow.powerflow.machines.QG2,
          enableangle_0=true)
                        annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-30,10})));
        inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000, fn=60)
          annotation (Placement(transformation(extent={{-128,104},{-74,124}})));
        OpenIPSL.Electrical.Loads.PSSE.Load Load1(
          V_b=220000,
          P_0=powerFlow.powerflow.loads.PL1,
          Q_0=powerFlow.powerflow.loads.QL1,
          v_0=powerFlow.powerflow.bus.V3,
          angle_0=powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-20,48},{0,68}})));
        Electrical.Events.Breaker breaker(enableTrigger=false,
          t_o=1.01,
          rc_enabled=true,
          t_rc=800.01)      if not equivalentGRID                     annotation (Placement(transformation(
              extent={{-4,-4},{4,4}},
              rotation=90,
              origin={80,26})));

        Modelica.Blocks.Sources.Constant IN11(k=0)
          annotation (Placement(transformation(extent={{-108,-2},{-96,10}})));
        Modelica.Blocks.Math.Add AddU1
          annotation (Placement(transformation(extent={{-80,0},{-60,20}})));
        Modelica.Blocks.Sources.Constant IN22(k=0)
          annotation (Placement(transformation(extent={{-108,-32},{-96,-20}})));
        Modelica.Blocks.Math.Add AddU2
          annotation (Placement(transformation(extent={{-80,-30},{-60,-10}})));

        PFData.PowerFlow powerFlow(redeclare record PowerFlow =
              OpenIPSL.Examples.ModelPredictiveControl.PFData.PF15)
          annotation (Placement(transformation(extent={{-68,104},{-48,124}})));
        Electrical.Machines.PSSE.GENCLS IB(
          V_b=220000,
          v_0=powerFlow.powerflow.bus.V4,
          angle_0=powerFlow.powerflow.bus.A4,
          P_0=powerFlow.powerflow.machines.Pinf,
          Q_0=powerFlow.powerflow.machines.Qinf,
          M_b=100000000,
          X_d=1) if not equivalentGRID annotation (Placement(transformation(extent={{110,70},
                  {100,90}})));
        Electrical.Loads.PSSE.Load_ExtInput Load2(
          P_0=powerFlow.powerflow.loads.PL2,
          Q_0=powerFlow.powerflow.loads.QL2,
          v_0=powerFlow.powerflow.bus.V5,
          angle_0=powerFlow.powerflow.bus.A5,
          d_P=0,
          t1=0,
          d_t=0)
          annotation (Placement(transformation(extent={{100,-30},{120,-10}})));
        Electrical.Loads.NoiseInjections.WhiteNoiseInjection whiteNoiseInjection(
            active_sigma=0.0000000005,
                                  samplePeriod=0.02)
          annotation (Placement(transformation(extent={{76,-14},{82,-8}})));

        inner Modelica.Blocks.Noise.GlobalSeed globalSeed(useAutomaticSeed=false,
            fixedSeed=10000)
          annotation (Placement(transformation(extent={{-42,102},{-22,122}})));
        Modelica.Blocks.Sources.Sine sine(
          amplitude=0,
          f=1/260,
          phase=3.1415926535898,
          startTime=1000)
          annotation (Placement(transformation(extent={{76,-26},{82,-20}})));
        Modelica.Blocks.Math.Add add
          annotation (Placement(transformation(extent={{86,-18},{94,-10}})));

        Electrical.Buses.Bus          Bus7(v_0=powerFlow.powerflow.bus.V7, angle_0=
              powerFlow.powerflow.bus.A7) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={0,-76})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T3(
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.05) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=270,
              origin={60,-20})));
        Modelica.Blocks.Math.Add AddU3
          annotation (Placement(transformation(extent={{-80,-60},{-60,-40}})));
        Modelica.Blocks.Sources.Constant IN33(k=0)
          annotation (Placement(transformation(extent={{-108,-62},{-96,-50}})));

        GenerationUnits.PSSE.Battery_Units.BESSMPCLocalVControl BESS(
          V_base=480,
          V_b(displayUnit="kV") = 480,
          enableV_b=true,
          P_0=powerFlow.powerflow.machines.PBESS,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QBESS,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V7,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A7,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-86},{-20,-66}})));
        Modelica.Blocks.Sources.Constant IN44(k=0)
          annotation (Placement(transformation(extent={{-108,-102},{-96,-90}})));
        Modelica.Blocks.Math.Add AddU4
          annotation (Placement(transformation(extent={{-80,-100},{-60,-80}})));
      equation


        connect(T1.p, Bus2.p)
          annotation (Line(points={{-51.2,80},{-40,80}}, color={0,0,255}));
        connect(Bus1.p, T1.n)
          annotation (Line(points={{-80,80},{-68.8,80}}, color={0,0,255}));
        connect(G1.conn, Bus1.p)
          annotation (Line(points={{-91,80},{-80,80}}, color={0,0,255}));
        connect(L1.n, Bus3.p)
          annotation (Line(points={{-14.6,80},{0,80}}, color={0,0,255}));
        connect(L1.p, Bus2.p)
          annotation (Line(points={{-25.4,80},{-40,80}}, color={0,0,255}));
        connect(L2_2.n, Bus4.p) annotation (Line(points={{35.4,70},{44,70},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.n, Bus4.p) annotation (Line(points={{35.4,90},{44,90},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.p, Bus3.p) annotation (Line(points={{24.6,90},{16,90},{16,80},{0,
                80}}, color={0,0,255}));
        connect(L2_2.p, Bus3.p) annotation (Line(points={{24.6,70},{16,70},{16,80},{0,
                80}}, color={0,0,255}));
        connect(Load1.p, Bus3.p)
          annotation (Line(points={{-10,68},{-10,80},{0,80}}, color={0,0,255}));
        connect(L3.p, Bus4.p)
          annotation (Line(points={{80,65.4},{80,80},{60,80}}, color={0,0,255}));
        connect(breaker.s, Bus5.p)
          annotation (Line(points={{80,22},{80,16}},color={0,0,255}));
        connect(breaker.r, L3.n)
          annotation (Line(points={{80,30},{80,54.6}},color={0,0,255}));
        connect(IN11.y, AddU1.u2) annotation (Line(points={{-95.4,4},{-82,4}},
                            color={0,0,127}));
        connect(T2.p, Bus5.p) annotation (Line(points={{51,10},{80,10},{80,16}},
              color={0,0,255}));

        connect(IN22.y,AddU2. u2) annotation (Line(points={{-95.4,-26},{-82,-26}},
                       color={0,0,127}));
        connect(AddU2.y, G2.Efd_ref)
          annotation (Line(points={{-59,-20},{-52,-20},{-52,4},{-42,4}},
                                                                 color={0,0,127}));
        connect(AddU1.y, G2.P_ref1) annotation (Line(points={{-59,10},{-52,10},{-52,16},
                {-42,16}},                          color={0,0,127}));
        connect(IB.p, Bus4.p)
          annotation (Line(points={{100,80},{60,80}}, color={0,0,255}));
        connect(Load2.p, Bus5.p) annotation (Line(points={{110,-10},{110,10},{80,10},{
                80,16}},
                     color={0,0,255}));
        connect(sine.y, add.u2) annotation (Line(points={{82.3,-23},{82.3,-24},{85.2,-24},
                {85.2,-16.4}}, color={0,0,127}));
        connect(whiteNoiseInjection.y, add.u1) annotation (Line(points={{82.27,-11.03},
                {82.27,-11.6},{85.2,-11.6}}, color={0,0,127}));
        connect(add.y, Load2.u) annotation (Line(points={{94.4,-14},{94.4,-14.5},{101.9,
                -14.5}}, color={0,0,127}));
        connect(T3.n, Bus7.p) annotation (Line(points={{60,-31},{60,-76},{0,-76}},
                       color={0,0,255}));
        connect(T3.p, Bus5.p) annotation (Line(points={{60,-9},{60,10},{80,10},{80,16}},
              color={0,0,255}));
        connect(Bus6.p, T2.n)
          annotation (Line(points={{4.996e-16,10},{29,10}},
                                                  color={0,0,255}));
        connect(IN33.y,AddU3. u2)
          annotation (Line(points={{-95.4,-56},{-82,-56}}, color={0,0,127}));
        connect(G2.conn, Bus6.p) annotation (Line(points={{-19,10},{4.996e-16,10}},
                                           color={0,0,255}));
        connect(BESS.p1, Bus7.p)
          annotation (Line(points={{-20,-76},{4.996e-16,-76}}, color={0,0,255}));
        connect(AddU3.y, BESS.Pinput) annotation (Line(points={{-59,-50},{-50,-50},{-50,
                -70},{-42,-70}}, color={0,0,127}));
        connect(IN44.y, AddU4.u2)
          annotation (Line(points={{-95.4,-96},{-82,-96}}, color={0,0,127}));
        connect(AddU4.y, BESS.Vinput) annotation (Line(points={{-59,-90},{-52,-90},{-52,
                -82},{-42,-82}}, color={0,0,127}));
        connect(AddU1.u1, AddU1.u2) annotation (Line(points={{-82,16},{-86,16},{-86,4},
                {-82,4}}, color={0,0,127}));
        connect(AddU2.u1, AddU2.u2) annotation (Line(points={{-82,-14},{-86,-14},{-86,
                -26},{-82,-26}}, color={0,0,127}));
        connect(AddU3.u1, AddU3.u2) annotation (Line(points={{-82,-44},{-86,-44},{-86,
                -56},{-82,-56}}, color={0,0,127}));
        connect(AddU4.u1, AddU4.u2) annotation (Line(points={{-82,-84},{-86,-84},{-86,
                -96},{-82,-96}}, color={0,0,127}));
          annotation (Placement(transformation(extent={{140,-20},{160,0}})),
                      Placement(transformation(extent={{140,-40},{160,-20}})),
                      Placement(transformation(extent={{140,-60},{160,-40}})),
                      Placement(transformation(extent={{140,-80},{160,-60}})),
                     Diagram(coordinateSystem(preserveAspectRatio=false,
                extent={{-140,-140},{140,140}}), graphics={
              Rectangle(
                extent={{-128,36},{124,-124}},
                lineColor={238,46,47},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,98},{124,38}},
                lineColor={0,128,255},
                lineThickness=0.5),
              Polygon(
                points={{-124,30},{-124,-120},{72,-120},{72,-50},{0,30},{-124,30}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Text(
                extent={{78,-106},{114,-120}},
                textColor={238,46,47},
                textString="Microgrid"),
              Text(
                extent={{84,56},{120,34}},
                textColor={28,108,200},
                textString="Utility Grid"),
              Text(
                extent={{6,-102},{70,-124}},
                textColor={0,140,72},
                textString="Linearization Unit")}),
          Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),experiment(StopTime=50, __Dymola_Algorithm="Dassl"),
          Icon(coordinateSystem(extent={{-140,-140},{140,140}})));
      end MPCMicrogridGasBESS_02_rootlocus;

      model MPCMicrogridGasBESS_022
        "Microgrid with G2 and PV on Local V Control"
        extends Modelica.Icons.Example;

        parameter Boolean equivalentGRID = true;
        parameter Boolean equivalentsystem = false;

        OpenIPSL.Electrical.Buses.Bus Bus1(v_0=powerFlow.powerflow.bus.V1, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-90,70},{-70,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus2(v_0=powerFlow.powerflow.bus.V2, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-50,70},{-30,90}})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
          R=0.001,
          X=0.2,
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000)  if not equivalentGRID annotation (Placement(transformation(
              extent={{-8,-8},{8,8}},
              rotation=180,
              origin={-60,80})));
        OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
          enableV_b=true,
          v_0=powerFlow.powerflow.bus.V1,
          angle_0=powerFlow.powerflow.bus.A1,
          P_0=powerFlow.powerflow.machines.PG1,
          Q_0=powerFlow.powerflow.machines.QG1,
          V_b=6000)  if not equivalentGRID
          annotation (Placement(transformation(extent={{-112,70},{-92,90}})));
        OpenIPSL.Electrical.Branches.PwLine L1(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{-26,76},
                  {-14,84}})));
        OpenIPSL.Electrical.Buses.Bus Bus3(v_0=powerFlow.powerflow.bus.V3, angle_0=
              powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-10,70},{10,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus4(v_0=powerFlow.powerflow.bus.V4, angle_0=
              powerFlow.powerflow.bus.V4) if not equivalentGRID
          annotation (Placement(transformation(extent={{50,70},{70,90}})));
        OpenIPSL.Electrical.Branches.PwLine L2_1(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,86},
                  {36,94}})));
        OpenIPSL.Electrical.Branches.PwLine L2_2(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,66},
                  {36,74}})));
        OpenIPSL.Electrical.Buses.Bus Bus5(angle_0=powerFlow.powerflow.bus.A5, v_0=
              powerFlow.powerflow.bus.V5)  annotation (Placement(
              transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={80,16})));
        OpenIPSL.Electrical.Branches.PwLine L3(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=-90,
              origin={80,60})));
        OpenIPSL.Electrical.Buses.Bus Bus6(v_0=powerFlow.powerflow.bus.V6, angle_0=
              powerFlow.powerflow.bus.A6) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={0,10})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000,
          R=0.005,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={40,10})));
        GenerationUnits.PSSE.G2_16MVA                         G2(
          enableV_b=true,
          enableP_0=true,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V6,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A6,
          V_b=6000,
          P_0=powerFlow.powerflow.machines.PG2,
          Q_0=powerFlow.powerflow.machines.QG2,
          enableangle_0=true)
                        annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-30,10})));
        inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000, fn=60)
          annotation (Placement(transformation(extent={{-128,104},{-74,124}})));
        OpenIPSL.Electrical.Loads.PSSE.Load Load1(
          V_b=220000,
          P_0=powerFlow.powerflow.loads.PL1,
          Q_0=powerFlow.powerflow.loads.QL1,
          v_0=powerFlow.powerflow.bus.V3,
          angle_0=powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-20,48},{0,68}})));
        Electrical.Events.Breaker breaker(enableTrigger=false,
          t_o=1.01,
          rc_enabled=true,
          t_rc=800.01)      if not equivalentGRID                     annotation (Placement(transformation(
              extent={{-4,-4},{4,4}},
              rotation=90,
              origin={80,26})));

        Modelica.Blocks.Interfaces.RealInput IN1(start=0)
          "Connector of Real input signal 2" annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-150,14}),iconTransformation(extent={{-10,-10},{10,10}}, origin={-150,14})));
        Modelica.Blocks.Sources.Constant IN11(k=0)
          annotation (Placement(transformation(extent={{-108,-2},{-96,10}})));
        Modelica.Blocks.Math.Add AddU1
          annotation (Placement(transformation(extent={{-80,0},{-60,20}})));
        Modelica.Blocks.Sources.Constant IN22(k=0)
          annotation (Placement(transformation(extent={{-108,-32},{-96,-20}})));
        Modelica.Blocks.Math.Add AddU2
          annotation (Placement(transformation(extent={{-80,-30},{-60,-10}})));
        Modelica.Blocks.Interfaces.RealInput IN2(start=0)
          "Connector of Real input signal 2"
                 annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-150,-8}),  iconTransformation(extent={{-10,-10},{10,10}},
                origin={-150,-8})));
        Modelica.Blocks.Interfaces.RealInput IN3(start = 0) "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-40},{-140,-20}}),
              iconTransformation(extent={{-160,-40},{-140,-20}})));

        Modelica.Blocks.Interfaces.RealOutput OUT1
          annotation (Placement(transformation(extent={{140,70},{160,90}})));

        PFData.PowerFlow powerFlow(redeclare record PowerFlow =
              OpenIPSL.Examples.ModelPredictiveControl.PFData.PF15)
          annotation (Placement(transformation(extent={{-68,104},{-48,124}})));
        Electrical.Machines.PSSE.GENCLS IB(
          V_b=220000,
          v_0=powerFlow.powerflow.bus.V4,
          angle_0=powerFlow.powerflow.bus.A4,
          P_0=powerFlow.powerflow.machines.Pinf,
          Q_0=powerFlow.powerflow.machines.Qinf,
          M_b=100000000,
          X_d=1) if not equivalentGRID annotation (Placement(transformation(extent={{110,70},
                  {100,90}})));
        Electrical.Loads.PSSE.Load_ExtInput Load2(
          P_0=powerFlow.powerflow.loads.PL2,
          Q_0=powerFlow.powerflow.loads.QL2,
          v_0=powerFlow.powerflow.bus.V5,
          angle_0=powerFlow.powerflow.bus.A5,
          d_P=0,
          t1=0,
          d_t=0)
          annotation (Placement(transformation(extent={{100,-30},{120,-10}})));
        Electrical.Loads.NoiseInjections.WhiteNoiseInjection whiteNoiseInjection(
            active_sigma=0.0000000005,
                                  samplePeriod=0.02)
          annotation (Placement(transformation(extent={{76,-14},{82,-8}})));

        inner Modelica.Blocks.Noise.GlobalSeed globalSeed(useAutomaticSeed=false,
            fixedSeed=10000)
          annotation (Placement(transformation(extent={{-42,102},{-22,122}})));
        Modelica.Blocks.Sources.Sine sine(
          amplitude=0,
          f=1/260,
          phase=3.1415926535898,
          startTime=1000)
          annotation (Placement(transformation(extent={{76,-26},{82,-20}})));
        Modelica.Blocks.Math.Add add
          annotation (Placement(transformation(extent={{86,-18},{94,-10}})));

        Electrical.Buses.Bus          Bus7(v_0=powerFlow.powerflow.bus.V7, angle_0=
              powerFlow.powerflow.bus.A7) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={0,-76})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T3(
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.05) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=270,
              origin={60,-20})));
        Modelica.Blocks.Math.Add AddU3
          annotation (Placement(transformation(extent={{-80,-60},{-60,-40}})));
        Modelica.Blocks.Sources.Constant IN33(k=0)
          annotation (Placement(transformation(extent={{-108,-62},{-96,-50}})));

        GenerationUnits.PSSE.Battery_Units.BESSMPCLocalVControl BESS(
          V_base=480,
          V_b(displayUnit="kV") = 480,
          enableV_b=true,
          P_0=powerFlow.powerflow.machines.PBESS,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QBESS,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V7,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A7,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-86},{-20,-66}})));
        Modelica.Blocks.Sources.Constant IN44(k=0)
          annotation (Placement(transformation(extent={{-108,-102},{-96,-90}})));
        Modelica.Blocks.Math.Add AddU4
          annotation (Placement(transformation(extent={{-80,-100},{-60,-80}})));
        Modelica.Blocks.Interfaces.RealInput IN4 "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-60},{-140,-40}}),
              iconTransformation(extent={{-160,-60},{-140,-40}})));
                Modelica.Blocks.Interfaces.RealOutput OUT21
          annotation (Placement(transformation(extent={{140,40},{160,60}})));
        Modelica.Blocks.Interfaces.RealOutput OUT22
          annotation (Placement(transformation(extent={{140,20},{160,40}})));
        Modelica.Blocks.Interfaces.RealOutput OUT25
          annotation (Placement(transformation(extent={{140,0},{160,20}})));
        Modelica.Blocks.Interfaces.RealOutput OUT26
          annotation (Placement(transformation(extent={{140,-20},{160,0}})));

      equation

        OUT1 = G2.gen.w;
      //   OUT2 = G2.gen.delta;
      //   OUT3 = G2.gen.Epq;
      //   OUT4 = G2.gen.PSIkd;
      //   OUT5 = G2.gen.PSIppq;
      //   OUT6 = G2.sEXSMPC.simpleLagLim.state;
      //   OUT7 = G2.sEXSMPC.leadLag.TF.x[1];
      //   OUT8 = G2.gASTMPC.simpleLagLim.state;
      //   OUT9 = G2.gASTMPC.simpleLag.state;
      //   OUT10 = G2.gASTMPC.simpleLag1.state;
      //   OUT11 = BESS.rEGCA1_1.simpleLag.state;
      //   OUT12 = BESS.rEGCA1_1.integrator.y;
      //   OUT13 = BESS.rEGCA1_1.integrator1.y;
      //   OUT14 = BESS.rEECCU1_Local_V_Control.integrator3.y;
      //   OUT15 = BESS.rEECCU1_Local_V_Control.integrator1.y;
      //   OUT16 = BESS.rEECCU1_Local_V_Control.simpleLag.state;
      //   OUT17 =BESS.rEECCU1_Local_V_Control.IGQ.y;
      //   OUT18 = BESS.rEECCU1_Local_V_Control.simpleLag2.state;
      //   OUT19 =BESS.rEECCU1_Local_V_Control.IGP.y;
      //   OUT20 = BESS.rEECCU1_Local_V_Control.simpleLag1.state;
      OUT21 = BESS.rEGCA1_1.Qgen;
      OUT22 = BESS.rEGCA1_1.Pgen;
      //   OUT23 = G2.gen.PMECH;
      //   OUT24 = G2.sEXSMPC.EFD;
        OUT25 = Bus5.v;
        OUT26 = Bus5.angle;

        connect(T1.p, Bus2.p)
          annotation (Line(points={{-51.2,80},{-40,80}}, color={0,0,255}));
        connect(Bus1.p, T1.n)
          annotation (Line(points={{-80,80},{-68.8,80}}, color={0,0,255}));
        connect(G1.conn, Bus1.p)
          annotation (Line(points={{-91,80},{-80,80}}, color={0,0,255}));
        connect(L1.n, Bus3.p)
          annotation (Line(points={{-14.6,80},{0,80}}, color={0,0,255}));
        connect(L1.p, Bus2.p)
          annotation (Line(points={{-25.4,80},{-40,80}}, color={0,0,255}));
        connect(L2_2.n, Bus4.p) annotation (Line(points={{35.4,70},{44,70},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.n, Bus4.p) annotation (Line(points={{35.4,90},{44,90},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.p, Bus3.p) annotation (Line(points={{24.6,90},{16,90},{16,80},{0,
                80}}, color={0,0,255}));
        connect(L2_2.p, Bus3.p) annotation (Line(points={{24.6,70},{16,70},{16,80},{0,
                80}}, color={0,0,255}));
        connect(Load1.p, Bus3.p)
          annotation (Line(points={{-10,68},{-10,80},{0,80}}, color={0,0,255}));
        connect(L3.p, Bus4.p)
          annotation (Line(points={{80,65.4},{80,80},{60,80}}, color={0,0,255}));
        connect(breaker.s, Bus5.p)
          annotation (Line(points={{80,22},{80,16}},color={0,0,255}));
        connect(breaker.r, L3.n)
          annotation (Line(points={{80,30},{80,54.6}},color={0,0,255}));
        connect(IN11.y, AddU1.u2) annotation (Line(points={{-95.4,4},{-82,4}},
                            color={0,0,127}));
        connect(IN1, AddU1.u1) annotation (Line(points={{-150,14},{-116,14},{-116,16},
                {-82,16}},
                       color={0,0,127}));
        connect(T2.p, Bus5.p) annotation (Line(points={{51,10},{80,10},{80,16}},
              color={0,0,255}));

        connect(IN22.y,AddU2. u2) annotation (Line(points={{-95.4,-26},{-82,-26}},
                       color={0,0,127}));
        connect(IN2,AddU2. u1) annotation (Line(points={{-150,-8},{-118,-8},{-118,-14},
                {-82,-14}},
                       color={0,0,127}));
        connect(AddU2.y, G2.Efd_ref)
          annotation (Line(points={{-59,-20},{-52,-20},{-52,4},{-42,4}},
                                                                 color={0,0,127}));
        connect(AddU1.y, G2.P_ref1) annotation (Line(points={{-59,10},{-52,10},{-52,16},
                {-42,16}},                          color={0,0,127}));
        connect(IB.p, Bus4.p)
          annotation (Line(points={{100,80},{60,80}}, color={0,0,255}));
        connect(Load2.p, Bus5.p) annotation (Line(points={{110,-10},{110,10},{80,10},{
                80,16}},
                     color={0,0,255}));
        connect(sine.y, add.u2) annotation (Line(points={{82.3,-23},{82.3,-24},{85.2,-24},
                {85.2,-16.4}}, color={0,0,127}));
        connect(whiteNoiseInjection.y, add.u1) annotation (Line(points={{82.27,-11.03},
                {82.27,-11.6},{85.2,-11.6}}, color={0,0,127}));
        connect(add.y, Load2.u) annotation (Line(points={{94.4,-14},{94.4,-14.5},{101.9,
                -14.5}}, color={0,0,127}));
        connect(T3.n, Bus7.p) annotation (Line(points={{60,-31},{60,-76},{0,-76}},
                       color={0,0,255}));
        connect(T3.p, Bus5.p) annotation (Line(points={{60,-9},{60,10},{80,10},{80,16}},
              color={0,0,255}));
        connect(Bus6.p, T2.n)
          annotation (Line(points={{4.996e-16,10},{29,10}},
                                                  color={0,0,255}));
        connect(IN33.y,AddU3. u2)
          annotation (Line(points={{-95.4,-56},{-82,-56}}, color={0,0,127}));
        connect(IN3,AddU3. u1) annotation (Line(points={{-150,-30},{-114,-30},{-114,-44},
                {-82,-44}}, color={0,0,127}));
        connect(G2.conn, Bus6.p) annotation (Line(points={{-19,10},{4.996e-16,10}},
                                           color={0,0,255}));
        connect(BESS.p1, Bus7.p)
          annotation (Line(points={{-20,-76},{4.996e-16,-76}}, color={0,0,255}));
        connect(AddU3.y, BESS.Pinput) annotation (Line(points={{-59,-50},{-50,-50},{-50,
                -70},{-42,-70}}, color={0,0,127}));
        connect(IN44.y, AddU4.u2)
          annotation (Line(points={{-95.4,-96},{-82,-96}}, color={0,0,127}));
        connect(AddU4.u1, IN4) annotation (Line(points={{-82,-84},{-120,-84},{-120,-50},
                {-150,-50}}, color={0,0,127}));
        connect(AddU4.y, BESS.Vinput) annotation (Line(points={{-59,-90},{-52,-90},{-52,
                -82},{-42,-82}}, color={0,0,127}));
          annotation (Placement(transformation(extent={{140,-20},{160,0}})),
                      Placement(transformation(extent={{140,-40},{160,-20}})),
                      Placement(transformation(extent={{140,-60},{160,-40}})),
                      Placement(transformation(extent={{140,-80},{160,-60}})),
                     Diagram(coordinateSystem(preserveAspectRatio=false,
                extent={{-140,-140},{140,140}}), graphics={
              Rectangle(
                extent={{-160,30},{-136,-60}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,36},{124,-124}},
                lineColor={238,46,47},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,98},{124,38}},
                lineColor={0,128,255},
                lineThickness=0.5),
              Polygon(
                points={{-124,30},{-124,-120},{72,-120},{72,-50},{0,30},{-124,30}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Text(
                extent={{78,-106},{114,-120}},
                textColor={238,46,47},
                textString="Microgrid"),
              Text(
                extent={{76,58},{128,34}},
                textColor={28,108,200},
                textString="Utility Grid"),
              Text(
                extent={{6,-102},{70,-124}},
                textColor={0,140,72},
                textString="Linearization Unit"),
              Text(
                extent={{-164,50},{-132,30}},
                textColor={0,140,72},
                textString="Inputs"),
              Text(
                extent={{128,118},{168,98}},
                textColor={0,140,72},
                textString="Outputs")}),
          Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),experiment(StopTime=50, __Dymola_Algorithm="Dassl"),
          Icon(coordinateSystem(extent={{-140,-140},{140,140}})));
      end MPCMicrogridGasBESS_022;

      model MPCMicrogridGasBESS_03
        "Microgrid with G2 and PV on Local V Control"
        extends Modelica.Icons.Example;

        parameter Boolean equivalentGRID = false;
        parameter Boolean equivalentsystem = false;

        OpenIPSL.Electrical.Buses.Bus Bus1(v_0=powerFlow.powerflow.bus.V1, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-90,70},{-70,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus2(v_0=powerFlow.powerflow.bus.V2, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-50,70},{-30,90}})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
          R=0.001,
          X=0.2,
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000)  if not equivalentGRID annotation (Placement(transformation(
              extent={{-8,-8},{8,8}},
              rotation=180,
              origin={-60,80})));
        OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
          enableV_b=true,
          v_0=powerFlow.powerflow.bus.V1,
          angle_0=powerFlow.powerflow.bus.A1,
          P_0=powerFlow.powerflow.machines.PG1,
          Q_0=powerFlow.powerflow.machines.QG1,
          V_b=6000)  if not equivalentGRID
          annotation (Placement(transformation(extent={{-112,70},{-92,90}})));
        OpenIPSL.Electrical.Branches.PwLine L1(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{-26,76},
                  {-14,84}})));
        OpenIPSL.Electrical.Buses.Bus Bus3(v_0=powerFlow.powerflow.bus.V3, angle_0=
              powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-10,70},{10,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus4(v_0=powerFlow.powerflow.bus.V4, angle_0=
              powerFlow.powerflow.bus.V4) if not equivalentGRID
          annotation (Placement(transformation(extent={{50,70},{70,90}})));
        OpenIPSL.Electrical.Branches.PwLine L2_1(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,86},
                  {36,94}})));
        OpenIPSL.Electrical.Branches.PwLine L2_2(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,66},
                  {36,74}})));
        OpenIPSL.Electrical.Buses.Bus Bus5(angle_0=powerFlow.powerflow.bus.A5, v_0=
              powerFlow.powerflow.bus.V5)  annotation (Placement(
              transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={80,16})));
        OpenIPSL.Electrical.Branches.PwLine L3(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=-90,
              origin={80,60})));
        OpenIPSL.Electrical.Buses.Bus Bus6(v_0=powerFlow.powerflow.bus.V6, angle_0=
              powerFlow.powerflow.bus.A6) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={0,10})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000,
          R=0.005,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={40,10})));
        GenerationUnits.PSSE.G2_16MVA                         G2(
          enableV_b=true,
          enableP_0=true,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V6,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A6,
          V_b=6000,
          P_0=powerFlow.powerflow.machines.PG2,
          Q_0=powerFlow.powerflow.machines.QG2,
          enableangle_0=true)
                        annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-30,10})));
        inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000, fn=60)
          annotation (Placement(transformation(extent={{-128,104},{-74,124}})));
        OpenIPSL.Electrical.Loads.PSSE.Load Load1(
          V_b=220000,
          P_0=powerFlow.powerflow.loads.PL1,
          Q_0=powerFlow.powerflow.loads.QL1,
          v_0=powerFlow.powerflow.bus.V3,
          angle_0=powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-20,48},{0,68}})));
        Electrical.Events.Breaker breaker(enableTrigger=false,
          t_o=1.01,
          rc_enabled=true,
          t_rc=800.01)      if not equivalentGRID                     annotation (Placement(transformation(
              extent={{-4,-4},{4,4}},
              rotation=90,
              origin={80,26})));

        Modelica.Blocks.Interfaces.RealInput IN1(start=0)
          "Connector of Real input signal 2" annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-150,14}),iconTransformation(extent={{-10,-10},{10,10}}, origin={-150,14})));
        Modelica.Blocks.Sources.Constant IN11(k=0)
          annotation (Placement(transformation(extent={{-108,-2},{-96,10}})));
        Modelica.Blocks.Math.Add AddU1
          annotation (Placement(transformation(extent={{-80,0},{-60,20}})));
        Modelica.Blocks.Sources.Constant IN22(k=0)
          annotation (Placement(transformation(extent={{-108,-32},{-96,-20}})));
        Modelica.Blocks.Math.Add AddU2
          annotation (Placement(transformation(extent={{-80,-30},{-60,-10}})));
        Modelica.Blocks.Interfaces.RealInput IN2(start=0)
          "Connector of Real input signal 2"
                 annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-150,-8}),  iconTransformation(extent={{-10,-10},{10,10}},
                origin={-150,-8})));
        Modelica.Blocks.Interfaces.RealInput IN3(start = 0) "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-40},{-140,-20}}),
              iconTransformation(extent={{-160,-40},{-140,-20}})));

        Modelica.Blocks.Interfaces.RealOutput OUT1
          annotation (Placement(transformation(extent={{140,70},{160,90}})));

        PFData.PowerFlow powerFlow(redeclare record PowerFlow =
              OpenIPSL.Examples.ModelPredictiveControl.PFData.PF15)
          annotation (Placement(transformation(extent={{-68,104},{-48,124}})));
        Electrical.Machines.PSSE.GENCLS IB(
          V_b=220000,
          v_0=powerFlow.powerflow.bus.V4,
          angle_0=powerFlow.powerflow.bus.A4,
          P_0=powerFlow.powerflow.machines.Pinf,
          Q_0=powerFlow.powerflow.machines.Qinf,
          M_b=100000000,
          X_d=1) if not equivalentGRID annotation (Placement(transformation(extent={{110,70},
                  {100,90}})));
        Electrical.Loads.PSSE.Load_ExtInput Load2(
          P_0=powerFlow.powerflow.loads.PL2,
          Q_0=powerFlow.powerflow.loads.QL2,
          v_0=powerFlow.powerflow.bus.V5,
          angle_0=powerFlow.powerflow.bus.A5,
          d_P=0,
          t1=0,
          d_t=0)
          annotation (Placement(transformation(extent={{100,-30},{120,-10}})));
        Electrical.Loads.NoiseInjections.WhiteNoiseInjection whiteNoiseInjection(
            active_sigma=0.0000000005,
                                  samplePeriod=0.02)
          annotation (Placement(transformation(extent={{76,-14},{82,-8}})));

        inner Modelica.Blocks.Noise.GlobalSeed globalSeed(useAutomaticSeed=false,
            fixedSeed=10000)
          annotation (Placement(transformation(extent={{-42,102},{-22,122}})));
        Modelica.Blocks.Sources.Sine sine(
          amplitude=0.01,
          f=1/260,
          phase=3.1415926535898,
          startTime=5.5)
          annotation (Placement(transformation(extent={{76,-26},{82,-20}})));
        Modelica.Blocks.Math.Add add
          annotation (Placement(transformation(extent={{86,-18},{94,-10}})));

        Electrical.Buses.Bus          Bus7(v_0=powerFlow.powerflow.bus.V7, angle_0=
              powerFlow.powerflow.bus.A7) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={0,-76})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T3(
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.05) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=270,
              origin={60,-20})));
        Modelica.Blocks.Math.Add AddU3
          annotation (Placement(transformation(extent={{-80,-60},{-60,-40}})));
        Modelica.Blocks.Sources.Constant IN33(k=0)
          annotation (Placement(transformation(extent={{-108,-62},{-96,-50}})));

        GenerationUnits.PSSE.Battery_Units.BESSMPCLocalVQControlLinearized
                                                                 BESS(
          V_base=480,
          V_b(displayUnit="kV") = 480,
          enableV_b=true,
          P_0=powerFlow.powerflow.machines.PBESS,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QBESS,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V7,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A7,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-86},{-20,-66}})));
        Modelica.Blocks.Sources.Constant IN44(k=0)
          annotation (Placement(transformation(extent={{-108,-102},{-96,-90}})));
        Modelica.Blocks.Math.Add AddU4
          annotation (Placement(transformation(extent={{-80,-100},{-60,-80}})));
        Modelica.Blocks.Interfaces.RealInput IN4 "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-60},{-140,-40}}),
              iconTransformation(extent={{-160,-60},{-140,-40}})));
        Modelica.Blocks.Interfaces.RealOutput OUT2
          annotation (Placement(transformation(extent={{140,40},{160,60}})));
        Modelica.Blocks.Interfaces.RealOutput OUT3
          annotation (Placement(transformation(extent={{140,20},{160,40}})));
        Modelica.Blocks.Interfaces.RealOutput OUT4
          annotation (Placement(transformation(extent={{140,-10},{160,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT5
          annotation (Placement(transformation(extent={{140,-40},{160,-20}})));
        Modelica.Blocks.Interfaces.RealOutput OUT6
          annotation (Placement(transformation(extent={{140,-70},{160,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT7
          annotation (Placement(transformation(extent={{170,70},{190,90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT8
          annotation (Placement(transformation(extent={{170,40},{190,60}})));
        Modelica.Blocks.Interfaces.RealOutput OUT9
          annotation (Placement(transformation(extent={{170,20},{190,40}})));
        Modelica.Blocks.Interfaces.RealOutput OUT10
          annotation (Placement(transformation(extent={{170,-10},{190,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT11
          annotation (Placement(transformation(extent={{170,-40},{190,-20}})));
        Modelica.Blocks.Interfaces.RealOutput OUT12
          annotation (Placement(transformation(extent={{170,-70},{190,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT13
          annotation (Placement(transformation(extent={{198,72},{218,92}})));
        Modelica.Blocks.Interfaces.RealOutput OUT14
          annotation (Placement(transformation(extent={{198,42},{218,62}})));
        Modelica.Blocks.Interfaces.RealOutput OUT15
          annotation (Placement(transformation(extent={{198,22},{218,42}})));
        Modelica.Blocks.Interfaces.RealOutput OUT16
          annotation (Placement(transformation(extent={{198,-8},{218,12}})));
        Modelica.Blocks.Interfaces.RealOutput OUT17
          annotation (Placement(transformation(extent={{198,-38},{218,-18}})));
        Modelica.Blocks.Interfaces.RealOutput OUT18
          annotation (Placement(transformation(extent={{198,-68},{218,-48}})));
        Modelica.Blocks.Interfaces.RealOutput OUT19
          annotation (Placement(transformation(extent={{232,76},{252,96}})));
        Modelica.Blocks.Interfaces.RealOutput OUT20
          annotation (Placement(transformation(extent={{232,46},{252,66}})));
        Modelica.Blocks.Interfaces.RealOutput OUT21
          annotation (Placement(transformation(extent={{232,26},{252,46}})));
        Modelica.Blocks.Interfaces.RealOutput OUT22
          annotation (Placement(transformation(extent={{232,-4},{252,16}})));
        Modelica.Blocks.Interfaces.RealOutput OUT23
          annotation (Placement(transformation(extent={{232,-34},{252,-14}})));
        Modelica.Blocks.Interfaces.RealOutput OUT24
          annotation (Placement(transformation(extent={{244,-60},{264,-40}})));
        Modelica.Blocks.Interfaces.RealOutput OUT25
          annotation (Placement(transformation(extent={{228,-80},{248,-60}})));
        Modelica.Blocks.Interfaces.RealOutput OUT26
          annotation (Placement(transformation(extent={{234,-98},{254,-78}})));
      equation

      OUT1 = G2.gen.w;
      OUT2 = G2.gen.delta;
      OUT3 = G2.gen.Epq;
      OUT4 = G2.gen.PSIkd;
      OUT5 = G2.gen.PSIppq;
      OUT6 = G2.sEXSMPC.simpleLagLim.state;
      OUT7 = G2.sEXSMPC.leadLag.TF.x_scaled[1];
      OUT8 = G2.gASTMPC.simpleLagLim.state;
      OUT9 = G2.gASTMPC.simpleLag.state;
      OUT10 = G2.gASTMPC.simpleLag1.state;
      OUT11 = BESS.rEGCA1_1.simpleLag.state;
      OUT12 = BESS.rEGCA1_1.integrator.y;
      OUT13 = BESS.rEGCA1_1.integrator1.y;
      OUT14 =BESS.EC.integrator3.y;
      OUT15 =BESS.EC.simpleLag.state;
      OUT16 =BESS.EC.IGQ.y;
      OUT17 =BESS.EC.IGV.y;
      OUT18 =BESS.EC.IGP.y;
      OUT19 =BESS.EC.simpleLag1.state;
      OUT20 =BESS.EC.simpleLag2.state;
      OUT21 =BESS.EC.simpleLag3.state;
      OUT22 =BESS.EC.simpleLag4.state;
      OUT23 = BESS.rEGCA1_1.Pgen;
      OUT24 = BESS.rEGCA1_1.Qgen;
      OUT25 = Bus5.v;
      OUT26 = Bus5.angle;

        connect(T1.p, Bus2.p)
          annotation (Line(points={{-51.2,80},{-40,80}}, color={0,0,255}));
        connect(Bus1.p, T1.n)
          annotation (Line(points={{-80,80},{-68.8,80}}, color={0,0,255}));
        connect(G1.conn, Bus1.p)
          annotation (Line(points={{-91,80},{-80,80}}, color={0,0,255}));
        connect(L1.n, Bus3.p)
          annotation (Line(points={{-14.6,80},{0,80}}, color={0,0,255}));
        connect(L1.p, Bus2.p)
          annotation (Line(points={{-25.4,80},{-40,80}}, color={0,0,255}));
        connect(L2_2.n, Bus4.p) annotation (Line(points={{35.4,70},{44,70},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.n, Bus4.p) annotation (Line(points={{35.4,90},{44,90},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.p, Bus3.p) annotation (Line(points={{24.6,90},{16,90},{16,80},{0,
                80}}, color={0,0,255}));
        connect(L2_2.p, Bus3.p) annotation (Line(points={{24.6,70},{16,70},{16,80},{0,
                80}}, color={0,0,255}));
        connect(Load1.p, Bus3.p)
          annotation (Line(points={{-10,68},{-10,80},{0,80}}, color={0,0,255}));
        connect(L3.p, Bus4.p)
          annotation (Line(points={{80,65.4},{80,80},{60,80}}, color={0,0,255}));
        connect(breaker.s, Bus5.p)
          annotation (Line(points={{80,22},{80,16}},color={0,0,255}));
        connect(breaker.r, L3.n)
          annotation (Line(points={{80,30},{80,54.6}},color={0,0,255}));
        connect(IN11.y, AddU1.u2) annotation (Line(points={{-95.4,4},{-82,4}},
                            color={0,0,127}));
        connect(IN1, AddU1.u1) annotation (Line(points={{-150,14},{-116,14},{-116,16},
                {-82,16}},
                       color={0,0,127}));
        connect(T2.p, Bus5.p) annotation (Line(points={{51,10},{80,10},{80,16}},
              color={0,0,255}));

        connect(IN22.y,AddU2. u2) annotation (Line(points={{-95.4,-26},{-82,-26}},
                       color={0,0,127}));
        connect(IN2,AddU2. u1) annotation (Line(points={{-150,-8},{-118,-8},{-118,-14},
                {-82,-14}},
                       color={0,0,127}));
        connect(AddU2.y, G2.Efd_ref)
          annotation (Line(points={{-59,-20},{-52,-20},{-52,4},{-42,4}},
                                                                 color={0,0,127}));
        connect(AddU1.y, G2.P_ref1) annotation (Line(points={{-59,10},{-52,10},{-52,16},
                {-42,16}},                          color={0,0,127}));
        connect(IB.p, Bus4.p)
          annotation (Line(points={{100,80},{60,80}}, color={0,0,255}));
        connect(Load2.p, Bus5.p) annotation (Line(points={{110,-10},{110,10},{80,10},{
                80,16}},
                     color={0,0,255}));
        connect(sine.y, add.u2) annotation (Line(points={{82.3,-23},{82.3,-24},{85.2,-24},
                {85.2,-16.4}}, color={0,0,127}));
        connect(whiteNoiseInjection.y, add.u1) annotation (Line(points={{82.27,-11.03},
                {82.27,-11.6},{85.2,-11.6}}, color={0,0,127}));
        connect(add.y, Load2.u) annotation (Line(points={{94.4,-14},{94.4,-14.5},{101.9,
                -14.5}}, color={0,0,127}));
        connect(T3.n, Bus7.p) annotation (Line(points={{60,-31},{60,-76},{0,-76}},
                       color={0,0,255}));
        connect(T3.p, Bus5.p) annotation (Line(points={{60,-9},{60,10},{80,10},{80,16}},
              color={0,0,255}));
        connect(Bus6.p, T2.n)
          annotation (Line(points={{4.996e-16,10},{29,10}},
                                                  color={0,0,255}));
        connect(IN33.y,AddU3. u2)
          annotation (Line(points={{-95.4,-56},{-82,-56}}, color={0,0,127}));
        connect(IN3,AddU3. u1) annotation (Line(points={{-150,-30},{-114,-30},{-114,-44},
                {-82,-44}}, color={0,0,127}));
        connect(G2.conn, Bus6.p) annotation (Line(points={{-19,10},{4.996e-16,10}},
                                           color={0,0,255}));
        connect(BESS.p1, Bus7.p)
          annotation (Line(points={{-20,-76},{4.996e-16,-76}}, color={0,0,255}));
        connect(IN44.y, AddU4.u2)
          annotation (Line(points={{-95.4,-96},{-82,-96}}, color={0,0,127}));
        connect(AddU4.u1, IN4) annotation (Line(points={{-82,-84},{-120,-84},{-120,-50},
                {-150,-50}}, color={0,0,127}));
        connect(AddU3.y, BESS.Paux1) annotation (Line(points={{-59,-50},{-52,-50},{-52,
                -70},{-42,-70}}, color={0,0,127}));
        connect(AddU4.y, BESS.Qext1) annotation (Line(points={{-59,-90},{-52,-90},{-52,
                -82},{-42,-82}}, color={0,0,127}));
          annotation (Placement(transformation(extent={{140,-20},{160,0}})),
                      Placement(transformation(extent={{140,-40},{160,-20}})),
                      Placement(transformation(extent={{140,-60},{160,-40}})),
                      Placement(transformation(extent={{140,-80},{160,-60}})),
                     Diagram(coordinateSystem(preserveAspectRatio=false,
                extent={{-140,-140},{140,140}}), graphics={
              Rectangle(
                extent={{-160,30},{-136,-60}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,36},{124,-124}},
                lineColor={238,46,47},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,98},{124,38}},
                lineColor={0,128,255},
                lineThickness=0.5),
              Polygon(
                points={{-124,30},{-124,-120},{72,-120},{72,-50},{0,30},{-124,30}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Text(
                extent={{78,-106},{114,-120}},
                textColor={238,46,47},
                textString="Microgrid"),
              Text(
                extent={{76,58},{128,34}},
                textColor={28,108,200},
                textString="Utility Grid"),
              Text(
                extent={{6,-102},{70,-124}},
                textColor={0,140,72},
                textString="Linearization Unit"),
              Text(
                extent={{-164,50},{-132,30}},
                textColor={0,140,72},
                textString="Inputs"),
              Text(
                extent={{128,118},{168,98}},
                textColor={0,140,72},
                textString="Outputs")}),
          Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),experiment(
            StopTime=100,
            __Dymola_NumberOfIntervals=100,
            __Dymola_Algorithm="Dassl"),
          Icon(coordinateSystem(extent={{-140,-140},{140,140}})));
      end MPCMicrogridGasBESS_03;

      model MPCMicrogridGasBESS_03_PMU
        "Microgrid with G2 and PV on Local V Control"
        extends Modelica.Icons.Example;

        parameter Boolean equivalentGRID = false;
        parameter Boolean equivalentsystem = false;

        OpenIPSL.Electrical.Buses.Bus Bus1(v_0=powerFlow.powerflow.bus.V1, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-90,70},{-70,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus2(v_0=powerFlow.powerflow.bus.V2, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-50,70},{-30,90}})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
          R=0.001,
          X=0.2,
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000)  if not equivalentGRID annotation (Placement(transformation(
              extent={{-8,-8},{8,8}},
              rotation=180,
              origin={-60,80})));
        OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
          enableV_b=true,
          v_0=powerFlow.powerflow.bus.V1,
          angle_0=powerFlow.powerflow.bus.A1,
          P_0=powerFlow.powerflow.machines.PG1,
          Q_0=powerFlow.powerflow.machines.QG1,
          V_b=6000)  if not equivalentGRID
          annotation (Placement(transformation(extent={{-112,70},{-92,90}})));
        OpenIPSL.Electrical.Branches.PwLine L1(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{-26,76},
                  {-14,84}})));
        OpenIPSL.Electrical.Buses.Bus Bus3(v_0=powerFlow.powerflow.bus.V3, angle_0=
              powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-10,70},{10,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus4(v_0=powerFlow.powerflow.bus.V4, angle_0=
              powerFlow.powerflow.bus.V4) if not equivalentGRID
          annotation (Placement(transformation(extent={{50,70},{70,90}})));
        OpenIPSL.Electrical.Branches.PwLine L2_1(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,86},
                  {36,94}})));
        OpenIPSL.Electrical.Branches.PwLine L2_2(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,66},
                  {36,74}})));
        OpenIPSL.Electrical.Buses.Bus Bus5(angle_0=powerFlow.powerflow.bus.A5, v_0=
              powerFlow.powerflow.bus.V5)  annotation (Placement(
              transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={80,16})));
        OpenIPSL.Electrical.Branches.PwLine L3(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=-90,
              origin={80,60})));
        OpenIPSL.Electrical.Buses.Bus Bus6(v_0=powerFlow.powerflow.bus.V6, angle_0=
              powerFlow.powerflow.bus.A6) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={0,10})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000,
          R=0.005,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={40,10})));
        GenerationUnits.PSSE.G2_16MVA                         G2(
          enableV_b=true,
          enableP_0=true,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V6,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A6,
          V_b=6000,
          P_0=powerFlow.powerflow.machines.PG2,
          Q_0=powerFlow.powerflow.machines.QG2,
          enableangle_0=true)
                        annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-30,10})));
        inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000, fn=60)
          annotation (Placement(transformation(extent={{-128,104},{-74,124}})));
        OpenIPSL.Electrical.Loads.PSSE.Load Load1(
          V_b=220000,
          P_0=powerFlow.powerflow.loads.PL1,
          Q_0=powerFlow.powerflow.loads.QL1,
          v_0=powerFlow.powerflow.bus.V3,
          angle_0=powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-20,48},{0,68}})));
        Electrical.Events.Breaker breaker(enableTrigger=false,
          t_o=0,
          rc_enabled=true,
          t_rc=800.01)      if not equivalentGRID                     annotation (Placement(transformation(
              extent={{-4,-4},{4,4}},
              rotation=90,
              origin={80,26})));

        Modelica.Blocks.Interfaces.RealInput IN1(start=0)
          "Connector of Real input signal 2" annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-150,14}),iconTransformation(extent={{-10,-10},{10,10}}, origin={-150,14})));
        Modelica.Blocks.Sources.Constant IN11(k=0)
          annotation (Placement(transformation(extent={{-108,-2},{-96,10}})));
        Modelica.Blocks.Math.Add AddU1
          annotation (Placement(transformation(extent={{-80,0},{-60,20}})));
        Modelica.Blocks.Sources.Constant IN22(k=0)
          annotation (Placement(transformation(extent={{-108,-32},{-96,-20}})));
        Modelica.Blocks.Math.Add AddU2
          annotation (Placement(transformation(extent={{-80,-30},{-60,-10}})));
        Modelica.Blocks.Interfaces.RealInput IN2(start=0)
          "Connector of Real input signal 2"
                 annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-150,-8}),  iconTransformation(extent={{-10,-10},{10,10}},
                origin={-150,-8})));
        Modelica.Blocks.Interfaces.RealInput IN3(start = 0) "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-40},{-140,-20}}),
              iconTransformation(extent={{-160,-40},{-140,-20}})));

        Modelica.Blocks.Interfaces.RealOutput OUT1
          annotation (Placement(transformation(extent={{140,70},{160,90}})));

        PFData.PowerFlow powerFlow(redeclare record PowerFlow =
              OpenIPSL.Examples.ModelPredictiveControl.PFData.PF15)
          annotation (Placement(transformation(extent={{-68,104},{-48,124}})));
        Electrical.Machines.PSSE.GENCLS IB(
          V_b=220000,
          v_0=powerFlow.powerflow.bus.V4,
          angle_0=powerFlow.powerflow.bus.A4,
          P_0=powerFlow.powerflow.machines.Pinf,
          Q_0=powerFlow.powerflow.machines.Qinf,
          M_b=100000000,
          X_d=1) if not equivalentGRID annotation (Placement(transformation(extent={{110,70},
                  {100,90}})));
        Electrical.Loads.PSSE.Load_ExtInput Load2(
          P_0=powerFlow.powerflow.loads.PL2,
          Q_0=powerFlow.powerflow.loads.QL2,
          v_0=powerFlow.powerflow.bus.V5,
          angle_0=powerFlow.powerflow.bus.A5,
          d_P=0,
          t1=0,
          d_t=0)
          annotation (Placement(transformation(extent={{100,-30},{120,-10}})));

        inner Modelica.Blocks.Noise.GlobalSeed globalSeed(useAutomaticSeed=false,
            fixedSeed=10000)
          annotation (Placement(transformation(extent={{-42,102},{-22,122}})));
        Modelica.Blocks.Sources.Sine sine(
          amplitude=0,
          f=1/260,
          phase=3.1415926535898,
          startTime=1000)
          annotation (Placement(transformation(extent={{76,-26},{82,-20}})));
        Modelica.Blocks.Math.Add add
          annotation (Placement(transformation(extent={{86,-18},{94,-10}})));

        Electrical.Buses.Bus          Bus7(v_0=powerFlow.powerflow.bus.V7, angle_0=
              powerFlow.powerflow.bus.A7) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={0,-76})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T3(
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.05) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=270,
              origin={60,-20})));
        Modelica.Blocks.Math.Add AddU3
          annotation (Placement(transformation(extent={{-80,-60},{-60,-40}})));
        Modelica.Blocks.Sources.Constant IN33(k=0)
          annotation (Placement(transformation(extent={{-108,-62},{-96,-50}})));

        GenerationUnits.PSSE.Battery_Units.BESSMPCLocalVQControl BESS(
          V_base=480,
          V_b(displayUnit="kV") = 480,
          enableV_b=true,
          P_0=powerFlow.powerflow.machines.PBESS,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QBESS,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V7,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A7,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-86},{-20,-66}})));
        Modelica.Blocks.Sources.Constant IN44(k=0)
          annotation (Placement(transformation(extent={{-108,-102},{-96,-90}})));
        Modelica.Blocks.Math.Add AddU4
          annotation (Placement(transformation(extent={{-80,-100},{-60,-80}})));
        Modelica.Blocks.Interfaces.RealInput IN4 "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-60},{-140,-40}}),
              iconTransformation(extent={{-160,-60},{-140,-40}})));
        Modelica.Blocks.Interfaces.RealOutput OUT2
          annotation (Placement(transformation(extent={{140,40},{160,60}})));
        Modelica.Blocks.Interfaces.RealOutput OUT3
          annotation (Placement(transformation(extent={{140,20},{160,40}})));
        Modelica.Blocks.Interfaces.RealOutput OUT4
          annotation (Placement(transformation(extent={{140,-10},{160,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT5
          annotation (Placement(transformation(extent={{140,-40},{160,-20}})));
        Modelica.Blocks.Interfaces.RealOutput OUT6
          annotation (Placement(transformation(extent={{140,-70},{160,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT7
          annotation (Placement(transformation(extent={{170,70},{190,90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT8
          annotation (Placement(transformation(extent={{170,40},{190,60}})));
        Modelica.Blocks.Interfaces.RealOutput OUT9
          annotation (Placement(transformation(extent={{170,20},{190,40}})));
        Modelica.Blocks.Interfaces.RealOutput OUT10
          annotation (Placement(transformation(extent={{170,-10},{190,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT11
          annotation (Placement(transformation(extent={{170,-40},{190,-20}})));
        Modelica.Blocks.Interfaces.RealOutput OUT12
          annotation (Placement(transformation(extent={{170,-70},{190,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT13
          annotation (Placement(transformation(extent={{198,72},{218,92}})));
        Modelica.Blocks.Interfaces.RealOutput OUT14
          annotation (Placement(transformation(extent={{198,42},{218,62}})));
        Modelica.Blocks.Interfaces.RealOutput OUT15
          annotation (Placement(transformation(extent={{198,22},{218,42}})));
        Modelica.Blocks.Interfaces.RealOutput OUT16
          annotation (Placement(transformation(extent={{198,-8},{218,12}})));
        Modelica.Blocks.Interfaces.RealOutput OUT17
          annotation (Placement(transformation(extent={{198,-38},{218,-18}})));
        Modelica.Blocks.Interfaces.RealOutput OUT18
          annotation (Placement(transformation(extent={{198,-68},{218,-48}})));
        Modelica.Blocks.Interfaces.RealOutput OUT19
          annotation (Placement(transformation(extent={{232,76},{252,96}})));
        Modelica.Blocks.Interfaces.RealOutput OUT20
          annotation (Placement(transformation(extent={{232,46},{252,66}})));
        Modelica.Blocks.Interfaces.RealOutput OUT21
          annotation (Placement(transformation(extent={{232,26},{252,46}})));
        Modelica.Blocks.Interfaces.RealOutput OUT22
          annotation (Placement(transformation(extent={{232,-4},{252,16}})));
        Modelica.Blocks.Interfaces.RealOutput OUT23
          annotation (Placement(transformation(extent={{232,-34},{252,-14}})));
        Modelica.Blocks.Interfaces.RealOutput OUT24
          annotation (Placement(transformation(extent={{232,-64},{252,-44}})));
        Electrical.Sensors.SoftPMU softPMU(v_0=powerFlow.powerflow.bus.V5, angle_0=
              powerFlow.powerflow.bus.A5,
          Ts=0.001)                        annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={96,10})));
      equation

        OUT1 = 60 + 60*G2.gen.w;
        OUT2 = G2.gen.delta;
        OUT3 = G2.gen.Epq;
        OUT4 = G2.gen.PSIkd;
        OUT5 = G2.gen.PSIppq;
        OUT6 = G2.sEXSMPC.simpleLagLim.state;
        OUT7 = G2.sEXSMPC.leadLag.TF.x[1];
        OUT8 = G2.gASTMPC.simpleLagLim.state;
        OUT9 = G2.gASTMPC.simpleLag.state;
        OUT10 = G2.gASTMPC.simpleLag1.state;
        OUT11 = BESS.rEGCA1_1.simpleLag.state;
        OUT12 = BESS.rEGCA1_1.integrator.y;
        OUT13 = BESS.rEGCA1_1.integrator1.y;
        OUT14 =BESS.EC.integrator3.y;
        OUT15 =BESS.EC.integrator1.y;
        OUT16 =BESS.EC.simpleLag.state;
        OUT17 =BESS.EC.IGQ.y;
        OUT18 =BESS.EC.IGV.y;
        OUT19 = BESS.rEGCA1_1.Pgen;
        OUT20 = BESS.rEGCA1_1.Qgen;
        OUT21 = G2.gen.PMECH;
        OUT22 = G2.sEXSMPC.EFD;
        OUT23 = Bus5.v;
        OUT24 = Bus5.angle;

        connect(T1.p, Bus2.p)
          annotation (Line(points={{-51.2,80},{-40,80}}, color={0,0,255}));
        connect(Bus1.p, T1.n)
          annotation (Line(points={{-80,80},{-68.8,80}}, color={0,0,255}));
        connect(G1.conn, Bus1.p)
          annotation (Line(points={{-91,80},{-80,80}}, color={0,0,255}));
        connect(L1.n, Bus3.p)
          annotation (Line(points={{-14.6,80},{0,80}}, color={0,0,255}));
        connect(L1.p, Bus2.p)
          annotation (Line(points={{-25.4,80},{-40,80}}, color={0,0,255}));
        connect(L2_2.n, Bus4.p) annotation (Line(points={{35.4,70},{44,70},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.n, Bus4.p) annotation (Line(points={{35.4,90},{44,90},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.p, Bus3.p) annotation (Line(points={{24.6,90},{16,90},{16,80},{0,
                80}}, color={0,0,255}));
        connect(L2_2.p, Bus3.p) annotation (Line(points={{24.6,70},{16,70},{16,80},{0,
                80}}, color={0,0,255}));
        connect(Load1.p, Bus3.p)
          annotation (Line(points={{-10,68},{-10,80},{0,80}}, color={0,0,255}));
        connect(L3.p, Bus4.p)
          annotation (Line(points={{80,65.4},{80,80},{60,80}}, color={0,0,255}));
        connect(breaker.s, Bus5.p)
          annotation (Line(points={{80,22},{80,16}},color={0,0,255}));
        connect(breaker.r, L3.n)
          annotation (Line(points={{80,30},{80,54.6}},color={0,0,255}));
        connect(IN11.y, AddU1.u2) annotation (Line(points={{-95.4,4},{-82,4}},
                            color={0,0,127}));
        connect(IN1, AddU1.u1) annotation (Line(points={{-150,14},{-116,14},{-116,16},
                {-82,16}},
                       color={0,0,127}));
        connect(T2.p, Bus5.p) annotation (Line(points={{51,10},{80,10},{80,16}},
              color={0,0,255}));

        connect(IN22.y,AddU2. u2) annotation (Line(points={{-95.4,-26},{-82,-26}},
                       color={0,0,127}));
        connect(IN2,AddU2. u1) annotation (Line(points={{-150,-8},{-118,-8},{-118,-14},
                {-82,-14}},
                       color={0,0,127}));
        connect(AddU2.y, G2.Efd_ref)
          annotation (Line(points={{-59,-20},{-52,-20},{-52,4},{-42,4}},
                                                                 color={0,0,127}));
        connect(AddU1.y, G2.P_ref1) annotation (Line(points={{-59,10},{-52,10},{-52,16},
                {-42,16}},                          color={0,0,127}));
        connect(IB.p, Bus4.p)
          annotation (Line(points={{100,80},{60,80}}, color={0,0,255}));
        connect(sine.y, add.u2) annotation (Line(points={{82.3,-23},{82.3,-24},{85.2,-24},
                {85.2,-16.4}}, color={0,0,127}));
        connect(add.y, Load2.u) annotation (Line(points={{94.4,-14},{94.4,-14.5},{101.9,
                -14.5}}, color={0,0,127}));
        connect(T3.n, Bus7.p) annotation (Line(points={{60,-31},{60,-76},{0,-76}},
                       color={0,0,255}));
        connect(T3.p, Bus5.p) annotation (Line(points={{60,-9},{60,10},{80,10},{80,16}},
              color={0,0,255}));
        connect(Bus6.p, T2.n)
          annotation (Line(points={{4.996e-16,10},{29,10}},
                                                  color={0,0,255}));
        connect(IN33.y,AddU3. u2)
          annotation (Line(points={{-95.4,-56},{-82,-56}}, color={0,0,127}));
        connect(IN3,AddU3. u1) annotation (Line(points={{-150,-30},{-114,-30},{-114,-44},
                {-82,-44}}, color={0,0,127}));
        connect(G2.conn, Bus6.p) annotation (Line(points={{-19,10},{4.996e-16,10}},
                                           color={0,0,255}));
        connect(BESS.p1, Bus7.p)
          annotation (Line(points={{-20,-76},{4.996e-16,-76}}, color={0,0,255}));
        connect(IN44.y, AddU4.u2)
          annotation (Line(points={{-95.4,-96},{-82,-96}}, color={0,0,127}));
        connect(AddU4.u1, IN4) annotation (Line(points={{-82,-84},{-120,-84},{-120,-50},
                {-150,-50}}, color={0,0,127}));
        connect(AddU3.y, BESS.Paux1) annotation (Line(points={{-59,-50},{-52,-50},{-52,
                -70},{-42,-70}}, color={0,0,127}));
        connect(AddU4.y, BESS.Qext1) annotation (Line(points={{-59,-90},{-52,-90},{-52,
                -82},{-42,-82}}, color={0,0,127}));
        connect(softPMU.n, Bus5.p)
          annotation (Line(points={{89,10},{80,10},{80,16}}, color={0,0,255}));
        connect(softPMU.p, Load2.p)
          annotation (Line(points={{103,10},{110,10},{110,-10}}, color={0,0,255}));
        connect(add.u1, sine.y) annotation (Line(points={{85.2,-11.6},{85.2,-16},{82.3,
                -16},{82.3,-23}}, color={0,0,127}));
          annotation (Placement(transformation(extent={{140,-20},{160,0}})),
                      Placement(transformation(extent={{140,-40},{160,-20}})),
                      Placement(transformation(extent={{140,-60},{160,-40}})),
                      Placement(transformation(extent={{140,-80},{160,-60}})),
                     Diagram(coordinateSystem(preserveAspectRatio=false,
                extent={{-140,-140},{140,140}}), graphics={
              Rectangle(
                extent={{-160,30},{-136,-60}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,36},{124,-124}},
                lineColor={238,46,47},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,98},{124,38}},
                lineColor={0,128,255},
                lineThickness=0.5),
              Polygon(
                points={{-124,30},{-124,-120},{72,-120},{72,-50},{0,30},{-124,30}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Text(
                extent={{78,-106},{114,-120}},
                textColor={238,46,47},
                textString="Microgrid"),
              Text(
                extent={{76,58},{128,34}},
                textColor={28,108,200},
                textString="Utility Grid"),
              Text(
                extent={{6,-102},{70,-124}},
                textColor={0,140,72},
                textString="Linearization Unit"),
              Text(
                extent={{-164,50},{-132,30}},
                textColor={0,140,72},
                textString="Inputs"),
              Text(
                extent={{128,118},{168,98}},
                textColor={0,140,72},
                textString="Outputs")}),
          Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),experiment(StopTime=20, __Dymola_Algorithm="Dassl"),
          Icon(coordinateSystem(extent={{-140,-140},{140,140}})));
      end MPCMicrogridGasBESS_03_PMU;

      model MPCMicrogridGasBESS_03_rootlocus
        "Microgrid with G2 and PV on Local V Control"
        extends Modelica.Icons.Example;

        parameter Boolean equivalentGRID = true;
        parameter Boolean equivalentsystem = false;

        OpenIPSL.Electrical.Buses.Bus Bus1(v_0=powerFlow.powerflow.bus.V1, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-90,70},{-70,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus2(v_0=powerFlow.powerflow.bus.V2, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-50,70},{-30,90}})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
          R=0.001,
          X=0.2,
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000)  if not equivalentGRID annotation (Placement(transformation(
              extent={{-8,-8},{8,8}},
              rotation=180,
              origin={-60,80})));
        OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
          enableV_b=true,
          v_0=powerFlow.powerflow.bus.V1,
          angle_0=powerFlow.powerflow.bus.A1,
          P_0=powerFlow.powerflow.machines.PG1,
          Q_0=powerFlow.powerflow.machines.QG1,
          V_b=6000)  if not equivalentGRID
          annotation (Placement(transformation(extent={{-112,70},{-92,90}})));
        OpenIPSL.Electrical.Branches.PwLine L1(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{-26,76},
                  {-14,84}})));
        OpenIPSL.Electrical.Buses.Bus Bus3(v_0=powerFlow.powerflow.bus.V3, angle_0=
              powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-10,70},{10,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus4(v_0=powerFlow.powerflow.bus.V4, angle_0=
              powerFlow.powerflow.bus.V4) if not equivalentGRID
          annotation (Placement(transformation(extent={{50,70},{70,90}})));
        OpenIPSL.Electrical.Branches.PwLine L2_1(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,86},
                  {36,94}})));
        OpenIPSL.Electrical.Branches.PwLine L2_2(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,66},
                  {36,74}})));
        OpenIPSL.Electrical.Buses.Bus Bus5(angle_0=powerFlow.powerflow.bus.A5, v_0=
              powerFlow.powerflow.bus.V5)  annotation (Placement(
              transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={80,16})));
        OpenIPSL.Electrical.Branches.PwLine L3(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=-90,
              origin={80,60})));
        OpenIPSL.Electrical.Buses.Bus Bus6(v_0=powerFlow.powerflow.bus.V6, angle_0=
              powerFlow.powerflow.bus.A6) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={0,10})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000,
          R=0.005,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={40,10})));
        GenerationUnits.PSSE.G2_16MVA                         G2(
          enableV_b=true,
          enableP_0=true,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V6,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A6,
          V_b=6000,
          P_0=powerFlow.powerflow.machines.PG2,
          Q_0=powerFlow.powerflow.machines.QG2,
          enableangle_0=true)
                        annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-30,10})));
        inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000, fn=60)
          annotation (Placement(transformation(extent={{-128,104},{-74,124}})));
        OpenIPSL.Electrical.Loads.PSSE.Load Load1(
          V_b=220000,
          P_0=powerFlow.powerflow.loads.PL1,
          Q_0=powerFlow.powerflow.loads.QL1,
          v_0=powerFlow.powerflow.bus.V3,
          angle_0=powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-20,48},{0,68}})));
        Electrical.Events.Breaker breaker(enableTrigger=false,
          t_o=100,
          rc_enabled=true,
          t_rc=800.01)      if not equivalentGRID                     annotation (Placement(transformation(
              extent={{-4,-4},{4,4}},
              rotation=90,
              origin={80,26})));

        Modelica.Blocks.Sources.Constant IN11(k=0)
          annotation (Placement(transformation(extent={{-108,-2},{-96,10}})));
        Modelica.Blocks.Math.Add AddU1
          annotation (Placement(transformation(extent={{-80,0},{-60,20}})));
        Modelica.Blocks.Sources.Constant IN22(k=0)
          annotation (Placement(transformation(extent={{-108,-32},{-96,-20}})));
        Modelica.Blocks.Math.Add AddU2
          annotation (Placement(transformation(extent={{-80,-30},{-60,-10}})));

        PFData.PowerFlow powerFlow(redeclare record PowerFlow =
              OpenIPSL.Examples.ModelPredictiveControl.PFData.PF15)
          annotation (Placement(transformation(extent={{-68,104},{-48,124}})));
        Electrical.Machines.PSSE.GENCLS IB(
          V_b=220000,
          v_0=powerFlow.powerflow.bus.V4,
          angle_0=powerFlow.powerflow.bus.A4,
          P_0=powerFlow.powerflow.machines.Pinf,
          Q_0=powerFlow.powerflow.machines.Qinf,
          M_b=100000000,
          X_d=1) if not equivalentGRID annotation (Placement(transformation(extent={{110,70},
                  {100,90}})));
        Electrical.Loads.PSSE.Load_ExtInput Load2(
          P_0=powerFlow.powerflow.loads.PL2,
          Q_0=powerFlow.powerflow.loads.QL2,
          v_0=powerFlow.powerflow.bus.V5,
          angle_0=powerFlow.powerflow.bus.A5,
          d_P=0,
          t1=0,
          d_t=0)
          annotation (Placement(transformation(extent={{100,-30},{120,-10}})));
        Electrical.Loads.NoiseInjections.WhiteNoiseInjection whiteNoiseInjection(
            active_sigma=0.0000000005,
                                  samplePeriod=0.02)
          annotation (Placement(transformation(extent={{76,-14},{82,-8}})));

        inner Modelica.Blocks.Noise.GlobalSeed globalSeed(useAutomaticSeed=false,
            fixedSeed=10000)
          annotation (Placement(transformation(extent={{-42,102},{-22,122}})));
        Modelica.Blocks.Sources.Sine sine(
          amplitude=0,
          f=1/260,
          phase=3.1415926535898,
          startTime=1000)
          annotation (Placement(transformation(extent={{76,-26},{82,-20}})));
        Modelica.Blocks.Math.Add add
          annotation (Placement(transformation(extent={{86,-18},{94,-10}})));

        Electrical.Buses.Bus          Bus7(v_0=powerFlow.powerflow.bus.V7, angle_0=
              powerFlow.powerflow.bus.A7) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={0,-76})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T3(
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.05) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=270,
              origin={60,-20})));
        Modelica.Blocks.Math.Add AddU3
          annotation (Placement(transformation(extent={{-80,-60},{-60,-40}})));
        Modelica.Blocks.Sources.Constant IN33(k=0)
          annotation (Placement(transformation(extent={{-108,-62},{-96,-50}})));

        GenerationUnits.PSSE.Battery_Units.BESSMPCLocalVQControlLinearized
                                                                 BESS(
          V_base=480,
          V_b(displayUnit="kV") = 480,
          enableV_b=true,
          P_0=powerFlow.powerflow.machines.PBESS,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QBESS,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V7,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A7,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-86},{-20,-66}})));
        Modelica.Blocks.Sources.Constant IN44(k=0)
          annotation (Placement(transformation(extent={{-108,-102},{-96,-90}})));
        Modelica.Blocks.Math.Add AddU4
          annotation (Placement(transformation(extent={{-80,-100},{-60,-80}})));
      equation

      //   OUT1 = G2.gen.w;
      //   OUT2 = G2.gen.delta;
      //   OUT3 = G2.gen.Epq;
      //   OUT4 = G2.gen.PSIkd;
      //   OUT5 = G2.gen.PSIppq;
      //   OUT6 = G2.sEXSMPC.simpleLagLim.state;
      //   OUT7 = G2.sEXSMPC.leadLag.TF.x[1];
      //   OUT8 = G2.gASTMPC.simpleLagLim.state;
      //   OUT9 = G2.gASTMPC.simpleLag.state;
      //   OUT10 = G2.gASTMPC.simpleLag1.state;
      //   OUT11 = BESS.rEGCA1_1.simpleLag.state;
      //   OUT12 = BESS.rEGCA1_1.integrator.y;
      //   OUT13 = BESS.rEGCA1_1.integrator1.y;
      //   OUT14 =BESS.rEECCU1_Local_V_Q_Control2_1.integrator3.y;
      //   OUT15 =BESS.rEECCU1_Local_V_Q_Control2_1.integrator1.y;
      //   OUT16 =BESS.rEECCU1_Local_V_Q_Control2_1.simpleLag.state;
      //   OUT17 =BESS.rEECCU1_Local_V_Q_Control2_1.integrator.y;
      //   OUT18 =BESS.rEECCU1_Local_V_Q_Control2_1.integrator2.y;
      //   OUT19 = BESS.rEGCA1_1.Pgen;
      //   OUT20 = BESS.rEGCA1_1.Qgen;
      //   OUT21 = G2.gen.PMECH;
      //   OUT22 = G2.sEXSMPC.EFD;
      //   OUT23 = Bus5.v;
      //   OUT24 = Bus5.angle;

        connect(T1.p, Bus2.p)
          annotation (Line(points={{-51.2,80},{-40,80}}, color={0,0,255}));
        connect(Bus1.p, T1.n)
          annotation (Line(points={{-80,80},{-68.8,80}}, color={0,0,255}));
        connect(G1.conn, Bus1.p)
          annotation (Line(points={{-91,80},{-80,80}}, color={0,0,255}));
        connect(L1.n, Bus3.p)
          annotation (Line(points={{-14.6,80},{0,80}}, color={0,0,255}));
        connect(L1.p, Bus2.p)
          annotation (Line(points={{-25.4,80},{-40,80}}, color={0,0,255}));
        connect(L2_2.n, Bus4.p) annotation (Line(points={{35.4,70},{44,70},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.n, Bus4.p) annotation (Line(points={{35.4,90},{44,90},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.p, Bus3.p) annotation (Line(points={{24.6,90},{16,90},{16,80},{0,
                80}}, color={0,0,255}));
        connect(L2_2.p, Bus3.p) annotation (Line(points={{24.6,70},{16,70},{16,80},{0,
                80}}, color={0,0,255}));
        connect(Load1.p, Bus3.p)
          annotation (Line(points={{-10,68},{-10,80},{0,80}}, color={0,0,255}));
        connect(L3.p, Bus4.p)
          annotation (Line(points={{80,65.4},{80,80},{60,80}}, color={0,0,255}));
        connect(breaker.s, Bus5.p)
          annotation (Line(points={{80,22},{80,16}},color={0,0,255}));
        connect(breaker.r, L3.n)
          annotation (Line(points={{80,30},{80,54.6}},color={0,0,255}));
        connect(IN11.y, AddU1.u2) annotation (Line(points={{-95.4,4},{-82,4}},
                            color={0,0,127}));
        connect(T2.p, Bus5.p) annotation (Line(points={{51,10},{80,10},{80,16}},
              color={0,0,255}));

        connect(IN22.y,AddU2. u2) annotation (Line(points={{-95.4,-26},{-82,-26}},
                       color={0,0,127}));
        connect(AddU2.y, G2.Efd_ref)
          annotation (Line(points={{-59,-20},{-52,-20},{-52,4},{-42,4}},
                                                                 color={0,0,127}));
        connect(AddU1.y, G2.P_ref1) annotation (Line(points={{-59,10},{-52,10},{-52,16},
                {-42,16}},                          color={0,0,127}));
        connect(IB.p, Bus4.p)
          annotation (Line(points={{100,80},{60,80}}, color={0,0,255}));
        connect(Load2.p, Bus5.p) annotation (Line(points={{110,-10},{110,10},{80,10},{
                80,16}},
                     color={0,0,255}));
        connect(sine.y, add.u2) annotation (Line(points={{82.3,-23},{82.3,-24},{85.2,-24},
                {85.2,-16.4}}, color={0,0,127}));
        connect(whiteNoiseInjection.y, add.u1) annotation (Line(points={{82.27,-11.03},
                {82.27,-11.6},{85.2,-11.6}}, color={0,0,127}));
        connect(add.y, Load2.u) annotation (Line(points={{94.4,-14},{94.4,-14.5},{101.9,
                -14.5}}, color={0,0,127}));
        connect(T3.n, Bus7.p) annotation (Line(points={{60,-31},{60,-76},{0,-76}},
                       color={0,0,255}));
        connect(T3.p, Bus5.p) annotation (Line(points={{60,-9},{60,10},{80,10},{80,16}},
              color={0,0,255}));
        connect(Bus6.p, T2.n)
          annotation (Line(points={{4.996e-16,10},{29,10}},
                                                  color={0,0,255}));
        connect(IN33.y,AddU3. u2)
          annotation (Line(points={{-95.4,-56},{-82,-56}}, color={0,0,127}));
        connect(G2.conn, Bus6.p) annotation (Line(points={{-19,10},{4.996e-16,10}},
                                           color={0,0,255}));
        connect(BESS.p1, Bus7.p)
          annotation (Line(points={{-20,-76},{4.996e-16,-76}}, color={0,0,255}));
        connect(IN44.y, AddU4.u2)
          annotation (Line(points={{-95.4,-96},{-82,-96}}, color={0,0,127}));
        connect(AddU3.y, BESS.Paux1) annotation (Line(points={{-59,-50},{-52,-50},{-52,
                -70},{-42,-70}}, color={0,0,127}));
        connect(AddU4.y, BESS.Qext1) annotation (Line(points={{-59,-90},{-52,-90},{-52,
                -82},{-42,-82}}, color={0,0,127}));
        connect(AddU2.u1, AddU2.u2) annotation (Line(points={{-82,-14},{-86,-14},{-86,
                -26},{-82,-26}}, color={0,0,127}));
        connect(AddU1.u1, IN11.y) annotation (Line(points={{-82,16},{-92,16},{
                -92,4},{-95.4,4}}, color={0,0,127}));
        connect(AddU3.u1, AddU3.u2) annotation (Line(points={{-82,-44},{-90,-44},{-90,
                -56},{-82,-56}}, color={0,0,127}));
        connect(AddU4.u1, AddU4.u2) annotation (Line(points={{-82,-84},{-90,-84},{-90,
                -96},{-82,-96}}, color={0,0,127}));
          annotation (Placement(transformation(extent={{140,-20},{160,0}})),
                      Placement(transformation(extent={{140,-40},{160,-20}})),
                      Placement(transformation(extent={{140,-60},{160,-40}})),
                      Placement(transformation(extent={{140,-80},{160,-60}})),
                     Diagram(coordinateSystem(preserveAspectRatio=false,
                extent={{-140,-140},{140,140}}), graphics={
              Rectangle(
                extent={{-128,36},{124,-124}},
                lineColor={238,46,47},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,98},{124,38}},
                lineColor={0,128,255},
                lineThickness=0.5),
              Polygon(
                points={{-124,30},{-124,-120},{72,-120},{72,-50},{0,30},{-124,30}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Text(
                extent={{78,-106},{114,-120}},
                textColor={238,46,47},
                textString="Microgrid"),
              Text(
                extent={{76,58},{128,34}},
                textColor={28,108,200},
                textString="Utility Grid"),
              Text(
                extent={{6,-102},{70,-124}},
                textColor={0,140,72},
                textString="Linearization Unit")}),
          Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),experiment(StopTime=20, __Dymola_Algorithm="Dassl"),
          Icon(coordinateSystem(extent={{-140,-140},{140,140}})));
      end MPCMicrogridGasBESS_03_rootlocus;

      model MPCMicrogridRenewablesIncluded_rootlocus
        "THIS ONE IS STABLE, CONTROLLABLE, OBSERVABLE!!!!!!!"
        extends Modelica.Icons.Example;

        parameter Boolean equivalentGRID = true;
        parameter Boolean equivalentsystem = false;

        OpenIPSL.Electrical.Buses.Bus Bus1(v_0=powerFlow.powerflow.bus.V1, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-90,70},{-70,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus2(v_0=powerFlow.powerflow.bus.V2, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-50,70},{-30,90}})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
          R=0.001,
          X=0.2,
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000)  if not equivalentGRID annotation (Placement(transformation(
              extent={{-8,-8},{8,8}},
              rotation=180,
              origin={-60,80})));
        OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
          enableV_b=true,
          v_0=powerFlow.powerflow.bus.V1,
          angle_0=powerFlow.powerflow.bus.A1,
          P_0=powerFlow.powerflow.machines.PG1,
          Q_0=powerFlow.powerflow.machines.QG1,
          V_b=6000)  if not equivalentGRID
          annotation (Placement(transformation(extent={{-112,70},{-92,90}})));
        OpenIPSL.Electrical.Branches.PwLine L1(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{-26,76},
                  {-14,84}})));
        OpenIPSL.Electrical.Buses.Bus Bus3(v_0=powerFlow.powerflow.bus.V3, angle_0=
              powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-10,70},{10,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus4(v_0=powerFlow.powerflow.bus.V4, angle_0=
              powerFlow.powerflow.bus.V4) if not equivalentGRID
          annotation (Placement(transformation(extent={{50,70},{70,90}})));
        OpenIPSL.Electrical.Branches.PwLine L2_1(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,86},
                  {36,94}})));
        OpenIPSL.Electrical.Branches.PwLine L2_2(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,66},
                  {36,74}})));
        OpenIPSL.Electrical.Buses.Bus Bus5(angle_0=powerFlow.powerflow.bus.A5, v_0=
              powerFlow.powerflow.bus.V5)  annotation (Placement(
              transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={80,16})));
        OpenIPSL.Electrical.Branches.PwLine L3(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=-90,
              origin={80,60})));
        OpenIPSL.Electrical.Buses.Bus Bus6(v_0=powerFlow.powerflow.bus.V6, angle_0=
              powerFlow.powerflow.bus.A6) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={0,10})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000,
          R=0.005,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={40,10})));
        GenerationUnits.PSSE.G2_16MVA                         G2(
          enableV_b=true,
          enableP_0=true,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V6,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A6,
          V_b=6000,
          P_0=powerFlow.powerflow.machines.PG2,
          Q_0=powerFlow.powerflow.machines.QG2,
          enableangle_0=true)
                        annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-30,10})));
        inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000, fn=60)
          annotation (Placement(transformation(extent={{-128,104},{-74,124}})));
        OpenIPSL.Electrical.Loads.PSSE.Load Load1(
          V_b=220000,
          P_0=powerFlow.powerflow.loads.PL1,
          Q_0=powerFlow.powerflow.loads.QL1,
          v_0=powerFlow.powerflow.bus.V3,
          angle_0=powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-20,48},{0,68}})));
        Electrical.Events.Breaker breaker(enableTrigger=false,
          t_o=1.01,
          rc_enabled=true,
          t_rc=80.01)       if not equivalentGRID                     annotation (Placement(transformation(
              extent={{-4,-4},{4,4}},
              rotation=90,
              origin={80,26})));

        Modelica.Blocks.Interfaces.RealInput IN1(start=0)
          "Connector of Real input signal 2" annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-150,10}),iconTransformation(extent={{-10,-10},{10,10}}, origin={-150,10})));
        Modelica.Blocks.Sources.Constant IN11(k=0)
          annotation (Placement(transformation(extent={{-108,-2},{-96,10}})));
        Modelica.Blocks.Math.Add AddU1
          annotation (Placement(transformation(extent={{-80,0},{-60,20}})));
        Modelica.Blocks.Sources.Constant IN22(k=0)
          annotation (Placement(transformation(extent={{-108,-32},{-96,-20}})));
        Modelica.Blocks.Math.Add AddU2
          annotation (Placement(transformation(extent={{-80,-30},{-60,-10}})));
        Modelica.Blocks.Interfaces.RealInput IN2(start=0)
          "Connector of Real input signal 2"
                 annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-150,-12}), iconTransformation(extent={{-10,-10},{10,10}},
                origin={-150,-12})));
        Modelica.Blocks.Interfaces.RealInput IN3(start = 0) "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-44},{-140,-24}}),
              iconTransformation(extent={{-160,-44},{-140,-24}})));
        Modelica.Blocks.Interfaces.RealInput IN4(start = 0) "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-66},{-140,-46}}),
              iconTransformation(extent={{-160,-66},{-140,-46}})));
        Modelica.Blocks.Interfaces.RealInput IN5(start = 0) "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-88},{-140,-68}}),
              iconTransformation(extent={{-160,-88},{-140,-68}})));

        PFData.PowerFlow powerFlow(redeclare record PowerFlow =
              OpenIPSL.Examples.ModelPredictiveControl.PFData.PF13)
          annotation (Placement(transformation(extent={{-68,104},{-48,124}})));
        Electrical.Machines.PSSE.GENCLS IB(
          V_b=220000,
          v_0=powerFlow.powerflow.bus.V4,
          angle_0=powerFlow.powerflow.bus.A4,
          P_0=powerFlow.powerflow.machines.Pinf,
          Q_0=powerFlow.powerflow.machines.Qinf,
          M_b=100000000,
          X_d=1) if not equivalentGRID annotation (Placement(transformation(extent={{110,70},
                  {100,90}})));
        Electrical.Loads.PSSE.Load_ExtInput Load2(
          P_0=powerFlow.powerflow.loads.PL2,
          Q_0=powerFlow.powerflow.loads.QL2,
          v_0=powerFlow.powerflow.bus.V5,
          angle_0=powerFlow.powerflow.bus.A5,
          d_P=0,
          t1=100,
          d_t=1000)
          annotation (Placement(transformation(extent={{100,-30},{120,-10}})));
        Electrical.Loads.NoiseInjections.WhiteNoiseInjection whiteNoiseInjection(
            active_sigma=0.0000000005,
                                  samplePeriod=0.02)
          annotation (Placement(transformation(extent={{76,-14},{82,-8}})));

        inner Modelica.Blocks.Noise.GlobalSeed globalSeed(useAutomaticSeed=false,
            fixedSeed=10000)
          annotation (Placement(transformation(extent={{-42,102},{-22,122}})));
        Modelica.Blocks.Sources.Sine sine(
          amplitude=0,
          f=1/260,
          phase=3.1415926535898,
          startTime=1000)
          annotation (Placement(transformation(extent={{76,-26},{82,-20}})));
        Modelica.Blocks.Math.Add add
          annotation (Placement(transformation(extent={{86,-18},{94,-10}})));

        Electrical.Buses.Bus          Bus7(v_0=powerFlow.powerflow.bus.V7, angle_0=
              powerFlow.powerflow.bus.A7) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={0,-76})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T3(
          G=0,
          B=0,
          CW=1,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=270,
              origin={60,-20})));
        GenerationUnits.PSSE.Solar_Units.SolarMPCLocalVQControl PV(
          V_b=480,
          P_0=powerFlow.powerflow.machines.PPV,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QPV,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V7,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A7,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-70},{-20,-50}})));
        Modelica.Blocks.Math.Add AddU3
          annotation (Placement(transformation(extent={{-80,-60},{-60,-40}})));
        Modelica.Blocks.Sources.Constant IN33(k=0)
          annotation (Placement(transformation(extent={{-108,-62},{-96,-50}})));

        Modelica.Blocks.Math.Add AddU4
          annotation (Placement(transformation(extent={{-80,-90},{-60,-70}})));
        Modelica.Blocks.Math.Add AddU5
          annotation (Placement(transformation(extent={{-80,-116},{-60,-96}})));
        Modelica.Blocks.Sources.Constant IN44(k=0)
          annotation (Placement(transformation(extent={{-108,-92},{-96,-80}})));
        Modelica.Blocks.Sources.Constant IN55(k=0)
          annotation (Placement(transformation(extent={{-108,-118},{-96,-106}})));
        GenerationUnits.PSSE.Battery_Units.BESSMPCLocalVQControl BESS(
          V_base=480,
          V_b(displayUnit="kV") = 480,
          enableV_b=true,
          P_0=powerFlow.powerflow.machines.PBESS,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QBESS,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V7,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A7,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-102},{-20,-82}})));
      equation

      //   OUT1 = G2.gen.w;
      //   OUT2 = G2.gen.delta;
      //   OUT3 = G2.gen.Epq;
      //   OUT4 = G2.gen.PSIkd;
      //   OUT5 = G2.gen.PSIppq;
      //   OUT6 = G2.sEXSMPC.simpleLagLim.state;
      //   OUT7 = G2.sEXSMPC.leadLag.TF.x[1];
      //   OUT8 = G2.gASTMPC.simpleLagLim.state;
      //   OUT9 = G2.gASTMPC.simpleLag.state;
      //   OUT10 = G2.gASTMPC.simpleLag1.state;
      //   OUT11 = PV.rEGCA1_1.simpleLag.state;
      //   OUT12 = PV.rEGCA1_1.integrator.y;
      //   OUT13 = PV.rEGCA1_1.integrator1.y;
      //   OUT14 = PV.rEECB1_Local_V_Q_Control.integrator.y;
      //   OUT15 = PV.rEECB1_Local_V_Q_Control.integrator1.y;
      //   OUT16 = PV.rEECB1_Local_V_Q_Control.simpleLag.state;
      //   OUT17 = PV.rEECB1_Local_V_Q_Control.integrator3.y;
      //   OUT18 = PV.rEECB1_Local_V_Q_Control.simpleLag1.state;
      //   OUT19 = BESS.rEGCA1_1.simpleLag.state;
      //   OUT20 = BESS.rEGCA1_1.integrator.y;
      //   OUT21 = BESS.rEGCA1_1.integrator1.y;
      //   OUT22 = BESS.rEECCU1_Local_V_Q_Control2.integrator3.y;
      //   OUT23 = BESS.rEECCU1_Local_V_Q_Control2.integrator1.y;
      //   OUT24 = BESS.rEECCU1_Local_V_Q_Control2.simpleLag.state;
      //   OUT25 = BESS.rEECCU1_Local_V_Q_Control2.IGQ.y;
      //   OUT26 = BESS.rEECCU1_Local_V_Q_Control2.IGV.y;
      //   OUT27 = G2.gen.PMECH;
      //   OUT28 = G2.sEXSMPC.EFD;
      //   OUT29 = BESS.rEGCA1_1.Pgen;
      //   OUT30 = BESS.rEGCA1_1.Qgen;
      //   OUT31 = PV.rEGCA1_1.Pgen;
      //   OUT32 = PV.rEGCA1_1.Qgen;
      //   OUT33 = Bus5.v;
      //   OUT34 = Bus5.angle;



        connect(T1.p, Bus2.p)
          annotation (Line(points={{-51.2,80},{-40,80}}, color={0,0,255}));
        connect(Bus1.p, T1.n)
          annotation (Line(points={{-80,80},{-68.8,80}}, color={0,0,255}));
        connect(G1.conn, Bus1.p)
          annotation (Line(points={{-91,80},{-80,80}}, color={0,0,255}));
        connect(L1.n, Bus3.p)
          annotation (Line(points={{-14.6,80},{0,80}}, color={0,0,255}));
        connect(L1.p, Bus2.p)
          annotation (Line(points={{-25.4,80},{-40,80}}, color={0,0,255}));
        connect(L2_2.n, Bus4.p) annotation (Line(points={{35.4,70},{44,70},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.n, Bus4.p) annotation (Line(points={{35.4,90},{44,90},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.p, Bus3.p) annotation (Line(points={{24.6,90},{16,90},{16,80},{0,
                80}}, color={0,0,255}));
        connect(L2_2.p, Bus3.p) annotation (Line(points={{24.6,70},{16,70},{16,80},{0,
                80}}, color={0,0,255}));
        connect(Load1.p, Bus3.p)
          annotation (Line(points={{-10,68},{-10,80},{0,80}}, color={0,0,255}));
        connect(L3.p, Bus4.p)
          annotation (Line(points={{80,65.4},{80,80},{60,80}}, color={0,0,255}));
        connect(breaker.s, Bus5.p)
          annotation (Line(points={{80,22},{80,16}},color={0,0,255}));
        connect(breaker.r, L3.n)
          annotation (Line(points={{80,30},{80,54.6}},color={0,0,255}));
        connect(IN11.y, AddU1.u2) annotation (Line(points={{-95.4,4},{-82,4}},
                            color={0,0,127}));
        connect(IN1, AddU1.u1) annotation (Line(points={{-150,10},{-116,10},{-116,16},
                {-82,16}},
                       color={0,0,127}));
        connect(T2.p, Bus5.p) annotation (Line(points={{51,10},{80,10},{80,16}},
              color={0,0,255}));

        connect(IN22.y,AddU2. u2) annotation (Line(points={{-95.4,-26},{-82,-26}},
                       color={0,0,127}));
        connect(IN2,AddU2. u1) annotation (Line(points={{-150,-12},{-118,-12},{-118,-14},
                {-82,-14}},
                       color={0,0,127}));
        connect(AddU2.y, G2.Efd_ref)
          annotation (Line(points={{-59,-20},{-52,-20},{-52,4},{-42,4}},
                                                                 color={0,0,127}));
        connect(AddU1.y, G2.P_ref1) annotation (Line(points={{-59,10},{-52,10},{-52,16},
                {-42,16}},                          color={0,0,127}));
        connect(IB.p, Bus4.p)
          annotation (Line(points={{100,80},{60,80}}, color={0,0,255}));
        connect(Load2.p, Bus5.p) annotation (Line(points={{110,-10},{110,10},{80,10},{
                80,16}},
                     color={0,0,255}));
        connect(sine.y, add.u2) annotation (Line(points={{82.3,-23},{82.3,-24},{85.2,-24},
                {85.2,-16.4}}, color={0,0,127}));
        connect(whiteNoiseInjection.y, add.u1) annotation (Line(points={{82.27,-11.03},
                {82.27,-11.6},{85.2,-11.6}}, color={0,0,127}));
        connect(add.y, Load2.u) annotation (Line(points={{94.4,-14},{94.4,-14.5},{101.9,
                -14.5}}, color={0,0,127}));
        connect(T3.n, Bus7.p) annotation (Line(points={{60,-31},{60,-76},{0,-76}},
                       color={0,0,255}));
        connect(T3.p, Bus5.p) annotation (Line(points={{60,-9},{60,10},{80,10},{80,16}},
              color={0,0,255}));
        connect(Bus6.p, T2.n)
          annotation (Line(points={{4.996e-16,10},{29,10}},
                                                  color={0,0,255}));
        connect(PV.p1, Bus7.p)
          annotation (Line(points={{-20,-60},{-6,-60},{-6,-76},{0,-76}},
                                                               color={0,0,255}));
        connect(AddU3.y, PV.QINPUT) annotation (Line(points={{-59,-50},{-50,-50},{-50,
                -60},{-42,-60}}, color={0,0,127}));
        connect(IN33.y,AddU3. u2)
          annotation (Line(points={{-95.4,-56},{-82,-56}}, color={0,0,127}));
        connect(IN3,AddU3. u1) annotation (Line(points={{-150,-34},{-114,-34},{-114,-44},
                {-82,-44}}, color={0,0,127}));
        connect(BESS.p1, Bus7.p) annotation (Line(points={{-20,-92},{-6,-92},{-6,-76},
                {4.996e-16,-76}},
                          color={0,0,255}));
        connect(BESS.Paux1, AddU4.y) annotation (Line(points={{-42,-86},{-54,-86},{-54,
                -80},{-59,-80}}, color={0,0,127}));
        connect(IN55.y, AddU5.u2)
          annotation (Line(points={{-95.4,-112},{-82,-112}}, color={0,0,127}));
        connect(AddU5.y, BESS.Qext1) annotation (Line(points={{-59,-106},{-52,-106},{-52,
                -98},{-42,-98}},   color={0,0,127}));
        connect(IN44.y, AddU4.u2)
          annotation (Line(points={{-95.4,-86},{-82,-86}}, color={0,0,127}));
        connect(AddU4.u1, IN4) annotation (Line(points={{-82,-74},{-100,-74},{-100,-70},
                {-116,-70},{-116,-56},{-150,-56}}, color={0,0,127}));
        connect(AddU5.u1, IN5) annotation (Line(points={{-82,-100},{-116,-100},{-116,-78},
                {-150,-78}}, color={0,0,127}));
        connect(G2.conn, Bus6.p) annotation (Line(points={{-19,10},{4.996e-16,10}},
                                           color={0,0,255}));
          annotation (Placement(transformation(extent={{140,-20},{160,0}})),
                      Placement(transformation(extent={{140,-40},{160,-20}})),
                      Placement(transformation(extent={{140,-60},{160,-40}})),
                      Placement(transformation(extent={{140,-80},{160,-60}})),
                     Diagram(coordinateSystem(preserveAspectRatio=false,
                extent={{-140,-140},{140,140}}), graphics={
              Rectangle(
                extent={{-160,30},{-134,-90}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,36},{124,-124}},
                lineColor={238,46,47},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,98},{124,38}},
                lineColor={0,128,255},
                lineThickness=0.5),
              Polygon(
                points={{-124,30},{-124,-120},{72,-120},{72,-50},{0,30},{-124,30}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Text(
                extent={{78,-106},{114,-120}},
                textColor={238,46,47},
                textString="Microgrid"),
              Text(
                extent={{76,58},{128,34}},
                textColor={28,108,200},
                textString="Utility Grid"),
              Text(
                extent={{6,-102},{70,-124}},
                textColor={0,140,72},
                textString="Linearization Unit"),
              Text(
                extent={{-164,50},{-132,30}},
                textColor={0,140,72},
                textString="Inputs")}),
          Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),experiment(StopTime=10, __Dymola_Algorithm="Dassl"),
          Icon(coordinateSystem(extent={{-140,-140},{140,140}})));
      end MPCMicrogridRenewablesIncluded_rootlocus;

      model MPCAppliedEnergyOriginal
        "THIS ONE IS STABLE, CONTROLLABLE, OBSERVABLE!!!!!!!"
        extends Modelica.Icons.Example;

        parameter Boolean equivalentGRID = false;
        parameter Boolean equivalentsystem = false;

        OpenIPSL.Electrical.Buses.Bus Bus1(v_0=powerFlow.powerflow.bus.V1, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-90,70},{-70,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus2(v_0=powerFlow.powerflow.bus.V2, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-50,70},{-30,90}})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
          R=0.001,
          X=0.2,
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000)  if not equivalentGRID annotation (Placement(transformation(
              extent={{-8,-8},{8,8}},
              rotation=180,
              origin={-60,80})));
        OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
          enableV_b=true,
          v_0=powerFlow.powerflow.bus.V1,
          angle_0=powerFlow.powerflow.bus.A1,
          P_0=powerFlow.powerflow.machines.PG1,
          Q_0=powerFlow.powerflow.machines.QG1,
          V_b=6000)  if not equivalentGRID
          annotation (Placement(transformation(extent={{-112,70},{-92,90}})));
        OpenIPSL.Electrical.Branches.PwLine L1(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{-26,76},
                  {-14,84}})));
        OpenIPSL.Electrical.Buses.Bus Bus3(v_0=powerFlow.powerflow.bus.V3, angle_0=
              powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-10,70},{10,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus4(v_0=powerFlow.powerflow.bus.V4, angle_0=
              powerFlow.powerflow.bus.V4) if not equivalentGRID
          annotation (Placement(transformation(extent={{50,70},{70,90}})));
        OpenIPSL.Electrical.Branches.PwLine L2_1(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,86},
                  {36,94}})));
        OpenIPSL.Electrical.Branches.PwLine L2_2(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,66},
                  {36,74}})));
        OpenIPSL.Electrical.Buses.Bus Bus5(angle_0=powerFlow.powerflow.bus.A5, v_0=
              powerFlow.powerflow.bus.V5)  annotation (Placement(
              transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={80,16})));
        OpenIPSL.Electrical.Branches.PwLine L3(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=-90,
              origin={80,60})));
        OpenIPSL.Electrical.Buses.Bus Bus6(v_0=powerFlow.powerflow.bus.V6, angle_0=
              powerFlow.powerflow.bus.A6) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,10})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000,
          R=0.005,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={10,10})));
        GenerationUnits.PSSE.G2_16MVA                         G2(
          enableV_b=true,
          enableP_0=true,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V6,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A6,
          V_b=6000,
          P_0=powerFlow.powerflow.machines.PG2,
          Q_0=powerFlow.powerflow.machines.QG2,
          enableangle_0=true)
                        annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-30,10})));
        inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000, fn=60)
          annotation (Placement(transformation(extent={{-128,104},{-74,124}})));
        OpenIPSL.Electrical.Loads.PSSE.Load Load1(
          V_b=220000,
          P_0=powerFlow.powerflow.loads.PL1,
          Q_0=powerFlow.powerflow.loads.QL1,
          v_0=powerFlow.powerflow.bus.V3,
          angle_0=powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-20,48},{0,68}})));
        Electrical.Events.Breaker breaker(enableTrigger=false,
          t_o=1.01,
          rc_enabled=false,
          t_rc=80.01)       if not equivalentGRID                     annotation (Placement(transformation(
              extent={{-4,-4},{4,4}},
              rotation=90,
              origin={80,26})));

        Modelica.Blocks.Interfaces.RealInput IN1(start=0)
          "Connector of Real input signal 2" annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-150,10}),iconTransformation(extent={{-10,-10},{10,10}}, origin={-150,10})));
        Modelica.Blocks.Sources.Constant IN11(k=0)
          annotation (Placement(transformation(extent={{-108,-2},{-96,10}})));
        Modelica.Blocks.Math.Add AddU1
          annotation (Placement(transformation(extent={{-80,0},{-60,20}})));
        Modelica.Blocks.Sources.Constant IN22(k=0)
          annotation (Placement(transformation(extent={{-108,-32},{-96,-20}})));
        Modelica.Blocks.Math.Add AddU2
          annotation (Placement(transformation(extent={{-80,-30},{-60,-10}})));
        Modelica.Blocks.Interfaces.RealInput IN2(start=0)
          "Connector of Real input signal 2"
                 annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-150,-12}), iconTransformation(extent={{-10,-10},{10,10}},
                origin={-150,-12})));
                  Modelica.Blocks.Interfaces.RealInput IN3 "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-44},{-140,-24}}),
              iconTransformation(extent={{-160,-44},{-140,-24}})));
        Modelica.Blocks.Interfaces.RealInput IN4(start = 0) "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-66},{-140,-46}}),
              iconTransformation(extent={{-160,-66},{-140,-46}})));
        Modelica.Blocks.Interfaces.RealInput IN5(start = 0) "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-88},{-140,-68}}),
              iconTransformation(extent={{-160,-88},{-140,-68}})));

        Modelica.Blocks.Interfaces.RealOutput OUT1
          annotation (Placement(transformation(extent={{140,70},{160,90}})));
       Modelica.Blocks.Interfaces.RealOutput OUT2
          annotation (Placement(transformation(extent={{140,50},{160,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT3
          annotation (Placement(transformation(extent={{140,30},{160,50}})));

        PFData.PowerFlow powerFlow(redeclare record PowerFlow =
              OpenIPSL.Examples.ModelPredictiveControl.PFData.PF16)
          annotation (Placement(transformation(extent={{-68,104},{-48,124}})));
        Electrical.Machines.PSSE.GENCLS IB(
          V_b=220000,
          v_0=powerFlow.powerflow.bus.V4,
          angle_0=powerFlow.powerflow.bus.A4,
          P_0=powerFlow.powerflow.machines.Pinf,
          Q_0=powerFlow.powerflow.machines.Qinf,
          M_b=100000000,
          X_d=1) if not equivalentGRID annotation (Placement(transformation(extent={{110,70},
                  {100,90}})));
        Electrical.Loads.PSSE.Load_ExtInput Load2(
          P_0=powerFlow.powerflow.loads.PL2,
          Q_0=powerFlow.powerflow.loads.QL2,
          v_0=powerFlow.powerflow.bus.V5,
          angle_0=powerFlow.powerflow.bus.A5,
          d_P=0,
          t1=100,
          d_t=1000)
          annotation (Placement(transformation(extent={{100,-30},{120,-10}})));

        inner Modelica.Blocks.Noise.GlobalSeed globalSeed(useAutomaticSeed=false,
            fixedSeed=10000)
          annotation (Placement(transformation(extent={{-42,102},{-22,122}})));
        Modelica.Blocks.Sources.Sine sine(
          amplitude=0,
          f=1/260,
          phase=3.1415926535898,
          startTime=1000)
          annotation (Placement(transformation(extent={{70,-36},{80,-26}})));

        Electrical.Buses.Bus Bus10(v_0=powerFlow.powerflow.bus.V10, angle_0=powerFlow.powerflow.bus.A10)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,-90})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T4(
          G=0,
          B=0,
          CW=1,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={10,-90})));
        GenerationUnits.PSSE.Solar_Units.SolarMPCLocalVQControl PV(
          V_b=480,
          P_0=powerFlow.powerflow.machines.PPV,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QPV,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V8,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A8,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-60},{-20,-40}})));
        Modelica.Blocks.Math.Add AddU3
          annotation (Placement(transformation(extent={{-80,-60},{-60,-40}})));
        Modelica.Blocks.Sources.Constant IN33(k=0)
          annotation (Placement(transformation(extent={{-108,-62},{-96,-50}})));

        Modelica.Blocks.Math.Add AddU4
          annotation (Placement(transformation(extent={{-80,-90},{-60,-70}})));
        Modelica.Blocks.Math.Add AddU5
          annotation (Placement(transformation(extent={{-80,-116},{-60,-96}})));
        Modelica.Blocks.Sources.Constant IN44(k=0)
          annotation (Placement(transformation(extent={{-108,-92},{-96,-80}})));
        Modelica.Blocks.Sources.Constant IN55(k=0)
          annotation (Placement(transformation(extent={{-108,-118},{-96,-106}})));
        Modelica.Blocks.Interfaces.RealOutput OUT4
          annotation (Placement(transformation(extent={{140,10},{160,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT5
          annotation (Placement(transformation(extent={{140,-10},{160,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT6
          annotation (Placement(transformation(extent={{140,-30},{160,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT7
          annotation (Placement(transformation(extent={{140,-50},{160,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT8
          annotation (Placement(transformation(extent={{140,-70},{160,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT9
          annotation (Placement(transformation(extent={{140,-90},{160,-70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT10
          annotation (Placement(transformation(extent={{140,-110},{160,-90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT11
          annotation (Placement(transformation(extent={{164,70},{184,90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT12
          annotation (Placement(transformation(extent={{164,50},{184,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT13
          annotation (Placement(transformation(extent={{164,30},{184,50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT14
          annotation (Placement(transformation(extent={{164,10},{184,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT15
          annotation (Placement(transformation(extent={{164,-10},{184,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT16
          annotation (Placement(transformation(extent={{164,-30},{184,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT17
          annotation (Placement(transformation(extent={{164,-50},{184,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT18
          annotation (Placement(transformation(extent={{164,-70},{184,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT19
          annotation (Placement(transformation(extent={{164,-90},{184,-70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT20
          annotation (Placement(transformation(extent={{164,-110},{184,-90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT21
          annotation (Placement(transformation(extent={{184,70},{204,90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT22
          annotation (Placement(transformation(extent={{184,50},{204,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT23
          annotation (Placement(transformation(extent={{184,30},{204,50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT24
          annotation (Placement(transformation(extent={{184,10},{204,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT25
          annotation (Placement(transformation(extent={{184,-10},{204,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT26
          annotation (Placement(transformation(extent={{184,-30},{204,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT27
          annotation (Placement(transformation(extent={{184,-50},{204,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT28
          annotation (Placement(transformation(extent={{184,-70},{204,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT29
          annotation (Placement(transformation(extent={{184,-90},{204,-70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT30
          annotation (Placement(transformation(extent={{184,-110},{204,-90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT31
          annotation (Placement(transformation(extent={{204,70},{224,90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT32
          annotation (Placement(transformation(extent={{204,50},{224,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT33
          annotation (Placement(transformation(extent={{204,30},{224,50}})));
        GenerationUnits.PSSE.Battery_Units.BESSMPCLocalVQControl BESS(
          V_base=480,
          V_b(displayUnit="kV") = 480,
          enableV_b=true,
          P_0=powerFlow.powerflow.machines.PBESS,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QBESS,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V10,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A10,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-100},{-20,-80}})));
        Modelica.Blocks.Interfaces.RealOutput OUT34
          annotation (Placement(transformation(extent={{204,10},{224,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT35
          annotation (Placement(transformation(extent={{206,-10},{226,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT36
          annotation (Placement(transformation(extent={{206,-30},{226,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT37
          annotation (Placement(transformation(extent={{206,-50},{226,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT38
          annotation (Placement(transformation(extent={{206,-70},{226,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT39
          annotation (Placement(transformation(extent={{206,-90},{226,-70}})));
        Electrical.Buses.Bus Bus8(v_0=powerFlow.powerflow.bus.V8, angle_0=powerFlow.powerflow.bus.A8)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,-50})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T3(
          G=0,
          B=0,
          CW=1,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={12,-50})));
        Electrical.Buses.Bus Bus11(v_0=powerFlow.powerflow.bus.V11, angle_0=powerFlow.powerflow.bus.A11)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,-90})));
        Electrical.Buses.Bus Bus9(v_0=powerFlow.powerflow.bus.V9, angle_0=powerFlow.powerflow.bus.A9)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,-50})));
        Electrical.Buses.Bus Bus7(v_0=powerFlow.powerflow.bus.V7, angle_0=powerFlow.powerflow.bus.A7)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,10})));
        Electrical.Branches.PwLine          L4(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,6},{
                  50,14}})));
        Electrical.Branches.PwLine          L5(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,-54},
                  {50,-46}})));
        Electrical.Branches.PwLine          L6(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,-94},
                  {50,-86}})));
        Modelica.Blocks.Interfaces.RealOutput OUT40
          annotation (Placement(transformation(extent={{206,-110},{226,-90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT41
          annotation (Placement(transformation(extent={{224,70},{244,90}})));
        Electrical.Loads.NoiseInjections.WhiteNoiseInjection whiteNoiseInjection(
            active_sigma=0.0000000001, samplePeriod=0.1)
          annotation (Placement(transformation(extent={{68,-18},{80,-6}})));
        Modelica.Blocks.Math.Add add
          annotation (Placement(transformation(extent={{86,-18},{94,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT42
          annotation (Placement(transformation(extent={{224,50},{244,70}})));
      equation

      // OUT1 = G2.gen.w;
      // OUT2 = G2.gen.delta;
      // OUT3 = G2.gen.Epq;
      // OUT4 = G2.gen.PSIkd;
      // OUT5 = G2.gen.PSIppq;
      // OUT6 = G2.sEXSMPC.simpleLagLim.state;
      // OUT7 = G2.sEXSMPC.leadLag.TF.x_scaled[1];
      // OUT8 = G2.gASTMPC.simpleLagLim.state;
      // OUT9 = G2.gASTMPC.simpleLag.state;
      // OUT10 = G2.gASTMPC.simpleLag1.state;
      // OUT11 = PV.rEGCA1_1.simpleLag.state;
      // OUT12 = PV.rEGCA1_1.integrator.y;
      // OUT13 = PV.rEGCA1_1.integrator1.y;
      // OUT14 =PV.EC.IGQ.y;
      // OUT15 =PV.EC.IGV.y;
      // OUT16 =PV.EC.simpleLag.state;
      // OUT17 =PV.EC.simpleLag1.state;
      // OUT18 =PV.EC.simpleLag2.state;
      // OUT19 =PV.EC.IGP.y;
      // OUT20 =PV.EC.simpleLag3.state;
      // OUT21 =PV.EC.simpleLag4.state;
      // OUT22 =PV.EC.simpleLag5.state;
      // OUT23 = BESS.rEGCA1_1.simpleLag.state;
      // OUT24 = BESS.rEGCA1_1.integrator.y;
      // OUT25 = BESS.rEGCA1_1.integrator1.y;
      // OUT26 =BESS.EC.integrator3.y;
      // OUT27 =BESS.EC.integrator1.y;
      // OUT28 =BESS.EC.simpleLag.state;
      // OUT29 =BESS.EC.IGQ.y;
      // OUT30 =BESS.EC.IGV.y;
      // OUT31 =BESS.EC.IGP.y;
      // OUT32 =BESS.EC.simpleLag1.state;
      // OUT33 =BESS.EC.simpleLag2.state;
      // OUT34 =BESS.EC.simpleLag3.state;
      // OUT35 =BESS.EC.simpleLag4.state;
      // OUT36 = G2.gen.PMECH;
      // OUT37 = G2.sEXSMPC.EFD;
      // OUT38 = BESS.rEGCA1_1.Pgen;
      // OUT39 = BESS.rEGCA1_1.Qgen;
      // OUT40 = PV.rEGCA1_1.Pgen;
      // OUT41 = PV.rEGCA1_1.Qgen;
      // OUT42 = Bus5.v;
      // OUT43 = Bus5.angle;

      OUT1 = G2.gen.w;
      OUT2 = G2.gen.delta;
      OUT3 = G2.gen.Epq;
      OUT4 = G2.gen.PSIkd;
      OUT5 = G2.gen.PSIppq;
      OUT6 = G2.sEXSMPC.simpleLagLim.state;
      OUT7 = G2.sEXSMPC.leadLag.TF.x_scaled[1];
      OUT8 = G2.gASTMPC.simpleLagLim.state;
      OUT9 = G2.gASTMPC.simpleLag.state;
      OUT10 = G2.gASTMPC.simpleLag1.state;
      OUT11 = PV.rEGCA1_1.simpleLag.state;
      OUT12 = PV.rEGCA1_1.integrator.y;
      OUT13 = PV.rEGCA1_1.integrator1.y;
      OUT14 =PV.EC.IGQ.y;
      OUT15 =PV.EC.IGV.y;
      OUT16 =PV.EC.simpleLag.state;
      OUT17 =PV.EC.simpleLag1.state;
      OUT18 =PV.EC.simpleLag2.state;
      OUT19 =PV.EC.IGP.y;
      OUT20 =PV.EC.simpleLag3.state;
      OUT21 =PV.EC.simpleLag5.state;
      OUT22 = PV.EC.simpleLag4.state;
      OUT23 = BESS.rEGCA1_1.simpleLag.state;
      OUT24 = BESS.rEGCA1_1.integrator.y;
      OUT25 = BESS.rEGCA1_1.integrator1.y;
      OUT26 =BESS.EC.integrator3.y;
      OUT27 =BESS.EC.simpleLag.state;
      OUT28 =BESS.EC.IGQ.y;
      OUT29 =BESS.EC.IGV.y;
      OUT30 =BESS.EC.IGP.y;
      OUT31 =BESS.EC.simpleLag1.state;
      OUT32 =BESS.EC.simpleLag2.state;
      OUT33 =BESS.EC.simpleLag3.state;
      OUT34 =BESS.EC.simpleLag4.state;
      OUT35 = G2.gen.PMECH;
      OUT36 = G2.sEXSMPC.EFD;
      OUT37 = BESS.rEGCA1_1.Pgen;
      OUT38 = BESS.rEGCA1_1.Qgen;
      OUT39 = PV.rEGCA1_1.Pgen;
      OUT40 = PV.rEGCA1_1.Qgen;
      OUT41 = Bus5.v;
      OUT42 = Bus5.angle;



        connect(T1.p, Bus2.p)
          annotation (Line(points={{-51.2,80},{-40,80}}, color={0,0,255}));
        connect(Bus1.p, T1.n)
          annotation (Line(points={{-80,80},{-68.8,80}}, color={0,0,255}));
        connect(G1.conn, Bus1.p)
          annotation (Line(points={{-91,80},{-80,80}}, color={0,0,255}));
        connect(L1.n, Bus3.p)
          annotation (Line(points={{-14.6,80},{0,80}}, color={0,0,255}));
        connect(L1.p, Bus2.p)
          annotation (Line(points={{-25.4,80},{-40,80}}, color={0,0,255}));
        connect(L2_2.n, Bus4.p) annotation (Line(points={{35.4,70},{44,70},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.n, Bus4.p) annotation (Line(points={{35.4,90},{44,90},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.p, Bus3.p) annotation (Line(points={{24.6,90},{16,90},{16,80},{0,
                80}}, color={0,0,255}));
        connect(L2_2.p, Bus3.p) annotation (Line(points={{24.6,70},{16,70},{16,80},{0,
                80}}, color={0,0,255}));
        connect(Load1.p, Bus3.p)
          annotation (Line(points={{-10,68},{-10,80},{0,80}}, color={0,0,255}));
        connect(L3.p, Bus4.p)
          annotation (Line(points={{80,65.4},{80,80},{60,80}}, color={0,0,255}));
        connect(breaker.s, Bus5.p)
          annotation (Line(points={{80,22},{80,16}},color={0,0,255}));
        connect(breaker.r, L3.n)
          annotation (Line(points={{80,30},{80,54.6}},color={0,0,255}));
        connect(IN11.y, AddU1.u2) annotation (Line(points={{-95.4,4},{-82,4}},
                            color={0,0,127}));
        connect(IN1, AddU1.u1) annotation (Line(points={{-150,10},{-116,10},{-116,16},
                {-82,16}},
                       color={0,0,127}));

        connect(IN22.y,AddU2. u2) annotation (Line(points={{-95.4,-26},{-82,-26}},
                       color={0,0,127}));
        connect(IN2,AddU2. u1) annotation (Line(points={{-150,-12},{-118,-12},{-118,-14},
                {-82,-14}},
                       color={0,0,127}));
        connect(AddU2.y, G2.Efd_ref)
          annotation (Line(points={{-59,-20},{-52,-20},{-52,4},{-42,4}},
                                                                 color={0,0,127}));
        connect(AddU1.y, G2.P_ref1) annotation (Line(points={{-59,10},{-52,10},{-52,16},
                {-42,16}},                          color={0,0,127}));
        connect(IB.p, Bus4.p)
          annotation (Line(points={{100,80},{60,80}}, color={0,0,255}));
        connect(Load2.p, Bus5.p) annotation (Line(points={{110,-10},{110,10},{80,10},{
                80,16}},
                     color={0,0,255}));
        connect(T4.n, Bus10.p)
          annotation (Line(points={{-1,-90},{-10,-90}}, color={0,0,255}));
        connect(Bus6.p, T2.n)
          annotation (Line(points={{-10,10},{-1,10}},
                                                  color={0,0,255}));
        connect(AddU3.y, PV.QINPUT) annotation (Line(points={{-59,-50},{-42,-50}},
                                 color={0,0,127}));
        connect(IN33.y,AddU3. u2)
          annotation (Line(points={{-95.4,-56},{-82,-56}}, color={0,0,127}));
        connect(BESS.p1, Bus10.p)
          annotation (Line(points={{-20,-90},{-10,-90}}, color={0,0,255}));
        connect(BESS.Paux1, AddU4.y) annotation (Line(points={{-42,-84},{-54,-84},{-54,
                -80},{-59,-80}}, color={0,0,127}));
        connect(IN55.y, AddU5.u2)
          annotation (Line(points={{-95.4,-112},{-82,-112}}, color={0,0,127}));
        connect(AddU5.y, BESS.Qext1) annotation (Line(points={{-59,-106},{-52,-106},{-52,
                -96},{-42,-96}},   color={0,0,127}));
        connect(IN44.y, AddU4.u2)
          annotation (Line(points={{-95.4,-86},{-82,-86}}, color={0,0,127}));
        connect(AddU4.u1,IN4)  annotation (Line(points={{-82,-74},{-100,-74},{-100,-70},
                {-116,-70},{-116,-56},{-150,-56}}, color={0,0,127}));
        connect(AddU5.u1,IN5)  annotation (Line(points={{-82,-100},{-116,-100},{-116,-78},
                {-150,-78}}, color={0,0,127}));
        connect(G2.conn, Bus6.p) annotation (Line(points={{-19,10},{-10,10}},
                                           color={0,0,255}));
        connect(AddU3.u1, IN3) annotation (Line(points={{-82,-44},{-118,-44},{-118,-34},
                {-150,-34}}, color={0,0,127}));
        connect(PV.p1, Bus8.p)
          annotation (Line(points={{-20,-50},{-10,-50}}, color={0,0,255}));
        connect(Bus8.p, T3.n)
          annotation (Line(points={{-10,-50},{1,-50}},  color={0,0,255}));
        connect(T2.p, Bus7.p) annotation (Line(points={{21,10},{25.5,10},{25.5,10},{30,
                10}}, color={0,0,255}));
        connect(T3.p, Bus9.p)
          annotation (Line(points={{23,-50},{30,-50}}, color={0,0,255}));
        connect(T4.p, Bus11.p)
          annotation (Line(points={{21,-90},{30,-90}}, color={0,0,255}));
        connect(L4.n, Bus5.p) annotation (Line(points={{49.4,10},{60,10},{60,10},{80,10},
                {80,16}},     color={0,0,255}));
        connect(L5.n, Bus5.p) annotation (Line(points={{49.4,-50},{60,-50},{60,10},{80,
                10},{80,16}}, color={0,0,255}));
        connect(Bus11.p, L6.p)
          annotation (Line(points={{30,-90},{38.6,-90}}, color={0,0,255}));
        connect(Bus9.p, L5.p)
          annotation (Line(points={{30,-50},{38.6,-50}}, color={0,0,255}));
        connect(L6.n, Bus5.p) annotation (Line(points={{49.4,-90},{60,-90},{60,10},{80,
                10},{80,16}}, color={0,0,255}));
        connect(Bus7.p, L4.p) annotation (Line(points={{30,10},{34.3,10},{34.3,10},{38.6,
                10}}, color={0,0,255}));
        connect(sine.y, add.u2) annotation (Line(points={{80.5,-31},{85.2,-31},{85.2,-16.4}},
              color={0,0,127}));
        connect(whiteNoiseInjection.y, add.u1) annotation (Line(points={{80.54,-12.06},
                {82.87,-12.06},{82.87,-11.6},{85.2,-11.6}}, color={0,0,127}));
        connect(add.y, Load2.u) annotation (Line(points={{94.4,-14},{98.15,-14},{98.15,
                -14.5},{101.9,-14.5}}, color={0,0,127}));
          annotation (Placement(transformation(extent={{140,-20},{160,0}})),
                      Placement(transformation(extent={{140,-40},{160,-20}})),
                      Placement(transformation(extent={{140,-60},{160,-40}})),
                      Placement(transformation(extent={{140,-80},{160,-60}})),
                     Diagram(coordinateSystem(preserveAspectRatio=false,
                extent={{-140,-140},{140,140}}), graphics={
              Rectangle(
                extent={{130,98},{252,-124}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Rectangle(
                extent={{-160,30},{-134,-90}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,36},{124,-124}},
                lineColor={238,46,47},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,98},{124,38}},
                lineColor={0,128,255},
                lineThickness=0.5),
              Text(
                extent={{78,-106},{114,-120}},
                textColor={238,46,47},
                textString="Microgrid"),
              Text(
                extent={{76,58},{128,34}},
                textColor={28,108,200},
                textString="Utility Grid"),
              Text(
                extent={{-30,-102},{34,-124}},
                textColor={0,140,72},
                textString="Linearization Unit"),
              Text(
                extent={{-164,50},{-132,30}},
                textColor={0,140,72},
                textString="Inputs"),
              Text(
                extent={{128,118},{168,98}},
                textColor={0,140,72},
                textString="Outputs")}),
          Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),experiment(
            StopTime=10,
            Interval=0.0001,
            __Dymola_Algorithm="Dassl"),
          Icon(coordinateSystem(extent={{-140,-140},{140,140}})));
      end MPCAppliedEnergyOriginal;

      model MPCAppliedEnergyLinearized
        "THIS ONE IS STABLE, CONTROLLABLE, OBSERVABLE!!!!!!!"
        extends Modelica.Icons.Example;

        parameter Boolean equivalentGRID = true;
        parameter Boolean equivalentsystem = false;

        OpenIPSL.Electrical.Buses.Bus Bus1(v_0=powerFlow.powerflow.bus.V1, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-90,70},{-70,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus2(v_0=powerFlow.powerflow.bus.V2, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-50,70},{-30,90}})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
          R=0.001,
          X=0.2,
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000)  if not equivalentGRID annotation (Placement(transformation(
              extent={{-8,-8},{8,8}},
              rotation=180,
              origin={-60,80})));
        OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
          enableV_b=true,
          v_0=powerFlow.powerflow.bus.V1,
          angle_0=powerFlow.powerflow.bus.A1,
          P_0=powerFlow.powerflow.machines.PG1,
          Q_0=powerFlow.powerflow.machines.QG1,
          V_b=6000)  if not equivalentGRID
          annotation (Placement(transformation(extent={{-112,70},{-92,90}})));
        OpenIPSL.Electrical.Branches.PwLine L1(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{-26,76},
                  {-14,84}})));
        OpenIPSL.Electrical.Buses.Bus Bus3(v_0=powerFlow.powerflow.bus.V3, angle_0=
              powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-10,70},{10,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus4(v_0=powerFlow.powerflow.bus.V4, angle_0=
              powerFlow.powerflow.bus.V4) if not equivalentGRID
          annotation (Placement(transformation(extent={{50,70},{70,90}})));
        OpenIPSL.Electrical.Branches.PwLine L2_1(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,86},
                  {36,94}})));
        OpenIPSL.Electrical.Branches.PwLine L2_2(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,66},
                  {36,74}})));
        OpenIPSL.Electrical.Buses.Bus Bus5(angle_0=powerFlow.powerflow.bus.A5, v_0=
              powerFlow.powerflow.bus.V5)  annotation (Placement(
              transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={80,16})));
        OpenIPSL.Electrical.Branches.PwLine L3(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=-90,
              origin={80,60})));
        OpenIPSL.Electrical.Buses.Bus Bus6(v_0=powerFlow.powerflow.bus.V6, angle_0=
              powerFlow.powerflow.bus.A6) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,10})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000,
          R=0.005,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={10,10})));
        GenerationUnits.PSSE.G2_16MVA                         G2(
          enableV_b=true,
          enableP_0=true,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V6,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A6,
          V_b=6000,
          P_0=powerFlow.powerflow.machines.PG2,
          Q_0=powerFlow.powerflow.machines.QG2,
          enableangle_0=true)
                        annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-30,10})));
        inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000, fn=60)
          annotation (Placement(transformation(extent={{-128,104},{-74,124}})));
        OpenIPSL.Electrical.Loads.PSSE.Load Load1(
          V_b=220000,
          P_0=powerFlow.powerflow.loads.PL1,
          Q_0=powerFlow.powerflow.loads.QL1,
          v_0=powerFlow.powerflow.bus.V3,
          angle_0=powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-20,48},{0,68}})));
        Electrical.Events.Breaker breaker(enableTrigger=false,
          t_o=1.01,
          rc_enabled=true,
          t_rc=10000)       if not equivalentGRID                     annotation (Placement(transformation(
              extent={{-4,-4},{4,4}},
              rotation=90,
              origin={80,26})));

        Modelica.Blocks.Interfaces.RealInput IN1(start=0)
          "Connector of Real input signal 2" annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-150,10}),iconTransformation(extent={{-10,-10},{10,10}}, origin={-150,10})));
        Modelica.Blocks.Sources.Constant IN11(k=0)
          annotation (Placement(transformation(extent={{-108,-2},{-96,10}})));
        Modelica.Blocks.Math.Add AddU1
          annotation (Placement(transformation(extent={{-80,0},{-60,20}})));
        Modelica.Blocks.Sources.Constant IN22(k=0)
          annotation (Placement(transformation(extent={{-108,-32},{-96,-20}})));
        Modelica.Blocks.Math.Add AddU2
          annotation (Placement(transformation(extent={{-80,-30},{-60,-10}})));
        Modelica.Blocks.Interfaces.RealInput IN2(start=0)
          "Connector of Real input signal 2"
                 annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-150,-12}), iconTransformation(extent={{-10,-10},{10,10}},
                origin={-150,-12})));

        Modelica.Blocks.Interfaces.RealInput IN3(start = 0) "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-44},{-140,-24}}),
              iconTransformation(extent={{-160,-44},{-140,-24}})));
        Modelica.Blocks.Interfaces.RealInput IN4(start = 0) "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-66},{-140,-46}}),
              iconTransformation(extent={{-160,-66},{-140,-46}})));
        Modelica.Blocks.Interfaces.RealInput IN5(start = 0) "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-88},{-140,-68}}),
              iconTransformation(extent={{-160,-88},{-140,-68}})));

        Modelica.Blocks.Interfaces.RealOutput OUT1
          annotation (Placement(transformation(extent={{140,70},{160,90}})));
       Modelica.Blocks.Interfaces.RealOutput OUT2
          annotation (Placement(transformation(extent={{140,50},{160,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT3
          annotation (Placement(transformation(extent={{140,30},{160,50}})));

        PFData.PowerFlow powerFlow(redeclare record PowerFlow =
              OpenIPSL.Examples.ModelPredictiveControl.PFData.PF16)
          annotation (Placement(transformation(extent={{-68,104},{-48,124}})));
        Electrical.Machines.PSSE.GENCLS IB(
          V_b=220000,
          v_0=powerFlow.powerflow.bus.V4,
          angle_0=powerFlow.powerflow.bus.A4,
          P_0=powerFlow.powerflow.machines.Pinf,
          Q_0=powerFlow.powerflow.machines.Qinf,
          M_b=100000000,
          X_d=1) if not equivalentGRID annotation (Placement(transformation(extent={{110,70},
                  {100,90}})));
        Electrical.Loads.PSSE.Load_ExtInput Load2(
          P_0=powerFlow.powerflow.loads.PL2,
          Q_0=powerFlow.powerflow.loads.QL2,
          v_0=powerFlow.powerflow.bus.V5,
          angle_0=powerFlow.powerflow.bus.A5,
          d_P=0,
          t1=100,
          d_t=1000)
          annotation (Placement(transformation(extent={{100,-30},{120,-10}})));

        inner Modelica.Blocks.Noise.GlobalSeed globalSeed(useAutomaticSeed=false,
            fixedSeed=10000)
          annotation (Placement(transformation(extent={{-42,102},{-22,122}})));

        Electrical.Buses.Bus Bus10(v_0=powerFlow.powerflow.bus.V10, angle_0=powerFlow.powerflow.bus.A10)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,-90})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T4(
          G=0,
          B=0,
          CW=1,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={10,-90})));
        GenerationUnits.PSSE.Solar_Units.SolarMPCLocalVQControl PV(
          V_b=480,
          P_0=powerFlow.powerflow.machines.PPV,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QPV,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V8,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A8,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-60},{-20,-40}})));
        Modelica.Blocks.Math.Add AddU3
          annotation (Placement(transformation(extent={{-80,-60},{-60,-40}})));
        Modelica.Blocks.Sources.Constant IN33(k=0)
          annotation (Placement(transformation(extent={{-108,-62},{-96,-50}})));

        Modelica.Blocks.Math.Add AddU4
          annotation (Placement(transformation(extent={{-80,-90},{-60,-70}})));
        Modelica.Blocks.Math.Add AddU5
          annotation (Placement(transformation(extent={{-80,-116},{-60,-96}})));
        Modelica.Blocks.Sources.Constant IN44(k=0)
          annotation (Placement(transformation(extent={{-108,-92},{-96,-80}})));
        Modelica.Blocks.Sources.Constant IN55(k=0)
          annotation (Placement(transformation(extent={{-108,-118},{-96,-106}})));
        Modelica.Blocks.Interfaces.RealOutput OUT4
          annotation (Placement(transformation(extent={{140,10},{160,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT5
          annotation (Placement(transformation(extent={{140,-10},{160,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT6
          annotation (Placement(transformation(extent={{140,-30},{160,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT7
          annotation (Placement(transformation(extent={{140,-50},{160,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT8
          annotation (Placement(transformation(extent={{140,-70},{160,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT9
          annotation (Placement(transformation(extent={{140,-90},{160,-70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT10
          annotation (Placement(transformation(extent={{140,-110},{160,-90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT11
          annotation (Placement(transformation(extent={{164,70},{184,90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT12
          annotation (Placement(transformation(extent={{164,50},{184,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT13
          annotation (Placement(transformation(extent={{164,30},{184,50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT14
          annotation (Placement(transformation(extent={{164,10},{184,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT15
          annotation (Placement(transformation(extent={{164,-10},{184,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT16
          annotation (Placement(transformation(extent={{164,-30},{184,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT17
          annotation (Placement(transformation(extent={{164,-50},{184,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT18
          annotation (Placement(transformation(extent={{164,-70},{184,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT19
          annotation (Placement(transformation(extent={{164,-90},{184,-70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT20
          annotation (Placement(transformation(extent={{164,-110},{184,-90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT21
          annotation (Placement(transformation(extent={{184,70},{204,90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT22
          annotation (Placement(transformation(extent={{184,50},{204,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT23
          annotation (Placement(transformation(extent={{184,30},{204,50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT24
          annotation (Placement(transformation(extent={{184,10},{204,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT25
          annotation (Placement(transformation(extent={{184,-10},{204,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT26
          annotation (Placement(transformation(extent={{184,-30},{204,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT27
          annotation (Placement(transformation(extent={{184,-50},{204,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT28
          annotation (Placement(transformation(extent={{184,-70},{204,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT29
          annotation (Placement(transformation(extent={{184,-90},{204,-70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT30
          annotation (Placement(transformation(extent={{184,-110},{204,-90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT31
          annotation (Placement(transformation(extent={{204,70},{224,90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT32
          annotation (Placement(transformation(extent={{204,50},{224,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT33
          annotation (Placement(transformation(extent={{204,30},{224,50}})));
        GenerationUnits.PSSE.Battery_Units.BESSMPCLocalVQControlLinearized
                                                                 BESS(
          V_base=480,
          V_b(displayUnit="kV") = 480,
          enableV_b=true,
          P_0=powerFlow.powerflow.machines.PBESS,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QBESS,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V10,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A10,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-100},{-20,-80}})));
        Modelica.Blocks.Interfaces.RealOutput OUT34
          annotation (Placement(transformation(extent={{204,10},{224,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT35
          annotation (Placement(transformation(extent={{206,-10},{226,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT36
          annotation (Placement(transformation(extent={{206,-30},{226,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT37
          annotation (Placement(transformation(extent={{206,-50},{226,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT38
          annotation (Placement(transformation(extent={{206,-70},{226,-50}})));
        Electrical.Buses.Bus Bus8(v_0=powerFlow.powerflow.bus.V8, angle_0=powerFlow.powerflow.bus.A8)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,-50})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T3(
          G=0,
          B=0,
          CW=1,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={12,-50})));
        Electrical.Buses.Bus Bus11(v_0=powerFlow.powerflow.bus.V11, angle_0=powerFlow.powerflow.bus.A11)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,-90})));
        Electrical.Buses.Bus Bus9(v_0=powerFlow.powerflow.bus.V9, angle_0=powerFlow.powerflow.bus.A9)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,-50})));
        Electrical.Buses.Bus Bus7(v_0=powerFlow.powerflow.bus.V7, angle_0=powerFlow.powerflow.bus.A7)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,10})));
        Electrical.Branches.PwLine          L4(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,6},{
                  50,14}})));
        Electrical.Branches.PwLine          L5(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,-54},
                  {50,-46}})));
        Electrical.Branches.PwLine          L6(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,-94},
                  {50,-86}})));
        Modelica.Blocks.Interfaces.RealOutput OUT39
          annotation (Placement(transformation(extent={{206,-90},{226,-70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT40
          annotation (Placement(transformation(extent={{208,-108},{228,-88}})));
        Modelica.Blocks.Interfaces.RealOutput OUT41
          annotation (Placement(transformation(extent={{224,70},{244,90}})));
        Modelica.Blocks.Sources.Sine sine(
          amplitude=0,
          f=1/260,
          phase=3.1415926535898,
          startTime=1000)
          annotation (Placement(transformation(extent={{68,-36},{78,-26}})));
        Electrical.Loads.NoiseInjections.WhiteNoiseInjection whiteNoiseInjection(
            active_sigma=0.0000000000000001,
                                       samplePeriod=0.01)
          annotation (Placement(transformation(extent={{66,-18},{78,-6}})));
        Modelica.Blocks.Math.Add add
          annotation (Placement(transformation(extent={{84,-18},{92,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT42
          annotation (Placement(transformation(extent={{224,50},{244,70}})));
      equation

      OUT1 = G2.gen.w;
      OUT2 = G2.gen.delta;
      OUT3 = G2.gen.Epq;
      OUT4 = G2.gen.PSIkd;
      OUT5 = G2.gen.PSIppq;
      OUT6 = G2.sEXSMPC.simpleLagLim.state;
      OUT7 = G2.sEXSMPC.leadLag.TF.x_scaled[1];
      OUT8 = G2.gASTMPC.simpleLagLim.state;
      OUT9 = G2.gASTMPC.simpleLag.state;
      OUT10 = G2.gASTMPC.simpleLag1.state;
      OUT11 = PV.rEGCA1_1.simpleLag.state;
      OUT12 = PV.rEGCA1_1.integrator.y;
      OUT13 = PV.rEGCA1_1.integrator1.y;
      OUT14 =PV.EC.IGQ.y;
      OUT15 =PV.EC.IGV.y;
      OUT16 =PV.EC.simpleLag.state;
      OUT17 =PV.EC.simpleLag1.state;
      OUT18 =PV.EC.simpleLag2.state;
      OUT19 =PV.EC.IGP.y;
      OUT20 =PV.EC.simpleLag3.state;
      OUT21 =PV.EC.simpleLag5.state;
      OUT22 = PV.EC.simpleLag4.state;
      OUT23 = BESS.rEGCA1_1.simpleLag.state;
      OUT24 = BESS.rEGCA1_1.integrator.y;
      OUT25 = BESS.rEGCA1_1.integrator1.y;
      OUT26 =BESS.EC.integrator3.y;
      OUT27 =BESS.EC.simpleLag.state;
      OUT28 =BESS.EC.IGQ.y;
      OUT29 =BESS.EC.IGV.y;
      OUT30 =BESS.EC.IGP.y;
      OUT31 =BESS.EC.simpleLag1.state;
      OUT32 =BESS.EC.simpleLag2.state;
      OUT33 =BESS.EC.simpleLag3.state;
      OUT34 =BESS.EC.simpleLag4.state;
      OUT35 = G2.gen.PMECH;
      OUT36 = G2.sEXSMPC.EFD;
      OUT37 = BESS.rEGCA1_1.Pgen;
      OUT38 = BESS.rEGCA1_1.Qgen;
      OUT39 = PV.rEGCA1_1.Pgen;
      OUT40 = PV.rEGCA1_1.Qgen;
      OUT41 = Bus5.v;
      OUT42 = Bus5.angle;

        connect(T1.p, Bus2.p)
          annotation (Line(points={{-51.2,80},{-40,80}}, color={0,0,255}));
        connect(Bus1.p, T1.n)
          annotation (Line(points={{-80,80},{-68.8,80}}, color={0,0,255}));
        connect(G1.conn, Bus1.p)
          annotation (Line(points={{-91,80},{-80,80}}, color={0,0,255}));
        connect(L1.n, Bus3.p)
          annotation (Line(points={{-14.6,80},{0,80}}, color={0,0,255}));
        connect(L1.p, Bus2.p)
          annotation (Line(points={{-25.4,80},{-40,80}}, color={0,0,255}));
        connect(L2_2.n, Bus4.p) annotation (Line(points={{35.4,70},{44,70},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.n, Bus4.p) annotation (Line(points={{35.4,90},{44,90},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.p, Bus3.p) annotation (Line(points={{24.6,90},{16,90},{16,80},{0,
                80}}, color={0,0,255}));
        connect(L2_2.p, Bus3.p) annotation (Line(points={{24.6,70},{16,70},{16,80},{0,
                80}}, color={0,0,255}));
        connect(Load1.p, Bus3.p)
          annotation (Line(points={{-10,68},{-10,80},{0,80}}, color={0,0,255}));
        connect(L3.p, Bus4.p)
          annotation (Line(points={{80,65.4},{80,80},{60,80}}, color={0,0,255}));
        connect(breaker.s, Bus5.p)
          annotation (Line(points={{80,22},{80,16}},color={0,0,255}));
        connect(breaker.r, L3.n)
          annotation (Line(points={{80,30},{80,54.6}},color={0,0,255}));
        connect(IN11.y, AddU1.u2) annotation (Line(points={{-95.4,4},{-82,4}},
                            color={0,0,127}));
        connect(IN1, AddU1.u1) annotation (Line(points={{-150,10},{-116,10},{-116,16},
                {-82,16}},
                       color={0,0,127}));

        connect(IN22.y,AddU2. u2) annotation (Line(points={{-95.4,-26},{-82,-26}},
                       color={0,0,127}));
        connect(IN2,AddU2. u1) annotation (Line(points={{-150,-12},{-118,-12},{-118,-14},
                {-82,-14}},
                       color={0,0,127}));
        connect(AddU2.y, G2.Efd_ref)
          annotation (Line(points={{-59,-20},{-52,-20},{-52,4},{-42,4}},
                                                                 color={0,0,127}));
        connect(AddU1.y, G2.P_ref1) annotation (Line(points={{-59,10},{-52,10},{-52,16},
                {-42,16}},                          color={0,0,127}));
        connect(IB.p, Bus4.p)
          annotation (Line(points={{100,80},{60,80}}, color={0,0,255}));
        connect(Load2.p, Bus5.p) annotation (Line(points={{110,-10},{110,10},{80,10},{
                80,16}},
                     color={0,0,255}));
        connect(T4.n, Bus10.p)
          annotation (Line(points={{-1,-90},{-10,-90}}, color={0,0,255}));
        connect(Bus6.p, T2.n)
          annotation (Line(points={{-10,10},{-1,10}},
                                                  color={0,0,255}));
        connect(AddU3.y, PV.QINPUT) annotation (Line(points={{-59,-50},{-42,-50}},
                                 color={0,0,127}));
        connect(IN33.y,AddU3. u2)
          annotation (Line(points={{-95.4,-56},{-82,-56}}, color={0,0,127}));
        connect(BESS.p1, Bus10.p)
          annotation (Line(points={{-20,-90},{-10,-90}}, color={0,0,255}));
        connect(BESS.Paux1, AddU4.y) annotation (Line(points={{-42,-84},{-54,-84},{-54,
                -80},{-59,-80}}, color={0,0,127}));
        connect(IN55.y, AddU5.u2)
          annotation (Line(points={{-95.4,-112},{-82,-112}}, color={0,0,127}));
        connect(AddU5.y, BESS.Qext1) annotation (Line(points={{-59,-106},{-52,-106},{-52,
                -96},{-42,-96}},   color={0,0,127}));
        connect(IN44.y, AddU4.u2)
          annotation (Line(points={{-95.4,-86},{-82,-86}}, color={0,0,127}));
        connect(AddU4.u1,IN4)  annotation (Line(points={{-82,-74},{-100,-74},{-100,-70},
                {-116,-70},{-116,-56},{-150,-56}}, color={0,0,127}));
        connect(AddU5.u1,IN5)  annotation (Line(points={{-82,-100},{-116,-100},{-116,-78},
                {-150,-78}}, color={0,0,127}));
        connect(G2.conn, Bus6.p) annotation (Line(points={{-19,10},{-10,10}},
                                           color={0,0,255}));
        connect(AddU3.u1, IN3) annotation (Line(points={{-82,-44},{-118,-44},{-118,-34},
                {-150,-34}}, color={0,0,127}));
        connect(PV.p1, Bus8.p)
          annotation (Line(points={{-20,-50},{-10,-50}}, color={0,0,255}));
        connect(Bus8.p, T3.n)
          annotation (Line(points={{-10,-50},{1,-50}},  color={0,0,255}));
        connect(T2.p, Bus7.p) annotation (Line(points={{21,10},{25.5,10},{25.5,10},{30,
                10}}, color={0,0,255}));
        connect(T3.p, Bus9.p)
          annotation (Line(points={{23,-50},{30,-50}}, color={0,0,255}));
        connect(T4.p, Bus11.p)
          annotation (Line(points={{21,-90},{30,-90}}, color={0,0,255}));
        connect(L4.n, Bus5.p) annotation (Line(points={{49.4,10},{60,10},{60,10},{80,10},
                {80,16}},     color={0,0,255}));
        connect(L5.n, Bus5.p) annotation (Line(points={{49.4,-50},{60,-50},{60,10},{80,
                10},{80,16}}, color={0,0,255}));
        connect(Bus11.p, L6.p)
          annotation (Line(points={{30,-90},{38.6,-90}}, color={0,0,255}));
        connect(Bus9.p, L5.p)
          annotation (Line(points={{30,-50},{38.6,-50}}, color={0,0,255}));
        connect(L6.n, Bus5.p) annotation (Line(points={{49.4,-90},{60,-90},{60,10},{80,
                10},{80,16}}, color={0,0,255}));
        connect(Bus7.p, L4.p) annotation (Line(points={{30,10},{34.3,10},{34.3,10},{38.6,
                10}}, color={0,0,255}));
        connect(sine.y, add.u2) annotation (Line(points={{78.5,-31},{78.5,-16.4},
                {83.2,-16.4}}, color={0,0,127}));
        connect(whiteNoiseInjection.y, add.u1) annotation (Line(points={{78.54,
                -12.06},{80.87,-12.06},{80.87,-11.6},{83.2,-11.6}}, color={0,0,
                127}));
        connect(add.y, Load2.u) annotation (Line(points={{92.4,-14},{97.15,-14},
                {97.15,-14.5},{101.9,-14.5}}, color={0,0,127}));
          annotation (Placement(transformation(extent={{140,-20},{160,0}})),
                      Placement(transformation(extent={{140,-40},{160,-20}})),
                      Placement(transformation(extent={{140,-60},{160,-40}})),
                      Placement(transformation(extent={{140,-80},{160,-60}})),
                     Diagram(coordinateSystem(preserveAspectRatio=false,
                extent={{-140,-140},{140,140}}), graphics={
              Rectangle(
                extent={{130,98},{254,-124}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Rectangle(
                extent={{-160,30},{-134,-90}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,36},{124,-124}},
                lineColor={238,46,47},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,98},{124,38}},
                lineColor={0,128,255},
                lineThickness=0.5),
              Text(
                extent={{78,-106},{114,-120}},
                textColor={238,46,47},
                textString="Microgrid"),
              Text(
                extent={{76,58},{128,34}},
                textColor={28,108,200},
                textString="Utility Grid"),
              Text(
                extent={{-30,-102},{34,-124}},
                textColor={0,140,72},
                textString="Linearization Unit"),
              Text(
                extent={{-164,50},{-132,30}},
                textColor={0,140,72},
                textString="Inputs"),
              Text(
                extent={{128,118},{168,98}},
                textColor={0,140,72},
                textString="Outputs")}),
          Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),experiment(StopTime=10, __Dymola_Algorithm="Dassl"),
          Icon(coordinateSystem(extent={{-140,-140},{140,140}})));
      end MPCAppliedEnergyLinearized;

      model MPCAppliedEnergyLinearized_rootlocus
        "THIS ONE IS STABLE, CONTROLLABLE, OBSERVABLE!!!!!!!"
        extends Modelica.Icons.Example;

        parameter Boolean equivalentGRID = true;
        parameter Boolean equivalentsystem = false;

        OpenIPSL.Electrical.Buses.Bus Bus1(v_0=powerFlow.powerflow.bus.V1, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-90,70},{-70,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus2(v_0=powerFlow.powerflow.bus.V2, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-50,70},{-30,90}})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
          R=0.001,
          X=0.2,
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000)  if not equivalentGRID annotation (Placement(transformation(
              extent={{-8,-8},{8,8}},
              rotation=180,
              origin={-60,80})));
        OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
          enableV_b=true,
          v_0=powerFlow.powerflow.bus.V1,
          angle_0=powerFlow.powerflow.bus.A1,
          P_0=powerFlow.powerflow.machines.PG1,
          Q_0=powerFlow.powerflow.machines.QG1,
          V_b=6000)  if not equivalentGRID
          annotation (Placement(transformation(extent={{-112,70},{-92,90}})));
        OpenIPSL.Electrical.Branches.PwLine L1(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{-26,76},
                  {-14,84}})));
        OpenIPSL.Electrical.Buses.Bus Bus3(v_0=powerFlow.powerflow.bus.V3, angle_0=
              powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-10,70},{10,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus4(v_0=powerFlow.powerflow.bus.V4, angle_0=
              powerFlow.powerflow.bus.V4) if not equivalentGRID
          annotation (Placement(transformation(extent={{50,70},{70,90}})));
        OpenIPSL.Electrical.Branches.PwLine L2_1(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,86},
                  {36,94}})));
        OpenIPSL.Electrical.Branches.PwLine L2_2(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,66},
                  {36,74}})));
        OpenIPSL.Electrical.Buses.Bus Bus5(angle_0=powerFlow.powerflow.bus.A5, v_0=
              powerFlow.powerflow.bus.V5)  annotation (Placement(
              transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={80,16})));
        OpenIPSL.Electrical.Branches.PwLine L3(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=-90,
              origin={80,60})));
        OpenIPSL.Electrical.Buses.Bus Bus6(v_0=powerFlow.powerflow.bus.V6, angle_0=
              powerFlow.powerflow.bus.A6) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,10})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000,
          R=0.005,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={10,10})));
        GenerationUnits.PSSE.G2_16MVA                         G2(
          enableV_b=true,
          enableP_0=true,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V6,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A6,
          V_b=6000,
          P_0=powerFlow.powerflow.machines.PG2,
          Q_0=powerFlow.powerflow.machines.QG2,
          enableangle_0=true)
                        annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-30,10})));
        inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000, fn=60)
          annotation (Placement(transformation(extent={{-128,104},{-74,124}})));
        OpenIPSL.Electrical.Loads.PSSE.Load Load1(
          V_b=220000,
          P_0=powerFlow.powerflow.loads.PL1,
          Q_0=powerFlow.powerflow.loads.QL1,
          v_0=powerFlow.powerflow.bus.V3,
          angle_0=powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-20,48},{0,68}})));
        Electrical.Events.Breaker breaker(enableTrigger=false,
          t_o=50.0,
          rc_enabled=true,
          t_rc=80.01)       if not equivalentGRID                     annotation (Placement(transformation(
              extent={{-4,-4},{4,4}},
              rotation=90,
              origin={80,26})));

        Modelica.Blocks.Sources.Constant IN11(k=0)
          annotation (Placement(transformation(extent={{-108,-2},{-96,10}})));
        Modelica.Blocks.Math.Add AddU1
          annotation (Placement(transformation(extent={{-80,0},{-60,20}})));
        Modelica.Blocks.Sources.Constant IN22(k=0)
          annotation (Placement(transformation(extent={{-108,-32},{-96,-20}})));
        Modelica.Blocks.Math.Add AddU2
          annotation (Placement(transformation(extent={{-80,-30},{-60,-10}})));

        PFData.PowerFlow powerFlow(redeclare record PowerFlow =
              OpenIPSL.Examples.ModelPredictiveControl.PFData.PF16)
          annotation (Placement(transformation(extent={{-68,104},{-48,124}})));
        Electrical.Machines.PSSE.GENCLS IB(
          V_b=220000,
          v_0=powerFlow.powerflow.bus.V4,
          angle_0=powerFlow.powerflow.bus.A4,
          P_0=powerFlow.powerflow.machines.Pinf,
          Q_0=powerFlow.powerflow.machines.Qinf,
          M_b=100000000,
          X_d=1) if not equivalentGRID annotation (Placement(transformation(extent={{110,70},
                  {100,90}})));
        Electrical.Loads.PSSE.Load_ExtInput Load2(
          P_0=powerFlow.powerflow.loads.PL2,
          Q_0=powerFlow.powerflow.loads.QL2,
          v_0=powerFlow.powerflow.bus.V5,
          angle_0=powerFlow.powerflow.bus.A5,
          d_P=0,
          t1=100,
          d_t=1000)
          annotation (Placement(transformation(extent={{100,-30},{120,-10}})));

        inner Modelica.Blocks.Noise.GlobalSeed globalSeed(useAutomaticSeed=false,
            fixedSeed=10000)
          annotation (Placement(transformation(extent={{-42,102},{-22,122}})));
        Modelica.Blocks.Sources.Sine sine(
          amplitude=0,
          f=1/260,
          phase=3.1415926535898,
          startTime=1000)
          annotation (Placement(transformation(extent={{82,-20},{92,-10}})));

        Electrical.Buses.Bus Bus10(v_0=powerFlow.powerflow.bus.V10, angle_0=powerFlow.powerflow.bus.A10)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,-90})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T4(
          G=0,
          B=0,
          CW=1,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={10,-90})));
        GenerationUnits.PSSE.Solar_Units.SolarMPCLocalVQControl PV(
          V_b=480,
          P_0=powerFlow.powerflow.machines.PPV,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QPV,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V8,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A8,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-60},{-20,-40}})));
        Modelica.Blocks.Math.Add AddU3
          annotation (Placement(transformation(extent={{-80,-60},{-60,-40}})));
        Modelica.Blocks.Sources.Constant IN33(k=0)
          annotation (Placement(transformation(extent={{-108,-62},{-96,-50}})));

        Modelica.Blocks.Math.Add AddU4
          annotation (Placement(transformation(extent={{-80,-90},{-60,-70}})));
        Modelica.Blocks.Math.Add AddU5
          annotation (Placement(transformation(extent={{-80,-116},{-60,-96}})));
        Modelica.Blocks.Sources.Constant IN44(k=0)
          annotation (Placement(transformation(extent={{-108,-92},{-96,-80}})));
        Modelica.Blocks.Sources.Constant IN55(k=0)
          annotation (Placement(transformation(extent={{-108,-118},{-96,-106}})));
        GenerationUnits.PSSE.Battery_Units.BESSMPCLocalVQControlLinearized
                                                                 BESS(
          V_base=480,
          V_b(displayUnit="kV") = 480,
          enableV_b=true,
          P_0=powerFlow.powerflow.machines.PBESS,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QBESS,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V10,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A10,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-100},{-20,-80}})));
        Electrical.Buses.Bus Bus8(v_0=powerFlow.powerflow.bus.V8, angle_0=powerFlow.powerflow.bus.A8)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,-50})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T3(
          G=0,
          B=0,
          CW=1,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={12,-50})));
        Electrical.Buses.Bus Bus11(v_0=powerFlow.powerflow.bus.V11, angle_0=powerFlow.powerflow.bus.A11)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,-90})));
        Electrical.Buses.Bus Bus9(v_0=powerFlow.powerflow.bus.V9, angle_0=powerFlow.powerflow.bus.A9)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,-50})));
        Electrical.Buses.Bus Bus7(v_0=powerFlow.powerflow.bus.V7, angle_0=powerFlow.powerflow.bus.A7)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,10})));
        Electrical.Branches.PwLine          L4(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,6},{
                  50,14}})));
        Electrical.Branches.PwLine          L5(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,-54},
                  {50,-46}})));
        Electrical.Branches.PwLine          L6(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,-94},
                  {50,-86}})));
      equation

        connect(T1.p, Bus2.p)
          annotation (Line(points={{-51.2,80},{-40,80}}, color={0,0,255}));
        connect(Bus1.p, T1.n)
          annotation (Line(points={{-80,80},{-68.8,80}}, color={0,0,255}));
        connect(G1.conn, Bus1.p)
          annotation (Line(points={{-91,80},{-80,80}}, color={0,0,255}));
        connect(L1.n, Bus3.p)
          annotation (Line(points={{-14.6,80},{0,80}}, color={0,0,255}));
        connect(L1.p, Bus2.p)
          annotation (Line(points={{-25.4,80},{-40,80}}, color={0,0,255}));
        connect(L2_2.n, Bus4.p) annotation (Line(points={{35.4,70},{44,70},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.n, Bus4.p) annotation (Line(points={{35.4,90},{44,90},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.p, Bus3.p) annotation (Line(points={{24.6,90},{16,90},{16,80},{0,
                80}}, color={0,0,255}));
        connect(L2_2.p, Bus3.p) annotation (Line(points={{24.6,70},{16,70},{16,80},{0,
                80}}, color={0,0,255}));
        connect(Load1.p, Bus3.p)
          annotation (Line(points={{-10,68},{-10,80},{0,80}}, color={0,0,255}));
        connect(L3.p, Bus4.p)
          annotation (Line(points={{80,65.4},{80,80},{60,80}}, color={0,0,255}));
        connect(breaker.s, Bus5.p)
          annotation (Line(points={{80,22},{80,16}},color={0,0,255}));
        connect(breaker.r, L3.n)
          annotation (Line(points={{80,30},{80,54.6}},color={0,0,255}));
        connect(IN11.y, AddU1.u2) annotation (Line(points={{-95.4,4},{-82,4}},
                            color={0,0,127}));

        connect(IN22.y,AddU2. u2) annotation (Line(points={{-95.4,-26},{-82,-26}},
                       color={0,0,127}));
        connect(AddU2.y, G2.Efd_ref)
          annotation (Line(points={{-59,-20},{-52,-20},{-52,4},{-42,4}},
                                                                 color={0,0,127}));
        connect(AddU1.y, G2.P_ref1) annotation (Line(points={{-59,10},{-52,10},{-52,16},
                {-42,16}},                          color={0,0,127}));
        connect(IB.p, Bus4.p)
          annotation (Line(points={{100,80},{60,80}}, color={0,0,255}));
        connect(Load2.p, Bus5.p) annotation (Line(points={{110,-10},{110,10},{80,10},{
                80,16}},
                     color={0,0,255}));
        connect(T4.n, Bus10.p)
          annotation (Line(points={{-1,-90},{-10,-90}}, color={0,0,255}));
        connect(Bus6.p, T2.n)
          annotation (Line(points={{-10,10},{-1,10}},
                                                  color={0,0,255}));
        connect(AddU3.y, PV.QINPUT) annotation (Line(points={{-59,-50},{-42,-50}},
                                 color={0,0,127}));
        connect(IN33.y,AddU3. u2)
          annotation (Line(points={{-95.4,-56},{-82,-56}}, color={0,0,127}));
        connect(BESS.p1, Bus10.p)
          annotation (Line(points={{-20,-90},{-10,-90}}, color={0,0,255}));
        connect(BESS.Paux1, AddU4.y) annotation (Line(points={{-42,-84},{-54,-84},{-54,
                -80},{-59,-80}}, color={0,0,127}));
        connect(IN55.y, AddU5.u2)
          annotation (Line(points={{-95.4,-112},{-82,-112}}, color={0,0,127}));
        connect(AddU5.y, BESS.Qext1) annotation (Line(points={{-59,-106},{-52,-106},{-52,
                -96},{-42,-96}},   color={0,0,127}));
        connect(IN44.y, AddU4.u2)
          annotation (Line(points={{-95.4,-86},{-82,-86}}, color={0,0,127}));
        connect(G2.conn, Bus6.p) annotation (Line(points={{-19,10},{-10,10}},
                                           color={0,0,255}));
        connect(PV.p1, Bus8.p)
          annotation (Line(points={{-20,-50},{-10,-50}}, color={0,0,255}));
        connect(Bus8.p, T3.n)
          annotation (Line(points={{-10,-50},{1,-50}},  color={0,0,255}));
        connect(sine.y, Load2.u) annotation (Line(points={{92.5,-15},{96.1,-15},{96.1,
                -14.5},{101.9,-14.5}}, color={0,0,127}));
        connect(T2.p, Bus7.p) annotation (Line(points={{21,10},{25.5,10},{25.5,10},{30,
                10}}, color={0,0,255}));
        connect(T3.p, Bus9.p)
          annotation (Line(points={{23,-50},{30,-50}}, color={0,0,255}));
        connect(T4.p, Bus11.p)
          annotation (Line(points={{21,-90},{30,-90}}, color={0,0,255}));
        connect(L4.n, Bus5.p) annotation (Line(points={{49.4,10},{60,10},{60,10},{80,10},
                {80,16}},     color={0,0,255}));
        connect(L5.n, Bus5.p) annotation (Line(points={{49.4,-50},{60,-50},{60,10},{80,
                10},{80,16}}, color={0,0,255}));
        connect(Bus11.p, L6.p)
          annotation (Line(points={{30,-90},{38.6,-90}}, color={0,0,255}));
        connect(Bus9.p, L5.p)
          annotation (Line(points={{30,-50},{38.6,-50}}, color={0,0,255}));
        connect(L6.n, Bus5.p) annotation (Line(points={{49.4,-90},{60,-90},{60,10},{80,
                10},{80,16}}, color={0,0,255}));
        connect(Bus7.p, L4.p) annotation (Line(points={{30,10},{34.3,10},{34.3,10},{38.6,
                10}}, color={0,0,255}));
        connect(AddU1.u1, AddU1.u2) annotation (Line(points={{-82,16},{-86,16},{-86,4},
                {-82,4}}, color={0,0,127}));
        connect(AddU2.u1, AddU2.u2) annotation (Line(points={{-82,-14},{-86,-14},{-86,
                -26},{-82,-26}}, color={0,0,127}));
        connect(AddU3.u1, AddU3.u2) annotation (Line(points={{-82,-44},{-86,-44},{-86,
                -56},{-82,-56}}, color={0,0,127}));
        connect(AddU4.u1, AddU4.u2) annotation (Line(points={{-82,-74},{-86,-74},{-86,
                -86},{-82,-86}}, color={0,0,127}));
        connect(AddU5.u1, AddU5.u2) annotation (Line(points={{-82,-100},{-86,-100},{-86,
                -112},{-82,-112}}, color={0,0,127}));
          annotation (Placement(transformation(extent={{140,-20},{160,0}})),
                      Placement(transformation(extent={{140,-40},{160,-20}})),
                      Placement(transformation(extent={{140,-60},{160,-40}})),
                      Placement(transformation(extent={{140,-80},{160,-60}})),
                     Diagram(coordinateSystem(preserveAspectRatio=false,
                extent={{-140,-140},{140,140}}), graphics={
              Rectangle(
                extent={{-128,36},{124,-124}},
                lineColor={238,46,47},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,98},{124,38}},
                lineColor={0,128,255},
                lineThickness=0.5),
              Text(
                extent={{78,-106},{114,-120}},
                textColor={238,46,47},
                textString="Microgrid"),
              Text(
                extent={{76,58},{128,34}},
                textColor={28,108,200},
                textString="Utility Grid"),
              Text(
                extent={{-30,-102},{34,-124}},
                textColor={0,140,72},
                textString="Linearization Unit")}),
          Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),experiment(StopTime=10, __Dymola_Algorithm="Dassl"),
          Icon(coordinateSystem(extent={{-140,-140},{140,140}})));
      end MPCAppliedEnergyLinearized_rootlocus;

      model MPCAppliedEnergyLinearized_step
        "THIS ONE IS STABLE, CONTROLLABLE, OBSERVABLE!!!!!!!"
        extends Modelica.Icons.Example;

        parameter Boolean equivalentGRID = false;
        parameter Boolean equivalentsystem = false;

        OpenIPSL.Electrical.Buses.Bus Bus1(v_0=powerFlow.powerflow.bus.V1, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-90,70},{-70,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus2(v_0=powerFlow.powerflow.bus.V2, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-50,70},{-30,90}})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
          R=0.001,
          X=0.2,
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000)  if not equivalentGRID annotation (Placement(transformation(
              extent={{-8,-8},{8,8}},
              rotation=180,
              origin={-60,80})));
        OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
          enableV_b=true,
          v_0=powerFlow.powerflow.bus.V1,
          angle_0=powerFlow.powerflow.bus.A1,
          P_0=powerFlow.powerflow.machines.PG1,
          Q_0=powerFlow.powerflow.machines.QG1,
          V_b=6000)  if not equivalentGRID
          annotation (Placement(transformation(extent={{-112,70},{-92,90}})));
        OpenIPSL.Electrical.Branches.PwLine L1(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{-26,76},
                  {-14,84}})));
        OpenIPSL.Electrical.Buses.Bus Bus3(v_0=powerFlow.powerflow.bus.V3, angle_0=
              powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-10,70},{10,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus4(v_0=powerFlow.powerflow.bus.V4, angle_0=
              powerFlow.powerflow.bus.V4) if not equivalentGRID
          annotation (Placement(transformation(extent={{50,70},{70,90}})));
        OpenIPSL.Electrical.Branches.PwLine L2_1(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,86},
                  {36,94}})));
        OpenIPSL.Electrical.Branches.PwLine L2_2(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,66},
                  {36,74}})));
        OpenIPSL.Electrical.Buses.Bus Bus5(angle_0=powerFlow.powerflow.bus.A5, v_0=
              powerFlow.powerflow.bus.V5)  annotation (Placement(
              transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={80,16})));
        OpenIPSL.Electrical.Branches.PwLine L3(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=-90,
              origin={80,60})));
        OpenIPSL.Electrical.Buses.Bus Bus6(v_0=powerFlow.powerflow.bus.V6, angle_0=
              powerFlow.powerflow.bus.A6) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,10})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000,
          R=0.005,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={10,10})));
        GenerationUnits.PSSE.G2_16MVA                         G2(
          enableV_b=true,
          enableP_0=true,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V6,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A6,
          V_b=6000,
          P_0=powerFlow.powerflow.machines.PG2,
          Q_0=powerFlow.powerflow.machines.QG2,
          enableangle_0=true)
                        annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-30,10})));
        inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000, fn=60)
          annotation (Placement(transformation(extent={{-128,104},{-74,124}})));
        OpenIPSL.Electrical.Loads.PSSE.Load Load1(
          V_b=220000,
          P_0=powerFlow.powerflow.loads.PL1,
          Q_0=powerFlow.powerflow.loads.QL1,
          v_0=powerFlow.powerflow.bus.V3,
          angle_0=powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-20,48},{0,68}})));
        Electrical.Events.Breaker breaker(enableTrigger=false,
          t_o=1.01,
          rc_enabled=true,
          t_rc=80.01)       if not equivalentGRID                     annotation (Placement(transformation(
              extent={{-4,-4},{4,4}},
              rotation=90,
              origin={80,26})));

        Modelica.Blocks.Sources.Constant IN11(k=0)
          annotation (Placement(transformation(extent={{-108,-2},{-96,10}})));
        Modelica.Blocks.Math.Add AddU1
          annotation (Placement(transformation(extent={{-80,0},{-60,20}})));
        Modelica.Blocks.Sources.Constant IN22(k=0)
          annotation (Placement(transformation(extent={{-108,-32},{-96,-20}})));
        Modelica.Blocks.Math.Add AddU2
          annotation (Placement(transformation(extent={{-80,-30},{-60,-10}})));

        Modelica.Blocks.Interfaces.RealOutput OUT1
          annotation (Placement(transformation(extent={{140,70},{160,90}})));
       Modelica.Blocks.Interfaces.RealOutput OUT2
          annotation (Placement(transformation(extent={{140,50},{160,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT3
          annotation (Placement(transformation(extent={{140,30},{160,50}})));

        PFData.PowerFlow powerFlow(redeclare record PowerFlow =
              OpenIPSL.Examples.ModelPredictiveControl.PFData.PF16)
          annotation (Placement(transformation(extent={{-68,104},{-48,124}})));
        Electrical.Machines.PSSE.GENCLS IB(
          V_b=220000,
          v_0=powerFlow.powerflow.bus.V4,
          angle_0=powerFlow.powerflow.bus.A4,
          P_0=powerFlow.powerflow.machines.Pinf,
          Q_0=powerFlow.powerflow.machines.Qinf,
          M_b=100000000,
          X_d=1) if not equivalentGRID annotation (Placement(transformation(extent={{110,70},
                  {100,90}})));
        Electrical.Loads.PSSE.Load_ExtInput Load2(
          P_0=powerFlow.powerflow.loads.PL2,
          Q_0=powerFlow.powerflow.loads.QL2,
          v_0=powerFlow.powerflow.bus.V5,
          angle_0=powerFlow.powerflow.bus.A5,
          d_P=0,
          t1=100,
          d_t=1000)
          annotation (Placement(transformation(extent={{100,-30},{120,-10}})));

        inner Modelica.Blocks.Noise.GlobalSeed globalSeed(useAutomaticSeed=false,
            fixedSeed=10000)
          annotation (Placement(transformation(extent={{-42,102},{-22,122}})));
        Modelica.Blocks.Sources.Sine sine(
          amplitude=0,
          f=1/260,
          phase=3.1415926535898,
          startTime=1000)
          annotation (Placement(transformation(extent={{82,-20},{92,-10}})));

        Electrical.Buses.Bus Bus10(v_0=powerFlow.powerflow.bus.V10, angle_0=powerFlow.powerflow.bus.A10)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,-90})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T4(
          G=0,
          B=0,
          CW=1,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={10,-90})));
        GenerationUnits.PSSE.Solar_Units.SolarMPCLocalVQControl PV(
          V_b=480,
          P_0=powerFlow.powerflow.machines.PPV,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QPV,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V8,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A8,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-60},{-20,-40}})));
        Modelica.Blocks.Math.Add AddU3
          annotation (Placement(transformation(extent={{-80,-60},{-60,-40}})));
        Modelica.Blocks.Sources.Constant IN33(k=0)
          annotation (Placement(transformation(extent={{-108,-62},{-96,-50}})));

        Modelica.Blocks.Math.Add AddU4
          annotation (Placement(transformation(extent={{-80,-90},{-60,-70}})));
        Modelica.Blocks.Math.Add AddU5
          annotation (Placement(transformation(extent={{-80,-116},{-60,-96}})));
        Modelica.Blocks.Sources.Constant IN44(k=0)
          annotation (Placement(transformation(extent={{-108,-92},{-96,-80}})));
        Modelica.Blocks.Sources.Constant IN55(k=0)
          annotation (Placement(transformation(extent={{-108,-118},{-96,-106}})));
        Modelica.Blocks.Interfaces.RealOutput OUT4
          annotation (Placement(transformation(extent={{140,10},{160,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT5
          annotation (Placement(transformation(extent={{140,-10},{160,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT6
          annotation (Placement(transformation(extent={{140,-30},{160,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT7
          annotation (Placement(transformation(extent={{140,-50},{160,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT8
          annotation (Placement(transformation(extent={{140,-70},{160,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT9
          annotation (Placement(transformation(extent={{140,-90},{160,-70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT10
          annotation (Placement(transformation(extent={{140,-110},{160,-90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT11
          annotation (Placement(transformation(extent={{164,70},{184,90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT12
          annotation (Placement(transformation(extent={{164,50},{184,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT13
          annotation (Placement(transformation(extent={{164,30},{184,50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT14
          annotation (Placement(transformation(extent={{164,10},{184,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT15
          annotation (Placement(transformation(extent={{164,-10},{184,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT16
          annotation (Placement(transformation(extent={{164,-30},{184,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT17
          annotation (Placement(transformation(extent={{164,-50},{184,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT18
          annotation (Placement(transformation(extent={{164,-70},{184,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT19
          annotation (Placement(transformation(extent={{164,-90},{184,-70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT20
          annotation (Placement(transformation(extent={{164,-110},{184,-90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT21
          annotation (Placement(transformation(extent={{184,70},{204,90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT22
          annotation (Placement(transformation(extent={{184,50},{204,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT23
          annotation (Placement(transformation(extent={{184,30},{204,50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT24
          annotation (Placement(transformation(extent={{184,10},{204,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT25
          annotation (Placement(transformation(extent={{184,-10},{204,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT26
          annotation (Placement(transformation(extent={{184,-30},{204,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT27
          annotation (Placement(transformation(extent={{184,-50},{204,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT28
          annotation (Placement(transformation(extent={{184,-70},{204,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT29
          annotation (Placement(transformation(extent={{184,-90},{204,-70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT30
          annotation (Placement(transformation(extent={{184,-110},{204,-90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT31
          annotation (Placement(transformation(extent={{204,70},{224,90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT32
          annotation (Placement(transformation(extent={{204,50},{224,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT33
          annotation (Placement(transformation(extent={{204,30},{224,50}})));
        GenerationUnits.PSSE.Battery_Units.BESSMPCLocalVQControlLinearized
                                                                 BESS(
          V_base=480,
          V_b(displayUnit="kV") = 480,
          enableV_b=true,
          P_0=powerFlow.powerflow.machines.PBESS,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QBESS,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V10,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A10,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-100},{-20,-80}})));
        Modelica.Blocks.Interfaces.RealOutput OUT34
          annotation (Placement(transformation(extent={{204,10},{224,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT35
          annotation (Placement(transformation(extent={{206,-10},{226,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT36
          annotation (Placement(transformation(extent={{206,-30},{226,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT37
          annotation (Placement(transformation(extent={{206,-50},{226,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT38
          annotation (Placement(transformation(extent={{206,-70},{226,-50}})));
        Electrical.Buses.Bus Bus8(v_0=powerFlow.powerflow.bus.V8, angle_0=powerFlow.powerflow.bus.A8)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,-50})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T3(
          G=0,
          B=0,
          CW=1,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={12,-50})));
        Electrical.Buses.Bus Bus11(v_0=powerFlow.powerflow.bus.V11, angle_0=powerFlow.powerflow.bus.A11)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,-90})));
        Electrical.Buses.Bus Bus9(v_0=powerFlow.powerflow.bus.V9, angle_0=powerFlow.powerflow.bus.A9)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,-50})));
        Electrical.Buses.Bus Bus7(v_0=powerFlow.powerflow.bus.V7, angle_0=powerFlow.powerflow.bus.A7)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,10})));
        Electrical.Branches.PwLine          L4(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,6},{
                  50,14}})));
        Electrical.Branches.PwLine          L5(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,-54},
                  {50,-46}})));
        Electrical.Branches.PwLine          L6(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,-94},
                  {50,-86}})));
        Modelica.Blocks.Sources.Step     IN1(startTime=20)
          annotation (Placement(transformation(extent={{-152,10},{-140,22}})));
        Modelica.Blocks.Sources.Step     IN2(startTime=100)
          annotation (Placement(transformation(extent={{-152,-20},{-140,-8}})));
        Modelica.Blocks.Sources.Step     IN3(startTime=100)
          annotation (Placement(transformation(extent={{-152,-50},{-140,-38}})));
        Modelica.Blocks.Sources.Step     IN4(startTime=100)
          annotation (Placement(transformation(extent={{-152,-80},{-140,-68}})));
        Modelica.Blocks.Sources.Step     IN5(startTime=100)
          annotation (Placement(transformation(extent={{-152,-106},{-140,-94}})));
      equation

      OUT1 = G2.gen.w;
      OUT2 = G2.gen.delta;
      OUT3 = G2.gen.Epq;
      OUT4 = G2.gen.PSIkd;
      OUT5 = G2.gen.PSIppq;
      OUT6 = G2.sEXSMPC.simpleLagLim.state;
      OUT7 = G2.sEXSMPC.leadLag.TF.x_scaled[1];
      OUT8 = G2.gASTMPC.simpleLagLim.state;
      OUT9 = G2.gASTMPC.simpleLag.state;
      OUT10 = G2.gASTMPC.simpleLag1.state;
      OUT11 = PV.rEGCA1_1.simpleLag.state;
      OUT12 = PV.rEGCA1_1.integrator.y;
      OUT13 = PV.rEGCA1_1.integrator1.y;
      OUT14 =PV.EC.IGQ.y;
      OUT15 =PV.EC.IGV.y;
      OUT16 =PV.EC.simpleLag.state;
      OUT17 =PV.EC.simpleLag1.state;
      OUT18 =PV.EC.simpleLag2.state;
      OUT19 =PV.EC.IGP.y;
      OUT20 =PV.EC.simpleLag3.state;
      OUT21 = BESS.rEGCA1_1.simpleLag.state;
      OUT22 = BESS.rEGCA1_1.integrator.y;
      OUT23 = BESS.rEGCA1_1.integrator1.y;
      OUT24 =BESS.EC.integrator3.y;
      OUT25 =BESS.EC.simpleLag.state;
      OUT26 =BESS.EC.IGQ.y;
      OUT27 =BESS.EC.IGV.y;
      OUT28 =BESS.EC.IGP.y;
      OUT29 =BESS.EC.simpleLag1.state;
      OUT30 =BESS.EC.simpleLag2.state;
      OUT31 = G2.gen.PMECH;
      OUT32 = G2.sEXSMPC.EFD;
      OUT33 = BESS.rEGCA1_1.Pgen;
      OUT34 = BESS.rEGCA1_1.Qgen;
      OUT35 = PV.rEGCA1_1.Pgen;
      OUT36 = PV.rEGCA1_1.Qgen;
      OUT37 = Bus5.v;
      OUT38 = Bus5.angle;

        connect(T1.p, Bus2.p)
          annotation (Line(points={{-51.2,80},{-40,80}}, color={0,0,255}));
        connect(Bus1.p, T1.n)
          annotation (Line(points={{-80,80},{-68.8,80}}, color={0,0,255}));
        connect(G1.conn, Bus1.p)
          annotation (Line(points={{-91,80},{-80,80}}, color={0,0,255}));
        connect(L1.n, Bus3.p)
          annotation (Line(points={{-14.6,80},{0,80}}, color={0,0,255}));
        connect(L1.p, Bus2.p)
          annotation (Line(points={{-25.4,80},{-40,80}}, color={0,0,255}));
        connect(L2_2.n, Bus4.p) annotation (Line(points={{35.4,70},{44,70},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.n, Bus4.p) annotation (Line(points={{35.4,90},{44,90},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.p, Bus3.p) annotation (Line(points={{24.6,90},{16,90},{16,80},{0,
                80}}, color={0,0,255}));
        connect(L2_2.p, Bus3.p) annotation (Line(points={{24.6,70},{16,70},{16,80},{0,
                80}}, color={0,0,255}));
        connect(Load1.p, Bus3.p)
          annotation (Line(points={{-10,68},{-10,80},{0,80}}, color={0,0,255}));
        connect(L3.p, Bus4.p)
          annotation (Line(points={{80,65.4},{80,80},{60,80}}, color={0,0,255}));
        connect(breaker.s, Bus5.p)
          annotation (Line(points={{80,22},{80,16}},color={0,0,255}));
        connect(breaker.r, L3.n)
          annotation (Line(points={{80,30},{80,54.6}},color={0,0,255}));
        connect(IN11.y, AddU1.u2) annotation (Line(points={{-95.4,4},{-82,4}},
                            color={0,0,127}));

        connect(IN22.y,AddU2. u2) annotation (Line(points={{-95.4,-26},{-82,-26}},
                       color={0,0,127}));
        connect(AddU2.y, G2.Efd_ref)
          annotation (Line(points={{-59,-20},{-52,-20},{-52,4},{-42,4}},
                                                                 color={0,0,127}));
        connect(AddU1.y, G2.P_ref1) annotation (Line(points={{-59,10},{-52,10},{-52,16},
                {-42,16}},                          color={0,0,127}));
        connect(IB.p, Bus4.p)
          annotation (Line(points={{100,80},{60,80}}, color={0,0,255}));
        connect(Load2.p, Bus5.p) annotation (Line(points={{110,-10},{110,10},{80,10},{
                80,16}},
                     color={0,0,255}));
        connect(T4.n, Bus10.p)
          annotation (Line(points={{-1,-90},{-10,-90}}, color={0,0,255}));
        connect(Bus6.p, T2.n)
          annotation (Line(points={{-10,10},{-1,10}},
                                                  color={0,0,255}));
        connect(AddU3.y, PV.QINPUT) annotation (Line(points={{-59,-50},{-42,-50}},
                                 color={0,0,127}));
        connect(IN33.y,AddU3. u2)
          annotation (Line(points={{-95.4,-56},{-82,-56}}, color={0,0,127}));
        connect(BESS.p1, Bus10.p)
          annotation (Line(points={{-20,-90},{-10,-90}}, color={0,0,255}));
        connect(BESS.Paux1, AddU4.y) annotation (Line(points={{-42,-84},{-54,-84},{-54,
                -80},{-59,-80}}, color={0,0,127}));
        connect(IN55.y, AddU5.u2)
          annotation (Line(points={{-95.4,-112},{-82,-112}}, color={0,0,127}));
        connect(AddU5.y, BESS.Qext1) annotation (Line(points={{-59,-106},{-52,-106},{-52,
                -96},{-42,-96}},   color={0,0,127}));
        connect(IN44.y, AddU4.u2)
          annotation (Line(points={{-95.4,-86},{-82,-86}}, color={0,0,127}));
        connect(G2.conn, Bus6.p) annotation (Line(points={{-19,10},{-10,10}},
                                           color={0,0,255}));
        connect(PV.p1, Bus8.p)
          annotation (Line(points={{-20,-50},{-10,-50}}, color={0,0,255}));
        connect(Bus8.p, T3.n)
          annotation (Line(points={{-10,-50},{1,-50}},  color={0,0,255}));
        connect(sine.y, Load2.u) annotation (Line(points={{92.5,-15},{96.1,-15},{96.1,
                -14.5},{101.9,-14.5}}, color={0,0,127}));
        connect(T2.p, Bus7.p) annotation (Line(points={{21,10},{25.5,10},{25.5,10},{30,
                10}}, color={0,0,255}));
        connect(T3.p, Bus9.p)
          annotation (Line(points={{23,-50},{30,-50}}, color={0,0,255}));
        connect(T4.p, Bus11.p)
          annotation (Line(points={{21,-90},{30,-90}}, color={0,0,255}));
        connect(L4.n, Bus5.p) annotation (Line(points={{49.4,10},{60,10},{60,10},{80,10},
                {80,16}},     color={0,0,255}));
        connect(L5.n, Bus5.p) annotation (Line(points={{49.4,-50},{60,-50},{60,10},{80,
                10},{80,16}}, color={0,0,255}));
        connect(Bus11.p, L6.p)
          annotation (Line(points={{30,-90},{38.6,-90}}, color={0,0,255}));
        connect(Bus9.p, L5.p)
          annotation (Line(points={{30,-50},{38.6,-50}}, color={0,0,255}));
        connect(L6.n, Bus5.p) annotation (Line(points={{49.4,-90},{60,-90},{60,10},{80,
                10},{80,16}}, color={0,0,255}));
        connect(Bus7.p, L4.p) annotation (Line(points={{30,10},{34.3,10},{34.3,10},{38.6,
                10}}, color={0,0,255}));
        connect(IN1.y, AddU1.u1)
          annotation (Line(points={{-139.4,16},{-82,16}}, color={0,0,127}));
        connect(IN2.y, AddU2.u1)
          annotation (Line(points={{-139.4,-14},{-82,-14}}, color={0,0,127}));
        connect(IN3.y, AddU3.u1)
          annotation (Line(points={{-139.4,-44},{-82,-44}}, color={0,0,127}));
        connect(IN4.y, AddU4.u1)
          annotation (Line(points={{-139.4,-74},{-82,-74}}, color={0,0,127}));
        connect(IN5.y, AddU5.u1) annotation (Line(points={{-139.4,-100},{-82,
                -100}}, color={0,0,127}));
          annotation (Placement(transformation(extent={{140,-20},{160,0}})),
                      Placement(transformation(extent={{140,-40},{160,-20}})),
                      Placement(transformation(extent={{140,-60},{160,-40}})),
                      Placement(transformation(extent={{140,-80},{160,-60}})),
                     Diagram(coordinateSystem(preserveAspectRatio=false,
                extent={{-140,-140},{140,140}}), graphics={
              Rectangle(
                extent={{130,98},{232,-124}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,36},{124,-124}},
                lineColor={238,46,47},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,98},{124,38}},
                lineColor={0,128,255},
                lineThickness=0.5),
              Text(
                extent={{78,-106},{114,-120}},
                textColor={238,46,47},
                textString="Microgrid"),
              Text(
                extent={{76,58},{128,34}},
                textColor={28,108,200},
                textString="Utility Grid"),
              Text(
                extent={{-30,-102},{34,-124}},
                textColor={0,140,72},
                textString="Linearization Unit"),
              Text(
                extent={{-164,50},{-132,30}},
                textColor={0,140,72},
                textString="Inputs"),
              Text(
                extent={{128,118},{168,98}},
                textColor={0,140,72},
                textString="Outputs")}),
          Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),experiment(StopTime=50, __Dymola_Algorithm="Dassl"),
          Icon(coordinateSystem(extent={{-140,-140},{140,140}})));
      end MPCAppliedEnergyLinearized_step;

      model MPCAppliedEnergyLinearized_PYTHON
        "THIS ONE IS STABLE, CONTROLLABLE, OBSERVABLE!!!!!!!"
        extends Modelica.Icons.Example;

        parameter Boolean equivalentGRID = true;
        parameter Boolean equivalentsystem = false;

        OpenIPSL.Electrical.Buses.Bus Bus1(v_0=powerFlow.powerflow.bus.V1, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-90,70},{-70,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus2(v_0=powerFlow.powerflow.bus.V2, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-50,70},{-30,90}})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
          R=0.001,
          X=0.2,
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000)  if not equivalentGRID annotation (Placement(transformation(
              extent={{-8,-8},{8,8}},
              rotation=180,
              origin={-60,80})));
        OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
          enableV_b=true,
          v_0=powerFlow.powerflow.bus.V1,
          angle_0=powerFlow.powerflow.bus.A1,
          P_0=powerFlow.powerflow.machines.PG1,
          Q_0=powerFlow.powerflow.machines.QG1,
          V_b=6000)  if not equivalentGRID
          annotation (Placement(transformation(extent={{-112,70},{-92,90}})));
        OpenIPSL.Electrical.Branches.PwLine L1(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{-26,76},
                  {-14,84}})));
        OpenIPSL.Electrical.Buses.Bus Bus3(v_0=powerFlow.powerflow.bus.V3, angle_0=
              powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-10,70},{10,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus4(v_0=powerFlow.powerflow.bus.V4, angle_0=
              powerFlow.powerflow.bus.V4) if not equivalentGRID
          annotation (Placement(transformation(extent={{50,70},{70,90}})));
        OpenIPSL.Electrical.Branches.PwLine L2_1(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,86},
                  {36,94}})));
        OpenIPSL.Electrical.Branches.PwLine L2_2(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,66},
                  {36,74}})));
        OpenIPSL.Electrical.Buses.Bus Bus5(angle_0=powerFlow.powerflow.bus.A5, v_0=
              powerFlow.powerflow.bus.V5)  annotation (Placement(
              transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={80,16})));
        OpenIPSL.Electrical.Branches.PwLine L3(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=-90,
              origin={80,60})));
        OpenIPSL.Electrical.Buses.Bus Bus6(v_0=powerFlow.powerflow.bus.V6, angle_0=
              powerFlow.powerflow.bus.A6) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,10})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000,
          R=0.005,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={10,10})));
        GenerationUnits.PSSE.G2_16MVA                         G2(
          enableV_b=true,
          enableP_0=true,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V6,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A6,
          V_b=6000,
          P_0=powerFlow.powerflow.machines.PG2,
          Q_0=powerFlow.powerflow.machines.QG2,
          enableangle_0=true)
                        annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-30,10})));
        inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000, fn=60)
          annotation (Placement(transformation(extent={{-128,104},{-74,124}})));
        OpenIPSL.Electrical.Loads.PSSE.Load Load1(
          V_b=220000,
          P_0=powerFlow.powerflow.loads.PL1,
          Q_0=powerFlow.powerflow.loads.QL1,
          v_0=powerFlow.powerflow.bus.V3,
          angle_0=powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-20,48},{0,68}})));
        Electrical.Events.Breaker breaker(enableTrigger=false,
          t_o=1.01,
          rc_enabled=true,
          t_rc=80.01)       if not equivalentGRID                     annotation (Placement(transformation(
              extent={{-4,-4},{4,4}},
              rotation=90,
              origin={80,26})));

        Modelica.Blocks.Sources.Constant IN11(k=0)
          annotation (Placement(transformation(extent={{-108,-2},{-96,10}})));
        Modelica.Blocks.Math.Add AddU1
          annotation (Placement(transformation(extent={{-80,0},{-60,20}})));
        Modelica.Blocks.Sources.Constant IN22(k=0)
          annotation (Placement(transformation(extent={{-108,-32},{-96,-20}})));
        Modelica.Blocks.Math.Add AddU2
          annotation (Placement(transformation(extent={{-80,-30},{-60,-10}})));

        PFData.PowerFlow powerFlow(redeclare record PowerFlow =
              OpenIPSL.Examples.ModelPredictiveControl.PFData.PF16)
          annotation (Placement(transformation(extent={{-68,104},{-48,124}})));
        Electrical.Machines.PSSE.GENCLS IB(
          V_b=220000,
          v_0=powerFlow.powerflow.bus.V4,
          angle_0=powerFlow.powerflow.bus.A4,
          P_0=powerFlow.powerflow.machines.Pinf,
          Q_0=powerFlow.powerflow.machines.Qinf,
          M_b=100000000,
          X_d=1) if not equivalentGRID annotation (Placement(transformation(extent={{110,70},
                  {100,90}})));
        Electrical.Loads.PSSE.Load_ExtInput Load2(
          P_0=powerFlow.powerflow.loads.PL2,
          Q_0=powerFlow.powerflow.loads.QL2,
          v_0=powerFlow.powerflow.bus.V5,
          angle_0=powerFlow.powerflow.bus.A5,
          d_P=0,
          t1=100,
          d_t=1000)
          annotation (Placement(transformation(extent={{100,-30},{120,-10}})));

        inner Modelica.Blocks.Noise.GlobalSeed globalSeed(useAutomaticSeed=false,
            fixedSeed=10000)
          annotation (Placement(transformation(extent={{-42,102},{-22,122}})));
        Modelica.Blocks.Sources.Sine sine(
          amplitude=0,
          f=1/260,
          phase=3.1415926535898,
          startTime=1000)
          annotation (Placement(transformation(extent={{82,-20},{92,-10}})));

        Electrical.Buses.Bus Bus10(v_0=powerFlow.powerflow.bus.V10, angle_0=powerFlow.powerflow.bus.A10)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,-90})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T4(
          G=0,
          B=0,
          CW=1,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={10,-90})));
        GenerationUnits.PSSE.Solar_Units.SolarMPCLocalVQControl_PYTHON
                                                                PV(
          V_b=480,
          P_0=powerFlow.powerflow.machines.PPV,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QPV,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V8,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A8,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-60},{-20,-40}})));
        Modelica.Blocks.Math.Add AddU3
          annotation (Placement(transformation(extent={{-80,-60},{-60,-40}})));
        Modelica.Blocks.Sources.Constant IN33(k=0)
          annotation (Placement(transformation(extent={{-108,-62},{-96,-50}})));

        Modelica.Blocks.Math.Add AddU4
          annotation (Placement(transformation(extent={{-80,-90},{-60,-70}})));
        Modelica.Blocks.Math.Add AddU5
          annotation (Placement(transformation(extent={{-80,-116},{-60,-96}})));
        Modelica.Blocks.Sources.Constant IN44(k=0)
          annotation (Placement(transformation(extent={{-108,-92},{-96,-80}})));
        Modelica.Blocks.Sources.Constant IN55(k=0)
          annotation (Placement(transformation(extent={{-108,-118},{-96,-106}})));
        GenerationUnits.PSSE.Battery_Units.BESSMPCLocalVQControlLinearized_PYTHON
                                                                 BESS(
          V_base=480,
          V_b(displayUnit="kV") = 480,
          enableV_b=true,
          P_0=powerFlow.powerflow.machines.PBESS,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QBESS,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V10,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A10,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-100},{-20,-80}})));
        Electrical.Buses.Bus Bus8(v_0=powerFlow.powerflow.bus.V8, angle_0=powerFlow.powerflow.bus.A8)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,-50})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T3(
          G=0,
          B=0,
          CW=1,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={10,-50})));
        Electrical.Buses.Bus Bus11(v_0=powerFlow.powerflow.bus.V11, angle_0=powerFlow.powerflow.bus.A11)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,-90})));
        Electrical.Buses.Bus Bus9(v_0=powerFlow.powerflow.bus.V9, angle_0=powerFlow.powerflow.bus.A9)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,-50})));
        Electrical.Buses.Bus Bus7(v_0=powerFlow.powerflow.bus.V7, angle_0=powerFlow.powerflow.bus.A7)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,10})));
        Electrical.Branches.PwLine          L4(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,6},{
                  50,14}})));
        Electrical.Branches.PwLine          L5(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,-54},
                  {50,-46}})));
        Electrical.Branches.PwLine          L6(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,-94},
                  {50,-86}})));
      equation


        connect(T1.p, Bus2.p)
          annotation (Line(points={{-51.2,80},{-40,80}}, color={0,0,255}));
        connect(Bus1.p, T1.n)
          annotation (Line(points={{-80,80},{-68.8,80}}, color={0,0,255}));
        connect(G1.conn, Bus1.p)
          annotation (Line(points={{-91,80},{-80,80}}, color={0,0,255}));
        connect(L1.n, Bus3.p)
          annotation (Line(points={{-14.6,80},{0,80}}, color={0,0,255}));
        connect(L1.p, Bus2.p)
          annotation (Line(points={{-25.4,80},{-40,80}}, color={0,0,255}));
        connect(L2_2.n, Bus4.p) annotation (Line(points={{35.4,70},{44,70},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.n, Bus4.p) annotation (Line(points={{35.4,90},{44,90},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.p, Bus3.p) annotation (Line(points={{24.6,90},{16,90},{16,80},{0,
                80}}, color={0,0,255}));
        connect(L2_2.p, Bus3.p) annotation (Line(points={{24.6,70},{16,70},{16,80},{0,
                80}}, color={0,0,255}));
        connect(Load1.p, Bus3.p)
          annotation (Line(points={{-10,68},{-10,80},{0,80}}, color={0,0,255}));
        connect(L3.p, Bus4.p)
          annotation (Line(points={{80,65.4},{80,80},{60,80}}, color={0,0,255}));
        connect(breaker.s, Bus5.p)
          annotation (Line(points={{80,22},{80,16}},color={0,0,255}));
        connect(breaker.r, L3.n)
          annotation (Line(points={{80,30},{80,54.6}},color={0,0,255}));
        connect(IN11.y, AddU1.u2) annotation (Line(points={{-95.4,4},{-82,4}},
                            color={0,0,127}));

        connect(IN22.y,AddU2. u2) annotation (Line(points={{-95.4,-26},{-82,-26}},
                       color={0,0,127}));
        connect(AddU2.y, G2.Efd_ref)
          annotation (Line(points={{-59,-20},{-52,-20},{-52,4},{-42,4}},
                                                                 color={0,0,127}));
        connect(AddU1.y, G2.P_ref1) annotation (Line(points={{-59,10},{-52,10},{-52,16},
                {-42,16}},                          color={0,0,127}));
        connect(IB.p, Bus4.p)
          annotation (Line(points={{100,80},{60,80}}, color={0,0,255}));
        connect(Load2.p, Bus5.p) annotation (Line(points={{110,-10},{110,10},{80,10},{
                80,16}},
                     color={0,0,255}));
        connect(T4.n, Bus10.p)
          annotation (Line(points={{-1,-90},{-10,-90}}, color={0,0,255}));
        connect(Bus6.p, T2.n)
          annotation (Line(points={{-10,10},{-1,10}},
                                                  color={0,0,255}));
        connect(AddU3.y, PV.QINPUT) annotation (Line(points={{-59,-50},{-42,-50}},
                                 color={0,0,127}));
        connect(IN33.y,AddU3. u2)
          annotation (Line(points={{-95.4,-56},{-82,-56}}, color={0,0,127}));
        connect(BESS.p1, Bus10.p)
          annotation (Line(points={{-20,-90},{-10,-90}}, color={0,0,255}));
        connect(BESS.Paux1, AddU4.y) annotation (Line(points={{-42,-84},{-54,-84},{-54,
                -80},{-59,-80}}, color={0,0,127}));
        connect(IN55.y, AddU5.u2)
          annotation (Line(points={{-95.4,-112},{-82,-112}}, color={0,0,127}));
        connect(AddU5.y, BESS.Qext1) annotation (Line(points={{-59,-106},{-52,-106},{-52,
                -96},{-42,-96}},   color={0,0,127}));
        connect(IN44.y, AddU4.u2)
          annotation (Line(points={{-95.4,-86},{-82,-86}}, color={0,0,127}));
        connect(G2.conn, Bus6.p) annotation (Line(points={{-19,10},{-10,10}},
                                           color={0,0,255}));
        connect(PV.p1, Bus8.p)
          annotation (Line(points={{-20,-50},{-10,-50}}, color={0,0,255}));
        connect(Bus8.p, T3.n)
          annotation (Line(points={{-10,-50},{-1,-50}}, color={0,0,255}));
        connect(sine.y, Load2.u) annotation (Line(points={{92.5,-15},{96.1,-15},{96.1,
                -14.5},{101.9,-14.5}}, color={0,0,127}));
        connect(T2.p, Bus7.p) annotation (Line(points={{21,10},{25.5,10},{25.5,10},{30,
                10}}, color={0,0,255}));
        connect(T3.p, Bus9.p)
          annotation (Line(points={{21,-50},{30,-50}}, color={0,0,255}));
        connect(T4.p, Bus11.p)
          annotation (Line(points={{21,-90},{30,-90}}, color={0,0,255}));
        connect(L4.n, Bus5.p) annotation (Line(points={{49.4,10},{60,10},{60,10},{80,10},
                {80,16}},     color={0,0,255}));
        connect(L5.n, Bus5.p) annotation (Line(points={{49.4,-50},{60,-50},{60,10},{80,
                10},{80,16}}, color={0,0,255}));
        connect(Bus11.p, L6.p)
          annotation (Line(points={{30,-90},{38.6,-90}}, color={0,0,255}));
        connect(Bus9.p, L5.p)
          annotation (Line(points={{30,-50},{38.6,-50}}, color={0,0,255}));
        connect(L6.n, Bus5.p) annotation (Line(points={{49.4,-90},{60,-90},{60,10},{80,
                10},{80,16}}, color={0,0,255}));
        connect(Bus7.p, L4.p) annotation (Line(points={{30,10},{34.3,10},{34.3,10},{38.6,
                10}}, color={0,0,255}));
        connect(AddU1.u1, AddU1.u2) annotation (Line(points={{-82,16},{-86,16},{-86,4},
                {-82,4}}, color={0,0,127}));
        connect(AddU2.u1, AddU2.u2)
          annotation (Line(points={{-82,-14},{-90,-26},{-82,-26}}, color={0,0,127}));
        connect(AddU3.u1, AddU3.u2) annotation (Line(points={{-82,-44},{-88,-44},{-88,
                -56},{-82,-56}}, color={0,0,127}));
        connect(AddU4.u1, AddU4.u2)
          annotation (Line(points={{-82,-74},{-90,-86},{-82,-86}}, color={0,0,127}));
        connect(AddU5.u1, AddU5.u2) annotation (Line(points={{-82,-100},{-86,-100},{-86,
                -112},{-82,-112}}, color={0,0,127}));
          annotation (Placement(transformation(extent={{140,-20},{160,0}})),
                      Placement(transformation(extent={{140,-40},{160,-20}})),
                      Placement(transformation(extent={{140,-60},{160,-40}})),
                      Placement(transformation(extent={{140,-80},{160,-60}})),
                     Diagram(coordinateSystem(preserveAspectRatio=false,
                extent={{-140,-140},{140,140}}), graphics={
              Rectangle(
                extent={{-128,36},{124,-124}},
                lineColor={238,46,47},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,98},{124,38}},
                lineColor={0,128,255},
                lineThickness=0.5),
              Text(
                extent={{78,-106},{114,-120}},
                textColor={238,46,47},
                textString="Microgrid"),
              Text(
                extent={{76,58},{128,34}},
                textColor={28,108,200},
                textString="Utility Grid"),
              Text(
                extent={{-30,-102},{34,-124}},
                textColor={0,140,72},
                textString="Linearization Unit")}),
          Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),experiment(StopTime=10, __Dymola_Algorithm="Dassl"),
          Icon(coordinateSystem(extent={{-140,-140},{140,140}})));
      end MPCAppliedEnergyLinearized_PYTHON;

      model MPCAppliedEnergyOriginal_rootlocus
        "THIS ONE IS STABLE, CONTROLLABLE, OBSERVABLE!!!!!!!"
        extends Modelica.Icons.Example;

        parameter Boolean equivalentGRID = true;
        parameter Boolean equivalentsystem = false;

        OpenIPSL.Electrical.Buses.Bus Bus1(v_0=powerFlow.powerflow.bus.V1, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-90,70},{-70,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus2(v_0=powerFlow.powerflow.bus.V2, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-50,70},{-30,90}})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
          R=0.001,
          X=0.2,
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000)  if not equivalentGRID annotation (Placement(transformation(
              extent={{-8,-8},{8,8}},
              rotation=180,
              origin={-60,80})));
        OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
          enableV_b=true,
          v_0=powerFlow.powerflow.bus.V1,
          angle_0=powerFlow.powerflow.bus.A1,
          P_0=powerFlow.powerflow.machines.PG1,
          Q_0=powerFlow.powerflow.machines.QG1,
          V_b=6000)  if not equivalentGRID
          annotation (Placement(transformation(extent={{-112,70},{-92,90}})));
        OpenIPSL.Electrical.Branches.PwLine L1(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{-26,76},
                  {-14,84}})));
        OpenIPSL.Electrical.Buses.Bus Bus3(v_0=powerFlow.powerflow.bus.V3, angle_0=
              powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-10,70},{10,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus4(v_0=powerFlow.powerflow.bus.V4, angle_0=
              powerFlow.powerflow.bus.V4) if not equivalentGRID
          annotation (Placement(transformation(extent={{50,70},{70,90}})));
        OpenIPSL.Electrical.Branches.PwLine L2_1(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,86},
                  {36,94}})));
        OpenIPSL.Electrical.Branches.PwLine L2_2(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,66},
                  {36,74}})));
        OpenIPSL.Electrical.Buses.Bus Bus5(angle_0=powerFlow.powerflow.bus.A5, v_0=
              powerFlow.powerflow.bus.V5)  annotation (Placement(
              transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={80,16})));
        OpenIPSL.Electrical.Branches.PwLine L3(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=-90,
              origin={80,60})));
        OpenIPSL.Electrical.Buses.Bus Bus6(v_0=powerFlow.powerflow.bus.V6, angle_0=
              powerFlow.powerflow.bus.A6) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,10})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000,
          R=0.005,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={10,10})));
        GenerationUnits.PSSE.G2_16MVA                         G2(
          enableV_b=true,
          enableP_0=true,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V6,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A6,
          V_b=6000,
          P_0=powerFlow.powerflow.machines.PG2,
          Q_0=powerFlow.powerflow.machines.QG2,
          enableangle_0=true)
                        annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-30,10})));
        inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000, fn=60)
          annotation (Placement(transformation(extent={{-128,104},{-74,124}})));
        OpenIPSL.Electrical.Loads.PSSE.Load Load1(
          V_b=220000,
          P_0=powerFlow.powerflow.loads.PL1,
          Q_0=powerFlow.powerflow.loads.QL1,
          v_0=powerFlow.powerflow.bus.V3,
          angle_0=powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-20,48},{0,68}})));
        Electrical.Events.Breaker breaker(enableTrigger=false,
          t_o=1.01,
          rc_enabled=true,
          t_rc=80.01)       if not equivalentGRID                     annotation (Placement(transformation(
              extent={{-4,-4},{4,4}},
              rotation=90,
              origin={80,26})));

        Modelica.Blocks.Sources.Constant IN11(k=0)
          annotation (Placement(transformation(extent={{-108,-2},{-96,10}})));
        Modelica.Blocks.Math.Add AddU1
          annotation (Placement(transformation(extent={{-80,0},{-60,20}})));
        Modelica.Blocks.Sources.Constant IN22(k=0)
          annotation (Placement(transformation(extent={{-108,-32},{-96,-20}})));
        Modelica.Blocks.Math.Add AddU2
          annotation (Placement(transformation(extent={{-80,-30},{-60,-10}})));

        PFData.PowerFlow powerFlow(redeclare record PowerFlow =
              OpenIPSL.Examples.ModelPredictiveControl.PFData.PF16)
          annotation (Placement(transformation(extent={{-68,104},{-48,124}})));
        Electrical.Machines.PSSE.GENCLS IB(
          V_b=220000,
          v_0=powerFlow.powerflow.bus.V4,
          angle_0=powerFlow.powerflow.bus.A4,
          P_0=powerFlow.powerflow.machines.Pinf,
          Q_0=powerFlow.powerflow.machines.Qinf,
          M_b=100000000,
          X_d=1) if not equivalentGRID annotation (Placement(transformation(extent={{110,70},
                  {100,90}})));
        Electrical.Loads.PSSE.Load_ExtInput Load2(
          P_0=powerFlow.powerflow.loads.PL2,
          Q_0=powerFlow.powerflow.loads.QL2,
          v_0=powerFlow.powerflow.bus.V5,
          angle_0=powerFlow.powerflow.bus.A5,
          d_P=0,
          t1=100,
          d_t=1000)
          annotation (Placement(transformation(extent={{100,-30},{120,-10}})));

        inner Modelica.Blocks.Noise.GlobalSeed globalSeed(useAutomaticSeed=false,
            fixedSeed=10000)
          annotation (Placement(transformation(extent={{-42,102},{-22,122}})));
        Modelica.Blocks.Sources.Sine sine(
          amplitude=0,
          f=1/260,
          phase=3.1415926535898,
          startTime=1000)
          annotation (Placement(transformation(extent={{82,-20},{92,-10}})));

        Electrical.Buses.Bus Bus10(v_0=powerFlow.powerflow.bus.V10, angle_0=powerFlow.powerflow.bus.A10)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,-90})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T4(
          G=0,
          B=0,
          CW=1,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={10,-90})));
        GenerationUnits.PSSE.Solar_Units.SolarMPCLocalVQControl PV(
          V_b=480,
          P_0=powerFlow.powerflow.machines.PPV,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QPV,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V8,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A8,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-60},{-20,-40}})));
        Modelica.Blocks.Math.Add AddU3
          annotation (Placement(transformation(extent={{-80,-60},{-60,-40}})));
        Modelica.Blocks.Sources.Constant IN33(k=0)
          annotation (Placement(transformation(extent={{-108,-62},{-96,-50}})));

        Modelica.Blocks.Math.Add AddU4
          annotation (Placement(transformation(extent={{-80,-90},{-60,-70}})));
        Modelica.Blocks.Math.Add AddU5
          annotation (Placement(transformation(extent={{-80,-116},{-60,-96}})));
        Modelica.Blocks.Sources.Constant IN44(k=0)
          annotation (Placement(transformation(extent={{-108,-92},{-96,-80}})));
        Modelica.Blocks.Sources.Constant IN55(k=0)
          annotation (Placement(transformation(extent={{-108,-118},{-96,-106}})));
        GenerationUnits.PSSE.Battery_Units.BESSMPCLocalVQControl BESS(
          V_base=480,
          V_b(displayUnit="kV") = 480,
          enableV_b=true,
          P_0=powerFlow.powerflow.machines.PBESS,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QBESS,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V10,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A10,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-100},{-20,-80}})));
        Electrical.Buses.Bus Bus8(v_0=powerFlow.powerflow.bus.V8, angle_0=powerFlow.powerflow.bus.A8)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,-50})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T3(
          G=0,
          B=0,
          CW=1,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={12,-50})));
        Electrical.Buses.Bus Bus11(v_0=powerFlow.powerflow.bus.V11, angle_0=powerFlow.powerflow.bus.A11)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,-90})));
        Electrical.Buses.Bus Bus9(v_0=powerFlow.powerflow.bus.V9, angle_0=powerFlow.powerflow.bus.A9)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,-50})));
        Electrical.Buses.Bus Bus7(v_0=powerFlow.powerflow.bus.V7, angle_0=powerFlow.powerflow.bus.A7)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,10})));
        Electrical.Branches.PwLine          L4(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,6},{
                  50,14}})));
        Electrical.Branches.PwLine          L5(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,-54},
                  {50,-46}})));
        Electrical.Branches.PwLine          L6(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,-94},
                  {50,-86}})));
      equation

        connect(T1.p, Bus2.p)
          annotation (Line(points={{-51.2,80},{-40,80}}, color={0,0,255}));
        connect(Bus1.p, T1.n)
          annotation (Line(points={{-80,80},{-68.8,80}}, color={0,0,255}));
        connect(G1.conn, Bus1.p)
          annotation (Line(points={{-91,80},{-80,80}}, color={0,0,255}));
        connect(L1.n, Bus3.p)
          annotation (Line(points={{-14.6,80},{0,80}}, color={0,0,255}));
        connect(L1.p, Bus2.p)
          annotation (Line(points={{-25.4,80},{-40,80}}, color={0,0,255}));
        connect(L2_2.n, Bus4.p) annotation (Line(points={{35.4,70},{44,70},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.n, Bus4.p) annotation (Line(points={{35.4,90},{44,90},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.p, Bus3.p) annotation (Line(points={{24.6,90},{16,90},{16,80},{0,
                80}}, color={0,0,255}));
        connect(L2_2.p, Bus3.p) annotation (Line(points={{24.6,70},{16,70},{16,80},{0,
                80}}, color={0,0,255}));
        connect(Load1.p, Bus3.p)
          annotation (Line(points={{-10,68},{-10,80},{0,80}}, color={0,0,255}));
        connect(L3.p, Bus4.p)
          annotation (Line(points={{80,65.4},{80,80},{60,80}}, color={0,0,255}));
        connect(breaker.s, Bus5.p)
          annotation (Line(points={{80,22},{80,16}},color={0,0,255}));
        connect(breaker.r, L3.n)
          annotation (Line(points={{80,30},{80,54.6}},color={0,0,255}));
        connect(IN11.y, AddU1.u2) annotation (Line(points={{-95.4,4},{-82,4}},
                            color={0,0,127}));

        connect(IN22.y,AddU2. u2) annotation (Line(points={{-95.4,-26},{-82,-26}},
                       color={0,0,127}));
        connect(AddU2.y, G2.Efd_ref)
          annotation (Line(points={{-59,-20},{-52,-20},{-52,4},{-42,4}},
                                                                 color={0,0,127}));
        connect(AddU1.y, G2.P_ref1) annotation (Line(points={{-59,10},{-52,10},{-52,16},
                {-42,16}},                          color={0,0,127}));
        connect(IB.p, Bus4.p)
          annotation (Line(points={{100,80},{60,80}}, color={0,0,255}));
        connect(Load2.p, Bus5.p) annotation (Line(points={{110,-10},{110,10},{80,10},{
                80,16}},
                     color={0,0,255}));
        connect(T4.n, Bus10.p)
          annotation (Line(points={{-1,-90},{-10,-90}}, color={0,0,255}));
        connect(Bus6.p, T2.n)
          annotation (Line(points={{-10,10},{-1,10}},
                                                  color={0,0,255}));
        connect(AddU3.y, PV.QINPUT) annotation (Line(points={{-59,-50},{-42,-50}},
                                 color={0,0,127}));
        connect(IN33.y,AddU3. u2)
          annotation (Line(points={{-95.4,-56},{-82,-56}}, color={0,0,127}));
        connect(BESS.p1, Bus10.p)
          annotation (Line(points={{-20,-90},{-10,-90}}, color={0,0,255}));
        connect(BESS.Paux1, AddU4.y) annotation (Line(points={{-42,-84},{-54,-84},{-54,
                -80},{-59,-80}}, color={0,0,127}));
        connect(IN55.y, AddU5.u2)
          annotation (Line(points={{-95.4,-112},{-82,-112}}, color={0,0,127}));
        connect(AddU5.y, BESS.Qext1) annotation (Line(points={{-59,-106},{-52,-106},{-52,
                -96},{-42,-96}},   color={0,0,127}));
        connect(IN44.y, AddU4.u2)
          annotation (Line(points={{-95.4,-86},{-82,-86}}, color={0,0,127}));
        connect(G2.conn, Bus6.p) annotation (Line(points={{-19,10},{-10,10}},
                                           color={0,0,255}));
        connect(PV.p1, Bus8.p)
          annotation (Line(points={{-20,-50},{-10,-50}}, color={0,0,255}));
        connect(Bus8.p, T3.n)
          annotation (Line(points={{-10,-50},{1,-50}},  color={0,0,255}));
        connect(sine.y, Load2.u) annotation (Line(points={{92.5,-15},{96.1,-15},{96.1,
                -14.5},{101.9,-14.5}}, color={0,0,127}));
        connect(T2.p, Bus7.p) annotation (Line(points={{21,10},{25.5,10},{25.5,10},{30,
                10}}, color={0,0,255}));
        connect(T3.p, Bus9.p)
          annotation (Line(points={{23,-50},{30,-50}}, color={0,0,255}));
        connect(T4.p, Bus11.p)
          annotation (Line(points={{21,-90},{30,-90}}, color={0,0,255}));
        connect(L4.n, Bus5.p) annotation (Line(points={{49.4,10},{60,10},{60,10},{80,10},
                {80,16}},     color={0,0,255}));
        connect(L5.n, Bus5.p) annotation (Line(points={{49.4,-50},{60,-50},{60,10},{80,
                10},{80,16}}, color={0,0,255}));
        connect(Bus11.p, L6.p)
          annotation (Line(points={{30,-90},{38.6,-90}}, color={0,0,255}));
        connect(Bus9.p, L5.p)
          annotation (Line(points={{30,-50},{38.6,-50}}, color={0,0,255}));
        connect(L6.n, Bus5.p) annotation (Line(points={{49.4,-90},{60,-90},{60,10},{80,
                10},{80,16}}, color={0,0,255}));
        connect(Bus7.p, L4.p) annotation (Line(points={{30,10},{34.3,10},{34.3,10},{38.6,
                10}}, color={0,0,255}));
        connect(AddU1.u1, AddU1.u2)
          annotation (Line(points={{-82,16},{-92,4},{-82,4}}, color={0,0,127}));
        connect(AddU2.u1, AddU2.u2) annotation (Line(points={{-82,-14},{-88,-14},{-88,
                -26},{-82,-26}}, color={0,0,127}));
        connect(AddU3.u1, AddU3.u2) annotation (Line(points={{-82,-44},{-88,-44},{-88,
                -56},{-82,-56}}, color={0,0,127}));
        connect(AddU4.u1, AddU4.u2) annotation (Line(points={{-82,-74},{-86,-74},{-86,
                -86},{-82,-86}}, color={0,0,127}));
        connect(AddU5.u1, AddU5.u2) annotation (Line(points={{-82,-100},{-86,-100},{-86,
                -112},{-82,-112}}, color={0,0,127}));
          annotation (Placement(transformation(extent={{140,-20},{160,0}})),
                      Placement(transformation(extent={{140,-40},{160,-20}})),
                      Placement(transformation(extent={{140,-60},{160,-40}})),
                      Placement(transformation(extent={{140,-80},{160,-60}})),
                     Diagram(coordinateSystem(preserveAspectRatio=false,
                extent={{-140,-140},{140,140}}), graphics={
              Rectangle(
                extent={{-128,36},{124,-124}},
                lineColor={238,46,47},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,98},{124,38}},
                lineColor={0,128,255},
                lineThickness=0.5),
              Text(
                extent={{78,-106},{114,-120}},
                textColor={238,46,47},
                textString="Microgrid"),
              Text(
                extent={{76,58},{128,34}},
                textColor={28,108,200},
                textString="Utility Grid"),
              Text(
                extent={{-30,-102},{34,-124}},
                textColor={0,140,72},
                textString="Linearization Unit")}),
          Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),experiment(StopTime=10, __Dymola_Algorithm="Dassl"),
          Icon(coordinateSystem(extent={{-140,-140},{140,140}})));
      end MPCAppliedEnergyOriginal_rootlocus;

      model MPCAppliedEnergyOriginal_TABLE_mode1
        "THIS ONE IS STABLE, CONTROLLABLE, OBSERVABLE!!!!!!!"
        extends Modelica.Icons.Example;

        parameter Boolean equivalentGRID = false;
        parameter Boolean equivalentsystem = false;

        OpenIPSL.Electrical.Buses.Bus Bus1(v_0=powerFlow.powerflow.bus.V1, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-90,70},{-70,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus2(v_0=powerFlow.powerflow.bus.V2, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-50,70},{-30,90}})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
          R=0.001,
          X=0.2,
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000)  if not equivalentGRID annotation (Placement(transformation(
              extent={{-8,-8},{8,8}},
              rotation=180,
              origin={-60,80})));
        OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
          enableV_b=true,
          v_0=powerFlow.powerflow.bus.V1,
          angle_0=powerFlow.powerflow.bus.A1,
          P_0=powerFlow.powerflow.machines.PG1,
          Q_0=powerFlow.powerflow.machines.QG1,
          V_b=6000)  if not equivalentGRID
          annotation (Placement(transformation(extent={{-112,70},{-92,90}})));
        OpenIPSL.Electrical.Branches.PwLine L1(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{-26,76},
                  {-14,84}})));
        OpenIPSL.Electrical.Buses.Bus Bus3(v_0=powerFlow.powerflow.bus.V3, angle_0=
              powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-10,70},{10,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus4(v_0=powerFlow.powerflow.bus.V4, angle_0=
              powerFlow.powerflow.bus.V4) if not equivalentGRID
          annotation (Placement(transformation(extent={{50,70},{70,90}})));
        OpenIPSL.Electrical.Branches.PwLine L2_1(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,86},
                  {36,94}})));
        OpenIPSL.Electrical.Branches.PwLine L2_2(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,66},
                  {36,74}})));
        OpenIPSL.Electrical.Buses.Bus Bus5(angle_0=powerFlow.powerflow.bus.A5, v_0=
              powerFlow.powerflow.bus.V5)  annotation (Placement(
              transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={80,16})));
        OpenIPSL.Electrical.Branches.PwLine L3(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=-90,
              origin={80,60})));
        OpenIPSL.Electrical.Buses.Bus Bus6(v_0=powerFlow.powerflow.bus.V6, angle_0=
              powerFlow.powerflow.bus.A6) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,10})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000,
          R=0.005,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={10,10})));
        GenerationUnits.PSSE.G2_16MVA                         G2(
          enableV_b=true,
          enableP_0=true,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V6,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A6,
          V_b=6000,
          P_0=powerFlow.powerflow.machines.PG2,
          Q_0=powerFlow.powerflow.machines.QG2,
          enableangle_0=true)
                        annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-30,10})));
        inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000, fn=60)
          annotation (Placement(transformation(extent={{-128,104},{-74,124}})));
        OpenIPSL.Electrical.Loads.PSSE.Load Load1(
          V_b=220000,
          P_0=powerFlow.powerflow.loads.PL1,
          Q_0=powerFlow.powerflow.loads.QL1,
          v_0=powerFlow.powerflow.bus.V3,
          angle_0=powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-20,48},{0,68}})));
        Electrical.Events.Breaker breaker(enableTrigger=false,
          t_o=1.01,
          rc_enabled=true,
          t_rc=80.01)       if not equivalentGRID                     annotation (Placement(transformation(
              extent={{-4,-4},{4,4}},
              rotation=90,
              origin={80,26})));

        Modelica.Blocks.Interfaces.RealOutput OUT1
          annotation (Placement(transformation(extent={{140,70},{160,90}})));
       Modelica.Blocks.Interfaces.RealOutput OUT2
          annotation (Placement(transformation(extent={{140,50},{160,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT3
          annotation (Placement(transformation(extent={{140,30},{160,50}})));

        PFData.PowerFlow powerFlow(redeclare record PowerFlow =
              OpenIPSL.Examples.ModelPredictiveControl.PFData.PF16)
          annotation (Placement(transformation(extent={{-68,104},{-48,124}})));
        Electrical.Machines.PSSE.GENCLS IB(
          V_b=220000,
          v_0=powerFlow.powerflow.bus.V4,
          angle_0=powerFlow.powerflow.bus.A4,
          P_0=powerFlow.powerflow.machines.Pinf,
          Q_0=powerFlow.powerflow.machines.Qinf,
          M_b=100000000,
          X_d=1) if not equivalentGRID annotation (Placement(transformation(extent={{110,70},
                  {100,90}})));
        Electrical.Loads.PSSE.Load_ExtInput Load2(
          P_0=powerFlow.powerflow.loads.PL2,
          Q_0=powerFlow.powerflow.loads.QL2,
          v_0=powerFlow.powerflow.bus.V5,
          angle_0=powerFlow.powerflow.bus.A5,
          d_P=0,
          t1=100,
          d_t=1000)
          annotation (Placement(transformation(extent={{100,-30},{120,-10}})));

        inner Modelica.Blocks.Noise.GlobalSeed globalSeed(useAutomaticSeed=false,
            fixedSeed=10000)
          annotation (Placement(transformation(extent={{-42,102},{-22,122}})));
        Modelica.Blocks.Sources.Sine sine(
          amplitude=0,
          f=1/260,
          phase=3.1415926535898,
          startTime=1000)
          annotation (Placement(transformation(extent={{82,-20},{92,-10}})));

        Electrical.Buses.Bus Bus10(v_0=powerFlow.powerflow.bus.V10, angle_0=powerFlow.powerflow.bus.A10)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,-90})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T4(
          G=0,
          B=0,
          CW=1,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={10,-90})));
        GenerationUnits.PSSE.Solar_Units.SolarMPCLocalVQControl PV(
          V_b=480,
          P_0=powerFlow.powerflow.machines.PPV,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QPV,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V8,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A8,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-60},{-20,-40}})));

        Modelica.Blocks.Interfaces.RealOutput OUT4
          annotation (Placement(transformation(extent={{140,10},{160,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT5
          annotation (Placement(transformation(extent={{140,-10},{160,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT6
          annotation (Placement(transformation(extent={{140,-30},{160,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT7
          annotation (Placement(transformation(extent={{140,-50},{160,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT8
          annotation (Placement(transformation(extent={{140,-70},{160,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT9
          annotation (Placement(transformation(extent={{140,-90},{160,-70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT10
          annotation (Placement(transformation(extent={{140,-110},{160,-90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT11
          annotation (Placement(transformation(extent={{164,70},{184,90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT12
          annotation (Placement(transformation(extent={{164,50},{184,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT13
          annotation (Placement(transformation(extent={{164,30},{184,50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT14
          annotation (Placement(transformation(extent={{164,10},{184,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT15
          annotation (Placement(transformation(extent={{164,-10},{184,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT16
          annotation (Placement(transformation(extent={{164,-30},{184,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT17
          annotation (Placement(transformation(extent={{164,-50},{184,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT18
          annotation (Placement(transformation(extent={{164,-70},{184,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT19
          annotation (Placement(transformation(extent={{164,-90},{184,-70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT20
          annotation (Placement(transformation(extent={{164,-110},{184,-90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT21
          annotation (Placement(transformation(extent={{184,70},{204,90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT22
          annotation (Placement(transformation(extent={{184,50},{204,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT23
          annotation (Placement(transformation(extent={{184,30},{204,50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT24
          annotation (Placement(transformation(extent={{184,10},{204,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT25
          annotation (Placement(transformation(extent={{184,-10},{204,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT26
          annotation (Placement(transformation(extent={{184,-30},{204,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT27
          annotation (Placement(transformation(extent={{184,-50},{204,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT28
          annotation (Placement(transformation(extent={{184,-70},{204,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT29
          annotation (Placement(transformation(extent={{184,-90},{204,-70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT30
          annotation (Placement(transformation(extent={{184,-110},{204,-90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT31
          annotation (Placement(transformation(extent={{204,70},{224,90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT32
          annotation (Placement(transformation(extent={{204,50},{224,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT33
          annotation (Placement(transformation(extent={{204,30},{224,50}})));
        GenerationUnits.PSSE.Battery_Units.BESSMPCLocalVQControl BESS(
          V_base=480,
          V_b(displayUnit="kV") = 480,
          enableV_b=true,
          P_0=powerFlow.powerflow.machines.PBESS,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QBESS,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V10,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A10,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-100},{-20,-80}})));
        Modelica.Blocks.Interfaces.RealOutput OUT34
          annotation (Placement(transformation(extent={{204,10},{224,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT35
          annotation (Placement(transformation(extent={{206,-10},{226,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT36
          annotation (Placement(transformation(extent={{206,-30},{226,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT37
          annotation (Placement(transformation(extent={{206,-50},{226,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT38
          annotation (Placement(transformation(extent={{206,-70},{226,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT39
          annotation (Placement(transformation(extent={{206,-90},{226,-70}})));
        Electrical.Buses.Bus Bus8(v_0=powerFlow.powerflow.bus.V8, angle_0=powerFlow.powerflow.bus.A8)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,-50})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T3(
          G=0,
          B=0,
          CW=1,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={12,-50})));
        Electrical.Buses.Bus Bus11(v_0=powerFlow.powerflow.bus.V11, angle_0=powerFlow.powerflow.bus.A11)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,-90})));
        Electrical.Buses.Bus Bus9(v_0=powerFlow.powerflow.bus.V9, angle_0=powerFlow.powerflow.bus.A9)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,-50})));
        Electrical.Buses.Bus Bus7(v_0=powerFlow.powerflow.bus.V7, angle_0=powerFlow.powerflow.bus.A7)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,10})));
        Electrical.Branches.PwLine          L4(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,6},{
                  50,14}})));
        Electrical.Branches.PwLine          L5(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,-54},
                  {50,-46}})));
        Electrical.Branches.PwLine          L6(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,-94},
                  {50,-86}})));
        Modelica.Blocks.Interfaces.RealOutput OUT40
          annotation (Placement(transformation(extent={{206,-110},{226,-90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT41
          annotation (Placement(transformation(extent={{224,70},{244,90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT42
          annotation (Placement(transformation(extent={{224,50},{244,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT43
          annotation (Placement(transformation(extent={{224,30},{244,50}})));
        Modelica.Blocks.Sources.CombiTimeTable combiTimeTable(table=[0,0; 0.5,
              1.63e-18; 1,3.25e-18; 1.5,0.01; 2,0.02; 2.5,0.03; 3,0.04; 3.5,
              0.05; 4,0.06; 4.5,0.07; 5,0.08; 5.5,0.09; 6,0.1; 6.5,0.11; 7,0.12;
              7.5,0.13; 8,0.14; 8.5,0.15; 9,0.16; 9.5,0.17; 10,0.18; 10.5,0.19;
              11,0.2; 11.5,0.21; 12,0.211394749; 12.5,0.208967391; 13,
              0.206813042; 13.5,0.204814716; 14,0.202939831; 14.5,0.201187827;
              15,0.199563061; 15.5,0.198069037; 16,0.196693391; 16.5,0.19543066;
              17,0.191430624; 17.5,0.189724498; 18,0.188315654; 18.5,
              0.186906047; 19,0.185738558; 19.5,0.184822385; 20,0.184088679;
              20.5,0.183502562; 21,0.183036426; 21.5,0.182665915; 22,
              0.182369913; 22.5,0.182115217; 23,0.181937876; 23.5,0.181800481;
              24,0.181683898; 24.5,0.181592896; 25,0.181521311; 25.5,
              0.181460187; 26,0.181410098; 26.5,0.181377246; 27,0.181347034;
              27.5,0.181323135; 28,0.181304277; 28.5,0.181291026; 29,0.18127658;
              29.5,0.181267167], smoothness=Modelica.Blocks.Types.Smoothness.ConstantSegments)
          annotation (Placement(transformation(extent={{-100,6},{-80,26}})));
        Modelica.Blocks.Sources.CombiTimeTable combiTimeTable1(table=[0,0; 0.5,
              8.72e-17; 1,1.74e-16; 1.5,0.05; 2,0.1; 2.5,0.15; 3,0.2; 3.5,0.25;
              4,0.3; 4.5,0.35; 5,0.4; 5.5,0.432268407; 6,0.4224197; 6.5,
              0.40103619; 7,0.390437125; 7.5,0.382556554; 8,0.375168263; 8.5,
              0.369553476; 9,0.365418574; 9.5,0.362471672; 10,0.360534141; 10.5,
              0.35940924; 11,0.358361886; 11.5,0.357331258; 12,0.356885581;
              12.5,0.356094554; 13,0.35563203; 13.5,0.355286945; 14,0.35505784;
              14.5,0.354745516; 15,0.354664024; 15.5,0.354648366; 16,
              0.354632249; 16.5,0.354626546; 17,0.354532805; 17.5,0.354479273;
              18,0.354444794; 18.5,0.354409796; 19,0.354379657; 19.5,
              0.354356813; 20,0.354339106; 20.5,0.354325056; 21,0.354313955;
              21.5,0.354305224; 22,0.354501548; 22.5,0.354144102; 23,
              0.354344338; 23.5,0.354209265; 24,0.354327501; 24.5,0.354371136;
              25,0.35416755; 25.5,0.35426433; 26,0.354275405; 26.5,0.354280469;
              27,0.354282307; 27.5,0.354282504; 28,0.354281971; 28.5,
              0.354281325; 29,0.354280474; 29.5,0.354279649], smoothness=
              Modelica.Blocks.Types.Smoothness.ConstantSegments)
          annotation (Placement(transformation(extent={{-100,-20},{-80,0}})));
        Modelica.Blocks.Sources.CombiTimeTable combiTimeTable2(table=[0,0; 0.5,
              1.26e-15; 1,2.52e-15; 1.5,-1.23e-17; 2,1.6e-18; 2.5,1.6e-18; 3,
              1.6e-18; 3.5,1.6e-18; 4,-1.87e-18; 4.5,6.11e-20; 5,-7.52e-17; 5.5,
              -1.79e-18; 6,-4.16e-20; 6.5,-4.4e-19; 7,-8.97e-19; 7.5,-3.68e-19;
              8,-2e-21; 8.5,-2e-21; 9,-2e-21; 9.5,1.39e-21; 10,-2e-21; 10.5,-3.03e-22;
              11,-3.03e-22; 11.5,-3.03e-22; 12,-3.03e-22; 12.5,1.21e-22; 13,
              1.21e-22; 13.5,-9.13e-23; 14,-1.36e-19; 14.5,-5.4e-07; 15,-8.12e-08;
              15.5,2.47e-07; 16,-8.29e-20; 16.5,5.87e-20; 17,-2.29e-20; 17.5,-1.21e-20;
              18,-1.15e-20; 18.5,-8.21e-21; 19,-9.63e-21; 19.5,-5.99e-21; 20,-4.39e-21;
              20.5,-5.12e-21; 21,-3.31e-21; 21.5,-4.22e-21; 22,-8.33e-22; 22.5,
              -5.13e-21; 23,-5.26e-23; 23.5,-2.21e-21; 24,3.31e-22; 24.5,-9.27e-23;
              25,-2.29e-21; 25.5,-1.74e-22; 26,7.7e-07; 26.5,-6.48e-10; 27,
              5.5e-07; 27.5,7.06e-07; 28,6.93e-07; 28.5,6.77e-07; 29,5.6e-07;
              29.5,4.53e-07], smoothness=Modelica.Blocks.Types.Smoothness.ConstantSegments)
          annotation (Placement(transformation(extent={{-100,-48},{-80,-28}})));
        Modelica.Blocks.Sources.CombiTimeTable combiTimeTable3(table=[0,0; 0.5,
              1.77e-15; 1,3.54e-15; 1.5,-1.13e-18; 2,-1.24e-18; 2.5,9.39e-20; 3,
              8.22e-18; 3.5,9.65e-18; 4,7.77e-18; 4.5,6.99e-18; 5,2.12e-18; 5.5,
              4.88e-18; 6,4.23e-18; 6.5,5.04e-18; 7,5.44e-18; 7.5,3.66e-18; 8,
              4.65e-18; 8.5,5.32e-18; 9,1.18e-18; 9.5,2.69e-18; 10,-7.44e-19;
              10.5,-3.72e-19; 11,-1.84e-18; 11.5,-6.03e-20; 12,-3.3e-20; 12.5,-1.79e-20;
              13,-1.68e-20; 13.5,-4.5e-19; 14,-1.58e-20; 14.5,-2.08e-20; 15,-2.57e-20;
              15.5,-3.07e-20; 16,-3.02e-20; 16.5,-3.11e-21; 17,1.65e-20; 17.5,
              3.11e-20; 18,-1.17e-20; 18.5,-2.59e-21; 19,4.67e-21; 19.5,
              3.75e-20; 20,1.45e-21; 20.5,5.09e-21; 21,7.98e-21; 21.5,3.5e-21;
              22,-2.84e-21; 22.5,2.28e-22; 23,3.76e-22; 23.5,1.95e-21; 24,-1.35e-21;
              24.5,-1.27e-21; 25,1.96e-21; 25.5,3.2e-22; 26,3.2e-22; 26.5,
              3.2e-22; 27,3.2e-22; 27.5,-1.03e-22; 28,-1.03e-22; 28.5,-1.03e-22;
              29,-1.03e-22; 29.5,-1.03e-22], smoothness=Modelica.Blocks.Types.Smoothness.ConstantSegments)
          annotation (Placement(transformation(extent={{-100,-94},{-80,-74}})));
        Modelica.Blocks.Sources.CombiTimeTable combiTimeTable4(table=[0,0; 0.5,
              1.26e-15; 1,2.52e-15; 1.5,-3.53e-19; 2,-2.82e-20; 2.5,-2.82e-20;
              3,-2.82e-20; 3.5,-2.82e-20; 4,-2.82e-20; 4.5,5.46e-18; 5,1.68e-18;
              5.5,8.51e-19; 6,-4.5e-19; 6.5,-1.28e-18; 7,-2.84e-19; 7.5,-3.24e-19;
              8,-1.47e-18; 8.5,-1.12e-18; 9,-8.41e-19; 9.5,-6.21e-19; 10,-4.59e-19;
              10.5,-3.46e-19; 11,-8.25e-19; 11.5,-6.43e-19; 12,-3.5e-19; 12.5,-1.05e-19;
              13,-6.88e-20; 13.5,-4.29e-20; 14,-8.02e-07; 14.5,-6.63e-19; 15,-5.71e-19;
              15.5,-4.41e-19; 16,4.07e-07; 16.5,5.03e-07; 17,4.38e-07; 17.5,
              3.89e-07; 18,3.31e-07; 18.5,2.64e-07; 19,2.09e-07; 19.5,1.69e-07;
              20,1.37e-07; 20.5,1.1e-07; 21,8.86e-08; 21.5,7.13e-08; 22,-4.86e-07;
              22.5,-3.96e-07; 23,-3.12e-07; 23.5,-1.59e-07; 24,-1.59e-07; 24.5,
              -4.56e-07; 25,-2.87e-07; 25.5,-6.52e-08; 26,-7.67e-07; 26.5,0; 27,
              -5.72e-07; 27.5,-7.54e-07; 28,-7.66e-07; 28.5,-7.76e-07; 29,-6.8e-07;
              29.5,-5.9e-07], smoothness=Modelica.Blocks.Types.Smoothness.ConstantSegments)
          annotation (Placement(transformation(extent={{-100,-120},{-80,-100}})));
      equation

      OUT1 = G2.gen.w;
      OUT2 = G2.gen.delta;
      OUT3 = G2.gen.Epq;
      OUT4 = G2.gen.PSIkd;
      OUT5 = G2.gen.PSIppq;
      OUT6 = G2.sEXSMPC.simpleLagLim.state;
      OUT7 = G2.sEXSMPC.leadLag.TF.x_scaled[1];
      OUT8 = G2.gASTMPC.simpleLagLim.state;
      OUT9 = G2.gASTMPC.simpleLag.state;
      OUT10 = G2.gASTMPC.simpleLag1.state;
      OUT11 = PV.rEGCA1_1.simpleLag.state;
      OUT12 = PV.rEGCA1_1.integrator.y;
      OUT13 = PV.rEGCA1_1.integrator1.y;
      OUT14 =PV.EC.IGQ.y;
      OUT15 =PV.EC.IGV.y;
      OUT16 =PV.EC.simpleLag.state;
      OUT17 =PV.EC.simpleLag1.state;
      OUT18 =PV.EC.simpleLag2.state;
      OUT19 =PV.EC.IGP.y;
      OUT20 =PV.EC.simpleLag3.state;
      OUT21 =PV.EC.simpleLag4.state;
      OUT22 =PV.EC.simpleLag5.state;
      OUT23 = BESS.rEGCA1_1.simpleLag.state;
      OUT24 = BESS.rEGCA1_1.integrator.y;
      OUT25 = BESS.rEGCA1_1.integrator1.y;
      OUT26 =BESS.EC.integrator3.y;
      OUT27 =BESS.EC.integrator1.y;
      OUT28 =BESS.EC.simpleLag.state;
      OUT29 =BESS.EC.IGQ.y;
      OUT30 =BESS.EC.IGV.y;
      OUT31 =BESS.EC.IGP.y;
      OUT32 =BESS.EC.simpleLag1.state;
      OUT33 =BESS.EC.simpleLag2.state;
      OUT34 =BESS.EC.simpleLag3.state;
      OUT35 =BESS.EC.simpleLag4.state;
      OUT36 = G2.gen.PMECH;
      OUT37 = G2.sEXSMPC.EFD;
      OUT38 = BESS.rEGCA1_1.Pgen;
      OUT39 = BESS.rEGCA1_1.Qgen;
      OUT40 = PV.rEGCA1_1.Pgen;
      OUT41 = PV.rEGCA1_1.Qgen;
      OUT42 = Bus5.v;
      OUT43 = Bus5.angle;

        connect(T1.p, Bus2.p)
          annotation (Line(points={{-51.2,80},{-40,80}}, color={0,0,255}));
        connect(Bus1.p, T1.n)
          annotation (Line(points={{-80,80},{-68.8,80}}, color={0,0,255}));
        connect(G1.conn, Bus1.p)
          annotation (Line(points={{-91,80},{-80,80}}, color={0,0,255}));
        connect(L1.n, Bus3.p)
          annotation (Line(points={{-14.6,80},{0,80}}, color={0,0,255}));
        connect(L1.p, Bus2.p)
          annotation (Line(points={{-25.4,80},{-40,80}}, color={0,0,255}));
        connect(L2_2.n, Bus4.p) annotation (Line(points={{35.4,70},{44,70},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.n, Bus4.p) annotation (Line(points={{35.4,90},{44,90},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.p, Bus3.p) annotation (Line(points={{24.6,90},{16,90},{16,80},{0,
                80}}, color={0,0,255}));
        connect(L2_2.p, Bus3.p) annotation (Line(points={{24.6,70},{16,70},{16,80},{0,
                80}}, color={0,0,255}));
        connect(Load1.p, Bus3.p)
          annotation (Line(points={{-10,68},{-10,80},{0,80}}, color={0,0,255}));
        connect(L3.p, Bus4.p)
          annotation (Line(points={{80,65.4},{80,80},{60,80}}, color={0,0,255}));
        connect(breaker.s, Bus5.p)
          annotation (Line(points={{80,22},{80,16}},color={0,0,255}));
        connect(breaker.r, L3.n)
          annotation (Line(points={{80,30},{80,54.6}},color={0,0,255}));

        connect(IB.p, Bus4.p)
          annotation (Line(points={{100,80},{60,80}}, color={0,0,255}));
        connect(Load2.p, Bus5.p) annotation (Line(points={{110,-10},{110,10},{80,10},{
                80,16}},
                     color={0,0,255}));
        connect(T4.n, Bus10.p)
          annotation (Line(points={{-1,-90},{-10,-90}}, color={0,0,255}));
        connect(Bus6.p, T2.n)
          annotation (Line(points={{-10,10},{-1,10}},
                                                  color={0,0,255}));
        connect(BESS.p1, Bus10.p)
          annotation (Line(points={{-20,-90},{-10,-90}}, color={0,0,255}));
        connect(G2.conn, Bus6.p) annotation (Line(points={{-19,10},{-10,10}},
                                           color={0,0,255}));
        connect(PV.p1, Bus8.p)
          annotation (Line(points={{-20,-50},{-10,-50}}, color={0,0,255}));
        connect(Bus8.p, T3.n)
          annotation (Line(points={{-10,-50},{1,-50}},  color={0,0,255}));
        connect(sine.y, Load2.u) annotation (Line(points={{92.5,-15},{96.1,-15},{96.1,
                -14.5},{101.9,-14.5}}, color={0,0,127}));
        connect(T2.p, Bus7.p) annotation (Line(points={{21,10},{25.5,10},{25.5,10},{30,
                10}}, color={0,0,255}));
        connect(T3.p, Bus9.p)
          annotation (Line(points={{23,-50},{30,-50}}, color={0,0,255}));
        connect(T4.p, Bus11.p)
          annotation (Line(points={{21,-90},{30,-90}}, color={0,0,255}));
        connect(L4.n, Bus5.p) annotation (Line(points={{49.4,10},{60,10},{60,10},{80,10},
                {80,16}},     color={0,0,255}));
        connect(L5.n, Bus5.p) annotation (Line(points={{49.4,-50},{60,-50},{60,10},{80,
                10},{80,16}}, color={0,0,255}));
        connect(Bus11.p, L6.p)
          annotation (Line(points={{30,-90},{38.6,-90}}, color={0,0,255}));
        connect(Bus9.p, L5.p)
          annotation (Line(points={{30,-50},{38.6,-50}}, color={0,0,255}));
        connect(L6.n, Bus5.p) annotation (Line(points={{49.4,-90},{60,-90},{60,10},{80,
                10},{80,16}}, color={0,0,255}));
        connect(Bus7.p, L4.p) annotation (Line(points={{30,10},{34.3,10},{34.3,10},{38.6,
                10}}, color={0,0,255}));
        connect(combiTimeTable.y[1], G2.P_ref1)
          annotation (Line(points={{-79,16},{-42,16}}, color={0,0,127}));
        connect(combiTimeTable1.y[1], G2.Efd_ref) annotation (Line(points={{-79,
                -10},{-52,-10},{-52,4},{-42,4}}, color={0,0,127}));
        connect(combiTimeTable2.y[1], PV.QINPUT) annotation (Line(points={{-79,
                -38},{-50,-38},{-50,-50},{-42,-50}}, color={0,0,127}));
        connect(combiTimeTable3.y[1], BESS.Paux1)
          annotation (Line(points={{-79,-84},{-42,-84}}, color={0,0,127}));
        connect(combiTimeTable4.y[1], BESS.Qext1) annotation (Line(points={{-79,
                -110},{-52,-110},{-52,-96},{-42,-96}}, color={0,0,127}));
          annotation (Placement(transformation(extent={{140,-20},{160,0}})),
                      Placement(transformation(extent={{140,-40},{160,-20}})),
                      Placement(transformation(extent={{140,-60},{160,-40}})),
                      Placement(transformation(extent={{140,-80},{160,-60}})),
                     Diagram(coordinateSystem(preserveAspectRatio=false,
                extent={{-140,-140},{140,140}}), graphics={
              Rectangle(
                extent={{130,98},{252,-124}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,36},{124,-124}},
                lineColor={238,46,47},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,98},{124,38}},
                lineColor={0,128,255},
                lineThickness=0.5),
              Text(
                extent={{78,-106},{114,-120}},
                textColor={238,46,47},
                textString="Microgrid"),
              Text(
                extent={{76,58},{128,34}},
                textColor={28,108,200},
                textString="Utility Grid"),
              Text(
                extent={{-30,-102},{34,-124}},
                textColor={0,140,72},
                textString="Linearization Unit"),
              Text(
                extent={{-164,50},{-132,30}},
                textColor={0,140,72},
                textString="Inputs"),
              Text(
                extent={{128,118},{168,98}},
                textColor={0,140,72},
                textString="Outputs")}),
          Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),experiment(StopTime=30, __Dymola_Algorithm="Dassl"),
          Icon(coordinateSystem(extent={{-140,-140},{140,140}})));
      end MPCAppliedEnergyOriginal_TABLE_mode1;

      model MPCAppliedEnergyOriginal_TABLE_mode2
        "THIS ONE IS STABLE, CONTROLLABLE, OBSERVABLE!!!!!!!"
        extends Modelica.Icons.Example;

        parameter Boolean equivalentGRID = false;
        parameter Boolean equivalentsystem = false;

        OpenIPSL.Electrical.Buses.Bus Bus1(v_0=powerFlow.powerflow.bus.V1, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-90,70},{-70,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus2(v_0=powerFlow.powerflow.bus.V2, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-50,70},{-30,90}})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
          R=0.001,
          X=0.2,
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000)  if not equivalentGRID annotation (Placement(transformation(
              extent={{-8,-8},{8,8}},
              rotation=180,
              origin={-60,80})));
        OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
          enableV_b=true,
          v_0=powerFlow.powerflow.bus.V1,
          angle_0=powerFlow.powerflow.bus.A1,
          P_0=powerFlow.powerflow.machines.PG1,
          Q_0=powerFlow.powerflow.machines.QG1,
          V_b=6000)  if not equivalentGRID
          annotation (Placement(transformation(extent={{-112,70},{-92,90}})));
        OpenIPSL.Electrical.Branches.PwLine L1(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{-26,76},
                  {-14,84}})));
        OpenIPSL.Electrical.Buses.Bus Bus3(v_0=powerFlow.powerflow.bus.V3, angle_0=
              powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-10,70},{10,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus4(v_0=powerFlow.powerflow.bus.V4, angle_0=
              powerFlow.powerflow.bus.V4) if not equivalentGRID
          annotation (Placement(transformation(extent={{50,70},{70,90}})));
        OpenIPSL.Electrical.Branches.PwLine L2_1(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,86},
                  {36,94}})));
        OpenIPSL.Electrical.Branches.PwLine L2_2(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,66},
                  {36,74}})));
        OpenIPSL.Electrical.Buses.Bus Bus5(angle_0=powerFlow.powerflow.bus.A5, v_0=
              powerFlow.powerflow.bus.V5)  annotation (Placement(
              transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={80,16})));
        OpenIPSL.Electrical.Branches.PwLine L3(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=-90,
              origin={80,60})));
        OpenIPSL.Electrical.Buses.Bus Bus6(v_0=powerFlow.powerflow.bus.V6, angle_0=
              powerFlow.powerflow.bus.A6) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,10})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000,
          R=0.005,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={10,10})));
        GenerationUnits.PSSE.G2_16MVA                         G2(
          enableV_b=true,
          enableP_0=true,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V6,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A6,
          V_b=6000,
          P_0=powerFlow.powerflow.machines.PG2,
          Q_0=powerFlow.powerflow.machines.QG2,
          enableangle_0=true)
                        annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-30,10})));
        inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000, fn=60)
          annotation (Placement(transformation(extent={{-128,104},{-74,124}})));
        OpenIPSL.Electrical.Loads.PSSE.Load Load1(
          V_b=220000,
          P_0=powerFlow.powerflow.loads.PL1,
          Q_0=powerFlow.powerflow.loads.QL1,
          v_0=powerFlow.powerflow.bus.V3,
          angle_0=powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-20,48},{0,68}})));
        Electrical.Events.Breaker breaker(enableTrigger=false,
          t_o=1.01,
          rc_enabled=true,
          t_rc=80.01)       if not equivalentGRID                     annotation (Placement(transformation(
              extent={{-4,-4},{4,4}},
              rotation=90,
              origin={80,26})));

        Modelica.Blocks.Interfaces.RealOutput OUT1
          annotation (Placement(transformation(extent={{140,70},{160,90}})));
       Modelica.Blocks.Interfaces.RealOutput OUT2
          annotation (Placement(transformation(extent={{140,50},{160,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT3
          annotation (Placement(transformation(extent={{140,30},{160,50}})));

        PFData.PowerFlow powerFlow(redeclare record PowerFlow =
              OpenIPSL.Examples.ModelPredictiveControl.PFData.PF16)
          annotation (Placement(transformation(extent={{-68,104},{-48,124}})));
        Electrical.Machines.PSSE.GENCLS IB(
          V_b=220000,
          v_0=powerFlow.powerflow.bus.V4,
          angle_0=powerFlow.powerflow.bus.A4,
          P_0=powerFlow.powerflow.machines.Pinf,
          Q_0=powerFlow.powerflow.machines.Qinf,
          M_b=100000000,
          X_d=1) if not equivalentGRID annotation (Placement(transformation(extent={{110,70},
                  {100,90}})));
        Electrical.Loads.PSSE.Load_ExtInput Load2(
          P_0=powerFlow.powerflow.loads.PL2,
          Q_0=powerFlow.powerflow.loads.QL2,
          v_0=powerFlow.powerflow.bus.V5,
          angle_0=powerFlow.powerflow.bus.A5,
          d_P=0,
          t1=100,
          d_t=1000)
          annotation (Placement(transformation(extent={{100,-30},{120,-10}})));

        inner Modelica.Blocks.Noise.GlobalSeed globalSeed(useAutomaticSeed=false,
            fixedSeed=10000)
          annotation (Placement(transformation(extent={{-42,102},{-22,122}})));
        Modelica.Blocks.Sources.Sine sine(
          amplitude=0,
          f=1/260,
          phase=3.1415926535898,
          startTime=1000)
          annotation (Placement(transformation(extent={{82,-20},{92,-10}})));

        Electrical.Buses.Bus Bus10(v_0=powerFlow.powerflow.bus.V10, angle_0=powerFlow.powerflow.bus.A10)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,-90})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T4(
          G=0,
          B=0,
          CW=1,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={10,-90})));
        GenerationUnits.PSSE.Solar_Units.SolarMPCLocalVQControl PV(
          V_b=480,
          P_0=powerFlow.powerflow.machines.PPV,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QPV,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V8,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A8,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-60},{-20,-40}})));

        Modelica.Blocks.Interfaces.RealOutput OUT4
          annotation (Placement(transformation(extent={{140,10},{160,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT5
          annotation (Placement(transformation(extent={{140,-10},{160,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT6
          annotation (Placement(transformation(extent={{140,-30},{160,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT7
          annotation (Placement(transformation(extent={{140,-50},{160,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT8
          annotation (Placement(transformation(extent={{140,-70},{160,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT9
          annotation (Placement(transformation(extent={{140,-90},{160,-70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT10
          annotation (Placement(transformation(extent={{140,-110},{160,-90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT11
          annotation (Placement(transformation(extent={{164,70},{184,90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT12
          annotation (Placement(transformation(extent={{164,50},{184,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT13
          annotation (Placement(transformation(extent={{164,30},{184,50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT14
          annotation (Placement(transformation(extent={{164,10},{184,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT15
          annotation (Placement(transformation(extent={{164,-10},{184,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT16
          annotation (Placement(transformation(extent={{164,-30},{184,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT17
          annotation (Placement(transformation(extent={{164,-50},{184,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT18
          annotation (Placement(transformation(extent={{164,-70},{184,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT19
          annotation (Placement(transformation(extent={{164,-90},{184,-70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT20
          annotation (Placement(transformation(extent={{164,-110},{184,-90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT21
          annotation (Placement(transformation(extent={{184,70},{204,90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT22
          annotation (Placement(transformation(extent={{184,50},{204,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT23
          annotation (Placement(transformation(extent={{184,30},{204,50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT24
          annotation (Placement(transformation(extent={{184,10},{204,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT25
          annotation (Placement(transformation(extent={{184,-10},{204,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT26
          annotation (Placement(transformation(extent={{184,-30},{204,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT27
          annotation (Placement(transformation(extent={{184,-50},{204,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT28
          annotation (Placement(transformation(extent={{184,-70},{204,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT29
          annotation (Placement(transformation(extent={{184,-90},{204,-70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT30
          annotation (Placement(transformation(extent={{184,-110},{204,-90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT31
          annotation (Placement(transformation(extent={{204,70},{224,90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT32
          annotation (Placement(transformation(extent={{204,50},{224,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT33
          annotation (Placement(transformation(extent={{204,30},{224,50}})));
        GenerationUnits.PSSE.Battery_Units.BESSMPCLocalVQControl BESS(
          V_base=480,
          V_b(displayUnit="kV") = 480,
          enableV_b=true,
          P_0=powerFlow.powerflow.machines.PBESS,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QBESS,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V10,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A10,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-100},{-20,-80}})));
        Modelica.Blocks.Interfaces.RealOutput OUT34
          annotation (Placement(transformation(extent={{204,10},{224,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT35
          annotation (Placement(transformation(extent={{206,-10},{226,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT36
          annotation (Placement(transformation(extent={{206,-30},{226,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT37
          annotation (Placement(transformation(extent={{206,-50},{226,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT38
          annotation (Placement(transformation(extent={{206,-70},{226,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT39
          annotation (Placement(transformation(extent={{206,-90},{226,-70}})));
        Electrical.Buses.Bus Bus8(v_0=powerFlow.powerflow.bus.V8, angle_0=powerFlow.powerflow.bus.A8)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,-50})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T3(
          G=0,
          B=0,
          CW=1,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={12,-50})));
        Electrical.Buses.Bus Bus11(v_0=powerFlow.powerflow.bus.V11, angle_0=powerFlow.powerflow.bus.A11)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,-90})));
        Electrical.Buses.Bus Bus9(v_0=powerFlow.powerflow.bus.V9, angle_0=powerFlow.powerflow.bus.A9)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,-50})));
        Electrical.Buses.Bus Bus7(v_0=powerFlow.powerflow.bus.V7, angle_0=powerFlow.powerflow.bus.A7)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,10})));
        Electrical.Branches.PwLine          L4(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,6},{
                  50,14}})));
        Electrical.Branches.PwLine          L5(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,-54},
                  {50,-46}})));
        Electrical.Branches.PwLine          L6(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,-94},
                  {50,-86}})));
        Modelica.Blocks.Interfaces.RealOutput OUT40
          annotation (Placement(transformation(extent={{206,-110},{226,-90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT41
          annotation (Placement(transformation(extent={{224,70},{244,90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT42
          annotation (Placement(transformation(extent={{224,50},{244,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT43
          annotation (Placement(transformation(extent={{224,30},{244,50}})));
        Modelica.Blocks.Sources.CombiTimeTable combiTimeTable(table=[0,0; 0.5,
              1.63e-18; 1,3.25e-18; 1.5,0.01; 2,0.02; 2.5,0.03; 3,0.04; 3.5,
              0.05; 4,0.06; 4.5,0.07; 5,0.08; 5.5,0.09; 6,0.1; 6.5,0.11; 7,0.12;
              7.5,0.13; 8,0.14; 8.5,0.15; 9,0.16; 9.5,0.17; 10,0.18; 10.5,0.19;
              11,0.2; 11.5,0.21; 12,0.216005309; 12.5,0.213109436; 13,
              0.210605197; 13.5,0.208313713; 14,0.206171115; 14.5,0.204166729;
              15,0.202304256; 15.5,0.200585161; 16,0.199005596; 16.5,
              0.197556394; 17,0.196227474; 17.5,0.194028332; 18,0.190543197;
              18.5,0.189153799; 19,0.187753417; 19.5,0.186455549; 20,0.18537888;
              20.5,0.184561474; 21,0.183901627; 21.5,0.183370188; 22,
              0.182944999; 22.5,0.182605242; 23,0.182333794; 23.5,0.182116953;
              24,0.181943746; 24.5,0.181805396; 25,0.181699723; 25.5,
              0.181607001; 26,0.181536581; 26.5,0.181480402; 27,0.181435107;
              27.5,0.181398901; 28,0.181369977; 28.5,0.181346952; 29,
              0.181328528; 29.5,0.181313853], smoothness=Modelica.Blocks.Types.Smoothness.ConstantSegments)
          annotation (Placement(transformation(extent={{-100,6},{-80,26}})));
        Modelica.Blocks.Sources.CombiTimeTable combiTimeTable1(table=[0,0; 0.5,
              8.72e-17; 1,1.74e-16; 1.5,0.05; 2,0.1; 2.5,0.15; 3,0.2; 3.5,0.25;
              4,0.294480528; 4.5,0.265283387; 5,0.243480264; 5.5,0.225768212; 6,
              0.212390384; 6.5,0.202472182; 7,0.195322955; 7.5,0.190395046; 8,
              0.187259567; 8.5,0.185571463; 9,0.185047655; 9.5,0.185460555; 10,
              0.186624853; 10.5,0.186375363; 11,0.182795578; 11.5,0.17934458;
              12,0.175395873; 12.5,0.172017353; 13,0.169218394; 13.5,
              0.166935569; 14,0.165063451; 14.5,0.163494548; 15,0.162141664;
              15.5,0.16094197; 16,0.15985398; 16.5,0.158849237; 17,0.157909049;
              17.5,0.157096639; 18,0.156434608; 18.5,0.155926438; 19,
              0.155599894; 19.5,0.15531796; 20,0.155112583; 20.5,0.154963331;
              21,0.154855096; 21.5,0.154776993; 22,0.154721031; 22.5,
              0.154681297; 23,0.154653411; 23.5,0.154634131; 24,0.154621064;
              24.5,0.154612443; 25,0.154640782; 25.5,0.154652872; 26,0.15465697;
              26.5,0.154657349; 27,0.1546561; 27.5,0.154654258; 28,0.154652357;
              28.5,0.154650585; 29,0.154649047; 29.5,0.154647753], smoothness=
              Modelica.Blocks.Types.Smoothness.ConstantSegments)
          annotation (Placement(transformation(extent={{-100,-20},{-80,0}})));
        Modelica.Blocks.Sources.CombiTimeTable combiTimeTable2(table=[0,0; 0.5,
              1.26e-15; 1,2.52e-15; 1.5,0.000901236; 2,0.006688066; 2.5,
              0.010506773; 3,0.013024043; 3.5,0.014691572; 4,0.015638802; 4.5,
              0.016189828; 5,0.016656838; 5.5,0.016933452; 6,0.017106284; 6.5,
              0.017191582; 7,0.017205629; 7.5,0.017162624; 8,0.017073898; 8.5,
              0.016948851; 9,0.016795322; 9.5,0.016619658; 10,0.01642716; 10.5,
              0.016226794; 11,0.016033937; 11.5,0.015854393; 12,0.015695113;
              12.5,0.015557794; 13,0.015437971; 13.5,0.015333235; 14,
              0.015241857; 14.5,0.015162436; 15,0.01509382; 15.5,0.015035303;
              16,0.014985779; 16.5,0.014944803; 17,0.01491133; 17.5,0.014885026;
              18,0.014863264; 18.5,0.014845892; 19,0.014831932; 19.5,0.01482082;
              20,0.014812247; 20.5,0.014805443; 21,0.014800026; 21.5,
              0.014795709; 22,0.014792269; 22.5,0.014789527; 23,0.014787341;
              23.5,0.014785598; 24,0.014784209; 24.5,0.014783101; 25,0.0147821;
              25.5,0.014781214; 26,0.014780437; 26.5,0.014779768; 27,0.0147792;
              27.5,0.01477972; 28,0.014778321; 28.5,0.014778632; 29,0.014778549;
              29.5,0.014778314], smoothness=Modelica.Blocks.Types.Smoothness.ConstantSegments)
          annotation (Placement(transformation(extent={{-100,-48},{-80,-28}})));
        Modelica.Blocks.Sources.CombiTimeTable combiTimeTable3(table=[0,0; 0.5,
              1.77e-15; 1,3.54e-15; 1.5,-1.63e-18; 2,-3.32e-19; 2.5,3.19e-19; 3,
              -1.18e-17; 3.5,5.68e-18; 4,3.94e-18; 4.5,3.52e-18; 5,-8.35e-19;
              5.5,-1.56e-18; 6,-2.18e-18; 6.5,6.44e-19; 7,-7.57e-20; 7.5,-3.34e-20;
              8,-3.17e-18; 8.5,-2.73e-18; 9,-2.63e-18; 9.5,-1.87e-18; 10,-1.39e-18;
              10.5,-2.18e-18; 11,1.36e-18; 11.5,-3.83e-19; 12,-3.67e-19; 12.5,
              5.13e-19; 13,-3.46e-19; 13.5,-3.37e-19; 14,-3.3e-19; 14.5,
              1.11e-19; 15,1.16e-19; 15.5,1.21e-19; 16,-9.26e-20; 16.5,1.79e-20;
              17,1.89e-20; 17.5,-8.12e-21; 18,-6.22e-20; 18.5,-7.99e-21; 19,-7.97e-21;
              19.5,-8.11e-21; 20,-8.27e-21; 20.5,-8.45e-21; 21,4.92e-21; 21.5,
              1.83e-20; 22,4.58e-21; 22.5,4.44e-21; 23,-2.47e-21; 23.5,-2.59e-21;
              24,-2.69e-21; 24.5,6.05e-22; 25,6.06e-22; 25.5,6.07e-22; 26,
              6.07e-22; 26.5,6.08e-22; 27,6.08e-22; 27.5,-2.39e-22; 28,6.09e-22;
              28.5,-2.38e-22; 29,1.85e-22; 29.5,-2.38e-22], smoothness=Modelica.Blocks.Types.Smoothness.ConstantSegments)
          annotation (Placement(transformation(extent={{-100,-94},{-80,-74}})));
        Modelica.Blocks.Sources.CombiTimeTable combiTimeTable4(table=[0,0; 0.5,
              1.26e-15; 1,2.52e-15; 1.5,3.4e-17; 2,2.57e-17; 2.5,1.16e-18; 3,
              1.16e-18; 3.5,1.16e-18; 4,-5.79e-19; 4.5,2.88e-19; 5,2.88e-19;
              5.5,1.16e-18; 6,-1.45e-19; 6.5,7.14e-20; 7,9.53e-18; 7.5,1.01e-17;
              8,1.2e-17; 8.5,1.53e-17; 9,1.64e-17; 9.5,1.71e-17; 10,1.56e-17;
              10.5,1.28e-17; 11,-2.55e-18; 11.5,-1.26e-18; 12,2.79e-19; 12.5,
              1.67e-20; 13,1.49e-19; 13.5,4.51e-20; 14,1.45e-19; 14.5,1.25e-19;
              15,-1.72e-20; 15.5,4.26e-20; 16,8.66e-20; 16.5,-4.79e-20; 17,-3.31e-20;
              17.5,-6.01e-21; 18,-6.09e-21; 18.5,7.47e-21; 19,6.89e-22; 19.5,
              8.15e-22; 20,4.35e-21; 20.5,1.12e-21; 21,1.27e-21; 21.5,-2.68e-22;
              22,-1.27e-22; 22.5,1.28e-24; 23,1.16e-22; 23.5,2.18e-22; 24,
              3.06e-22; 24.5,3.83e-22; 25,3.83e-22; 25.5,-4.08e-23; 26,-4.08e-23;
              26.5,1.71e-22; 27,-4.08e-23; 27.5,-1e-06; 28,0; 28.5,-6.49e-07;
              29,-8.46e-07; 29.5,-8.44e-07], smoothness=Modelica.Blocks.Types.Smoothness.ConstantSegments)
          annotation (Placement(transformation(extent={{-100,-120},{-80,-100}})));
      equation

      OUT1 = G2.gen.w;
      OUT2 = G2.gen.delta;
      OUT3 = G2.gen.Epq;
      OUT4 = G2.gen.PSIkd;
      OUT5 = G2.gen.PSIppq;
      OUT6 = G2.sEXSMPC.simpleLagLim.state;
      OUT7 = G2.sEXSMPC.leadLag.TF.x_scaled[1];
      OUT8 = G2.gASTMPC.simpleLagLim.state;
      OUT9 = G2.gASTMPC.simpleLag.state;
      OUT10 = G2.gASTMPC.simpleLag1.state;
      OUT11 = PV.rEGCA1_1.simpleLag.state;
      OUT12 = PV.rEGCA1_1.integrator.y;
      OUT13 = PV.rEGCA1_1.integrator1.y;
      OUT14 =PV.EC.IGQ.y;
      OUT15 =PV.EC.IGV.y;
      OUT16 =PV.EC.simpleLag.state;
      OUT17 =PV.EC.simpleLag1.state;
      OUT18 =PV.EC.simpleLag2.state;
      OUT19 =PV.EC.IGP.y;
      OUT20 =PV.EC.simpleLag3.state;
      OUT21 =PV.EC.simpleLag4.state;
      OUT22 =PV.EC.simpleLag5.state;
      OUT23 = BESS.rEGCA1_1.simpleLag.state;
      OUT24 = BESS.rEGCA1_1.integrator.y;
      OUT25 = BESS.rEGCA1_1.integrator1.y;
      OUT26 =BESS.EC.integrator3.y;
      OUT27 =BESS.EC.integrator1.y;
      OUT28 =BESS.EC.simpleLag.state;
      OUT29 =BESS.EC.IGQ.y;
      OUT30 =BESS.EC.IGV.y;
      OUT31 =BESS.EC.IGP.y;
      OUT32 =BESS.EC.simpleLag1.state;
      OUT33 =BESS.EC.simpleLag2.state;
      OUT34 =BESS.EC.simpleLag3.state;
      OUT35 =BESS.EC.simpleLag4.state;
      OUT36 = G2.gen.PMECH;
      OUT37 = G2.sEXSMPC.EFD;
      OUT38 = BESS.rEGCA1_1.Pgen;
      OUT39 = BESS.rEGCA1_1.Qgen;
      OUT40 = PV.rEGCA1_1.Pgen;
      OUT41 = PV.rEGCA1_1.Qgen;
      OUT42 = Bus5.v;
      OUT43 = Bus5.angle;

        connect(T1.p, Bus2.p)
          annotation (Line(points={{-51.2,80},{-40,80}}, color={0,0,255}));
        connect(Bus1.p, T1.n)
          annotation (Line(points={{-80,80},{-68.8,80}}, color={0,0,255}));
        connect(G1.conn, Bus1.p)
          annotation (Line(points={{-91,80},{-80,80}}, color={0,0,255}));
        connect(L1.n, Bus3.p)
          annotation (Line(points={{-14.6,80},{0,80}}, color={0,0,255}));
        connect(L1.p, Bus2.p)
          annotation (Line(points={{-25.4,80},{-40,80}}, color={0,0,255}));
        connect(L2_2.n, Bus4.p) annotation (Line(points={{35.4,70},{44,70},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.n, Bus4.p) annotation (Line(points={{35.4,90},{44,90},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.p, Bus3.p) annotation (Line(points={{24.6,90},{16,90},{16,80},{0,
                80}}, color={0,0,255}));
        connect(L2_2.p, Bus3.p) annotation (Line(points={{24.6,70},{16,70},{16,80},{0,
                80}}, color={0,0,255}));
        connect(Load1.p, Bus3.p)
          annotation (Line(points={{-10,68},{-10,80},{0,80}}, color={0,0,255}));
        connect(L3.p, Bus4.p)
          annotation (Line(points={{80,65.4},{80,80},{60,80}}, color={0,0,255}));
        connect(breaker.s, Bus5.p)
          annotation (Line(points={{80,22},{80,16}},color={0,0,255}));
        connect(breaker.r, L3.n)
          annotation (Line(points={{80,30},{80,54.6}},color={0,0,255}));

        connect(IB.p, Bus4.p)
          annotation (Line(points={{100,80},{60,80}}, color={0,0,255}));
        connect(Load2.p, Bus5.p) annotation (Line(points={{110,-10},{110,10},{80,10},{
                80,16}},
                     color={0,0,255}));
        connect(T4.n, Bus10.p)
          annotation (Line(points={{-1,-90},{-10,-90}}, color={0,0,255}));
        connect(Bus6.p, T2.n)
          annotation (Line(points={{-10,10},{-1,10}},
                                                  color={0,0,255}));
        connect(BESS.p1, Bus10.p)
          annotation (Line(points={{-20,-90},{-10,-90}}, color={0,0,255}));
        connect(G2.conn, Bus6.p) annotation (Line(points={{-19,10},{-10,10}},
                                           color={0,0,255}));
        connect(PV.p1, Bus8.p)
          annotation (Line(points={{-20,-50},{-10,-50}}, color={0,0,255}));
        connect(Bus8.p, T3.n)
          annotation (Line(points={{-10,-50},{1,-50}},  color={0,0,255}));
        connect(sine.y, Load2.u) annotation (Line(points={{92.5,-15},{96.1,-15},{96.1,
                -14.5},{101.9,-14.5}}, color={0,0,127}));
        connect(T2.p, Bus7.p) annotation (Line(points={{21,10},{25.5,10},{25.5,10},{30,
                10}}, color={0,0,255}));
        connect(T3.p, Bus9.p)
          annotation (Line(points={{23,-50},{30,-50}}, color={0,0,255}));
        connect(T4.p, Bus11.p)
          annotation (Line(points={{21,-90},{30,-90}}, color={0,0,255}));
        connect(L4.n, Bus5.p) annotation (Line(points={{49.4,10},{60,10},{60,10},{80,10},
                {80,16}},     color={0,0,255}));
        connect(L5.n, Bus5.p) annotation (Line(points={{49.4,-50},{60,-50},{60,10},{80,
                10},{80,16}}, color={0,0,255}));
        connect(Bus11.p, L6.p)
          annotation (Line(points={{30,-90},{38.6,-90}}, color={0,0,255}));
        connect(Bus9.p, L5.p)
          annotation (Line(points={{30,-50},{38.6,-50}}, color={0,0,255}));
        connect(L6.n, Bus5.p) annotation (Line(points={{49.4,-90},{60,-90},{60,10},{80,
                10},{80,16}}, color={0,0,255}));
        connect(Bus7.p, L4.p) annotation (Line(points={{30,10},{34.3,10},{34.3,10},{38.6,
                10}}, color={0,0,255}));
        connect(combiTimeTable.y[1], G2.P_ref1)
          annotation (Line(points={{-79,16},{-42,16}}, color={0,0,127}));
        connect(combiTimeTable1.y[1], G2.Efd_ref) annotation (Line(points={{-79,
                -10},{-52,-10},{-52,4},{-42,4}}, color={0,0,127}));
        connect(combiTimeTable2.y[1], PV.QINPUT) annotation (Line(points={{-79,
                -38},{-50,-38},{-50,-50},{-42,-50}}, color={0,0,127}));
        connect(combiTimeTable3.y[1], BESS.Paux1)
          annotation (Line(points={{-79,-84},{-42,-84}}, color={0,0,127}));
        connect(combiTimeTable4.y[1], BESS.Qext1) annotation (Line(points={{-79,
                -110},{-52,-110},{-52,-96},{-42,-96}}, color={0,0,127}));
          annotation (Placement(transformation(extent={{140,-20},{160,0}})),
                      Placement(transformation(extent={{140,-40},{160,-20}})),
                      Placement(transformation(extent={{140,-60},{160,-40}})),
                      Placement(transformation(extent={{140,-80},{160,-60}})),
                     Diagram(coordinateSystem(preserveAspectRatio=false,
                extent={{-140,-140},{140,140}}), graphics={
              Rectangle(
                extent={{130,98},{252,-124}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,36},{124,-124}},
                lineColor={238,46,47},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,98},{124,38}},
                lineColor={0,128,255},
                lineThickness=0.5),
              Text(
                extent={{78,-106},{114,-120}},
                textColor={238,46,47},
                textString="Microgrid"),
              Text(
                extent={{76,58},{128,34}},
                textColor={28,108,200},
                textString="Utility Grid"),
              Text(
                extent={{-30,-102},{34,-124}},
                textColor={0,140,72},
                textString="Linearization Unit"),
              Text(
                extent={{-164,50},{-132,30}},
                textColor={0,140,72},
                textString="Inputs"),
              Text(
                extent={{128,118},{168,98}},
                textColor={0,140,72},
                textString="Outputs")}),
          Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),experiment(StopTime=30, __Dymola_Algorithm="Dassl"),
          Icon(coordinateSystem(extent={{-140,-140},{140,140}})));
      end MPCAppliedEnergyOriginal_TABLE_mode2;

      model MPCAppliedEnergyOriginal_TABLE_mode3
        "THIS ONE IS STABLE, CONTROLLABLE, OBSERVABLE!!!!!!!"
        extends Modelica.Icons.Example;

        parameter Boolean equivalentGRID = false;
        parameter Boolean equivalentsystem = false;

        OpenIPSL.Electrical.Buses.Bus Bus1(v_0=powerFlow.powerflow.bus.V1, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-90,70},{-70,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus2(v_0=powerFlow.powerflow.bus.V2, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-50,70},{-30,90}})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
          R=0.001,
          X=0.2,
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000)  if not equivalentGRID annotation (Placement(transformation(
              extent={{-8,-8},{8,8}},
              rotation=180,
              origin={-60,80})));
        OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
          enableV_b=true,
          v_0=powerFlow.powerflow.bus.V1,
          angle_0=powerFlow.powerflow.bus.A1,
          P_0=powerFlow.powerflow.machines.PG1,
          Q_0=powerFlow.powerflow.machines.QG1,
          V_b=6000)  if not equivalentGRID
          annotation (Placement(transformation(extent={{-112,70},{-92,90}})));
        OpenIPSL.Electrical.Branches.PwLine L1(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{-26,76},
                  {-14,84}})));
        OpenIPSL.Electrical.Buses.Bus Bus3(v_0=powerFlow.powerflow.bus.V3, angle_0=
              powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-10,70},{10,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus4(v_0=powerFlow.powerflow.bus.V4, angle_0=
              powerFlow.powerflow.bus.V4) if not equivalentGRID
          annotation (Placement(transformation(extent={{50,70},{70,90}})));
        OpenIPSL.Electrical.Branches.PwLine L2_1(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,86},
                  {36,94}})));
        OpenIPSL.Electrical.Branches.PwLine L2_2(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,66},
                  {36,74}})));
        OpenIPSL.Electrical.Buses.Bus Bus5(angle_0=powerFlow.powerflow.bus.A5, v_0=
              powerFlow.powerflow.bus.V5)  annotation (Placement(
              transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={80,16})));
        OpenIPSL.Electrical.Branches.PwLine L3(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=-90,
              origin={80,60})));
        OpenIPSL.Electrical.Buses.Bus Bus6(v_0=powerFlow.powerflow.bus.V6, angle_0=
              powerFlow.powerflow.bus.A6) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,10})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000,
          R=0.005,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={10,10})));
        GenerationUnits.PSSE.G2_16MVA                         G2(
          enableV_b=true,
          enableP_0=true,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V6,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A6,
          V_b=6000,
          P_0=powerFlow.powerflow.machines.PG2,
          Q_0=powerFlow.powerflow.machines.QG2,
          enableangle_0=true)
                        annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-30,10})));
        inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000, fn=60)
          annotation (Placement(transformation(extent={{-128,104},{-74,124}})));
        OpenIPSL.Electrical.Loads.PSSE.Load Load1(
          V_b=220000,
          P_0=powerFlow.powerflow.loads.PL1,
          Q_0=powerFlow.powerflow.loads.QL1,
          v_0=powerFlow.powerflow.bus.V3,
          angle_0=powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-20,48},{0,68}})));
        Electrical.Events.Breaker breaker(enableTrigger=false,
          t_o=1.01,
          rc_enabled=true,
          t_rc=80.01)       if not equivalentGRID                     annotation (Placement(transformation(
              extent={{-4,-4},{4,4}},
              rotation=90,
              origin={80,26})));

        Modelica.Blocks.Interfaces.RealOutput OUT1
          annotation (Placement(transformation(extent={{140,70},{160,90}})));
       Modelica.Blocks.Interfaces.RealOutput OUT2
          annotation (Placement(transformation(extent={{140,50},{160,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT3
          annotation (Placement(transformation(extent={{140,30},{160,50}})));

        PFData.PowerFlow powerFlow(redeclare record PowerFlow =
              OpenIPSL.Examples.ModelPredictiveControl.PFData.PF16)
          annotation (Placement(transformation(extent={{-68,104},{-48,124}})));
        Electrical.Machines.PSSE.GENCLS IB(
          V_b=220000,
          v_0=powerFlow.powerflow.bus.V4,
          angle_0=powerFlow.powerflow.bus.A4,
          P_0=powerFlow.powerflow.machines.Pinf,
          Q_0=powerFlow.powerflow.machines.Qinf,
          M_b=100000000,
          X_d=1) if not equivalentGRID annotation (Placement(transformation(extent={{110,70},
                  {100,90}})));
        Electrical.Loads.PSSE.Load_ExtInput Load2(
          P_0=powerFlow.powerflow.loads.PL2,
          Q_0=powerFlow.powerflow.loads.QL2,
          v_0=powerFlow.powerflow.bus.V5,
          angle_0=powerFlow.powerflow.bus.A5,
          d_P=0,
          t1=100,
          d_t=1000)
          annotation (Placement(transformation(extent={{100,-30},{120,-10}})));

        inner Modelica.Blocks.Noise.GlobalSeed globalSeed(useAutomaticSeed=false,
            fixedSeed=10000)
          annotation (Placement(transformation(extent={{-42,102},{-22,122}})));
        Modelica.Blocks.Sources.Sine sine(
          amplitude=0,
          f=1/260,
          phase=3.1415926535898,
          startTime=1000)
          annotation (Placement(transformation(extent={{82,-20},{92,-10}})));

        Electrical.Buses.Bus Bus10(v_0=powerFlow.powerflow.bus.V10, angle_0=powerFlow.powerflow.bus.A10)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,-90})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T4(
          G=0,
          B=0,
          CW=1,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={10,-90})));
        GenerationUnits.PSSE.Solar_Units.SolarMPCLocalVQControl PV(
          V_b=480,
          P_0=powerFlow.powerflow.machines.PPV,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QPV,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V8,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A8,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-60},{-20,-40}})));

        Modelica.Blocks.Interfaces.RealOutput OUT4
          annotation (Placement(transformation(extent={{140,10},{160,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT5
          annotation (Placement(transformation(extent={{140,-10},{160,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT6
          annotation (Placement(transformation(extent={{140,-30},{160,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT7
          annotation (Placement(transformation(extent={{140,-50},{160,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT8
          annotation (Placement(transformation(extent={{140,-70},{160,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT9
          annotation (Placement(transformation(extent={{140,-90},{160,-70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT10
          annotation (Placement(transformation(extent={{140,-110},{160,-90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT11
          annotation (Placement(transformation(extent={{164,70},{184,90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT12
          annotation (Placement(transformation(extent={{164,50},{184,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT13
          annotation (Placement(transformation(extent={{164,30},{184,50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT14
          annotation (Placement(transformation(extent={{164,10},{184,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT15
          annotation (Placement(transformation(extent={{164,-10},{184,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT16
          annotation (Placement(transformation(extent={{164,-30},{184,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT17
          annotation (Placement(transformation(extent={{164,-50},{184,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT18
          annotation (Placement(transformation(extent={{164,-70},{184,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT19
          annotation (Placement(transformation(extent={{164,-90},{184,-70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT20
          annotation (Placement(transformation(extent={{164,-110},{184,-90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT21
          annotation (Placement(transformation(extent={{184,70},{204,90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT22
          annotation (Placement(transformation(extent={{184,50},{204,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT23
          annotation (Placement(transformation(extent={{184,30},{204,50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT24
          annotation (Placement(transformation(extent={{184,10},{204,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT25
          annotation (Placement(transformation(extent={{184,-10},{204,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT26
          annotation (Placement(transformation(extent={{184,-30},{204,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT27
          annotation (Placement(transformation(extent={{184,-50},{204,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT28
          annotation (Placement(transformation(extent={{184,-70},{204,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT29
          annotation (Placement(transformation(extent={{184,-90},{204,-70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT30
          annotation (Placement(transformation(extent={{184,-110},{204,-90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT31
          annotation (Placement(transformation(extent={{204,70},{224,90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT32
          annotation (Placement(transformation(extent={{204,50},{224,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT33
          annotation (Placement(transformation(extent={{204,30},{224,50}})));
        GenerationUnits.PSSE.Battery_Units.BESSMPCLocalVQControl BESS(
          V_base=480,
          V_b(displayUnit="kV") = 480,
          enableV_b=true,
          P_0=powerFlow.powerflow.machines.PBESS,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QBESS,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V10,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A10,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-100},{-20,-80}})));
        Modelica.Blocks.Interfaces.RealOutput OUT34
          annotation (Placement(transformation(extent={{204,10},{224,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT35
          annotation (Placement(transformation(extent={{206,-10},{226,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT36
          annotation (Placement(transformation(extent={{206,-30},{226,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT37
          annotation (Placement(transformation(extent={{206,-50},{226,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT38
          annotation (Placement(transformation(extent={{206,-70},{226,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT39
          annotation (Placement(transformation(extent={{206,-90},{226,-70}})));
        Electrical.Buses.Bus Bus8(v_0=powerFlow.powerflow.bus.V8, angle_0=powerFlow.powerflow.bus.A8)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,-50})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T3(
          G=0,
          B=0,
          CW=1,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={12,-50})));
        Electrical.Buses.Bus Bus11(v_0=powerFlow.powerflow.bus.V11, angle_0=powerFlow.powerflow.bus.A11)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,-90})));
        Electrical.Buses.Bus Bus9(v_0=powerFlow.powerflow.bus.V9, angle_0=powerFlow.powerflow.bus.A9)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,-50})));
        Electrical.Buses.Bus Bus7(v_0=powerFlow.powerflow.bus.V7, angle_0=powerFlow.powerflow.bus.A7)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,10})));
        Electrical.Branches.PwLine          L4(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,6},{
                  50,14}})));
        Electrical.Branches.PwLine          L5(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,-54},
                  {50,-46}})));
        Electrical.Branches.PwLine          L6(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,-94},
                  {50,-86}})));
        Modelica.Blocks.Interfaces.RealOutput OUT40
          annotation (Placement(transformation(extent={{206,-110},{226,-90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT41
          annotation (Placement(transformation(extent={{224,70},{244,90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT42
          annotation (Placement(transformation(extent={{224,50},{244,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT43
          annotation (Placement(transformation(extent={{224,30},{244,50}})));
        Modelica.Blocks.Sources.CombiTimeTable combiTimeTable(table=[0,0; 0.5,
              1.63e-18; 1,3.25e-18; 1.5,0.01; 2,-5.2e-17; 2.5,0.01; 3,
              0.012018287; 3.5,0.018344075; 4,0.011720761; 4.5,0.012300868; 5,
              0.010138889; 5.5,0.009591433; 6,0.008637586; 6.5,0.008047798; 7,
              0.007498672; 7.5,0.007069727; 8,0.006722317; 8.5,0.006432896; 9,
              0.006200144; 9.5,0.006009931; 10,0.005855601; 10.5,0.005729994;
              11,0.005627959; 11.5,0.005544947; 12,0.005477509; 12.5,
              0.005422662; 13,0.00537808; 13.5,0.005341631; 14,0.005313493;
              14.5,0.005288816; 15,0.005269423; 15.5,0.005253475; 16,
              0.005240627; 16.5,0.005230138; 17,0.005221628; 17.5,0.005214752;
              18,0.005209071; 18.5,0.005204524; 19,0.005200765; 19.5,
              0.005197764; 20,0.005195281; 20.5,0.005193284; 21,0.005191659;
              21.5,0.005190341; 22,0.005189276; 22.5,0.005188402; 23,
              0.005187679; 23.5,0.005187112; 24,0.005186666; 24.5,0.00518627;
              25,0.005185968; 25.5,0.005185709; 26,0.005185501; 26.5,0.00518535;
              27,0.005185205; 27.5,0.005185091; 28,0.005185005; 28.5,
              0.005184931; 29,0.005184872; 29.5,0.005184824], smoothness=
              Modelica.Blocks.Types.Smoothness.ConstantSegments)
          annotation (Placement(transformation(extent={{-100,6},{-80,26}})));
        Modelica.Blocks.Sources.CombiTimeTable combiTimeTable1(table=[0,0; 0.5,
              8.72e-17; 1,1.74e-16; 1.5,-0.05; 2,1.6e-16; 2.5,0.020788911; 3,
              0.028969492; 3.5,0.033168917; 4,0.033290846; 4.5,0.033253872; 5,
              0.032883028; 5.5,0.032676023; 6,0.032498267; 6.5,0.032386125; 7,
              0.032302081; 7.5,0.032240984; 8,0.032195423; 8.5,0.032159475; 9,
              0.032130463; 9.5,0.032106694; 10,0.03208725; 10.5,0.032071337; 11,
              0.03205835; 11.5,0.032047752; 12,0.032039125; 12.5,0.032032099;
              13,0.032026382; 13.5,0.032021718; 14,0.03201812; 14.5,0.032015304;
              15,0.032013021; 15.5,0.032011104; 16,0.03200952; 16.5,0.032008211;
              17,0.032007137; 17.5,0.032006234; 18,0.032005521; 18.5,
              0.032004927; 19,0.032004458; 19.5,0.032004067; 20,0.032003758;
              20.5,0.032003506; 21,0.0320033; 21.5,0.032003132; 22,0.032002991;
              22.5,0.032002882; 23,0.032002786; 23.5,0.032002721; 24,
              0.032002672; 24.5,0.032002643; 25,0.032002617; 25.5,0.032002597;
              26,0.032002582; 26.5,0.032002573; 27,0.032002553; 27.5,
              0.032002537; 28,0.032002527; 28.5,0.03200252; 29,0.032002515;
              29.5,0.032002512], smoothness=Modelica.Blocks.Types.Smoothness.ConstantSegments)
          annotation (Placement(transformation(extent={{-100,-20},{-80,0}})));
        Modelica.Blocks.Sources.CombiTimeTable combiTimeTable2(table=[0,0; 0.5,
              1.26e-15; 1,2.52e-15; 1.5,-3.36e-17; 2,-4.45e-19; 2.5,-1.58e-18;
              3,4.28e-20; 3.5,-1.14e-20; 4,-1.14e-20; 4.5,2.17e-21; 5,8.95e-21;
              5.5,4.06e-07; 6,4.76e-22; 6.5,-3.71e-22; 7,-3.71e-22; 7.5,-3.71e-22;
              8,5.29e-23; 8.5,5.29e-23; 9,2.65e-22; 9.5,5.29e-23; 10,5.29e-23;
              10.5,5.29e-23; 11,-8.14e-07; 11.5,0; 12,-5.38e-07; 12.5,-7.07e-07;
              13,-7.08e-07; 13.5,-8.33e-07; 14,-6.35e-07; 14.5,-5.12e-07; 15,-4e-07;
              15.5,-3.27e-07; 16,-2.64e-07; 16.5,-2.15e-07; 17,-1.75e-07; 17.5,
              -1.47e-07; 18,-1.18e-07; 18.5,-9.79e-08; 19,-7.84e-08; 19.5,-6.49e-08;
              20,-5.19e-08; 20.5,-4.16e-08; 21,-3.37e-08; 21.5,-2.73e-08; 22,-2.29e-08;
              22.5,4.61e-07; 23,2.23e-07; 23.5,5.41e-07; 24,2.67e-07; 24.5,
              4.79e-07; 25,6.5e-07; 25.5,7.9e-07; 26,3.92e-07; 26.5,4.86e-07;
              27,5.6e-07; 27.5,6.21e-07; 28,6.7e-07; 28.5,7.1e-07; 29,7.43e-07;
              29.5,7.7e-07], smoothness=Modelica.Blocks.Types.Smoothness.ConstantSegments)
          annotation (Placement(transformation(extent={{-100,-48},{-80,-28}})));
        Modelica.Blocks.Sources.CombiTimeTable combiTimeTable3(table=[0,0; 0.5,
              1.77e-15; 1,3.54e-15; 1.5,0.05; 2,0.024838528; 2.5,0.034316539; 3,
              0.028648948; 3.5,0.030350876; 4,0.029219023; 4.5,0.029525673; 5,
              0.029329908; 5.5,0.029376572; 6,0.02933671; 6.5,0.029335159; 7,
              0.029324175; 7.5,0.029316997; 8,0.029312496; 8.5,0.029307744; 9,
              0.029304223; 9.5,0.029301189; 10,0.029298777; 10.5,0.02929679; 11,
              0.029295183; 11.5,0.029293876; 12,0.029292813; 12.5,0.029291949;
              13,0.029291247; 13.5,0.029290452; 14,0.029290204; 14.5,
              0.029289755; 15,0.029289488; 15.5,0.029289224; 16,0.029289028;
              16.5,0.029288861; 17,0.029288728; 17.5,0.02928862; 18,0.029288529;
              18.5,0.02928846; 19,0.029288399; 19.5,0.029288353; 20,0.029288313;
              20.5,0.029288282; 21,0.029288257; 21.5,0.029288236; 22,
              0.029288219; 22.5,0.029288203; 23,0.029288197; 23.5,0.029288176;
              24,0.02928818; 24.5,0.029288168; 25,0.029288166; 25.5,0.029288161;
              26,0.02928816; 26.5,0.029288154; 27,0.029288154; 27.5,0.029288151;
              28,0.02928815; 28.5,0.029288149; 29,0.029288148; 29.5,0.029288147],
            smoothness=Modelica.Blocks.Types.Smoothness.ConstantSegments)
          annotation (Placement(transformation(extent={{-100,-94},{-80,-74}})));
        Modelica.Blocks.Sources.CombiTimeTable combiTimeTable4(table=[0,0; 0.5,
              1.26e-15; 1,2.52e-15; 1.5,0.013963432; 2,0.012045376; 2.5,
              0.0083516; 3,0.007874428; 3.5,0.007164645; 4,0.007147054; 4.5,
              0.007080234; 5,0.007142216; 5.5,0.007172701; 6,0.007215719; 6.5,
              0.007244268; 7,0.007271442; 7.5,0.007291538; 8,0.00730936; 8.5,
              0.007323639; 9,0.007335148; 9.5,0.007344504; 10,0.007352093; 10.5,
              0.007358263; 11,0.007364092; 11.5,0.007367354; 12,0.007371208;
              12.5,0.00737407; 13,0.007376262; 13.5,0.007378018; 14,0.007379306;
              14.5,0.007380417; 15,0.007381266; 15.5,0.007381977; 16,
              0.007382547; 16.5,0.007383014; 17,0.007383392; 17.5,0.007383701;
              18,0.007383952; 18.5,0.007384155; 19,0.007384321; 19.5,
              0.007384454; 20,0.007384564; 20.5,0.007384651; 21,0.007384723;
              21.5,0.007384782; 22,0.007384829; 22.5,0.007384388; 23,
              0.007384658; 23.5,0.007384366; 24,0.007384663; 24.5,0.007384471;
              25,0.007384313; 25.5,0.007384185; 26,0.007384593; 26.5,0.00738451;
              27,0.007384441; 27.5,0.007384385; 28,0.00738434; 28.5,0.007384303;
              29,0.007384273; 29.5,0.007384249], smoothness=Modelica.Blocks.Types.Smoothness.ConstantSegments)
          annotation (Placement(transformation(extent={{-100,-120},{-80,-100}})));
      equation

      OUT1 = G2.gen.w;
      OUT2 = G2.gen.delta;
      OUT3 = G2.gen.Epq;
      OUT4 = G2.gen.PSIkd;
      OUT5 = G2.gen.PSIppq;
      OUT6 = G2.sEXSMPC.simpleLagLim.state;
      OUT7 = G2.sEXSMPC.leadLag.TF.x_scaled[1];
      OUT8 = G2.gASTMPC.simpleLagLim.state;
      OUT9 = G2.gASTMPC.simpleLag.state;
      OUT10 = G2.gASTMPC.simpleLag1.state;
      OUT11 = PV.rEGCA1_1.simpleLag.state;
      OUT12 = PV.rEGCA1_1.integrator.y;
      OUT13 = PV.rEGCA1_1.integrator1.y;
      OUT14 =PV.EC.IGQ.y;
      OUT15 =PV.EC.IGV.y;
      OUT16 =PV.EC.simpleLag.state;
      OUT17 =PV.EC.simpleLag1.state;
      OUT18 =PV.EC.simpleLag2.state;
      OUT19 =PV.EC.IGP.y;
      OUT20 =PV.EC.simpleLag3.state;
      OUT21 =PV.EC.simpleLag4.state;
      OUT22 =PV.EC.simpleLag5.state;
      OUT23 = BESS.rEGCA1_1.simpleLag.state;
      OUT24 = BESS.rEGCA1_1.integrator.y;
      OUT25 = BESS.rEGCA1_1.integrator1.y;
      OUT26 =BESS.EC.integrator3.y;
      OUT27 =BESS.EC.integrator1.y;
      OUT28 =BESS.EC.simpleLag.state;
      OUT29 =BESS.EC.IGQ.y;
      OUT30 =BESS.EC.IGV.y;
      OUT31 =BESS.EC.IGP.y;
      OUT32 =BESS.EC.simpleLag1.state;
      OUT33 =BESS.EC.simpleLag2.state;
      OUT34 =BESS.EC.simpleLag3.state;
      OUT35 =BESS.EC.simpleLag4.state;
      OUT36 = G2.gen.PMECH;
      OUT37 = G2.sEXSMPC.EFD;
      OUT38 = BESS.rEGCA1_1.Pgen;
      OUT39 = BESS.rEGCA1_1.Qgen;
      OUT40 = PV.rEGCA1_1.Pgen;
      OUT41 = PV.rEGCA1_1.Qgen;
      OUT42 = Bus5.v;
      OUT43 = Bus5.angle;

        connect(T1.p, Bus2.p)
          annotation (Line(points={{-51.2,80},{-40,80}}, color={0,0,255}));
        connect(Bus1.p, T1.n)
          annotation (Line(points={{-80,80},{-68.8,80}}, color={0,0,255}));
        connect(G1.conn, Bus1.p)
          annotation (Line(points={{-91,80},{-80,80}}, color={0,0,255}));
        connect(L1.n, Bus3.p)
          annotation (Line(points={{-14.6,80},{0,80}}, color={0,0,255}));
        connect(L1.p, Bus2.p)
          annotation (Line(points={{-25.4,80},{-40,80}}, color={0,0,255}));
        connect(L2_2.n, Bus4.p) annotation (Line(points={{35.4,70},{44,70},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.n, Bus4.p) annotation (Line(points={{35.4,90},{44,90},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.p, Bus3.p) annotation (Line(points={{24.6,90},{16,90},{16,80},{0,
                80}}, color={0,0,255}));
        connect(L2_2.p, Bus3.p) annotation (Line(points={{24.6,70},{16,70},{16,80},{0,
                80}}, color={0,0,255}));
        connect(Load1.p, Bus3.p)
          annotation (Line(points={{-10,68},{-10,80},{0,80}}, color={0,0,255}));
        connect(L3.p, Bus4.p)
          annotation (Line(points={{80,65.4},{80,80},{60,80}}, color={0,0,255}));
        connect(breaker.s, Bus5.p)
          annotation (Line(points={{80,22},{80,16}},color={0,0,255}));
        connect(breaker.r, L3.n)
          annotation (Line(points={{80,30},{80,54.6}},color={0,0,255}));

        connect(IB.p, Bus4.p)
          annotation (Line(points={{100,80},{60,80}}, color={0,0,255}));
        connect(Load2.p, Bus5.p) annotation (Line(points={{110,-10},{110,10},{80,10},{
                80,16}},
                     color={0,0,255}));
        connect(T4.n, Bus10.p)
          annotation (Line(points={{-1,-90},{-10,-90}}, color={0,0,255}));
        connect(Bus6.p, T2.n)
          annotation (Line(points={{-10,10},{-1,10}},
                                                  color={0,0,255}));
        connect(BESS.p1, Bus10.p)
          annotation (Line(points={{-20,-90},{-10,-90}}, color={0,0,255}));
        connect(G2.conn, Bus6.p) annotation (Line(points={{-19,10},{-10,10}},
                                           color={0,0,255}));
        connect(PV.p1, Bus8.p)
          annotation (Line(points={{-20,-50},{-10,-50}}, color={0,0,255}));
        connect(Bus8.p, T3.n)
          annotation (Line(points={{-10,-50},{1,-50}},  color={0,0,255}));
        connect(sine.y, Load2.u) annotation (Line(points={{92.5,-15},{96.1,-15},{96.1,
                -14.5},{101.9,-14.5}}, color={0,0,127}));
        connect(T2.p, Bus7.p) annotation (Line(points={{21,10},{25.5,10},{25.5,10},{30,
                10}}, color={0,0,255}));
        connect(T3.p, Bus9.p)
          annotation (Line(points={{23,-50},{30,-50}}, color={0,0,255}));
        connect(T4.p, Bus11.p)
          annotation (Line(points={{21,-90},{30,-90}}, color={0,0,255}));
        connect(L4.n, Bus5.p) annotation (Line(points={{49.4,10},{60,10},{60,10},{80,10},
                {80,16}},     color={0,0,255}));
        connect(L5.n, Bus5.p) annotation (Line(points={{49.4,-50},{60,-50},{60,10},{80,
                10},{80,16}}, color={0,0,255}));
        connect(Bus11.p, L6.p)
          annotation (Line(points={{30,-90},{38.6,-90}}, color={0,0,255}));
        connect(Bus9.p, L5.p)
          annotation (Line(points={{30,-50},{38.6,-50}}, color={0,0,255}));
        connect(L6.n, Bus5.p) annotation (Line(points={{49.4,-90},{60,-90},{60,10},{80,
                10},{80,16}}, color={0,0,255}));
        connect(Bus7.p, L4.p) annotation (Line(points={{30,10},{34.3,10},{34.3,10},{38.6,
                10}}, color={0,0,255}));
        connect(combiTimeTable.y[1], G2.P_ref1)
          annotation (Line(points={{-79,16},{-42,16}}, color={0,0,127}));
        connect(combiTimeTable1.y[1], G2.Efd_ref) annotation (Line(points={{-79,
                -10},{-52,-10},{-52,4},{-42,4}}, color={0,0,127}));
        connect(combiTimeTable2.y[1], PV.QINPUT) annotation (Line(points={{-79,
                -38},{-50,-38},{-50,-50},{-42,-50}}, color={0,0,127}));
        connect(combiTimeTable3.y[1], BESS.Paux1)
          annotation (Line(points={{-79,-84},{-42,-84}}, color={0,0,127}));
        connect(combiTimeTable4.y[1], BESS.Qext1) annotation (Line(points={{-79,
                -110},{-52,-110},{-52,-96},{-42,-96}}, color={0,0,127}));
          annotation (Placement(transformation(extent={{140,-20},{160,0}})),
                      Placement(transformation(extent={{140,-40},{160,-20}})),
                      Placement(transformation(extent={{140,-60},{160,-40}})),
                      Placement(transformation(extent={{140,-80},{160,-60}})),
                     Diagram(coordinateSystem(preserveAspectRatio=false,
                extent={{-140,-140},{140,140}}), graphics={
              Rectangle(
                extent={{130,98},{252,-124}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,36},{124,-124}},
                lineColor={238,46,47},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,98},{124,38}},
                lineColor={0,128,255},
                lineThickness=0.5),
              Text(
                extent={{78,-106},{114,-120}},
                textColor={238,46,47},
                textString="Microgrid"),
              Text(
                extent={{76,58},{128,34}},
                textColor={28,108,200},
                textString="Utility Grid"),
              Text(
                extent={{-30,-102},{34,-124}},
                textColor={0,140,72},
                textString="Linearization Unit"),
              Text(
                extent={{-164,50},{-132,30}},
                textColor={0,140,72},
                textString="Inputs"),
              Text(
                extent={{128,118},{168,98}},
                textColor={0,140,72},
                textString="Outputs")}),
          Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),experiment(StopTime=30, __Dymola_Algorithm="Dassl"),
          Icon(coordinateSystem(extent={{-140,-140},{140,140}})));
      end MPCAppliedEnergyOriginal_TABLE_mode3;

      model MPCAppliedEnergyOriginal_TABLE_mode4
        "THIS ONE IS STABLE, CONTROLLABLE, OBSERVABLE!!!!!!!"
        extends Modelica.Icons.Example;

        parameter Boolean equivalentGRID = false;
        parameter Boolean equivalentsystem = false;

        OpenIPSL.Electrical.Buses.Bus Bus1(v_0=powerFlow.powerflow.bus.V1, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-90,70},{-70,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus2(v_0=powerFlow.powerflow.bus.V2, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-50,70},{-30,90}})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
          R=0.001,
          X=0.2,
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000)  if not equivalentGRID annotation (Placement(transformation(
              extent={{-8,-8},{8,8}},
              rotation=180,
              origin={-60,80})));
        OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
          enableV_b=true,
          v_0=powerFlow.powerflow.bus.V1,
          angle_0=powerFlow.powerflow.bus.A1,
          P_0=powerFlow.powerflow.machines.PG1,
          Q_0=powerFlow.powerflow.machines.QG1,
          V_b=6000)  if not equivalentGRID
          annotation (Placement(transformation(extent={{-112,70},{-92,90}})));
        OpenIPSL.Electrical.Branches.PwLine L1(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{-26,76},
                  {-14,84}})));
        OpenIPSL.Electrical.Buses.Bus Bus3(v_0=powerFlow.powerflow.bus.V3, angle_0=
              powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-10,70},{10,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus4(v_0=powerFlow.powerflow.bus.V4, angle_0=
              powerFlow.powerflow.bus.V4) if not equivalentGRID
          annotation (Placement(transformation(extent={{50,70},{70,90}})));
        OpenIPSL.Electrical.Branches.PwLine L2_1(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,86},
                  {36,94}})));
        OpenIPSL.Electrical.Branches.PwLine L2_2(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,66},
                  {36,74}})));
        OpenIPSL.Electrical.Buses.Bus Bus5(angle_0=powerFlow.powerflow.bus.A5, v_0=
              powerFlow.powerflow.bus.V5)  annotation (Placement(
              transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={80,16})));
        OpenIPSL.Electrical.Branches.PwLine L3(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=-90,
              origin={80,60})));
        OpenIPSL.Electrical.Buses.Bus Bus6(v_0=powerFlow.powerflow.bus.V6, angle_0=
              powerFlow.powerflow.bus.A6) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,10})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000,
          R=0.005,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={10,10})));
        GenerationUnits.PSSE.G2_16MVA                         G2(
          enableV_b=true,
          enableP_0=true,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V6,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A6,
          V_b=6000,
          P_0=powerFlow.powerflow.machines.PG2,
          Q_0=powerFlow.powerflow.machines.QG2,
          enableangle_0=true)
                        annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-30,10})));
        inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000, fn=60)
          annotation (Placement(transformation(extent={{-128,104},{-74,124}})));
        OpenIPSL.Electrical.Loads.PSSE.Load Load1(
          V_b=220000,
          P_0=powerFlow.powerflow.loads.PL1,
          Q_0=powerFlow.powerflow.loads.QL1,
          v_0=powerFlow.powerflow.bus.V3,
          angle_0=powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-20,48},{0,68}})));
        Electrical.Events.Breaker breaker(enableTrigger=false,
          t_o=1.01,
          rc_enabled=true,
          t_rc=80.01)       if not equivalentGRID                     annotation (Placement(transformation(
              extent={{-4,-4},{4,4}},
              rotation=90,
              origin={80,26})));

        Modelica.Blocks.Interfaces.RealOutput OUT1
          annotation (Placement(transformation(extent={{140,70},{160,90}})));
       Modelica.Blocks.Interfaces.RealOutput OUT2
          annotation (Placement(transformation(extent={{140,50},{160,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT3
          annotation (Placement(transformation(extent={{140,30},{160,50}})));

        PFData.PowerFlow powerFlow(redeclare record PowerFlow =
              OpenIPSL.Examples.ModelPredictiveControl.PFData.PF16)
          annotation (Placement(transformation(extent={{-68,104},{-48,124}})));
        Electrical.Machines.PSSE.GENCLS IB(
          V_b=220000,
          v_0=powerFlow.powerflow.bus.V4,
          angle_0=powerFlow.powerflow.bus.A4,
          P_0=powerFlow.powerflow.machines.Pinf,
          Q_0=powerFlow.powerflow.machines.Qinf,
          M_b=100000000,
          X_d=1) if not equivalentGRID annotation (Placement(transformation(extent={{110,70},
                  {100,90}})));
        Electrical.Loads.PSSE.Load_ExtInput Load2(
          P_0=powerFlow.powerflow.loads.PL2,
          Q_0=powerFlow.powerflow.loads.QL2,
          v_0=powerFlow.powerflow.bus.V5,
          angle_0=powerFlow.powerflow.bus.A5,
          d_P=0,
          t1=100,
          d_t=1000)
          annotation (Placement(transformation(extent={{100,-30},{120,-10}})));

        inner Modelica.Blocks.Noise.GlobalSeed globalSeed(useAutomaticSeed=false,
            fixedSeed=10000)
          annotation (Placement(transformation(extent={{-42,102},{-22,122}})));
        Modelica.Blocks.Sources.Sine sine(
          amplitude=0,
          f=1/260,
          phase=3.1415926535898,
          startTime=1000)
          annotation (Placement(transformation(extent={{82,-20},{92,-10}})));

        Electrical.Buses.Bus Bus10(v_0=powerFlow.powerflow.bus.V10, angle_0=powerFlow.powerflow.bus.A10)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,-90})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T4(
          G=0,
          B=0,
          CW=1,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={10,-90})));
        GenerationUnits.PSSE.Solar_Units.SolarMPCLocalVQControl PV(
          V_b=480,
          P_0=powerFlow.powerflow.machines.PPV,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QPV,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V8,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A8,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-60},{-20,-40}})));

        Modelica.Blocks.Interfaces.RealOutput OUT4
          annotation (Placement(transformation(extent={{140,10},{160,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT5
          annotation (Placement(transformation(extent={{140,-10},{160,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT6
          annotation (Placement(transformation(extent={{140,-30},{160,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT7
          annotation (Placement(transformation(extent={{140,-50},{160,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT8
          annotation (Placement(transformation(extent={{140,-70},{160,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT9
          annotation (Placement(transformation(extent={{140,-90},{160,-70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT10
          annotation (Placement(transformation(extent={{140,-110},{160,-90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT11
          annotation (Placement(transformation(extent={{164,70},{184,90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT12
          annotation (Placement(transformation(extent={{164,50},{184,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT13
          annotation (Placement(transformation(extent={{164,30},{184,50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT14
          annotation (Placement(transformation(extent={{164,10},{184,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT15
          annotation (Placement(transformation(extent={{164,-10},{184,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT16
          annotation (Placement(transformation(extent={{164,-30},{184,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT17
          annotation (Placement(transformation(extent={{164,-50},{184,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT18
          annotation (Placement(transformation(extent={{164,-70},{184,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT19
          annotation (Placement(transformation(extent={{164,-90},{184,-70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT20
          annotation (Placement(transformation(extent={{164,-110},{184,-90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT21
          annotation (Placement(transformation(extent={{184,70},{204,90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT22
          annotation (Placement(transformation(extent={{184,50},{204,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT23
          annotation (Placement(transformation(extent={{184,30},{204,50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT24
          annotation (Placement(transformation(extent={{184,10},{204,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT25
          annotation (Placement(transformation(extent={{184,-10},{204,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT26
          annotation (Placement(transformation(extent={{184,-30},{204,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT27
          annotation (Placement(transformation(extent={{184,-50},{204,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT28
          annotation (Placement(transformation(extent={{184,-70},{204,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT29
          annotation (Placement(transformation(extent={{184,-90},{204,-70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT30
          annotation (Placement(transformation(extent={{184,-110},{204,-90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT31
          annotation (Placement(transformation(extent={{204,70},{224,90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT32
          annotation (Placement(transformation(extent={{204,50},{224,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT33
          annotation (Placement(transformation(extent={{204,30},{224,50}})));
        GenerationUnits.PSSE.Battery_Units.BESSMPCLocalVQControl BESS(
          V_base=480,
          V_b(displayUnit="kV") = 480,
          enableV_b=true,
          P_0=powerFlow.powerflow.machines.PBESS,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QBESS,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V10,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A10,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-100},{-20,-80}})));
        Modelica.Blocks.Interfaces.RealOutput OUT34
          annotation (Placement(transformation(extent={{204,10},{224,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT35
          annotation (Placement(transformation(extent={{206,-10},{226,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT36
          annotation (Placement(transformation(extent={{206,-30},{226,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT37
          annotation (Placement(transformation(extent={{206,-50},{226,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT38
          annotation (Placement(transformation(extent={{206,-70},{226,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT39
          annotation (Placement(transformation(extent={{206,-90},{226,-70}})));
        Electrical.Buses.Bus Bus8(v_0=powerFlow.powerflow.bus.V8, angle_0=powerFlow.powerflow.bus.A8)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,-50})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T3(
          G=0,
          B=0,
          CW=1,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={12,-50})));
        Electrical.Buses.Bus Bus11(v_0=powerFlow.powerflow.bus.V11, angle_0=powerFlow.powerflow.bus.A11)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,-90})));
        Electrical.Buses.Bus Bus9(v_0=powerFlow.powerflow.bus.V9, angle_0=powerFlow.powerflow.bus.A9)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,-50})));
        Electrical.Buses.Bus Bus7(v_0=powerFlow.powerflow.bus.V7, angle_0=powerFlow.powerflow.bus.A7)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,10})));
        Electrical.Branches.PwLine          L4(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,6},{
                  50,14}})));
        Electrical.Branches.PwLine          L5(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,-54},
                  {50,-46}})));
        Electrical.Branches.PwLine          L6(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,-94},
                  {50,-86}})));
        Modelica.Blocks.Interfaces.RealOutput OUT40
          annotation (Placement(transformation(extent={{206,-110},{226,-90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT41
          annotation (Placement(transformation(extent={{224,70},{244,90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT42
          annotation (Placement(transformation(extent={{224,50},{244,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT43
          annotation (Placement(transformation(extent={{224,30},{244,50}})));
        Modelica.Blocks.Sources.CombiTimeTable combiTimeTable(table=[0,0; 0.5,
              1.63e-18; 1,3.25e-18; 1.5,0.01; 2,-7.46e-17; 2.5,0.01; 3,
              0.011947754; 3.5,0.018469101; 4,0.011764015; 4.5,0.012390771; 5,
              0.010205379; 5.5,0.009669309; 6,0.00871494; 6.5,0.008126979; 7,
              0.007577389; 7.5,0.007148819; 8,0.006800779; 8.5,0.006511839; 9,
              0.006278707; 9.5,0.006088355; 10,0.005933983; 10.5,0.005808338;
              11,0.00570625; 11.5,0.005623227; 12,0.005555742; 12.5,0.005500873;
              13,0.005456268; 13.5,0.005419799; 14,0.005391647; 14.5,
              0.005366957; 15,0.005347556; 15.5,0.005331599; 16,0.005318744;
              16.5,0.005308249; 17,0.005299735; 17.5,0.005292855; 18,0.00528717;
              18.5,0.005282621; 19,0.005278861; 19.5,0.005275857; 20,
              0.005273373; 20.5,0.005271375; 21,0.005269749; 21.5,0.00526843;
              22,0.005267365; 22.5,0.005266491; 23,0.005265768; 23.5,
              0.005265203; 24,0.005264756; 24.5,0.005264361; 25,0.005264057;
              25.5,0.0052638; 26,0.005263592; 26.5,0.005263441; 27,0.005263294;
              27.5,0.005263182; 28,0.005263095; 28.5,0.005263022; 29,
              0.005262964; 29.5,0.005262916], smoothness=Modelica.Blocks.Types.Smoothness.ConstantSegments)
          annotation (Placement(transformation(extent={{-100,6},{-80,26}})));
        Modelica.Blocks.Sources.CombiTimeTable combiTimeTable1(table=[0,0; 0.5,
              8.72e-17; 1,1.74e-16; 1.5,-0.05; 2,1.8e-16; 2.5,0.020899243; 3,
              0.029894402; 3.5,0.034593171; 4,0.035008482; 4.5,0.035133463; 5,
              0.034855779; 5.5,0.034700953; 6,0.034553084; 6.5,0.034457033; 7,
              0.034381429; 7.5,0.034324496; 8,0.03428055; 8.5,0.034244785; 9,
              0.034215471; 9.5,0.034191198; 10,0.034171212; 10.5,0.034154789;
              11,0.034141345; 11.5,0.034130361; 12,0.034121402; 12.5,
              0.034114102; 13,0.03410816; 13.5,0.034103311; 14,0.034099559;
              14.5,0.034096625; 15,0.034094247; 15.5,0.034092253; 16,
              0.034090606; 16.5,0.034089247; 17,0.034088131; 17.5,0.034087195;
              18,0.034086454; 18.5,0.034085837; 19,0.034085348; 19.5,
              0.034084942; 20,0.03408462; 20.5,0.034084359; 21,0.034084145;
              21.5,0.03408397; 22,0.034083824; 22.5,0.03408371; 23,0.034083636;
              23.5,0.034083575; 24,0.034083544; 24.5,0.034083512; 25,
              0.034083494; 25.5,0.034083489; 26,0.03408349; 26.5,0.034083472;
              27,0.034083446; 27.5,0.034083431; 28,0.034083426; 28.5,
              0.034083425; 29,0.034083426; 29.5,0.034083428], smoothness=
              Modelica.Blocks.Types.Smoothness.ConstantSegments)
          annotation (Placement(transformation(extent={{-100,-20},{-80,0}})));
        Modelica.Blocks.Sources.CombiTimeTable combiTimeTable2(table=[0,0; 0.5,
              1.26e-15; 1,2.52e-15; 1.5,0.04038; 2,0.038167268; 2.5,0.039627456;
              3,0.039142786; 3.5,0.040187805; 4,0.040055855; 4.5,0.040263843; 5,
              0.040272598; 5.5,0.04032756; 6,0.040341833; 6.5,0.040355937; 7,
              0.040363268; 7.5,0.040367197; 8,0.040371036; 8.5,0.04037324; 9,
              0.040374805; 9.5,0.040375887; 10,0.040376716; 10.5,0.040377353;
              11,0.040377859; 11.5,0.040378264; 12,0.040378591; 12.5,
              0.040378855; 13,0.040379069; 13.5,0.040379052; 14,0.040379305;
              14.5,0.040379456; 15,0.040379582; 15.5,0.040379663; 16,0.04037973;
              16.5,0.040379781; 17,0.040379822; 17.5,0.040379851; 18,
              0.040379881; 18.5,0.040379901; 19,0.040379921; 19.5,0.040379934;
              20,0.040379947; 20.5,0.040379958; 21,0.040379966; 21.5,
              0.040379972; 22,0.040379977; 22.5,0.040380461; 23,0.040380224;
              23.5,0.040380541; 24,0.040380268; 24.5,0.040380479; 25,
              0.040380651; 25.5,0.040380791; 26,0.040380394; 26.5,0.040380486;
              27,0.040380561; 27.5,0.040380622; 28,0.040380671; 28.5,
              0.040380712; 29,0.040380744; 29.5,0.040380771], smoothness=
              Modelica.Blocks.Types.Smoothness.ConstantSegments)
          annotation (Placement(transformation(extent={{-100,-48},{-80,-28}})));
        Modelica.Blocks.Sources.CombiTimeTable combiTimeTable3(table=[0,0; 0.5,
              1.77e-15; 1,3.54e-15; 1.5,0.05; 2,0.024796407; 2.5,0.034388945; 3,
              0.028637523; 3.5,0.03038199; 4,0.029228227; 4.5,0.029542322; 5,
              0.029342629; 5.5,0.029390417; 6,0.029350085; 6.5,0.029348681; 7,
              0.029337543; 7.5,0.029330455; 8,0.029325802; 8.5,0.029321057; 9,
              0.029317495; 9.5,0.029314434; 10,0.029312003; 10.5,0.029310001;
              11,0.029308384; 11.5,0.029307066; 12,0.029305996; 12.5,
              0.029305126; 13,0.029304419; 13.5,0.02930362; 14,0.029303369;
              14.5,0.029302916; 15,0.029302647; 15.5,0.029302382; 16,
              0.029302185; 16.5,0.029302016; 17,0.029301882; 17.5,0.029301774;
              18,0.029301682; 18.5,0.029301612; 19,0.029301551; 19.5,
              0.029301505; 20,0.029301464; 20.5,0.029301434; 21,0.029301408;
              21.5,0.029301387; 22,0.02930137; 22.5,0.029301354; 23,0.029301347;
              23.5,0.029301327; 24,0.02930133; 24.5,0.029301319; 25,0.029301317;
              25.5,0.029301312; 26,0.029301311; 26.5,0.029301305; 27,
              0.029301304; 27.5,0.029301302; 28,0.029301301; 28.5,0.0293013; 29,
              0.029301299; 29.5,0.029301298], smoothness=Modelica.Blocks.Types.Smoothness.ConstantSegments)
          annotation (Placement(transformation(extent={{-100,-94},{-80,-74}})));
        Modelica.Blocks.Sources.CombiTimeTable combiTimeTable4(table=[0,0; 0.5,
              1.26e-15; 1,2.52e-15; 1.5,-0.026462106; 2,-0.026068148; 2.5,-0.03118349;
              3,-0.031172361; 3.5,-0.032926079; 4,-0.032802321; 4.5,-0.033079393;
              5,-0.033023541; 5.5,-0.033048091; 6,-0.033019103; 6.5,-0.033004595;
              7,-0.032984659; 7.5,-0.032968426; 8,-0.032954493; 8.5,-0.0329424;
              9,-0.032932485; 9.5,-0.032924241; 10,-0.032917507; 10.5,-0.032911993;
              11,-0.032907503; 11.5,-0.032903844; 12,-0.032900869; 12.5,-0.032898448;
              13,-0.03289648; 13.5,-0.032894839; 14,-0.032893611; 14.5,-0.032892532;
              15,-0.0328917; 15.5,-0.032891; 16,-0.032890436; 16.5,-0.032889973;
              17,-0.032889598; 17.5,-0.032889291; 18,-0.032889041; 18.5,-0.03288884;
              19,-0.032888675; 19.5,-0.032888542; 20,-0.032888433; 20.5,-0.032888346;
              21,-0.032888274; 21.5,-0.032888216; 22,-0.032888169; 22.5,-0.03288861;
              23,-0.032888339; 23.5,-0.032888632; 24,-0.032888334; 24.5,-0.032888527;
              25,-0.032888684; 25.5,-0.032888811; 26,-0.032888403; 26.5,-0.032888486;
              27,-0.032888556; 27.5,-0.032888611; 28,-0.032888656; 28.5,-0.032888693;
              29,-0.032888723; 29.5,-0.032888747], smoothness=Modelica.Blocks.Types.Smoothness.ConstantSegments)
          annotation (Placement(transformation(extent={{-100,-120},{-80,-100}})));
      equation

      OUT1 = G2.gen.w;
      OUT2 = G2.gen.delta;
      OUT3 = G2.gen.Epq;
      OUT4 = G2.gen.PSIkd;
      OUT5 = G2.gen.PSIppq;
      OUT6 = G2.sEXSMPC.simpleLagLim.state;
      OUT7 = G2.sEXSMPC.leadLag.TF.x_scaled[1];
      OUT8 = G2.gASTMPC.simpleLagLim.state;
      OUT9 = G2.gASTMPC.simpleLag.state;
      OUT10 = G2.gASTMPC.simpleLag1.state;
      OUT11 = PV.rEGCA1_1.simpleLag.state;
      OUT12 = PV.rEGCA1_1.integrator.y;
      OUT13 = PV.rEGCA1_1.integrator1.y;
      OUT14 =PV.EC.IGQ.y;
      OUT15 =PV.EC.IGV.y;
      OUT16 =PV.EC.simpleLag.state;
      OUT17 =PV.EC.simpleLag1.state;
      OUT18 =PV.EC.simpleLag2.state;
      OUT19 =PV.EC.IGP.y;
      OUT20 =PV.EC.simpleLag3.state;
      OUT21 =PV.EC.simpleLag4.state;
      OUT22 =PV.EC.simpleLag5.state;
      OUT23 = BESS.rEGCA1_1.simpleLag.state;
      OUT24 = BESS.rEGCA1_1.integrator.y;
      OUT25 = BESS.rEGCA1_1.integrator1.y;
      OUT26 =BESS.EC.integrator3.y;
      OUT27 =BESS.EC.integrator1.y;
      OUT28 =BESS.EC.simpleLag.state;
      OUT29 =BESS.EC.IGQ.y;
      OUT30 =BESS.EC.IGV.y;
      OUT31 =BESS.EC.IGP.y;
      OUT32 =BESS.EC.simpleLag1.state;
      OUT33 =BESS.EC.simpleLag2.state;
      OUT34 =BESS.EC.simpleLag3.state;
      OUT35 =BESS.EC.simpleLag4.state;
      OUT36 = G2.gen.PMECH;
      OUT37 = G2.sEXSMPC.EFD;
      OUT38 = BESS.rEGCA1_1.Pgen;
      OUT39 = BESS.rEGCA1_1.Qgen;
      OUT40 = PV.rEGCA1_1.Pgen;
      OUT41 = PV.rEGCA1_1.Qgen;
      OUT42 = Bus5.v;
      OUT43 = Bus5.angle;

        connect(T1.p, Bus2.p)
          annotation (Line(points={{-51.2,80},{-40,80}}, color={0,0,255}));
        connect(Bus1.p, T1.n)
          annotation (Line(points={{-80,80},{-68.8,80}}, color={0,0,255}));
        connect(G1.conn, Bus1.p)
          annotation (Line(points={{-91,80},{-80,80}}, color={0,0,255}));
        connect(L1.n, Bus3.p)
          annotation (Line(points={{-14.6,80},{0,80}}, color={0,0,255}));
        connect(L1.p, Bus2.p)
          annotation (Line(points={{-25.4,80},{-40,80}}, color={0,0,255}));
        connect(L2_2.n, Bus4.p) annotation (Line(points={{35.4,70},{44,70},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.n, Bus4.p) annotation (Line(points={{35.4,90},{44,90},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.p, Bus3.p) annotation (Line(points={{24.6,90},{16,90},{16,80},{0,
                80}}, color={0,0,255}));
        connect(L2_2.p, Bus3.p) annotation (Line(points={{24.6,70},{16,70},{16,80},{0,
                80}}, color={0,0,255}));
        connect(Load1.p, Bus3.p)
          annotation (Line(points={{-10,68},{-10,80},{0,80}}, color={0,0,255}));
        connect(L3.p, Bus4.p)
          annotation (Line(points={{80,65.4},{80,80},{60,80}}, color={0,0,255}));
        connect(breaker.s, Bus5.p)
          annotation (Line(points={{80,22},{80,16}},color={0,0,255}));
        connect(breaker.r, L3.n)
          annotation (Line(points={{80,30},{80,54.6}},color={0,0,255}));

        connect(IB.p, Bus4.p)
          annotation (Line(points={{100,80},{60,80}}, color={0,0,255}));
        connect(Load2.p, Bus5.p) annotation (Line(points={{110,-10},{110,10},{80,10},{
                80,16}},
                     color={0,0,255}));
        connect(T4.n, Bus10.p)
          annotation (Line(points={{-1,-90},{-10,-90}}, color={0,0,255}));
        connect(Bus6.p, T2.n)
          annotation (Line(points={{-10,10},{-1,10}},
                                                  color={0,0,255}));
        connect(BESS.p1, Bus10.p)
          annotation (Line(points={{-20,-90},{-10,-90}}, color={0,0,255}));
        connect(G2.conn, Bus6.p) annotation (Line(points={{-19,10},{-10,10}},
                                           color={0,0,255}));
        connect(PV.p1, Bus8.p)
          annotation (Line(points={{-20,-50},{-10,-50}}, color={0,0,255}));
        connect(Bus8.p, T3.n)
          annotation (Line(points={{-10,-50},{1,-50}},  color={0,0,255}));
        connect(sine.y, Load2.u) annotation (Line(points={{92.5,-15},{96.1,-15},{96.1,
                -14.5},{101.9,-14.5}}, color={0,0,127}));
        connect(T2.p, Bus7.p) annotation (Line(points={{21,10},{25.5,10},{25.5,10},{30,
                10}}, color={0,0,255}));
        connect(T3.p, Bus9.p)
          annotation (Line(points={{23,-50},{30,-50}}, color={0,0,255}));
        connect(T4.p, Bus11.p)
          annotation (Line(points={{21,-90},{30,-90}}, color={0,0,255}));
        connect(L4.n, Bus5.p) annotation (Line(points={{49.4,10},{60,10},{60,10},{80,10},
                {80,16}},     color={0,0,255}));
        connect(L5.n, Bus5.p) annotation (Line(points={{49.4,-50},{60,-50},{60,10},{80,
                10},{80,16}}, color={0,0,255}));
        connect(Bus11.p, L6.p)
          annotation (Line(points={{30,-90},{38.6,-90}}, color={0,0,255}));
        connect(Bus9.p, L5.p)
          annotation (Line(points={{30,-50},{38.6,-50}}, color={0,0,255}));
        connect(L6.n, Bus5.p) annotation (Line(points={{49.4,-90},{60,-90},{60,10},{80,
                10},{80,16}}, color={0,0,255}));
        connect(Bus7.p, L4.p) annotation (Line(points={{30,10},{34.3,10},{34.3,10},{38.6,
                10}}, color={0,0,255}));
        connect(combiTimeTable.y[1], G2.P_ref1)
          annotation (Line(points={{-79,16},{-42,16}}, color={0,0,127}));
        connect(combiTimeTable1.y[1], G2.Efd_ref) annotation (Line(points={{-79,
                -10},{-52,-10},{-52,4},{-42,4}}, color={0,0,127}));
        connect(combiTimeTable2.y[1], PV.QINPUT) annotation (Line(points={{-79,
                -38},{-50,-38},{-50,-50},{-42,-50}}, color={0,0,127}));
        connect(combiTimeTable3.y[1], BESS.Paux1)
          annotation (Line(points={{-79,-84},{-42,-84}}, color={0,0,127}));
        connect(combiTimeTable4.y[1], BESS.Qext1) annotation (Line(points={{-79,
                -110},{-52,-110},{-52,-96},{-42,-96}}, color={0,0,127}));
          annotation (Placement(transformation(extent={{140,-20},{160,0}})),
                      Placement(transformation(extent={{140,-40},{160,-20}})),
                      Placement(transformation(extent={{140,-60},{160,-40}})),
                      Placement(transformation(extent={{140,-80},{160,-60}})),
                     Diagram(coordinateSystem(preserveAspectRatio=false,
                extent={{-140,-140},{140,140}}), graphics={
              Rectangle(
                extent={{130,98},{252,-124}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,36},{124,-124}},
                lineColor={238,46,47},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,98},{124,38}},
                lineColor={0,128,255},
                lineThickness=0.5),
              Text(
                extent={{78,-106},{114,-120}},
                textColor={238,46,47},
                textString="Microgrid"),
              Text(
                extent={{76,58},{128,34}},
                textColor={28,108,200},
                textString="Utility Grid"),
              Text(
                extent={{-30,-102},{34,-124}},
                textColor={0,140,72},
                textString="Linearization Unit"),
              Text(
                extent={{-164,50},{-132,30}},
                textColor={0,140,72},
                textString="Inputs"),
              Text(
                extent={{128,118},{168,98}},
                textColor={0,140,72},
                textString="Outputs")}),
          Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),experiment(
            StopTime=5,
            __Dymola_NumberOfIntervals=100,
            __Dymola_Algorithm="Dassl"),
          Icon(coordinateSystem(extent={{-140,-140},{140,140}})));
      end MPCAppliedEnergyOriginal_TABLE_mode4;

      model MPCAppliedEnergyOriginal_TABLE_mode5
        "THIS ONE IS STABLE, CONTROLLABLE, OBSERVABLE!!!!!!!"
        extends Modelica.Icons.Example;

        parameter Boolean equivalentGRID = false;
        parameter Boolean equivalentsystem = false;

        OpenIPSL.Electrical.Buses.Bus Bus1(v_0=powerFlow.powerflow.bus.V1, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-90,70},{-70,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus2(v_0=powerFlow.powerflow.bus.V2, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-50,70},{-30,90}})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
          R=0.001,
          X=0.2,
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000)  if not equivalentGRID annotation (Placement(transformation(
              extent={{-8,-8},{8,8}},
              rotation=180,
              origin={-60,80})));
        OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
          enableV_b=true,
          v_0=powerFlow.powerflow.bus.V1,
          angle_0=powerFlow.powerflow.bus.A1,
          P_0=powerFlow.powerflow.machines.PG1,
          Q_0=powerFlow.powerflow.machines.QG1,
          V_b=6000)  if not equivalentGRID
          annotation (Placement(transformation(extent={{-112,70},{-92,90}})));
        OpenIPSL.Electrical.Branches.PwLine L1(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{-26,76},
                  {-14,84}})));
        OpenIPSL.Electrical.Buses.Bus Bus3(v_0=powerFlow.powerflow.bus.V3, angle_0=
              powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-10,70},{10,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus4(v_0=powerFlow.powerflow.bus.V4, angle_0=
              powerFlow.powerflow.bus.V4) if not equivalentGRID
          annotation (Placement(transformation(extent={{50,70},{70,90}})));
        OpenIPSL.Electrical.Branches.PwLine L2_1(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,86},
                  {36,94}})));
        OpenIPSL.Electrical.Branches.PwLine L2_2(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,66},
                  {36,74}})));
        OpenIPSL.Electrical.Buses.Bus Bus5(angle_0=powerFlow.powerflow.bus.A5, v_0=
              powerFlow.powerflow.bus.V5)  annotation (Placement(
              transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={80,16})));
        OpenIPSL.Electrical.Branches.PwLine L3(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=-90,
              origin={80,60})));
        OpenIPSL.Electrical.Buses.Bus Bus6(v_0=powerFlow.powerflow.bus.V6, angle_0=
              powerFlow.powerflow.bus.A6) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,10})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000,
          R=0.005,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={10,10})));
        GenerationUnits.PSSE.G2_16MVA                         G2(
          enableV_b=true,
          enableP_0=true,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V6,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A6,
          V_b=6000,
          P_0=powerFlow.powerflow.machines.PG2,
          Q_0=powerFlow.powerflow.machines.QG2,
          enableangle_0=true)
                        annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-30,10})));
        inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000, fn=60)
          annotation (Placement(transformation(extent={{-128,104},{-74,124}})));
        OpenIPSL.Electrical.Loads.PSSE.Load Load1(
          V_b=220000,
          P_0=powerFlow.powerflow.loads.PL1,
          Q_0=powerFlow.powerflow.loads.QL1,
          v_0=powerFlow.powerflow.bus.V3,
          angle_0=powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-20,48},{0,68}})));
        Electrical.Events.Breaker breaker(enableTrigger=false,
          t_o=1.01,
          rc_enabled=true,
          t_rc=80.01)       if not equivalentGRID                     annotation (Placement(transformation(
              extent={{-4,-4},{4,4}},
              rotation=90,
              origin={80,26})));

        Modelica.Blocks.Interfaces.RealOutput OUT1
          annotation (Placement(transformation(extent={{140,70},{160,90}})));
       Modelica.Blocks.Interfaces.RealOutput OUT2
          annotation (Placement(transformation(extent={{140,50},{160,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT3
          annotation (Placement(transformation(extent={{140,30},{160,50}})));

        PFData.PowerFlow powerFlow(redeclare record PowerFlow =
              OpenIPSL.Examples.ModelPredictiveControl.PFData.PF17)
          annotation (Placement(transformation(extent={{-68,104},{-48,124}})));
        Electrical.Machines.PSSE.GENCLS IB(
          V_b=220000,
          v_0=powerFlow.powerflow.bus.V4,
          angle_0=powerFlow.powerflow.bus.A4,
          P_0=powerFlow.powerflow.machines.Pinf,
          Q_0=powerFlow.powerflow.machines.Qinf,
          M_b=100000000,
          X_d=1) if not equivalentGRID annotation (Placement(transformation(extent={{110,70},
                  {100,90}})));
        Electrical.Loads.PSSE.Load_ExtInput Load2(
          P_0=powerFlow.powerflow.loads.PL2,
          Q_0=powerFlow.powerflow.loads.QL2,
          v_0=powerFlow.powerflow.bus.V5,
          angle_0=powerFlow.powerflow.bus.A5,
          d_P=0,
          t1=100,
          d_t=1000)
          annotation (Placement(transformation(extent={{100,-30},{120,-10}})));

        inner Modelica.Blocks.Noise.GlobalSeed globalSeed(useAutomaticSeed=false,
            fixedSeed=10000)
          annotation (Placement(transformation(extent={{-42,102},{-22,122}})));
        Modelica.Blocks.Sources.Sine sine(
          amplitude=0,
          f=1/260,
          phase=3.1415926535898,
          startTime=1000)
          annotation (Placement(transformation(extent={{82,-20},{92,-10}})));

        Electrical.Buses.Bus Bus10(v_0=powerFlow.powerflow.bus.V10, angle_0=powerFlow.powerflow.bus.A10)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,-90})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T4(
          G=0,
          B=0,
          CW=1,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={10,-90})));
        GenerationUnits.PSSE.Solar_Units.SolarMPCLocalVQControl PV(
          V_b=480,
          P_0=powerFlow.powerflow.machines.PPV,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QPV,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V8,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A8,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-60},{-20,-40}})));

        Modelica.Blocks.Interfaces.RealOutput OUT4
          annotation (Placement(transformation(extent={{140,10},{160,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT5
          annotation (Placement(transformation(extent={{140,-10},{160,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT6
          annotation (Placement(transformation(extent={{140,-30},{160,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT7
          annotation (Placement(transformation(extent={{140,-50},{160,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT8
          annotation (Placement(transformation(extent={{140,-70},{160,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT9
          annotation (Placement(transformation(extent={{140,-90},{160,-70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT10
          annotation (Placement(transformation(extent={{140,-110},{160,-90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT11
          annotation (Placement(transformation(extent={{164,70},{184,90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT12
          annotation (Placement(transformation(extent={{164,50},{184,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT13
          annotation (Placement(transformation(extent={{164,30},{184,50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT14
          annotation (Placement(transformation(extent={{164,10},{184,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT15
          annotation (Placement(transformation(extent={{164,-10},{184,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT16
          annotation (Placement(transformation(extent={{164,-30},{184,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT17
          annotation (Placement(transformation(extent={{164,-50},{184,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT18
          annotation (Placement(transformation(extent={{164,-70},{184,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT19
          annotation (Placement(transformation(extent={{164,-90},{184,-70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT20
          annotation (Placement(transformation(extent={{164,-110},{184,-90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT21
          annotation (Placement(transformation(extent={{184,70},{204,90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT22
          annotation (Placement(transformation(extent={{184,50},{204,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT23
          annotation (Placement(transformation(extent={{184,30},{204,50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT24
          annotation (Placement(transformation(extent={{184,10},{204,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT25
          annotation (Placement(transformation(extent={{184,-10},{204,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT26
          annotation (Placement(transformation(extent={{184,-30},{204,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT27
          annotation (Placement(transformation(extent={{184,-50},{204,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT28
          annotation (Placement(transformation(extent={{184,-70},{204,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT29
          annotation (Placement(transformation(extent={{184,-90},{204,-70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT30
          annotation (Placement(transformation(extent={{184,-110},{204,-90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT31
          annotation (Placement(transformation(extent={{204,70},{224,90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT32
          annotation (Placement(transformation(extent={{204,50},{224,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT33
          annotation (Placement(transformation(extent={{204,30},{224,50}})));
        GenerationUnits.PSSE.Battery_Units.BESSMPCLocalVQControl BESS(
          V_base=480,
          V_b(displayUnit="kV") = 480,
          enableV_b=true,
          P_0=powerFlow.powerflow.machines.PBESS,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QBESS,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V10,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A10,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-100},{-20,-80}})));
        Modelica.Blocks.Interfaces.RealOutput OUT34
          annotation (Placement(transformation(extent={{204,10},{224,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT35
          annotation (Placement(transformation(extent={{206,-10},{226,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT36
          annotation (Placement(transformation(extent={{206,-30},{226,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT37
          annotation (Placement(transformation(extent={{206,-50},{226,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT38
          annotation (Placement(transformation(extent={{206,-70},{226,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT39
          annotation (Placement(transformation(extent={{206,-90},{226,-70}})));
        Electrical.Buses.Bus Bus8(v_0=powerFlow.powerflow.bus.V8, angle_0=powerFlow.powerflow.bus.A8)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,-50})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T3(
          G=0,
          B=0,
          CW=1,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={12,-50})));
        Electrical.Buses.Bus Bus11(v_0=powerFlow.powerflow.bus.V11, angle_0=powerFlow.powerflow.bus.A11)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,-90})));
        Electrical.Buses.Bus Bus9(v_0=powerFlow.powerflow.bus.V9, angle_0=powerFlow.powerflow.bus.A9)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,-50})));
        Electrical.Buses.Bus Bus7(v_0=powerFlow.powerflow.bus.V7, angle_0=powerFlow.powerflow.bus.A7)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,10})));
        Electrical.Branches.PwLine          L4(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,6},{
                  50,14}})));
        Electrical.Branches.PwLine          L5(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,-54},
                  {50,-46}})));
        Electrical.Branches.PwLine          L6(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,-94},
                  {50,-86}})));
        Modelica.Blocks.Interfaces.RealOutput OUT40
          annotation (Placement(transformation(extent={{206,-110},{226,-90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT41
          annotation (Placement(transformation(extent={{224,70},{244,90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT42
          annotation (Placement(transformation(extent={{224,50},{244,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT43
          annotation (Placement(transformation(extent={{224,30},{244,50}})));
        Modelica.Blocks.Sources.CombiTimeTable combiTimeTable(table=[0,0; 0.5,-2.68e-18;
              1,-5.35e-18; 1.5,-0.01; 2,-0.02; 2.5,-0.03; 3,-0.04; 3.5,-0.05; 4,
              -0.06; 4.5,-0.07; 5,-0.08; 5.5,-0.09; 6,-0.1; 6.5,-0.11; 7,-0.12;
              7.5,-0.13; 8,-0.14; 8.5,-0.15; 9,-0.16; 9.5,-0.17; 10,-0.18; 10.5,
              -0.19; 11,-0.2; 11.5,-0.21; 12,-0.22; 12.5,-0.23; 13,-0.24; 13.5,
              -0.25; 14,-0.26; 14.5,-0.27; 15,-0.28; 15.5,-0.29; 16,-0.3; 16.5,
              -0.31; 17,-0.32; 17.5,-0.33; 18,-0.32826628; 18.5,-0.325796166;
              19,-0.323688923; 19.5,-0.321790062; 20,-0.320027013; 20.5,-0.318380983;
              21,-0.316852234; 21.5,-0.31544171; 22,-0.314145738; 22.5,-0.312133228;
              23,-0.308556286; 23.5,-0.307298764; 24,-0.305931655; 24.5,-0.304626396;
              25,-0.3035816; 25.5,-0.302764542; 26,-0.302109139; 26.5,-0.301584639;
              27,-0.301166952; 27.5,-0.300834552; 28,-0.300569906; 28.5,-0.300359207;
              29,-0.300191069; 29.5,-0.30004429],
                                              smoothness=Modelica.Blocks.Types.Smoothness.ConstantSegments)
          annotation (Placement(transformation(extent={{-100,6},{-80,26}})));
        Modelica.Blocks.Sources.CombiTimeTable combiTimeTable1(table=[0,0; 0.5,
              6.58e-17; 1,1.32e-16; 1.5,-0.05; 2,-0.1; 2.5,-0.15; 3,-0.2; 3.5,-0.25;
              4,-0.3; 4.5,-0.35; 5,-0.4; 5.5,-0.434840368; 6,-0.389296406; 6.5,
              -0.367017423; 7,-0.350904259; 7.5,-0.339406413; 8,-0.313122586;
              8.5,-0.310692091; 9,-0.297297382; 9.5,-0.288224051; 10,-0.28228848;
              10.5,-0.277458363; 11,-0.27351905; 11.5,-0.281780817; 12,-0.275215634;
              12.5,-0.272522928; 13,-0.271954805; 13.5,-0.271364668; 14,-0.270856027;
              14.5,-0.270532271; 15,-0.270513207; 15.5,-0.270745474; 16,-0.271068335;
              16.5,-0.27159941; 17,-0.271787379; 17.5,-0.272005846; 18,-0.272160451;
              18.5,-0.272211509; 19,-0.272163417; 19.5,-0.272179236; 20,-0.272248329;
              20.5,-0.272320862; 21,-0.27238111; 21.5,-0.272432361; 22,-0.272479954;
              22.5,-0.272507994; 23,-0.272489478; 23.5,-0.272497234; 24,-0.272512108;
              24.5,-0.272517726; 25,-0.27251731; 25.5,-0.27251585; 26,-0.272514826;
              26.5,-0.272514148; 27,-0.272513807; 27.5,-0.272512735; 28,-0.272512517;
              28.5,-0.272511721; 29,-0.272584921; 29.5,-0.272490555],
                                                              smoothness=
              Modelica.Blocks.Types.Smoothness.ConstantSegments)
          annotation (Placement(transformation(extent={{-100,-20},{-80,0}})));
        Modelica.Blocks.Sources.CombiTimeTable combiTimeTable2(table=[0,0; 0.5,
              1.56e-15; 1,3.13e-15; 1.5,-1.74e-20; 2,-2.87e-16; 2.5,-4.81e-16;
              3,-4.9e-16; 3.5,-3.99e-16; 4,-4.15e-16; 4.5,-4.2e-16; 5,-3.28e-16;
              5.5,-3.38e-16; 6,1.41e-19; 6.5,-5.93e-20; 7,-5.37e-21; 7.5,-1.6e-20;
              8,1.11e-20; 8.5,-1.84e-20; 9,-1.49e-20; 9.5,-1.34e-21; 10,-1.34e-21;
              10.5,-1.34e-21; 11,-1.34e-21; 11.5,2.63e-20; 12,-7.76e-22; 12.5,-7.76e-22;
              13,7.05e-23; 13.5,7.05e-23; 14,8.43e-07; 14.5,4.56e-07; 15,
              2.53e-07; 15.5,5.14e-07; 16,1.06e-22; 16.5,1.06e-22; 17,-3.18e-22;
              17.5,1.06e-22; 18,3.18e-22; 18.5,8.37e-07; 19,3.64e-07; 19.5,-1.66e-08;
              20,-2.72e-07; 20.5,-3.64e-07; 21,-4.09e-07; 21.5,-4.68e-07; 22,-5.47e-07;
              22.5,-1.06e-22; 23,-1.06e-22; 23.5,-1.06e-22; 24,-1.06e-22; 24.5,
              -1.06e-22; 25,1.06e-22; 25.5,1.06e-22; 26,-1.06e-22; 26.5,-9.29e-07;
              27,-1.24e-07; 27.5,-6.47e-07; 28,-7.64e-08; 28.5,-4.08e-07; 29,-4.83e-07;
              29.5,-6.16e-08],                                smoothness=
              Modelica.Blocks.Types.Smoothness.ConstantSegments)
          annotation (Placement(transformation(extent={{-100,-48},{-80,-28}})));
        Modelica.Blocks.Sources.CombiTimeTable combiTimeTable3(table=[0,0; 0.5,
              4.32e-17; 1,8.63e-17; 1.5,1.29e-16; 2,-1.39e-17; 2.5,-3.56e-17; 3,
              -2.37e-17; 3.5,-1.93e-17; 4,-1.17e-17; 4.5,4.01e-18; 5,2.19e-18;
              5.5,6.32e-18; 6,1.19e-17; 6.5,-3.63e-18; 7,7.79e-18; 7.5,6.12e-18;
              8,5.46e-18; 8.5,5.54e-17; 9,5.92e-17; 9.5,5.07e-17; 10,5.3e-17;
              10.5,4.85e-17; 11,5.07e-17; 11.5,3.05e-17; 12,2.97e-17; 12.5,
              3.23e-17; 13,2.94e-17; 13.5,2.74e-17; 14,2.27e-17; 14.5,1.82e-17;
              15,1.69e-17; 15.5,1.26e-17; 16,7.33e-18; 16.5,2.3e-18; 17,1.3e-18;
              17.5,4.71e-19; 18,6.09e-20; 18.5,1.46e-19; 19,2.39e-19; 19.5,
              1.09e-19; 20,-2.71e-20; 20.5,4.77e-20; 21,3.29e-19; 21.5,-7.54e-20;
              22,-3.67e-20; 22.5,-6.31e-21; 23,-3.66e-21; 23.5,-1.58e-21; 24,
              5.22e-23; 24.5,1.35e-21; 25,2.39e-21; 25.5,3.22e-21; 26,3.88e-21;
              26.5,4.41e-21; 27,-3.25e-21; 27.5,-2.92e-21; 28,-3.48e-21; 28.5,
              1.17e-22; 29,1.17e-22; 29.5,3.99e-22],
                                              smoothness=Modelica.Blocks.Types.Smoothness.ConstantSegments)
          annotation (Placement(transformation(extent={{-100,-94},{-80,-74}})));
        Modelica.Blocks.Sources.CombiTimeTable combiTimeTable4(table=[0,0; 0.5,
              1.56e-15; 1,3.13e-15; 1.5,1.65e-18; 2,-8.4e-20; 2.5,-8.4e-20; 3,-8.4e-20;
              3.5,-8.4e-20; 4,-8.4e-20; 4.5,-8.4e-20; 5,-8.4e-20; 5.5,-2.8e-19;
              6,-3.33e-19; 6.5,-8.17e-21; 7,1.99e-21; 7.5,9.17e-16; 8,9.34e-16;
              8.5,-3.71e-20; 9,7.72e-20; 9.5,2.12e-19; 10,3.81e-19; 10.5,
              1.48e-19; 11,3.76e-19; 11.5,1.29e-21; 12,7.57e-20; 12.5,1.56e-19;
              13,2.37e-20; 13.5,1.14e-19; 14,-1.11e-20; 14.5,8e-20; 15,5.8e-20;
              15.5,-7.99e-20; 16,9.74e-20; 16.5,4.49e-20; 17,2.34e-19; 17.5,
              1.09e-17; 18,1.04e-19; 18.5,1.13e-19; 19,1.07e-19; 19.5,8.7e-20;
              20,8.08e-20; 20.5,7.63e-20; 21,4.75e-20; 21.5,4.87e-20; 22,
              3.93e-20; 22.5,-6.27e-07; 23,-6.76e-07; 23.5,-6.52e-07; 24,-5.55e-07;
              24.5,-4.33e-07; 25,-3.3e-07; 25.5,-2.55e-07; 26,-1.99e-07; 26.5,
              7.73e-07; 27,-2.12e-22; 27.5,5.53e-07; 28,-1.06e-22; 28.5,
              3.51e-07; 29,9.92e-07; 29.5,2.72e-07],
                                                   smoothness=Modelica.Blocks.Types.Smoothness.ConstantSegments)
          annotation (Placement(transformation(extent={{-100,-120},{-80,-100}})));
      equation

      OUT1 = G2.gen.w;
      OUT2 = G2.gen.delta;
      OUT3 = G2.gen.Epq;
      OUT4 = G2.gen.PSIkd;
      OUT5 = G2.gen.PSIppq;
      OUT6 = G2.sEXSMPC.simpleLagLim.state;
      OUT7 = G2.sEXSMPC.leadLag.TF.x_scaled[1];
      OUT8 = G2.gASTMPC.simpleLagLim.state;
      OUT9 = G2.gASTMPC.simpleLag.state;
      OUT10 = G2.gASTMPC.simpleLag1.state;
      OUT11 = PV.rEGCA1_1.simpleLag.state;
      OUT12 = PV.rEGCA1_1.integrator.y;
      OUT13 = PV.rEGCA1_1.integrator1.y;
      OUT14 =PV.EC.IGQ.y;
      OUT15 =PV.EC.IGV.y;
      OUT16 =PV.EC.simpleLag.state;
      OUT17 =PV.EC.simpleLag1.state;
      OUT18 =PV.EC.simpleLag2.state;
      OUT19 =PV.EC.IGP.y;
      OUT20 =PV.EC.simpleLag3.state;
      OUT21 =PV.EC.simpleLag4.state;
      OUT22 =PV.EC.simpleLag5.state;
      OUT23 = BESS.rEGCA1_1.simpleLag.state;
      OUT24 = BESS.rEGCA1_1.integrator.y;
      OUT25 = BESS.rEGCA1_1.integrator1.y;
      OUT26 =BESS.EC.integrator3.y;
      OUT27 =BESS.EC.integrator1.y;
      OUT28 =BESS.EC.simpleLag.state;
      OUT29 =BESS.EC.IGQ.y;
      OUT30 =BESS.EC.IGV.y;
      OUT31 =BESS.EC.IGP.y;
      OUT32 =BESS.EC.simpleLag1.state;
      OUT33 =BESS.EC.simpleLag2.state;
      OUT34 =BESS.EC.simpleLag3.state;
      OUT35 =BESS.EC.simpleLag4.state;
      OUT36 = G2.gen.PMECH;
      OUT37 = G2.sEXSMPC.EFD;
      OUT38 = BESS.rEGCA1_1.Pgen;
      OUT39 = BESS.rEGCA1_1.Qgen;
      OUT40 = PV.rEGCA1_1.Pgen;
      OUT41 = PV.rEGCA1_1.Qgen;
      OUT42 = Bus5.v;
      OUT43 = Bus5.angle;

        connect(T1.p, Bus2.p)
          annotation (Line(points={{-51.2,80},{-40,80}}, color={0,0,255}));
        connect(Bus1.p, T1.n)
          annotation (Line(points={{-80,80},{-68.8,80}}, color={0,0,255}));
        connect(G1.conn, Bus1.p)
          annotation (Line(points={{-91,80},{-80,80}}, color={0,0,255}));
        connect(L1.n, Bus3.p)
          annotation (Line(points={{-14.6,80},{0,80}}, color={0,0,255}));
        connect(L1.p, Bus2.p)
          annotation (Line(points={{-25.4,80},{-40,80}}, color={0,0,255}));
        connect(L2_2.n, Bus4.p) annotation (Line(points={{35.4,70},{44,70},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.n, Bus4.p) annotation (Line(points={{35.4,90},{44,90},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.p, Bus3.p) annotation (Line(points={{24.6,90},{16,90},{16,80},{0,
                80}}, color={0,0,255}));
        connect(L2_2.p, Bus3.p) annotation (Line(points={{24.6,70},{16,70},{16,80},{0,
                80}}, color={0,0,255}));
        connect(Load1.p, Bus3.p)
          annotation (Line(points={{-10,68},{-10,80},{0,80}}, color={0,0,255}));
        connect(L3.p, Bus4.p)
          annotation (Line(points={{80,65.4},{80,80},{60,80}}, color={0,0,255}));
        connect(breaker.s, Bus5.p)
          annotation (Line(points={{80,22},{80,16}},color={0,0,255}));
        connect(breaker.r, L3.n)
          annotation (Line(points={{80,30},{80,54.6}},color={0,0,255}));

        connect(IB.p, Bus4.p)
          annotation (Line(points={{100,80},{60,80}}, color={0,0,255}));
        connect(Load2.p, Bus5.p) annotation (Line(points={{110,-10},{110,10},{80,10},{
                80,16}},
                     color={0,0,255}));
        connect(T4.n, Bus10.p)
          annotation (Line(points={{-1,-90},{-10,-90}}, color={0,0,255}));
        connect(Bus6.p, T2.n)
          annotation (Line(points={{-10,10},{-1,10}},
                                                  color={0,0,255}));
        connect(BESS.p1, Bus10.p)
          annotation (Line(points={{-20,-90},{-10,-90}}, color={0,0,255}));
        connect(G2.conn, Bus6.p) annotation (Line(points={{-19,10},{-10,10}},
                                           color={0,0,255}));
        connect(PV.p1, Bus8.p)
          annotation (Line(points={{-20,-50},{-10,-50}}, color={0,0,255}));
        connect(Bus8.p, T3.n)
          annotation (Line(points={{-10,-50},{1,-50}},  color={0,0,255}));
        connect(sine.y, Load2.u) annotation (Line(points={{92.5,-15},{96.1,-15},{96.1,
                -14.5},{101.9,-14.5}}, color={0,0,127}));
        connect(T2.p, Bus7.p) annotation (Line(points={{21,10},{25.5,10},{25.5,10},{30,
                10}}, color={0,0,255}));
        connect(T3.p, Bus9.p)
          annotation (Line(points={{23,-50},{30,-50}}, color={0,0,255}));
        connect(T4.p, Bus11.p)
          annotation (Line(points={{21,-90},{30,-90}}, color={0,0,255}));
        connect(L4.n, Bus5.p) annotation (Line(points={{49.4,10},{60,10},{60,10},{80,10},
                {80,16}},     color={0,0,255}));
        connect(L5.n, Bus5.p) annotation (Line(points={{49.4,-50},{60,-50},{60,10},{80,
                10},{80,16}}, color={0,0,255}));
        connect(Bus11.p, L6.p)
          annotation (Line(points={{30,-90},{38.6,-90}}, color={0,0,255}));
        connect(Bus9.p, L5.p)
          annotation (Line(points={{30,-50},{38.6,-50}}, color={0,0,255}));
        connect(L6.n, Bus5.p) annotation (Line(points={{49.4,-90},{60,-90},{60,10},{80,
                10},{80,16}}, color={0,0,255}));
        connect(Bus7.p, L4.p) annotation (Line(points={{30,10},{34.3,10},{34.3,10},{38.6,
                10}}, color={0,0,255}));
        connect(combiTimeTable.y[1], G2.P_ref1)
          annotation (Line(points={{-79,16},{-42,16}}, color={0,0,127}));
        connect(combiTimeTable1.y[1], G2.Efd_ref) annotation (Line(points={{-79,
                -10},{-52,-10},{-52,4},{-42,4}}, color={0,0,127}));
        connect(combiTimeTable2.y[1], PV.QINPUT) annotation (Line(points={{-79,
                -38},{-50,-38},{-50,-50},{-42,-50}}, color={0,0,127}));
        connect(combiTimeTable3.y[1], BESS.Paux1)
          annotation (Line(points={{-79,-84},{-42,-84}}, color={0,0,127}));
        connect(combiTimeTable4.y[1], BESS.Qext1) annotation (Line(points={{-79,
                -110},{-52,-110},{-52,-96},{-42,-96}}, color={0,0,127}));
          annotation (Placement(transformation(extent={{140,-20},{160,0}})),
                      Placement(transformation(extent={{140,-40},{160,-20}})),
                      Placement(transformation(extent={{140,-60},{160,-40}})),
                      Placement(transformation(extent={{140,-80},{160,-60}})),
                     Diagram(coordinateSystem(preserveAspectRatio=false,
                extent={{-140,-140},{140,140}}), graphics={
              Rectangle(
                extent={{130,98},{252,-124}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,36},{124,-124}},
                lineColor={238,46,47},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,98},{124,38}},
                lineColor={0,128,255},
                lineThickness=0.5),
              Text(
                extent={{78,-106},{114,-120}},
                textColor={238,46,47},
                textString="Microgrid"),
              Text(
                extent={{76,58},{128,34}},
                textColor={28,108,200},
                textString="Utility Grid"),
              Text(
                extent={{-30,-102},{34,-124}},
                textColor={0,140,72},
                textString="Linearization Unit"),
              Text(
                extent={{-164,50},{-132,30}},
                textColor={0,140,72},
                textString="Inputs"),
              Text(
                extent={{128,118},{168,98}},
                textColor={0,140,72},
                textString="Outputs")}),
          Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),experiment(StopTime=30, __Dymola_Algorithm="Dassl"),
          Icon(coordinateSystem(extent={{-140,-140},{140,140}})));
      end MPCAppliedEnergyOriginal_TABLE_mode5;

      model CascadePIController
        extends Modelica.Icons.Example;
        Modelica.Blocks.Continuous.PI PI(
          T=10,
          initType=Modelica.Blocks.Types.Init.InitialOutput,
          x_start=0,
          y_start=1) annotation (Placement(transformation(extent={{-20,-10},{0,10}})));
        Modelica.Blocks.Continuous.PI PI1(
          T=10,
          initType=Modelica.Blocks.Types.Init.InitialOutput,
          x_start=0,
          y_start=1) annotation (Placement(transformation(extent={{28,-10},{48,10}})));
        Modelica.Blocks.Math.Add add(k2=-1)
          annotation (Placement(transformation(extent={{-54,-10},{-34,10}})));
        Modelica.Blocks.Sources.Step step(offset=1, startTime=1)
          annotation (Placement(transformation(extent={{-88,-4},{-68,16}})));
        Modelica.Blocks.Continuous.FirstOrder firstOrder(
          T=0.5,
          initType=Modelica.Blocks.Types.Init.InitialState,
          y_start=1) annotation (Placement(transformation(extent={{60,-10},{80,10}})));
        Modelica.Blocks.Math.Add add1(k1=-1)
          annotation (Placement(transformation(extent={{0,40},{20,60}})));
        Modelica.Blocks.Sources.Step     step1
          annotation (Placement(transformation(extent={{-40,46},{-20,66}})));
      equation
        connect(PI1.y, firstOrder.u)
          annotation (Line(points={{49,0},{58,0}}, color={0,0,127}));
        connect(step1.y, add1.u1)
          annotation (Line(points={{-19,56},{-2,56}}, color={0,0,127}));
        connect(PI.y, add1.u2) annotation (Line(points={{1,0},{10,0},{10,28},{-12,28},
                {-12,44},{-2,44}}, color={0,0,127}));
        connect(add1.y, PI1.u) annotation (Line(points={{21,50},{26,50},{26,20},{18,20},
                {18,0},{26,0}}, color={0,0,127}));
        connect(step.y, add.u1)
          annotation (Line(points={{-67,6},{-56,6}}, color={0,0,127}));
        connect(firstOrder.y, add.u2) annotation (Line(points={{81,0},{90,0},{90,-30},
                {-64,-30},{-64,-6},{-56,-6}}, color={0,0,127}));
        connect(add.y, PI.u)
          annotation (Line(points={{-33,0},{-22,0}}, color={0,0,127}));
        annotation ();
      end CascadePIController;

      model ParallelCascadePIController
        extends Modelica.Icons.Example;
        Modelica.Blocks.Continuous.PI PI(
          T=10,
          initType=Modelica.Blocks.Types.Init.InitialOutput,
          x_start=0,
          y_start=1) annotation (Placement(transformation(extent={{-24,30},{-4,
                  50}})));
        Modelica.Blocks.Continuous.PI PI1(
          T=10,
          initType=Modelica.Blocks.Types.Init.InitialOutput,
          x_start=0,
          y_start=1) annotation (Placement(transformation(extent={{40,60},{60,
                  80}})));
        Modelica.Blocks.Math.Add add(k2=-1)
          annotation (Placement(transformation(extent={{-54,30},{-34,50}})));
        Modelica.Blocks.Sources.Step step(offset=1, startTime=1)
          annotation (Placement(transformation(extent={{-90,32},{-70,52}})));
        Modelica.Blocks.Continuous.FirstOrder firstOrder(
          T=0.5,
          initType=Modelica.Blocks.Types.Init.InitialState,
          y_start=1) annotation (Placement(transformation(extent={{76,-10},{96,
                  10}})));
        Modelica.Blocks.Math.Add add1(k1=-1)
          annotation (Placement(transformation(extent={{4,60},{24,80}})));
        Modelica.Blocks.Sources.Step     step1
          annotation (Placement(transformation(extent={{-34,70},{-14,90}})));
        Modelica.Blocks.Continuous.PI PI2(
          T=10,
          initType=Modelica.Blocks.Types.Init.InitialOutput,
          x_start=0,
          y_start=1) annotation (Placement(transformation(extent={{-30,-80},{
                  -10,-60}})));
        Modelica.Blocks.Continuous.PI PI3(
          T=10,
          initType=Modelica.Blocks.Types.Init.InitialOutput,
          x_start=0,
          y_start=1) annotation (Placement(transformation(extent={{40,-80},{60,
                  -60}})));
        Modelica.Blocks.Math.Add add2(k2=-1)
          annotation (Placement(transformation(extent={{-60,-80},{-40,-60}})));
        Modelica.Blocks.Sources.Step step2(offset=1, startTime=1)
          annotation (Placement(transformation(extent={{-94,-80},{-74,-60}})));
        Modelica.Blocks.Math.Add add3(k1=-1)
          annotation (Placement(transformation(extent={{4,-80},{24,-60}})));
        Modelica.Blocks.Sources.Step     step3
          annotation (Placement(transformation(extent={{-40,-40},{-20,-20}})));
        Modelica.Blocks.Math.Add add4(k1=-1)
          annotation (Placement(transformation(extent={{40,-10},{60,10}})));
      equation
        connect(step1.y, add1.u1)
          annotation (Line(points={{-13,80},{-13,76},{2,76}},
                                                      color={0,0,127}));
        connect(PI.y, add1.u2) annotation (Line(points={{-3,40},{0,40},{0,56},{
                2,56},{2,64}},     color={0,0,127}));
        connect(add1.y, PI1.u) annotation (Line(points={{25,70},{38,70}},
                                color={0,0,127}));
        connect(step.y, add.u1)
          annotation (Line(points={{-69,42},{-62,42},{-62,46},{-56,46}},
                                                     color={0,0,127}));
        connect(add.y, PI.u)
          annotation (Line(points={{-33,40},{-26,40}},
                                                     color={0,0,127}));
        connect(step3.y,add3. u1)
          annotation (Line(points={{-19,-30},{2,-30},{2,-64}},
                                                      color={0,0,127}));
        connect(PI2.y, add3.u2) annotation (Line(points={{-9,-70},{-4,-70},{-4,
                -76},{2,-76}}, color={0,0,127}));
        connect(add3.y,PI3. u) annotation (Line(points={{25,-70},{38,-70}},
                                color={0,0,127}));
        connect(step2.y, add2.u1) annotation (Line(points={{-73,-70},{-68,-70},
                {-68,-64},{-62,-64}}, color={0,0,127}));
        connect(add2.y, PI2.u)
          annotation (Line(points={{-39,-70},{-32,-70}}, color={0,0,127}));
        connect(PI3.y, add4.u2) annotation (Line(points={{61,-70},{74,-70},{74,
                -42},{18,-42},{18,-6},{38,-6}}, color={0,0,127}));
        connect(PI1.y, add4.u1) annotation (Line(points={{61,70},{78,70},{78,38},
                {20,38},{20,6},{38,6}}, color={0,0,127}));
        connect(add4.y, firstOrder.u)
          annotation (Line(points={{61,0},{74,0}}, color={0,0,127}));
      end ParallelCascadePIController;

      model MPCAppliedEnergyOriginal_TABLE_mode4_modified
        "THIS ONE IS STABLE, CONTROLLABLE, OBSERVABLE!!!!!!!"
        extends Modelica.Icons.Example;

        parameter Boolean equivalentGRID = false;
        parameter Boolean equivalentsystem = false;

        OpenIPSL.Electrical.Buses.Bus Bus1(v_0=powerFlow.powerflow.bus.V1, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-90,70},{-70,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus2(v_0=powerFlow.powerflow.bus.V2, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-50,70},{-30,90}})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
          R=0.001,
          X=0.2,
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000)  if not equivalentGRID annotation (Placement(transformation(
              extent={{-8,-8},{8,8}},
              rotation=180,
              origin={-60,80})));
        OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
          enableV_b=true,
          v_0=powerFlow.powerflow.bus.V1,
          angle_0=powerFlow.powerflow.bus.A1,
          P_0=powerFlow.powerflow.machines.PG1,
          Q_0=powerFlow.powerflow.machines.QG1,
          V_b=6000)  if not equivalentGRID
          annotation (Placement(transformation(extent={{-112,70},{-92,90}})));
        OpenIPSL.Electrical.Branches.PwLine L1(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{-26,76},
                  {-14,84}})));
        OpenIPSL.Electrical.Buses.Bus Bus3(v_0=powerFlow.powerflow.bus.V3, angle_0=
              powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-10,70},{10,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus4(v_0=powerFlow.powerflow.bus.V4, angle_0=
              powerFlow.powerflow.bus.V4) if not equivalentGRID
          annotation (Placement(transformation(extent={{50,70},{70,90}})));
        OpenIPSL.Electrical.Branches.PwLine L2_1(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,86},
                  {36,94}})));
        OpenIPSL.Electrical.Branches.PwLine L2_2(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,66},
                  {36,74}})));
        OpenIPSL.Electrical.Buses.Bus Bus5(angle_0=powerFlow.powerflow.bus.A5, v_0=
              powerFlow.powerflow.bus.V5)  annotation (Placement(
              transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={80,16})));
        OpenIPSL.Electrical.Branches.PwLine L3(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=-90,
              origin={80,60})));
        OpenIPSL.Electrical.Buses.Bus Bus6(v_0=powerFlow.powerflow.bus.V6, angle_0=
              powerFlow.powerflow.bus.A6) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,10})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000,
          R=0.005,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={10,10})));
        GenerationUnits.PSSE.G2_16MVA                         G2(
          enableV_b=true,
          enableP_0=true,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V6,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A6,
          V_b=6000,
          P_0=powerFlow.powerflow.machines.PG2,
          Q_0=powerFlow.powerflow.machines.QG2,
          enableangle_0=true)
                        annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-30,10})));
        inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000, fn=60)
          annotation (Placement(transformation(extent={{-128,104},{-74,124}})));
        OpenIPSL.Electrical.Loads.PSSE.Load Load1(
          V_b=220000,
          P_0=powerFlow.powerflow.loads.PL1,
          Q_0=powerFlow.powerflow.loads.QL1,
          v_0=powerFlow.powerflow.bus.V3,
          angle_0=powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-20,48},{0,68}})));
        Electrical.Events.Breaker breaker(enableTrigger=false,
          t_o=1.01,
          rc_enabled=true,
          t_rc=80.01)       if not equivalentGRID                     annotation (Placement(transformation(
              extent={{-4,-4},{4,4}},
              rotation=90,
              origin={80,26})));

        Modelica.Blocks.Interfaces.RealOutput OUT1
          annotation (Placement(transformation(extent={{140,70},{160,90}})));
       Modelica.Blocks.Interfaces.RealOutput OUT2
          annotation (Placement(transformation(extent={{140,50},{160,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT3
          annotation (Placement(transformation(extent={{140,30},{160,50}})));

        PFData.PowerFlow powerFlow(redeclare record PowerFlow =
              OpenIPSL.Examples.ModelPredictiveControl.PFData.PF16)
          annotation (Placement(transformation(extent={{-68,104},{-48,124}})));
        Electrical.Machines.PSSE.GENCLS IB(
          V_b=220000,
          v_0=powerFlow.powerflow.bus.V4,
          angle_0=powerFlow.powerflow.bus.A4,
          P_0=powerFlow.powerflow.machines.Pinf,
          Q_0=powerFlow.powerflow.machines.Qinf,
          M_b=100000000,
          X_d=1) if not equivalentGRID annotation (Placement(transformation(extent={{110,70},
                  {100,90}})));
        Electrical.Loads.PSSE.Load_ExtInput Load2(
          P_0=powerFlow.powerflow.loads.PL2,
          Q_0=powerFlow.powerflow.loads.QL2,
          v_0=powerFlow.powerflow.bus.V5,
          angle_0=powerFlow.powerflow.bus.A5,
          d_P=0,
          t1=100,
          d_t=1000)
          annotation (Placement(transformation(extent={{100,-30},{120,-10}})));

        inner Modelica.Blocks.Noise.GlobalSeed globalSeed(useAutomaticSeed=false,
            fixedSeed=10000)
          annotation (Placement(transformation(extent={{-42,102},{-22,122}})));
        Modelica.Blocks.Sources.Sine sine(
          amplitude=0,
          f=1/260,
          phase=3.1415926535898,
          startTime=1000)
          annotation (Placement(transformation(extent={{82,-20},{92,-10}})));

        Electrical.Buses.Bus Bus10(v_0=powerFlow.powerflow.bus.V10, angle_0=powerFlow.powerflow.bus.A10)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,-90})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T4(
          G=0,
          B=0,
          CW=1,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={10,-90})));
        GenerationUnits.PSSE.Solar_Units.SolarMPCLocalVQControl PV(
          V_b=480,
          P_0=powerFlow.powerflow.machines.PPV,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QPV,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V8,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A8,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-60},{-20,-40}})));

        Modelica.Blocks.Interfaces.RealOutput OUT4
          annotation (Placement(transformation(extent={{140,10},{160,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT5
          annotation (Placement(transformation(extent={{140,-10},{160,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT6
          annotation (Placement(transformation(extent={{140,-30},{160,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT7
          annotation (Placement(transformation(extent={{140,-50},{160,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT8
          annotation (Placement(transformation(extent={{140,-70},{160,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT9
          annotation (Placement(transformation(extent={{140,-90},{160,-70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT10
          annotation (Placement(transformation(extent={{140,-110},{160,-90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT11
          annotation (Placement(transformation(extent={{164,70},{184,90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT12
          annotation (Placement(transformation(extent={{164,50},{184,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT13
          annotation (Placement(transformation(extent={{164,30},{184,50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT14
          annotation (Placement(transformation(extent={{164,10},{184,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT15
          annotation (Placement(transformation(extent={{164,-10},{184,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT16
          annotation (Placement(transformation(extent={{164,-30},{184,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT17
          annotation (Placement(transformation(extent={{164,-50},{184,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT18
          annotation (Placement(transformation(extent={{164,-70},{184,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT19
          annotation (Placement(transformation(extent={{164,-90},{184,-70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT20
          annotation (Placement(transformation(extent={{164,-110},{184,-90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT21
          annotation (Placement(transformation(extent={{184,70},{204,90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT22
          annotation (Placement(transformation(extent={{184,50},{204,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT23
          annotation (Placement(transformation(extent={{184,30},{204,50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT24
          annotation (Placement(transformation(extent={{184,10},{204,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT25
          annotation (Placement(transformation(extent={{184,-10},{204,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT26
          annotation (Placement(transformation(extent={{184,-30},{204,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT27
          annotation (Placement(transformation(extent={{184,-50},{204,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT28
          annotation (Placement(transformation(extent={{184,-70},{204,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT29
          annotation (Placement(transformation(extent={{184,-90},{204,-70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT30
          annotation (Placement(transformation(extent={{184,-110},{204,-90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT31
          annotation (Placement(transformation(extent={{204,70},{224,90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT32
          annotation (Placement(transformation(extent={{204,50},{224,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT33
          annotation (Placement(transformation(extent={{204,30},{224,50}})));
        GenerationUnits.PSSE.Battery_Units.BESSMPCLocalVQControl BESS(
          V_base=480,
          V_b(displayUnit="kV") = 480,
          enableV_b=true,
          P_0=powerFlow.powerflow.machines.PBESS,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QBESS,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V10,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A10,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-100},{-20,-80}})));
        Modelica.Blocks.Interfaces.RealOutput OUT34
          annotation (Placement(transformation(extent={{204,10},{224,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT35
          annotation (Placement(transformation(extent={{206,-10},{226,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT36
          annotation (Placement(transformation(extent={{206,-30},{226,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT37
          annotation (Placement(transformation(extent={{206,-50},{226,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT38
          annotation (Placement(transformation(extent={{206,-70},{226,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT39
          annotation (Placement(transformation(extent={{206,-90},{226,-70}})));
        Electrical.Buses.Bus Bus8(v_0=powerFlow.powerflow.bus.V8, angle_0=powerFlow.powerflow.bus.A8)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,-50})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T3(
          G=0,
          B=0,
          CW=1,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={12,-50})));
        Electrical.Buses.Bus Bus11(v_0=powerFlow.powerflow.bus.V11, angle_0=powerFlow.powerflow.bus.A11)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,-90})));
        Electrical.Buses.Bus Bus9(v_0=powerFlow.powerflow.bus.V9, angle_0=powerFlow.powerflow.bus.A9)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,-50})));
        Electrical.Buses.Bus Bus7(v_0=powerFlow.powerflow.bus.V7, angle_0=powerFlow.powerflow.bus.A7)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,10})));
        Electrical.Branches.PwLine          L4(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,6},{
                  50,14}})));
        Electrical.Branches.PwLine          L5(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,-54},
                  {50,-46}})));
        Electrical.Branches.PwLine          L6(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,-94},
                  {50,-86}})));
        Modelica.Blocks.Interfaces.RealOutput OUT40
          annotation (Placement(transformation(extent={{206,-110},{226,-90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT41
          annotation (Placement(transformation(extent={{224,70},{244,90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT42
          annotation (Placement(transformation(extent={{224,50},{244,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT43
          annotation (Placement(transformation(extent={{224,30},{244,50}})));
        Modelica.Blocks.Sources.CombiTimeTable combiTimeTable(table=[0,0; 0.5,0;
              1,0; 1.5,0.004505781; 2,-0.00549; 2.5,-0.015494219; 3,-0.025494219;
              3.5,-0.035494219; 4,-0.045494219; 4.5,-0.048325981; 5,-0.044503544;
              5.5,-0.039520789; 6,-0.035408788; 6.5,-0.032618842; 7,-0.030999584;
              7.5,-0.030242549; 8,-0.030056786; 8.5,-0.03021966; 9,-0.030577966;
              9.5,-0.031033374; 10,-0.031526159; 10.5,-0.032021887; 11,-0.032501873;
              11.5,-0.032956831; 12,-0.033382879; 12.5,-0.033779114; 13,-0.034146196;
              13.5,-0.034485542; 14,-0.034798888; 14.5,-0.035088057; 15,-0.035354836;
              15.5,-0.035600927; 16,-0.035827924; 16.5,-0.036037305; 17,-0.036230438;
              17.5,-0.036408585; 18,-0.036572911; 18.5,-0.03672449; 19,-0.036864309;
              19.5,-0.036993283; 20,-0.037112253; 20.5,-0.037221995; 21,-0.037323225],
                                              smoothness=Modelica.Blocks.Types.Smoothness.ConstantSegments)
          annotation (Placement(transformation(extent={{-100,6},{-80,26}})));
        Modelica.Blocks.Sources.CombiTimeTable combiTimeTable1(table=[0,0; 0.5,
              0; 1,0; 1.5,0.01; 2,0.02; 2.5,0.03; 3,0.03867007; 3.5,0.043095729;
              4,0.045328787; 4.5,0.046550951; 5,0.047394078; 5.5,0.04813991; 6,
              0.048887028; 6.5,0.049652444; 7,0.050424147; 7.5,0.051184466; 8,
              0.051918668; 8.5,0.05261697; 9,0.053274033; 9.5,0.053887804; 10,
              0.054458391; 10.5,0.054987202; 11,0.055476353; 11.5,0.055928287;
              12,0.05634554; 12.5,0.056730617; 13,0.057085917; 13.5,0.0574137;
              14,0.057716076; 14.5,0.057995006; 15,0.058252303; 15.5,
              0.058489643; 16,0.058708574; 16.5,0.058910523; 17,0.059096808;
              17.5,0.059268643; 18,0.059427151; 18.5,0.059573364; 19,
              0.059708236; 19.5,0.059832647; 20,0.059947408; 20.5,0.060053269;
              21,0.060150918],                                smoothness=
              Modelica.Blocks.Types.Smoothness.ConstantSegments)
          annotation (Placement(transformation(extent={{-100,-20},{-80,0}})));
        Modelica.Blocks.Sources.CombiTimeTable combiTimeTable2(table=[0,0; 0.5,
              0; 1,0; 1.5,0.036932785; 2,0.037835264; 2.5,0.03737385; 3,
              0.037540644; 3.5,0.037587899; 4,0.037581034; 4.5,0.037553439; 5,
              0.036391678; 5.5,0.034942323; 6,0.033657632; 6.5,0.032683173; 7,
              0.032008884; 7.5,0.031570603; 8,0.031298955; 8.5,0.031137183; 9,
              0.03104438; 9.5,0.030993218; 10,0.030966369; 10.5,0.030953278; 11,
              0.030947728; 11.5,0.030946161; 12,0.030946598; 12.5,0.030947972;
              13,0.030949723; 13.5,0.030951568; 14,0.030953375; 14.5,
              0.030955086; 15,0.030956679; 15.5,0.030958153; 16,0.030959511;
              16.5,0.030960763; 17,0.030961915; 17.5,0.030962977; 18,
              0.030963955; 18.5,0.030964857; 19,0.030965688; 19.5,0.030966455;
              20,0.030967162; 20.5,0.030967814; 21,0.030968416],
                                                              smoothness=
              Modelica.Blocks.Types.Smoothness.ConstantSegments)
          annotation (Placement(transformation(extent={{-100,-48},{-80,-28}})));
        Modelica.Blocks.Sources.CombiTimeTable combiTimeTable3(table=[0,0; 0.5,
              0; 1,0; 1.5,0.05; 2,0.034765727; 2.5,0.02942776; 3,0.033710698;
              3.5,0.035233013; 4,0.036508047; 4.5,0.037498507; 5,0.037699351;
              5.5,0.037211381; 6,0.036525568; 6.5,0.035922638; 7,0.03549443;
              7.5,0.035236578; 8,0.035111103; 8.5,0.035076572; 9,0.035099123;
              9.5,0.035154505; 10,0.035226707; 10.5,0.035305784; 11,0.03538589;
              11.5,0.035463785; 12,0.035537819; 12.5,0.035607267; 13,
              0.035671923; 13.5,0.035731861; 14,0.035787292; 14.5,0.035838489;
              15,0.035885741; 15.5,0.035929337; 16,0.035969555; 16.5,
              0.036006652; 17,0.036040872; 17.5,0.036072435; 18,0.03610155;
              18.5,0.036128406; 19,0.036153179; 19.5,0.03617603; 20,0.036197108;
              20.5,0.036216552; 21,0.036234487],
                                              smoothness=Modelica.Blocks.Types.Smoothness.ConstantSegments)
          annotation (Placement(transformation(extent={{-100,-94},{-80,-74}})));
        Modelica.Blocks.Sources.CombiTimeTable combiTimeTable4(table=[0,0; 0.5,
              0; 1,0; 1.5,-0.028219386; 2,-0.035694202; 2.5,-0.039658828; 3,-0.040321303;
              3.5,-0.041947097; 4,-0.043723737; 4.5,-0.04550335; 5,-0.046170199;
              5.5,-0.046412537; 6,-0.046460401; 6.5,-0.046401782; 7,-0.046282072;
              7.5,-0.046129369; 8,-0.045961849; 8.5,-0.045790979; 9,-0.045623631;
              9.5,-0.045463622; 10,-0.04531284; 10.5,-0.045172001; 11,-0.045041145;
              11.5,-0.044919948; 12,-0.044807904; 12.5,-0.044704429; 13,-0.044608924;
              13.5,-0.044520802; 14,-0.044439505; 14.5,-0.044364511; 15,-0.044295334;
              15.5,-0.044231523; 16,-0.044172662; 16.5,-0.044118367; 17,-0.044068284;
              17.5,-0.044022085; 18,-0.04397947; 18.5,-0.043940161; 19,-0.0439039;
              19.5,-0.043870452; 20,-0.043839599; 20.5,-0.043811138; 21,-0.043784885],
                                                   smoothness=Modelica.Blocks.Types.Smoothness.ConstantSegments)
          annotation (Placement(transformation(extent={{-100,-120},{-80,-100}})));
      equation

      OUT1 = G2.gen.w;
      OUT2 = G2.gen.delta;
      OUT3 = G2.gen.Epq;
      OUT4 = G2.gen.PSIkd;
      OUT5 = G2.gen.PSIppq;
      OUT6 = G2.sEXSMPC.simpleLagLim.state;
      OUT7 = G2.sEXSMPC.leadLag.TF.x_scaled[1];
      OUT8 = G2.gASTMPC.simpleLagLim.state;
      OUT9 = G2.gASTMPC.simpleLag.state;
      OUT10 = G2.gASTMPC.simpleLag1.state;
      OUT11 = PV.rEGCA1_1.simpleLag.state;
      OUT12 = PV.rEGCA1_1.integrator.y;
      OUT13 = PV.rEGCA1_1.integrator1.y;
      OUT14 =PV.EC.IGQ.y;
      OUT15 =PV.EC.IGV.y;
      OUT16 =PV.EC.simpleLag.state;
      OUT17 =PV.EC.simpleLag1.state;
      OUT18 =PV.EC.simpleLag2.state;
      OUT19 =PV.EC.IGP.y;
      OUT20 =PV.EC.simpleLag3.state;
      OUT21 =PV.EC.simpleLag4.state;
      OUT22 =PV.EC.simpleLag5.state;
      OUT23 = BESS.rEGCA1_1.simpleLag.state;
      OUT24 = BESS.rEGCA1_1.integrator.y;
      OUT25 = BESS.rEGCA1_1.integrator1.y;
      OUT26 =BESS.EC.integrator3.y;
      OUT27 =BESS.EC.integrator1.y;
      OUT28 =BESS.EC.simpleLag.state;
      OUT29 =BESS.EC.IGQ.y;
      OUT30 =BESS.EC.IGV.y;
      OUT31 =BESS.EC.IGP.y;
      OUT32 =BESS.EC.simpleLag1.state;
      OUT33 =BESS.EC.simpleLag2.state;
      OUT34 =BESS.EC.simpleLag3.state;
      OUT35 =BESS.EC.simpleLag4.state;
      OUT36 = G2.gen.PMECH;
      OUT37 = G2.sEXSMPC.EFD;
      OUT38 = BESS.rEGCA1_1.Pgen;
      OUT39 = BESS.rEGCA1_1.Qgen;
      OUT40 = PV.rEGCA1_1.Pgen;
      OUT41 = PV.rEGCA1_1.Qgen;
      OUT42 = Bus5.v;
      OUT43 = Bus5.angle;

        connect(T1.p, Bus2.p)
          annotation (Line(points={{-51.2,80},{-40,80}}, color={0,0,255}));
        connect(Bus1.p, T1.n)
          annotation (Line(points={{-80,80},{-68.8,80}}, color={0,0,255}));
        connect(G1.conn, Bus1.p)
          annotation (Line(points={{-91,80},{-80,80}}, color={0,0,255}));
        connect(L1.n, Bus3.p)
          annotation (Line(points={{-14.6,80},{0,80}}, color={0,0,255}));
        connect(L1.p, Bus2.p)
          annotation (Line(points={{-25.4,80},{-40,80}}, color={0,0,255}));
        connect(L2_2.n, Bus4.p) annotation (Line(points={{35.4,70},{44,70},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.n, Bus4.p) annotation (Line(points={{35.4,90},{44,90},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.p, Bus3.p) annotation (Line(points={{24.6,90},{16,90},{16,80},{0,
                80}}, color={0,0,255}));
        connect(L2_2.p, Bus3.p) annotation (Line(points={{24.6,70},{16,70},{16,80},{0,
                80}}, color={0,0,255}));
        connect(Load1.p, Bus3.p)
          annotation (Line(points={{-10,68},{-10,80},{0,80}}, color={0,0,255}));
        connect(L3.p, Bus4.p)
          annotation (Line(points={{80,65.4},{80,80},{60,80}}, color={0,0,255}));
        connect(breaker.s, Bus5.p)
          annotation (Line(points={{80,22},{80,16}},color={0,0,255}));
        connect(breaker.r, L3.n)
          annotation (Line(points={{80,30},{80,54.6}},color={0,0,255}));

        connect(IB.p, Bus4.p)
          annotation (Line(points={{100,80},{60,80}}, color={0,0,255}));
        connect(Load2.p, Bus5.p) annotation (Line(points={{110,-10},{110,10},{80,10},{
                80,16}},
                     color={0,0,255}));
        connect(T4.n, Bus10.p)
          annotation (Line(points={{-1,-90},{-10,-90}}, color={0,0,255}));
        connect(Bus6.p, T2.n)
          annotation (Line(points={{-10,10},{-1,10}},
                                                  color={0,0,255}));
        connect(BESS.p1, Bus10.p)
          annotation (Line(points={{-20,-90},{-10,-90}}, color={0,0,255}));
        connect(G2.conn, Bus6.p) annotation (Line(points={{-19,10},{-10,10}},
                                           color={0,0,255}));
        connect(PV.p1, Bus8.p)
          annotation (Line(points={{-20,-50},{-10,-50}}, color={0,0,255}));
        connect(Bus8.p, T3.n)
          annotation (Line(points={{-10,-50},{1,-50}},  color={0,0,255}));
        connect(sine.y, Load2.u) annotation (Line(points={{92.5,-15},{96.1,-15},{96.1,
                -14.5},{101.9,-14.5}}, color={0,0,127}));
        connect(T2.p, Bus7.p) annotation (Line(points={{21,10},{25.5,10},{25.5,10},{30,
                10}}, color={0,0,255}));
        connect(T3.p, Bus9.p)
          annotation (Line(points={{23,-50},{30,-50}}, color={0,0,255}));
        connect(T4.p, Bus11.p)
          annotation (Line(points={{21,-90},{30,-90}}, color={0,0,255}));
        connect(L4.n, Bus5.p) annotation (Line(points={{49.4,10},{60,10},{60,10},{80,10},
                {80,16}},     color={0,0,255}));
        connect(L5.n, Bus5.p) annotation (Line(points={{49.4,-50},{60,-50},{60,10},{80,
                10},{80,16}}, color={0,0,255}));
        connect(Bus11.p, L6.p)
          annotation (Line(points={{30,-90},{38.6,-90}}, color={0,0,255}));
        connect(Bus9.p, L5.p)
          annotation (Line(points={{30,-50},{38.6,-50}}, color={0,0,255}));
        connect(L6.n, Bus5.p) annotation (Line(points={{49.4,-90},{60,-90},{60,10},{80,
                10},{80,16}}, color={0,0,255}));
        connect(Bus7.p, L4.p) annotation (Line(points={{30,10},{34.3,10},{34.3,10},{38.6,
                10}}, color={0,0,255}));
        connect(combiTimeTable.y[1], G2.P_ref1)
          annotation (Line(points={{-79,16},{-42,16}}, color={0,0,127}));
        connect(combiTimeTable1.y[1], G2.Efd_ref) annotation (Line(points={{-79,
                -10},{-52,-10},{-52,4},{-42,4}}, color={0,0,127}));
        connect(combiTimeTable2.y[1], PV.QINPUT) annotation (Line(points={{-79,
                -38},{-50,-38},{-50,-50},{-42,-50}}, color={0,0,127}));
        connect(combiTimeTable3.y[1], BESS.Paux1)
          annotation (Line(points={{-79,-84},{-42,-84}}, color={0,0,127}));
        connect(combiTimeTable4.y[1], BESS.Qext1) annotation (Line(points={{-79,
                -110},{-52,-110},{-52,-96},{-42,-96}}, color={0,0,127}));
          annotation (Placement(transformation(extent={{140,-20},{160,0}})),
                      Placement(transformation(extent={{140,-40},{160,-20}})),
                      Placement(transformation(extent={{140,-60},{160,-40}})),
                      Placement(transformation(extent={{140,-80},{160,-60}})),
                     Diagram(coordinateSystem(preserveAspectRatio=false,
                extent={{-140,-140},{140,140}}), graphics={
              Rectangle(
                extent={{130,98},{252,-124}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,36},{124,-124}},
                lineColor={238,46,47},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,98},{124,38}},
                lineColor={0,128,255},
                lineThickness=0.5),
              Text(
                extent={{78,-106},{114,-120}},
                textColor={238,46,47},
                textString="Microgrid"),
              Text(
                extent={{76,58},{128,34}},
                textColor={28,108,200},
                textString="Utility Grid"),
              Text(
                extent={{-30,-102},{34,-124}},
                textColor={0,140,72},
                textString="Linearization Unit"),
              Text(
                extent={{-164,50},{-132,30}},
                textColor={0,140,72},
                textString="Inputs"),
              Text(
                extent={{128,118},{168,98}},
                textColor={0,140,72},
                textString="Outputs")}),
          Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),experiment(StopTime=21, __Dymola_Algorithm="Dassl"),
          Icon(coordinateSystem(extent={{-140,-140},{140,140}})));
      end MPCAppliedEnergyOriginal_TABLE_mode4_modified;

      model MPCAppliedEnergyOriginal_TABLE_mode4_modified2
        "THIS ONE IS STABLE, CONTROLLABLE, OBSERVABLE!!!!!!!"
        extends Modelica.Icons.Example;

        parameter Boolean equivalentGRID = false;
        parameter Boolean equivalentsystem = false;

        OpenIPSL.Electrical.Buses.Bus Bus1(v_0=powerFlow.powerflow.bus.V1, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-90,70},{-70,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus2(v_0=powerFlow.powerflow.bus.V2, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-50,70},{-30,90}})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
          R=0.001,
          X=0.2,
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000)  if not equivalentGRID annotation (Placement(transformation(
              extent={{-8,-8},{8,8}},
              rotation=180,
              origin={-60,80})));
        OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
          enableV_b=true,
          v_0=powerFlow.powerflow.bus.V1,
          angle_0=powerFlow.powerflow.bus.A1,
          P_0=powerFlow.powerflow.machines.PG1,
          Q_0=powerFlow.powerflow.machines.QG1,
          V_b=6000)  if not equivalentGRID
          annotation (Placement(transformation(extent={{-112,70},{-92,90}})));
        OpenIPSL.Electrical.Branches.PwLine L1(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{-26,76},
                  {-14,84}})));
        OpenIPSL.Electrical.Buses.Bus Bus3(v_0=powerFlow.powerflow.bus.V3, angle_0=
              powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-10,70},{10,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus4(v_0=powerFlow.powerflow.bus.V4, angle_0=
              powerFlow.powerflow.bus.V4) if not equivalentGRID
          annotation (Placement(transformation(extent={{50,70},{70,90}})));
        OpenIPSL.Electrical.Branches.PwLine L2_1(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,86},
                  {36,94}})));
        OpenIPSL.Electrical.Branches.PwLine L2_2(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,66},
                  {36,74}})));
        OpenIPSL.Electrical.Buses.Bus Bus5(angle_0=powerFlow.powerflow.bus.A5, v_0=
              powerFlow.powerflow.bus.V5)  annotation (Placement(
              transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={80,16})));
        OpenIPSL.Electrical.Branches.PwLine L3(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=-90,
              origin={80,60})));
        OpenIPSL.Electrical.Buses.Bus Bus6(v_0=powerFlow.powerflow.bus.V6, angle_0=
              powerFlow.powerflow.bus.A6) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,10})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000,
          R=0.005,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={10,10})));
        GenerationUnits.PSSE.G2_16MVA                         G2(
          enableV_b=true,
          enableP_0=true,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V6,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A6,
          V_b=6000,
          P_0=powerFlow.powerflow.machines.PG2,
          Q_0=powerFlow.powerflow.machines.QG2,
          enableangle_0=true)
                        annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-30,10})));
        inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000, fn=60)
          annotation (Placement(transformation(extent={{-128,104},{-74,124}})));
        OpenIPSL.Electrical.Loads.PSSE.Load Load1(
          V_b=220000,
          P_0=powerFlow.powerflow.loads.PL1,
          Q_0=powerFlow.powerflow.loads.QL1,
          v_0=powerFlow.powerflow.bus.V3,
          angle_0=powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-20,48},{0,68}})));
        Electrical.Events.Breaker breaker(enableTrigger=false,
          t_o=1.01,
          rc_enabled=true,
          t_rc=80.01)       if not equivalentGRID                     annotation (Placement(transformation(
              extent={{-4,-4},{4,4}},
              rotation=90,
              origin={80,26})));

        Modelica.Blocks.Interfaces.RealOutput OUT1
          annotation (Placement(transformation(extent={{140,70},{160,90}})));
       Modelica.Blocks.Interfaces.RealOutput OUT2
          annotation (Placement(transformation(extent={{140,50},{160,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT3
          annotation (Placement(transformation(extent={{140,30},{160,50}})));

        PFData.PowerFlow powerFlow(redeclare record PowerFlow =
              OpenIPSL.Examples.ModelPredictiveControl.PFData.PF16)
          annotation (Placement(transformation(extent={{-68,104},{-48,124}})));
        Electrical.Machines.PSSE.GENCLS IB(
          V_b=220000,
          v_0=powerFlow.powerflow.bus.V4,
          angle_0=powerFlow.powerflow.bus.A4,
          P_0=powerFlow.powerflow.machines.Pinf,
          Q_0=powerFlow.powerflow.machines.Qinf,
          M_b=100000000,
          X_d=1) if not equivalentGRID annotation (Placement(transformation(extent={{110,70},
                  {100,90}})));
        Electrical.Loads.PSSE.Load_ExtInput Load2(
          P_0=powerFlow.powerflow.loads.PL2,
          Q_0=powerFlow.powerflow.loads.QL2,
          v_0=powerFlow.powerflow.bus.V5,
          angle_0=powerFlow.powerflow.bus.A5,
          d_P=0,
          t1=100,
          d_t=1000)
          annotation (Placement(transformation(extent={{100,-30},{120,-10}})));

        inner Modelica.Blocks.Noise.GlobalSeed globalSeed(useAutomaticSeed=false,
            fixedSeed=10000)
          annotation (Placement(transformation(extent={{-42,102},{-22,122}})));
        Modelica.Blocks.Sources.Sine sine(
          amplitude=0,
          f=1/260,
          phase=3.1415926535898,
          startTime=1000)
          annotation (Placement(transformation(extent={{82,-20},{92,-10}})));

        Electrical.Buses.Bus Bus10(v_0=powerFlow.powerflow.bus.V10, angle_0=powerFlow.powerflow.bus.A10)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,-90})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T4(
          G=0,
          B=0,
          CW=1,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={10,-90})));
        GenerationUnits.PSSE.Solar_Units.SolarMPCLocalVQControl PV(
          V_b=480,
          P_0=powerFlow.powerflow.machines.PPV,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QPV,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V8,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A8,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-60},{-20,-40}})));

        Modelica.Blocks.Interfaces.RealOutput OUT4
          annotation (Placement(transformation(extent={{140,10},{160,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT5
          annotation (Placement(transformation(extent={{140,-10},{160,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT6
          annotation (Placement(transformation(extent={{140,-30},{160,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT7
          annotation (Placement(transformation(extent={{140,-50},{160,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT8
          annotation (Placement(transformation(extent={{140,-70},{160,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT9
          annotation (Placement(transformation(extent={{140,-90},{160,-70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT10
          annotation (Placement(transformation(extent={{140,-110},{160,-90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT11
          annotation (Placement(transformation(extent={{164,70},{184,90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT12
          annotation (Placement(transformation(extent={{164,50},{184,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT13
          annotation (Placement(transformation(extent={{164,30},{184,50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT14
          annotation (Placement(transformation(extent={{164,10},{184,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT15
          annotation (Placement(transformation(extent={{164,-10},{184,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT16
          annotation (Placement(transformation(extent={{164,-30},{184,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT17
          annotation (Placement(transformation(extent={{164,-50},{184,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT18
          annotation (Placement(transformation(extent={{164,-70},{184,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT19
          annotation (Placement(transformation(extent={{164,-90},{184,-70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT20
          annotation (Placement(transformation(extent={{164,-110},{184,-90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT21
          annotation (Placement(transformation(extent={{184,70},{204,90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT22
          annotation (Placement(transformation(extent={{184,50},{204,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT23
          annotation (Placement(transformation(extent={{184,30},{204,50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT24
          annotation (Placement(transformation(extent={{184,10},{204,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT25
          annotation (Placement(transformation(extent={{184,-10},{204,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT26
          annotation (Placement(transformation(extent={{184,-30},{204,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT27
          annotation (Placement(transformation(extent={{184,-50},{204,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT28
          annotation (Placement(transformation(extent={{184,-70},{204,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT29
          annotation (Placement(transformation(extent={{184,-90},{204,-70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT30
          annotation (Placement(transformation(extent={{184,-110},{204,-90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT31
          annotation (Placement(transformation(extent={{204,70},{224,90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT32
          annotation (Placement(transformation(extent={{204,50},{224,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT33
          annotation (Placement(transformation(extent={{204,30},{224,50}})));
        GenerationUnits.PSSE.Battery_Units.BESSMPCLocalVQControl BESS(
          V_base=480,
          V_b(displayUnit="kV") = 480,
          enableV_b=true,
          P_0=powerFlow.powerflow.machines.PBESS,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QBESS,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V10,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A10,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-100},{-20,-80}})));
        Modelica.Blocks.Interfaces.RealOutput OUT34
          annotation (Placement(transformation(extent={{204,10},{224,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT35
          annotation (Placement(transformation(extent={{206,-10},{226,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT36
          annotation (Placement(transformation(extent={{206,-30},{226,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT37
          annotation (Placement(transformation(extent={{206,-50},{226,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT38
          annotation (Placement(transformation(extent={{206,-70},{226,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT39
          annotation (Placement(transformation(extent={{206,-90},{226,-70}})));
        Electrical.Buses.Bus Bus8(v_0=powerFlow.powerflow.bus.V8, angle_0=powerFlow.powerflow.bus.A8)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,-50})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T3(
          G=0,
          B=0,
          CW=1,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={12,-50})));
        Electrical.Buses.Bus Bus11(v_0=powerFlow.powerflow.bus.V11, angle_0=powerFlow.powerflow.bus.A11)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,-90})));
        Electrical.Buses.Bus Bus9(v_0=powerFlow.powerflow.bus.V9, angle_0=powerFlow.powerflow.bus.A9)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,-50})));
        Electrical.Buses.Bus Bus7(v_0=powerFlow.powerflow.bus.V7, angle_0=powerFlow.powerflow.bus.A7)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,10})));
        Electrical.Branches.PwLine          L4(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,6},{
                  50,14}})));
        Electrical.Branches.PwLine          L5(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,-54},
                  {50,-46}})));
        Electrical.Branches.PwLine          L6(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,-94},
                  {50,-86}})));
        Modelica.Blocks.Interfaces.RealOutput OUT40
          annotation (Placement(transformation(extent={{206,-110},{226,-90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT41
          annotation (Placement(transformation(extent={{224,70},{244,90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT42
          annotation (Placement(transformation(extent={{224,50},{244,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT43
          annotation (Placement(transformation(extent={{224,30},{244,50}})));
        Modelica.Blocks.Sources.CombiTimeTable combiTimeTable(table=[0,0; 0.5,0;
              1,0; 1.5,0.01; 4.5,0.01],       smoothness=Modelica.Blocks.Types.Smoothness.ConstantSegments)
          annotation (Placement(transformation(extent={{-100,6},{-80,26}})));
        Modelica.Blocks.Sources.CombiTimeTable combiTimeTable1(table=[0,0; 0.5,
              0; 1,0; 1.5,-0.01; 4.5,-0.01],                  smoothness=
              Modelica.Blocks.Types.Smoothness.ConstantSegments)
          annotation (Placement(transformation(extent={{-100,-20},{-80,0}})));
        Modelica.Blocks.Sources.CombiTimeTable combiTimeTable2(table=[0,0; 0.5,
              0; 1,0; 1.5,-0.001734925; 4.5,-0.001734925],    smoothness=
              Modelica.Blocks.Types.Smoothness.ConstantSegments)
          annotation (Placement(transformation(extent={{-100,-48},{-80,-28}})));
        Modelica.Blocks.Sources.CombiTimeTable combiTimeTable3(table=[0,0; 0.5,
              0; 1,0; 1.5,0.05; 4.5,0.05],    smoothness=Modelica.Blocks.Types.Smoothness.ConstantSegments)
          annotation (Placement(transformation(extent={{-100,-94},{-80,-74}})));
        Modelica.Blocks.Sources.CombiTimeTable combiTimeTable4(table=[0,0; 0.5,
              0; 1,0; 1.5,0.012751724; 4.5,0.012751724],
                                                   smoothness=Modelica.Blocks.Types.Smoothness.ConstantSegments)
          annotation (Placement(transformation(extent={{-100,-120},{-80,-100}})));
      equation

      OUT1 = G2.gen.w;
      OUT2 = G2.gen.delta;
      OUT3 = G2.gen.Epq;
      OUT4 = G2.gen.PSIkd;
      OUT5 = G2.gen.PSIppq;
      OUT6 = G2.sEXSMPC.simpleLagLim.state;
      OUT7 = G2.sEXSMPC.leadLag.TF.x_scaled[1];
      OUT8 = G2.gASTMPC.simpleLagLim.state;
      OUT9 = G2.gASTMPC.simpleLag.state;
      OUT10 = G2.gASTMPC.simpleLag1.state;
      OUT11 = PV.rEGCA1_1.simpleLag.state;
      OUT12 = PV.rEGCA1_1.integrator.y;
      OUT13 = PV.rEGCA1_1.integrator1.y;
      OUT14 =PV.EC.IGQ.y;
      OUT15 =PV.EC.IGV.y;
      OUT16 =PV.EC.simpleLag.state;
      OUT17 =PV.EC.simpleLag1.state;
      OUT18 =PV.EC.simpleLag2.state;
      OUT19 =PV.EC.IGP.y;
      OUT20 =PV.EC.simpleLag3.state;
      OUT21 =PV.EC.simpleLag4.state;
      OUT22 =PV.EC.simpleLag5.state;
      OUT23 = BESS.rEGCA1_1.simpleLag.state;
      OUT24 = BESS.rEGCA1_1.integrator.y;
      OUT25 = BESS.rEGCA1_1.integrator1.y;
      OUT26 =BESS.EC.integrator3.y;
      OUT27 =BESS.EC.integrator1.y;
      OUT28 =BESS.EC.simpleLag.state;
      OUT29 =BESS.EC.IGQ.y;
      OUT30 =BESS.EC.IGV.y;
      OUT31 =BESS.EC.IGP.y;
      OUT32 =BESS.EC.simpleLag1.state;
      OUT33 =BESS.EC.simpleLag2.state;
      OUT34 =BESS.EC.simpleLag3.state;
      OUT35 =BESS.EC.simpleLag4.state;
      OUT36 = G2.gen.PMECH;
      OUT37 = G2.sEXSMPC.EFD;
      OUT38 = BESS.rEGCA1_1.Pgen;
      OUT39 = BESS.rEGCA1_1.Qgen;
      OUT40 = PV.rEGCA1_1.Pgen;
      OUT41 = PV.rEGCA1_1.Qgen;
      OUT42 = Bus5.v;
      OUT43 = Bus5.angle;

        connect(T1.p, Bus2.p)
          annotation (Line(points={{-51.2,80},{-40,80}}, color={0,0,255}));
        connect(Bus1.p, T1.n)
          annotation (Line(points={{-80,80},{-68.8,80}}, color={0,0,255}));
        connect(G1.conn, Bus1.p)
          annotation (Line(points={{-91,80},{-80,80}}, color={0,0,255}));
        connect(L1.n, Bus3.p)
          annotation (Line(points={{-14.6,80},{0,80}}, color={0,0,255}));
        connect(L1.p, Bus2.p)
          annotation (Line(points={{-25.4,80},{-40,80}}, color={0,0,255}));
        connect(L2_2.n, Bus4.p) annotation (Line(points={{35.4,70},{44,70},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.n, Bus4.p) annotation (Line(points={{35.4,90},{44,90},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.p, Bus3.p) annotation (Line(points={{24.6,90},{16,90},{16,80},{0,
                80}}, color={0,0,255}));
        connect(L2_2.p, Bus3.p) annotation (Line(points={{24.6,70},{16,70},{16,80},{0,
                80}}, color={0,0,255}));
        connect(Load1.p, Bus3.p)
          annotation (Line(points={{-10,68},{-10,80},{0,80}}, color={0,0,255}));
        connect(L3.p, Bus4.p)
          annotation (Line(points={{80,65.4},{80,80},{60,80}}, color={0,0,255}));
        connect(breaker.s, Bus5.p)
          annotation (Line(points={{80,22},{80,16}},color={0,0,255}));
        connect(breaker.r, L3.n)
          annotation (Line(points={{80,30},{80,54.6}},color={0,0,255}));

        connect(IB.p, Bus4.p)
          annotation (Line(points={{100,80},{60,80}}, color={0,0,255}));
        connect(Load2.p, Bus5.p) annotation (Line(points={{110,-10},{110,10},{80,10},{
                80,16}},
                     color={0,0,255}));
        connect(T4.n, Bus10.p)
          annotation (Line(points={{-1,-90},{-10,-90}}, color={0,0,255}));
        connect(Bus6.p, T2.n)
          annotation (Line(points={{-10,10},{-1,10}},
                                                  color={0,0,255}));
        connect(BESS.p1, Bus10.p)
          annotation (Line(points={{-20,-90},{-10,-90}}, color={0,0,255}));
        connect(G2.conn, Bus6.p) annotation (Line(points={{-19,10},{-10,10}},
                                           color={0,0,255}));
        connect(PV.p1, Bus8.p)
          annotation (Line(points={{-20,-50},{-10,-50}}, color={0,0,255}));
        connect(Bus8.p, T3.n)
          annotation (Line(points={{-10,-50},{1,-50}},  color={0,0,255}));
        connect(sine.y, Load2.u) annotation (Line(points={{92.5,-15},{96.1,-15},{96.1,
                -14.5},{101.9,-14.5}}, color={0,0,127}));
        connect(T2.p, Bus7.p) annotation (Line(points={{21,10},{25.5,10},{25.5,10},{30,
                10}}, color={0,0,255}));
        connect(T3.p, Bus9.p)
          annotation (Line(points={{23,-50},{30,-50}}, color={0,0,255}));
        connect(T4.p, Bus11.p)
          annotation (Line(points={{21,-90},{30,-90}}, color={0,0,255}));
        connect(L4.n, Bus5.p) annotation (Line(points={{49.4,10},{60,10},{60,10},{80,10},
                {80,16}},     color={0,0,255}));
        connect(L5.n, Bus5.p) annotation (Line(points={{49.4,-50},{60,-50},{60,10},{80,
                10},{80,16}}, color={0,0,255}));
        connect(Bus11.p, L6.p)
          annotation (Line(points={{30,-90},{38.6,-90}}, color={0,0,255}));
        connect(Bus9.p, L5.p)
          annotation (Line(points={{30,-50},{38.6,-50}}, color={0,0,255}));
        connect(L6.n, Bus5.p) annotation (Line(points={{49.4,-90},{60,-90},{60,10},{80,
                10},{80,16}}, color={0,0,255}));
        connect(Bus7.p, L4.p) annotation (Line(points={{30,10},{34.3,10},{34.3,10},{38.6,
                10}}, color={0,0,255}));
        connect(combiTimeTable.y[1], G2.P_ref1)
          annotation (Line(points={{-79,16},{-42,16}}, color={0,0,127}));
        connect(combiTimeTable1.y[1], G2.Efd_ref) annotation (Line(points={{-79,
                -10},{-52,-10},{-52,4},{-42,4}}, color={0,0,127}));
        connect(combiTimeTable2.y[1], PV.QINPUT) annotation (Line(points={{-79,
                -38},{-50,-38},{-50,-50},{-42,-50}}, color={0,0,127}));
        connect(combiTimeTable3.y[1], BESS.Paux1)
          annotation (Line(points={{-79,-84},{-42,-84}}, color={0,0,127}));
        connect(combiTimeTable4.y[1], BESS.Qext1) annotation (Line(points={{-79,
                -110},{-52,-110},{-52,-96},{-42,-96}}, color={0,0,127}));
          annotation (Placement(transformation(extent={{140,-20},{160,0}})),
                      Placement(transformation(extent={{140,-40},{160,-20}})),
                      Placement(transformation(extent={{140,-60},{160,-40}})),
                      Placement(transformation(extent={{140,-80},{160,-60}})),
                     Diagram(coordinateSystem(preserveAspectRatio=false,
                extent={{-140,-140},{140,140}}), graphics={
              Rectangle(
                extent={{130,98},{252,-124}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,36},{124,-124}},
                lineColor={238,46,47},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,98},{124,38}},
                lineColor={0,128,255},
                lineThickness=0.5),
              Text(
                extent={{78,-106},{114,-120}},
                textColor={238,46,47},
                textString="Microgrid"),
              Text(
                extent={{76,58},{128,34}},
                textColor={28,108,200},
                textString="Utility Grid"),
              Text(
                extent={{-30,-102},{34,-124}},
                textColor={0,140,72},
                textString="Linearization Unit"),
              Text(
                extent={{-164,50},{-132,30}},
                textColor={0,140,72},
                textString="Inputs"),
              Text(
                extent={{128,118},{168,98}},
                textColor={0,140,72},
                textString="Outputs")}),
          Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),experiment(
            StopTime=5,
            __Dymola_NumberOfIntervals=1000,
            __Dymola_Algorithm="Dassl"),
          Icon(coordinateSystem(extent={{-140,-140},{140,140}})));
      end MPCAppliedEnergyOriginal_TABLE_mode4_modified2;

      model MPCAppliedEnergyOriginal2
        "THIS ONE IS STABLE, CONTROLLABLE, OBSERVABLE!!!!!!!"
        extends Modelica.Icons.Example;

        parameter Boolean equivalentGRID = true;
        parameter Boolean equivalentsystem = false;

        OpenIPSL.Electrical.Buses.Bus Bus1(v_0=powerFlow.powerflow.bus.V1, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-90,70},{-70,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus2(v_0=powerFlow.powerflow.bus.V2, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-50,70},{-30,90}})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
          R=0.001,
          X=0.2,
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000)  if not equivalentGRID annotation (Placement(transformation(
              extent={{-8,-8},{8,8}},
              rotation=180,
              origin={-60,80})));
        OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
          enableV_b=true,
          v_0=powerFlow.powerflow.bus.V1,
          angle_0=powerFlow.powerflow.bus.A1,
          P_0=powerFlow.powerflow.machines.PG1,
          Q_0=powerFlow.powerflow.machines.QG1,
          V_b=6000)  if not equivalentGRID
          annotation (Placement(transformation(extent={{-112,70},{-92,90}})));
        OpenIPSL.Electrical.Branches.PwLine L1(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{-26,76},
                  {-14,84}})));
        OpenIPSL.Electrical.Buses.Bus Bus3(v_0=powerFlow.powerflow.bus.V3, angle_0=
              powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-10,70},{10,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus4(v_0=powerFlow.powerflow.bus.V4, angle_0=
              powerFlow.powerflow.bus.V4) if not equivalentGRID
          annotation (Placement(transformation(extent={{50,70},{70,90}})));
        OpenIPSL.Electrical.Branches.PwLine L2_1(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,86},
                  {36,94}})));
        OpenIPSL.Electrical.Branches.PwLine L2_2(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,66},
                  {36,74}})));
        OpenIPSL.Electrical.Buses.Bus Bus5(angle_0=powerFlow.powerflow.bus.A5, v_0=
              powerFlow.powerflow.bus.V5)  annotation (Placement(
              transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={80,16})));
        OpenIPSL.Electrical.Branches.PwLine L3(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=-90,
              origin={80,60})));
        OpenIPSL.Electrical.Buses.Bus Bus6(v_0=powerFlow.powerflow.bus.V6, angle_0=
              powerFlow.powerflow.bus.A6) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,10})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000,
          R=0.005,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={10,10})));
        GenerationUnits.PSSE.G2_16MVA                         G2(
          enableV_b=true,
          enableP_0=true,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V6,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A6,
          V_b=6000,
          P_0=powerFlow.powerflow.machines.PG2,
          Q_0=powerFlow.powerflow.machines.QG2,
          enableangle_0=true)
                        annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-30,10})));
        inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000, fn=60)
          annotation (Placement(transformation(extent={{-128,104},{-74,124}})));
        OpenIPSL.Electrical.Loads.PSSE.Load Load1(
          V_b=220000,
          P_0=powerFlow.powerflow.loads.PL1,
          Q_0=powerFlow.powerflow.loads.QL1,
          v_0=powerFlow.powerflow.bus.V3,
          angle_0=powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-20,48},{0,68}})));
        Electrical.Events.Breaker breaker(enableTrigger=false,
          t_o=8.5,
          rc_enabled=false,
          t_rc=80.01)       if not equivalentGRID                     annotation (Placement(transformation(
              extent={{-4,-4},{4,4}},
              rotation=90,
              origin={80,26})));

        Modelica.Blocks.Interfaces.RealInput IN1(start=0)
          "Connector of Real input signal 2" annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-150,10}),iconTransformation(extent={{-10,-10},{10,10}}, origin={-150,10})));
        Modelica.Blocks.Sources.Constant IN11(k=0)
          annotation (Placement(transformation(extent={{-108,-2},{-96,10}})));
        Modelica.Blocks.Math.Add AddU1
          annotation (Placement(transformation(extent={{-80,0},{-60,20}})));
        Modelica.Blocks.Sources.Constant IN22(k=0)
          annotation (Placement(transformation(extent={{-108,-32},{-96,-20}})));
        Modelica.Blocks.Math.Add AddU2
          annotation (Placement(transformation(extent={{-80,-30},{-60,-10}})));
        Modelica.Blocks.Interfaces.RealInput IN2(start=0)
          "Connector of Real input signal 2"
                 annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-150,-12}), iconTransformation(extent={{-10,-10},{10,10}},
                origin={-150,-12})));
                  Modelica.Blocks.Interfaces.RealInput IN3 "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-44},{-140,-24}}),
              iconTransformation(extent={{-160,-44},{-140,-24}})));
        Modelica.Blocks.Interfaces.RealInput IN4(start = 0) "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-66},{-140,-46}}),
              iconTransformation(extent={{-160,-66},{-140,-46}})));
        Modelica.Blocks.Interfaces.RealInput IN5(start = 0) "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-88},{-140,-68}}),
              iconTransformation(extent={{-160,-88},{-140,-68}})));

        Modelica.Blocks.Interfaces.RealOutput OUT1
          annotation (Placement(transformation(extent={{140,70},{160,90}})));

        PFData.PowerFlow powerFlow(redeclare record PowerFlow =
              OpenIPSL.Examples.ModelPredictiveControl.PFData.PF16)
          annotation (Placement(transformation(extent={{-68,104},{-48,124}})));
        Electrical.Machines.PSSE.GENCLS IB(
          V_b=220000,
          v_0=powerFlow.powerflow.bus.V4,
          angle_0=powerFlow.powerflow.bus.A4,
          P_0=powerFlow.powerflow.machines.Pinf,
          Q_0=powerFlow.powerflow.machines.Qinf,
          M_b=100000000,
          X_d=1) if not equivalentGRID annotation (Placement(transformation(extent={{110,70},
                  {100,90}})));
        Electrical.Loads.PSSE.Load_ExtInput Load2(
          P_0=powerFlow.powerflow.loads.PL2,
          Q_0=powerFlow.powerflow.loads.QL2,
          v_0=powerFlow.powerflow.bus.V5,
          angle_0=powerFlow.powerflow.bus.A5,
          d_P=0,
          t1=100,
          d_t=1000)
          annotation (Placement(transformation(extent={{100,-30},{120,-10}})));

        inner Modelica.Blocks.Noise.GlobalSeed globalSeed(useAutomaticSeed=false,
            fixedSeed=10000)
          annotation (Placement(transformation(extent={{-42,102},{-22,122}})));
        Modelica.Blocks.Sources.Sine sine(
          amplitude=0,
          f=1/260,
          phase=3.1415926535898,
          startTime=1000)
          annotation (Placement(transformation(extent={{70,-36},{80,-26}})));

        Electrical.Buses.Bus Bus10(v_0=powerFlow.powerflow.bus.V10, angle_0=powerFlow.powerflow.bus.A10)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,-90})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T4(
          G=0,
          B=0,
          CW=1,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={10,-90})));
        GenerationUnits.PSSE.Solar_Units.SolarMPCLocalVQControl PV(
          V_b=480,
          P_0=powerFlow.powerflow.machines.PPV,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QPV,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V8,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A8,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-60},{-20,-40}})));
        Modelica.Blocks.Math.Add AddU3
          annotation (Placement(transformation(extent={{-80,-60},{-60,-40}})));
        Modelica.Blocks.Sources.Constant IN33(k=0)
          annotation (Placement(transformation(extent={{-108,-62},{-96,-50}})));

        Modelica.Blocks.Math.Add AddU4
          annotation (Placement(transformation(extent={{-80,-90},{-60,-70}})));
        Modelica.Blocks.Math.Add AddU5
          annotation (Placement(transformation(extent={{-80,-116},{-60,-96}})));
        Modelica.Blocks.Sources.Constant IN44(k=0)
          annotation (Placement(transformation(extent={{-108,-92},{-96,-80}})));
        Modelica.Blocks.Sources.Constant IN55(k=0)
          annotation (Placement(transformation(extent={{-108,-118},{-96,-106}})));
        GenerationUnits.PSSE.Battery_Units.BESSMPCLocalVQControl BESS(
          V_base=480,
          V_b(displayUnit="kV") = 480,
          enableV_b=true,
          P_0=powerFlow.powerflow.machines.PBESS,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QBESS,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V10,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A10,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-100},{-20,-80}})));
        Modelica.Blocks.Interfaces.RealOutput OUT35
          annotation (Placement(transformation(extent={{206,-10},{226,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT36
          annotation (Placement(transformation(extent={{206,-30},{226,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT37
          annotation (Placement(transformation(extent={{206,-50},{226,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT38
          annotation (Placement(transformation(extent={{206,-70},{226,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT39
          annotation (Placement(transformation(extent={{206,-90},{226,-70}})));
        Electrical.Buses.Bus Bus8(v_0=powerFlow.powerflow.bus.V8, angle_0=powerFlow.powerflow.bus.A8)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,-50})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T3(
          G=0,
          B=0,
          CW=1,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={12,-50})));
        Electrical.Buses.Bus Bus11(v_0=powerFlow.powerflow.bus.V11, angle_0=powerFlow.powerflow.bus.A11)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,-90})));
        Electrical.Buses.Bus Bus9(v_0=powerFlow.powerflow.bus.V9, angle_0=powerFlow.powerflow.bus.A9)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,-50})));
        Electrical.Buses.Bus Bus7(v_0=powerFlow.powerflow.bus.V7, angle_0=powerFlow.powerflow.bus.A7)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,10})));
        Electrical.Branches.PwLine          L4(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,6},{
                  50,14}})));
        Electrical.Branches.PwLine          L5(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,-54},
                  {50,-46}})));
        Electrical.Branches.PwLine          L6(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,-94},
                  {50,-86}})));
        Modelica.Blocks.Interfaces.RealOutput OUT40
          annotation (Placement(transformation(extent={{206,-110},{226,-90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT41
          annotation (Placement(transformation(extent={{224,70},{244,90}})));
        Electrical.Loads.NoiseInjections.WhiteNoiseInjection whiteNoiseInjection(
            active_sigma=0.0000000001, samplePeriod=0.1)
          annotation (Placement(transformation(extent={{68,-18},{80,-6}})));
        Modelica.Blocks.Math.Add add
          annotation (Placement(transformation(extent={{86,-18},{94,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT42
          annotation (Placement(transformation(extent={{224,50},{244,70}})));
      equation

      // OUT1 = G2.gen.w;
      // OUT2 = G2.gen.delta;
      // OUT3 = G2.gen.Epq;
      // OUT4 = G2.gen.PSIkd;
      // OUT5 = G2.gen.PSIppq;
      // OUT6 = G2.sEXSMPC.simpleLagLim.state;
      // OUT7 = G2.sEXSMPC.leadLag.TF.x_scaled[1];
      // OUT8 = G2.gASTMPC.simpleLagLim.state;
      // OUT9 = G2.gASTMPC.simpleLag.state;
      // OUT10 = G2.gASTMPC.simpleLag1.state;
      // OUT11 = PV.rEGCA1_1.simpleLag.state;
      // OUT12 = PV.rEGCA1_1.integrator.y;
      // OUT13 = PV.rEGCA1_1.integrator1.y;
      // OUT14 =PV.EC.IGQ.y;
      // OUT15 =PV.EC.IGV.y;
      // OUT16 =PV.EC.simpleLag.state;
      // OUT17 =PV.EC.simpleLag1.state;
      // OUT18 =PV.EC.simpleLag2.state;
      // OUT19 =PV.EC.IGP.y;
      // OUT20 =PV.EC.simpleLag3.state;
      // OUT21 =PV.EC.simpleLag4.state;
      // OUT22 =PV.EC.simpleLag5.state;
      // OUT23 = BESS.rEGCA1_1.simpleLag.state;
      // OUT24 = BESS.rEGCA1_1.integrator.y;
      // OUT25 = BESS.rEGCA1_1.integrator1.y;
      // OUT26 =BESS.EC.integrator3.y;
      // OUT27 =BESS.EC.integrator1.y;
      // OUT28 =BESS.EC.simpleLag.state;
      // OUT29 =BESS.EC.IGQ.y;
      // OUT30 =BESS.EC.IGV.y;
      // OUT31 =BESS.EC.IGP.y;
      // OUT32 =BESS.EC.simpleLag1.state;
      // OUT33 =BESS.EC.simpleLag2.state;
      // OUT34 =BESS.EC.simpleLag3.state;
      // OUT35 =BESS.EC.simpleLag4.state;
      // OUT36 = G2.gen.PMECH;
      // OUT37 = G2.sEXSMPC.EFD;
      // OUT38 = BESS.rEGCA1_1.Pgen;
      // OUT39 = BESS.rEGCA1_1.Qgen;
      // OUT40 = PV.rEGCA1_1.Pgen;
      // OUT41 = PV.rEGCA1_1.Qgen;
      // OUT42 = Bus5.v;
      // OUT43 = Bus5.angle;

      OUT1 = G2.gen.w;
      // OUT2 = G2.gen.delta;
      // OUT3 = G2.gen.Epq;
      // OUT4 = G2.gen.PSIkd;
      // OUT5 = G2.gen.PSIppq;
      // OUT6 = G2.sEXSMPC.simpleLagLim.state;
      // OUT7 = G2.sEXSMPC.leadLag.TF.x_scaled[1];
      // OUT8 = G2.gASTMPC.simpleLagLim.state;
      // OUT9 = G2.gASTMPC.simpleLag.state;
      // OUT10 = G2.gASTMPC.simpleLag1.state;
      // OUT11 = PV.rEGCA1_1.simpleLag.state;
      // OUT12 = PV.rEGCA1_1.integrator.y;
      // OUT13 = PV.rEGCA1_1.integrator1.y;
      // OUT14 =PV.EC.IGQ.y;
      // OUT15 =PV.EC.IGV.y;
      // OUT16 =PV.EC.simpleLag.state;
      // OUT17 =PV.EC.simpleLag1.state;
      // OUT18 =PV.EC.simpleLag2.state;
      // OUT19 =PV.EC.IGP.y;
      // OUT20 =PV.EC.simpleLag3.state;
      // OUT21 =PV.EC.simpleLag5.state;
      // OUT22 = PV.EC.simpleLag4.state;
      // OUT23 = BESS.rEGCA1_1.simpleLag.state;
      // OUT24 = BESS.rEGCA1_1.integrator.y;
      // OUT25 = BESS.rEGCA1_1.integrator1.y;
      // OUT26 =BESS.EC.integrator3.y;
      // OUT27 =BESS.EC.simpleLag.state;
      // OUT28 =BESS.EC.IGQ.y;
      // OUT29 =BESS.EC.IGV.y;
      // OUT30 =BESS.EC.IGP.y;
      // OUT31 =BESS.EC.simpleLag1.state;
      // OUT32 =BESS.EC.simpleLag2.state;
      // OUT33 =BESS.EC.simpleLag3.state;
      // OUT34 =BESS.EC.simpleLag4.state;
      OUT35 = G2.gen.PMECH;
      OUT36 = G2.sEXSMPC.EFD;
      OUT37 = BESS.rEGCA1_1.Pgen;
      OUT38 = BESS.rEGCA1_1.Qgen;
      OUT39 = PV.rEGCA1_1.Pgen;
      OUT40 = PV.rEGCA1_1.Qgen;
      OUT41 = Bus5.v;
      OUT42 = Bus5.angle;

        connect(T1.p, Bus2.p)
          annotation (Line(points={{-51.2,80},{-40,80}}, color={0,0,255}));
        connect(Bus1.p, T1.n)
          annotation (Line(points={{-80,80},{-68.8,80}}, color={0,0,255}));
        connect(G1.conn, Bus1.p)
          annotation (Line(points={{-91,80},{-80,80}}, color={0,0,255}));
        connect(L1.n, Bus3.p)
          annotation (Line(points={{-14.6,80},{0,80}}, color={0,0,255}));
        connect(L1.p, Bus2.p)
          annotation (Line(points={{-25.4,80},{-40,80}}, color={0,0,255}));
        connect(L2_2.n, Bus4.p) annotation (Line(points={{35.4,70},{44,70},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.n, Bus4.p) annotation (Line(points={{35.4,90},{44,90},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.p, Bus3.p) annotation (Line(points={{24.6,90},{16,90},{16,80},{0,
                80}}, color={0,0,255}));
        connect(L2_2.p, Bus3.p) annotation (Line(points={{24.6,70},{16,70},{16,80},{0,
                80}}, color={0,0,255}));
        connect(Load1.p, Bus3.p)
          annotation (Line(points={{-10,68},{-10,80},{0,80}}, color={0,0,255}));
        connect(L3.p, Bus4.p)
          annotation (Line(points={{80,65.4},{80,80},{60,80}}, color={0,0,255}));
        connect(breaker.s, Bus5.p)
          annotation (Line(points={{80,22},{80,16}},color={0,0,255}));
        connect(breaker.r, L3.n)
          annotation (Line(points={{80,30},{80,54.6}},color={0,0,255}));
        connect(IN11.y, AddU1.u2) annotation (Line(points={{-95.4,4},{-82,4}},
                            color={0,0,127}));
        connect(IN1, AddU1.u1) annotation (Line(points={{-150,10},{-116,10},{-116,16},
                {-82,16}},
                       color={0,0,127}));

        connect(IN22.y,AddU2. u2) annotation (Line(points={{-95.4,-26},{-82,-26}},
                       color={0,0,127}));
        connect(IN2,AddU2. u1) annotation (Line(points={{-150,-12},{-118,-12},{-118,-14},
                {-82,-14}},
                       color={0,0,127}));
        connect(AddU2.y, G2.Efd_ref)
          annotation (Line(points={{-59,-20},{-52,-20},{-52,4},{-42,4}},
                                                                 color={0,0,127}));
        connect(AddU1.y, G2.P_ref1) annotation (Line(points={{-59,10},{-52,10},{-52,16},
                {-42,16}},                          color={0,0,127}));
        connect(IB.p, Bus4.p)
          annotation (Line(points={{100,80},{60,80}}, color={0,0,255}));
        connect(Load2.p, Bus5.p) annotation (Line(points={{110,-10},{110,10},{80,10},{
                80,16}},
                     color={0,0,255}));
        connect(T4.n, Bus10.p)
          annotation (Line(points={{-1,-90},{-10,-90}}, color={0,0,255}));
        connect(Bus6.p, T2.n)
          annotation (Line(points={{-10,10},{-1,10}},
                                                  color={0,0,255}));
        connect(AddU3.y, PV.QINPUT) annotation (Line(points={{-59,-50},{-42,-50}},
                                 color={0,0,127}));
        connect(IN33.y,AddU3. u2)
          annotation (Line(points={{-95.4,-56},{-82,-56}}, color={0,0,127}));
        connect(BESS.p1, Bus10.p)
          annotation (Line(points={{-20,-90},{-10,-90}}, color={0,0,255}));
        connect(BESS.Paux1, AddU4.y) annotation (Line(points={{-42,-84},{-54,-84},{-54,
                -80},{-59,-80}}, color={0,0,127}));
        connect(IN55.y, AddU5.u2)
          annotation (Line(points={{-95.4,-112},{-82,-112}}, color={0,0,127}));
        connect(AddU5.y, BESS.Qext1) annotation (Line(points={{-59,-106},{-52,-106},{-52,
                -96},{-42,-96}},   color={0,0,127}));
        connect(IN44.y, AddU4.u2)
          annotation (Line(points={{-95.4,-86},{-82,-86}}, color={0,0,127}));
        connect(AddU4.u1,IN4)  annotation (Line(points={{-82,-74},{-100,-74},{-100,-70},
                {-116,-70},{-116,-56},{-150,-56}}, color={0,0,127}));
        connect(AddU5.u1,IN5)  annotation (Line(points={{-82,-100},{-116,-100},{-116,-78},
                {-150,-78}}, color={0,0,127}));
        connect(G2.conn, Bus6.p) annotation (Line(points={{-19,10},{-10,10}},
                                           color={0,0,255}));
        connect(AddU3.u1, IN3) annotation (Line(points={{-82,-44},{-118,-44},{-118,-34},
                {-150,-34}}, color={0,0,127}));
        connect(PV.p1, Bus8.p)
          annotation (Line(points={{-20,-50},{-10,-50}}, color={0,0,255}));
        connect(Bus8.p, T3.n)
          annotation (Line(points={{-10,-50},{1,-50}},  color={0,0,255}));
        connect(T2.p, Bus7.p) annotation (Line(points={{21,10},{25.5,10},{25.5,10},{30,
                10}}, color={0,0,255}));
        connect(T3.p, Bus9.p)
          annotation (Line(points={{23,-50},{30,-50}}, color={0,0,255}));
        connect(T4.p, Bus11.p)
          annotation (Line(points={{21,-90},{30,-90}}, color={0,0,255}));
        connect(L4.n, Bus5.p) annotation (Line(points={{49.4,10},{60,10},{60,10},{80,10},
                {80,16}},     color={0,0,255}));
        connect(L5.n, Bus5.p) annotation (Line(points={{49.4,-50},{60,-50},{60,10},{80,
                10},{80,16}}, color={0,0,255}));
        connect(Bus11.p, L6.p)
          annotation (Line(points={{30,-90},{38.6,-90}}, color={0,0,255}));
        connect(Bus9.p, L5.p)
          annotation (Line(points={{30,-50},{38.6,-50}}, color={0,0,255}));
        connect(L6.n, Bus5.p) annotation (Line(points={{49.4,-90},{60,-90},{60,10},{80,
                10},{80,16}}, color={0,0,255}));
        connect(Bus7.p, L4.p) annotation (Line(points={{30,10},{34.3,10},{34.3,10},{38.6,
                10}}, color={0,0,255}));
        connect(sine.y, add.u2) annotation (Line(points={{80.5,-31},{85.2,-31},{85.2,-16.4}},
              color={0,0,127}));
        connect(whiteNoiseInjection.y, add.u1) annotation (Line(points={{80.54,-12.06},
                {82.87,-12.06},{82.87,-11.6},{85.2,-11.6}}, color={0,0,127}));
        connect(add.y, Load2.u) annotation (Line(points={{94.4,-14},{98.15,-14},{98.15,
                -14.5},{101.9,-14.5}}, color={0,0,127}));
          annotation (Placement(transformation(extent={{140,-20},{160,0}})),
                      Placement(transformation(extent={{140,-40},{160,-20}})),
                      Placement(transformation(extent={{140,-60},{160,-40}})),
                      Placement(transformation(extent={{140,-80},{160,-60}})),
                     Diagram(coordinateSystem(preserveAspectRatio=false,
                extent={{-140,-140},{140,140}}), graphics={
              Rectangle(
                extent={{-160,30},{-134,-90}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,36},{124,-124}},
                lineColor={238,46,47},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,98},{124,38}},
                lineColor={0,128,255},
                lineThickness=0.5),
              Text(
                extent={{78,-106},{114,-120}},
                textColor={238,46,47},
                textString="Microgrid"),
              Text(
                extent={{76,58},{128,34}},
                textColor={28,108,200},
                textString="Utility Grid"),
              Text(
                extent={{-30,-102},{34,-124}},
                textColor={0,140,72},
                textString="Linearization Unit"),
              Text(
                extent={{-164,50},{-132,30}},
                textColor={0,140,72},
                textString="Inputs")}),
          Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),experiment(
            StopTime=20,
            __Dymola_NumberOfIntervals=1000,
            __Dymola_Algorithm="Dassl"),
          Icon(coordinateSystem(extent={{-140,-140},{140,140}})));
      end MPCAppliedEnergyOriginal2;

      model MPCAppliedEnergyLinearized2
        "THIS ONE IS STABLE, CONTROLLABLE, OBSERVABLE!!!!!!!"
        extends Modelica.Icons.Example;

        parameter Boolean equivalentGRID = true;
        parameter Boolean equivalentsystem = false;

        OpenIPSL.Electrical.Buses.Bus Bus1(v_0=powerFlow.powerflow.bus.V1, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-90,70},{-70,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus2(v_0=powerFlow.powerflow.bus.V2, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-50,70},{-30,90}})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
          R=0.001,
          X=0.2,
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000)  if not equivalentGRID annotation (Placement(transformation(
              extent={{-8,-8},{8,8}},
              rotation=180,
              origin={-60,80})));
        OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
          enableV_b=true,
          v_0=powerFlow.powerflow.bus.V1,
          angle_0=powerFlow.powerflow.bus.A1,
          P_0=powerFlow.powerflow.machines.PG1,
          Q_0=powerFlow.powerflow.machines.QG1,
          V_b=6000)  if not equivalentGRID
          annotation (Placement(transformation(extent={{-112,70},{-92,90}})));
        OpenIPSL.Electrical.Branches.PwLine L1(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{-26,76},
                  {-14,84}})));
        OpenIPSL.Electrical.Buses.Bus Bus3(v_0=powerFlow.powerflow.bus.V3, angle_0=
              powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-10,70},{10,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus4(v_0=powerFlow.powerflow.bus.V4, angle_0=
              powerFlow.powerflow.bus.V4) if not equivalentGRID
          annotation (Placement(transformation(extent={{50,70},{70,90}})));
        OpenIPSL.Electrical.Branches.PwLine L2_1(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,86},
                  {36,94}})));
        OpenIPSL.Electrical.Branches.PwLine L2_2(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,66},
                  {36,74}})));
        OpenIPSL.Electrical.Buses.Bus Bus5(angle_0=powerFlow.powerflow.bus.A5, v_0=
              powerFlow.powerflow.bus.V5)  annotation (Placement(
              transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={80,16})));
        OpenIPSL.Electrical.Branches.PwLine L3(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=-90,
              origin={80,60})));
        OpenIPSL.Electrical.Buses.Bus Bus6(v_0=powerFlow.powerflow.bus.V6, angle_0=
              powerFlow.powerflow.bus.A6) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,10})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000,
          R=0.005,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={10,10})));
        GenerationUnits.PSSE.G2_16MVA                         G2(
          enableV_b=true,
          enableP_0=true,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V6,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A6,
          V_b=6000,
          P_0=powerFlow.powerflow.machines.PG2,
          Q_0=powerFlow.powerflow.machines.QG2,
          enableangle_0=true)
                        annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-30,10})));
        inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000, fn=60)
          annotation (Placement(transformation(extent={{-128,104},{-74,124}})));
        OpenIPSL.Electrical.Loads.PSSE.Load Load1(
          V_b=220000,
          P_0=powerFlow.powerflow.loads.PL1,
          Q_0=powerFlow.powerflow.loads.QL1,
          v_0=powerFlow.powerflow.bus.V3,
          angle_0=powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-20,48},{0,68}})));
        Electrical.Events.Breaker breaker(enableTrigger=false,
          t_o=1.01,
          rc_enabled=true,
          t_rc=10000)       if not equivalentGRID                     annotation (Placement(transformation(
              extent={{-4,-4},{4,4}},
              rotation=90,
              origin={80,26})));

        Modelica.Blocks.Interfaces.RealInput IN1(start=0)
          "Connector of Real input signal 2" annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-150,10}),iconTransformation(extent={{-10,-10},{10,10}}, origin={-150,10})));
        Modelica.Blocks.Sources.Constant IN11(k=0)
          annotation (Placement(transformation(extent={{-108,-2},{-96,10}})));
        Modelica.Blocks.Math.Add AddU1
          annotation (Placement(transformation(extent={{-80,0},{-60,20}})));
        Modelica.Blocks.Sources.Constant IN22(k=0)
          annotation (Placement(transformation(extent={{-108,-32},{-96,-20}})));
        Modelica.Blocks.Math.Add AddU2
          annotation (Placement(transformation(extent={{-80,-30},{-60,-10}})));
        Modelica.Blocks.Interfaces.RealInput IN2(start=0)
          "Connector of Real input signal 2"
                 annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-150,-12}), iconTransformation(extent={{-10,-10},{10,10}},
                origin={-150,-12})));

        Modelica.Blocks.Interfaces.RealInput IN3(start = 0) "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-44},{-140,-24}}),
              iconTransformation(extent={{-160,-44},{-140,-24}})));
        Modelica.Blocks.Interfaces.RealInput IN4(start = 0) "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-66},{-140,-46}}),
              iconTransformation(extent={{-160,-66},{-140,-46}})));
        Modelica.Blocks.Interfaces.RealInput IN5(start = 0) "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-88},{-140,-68}}),
              iconTransformation(extent={{-160,-88},{-140,-68}})));

        Modelica.Blocks.Interfaces.RealOutput OUT1
          annotation (Placement(transformation(extent={{140,70},{160,90}})));

        PFData.PowerFlow powerFlow(redeclare record PowerFlow =
              OpenIPSL.Examples.ModelPredictiveControl.PFData.PF16)
          annotation (Placement(transformation(extent={{-68,104},{-48,124}})));
        Electrical.Machines.PSSE.GENCLS IB(
          V_b=220000,
          v_0=powerFlow.powerflow.bus.V4,
          angle_0=powerFlow.powerflow.bus.A4,
          P_0=powerFlow.powerflow.machines.Pinf,
          Q_0=powerFlow.powerflow.machines.Qinf,
          M_b=100000000,
          X_d=1) if not equivalentGRID annotation (Placement(transformation(extent={{110,70},
                  {100,90}})));
        Electrical.Loads.PSSE.Load_ExtInput Load2(
          P_0=powerFlow.powerflow.loads.PL2,
          Q_0=powerFlow.powerflow.loads.QL2,
          v_0=powerFlow.powerflow.bus.V5,
          angle_0=powerFlow.powerflow.bus.A5,
          d_P=0,
          t1=100,
          d_t=1000)
          annotation (Placement(transformation(extent={{100,-30},{120,-10}})));

        inner Modelica.Blocks.Noise.GlobalSeed globalSeed(useAutomaticSeed=false,
            fixedSeed=10000)
          annotation (Placement(transformation(extent={{-42,102},{-22,122}})));

        Electrical.Buses.Bus Bus10(v_0=powerFlow.powerflow.bus.V10, angle_0=powerFlow.powerflow.bus.A10)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,-90})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T4(
          G=0,
          B=0,
          CW=1,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={10,-90})));
        GenerationUnits.PSSE.Solar_Units.SolarMPCLocalVQControl PV(
          V_b=480,
          P_0=powerFlow.powerflow.machines.PPV,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QPV,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V8,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A8,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-60},{-20,-40}})));
        Modelica.Blocks.Math.Add AddU3
          annotation (Placement(transformation(extent={{-80,-60},{-60,-40}})));
        Modelica.Blocks.Sources.Constant IN33(k=0)
          annotation (Placement(transformation(extent={{-108,-62},{-96,-50}})));

        Modelica.Blocks.Math.Add AddU4
          annotation (Placement(transformation(extent={{-80,-90},{-60,-70}})));
        Modelica.Blocks.Math.Add AddU5
          annotation (Placement(transformation(extent={{-80,-116},{-60,-96}})));
        Modelica.Blocks.Sources.Constant IN44(k=0)
          annotation (Placement(transformation(extent={{-108,-92},{-96,-80}})));
        Modelica.Blocks.Sources.Constant IN55(k=0)
          annotation (Placement(transformation(extent={{-108,-118},{-96,-106}})));
        GenerationUnits.PSSE.Battery_Units.BESSMPCLocalVQControlLinearized
                                                                 BESS(
          V_base=480,
          V_b(displayUnit="kV") = 480,
          enableV_b=true,
          P_0=powerFlow.powerflow.machines.PBESS,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QBESS,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V10,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A10,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-100},{-20,-80}})));
        Modelica.Blocks.Interfaces.RealOutput OUT35
          annotation (Placement(transformation(extent={{206,-10},{226,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT36
          annotation (Placement(transformation(extent={{206,-30},{226,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT37
          annotation (Placement(transformation(extent={{206,-50},{226,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT38
          annotation (Placement(transformation(extent={{206,-70},{226,-50}})));
        Electrical.Buses.Bus Bus8(v_0=powerFlow.powerflow.bus.V8, angle_0=powerFlow.powerflow.bus.A8)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,-50})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T3(
          G=0,
          B=0,
          CW=1,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={12,-50})));
        Electrical.Buses.Bus Bus11(v_0=powerFlow.powerflow.bus.V11, angle_0=powerFlow.powerflow.bus.A11)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,-90})));
        Electrical.Buses.Bus Bus9(v_0=powerFlow.powerflow.bus.V9, angle_0=powerFlow.powerflow.bus.A9)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,-50})));
        Electrical.Buses.Bus Bus7(v_0=powerFlow.powerflow.bus.V7, angle_0=powerFlow.powerflow.bus.A7)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,10})));
        Electrical.Branches.PwLine          L4(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,6},{
                  50,14}})));
        Electrical.Branches.PwLine          L5(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,-54},
                  {50,-46}})));
        Electrical.Branches.PwLine          L6(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,-94},
                  {50,-86}})));
        Modelica.Blocks.Interfaces.RealOutput OUT39
          annotation (Placement(transformation(extent={{206,-90},{226,-70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT40
          annotation (Placement(transformation(extent={{208,-108},{228,-88}})));
        Modelica.Blocks.Interfaces.RealOutput OUT41
          annotation (Placement(transformation(extent={{224,70},{244,90}})));
        Modelica.Blocks.Sources.Sine sine(
          amplitude=0,
          f=1/260,
          phase=3.1415926535898,
          startTime=1000)
          annotation (Placement(transformation(extent={{68,-36},{78,-26}})));
        Electrical.Loads.NoiseInjections.WhiteNoiseInjection whiteNoiseInjection(
            active_sigma=0.0000000001, samplePeriod=0.01)
          annotation (Placement(transformation(extent={{66,-18},{78,-6}})));
        Modelica.Blocks.Math.Add add
          annotation (Placement(transformation(extent={{84,-18},{92,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT42
          annotation (Placement(transformation(extent={{224,50},{244,70}})));
      equation

      OUT1 = G2.gen.w;
      OUT2 = G2.gen.delta;
      OUT3 = G2.gen.Epq;
      OUT4 = G2.gen.PSIkd;
      OUT5 = G2.gen.PSIppq;
      OUT6 = G2.sEXSMPC.simpleLagLim.state;
      OUT7 = G2.sEXSMPC.leadLag.TF.x_scaled[1];
      OUT8 = G2.gASTMPC.simpleLagLim.state;
      OUT9 = G2.gASTMPC.simpleLag.state;
      OUT10 = G2.gASTMPC.simpleLag1.state;
      OUT11 = PV.rEGCA1_1.simpleLag.state;
      OUT12 = PV.rEGCA1_1.integrator.y;
      OUT13 = PV.rEGCA1_1.integrator1.y;
      OUT14 =PV.EC.IGQ.y;
      OUT15 =PV.EC.IGV.y;
      OUT16 =PV.EC.simpleLag.state;
      OUT17 =PV.EC.simpleLag1.state;
      OUT18 =PV.EC.simpleLag2.state;
      OUT19 =PV.EC.IGP.y;
      OUT20 =PV.EC.simpleLag3.state;
      OUT21 =PV.EC.simpleLag5.state;
      OUT22 = PV.EC.simpleLag4.state;
      OUT23 = BESS.rEGCA1_1.simpleLag.state;
      OUT24 = BESS.rEGCA1_1.integrator.y;
      OUT25 = BESS.rEGCA1_1.integrator1.y;
      OUT26 =BESS.EC.integrator3.y;
      OUT27 =BESS.EC.simpleLag.state;
      OUT28 =BESS.EC.IGQ.y;
      OUT29 =BESS.EC.IGV.y;
      OUT30 =BESS.EC.IGP.y;
      OUT31 =BESS.EC.simpleLag1.state;
      OUT32 =BESS.EC.simpleLag2.state;
      OUT33 =BESS.EC.simpleLag3.state;
      OUT34 =BESS.EC.simpleLag4.state;
      OUT35 = G2.gen.PMECH;
      OUT36 = G2.sEXSMPC.EFD;
      OUT37 = BESS.rEGCA1_1.Pgen;
      OUT38 = BESS.rEGCA1_1.Qgen;
      OUT39 = PV.rEGCA1_1.Pgen;
      OUT40 = PV.rEGCA1_1.Qgen;
      OUT41 = Bus5.v;
      OUT42 = Bus5.angle;

        connect(T1.p, Bus2.p)
          annotation (Line(points={{-51.2,80},{-40,80}}, color={0,0,255}));
        connect(Bus1.p, T1.n)
          annotation (Line(points={{-80,80},{-68.8,80}}, color={0,0,255}));
        connect(G1.conn, Bus1.p)
          annotation (Line(points={{-91,80},{-80,80}}, color={0,0,255}));
        connect(L1.n, Bus3.p)
          annotation (Line(points={{-14.6,80},{0,80}}, color={0,0,255}));
        connect(L1.p, Bus2.p)
          annotation (Line(points={{-25.4,80},{-40,80}}, color={0,0,255}));
        connect(L2_2.n, Bus4.p) annotation (Line(points={{35.4,70},{44,70},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.n, Bus4.p) annotation (Line(points={{35.4,90},{44,90},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.p, Bus3.p) annotation (Line(points={{24.6,90},{16,90},{16,80},{0,
                80}}, color={0,0,255}));
        connect(L2_2.p, Bus3.p) annotation (Line(points={{24.6,70},{16,70},{16,80},{0,
                80}}, color={0,0,255}));
        connect(Load1.p, Bus3.p)
          annotation (Line(points={{-10,68},{-10,80},{0,80}}, color={0,0,255}));
        connect(L3.p, Bus4.p)
          annotation (Line(points={{80,65.4},{80,80},{60,80}}, color={0,0,255}));
        connect(breaker.s, Bus5.p)
          annotation (Line(points={{80,22},{80,16}},color={0,0,255}));
        connect(breaker.r, L3.n)
          annotation (Line(points={{80,30},{80,54.6}},color={0,0,255}));
        connect(IN11.y, AddU1.u2) annotation (Line(points={{-95.4,4},{-82,4}},
                            color={0,0,127}));
        connect(IN1, AddU1.u1) annotation (Line(points={{-150,10},{-116,10},{-116,16},
                {-82,16}},
                       color={0,0,127}));

        connect(IN22.y,AddU2. u2) annotation (Line(points={{-95.4,-26},{-82,-26}},
                       color={0,0,127}));
        connect(IN2,AddU2. u1) annotation (Line(points={{-150,-12},{-118,-12},{-118,-14},
                {-82,-14}},
                       color={0,0,127}));
        connect(AddU2.y, G2.Efd_ref)
          annotation (Line(points={{-59,-20},{-52,-20},{-52,4},{-42,4}},
                                                                 color={0,0,127}));
        connect(AddU1.y, G2.P_ref1) annotation (Line(points={{-59,10},{-52,10},{-52,16},
                {-42,16}},                          color={0,0,127}));
        connect(IB.p, Bus4.p)
          annotation (Line(points={{100,80},{60,80}}, color={0,0,255}));
        connect(Load2.p, Bus5.p) annotation (Line(points={{110,-10},{110,10},{80,10},{
                80,16}},
                     color={0,0,255}));
        connect(T4.n, Bus10.p)
          annotation (Line(points={{-1,-90},{-10,-90}}, color={0,0,255}));
        connect(Bus6.p, T2.n)
          annotation (Line(points={{-10,10},{-1,10}},
                                                  color={0,0,255}));
        connect(AddU3.y, PV.QINPUT) annotation (Line(points={{-59,-50},{-42,-50}},
                                 color={0,0,127}));
        connect(IN33.y,AddU3. u2)
          annotation (Line(points={{-95.4,-56},{-82,-56}}, color={0,0,127}));
        connect(BESS.p1, Bus10.p)
          annotation (Line(points={{-20,-90},{-10,-90}}, color={0,0,255}));
        connect(BESS.Paux1, AddU4.y) annotation (Line(points={{-42,-84},{-54,-84},{-54,
                -80},{-59,-80}}, color={0,0,127}));
        connect(IN55.y, AddU5.u2)
          annotation (Line(points={{-95.4,-112},{-82,-112}}, color={0,0,127}));
        connect(AddU5.y, BESS.Qext1) annotation (Line(points={{-59,-106},{-52,-106},{-52,
                -96},{-42,-96}},   color={0,0,127}));
        connect(IN44.y, AddU4.u2)
          annotation (Line(points={{-95.4,-86},{-82,-86}}, color={0,0,127}));
        connect(AddU4.u1,IN4)  annotation (Line(points={{-82,-74},{-100,-74},{-100,-70},
                {-116,-70},{-116,-56},{-150,-56}}, color={0,0,127}));
        connect(AddU5.u1,IN5)  annotation (Line(points={{-82,-100},{-116,-100},{-116,-78},
                {-150,-78}}, color={0,0,127}));
        connect(G2.conn, Bus6.p) annotation (Line(points={{-19,10},{-10,10}},
                                           color={0,0,255}));
        connect(AddU3.u1, IN3) annotation (Line(points={{-82,-44},{-118,-44},{-118,-34},
                {-150,-34}}, color={0,0,127}));
        connect(PV.p1, Bus8.p)
          annotation (Line(points={{-20,-50},{-10,-50}}, color={0,0,255}));
        connect(Bus8.p, T3.n)
          annotation (Line(points={{-10,-50},{1,-50}},  color={0,0,255}));
        connect(T2.p, Bus7.p) annotation (Line(points={{21,10},{25.5,10},{25.5,10},{30,
                10}}, color={0,0,255}));
        connect(T3.p, Bus9.p)
          annotation (Line(points={{23,-50},{30,-50}}, color={0,0,255}));
        connect(T4.p, Bus11.p)
          annotation (Line(points={{21,-90},{30,-90}}, color={0,0,255}));
        connect(L4.n, Bus5.p) annotation (Line(points={{49.4,10},{60,10},{60,10},{80,10},
                {80,16}},     color={0,0,255}));
        connect(L5.n, Bus5.p) annotation (Line(points={{49.4,-50},{60,-50},{60,10},{80,
                10},{80,16}}, color={0,0,255}));
        connect(Bus11.p, L6.p)
          annotation (Line(points={{30,-90},{38.6,-90}}, color={0,0,255}));
        connect(Bus9.p, L5.p)
          annotation (Line(points={{30,-50},{38.6,-50}}, color={0,0,255}));
        connect(L6.n, Bus5.p) annotation (Line(points={{49.4,-90},{60,-90},{60,10},{80,
                10},{80,16}}, color={0,0,255}));
        connect(Bus7.p, L4.p) annotation (Line(points={{30,10},{34.3,10},{34.3,10},{38.6,
                10}}, color={0,0,255}));
        connect(sine.y, add.u2) annotation (Line(points={{78.5,-31},{78.5,-16.4},
                {83.2,-16.4}}, color={0,0,127}));
        connect(whiteNoiseInjection.y, add.u1) annotation (Line(points={{78.54,
                -12.06},{80.87,-12.06},{80.87,-11.6},{83.2,-11.6}}, color={0,0,
                127}));
        connect(add.y, Load2.u) annotation (Line(points={{92.4,-14},{97.15,-14},
                {97.15,-14.5},{101.9,-14.5}}, color={0,0,127}));
          annotation (Placement(transformation(extent={{140,-20},{160,0}})),
                      Placement(transformation(extent={{140,-40},{160,-20}})),
                      Placement(transformation(extent={{140,-60},{160,-40}})),
                      Placement(transformation(extent={{140,-80},{160,-60}})),
                     Diagram(coordinateSystem(preserveAspectRatio=false,
                extent={{-140,-140},{140,140}}), graphics={
              Rectangle(
                extent={{-160,30},{-134,-90}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,36},{124,-124}},
                lineColor={238,46,47},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,98},{124,38}},
                lineColor={0,128,255},
                lineThickness=0.5),
              Text(
                extent={{78,-106},{114,-120}},
                textColor={238,46,47},
                textString="Microgrid"),
              Text(
                extent={{76,58},{128,34}},
                textColor={28,108,200},
                textString="Utility Grid"),
              Text(
                extent={{-30,-102},{34,-124}},
                textColor={0,140,72},
                textString="Linearization Unit"),
              Text(
                extent={{-164,50},{-132,30}},
                textColor={0,140,72},
                textString="Inputs")}),
          Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),experiment(StopTime=10, __Dymola_Algorithm="Dassl"),
          Icon(coordinateSystem(extent={{-140,-140},{140,140}})));
      end MPCAppliedEnergyLinearized2;

      model MPCAppliedEnergyLinearized3
        "THIS ONE IS STABLE, CONTROLLABLE, OBSERVABLE!!!!!!!"
        extends Modelica.Icons.Example;

        parameter Boolean equivalentGRID = true;
        parameter Boolean equivalentsystem = false;

        OpenIPSL.Electrical.Buses.Bus Bus1(v_0=powerFlow.powerflow.bus.V1, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-90,70},{-70,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus2(v_0=powerFlow.powerflow.bus.V2, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-50,70},{-30,90}})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
          R=0.001,
          X=0.2,
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000)  if not equivalentGRID annotation (Placement(transformation(
              extent={{-8,-8},{8,8}},
              rotation=180,
              origin={-60,80})));
        OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
          enableV_b=true,
          v_0=powerFlow.powerflow.bus.V1,
          angle_0=powerFlow.powerflow.bus.A1,
          P_0=powerFlow.powerflow.machines.PG1,
          Q_0=powerFlow.powerflow.machines.QG1,
          V_b=6000)  if not equivalentGRID
          annotation (Placement(transformation(extent={{-112,70},{-92,90}})));
        OpenIPSL.Electrical.Branches.PwLine L1(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{-26,76},
                  {-14,84}})));
        OpenIPSL.Electrical.Buses.Bus Bus3(v_0=powerFlow.powerflow.bus.V3, angle_0=
              powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-10,70},{10,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus4(v_0=powerFlow.powerflow.bus.V4, angle_0=
              powerFlow.powerflow.bus.V4) if not equivalentGRID
          annotation (Placement(transformation(extent={{50,70},{70,90}})));
        OpenIPSL.Electrical.Branches.PwLine L2_1(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,86},
                  {36,94}})));
        OpenIPSL.Electrical.Branches.PwLine L2_2(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,66},
                  {36,74}})));
        OpenIPSL.Electrical.Buses.Bus Bus5(angle_0=powerFlow.powerflow.bus.A5, v_0=
              powerFlow.powerflow.bus.V5)  annotation (Placement(
              transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={80,16})));
        OpenIPSL.Electrical.Branches.PwLine L3(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=-90,
              origin={80,60})));
        OpenIPSL.Electrical.Buses.Bus Bus6(v_0=powerFlow.powerflow.bus.V6, angle_0=
              powerFlow.powerflow.bus.A6) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,10})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000,
          R=0.005,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={10,10})));
        GenerationUnits.PSSE.G2_16MVA                         G2(
          enableV_b=true,
          enableP_0=true,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V6,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A6,
          V_b=6000,
          P_0=powerFlow.powerflow.machines.PG2,
          Q_0=powerFlow.powerflow.machines.QG2,
          enableangle_0=true)
                        annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-30,10})));
        inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000, fn=60)
          annotation (Placement(transformation(extent={{-128,104},{-74,124}})));
        OpenIPSL.Electrical.Loads.PSSE.Load Load1(
          V_b=220000,
          P_0=powerFlow.powerflow.loads.PL1,
          Q_0=powerFlow.powerflow.loads.QL1,
          v_0=powerFlow.powerflow.bus.V3,
          angle_0=powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-20,48},{0,68}})));
        Electrical.Events.Breaker breaker(enableTrigger=false,
          t_o=1.01,
          rc_enabled=true,
          t_rc=10000)       if not equivalentGRID                     annotation (Placement(transformation(
              extent={{-4,-4},{4,4}},
              rotation=90,
              origin={80,26})));

        Modelica.Blocks.Interfaces.RealInput IN1(start=0)
          "Connector of Real input signal 2" annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-150,10}),iconTransformation(extent={{-10,-10},{10,10}}, origin={-150,10})));
        Modelica.Blocks.Sources.Constant IN11(k=0)
          annotation (Placement(transformation(extent={{-108,-2},{-96,10}})));
        Modelica.Blocks.Math.Add AddU1
          annotation (Placement(transformation(extent={{-80,0},{-60,20}})));
        Modelica.Blocks.Sources.Constant IN22(k=0)
          annotation (Placement(transformation(extent={{-108,-32},{-96,-20}})));
        Modelica.Blocks.Math.Add AddU2
          annotation (Placement(transformation(extent={{-80,-30},{-60,-10}})));
        Modelica.Blocks.Interfaces.RealInput IN2(start=0)
          "Connector of Real input signal 2"
                 annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-150,-12}), iconTransformation(extent={{-10,-10},{10,10}},
                origin={-150,-12})));

        Modelica.Blocks.Interfaces.RealInput IN3(start = 0) "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-44},{-140,-24}}),
              iconTransformation(extent={{-160,-44},{-140,-24}})));
        Modelica.Blocks.Interfaces.RealInput IN4(start = 0) "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-66},{-140,-46}}),
              iconTransformation(extent={{-160,-66},{-140,-46}})));
        Modelica.Blocks.Interfaces.RealInput IN5(start = 0) "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-88},{-140,-68}}),
              iconTransformation(extent={{-160,-88},{-140,-68}})));

        PFData.PowerFlow powerFlow(redeclare record PowerFlow =
              OpenIPSL.Examples.ModelPredictiveControl.PFData.PF16)
          annotation (Placement(transformation(extent={{-68,104},{-48,124}})));
        Electrical.Machines.PSSE.GENCLS IB(
          V_b=220000,
          v_0=powerFlow.powerflow.bus.V4,
          angle_0=powerFlow.powerflow.bus.A4,
          P_0=powerFlow.powerflow.machines.Pinf,
          Q_0=powerFlow.powerflow.machines.Qinf,
          M_b=100000000,
          X_d=1) if not equivalentGRID annotation (Placement(transformation(extent={{110,70},
                  {100,90}})));
        Electrical.Loads.PSSE.Load_ExtInput Load2(
          P_0=powerFlow.powerflow.loads.PL2,
          Q_0=powerFlow.powerflow.loads.QL2,
          v_0=powerFlow.powerflow.bus.V5,
          angle_0=powerFlow.powerflow.bus.A5,
          d_P=0,
          t1=100,
          d_t=1000)
          annotation (Placement(transformation(extent={{100,-30},{120,-10}})));

        inner Modelica.Blocks.Noise.GlobalSeed globalSeed(useAutomaticSeed=false,
            fixedSeed=10000)
          annotation (Placement(transformation(extent={{-42,102},{-22,122}})));

        Electrical.Buses.Bus Bus10(v_0=powerFlow.powerflow.bus.V10, angle_0=powerFlow.powerflow.bus.A10)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,-90})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T4(
          G=0,
          B=0,
          CW=1,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={10,-90})));
        GenerationUnits.PSSE.Solar_Units.SolarMPCLocalVQControl PV(
          V_b=480,
          P_0=powerFlow.powerflow.machines.PPV,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QPV,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V8,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A8,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-60},{-20,-40}})));
        Modelica.Blocks.Math.Add AddU3
          annotation (Placement(transformation(extent={{-80,-60},{-60,-40}})));
        Modelica.Blocks.Sources.Constant IN33(k=0)
          annotation (Placement(transformation(extent={{-108,-62},{-96,-50}})));

        Modelica.Blocks.Math.Add AddU4
          annotation (Placement(transformation(extent={{-80,-90},{-60,-70}})));
        Modelica.Blocks.Math.Add AddU5
          annotation (Placement(transformation(extent={{-80,-116},{-60,-96}})));
        Modelica.Blocks.Sources.Constant IN44(k=0)
          annotation (Placement(transformation(extent={{-108,-92},{-96,-80}})));
        Modelica.Blocks.Sources.Constant IN55(k=0)
          annotation (Placement(transformation(extent={{-108,-118},{-96,-106}})));
        GenerationUnits.PSSE.Battery_Units.BESSMPCLocalVQControlLinearized
                                                                 BESS(
          V_base=480,
          V_b(displayUnit="kV") = 480,
          enableV_b=true,
          P_0=powerFlow.powerflow.machines.PBESS,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QBESS,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V10,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A10,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-100},{-20,-80}})));
        Electrical.Buses.Bus Bus8(v_0=powerFlow.powerflow.bus.V8, angle_0=powerFlow.powerflow.bus.A8)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,-50})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T3(
          G=0,
          B=0,
          CW=1,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={12,-50})));
        Electrical.Buses.Bus Bus11(v_0=powerFlow.powerflow.bus.V11, angle_0=powerFlow.powerflow.bus.A11)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,-90})));
        Electrical.Buses.Bus Bus9(v_0=powerFlow.powerflow.bus.V9, angle_0=powerFlow.powerflow.bus.A9)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,-50})));
        Electrical.Buses.Bus Bus7(v_0=powerFlow.powerflow.bus.V7, angle_0=powerFlow.powerflow.bus.A7)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,10})));
        Electrical.Branches.PwLine          L4(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,6},{
                  50,14}})));
        Electrical.Branches.PwLine          L5(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,-54},
                  {50,-46}})));
        Electrical.Branches.PwLine          L6(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,-94},
                  {50,-86}})));
        Modelica.Blocks.Sources.Sine sine(
          amplitude=0,
          f=1/260,
          phase=3.1415926535898,
          startTime=1000)
          annotation (Placement(transformation(extent={{68,-36},{78,-26}})));
        Electrical.Loads.NoiseInjections.WhiteNoiseInjection whiteNoiseInjection(
            active_sigma=0.0000000001, samplePeriod=0.01)
          annotation (Placement(transformation(extent={{66,-18},{78,-6}})));
        Modelica.Blocks.Math.Add add
          annotation (Placement(transformation(extent={{84,-18},{92,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT1
          annotation (Placement(transformation(extent={{140,70},{160,90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT6
          annotation (Placement(transformation(extent={{140,-30},{160,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT7
          annotation (Placement(transformation(extent={{140,-50},{160,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT8
          annotation (Placement(transformation(extent={{140,-70},{160,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT9
          annotation (Placement(transformation(extent={{140,-90},{160,-70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT10
          annotation (Placement(transformation(extent={{140,-110},{160,-90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT11
          annotation (Placement(transformation(extent={{164,70},{184,90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT12
          annotation (Placement(transformation(extent={{164,50},{184,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT13
          annotation (Placement(transformation(extent={{164,30},{184,50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT14
          annotation (Placement(transformation(extent={{164,10},{184,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT15
          annotation (Placement(transformation(extent={{164,-10},{184,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT16
          annotation (Placement(transformation(extent={{164,-30},{184,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT17
          annotation (Placement(transformation(extent={{164,-50},{184,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT18
          annotation (Placement(transformation(extent={{164,-70},{184,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT19
          annotation (Placement(transformation(extent={{164,-90},{184,-70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT20
          annotation (Placement(transformation(extent={{164,-110},{184,-90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT21
          annotation (Placement(transformation(extent={{184,70},{204,90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT2
          annotation (Placement(transformation(extent={{140,50},{160,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT3
          annotation (Placement(transformation(extent={{140,30},{160,50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT4
          annotation (Placement(transformation(extent={{140,10},{160,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT5
          annotation (Placement(transformation(extent={{140,-10},{160,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT22
          annotation (Placement(transformation(extent={{184,50},{204,70}})));
      equation

      OUT1 = G2.gen.w;
      OUT2 = G2.gen.P;
      OUT3 = G2.gen.Q;
      OUT4 = G2.sEXSMPC.EFD;
      OUT5 = G2.gASTMPC.PMECH;
      OUT6 = G2.gASTMPC.simpleLag1.state;
      OUT7 = Bus6.v;
      OUT8 = Bus6.angle;
      OUT9 = PV.rEGCA1_1.p.ir;
      OUT10 = PV.rEGCA1_1.p.ii;
      OUT11 = PV.rEGCA1_1.Pgen;
      OUT12 = PV.rEGCA1_1.Qgen;
      OUT13 = Bus8.v;
      OUT14 = Bus8.angle;
      OUT15 = BESS.rEGCA1_1.p.ir;
      OUT16 = BESS.rEGCA1_1.p.ii;
      OUT17 = BESS.rEGCA1_1.Pgen;
      OUT18 = BESS.rEGCA1_1.Qgen;
      OUT19 = Bus10.v;
      OUT20 = Bus10.angle;
      OUT21 = Bus5.v;
      OUT22 = Bus5.angle;


      // OUT2 = G2.gen.delta;
      // OUT3 = G2.gen.Epq;
      // OUT4 = G2.gen.PSIkd;
      // OUT5 = G2.gen.PSIppq;
      // OUT6 = G2.sEXSMPC.simpleLagLim.state;
      // OUT7 = G2.sEXSMPC.leadLag.TF.x_scaled[1];
      // OUT8 = G2.gASTMPC.simpleLagLim.state;
      // OUT9 = G2.gASTMPC.simpleLag.state;
      // OUT10 = G2.gASTMPC.simpleLag1.state;
      // OUT11 = PV.rEGCA1_1.simpleLag.state;
      // OUT12 = PV.rEGCA1_1.integrator.y;
      // OUT13 = PV.rEGCA1_1.integrator1.y;
      // OUT14 =PV.EC.IGQ.y;
      // OUT15 =PV.EC.IGV.y;
      // OUT16 =PV.EC.simpleLag.state;
      // OUT17 =PV.EC.simpleLag1.state;
      // OUT18 =PV.EC.simpleLag2.state;
      // OUT19 =PV.EC.IGP.y;
      // OUT20 =PV.EC.simpleLag3.state;
      // OUT21 =PV.EC.simpleLag5.state;
      // OUT22 = PV.EC.simpleLag4.state;
      // OUT23 = BESS.rEGCA1_1.simpleLag.state;
      // OUT24 = BESS.rEGCA1_1.integrator.y;
      // OUT25 = BESS.rEGCA1_1.integrator1.y;
      // OUT26 =BESS.EC.integrator3.y;
      // OUT27 =BESS.EC.simpleLag.state;
      // OUT28 =BESS.EC.IGQ.y;
      // OUT29 =BESS.EC.IGV.y;
      // OUT30 =BESS.EC.IGP.y;
      // OUT31 =BESS.EC.simpleLag1.state;
      // OUT32 =BESS.EC.simpleLag2.state;
      // OUT33 =BESS.EC.simpleLag3.state;
      // OUT34 =BESS.EC.simpleLag4.state;


        connect(T1.p, Bus2.p)
          annotation (Line(points={{-51.2,80},{-40,80}}, color={0,0,255}));
        connect(Bus1.p, T1.n)
          annotation (Line(points={{-80,80},{-68.8,80}}, color={0,0,255}));
        connect(G1.conn, Bus1.p)
          annotation (Line(points={{-91,80},{-80,80}}, color={0,0,255}));
        connect(L1.n, Bus3.p)
          annotation (Line(points={{-14.6,80},{0,80}}, color={0,0,255}));
        connect(L1.p, Bus2.p)
          annotation (Line(points={{-25.4,80},{-40,80}}, color={0,0,255}));
        connect(L2_2.n, Bus4.p) annotation (Line(points={{35.4,70},{44,70},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.n, Bus4.p) annotation (Line(points={{35.4,90},{44,90},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.p, Bus3.p) annotation (Line(points={{24.6,90},{16,90},{16,80},{0,
                80}}, color={0,0,255}));
        connect(L2_2.p, Bus3.p) annotation (Line(points={{24.6,70},{16,70},{16,80},{0,
                80}}, color={0,0,255}));
        connect(Load1.p, Bus3.p)
          annotation (Line(points={{-10,68},{-10,80},{0,80}}, color={0,0,255}));
        connect(L3.p, Bus4.p)
          annotation (Line(points={{80,65.4},{80,80},{60,80}}, color={0,0,255}));
        connect(breaker.s, Bus5.p)
          annotation (Line(points={{80,22},{80,16}},color={0,0,255}));
        connect(breaker.r, L3.n)
          annotation (Line(points={{80,30},{80,54.6}},color={0,0,255}));
        connect(IN11.y, AddU1.u2) annotation (Line(points={{-95.4,4},{-82,4}},
                            color={0,0,127}));
        connect(IN1, AddU1.u1) annotation (Line(points={{-150,10},{-116,10},{-116,16},
                {-82,16}},
                       color={0,0,127}));

        connect(IN22.y,AddU2. u2) annotation (Line(points={{-95.4,-26},{-82,-26}},
                       color={0,0,127}));
        connect(IN2,AddU2. u1) annotation (Line(points={{-150,-12},{-118,-12},{-118,-14},
                {-82,-14}},
                       color={0,0,127}));
        connect(AddU2.y, G2.Efd_ref)
          annotation (Line(points={{-59,-20},{-52,-20},{-52,4},{-42,4}},
                                                                 color={0,0,127}));
        connect(AddU1.y, G2.P_ref1) annotation (Line(points={{-59,10},{-52,10},{-52,16},
                {-42,16}},                          color={0,0,127}));
        connect(IB.p, Bus4.p)
          annotation (Line(points={{100,80},{60,80}}, color={0,0,255}));
        connect(Load2.p, Bus5.p) annotation (Line(points={{110,-10},{110,10},{80,10},{
                80,16}},
                     color={0,0,255}));
        connect(T4.n, Bus10.p)
          annotation (Line(points={{-1,-90},{-10,-90}}, color={0,0,255}));
        connect(Bus6.p, T2.n)
          annotation (Line(points={{-10,10},{-1,10}},
                                                  color={0,0,255}));
        connect(AddU3.y, PV.QINPUT) annotation (Line(points={{-59,-50},{-42,-50}},
                                 color={0,0,127}));
        connect(IN33.y,AddU3. u2)
          annotation (Line(points={{-95.4,-56},{-82,-56}}, color={0,0,127}));
        connect(BESS.p1, Bus10.p)
          annotation (Line(points={{-20,-90},{-10,-90}}, color={0,0,255}));
        connect(BESS.Paux1, AddU4.y) annotation (Line(points={{-42,-84},{-54,-84},{-54,
                -80},{-59,-80}}, color={0,0,127}));
        connect(IN55.y, AddU5.u2)
          annotation (Line(points={{-95.4,-112},{-82,-112}}, color={0,0,127}));
        connect(AddU5.y, BESS.Qext1) annotation (Line(points={{-59,-106},{-52,-106},{-52,
                -96},{-42,-96}},   color={0,0,127}));
        connect(IN44.y, AddU4.u2)
          annotation (Line(points={{-95.4,-86},{-82,-86}}, color={0,0,127}));
        connect(AddU4.u1,IN4)  annotation (Line(points={{-82,-74},{-100,-74},{-100,-70},
                {-116,-70},{-116,-56},{-150,-56}}, color={0,0,127}));
        connect(AddU5.u1,IN5)  annotation (Line(points={{-82,-100},{-116,-100},{-116,-78},
                {-150,-78}}, color={0,0,127}));
        connect(G2.conn, Bus6.p) annotation (Line(points={{-19,10},{-10,10}},
                                           color={0,0,255}));
        connect(AddU3.u1, IN3) annotation (Line(points={{-82,-44},{-118,-44},{-118,-34},
                {-150,-34}}, color={0,0,127}));
        connect(PV.p1, Bus8.p)
          annotation (Line(points={{-20,-50},{-10,-50}}, color={0,0,255}));
        connect(Bus8.p, T3.n)
          annotation (Line(points={{-10,-50},{1,-50}},  color={0,0,255}));
        connect(T2.p, Bus7.p) annotation (Line(points={{21,10},{25.5,10},{25.5,10},{30,
                10}}, color={0,0,255}));
        connect(T3.p, Bus9.p)
          annotation (Line(points={{23,-50},{30,-50}}, color={0,0,255}));
        connect(T4.p, Bus11.p)
          annotation (Line(points={{21,-90},{30,-90}}, color={0,0,255}));
        connect(L4.n, Bus5.p) annotation (Line(points={{49.4,10},{60,10},{60,10},{80,10},
                {80,16}},     color={0,0,255}));
        connect(L5.n, Bus5.p) annotation (Line(points={{49.4,-50},{60,-50},{60,10},{80,
                10},{80,16}}, color={0,0,255}));
        connect(Bus11.p, L6.p)
          annotation (Line(points={{30,-90},{38.6,-90}}, color={0,0,255}));
        connect(Bus9.p, L5.p)
          annotation (Line(points={{30,-50},{38.6,-50}}, color={0,0,255}));
        connect(L6.n, Bus5.p) annotation (Line(points={{49.4,-90},{60,-90},{60,10},{80,
                10},{80,16}}, color={0,0,255}));
        connect(Bus7.p, L4.p) annotation (Line(points={{30,10},{34.3,10},{34.3,10},{38.6,
                10}}, color={0,0,255}));
        connect(sine.y, add.u2) annotation (Line(points={{78.5,-31},{78.5,-16.4},
                {83.2,-16.4}}, color={0,0,127}));
        connect(whiteNoiseInjection.y, add.u1) annotation (Line(points={{78.54,
                -12.06},{80.87,-12.06},{80.87,-11.6},{83.2,-11.6}}, color={0,0,
                127}));
        connect(add.y, Load2.u) annotation (Line(points={{92.4,-14},{97.15,-14},
                {97.15,-14.5},{101.9,-14.5}}, color={0,0,127}));
          annotation (Placement(transformation(extent={{140,-20},{160,0}})),
                      Placement(transformation(extent={{140,-40},{160,-20}})),
                      Placement(transformation(extent={{140,-60},{160,-40}})),
                      Placement(transformation(extent={{140,-80},{160,-60}})),
                     Diagram(coordinateSystem(preserveAspectRatio=false,
                extent={{-140,-140},{140,140}}), graphics={
              Rectangle(
                extent={{-160,30},{-134,-90}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,36},{124,-124}},
                lineColor={238,46,47},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,98},{124,38}},
                lineColor={0,128,255},
                lineThickness=0.5),
              Text(
                extent={{78,-106},{114,-120}},
                textColor={238,46,47},
                textString="Microgrid"),
              Text(
                extent={{76,58},{128,34}},
                textColor={28,108,200},
                textString="Utility Grid"),
              Text(
                extent={{-30,-102},{34,-124}},
                textColor={0,140,72},
                textString="Linearization Unit"),
              Text(
                extent={{-164,50},{-132,30}},
                textColor={0,140,72},
                textString="Inputs"),
              Text(
                extent={{128,118},{168,98}},
                textColor={0,140,72},
                textString="Outputs")}),
          Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),experiment(StopTime=10, __Dymola_Algorithm="Dassl"),
          Icon(coordinateSystem(extent={{-140,-140},{140,140}})));
      end MPCAppliedEnergyLinearized3;

      model MPCAppliedEnergyLinearized3_table
        "THIS ONE IS STABLE, CONTROLLABLE, OBSERVABLE!!!!!!!"
        extends Modelica.Icons.Example;

        parameter Boolean equivalentGRID = true;
        parameter Boolean equivalentsystem = false;

        OpenIPSL.Electrical.Buses.Bus Bus1(v_0=powerFlow.powerflow.bus.V1, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-90,70},{-70,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus2(v_0=powerFlow.powerflow.bus.V2, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-50,70},{-30,90}})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
          R=0.001,
          X=0.2,
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000)  if not equivalentGRID annotation (Placement(transformation(
              extent={{-8,-8},{8,8}},
              rotation=180,
              origin={-60,80})));
        OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
          enableV_b=true,
          v_0=powerFlow.powerflow.bus.V1,
          angle_0=powerFlow.powerflow.bus.A1,
          P_0=powerFlow.powerflow.machines.PG1,
          Q_0=powerFlow.powerflow.machines.QG1,
          V_b=6000)  if not equivalentGRID
          annotation (Placement(transformation(extent={{-112,70},{-92,90}})));
        OpenIPSL.Electrical.Branches.PwLine L1(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{-26,76},
                  {-14,84}})));
        OpenIPSL.Electrical.Buses.Bus Bus3(v_0=powerFlow.powerflow.bus.V3, angle_0=
              powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-10,70},{10,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus4(v_0=powerFlow.powerflow.bus.V4, angle_0=
              powerFlow.powerflow.bus.V4) if not equivalentGRID
          annotation (Placement(transformation(extent={{50,70},{70,90}})));
        OpenIPSL.Electrical.Branches.PwLine L2_1(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,86},
                  {36,94}})));
        OpenIPSL.Electrical.Branches.PwLine L2_2(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,66},
                  {36,74}})));
        OpenIPSL.Electrical.Buses.Bus Bus5(angle_0=powerFlow.powerflow.bus.A5, v_0=
              powerFlow.powerflow.bus.V5)  annotation (Placement(
              transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={80,16})));
        OpenIPSL.Electrical.Branches.PwLine L3(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=-90,
              origin={80,60})));
        OpenIPSL.Electrical.Buses.Bus Bus6(v_0=powerFlow.powerflow.bus.V6, angle_0=
              powerFlow.powerflow.bus.A6) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,10})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000,
          R=0.005,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={10,10})));
        GenerationUnits.PSSE.G2_16MVA                         G2(
          enableV_b=true,
          enableP_0=true,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V6,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A6,
          V_b=6000,
          P_0=powerFlow.powerflow.machines.PG2,
          Q_0=powerFlow.powerflow.machines.QG2,
          enableangle_0=true)
                        annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-30,10})));
        inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000, fn=60)
          annotation (Placement(transformation(extent={{-128,104},{-74,124}})));
        OpenIPSL.Electrical.Loads.PSSE.Load Load1(
          V_b=220000,
          P_0=powerFlow.powerflow.loads.PL1,
          Q_0=powerFlow.powerflow.loads.QL1,
          v_0=powerFlow.powerflow.bus.V3,
          angle_0=powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-20,48},{0,68}})));
        Electrical.Events.Breaker breaker(enableTrigger=false,
          t_o=1.01,
          rc_enabled=true,
          t_rc=10000)       if not equivalentGRID                     annotation (Placement(transformation(
              extent={{-4,-4},{4,4}},
              rotation=90,
              origin={80,26})));

        PFData.PowerFlow powerFlow(redeclare record PowerFlow =
              OpenIPSL.Examples.ModelPredictiveControl.PFData.PF16)
          annotation (Placement(transformation(extent={{-68,104},{-48,124}})));
        Electrical.Machines.PSSE.GENCLS IB(
          V_b=220000,
          v_0=powerFlow.powerflow.bus.V4,
          angle_0=powerFlow.powerflow.bus.A4,
          P_0=powerFlow.powerflow.machines.Pinf,
          Q_0=powerFlow.powerflow.machines.Qinf,
          M_b=100000000,
          X_d=1) if not equivalentGRID annotation (Placement(transformation(extent={{110,70},
                  {100,90}})));
        Electrical.Loads.PSSE.Load_ExtInput Load2(
          P_0=powerFlow.powerflow.loads.PL2,
          Q_0=powerFlow.powerflow.loads.QL2,
          v_0=powerFlow.powerflow.bus.V5,
          angle_0=powerFlow.powerflow.bus.A5,
          d_P=0,
          t1=100,
          d_t=1000)
          annotation (Placement(transformation(extent={{100,-30},{120,-10}})));

        inner Modelica.Blocks.Noise.GlobalSeed globalSeed(useAutomaticSeed=false,
            fixedSeed=10000)
          annotation (Placement(transformation(extent={{-42,102},{-22,122}})));

        Electrical.Buses.Bus Bus10(v_0=powerFlow.powerflow.bus.V10, angle_0=powerFlow.powerflow.bus.A10)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,-90})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T4(
          G=0,
          B=0,
          CW=1,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={10,-90})));
        GenerationUnits.PSSE.Solar_Units.SolarMPCLocalVQControl PV(
          V_b=480,
          P_0=powerFlow.powerflow.machines.PPV,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QPV,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V8,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A8,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-60},{-20,-40}})));

        GenerationUnits.PSSE.Battery_Units.BESSMPCLocalVQControlLinearized
                                                                 BESS(
          V_base=480,
          V_b(displayUnit="kV") = 480,
          enableV_b=true,
          P_0=powerFlow.powerflow.machines.PBESS,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QBESS,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V10,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A10,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-100},{-20,-80}})));
        Electrical.Buses.Bus Bus8(v_0=powerFlow.powerflow.bus.V8, angle_0=powerFlow.powerflow.bus.A8)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,-50})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T3(
          G=0,
          B=0,
          CW=1,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={12,-50})));
        Electrical.Buses.Bus Bus11(v_0=powerFlow.powerflow.bus.V11, angle_0=powerFlow.powerflow.bus.A11)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,-90})));
        Electrical.Buses.Bus Bus9(v_0=powerFlow.powerflow.bus.V9, angle_0=powerFlow.powerflow.bus.A9)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,-50})));
        Electrical.Buses.Bus Bus7(v_0=powerFlow.powerflow.bus.V7, angle_0=powerFlow.powerflow.bus.A7)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,10})));
        Electrical.Branches.PwLine          L4(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,6},{
                  50,14}})));
        Electrical.Branches.PwLine          L5(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,-54},
                  {50,-46}})));
        Electrical.Branches.PwLine          L6(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,-94},
                  {50,-86}})));
        Modelica.Blocks.Sources.Sine sine(
          amplitude=0,
          f=1/260,
          phase=3.1415926535898,
          startTime=1000)
          annotation (Placement(transformation(extent={{68,-36},{78,-26}})));
        Electrical.Loads.NoiseInjections.WhiteNoiseInjection whiteNoiseInjection(
            active_sigma=0.000001,
                               samplePeriod=0.001)
          annotation (Placement(transformation(extent={{66,-18},{78,-6}})));
        Modelica.Blocks.Math.Add add
          annotation (Placement(transformation(extent={{84,-18},{92,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT1
          annotation (Placement(transformation(extent={{140,70},{160,90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT6
          annotation (Placement(transformation(extent={{140,-30},{160,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT7
          annotation (Placement(transformation(extent={{140,-50},{160,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT8
          annotation (Placement(transformation(extent={{140,-70},{160,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT9
          annotation (Placement(transformation(extent={{140,-90},{160,-70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT10
          annotation (Placement(transformation(extent={{140,-110},{160,-90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT11
          annotation (Placement(transformation(extent={{164,70},{184,90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT12
          annotation (Placement(transformation(extent={{164,50},{184,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT13
          annotation (Placement(transformation(extent={{164,30},{184,50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT14
          annotation (Placement(transformation(extent={{164,10},{184,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT15
          annotation (Placement(transformation(extent={{164,-10},{184,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT16
          annotation (Placement(transformation(extent={{164,-30},{184,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT17
          annotation (Placement(transformation(extent={{164,-50},{184,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT18
          annotation (Placement(transformation(extent={{164,-70},{184,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT19
          annotation (Placement(transformation(extent={{164,-90},{184,-70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT20
          annotation (Placement(transformation(extent={{164,-110},{184,-90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT21
          annotation (Placement(transformation(extent={{184,70},{204,90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT22
          annotation (Placement(transformation(extent={{184,50},{204,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT23
          annotation (Placement(transformation(extent={{184,30},{204,50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT24
          annotation (Placement(transformation(extent={{184,10},{204,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT25
          annotation (Placement(transformation(extent={{184,-10},{204,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT26
          annotation (Placement(transformation(extent={{184,-30},{204,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT27
          annotation (Placement(transformation(extent={{184,-50},{204,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT28
          annotation (Placement(transformation(extent={{184,-70},{204,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT29
          annotation (Placement(transformation(extent={{202,-94},{222,-74}})));
        Modelica.Blocks.Interfaces.RealOutput OUT30
          annotation (Placement(transformation(extent={{212,-116},{232,-96}})));
        Modelica.Blocks.Sources.CombiTimeTable combiTimeTable(table=[0,0; 0.5,0; 0.51,
              0.1; 5,0.1], smoothness=Modelica.Blocks.Types.Smoothness.ConstantSegments)
          annotation (Placement(transformation(extent={{-100,6},{-80,26}})));
        Modelica.Blocks.Sources.CombiTimeTable combiTimeTable1(table=[0,0; 0.5,0; 0.51,
              0.1; 5,0.1], smoothness=Modelica.Blocks.Types.Smoothness.ConstantSegments)
          annotation (Placement(transformation(extent={{-100,-20},{-80,0}})));
        Modelica.Blocks.Sources.CombiTimeTable combiTimeTable2(table=[0,0; 0.5,0; 0.51,
              0.1; 5,0.1], smoothness=Modelica.Blocks.Types.Smoothness.ConstantSegments)
          annotation (Placement(transformation(extent={{-100,-48},{-80,-28}})));
        Modelica.Blocks.Sources.CombiTimeTable combiTimeTable3(table=[0,0; 0.5,0; 0.51,
              0.1; 5,0.1], smoothness=Modelica.Blocks.Types.Smoothness.ConstantSegments)
          annotation (Placement(transformation(extent={{-100,-94},{-80,-74}})));
        Modelica.Blocks.Sources.CombiTimeTable combiTimeTable4(table=[0,0; 0.5,0; 0.51,
              0.1; 5,0.1], smoothness=Modelica.Blocks.Types.Smoothness.ConstantSegments)
          annotation (Placement(transformation(extent={{-100,-120},{-80,-100}})));
        Modelica.Blocks.Interfaces.RealOutput OUT31
          annotation (Placement(transformation(extent={{226,-8},{246,12}})));
        Modelica.Blocks.Interfaces.RealOutput OUT32
          annotation (Placement(transformation(extent={{226,-8},{246,12}})));
        Modelica.Blocks.Interfaces.RealOutput OUT33
          annotation (Placement(transformation(extent={{226,-8},{246,12}})));
        Modelica.Blocks.Interfaces.RealOutput OUT34
          annotation (Placement(transformation(extent={{226,-8},{246,12}})));
      equation

      OUT1 = G2.gen.w;
      // OUT2 = G2.gen.delta;
      // OUT3 = G2.gen.Epq;
      // OUT4 = G2.gen.PSIkd;
      // OUT5 = G2.gen.PSIppq;
      OUT6 = G2.sEXSMPC.simpleLagLim.state;
      OUT7 = G2.sEXSMPC.leadLag.TF.x_scaled[1];
      OUT8 = G2.gASTMPC.simpleLagLim.state;
      OUT9 = G2.gASTMPC.simpleLag.state;
      OUT10 = G2.gASTMPC.simpleLag1.state;
      OUT11 = PV.rEGCA1_1.simpleLag.state;
      OUT12 = PV.rEGCA1_1.integrator.y;
      OUT13 = PV.rEGCA1_1.integrator1.y;
      OUT14 =PV.EC.IGQ.y;
      OUT15 =PV.EC.IGV.y;
      OUT16 =PV.EC.simpleLag.state;
      OUT17 =PV.EC.simpleLag1.state;
      OUT18 =PV.EC.simpleLag2.state;
      OUT19 =PV.EC.IGP.y;
      OUT20 =PV.EC.simpleLag3.state;
      OUT21 =PV.EC.simpleLag5.state;
      OUT22 = PV.EC.simpleLag4.state;
      OUT23 = BESS.rEGCA1_1.simpleLag.state;
      OUT24 = BESS.rEGCA1_1.integrator.y;
      OUT25 = BESS.rEGCA1_1.integrator1.y;
      OUT26 =BESS.EC.integrator3.y;
      OUT27 =BESS.EC.simpleLag.state;
      OUT28 =BESS.EC.IGQ.y;
      OUT29 =BESS.EC.IGV.y;
      OUT30 =BESS.EC.IGP.y;
      OUT31 =BESS.EC.simpleLag1.state;
      OUT32 =BESS.EC.simpleLag2.state;
      OUT33 =BESS.EC.simpleLag3.state;
      OUT34 =BESS.EC.simpleLag4.state;


        connect(T1.p, Bus2.p)
          annotation (Line(points={{-51.2,80},{-40,80}}, color={0,0,255}));
        connect(Bus1.p, T1.n)
          annotation (Line(points={{-80,80},{-68.8,80}}, color={0,0,255}));
        connect(G1.conn, Bus1.p)
          annotation (Line(points={{-91,80},{-80,80}}, color={0,0,255}));
        connect(L1.n, Bus3.p)
          annotation (Line(points={{-14.6,80},{0,80}}, color={0,0,255}));
        connect(L1.p, Bus2.p)
          annotation (Line(points={{-25.4,80},{-40,80}}, color={0,0,255}));
        connect(L2_2.n, Bus4.p) annotation (Line(points={{35.4,70},{44,70},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.n, Bus4.p) annotation (Line(points={{35.4,90},{44,90},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.p, Bus3.p) annotation (Line(points={{24.6,90},{16,90},{16,80},{0,
                80}}, color={0,0,255}));
        connect(L2_2.p, Bus3.p) annotation (Line(points={{24.6,70},{16,70},{16,80},{0,
                80}}, color={0,0,255}));
        connect(Load1.p, Bus3.p)
          annotation (Line(points={{-10,68},{-10,80},{0,80}}, color={0,0,255}));
        connect(L3.p, Bus4.p)
          annotation (Line(points={{80,65.4},{80,80},{60,80}}, color={0,0,255}));
        connect(breaker.s, Bus5.p)
          annotation (Line(points={{80,22},{80,16}},color={0,0,255}));
        connect(breaker.r, L3.n)
          annotation (Line(points={{80,30},{80,54.6}},color={0,0,255}));

        connect(IB.p, Bus4.p)
          annotation (Line(points={{100,80},{60,80}}, color={0,0,255}));
        connect(Load2.p, Bus5.p) annotation (Line(points={{110,-10},{110,10},{80,10},{
                80,16}},
                     color={0,0,255}));
        connect(T4.n, Bus10.p)
          annotation (Line(points={{-1,-90},{-10,-90}}, color={0,0,255}));
        connect(Bus6.p, T2.n)
          annotation (Line(points={{-10,10},{-1,10}},
                                                  color={0,0,255}));
        connect(BESS.p1, Bus10.p)
          annotation (Line(points={{-20,-90},{-10,-90}}, color={0,0,255}));
        connect(G2.conn, Bus6.p) annotation (Line(points={{-19,10},{-10,10}},
                                           color={0,0,255}));
        connect(PV.p1, Bus8.p)
          annotation (Line(points={{-20,-50},{-10,-50}}, color={0,0,255}));
        connect(Bus8.p, T3.n)
          annotation (Line(points={{-10,-50},{1,-50}},  color={0,0,255}));
        connect(T2.p, Bus7.p) annotation (Line(points={{21,10},{25.5,10},{25.5,10},{30,
                10}}, color={0,0,255}));
        connect(T3.p, Bus9.p)
          annotation (Line(points={{23,-50},{30,-50}}, color={0,0,255}));
        connect(T4.p, Bus11.p)
          annotation (Line(points={{21,-90},{30,-90}}, color={0,0,255}));
        connect(L4.n, Bus5.p) annotation (Line(points={{49.4,10},{60,10},{60,10},{80,10},
                {80,16}},     color={0,0,255}));
        connect(L5.n, Bus5.p) annotation (Line(points={{49.4,-50},{60,-50},{60,10},{80,
                10},{80,16}}, color={0,0,255}));
        connect(Bus11.p, L6.p)
          annotation (Line(points={{30,-90},{38.6,-90}}, color={0,0,255}));
        connect(Bus9.p, L5.p)
          annotation (Line(points={{30,-50},{38.6,-50}}, color={0,0,255}));
        connect(L6.n, Bus5.p) annotation (Line(points={{49.4,-90},{60,-90},{60,10},{80,
                10},{80,16}}, color={0,0,255}));
        connect(Bus7.p, L4.p) annotation (Line(points={{30,10},{34.3,10},{34.3,10},{38.6,
                10}}, color={0,0,255}));
        connect(sine.y, add.u2) annotation (Line(points={{78.5,-31},{78.5,-16.4},
                {83.2,-16.4}}, color={0,0,127}));
        connect(whiteNoiseInjection.y, add.u1) annotation (Line(points={{78.54,
                -12.06},{80.87,-12.06},{80.87,-11.6},{83.2,-11.6}}, color={0,0,
                127}));
        connect(add.y, Load2.u) annotation (Line(points={{92.4,-14},{97.15,-14},
                {97.15,-14.5},{101.9,-14.5}}, color={0,0,127}));
        connect(combiTimeTable.y[1], G2.P_ref1)
          annotation (Line(points={{-79,16},{-42,16}}, color={0,0,127}));
        connect(combiTimeTable1.y[1], G2.Efd_ref) annotation (Line(points={{-79,-10},{
                -52,-10},{-52,4},{-42,4}}, color={0,0,127}));
        connect(combiTimeTable2.y[1], PV.QINPUT) annotation (Line(points={{-79,-38},{-50,
                -38},{-50,-50},{-42,-50}}, color={0,0,127}));
        connect(combiTimeTable3.y[1], BESS.Paux1)
          annotation (Line(points={{-79,-84},{-42,-84}}, color={0,0,127}));
        connect(combiTimeTable4.y[1], BESS.Qext1) annotation (Line(points={{-79,-110},
                {-52,-110},{-52,-96},{-42,-96}}, color={0,0,127}));
          annotation (Placement(transformation(extent={{140,-20},{160,0}})),
                      Placement(transformation(extent={{140,-40},{160,-20}})),
                      Placement(transformation(extent={{140,-60},{160,-40}})),
                      Placement(transformation(extent={{140,-80},{160,-60}})),
                     Diagram(coordinateSystem(preserveAspectRatio=false,
                extent={{-140,-140},{140,140}}), graphics={
              Rectangle(
                extent={{-128,36},{124,-124}},
                lineColor={238,46,47},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,98},{124,38}},
                lineColor={0,128,255},
                lineThickness=0.5),
              Text(
                extent={{78,-106},{114,-120}},
                textColor={238,46,47},
                textString="Microgrid"),
              Text(
                extent={{76,58},{128,34}},
                textColor={28,108,200},
                textString="Utility Grid"),
              Text(
                extent={{-30,-102},{34,-124}},
                textColor={0,140,72},
                textString="Linearization Unit"),
              Rectangle(
                extent={{130,98},{252,-124}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Text(
                extent={{128,118},{168,98}},
                textColor={0,140,72},
                textString="Outputs")}),
          Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),experiment(
            StopTime=2,
            Interval=0.01,
            __Dymola_Algorithm="Dassl"),
          Icon(coordinateSystem(extent={{-140,-140},{140,140}})));
      end MPCAppliedEnergyLinearized3_table;

      model MPCAppliedEnergyLinearized_WITHOUT_OUTPUTS
        "THIS ONE IS STABLE, CONTROLLABLE, OBSERVABLE!!!!!!!"
        extends Modelica.Icons.Example;

        parameter Boolean equivalentGRID = true;
        parameter Boolean equivalentsystem = false;

        OpenIPSL.Electrical.Buses.Bus Bus1(v_0=powerFlow.powerflow.bus.V1, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-90,70},{-70,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus2(v_0=powerFlow.powerflow.bus.V2, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-50,70},{-30,90}})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
          R=0.001,
          X=0.2,
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000)  if not equivalentGRID annotation (Placement(transformation(
              extent={{-8,-8},{8,8}},
              rotation=180,
              origin={-60,80})));
        OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
          enableV_b=true,
          v_0=powerFlow.powerflow.bus.V1,
          angle_0=powerFlow.powerflow.bus.A1,
          P_0=powerFlow.powerflow.machines.PG1,
          Q_0=powerFlow.powerflow.machines.QG1,
          V_b=6000)  if not equivalentGRID
          annotation (Placement(transformation(extent={{-112,70},{-92,90}})));
        OpenIPSL.Electrical.Branches.PwLine L1(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{-26,76},
                  {-14,84}})));
        OpenIPSL.Electrical.Buses.Bus Bus3(v_0=powerFlow.powerflow.bus.V3, angle_0=
              powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-10,70},{10,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus4(v_0=powerFlow.powerflow.bus.V4, angle_0=
              powerFlow.powerflow.bus.V4) if not equivalentGRID
          annotation (Placement(transformation(extent={{50,70},{70,90}})));
        OpenIPSL.Electrical.Branches.PwLine L2_1(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,86},
                  {36,94}})));
        OpenIPSL.Electrical.Branches.PwLine L2_2(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,66},
                  {36,74}})));
        OpenIPSL.Electrical.Buses.Bus Bus5(angle_0=powerFlow.powerflow.bus.A5, v_0=
              powerFlow.powerflow.bus.V5)  annotation (Placement(
              transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={80,16})));
        OpenIPSL.Electrical.Branches.PwLine L3(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=-90,
              origin={80,60})));
        OpenIPSL.Electrical.Buses.Bus Bus6(v_0=powerFlow.powerflow.bus.V6, angle_0=
              powerFlow.powerflow.bus.A6) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,10})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000,
          R=0.005,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={10,10})));
        GenerationUnits.PSSE.G2_16MVA                         G2(
          enableV_b=true,
          enableP_0=true,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V6,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A6,
          V_b=6000,
          P_0=powerFlow.powerflow.machines.PG2,
          Q_0=powerFlow.powerflow.machines.QG2,
          enableangle_0=true)
                        annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-30,10})));
        inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000, fn=60)
          annotation (Placement(transformation(extent={{-128,104},{-74,124}})));
        OpenIPSL.Electrical.Loads.PSSE.Load Load1(
          V_b=220000,
          P_0=powerFlow.powerflow.loads.PL1,
          Q_0=powerFlow.powerflow.loads.QL1,
          v_0=powerFlow.powerflow.bus.V3,
          angle_0=powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-20,48},{0,68}})));
        Electrical.Events.Breaker breaker(enableTrigger=false,
          t_o=1.01,
          rc_enabled=true,
          t_rc=10000)       if not equivalentGRID                     annotation (Placement(transformation(
              extent={{-4,-4},{4,4}},
              rotation=90,
              origin={80,26})));

        Modelica.Blocks.Interfaces.RealInput IN1(start=0)
          "Connector of Real input signal 2" annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-150,10}),iconTransformation(extent={{-10,-10},{10,10}}, origin={-150,10})));
        Modelica.Blocks.Sources.Constant IN11(k=0)
          annotation (Placement(transformation(extent={{-108,-2},{-96,10}})));
        Modelica.Blocks.Math.Add AddU1
          annotation (Placement(transformation(extent={{-80,0},{-60,20}})));
        Modelica.Blocks.Sources.Constant IN22(k=0)
          annotation (Placement(transformation(extent={{-108,-32},{-96,-20}})));
        Modelica.Blocks.Math.Add AddU2
          annotation (Placement(transformation(extent={{-80,-30},{-60,-10}})));
        Modelica.Blocks.Interfaces.RealInput IN2(start=0)
          "Connector of Real input signal 2"
                 annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-150,-12}), iconTransformation(extent={{-10,-10},{10,10}},
                origin={-150,-12})));

        Modelica.Blocks.Interfaces.RealInput IN3(start = 0) "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-44},{-140,-24}}),
              iconTransformation(extent={{-160,-44},{-140,-24}})));
        Modelica.Blocks.Interfaces.RealInput IN4(start = 0) "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-66},{-140,-46}}),
              iconTransformation(extent={{-160,-66},{-140,-46}})));
        Modelica.Blocks.Interfaces.RealInput IN5(start = 0) "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-88},{-140,-68}}),
              iconTransformation(extent={{-160,-88},{-140,-68}})));

        PFData.PowerFlow powerFlow(redeclare record PowerFlow =
              OpenIPSL.Examples.ModelPredictiveControl.PFData.PF16)
          annotation (Placement(transformation(extent={{-68,104},{-48,124}})));
        Electrical.Machines.PSSE.GENCLS IB(
          V_b=220000,
          v_0=powerFlow.powerflow.bus.V4,
          angle_0=powerFlow.powerflow.bus.A4,
          P_0=powerFlow.powerflow.machines.Pinf,
          Q_0=powerFlow.powerflow.machines.Qinf,
          M_b=100000000,
          X_d=1) if not equivalentGRID annotation (Placement(transformation(extent={{110,70},
                  {100,90}})));
        Electrical.Loads.PSSE.Load_ExtInput Load2(
          P_0=powerFlow.powerflow.loads.PL2,
          Q_0=powerFlow.powerflow.loads.QL2,
          v_0=powerFlow.powerflow.bus.V5,
          angle_0=powerFlow.powerflow.bus.A5,
          d_P=0,
          t1=100,
          d_t=1000)
          annotation (Placement(transformation(extent={{100,-30},{120,-10}})));

        inner Modelica.Blocks.Noise.GlobalSeed globalSeed(useAutomaticSeed=false,
            fixedSeed=10000)
          annotation (Placement(transformation(extent={{-42,102},{-22,122}})));

        Electrical.Buses.Bus Bus10(v_0=powerFlow.powerflow.bus.V10, angle_0=powerFlow.powerflow.bus.A10)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,-90})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T4(
          G=0,
          B=0,
          CW=1,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={10,-90})));
        GenerationUnits.PSSE.Solar_Units.SolarMPCLocalVQControl PV(
          V_b=480,
          P_0=powerFlow.powerflow.machines.PPV,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QPV,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V8,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A8,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-60},{-20,-40}})));
        Modelica.Blocks.Math.Add AddU3
          annotation (Placement(transformation(extent={{-80,-60},{-60,-40}})));
        Modelica.Blocks.Sources.Constant IN33(k=0)
          annotation (Placement(transformation(extent={{-108,-62},{-96,-50}})));

        Modelica.Blocks.Math.Add AddU4
          annotation (Placement(transformation(extent={{-80,-90},{-60,-70}})));
        Modelica.Blocks.Math.Add AddU5
          annotation (Placement(transformation(extent={{-80,-116},{-60,-96}})));
        Modelica.Blocks.Sources.Constant IN44(k=0)
          annotation (Placement(transformation(extent={{-108,-92},{-96,-80}})));
        Modelica.Blocks.Sources.Constant IN55(k=0)
          annotation (Placement(transformation(extent={{-108,-118},{-96,-106}})));
        GenerationUnits.PSSE.Battery_Units.BESSMPCLocalVQControlLinearized
                                                                 BESS(
          V_base=480,
          V_b(displayUnit="kV") = 480,
          enableV_b=true,
          P_0=powerFlow.powerflow.machines.PBESS,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QBESS,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V10,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A10,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-100},{-20,-80}})));
        Electrical.Buses.Bus Bus8(v_0=powerFlow.powerflow.bus.V8, angle_0=powerFlow.powerflow.bus.A8)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,-50})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T3(
          G=0,
          B=0,
          CW=1,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={12,-50})));
        Electrical.Buses.Bus Bus11(v_0=powerFlow.powerflow.bus.V11, angle_0=powerFlow.powerflow.bus.A11)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,-90})));
        Electrical.Buses.Bus Bus9(v_0=powerFlow.powerflow.bus.V9, angle_0=powerFlow.powerflow.bus.A9)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,-50})));
        Electrical.Buses.Bus Bus7(v_0=powerFlow.powerflow.bus.V7, angle_0=powerFlow.powerflow.bus.A7)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,10})));
        Electrical.Branches.PwLine          L4(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,6},{
                  50,14}})));
        Electrical.Branches.PwLine          L5(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,-54},
                  {50,-46}})));
        Electrical.Branches.PwLine          L6(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,-94},
                  {50,-86}})));
        Modelica.Blocks.Sources.Sine sine(
          amplitude=0,
          f=1/260,
          phase=3.1415926535898,
          startTime=1000)
          annotation (Placement(transformation(extent={{68,-36},{78,-26}})));
        Electrical.Loads.NoiseInjections.WhiteNoiseInjection whiteNoiseInjection(
            active_sigma=0.0000000001, samplePeriod=0.01)
          annotation (Placement(transformation(extent={{66,-18},{78,-6}})));
        Modelica.Blocks.Math.Add add
          annotation (Placement(transformation(extent={{84,-18},{92,-10}})));
      equation

      // OUT1 = G2.gen.w;
      // OUT2 = G2.gen.delta;
      // OUT3 = G2.gen.Epq;
      // OUT4 = G2.gen.PSIkd;
      // OUT5 = G2.gen.PSIppq;
      // OUT6 = G2.sEXSMPC.simpleLagLim.state;
      // OUT7 = G2.sEXSMPC.leadLag.TF.x_scaled[1];
      // OUT8 = G2.gASTMPC.simpleLagLim.state;
      // OUT9 = G2.gASTMPC.simpleLag.state;
      // OUT10 = G2.gASTMPC.simpleLag1.state;
      // OUT11 = PV.rEGCA1_1.simpleLag.state;
      // OUT12 = PV.rEGCA1_1.integrator.y;
      // OUT13 = PV.rEGCA1_1.integrator1.y;
      // OUT14 =PV.EC.IGQ.y;
      // OUT15 =PV.EC.IGV.y;
      // OUT16 =PV.EC.simpleLag.state;
      // OUT17 =PV.EC.simpleLag1.state;
      // OUT18 =PV.EC.simpleLag2.state;
      // OUT19 =PV.EC.IGP.y;
      // OUT20 =PV.EC.simpleLag3.state;
      // OUT21 =PV.EC.simpleLag5.state;
      // OUT22 = PV.EC.simpleLag4.state;
      // OUT23 = BESS.rEGCA1_1.simpleLag.state;
      // OUT24 = BESS.rEGCA1_1.integrator.y;
      // OUT25 = BESS.rEGCA1_1.integrator1.y;
      // OUT26 =BESS.EC.integrator3.y;
      // OUT27 =BESS.EC.simpleLag.state;
      // OUT28 =BESS.EC.IGQ.y;
      // OUT29 =BESS.EC.IGV.y;
      // OUT30 =BESS.EC.IGP.y;
      // OUT31 =BESS.EC.simpleLag1.state;
      // OUT32 =BESS.EC.simpleLag2.state;
      // OUT33 =BESS.EC.simpleLag3.state;
      // OUT34 =BESS.EC.simpleLag4.state;
      // OUT35 = G2.gen.PMECH;
      // OUT36 = G2.sEXSMPC.EFD;
      // OUT37 = BESS.rEGCA1_1.Pgen;
      // OUT38 = BESS.rEGCA1_1.Qgen;
      // OUT39 = PV.rEGCA1_1.Pgen;
      // OUT40 = PV.rEGCA1_1.Qgen;
      // OUT41 = Bus5.v;
      // OUT42 = Bus5.angle;

        connect(T1.p, Bus2.p)
          annotation (Line(points={{-51.2,80},{-40,80}}, color={0,0,255}));
        connect(Bus1.p, T1.n)
          annotation (Line(points={{-80,80},{-68.8,80}}, color={0,0,255}));
        connect(G1.conn, Bus1.p)
          annotation (Line(points={{-91,80},{-80,80}}, color={0,0,255}));
        connect(L1.n, Bus3.p)
          annotation (Line(points={{-14.6,80},{0,80}}, color={0,0,255}));
        connect(L1.p, Bus2.p)
          annotation (Line(points={{-25.4,80},{-40,80}}, color={0,0,255}));
        connect(L2_2.n, Bus4.p) annotation (Line(points={{35.4,70},{44,70},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.n, Bus4.p) annotation (Line(points={{35.4,90},{44,90},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.p, Bus3.p) annotation (Line(points={{24.6,90},{16,90},{16,80},{0,
                80}}, color={0,0,255}));
        connect(L2_2.p, Bus3.p) annotation (Line(points={{24.6,70},{16,70},{16,80},{0,
                80}}, color={0,0,255}));
        connect(Load1.p, Bus3.p)
          annotation (Line(points={{-10,68},{-10,80},{0,80}}, color={0,0,255}));
        connect(L3.p, Bus4.p)
          annotation (Line(points={{80,65.4},{80,80},{60,80}}, color={0,0,255}));
        connect(breaker.s, Bus5.p)
          annotation (Line(points={{80,22},{80,16}},color={0,0,255}));
        connect(breaker.r, L3.n)
          annotation (Line(points={{80,30},{80,54.6}},color={0,0,255}));
        connect(IN11.y, AddU1.u2) annotation (Line(points={{-95.4,4},{-82,4}},
                            color={0,0,127}));
        connect(IN1, AddU1.u1) annotation (Line(points={{-150,10},{-116,10},{-116,16},
                {-82,16}},
                       color={0,0,127}));

        connect(IN22.y,AddU2. u2) annotation (Line(points={{-95.4,-26},{-82,-26}},
                       color={0,0,127}));
        connect(IN2,AddU2. u1) annotation (Line(points={{-150,-12},{-118,-12},{-118,-14},
                {-82,-14}},
                       color={0,0,127}));
        connect(AddU2.y, G2.Efd_ref)
          annotation (Line(points={{-59,-20},{-52,-20},{-52,4},{-42,4}},
                                                                 color={0,0,127}));
        connect(AddU1.y, G2.P_ref1) annotation (Line(points={{-59,10},{-52,10},{-52,16},
                {-42,16}},                          color={0,0,127}));
        connect(IB.p, Bus4.p)
          annotation (Line(points={{100,80},{60,80}}, color={0,0,255}));
        connect(Load2.p, Bus5.p) annotation (Line(points={{110,-10},{110,10},{80,10},{
                80,16}},
                     color={0,0,255}));
        connect(T4.n, Bus10.p)
          annotation (Line(points={{-1,-90},{-10,-90}}, color={0,0,255}));
        connect(Bus6.p, T2.n)
          annotation (Line(points={{-10,10},{-1,10}},
                                                  color={0,0,255}));
        connect(AddU3.y, PV.QINPUT) annotation (Line(points={{-59,-50},{-42,-50}},
                                 color={0,0,127}));
        connect(IN33.y,AddU3. u2)
          annotation (Line(points={{-95.4,-56},{-82,-56}}, color={0,0,127}));
        connect(BESS.p1, Bus10.p)
          annotation (Line(points={{-20,-90},{-10,-90}}, color={0,0,255}));
        connect(BESS.Paux1, AddU4.y) annotation (Line(points={{-42,-84},{-54,-84},{-54,
                -80},{-59,-80}}, color={0,0,127}));
        connect(IN55.y, AddU5.u2)
          annotation (Line(points={{-95.4,-112},{-82,-112}}, color={0,0,127}));
        connect(AddU5.y, BESS.Qext1) annotation (Line(points={{-59,-106},{-52,-106},{-52,
                -96},{-42,-96}},   color={0,0,127}));
        connect(IN44.y, AddU4.u2)
          annotation (Line(points={{-95.4,-86},{-82,-86}}, color={0,0,127}));
        connect(AddU4.u1,IN4)  annotation (Line(points={{-82,-74},{-100,-74},{-100,-70},
                {-116,-70},{-116,-56},{-150,-56}}, color={0,0,127}));
        connect(AddU5.u1,IN5)  annotation (Line(points={{-82,-100},{-116,-100},{-116,-78},
                {-150,-78}}, color={0,0,127}));
        connect(G2.conn, Bus6.p) annotation (Line(points={{-19,10},{-10,10}},
                                           color={0,0,255}));
        connect(AddU3.u1, IN3) annotation (Line(points={{-82,-44},{-118,-44},{-118,-34},
                {-150,-34}}, color={0,0,127}));
        connect(PV.p1, Bus8.p)
          annotation (Line(points={{-20,-50},{-10,-50}}, color={0,0,255}));
        connect(Bus8.p, T3.n)
          annotation (Line(points={{-10,-50},{1,-50}},  color={0,0,255}));
        connect(T2.p, Bus7.p) annotation (Line(points={{21,10},{25.5,10},{25.5,10},{30,
                10}}, color={0,0,255}));
        connect(T3.p, Bus9.p)
          annotation (Line(points={{23,-50},{30,-50}}, color={0,0,255}));
        connect(T4.p, Bus11.p)
          annotation (Line(points={{21,-90},{30,-90}}, color={0,0,255}));
        connect(L4.n, Bus5.p) annotation (Line(points={{49.4,10},{60,10},{60,10},{80,10},
                {80,16}},     color={0,0,255}));
        connect(L5.n, Bus5.p) annotation (Line(points={{49.4,-50},{60,-50},{60,10},{80,
                10},{80,16}}, color={0,0,255}));
        connect(Bus11.p, L6.p)
          annotation (Line(points={{30,-90},{38.6,-90}}, color={0,0,255}));
        connect(Bus9.p, L5.p)
          annotation (Line(points={{30,-50},{38.6,-50}}, color={0,0,255}));
        connect(L6.n, Bus5.p) annotation (Line(points={{49.4,-90},{60,-90},{60,10},{80,
                10},{80,16}}, color={0,0,255}));
        connect(Bus7.p, L4.p) annotation (Line(points={{30,10},{34.3,10},{34.3,10},{38.6,
                10}}, color={0,0,255}));
        connect(sine.y, add.u2) annotation (Line(points={{78.5,-31},{78.5,-16.4},
                {83.2,-16.4}}, color={0,0,127}));
        connect(whiteNoiseInjection.y, add.u1) annotation (Line(points={{78.54,
                -12.06},{80.87,-12.06},{80.87,-11.6},{83.2,-11.6}}, color={0,0,
                127}));
        connect(add.y, Load2.u) annotation (Line(points={{92.4,-14},{97.15,-14},
                {97.15,-14.5},{101.9,-14.5}}, color={0,0,127}));
          annotation (Placement(transformation(extent={{140,-20},{160,0}})),
                      Placement(transformation(extent={{140,-40},{160,-20}})),
                      Placement(transformation(extent={{140,-60},{160,-40}})),
                      Placement(transformation(extent={{140,-80},{160,-60}})),
                     Diagram(coordinateSystem(preserveAspectRatio=false,
                extent={{-140,-140},{140,140}}), graphics={
              Rectangle(
                extent={{-160,30},{-134,-90}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,36},{124,-124}},
                lineColor={238,46,47},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,98},{124,38}},
                lineColor={0,128,255},
                lineThickness=0.5),
              Text(
                extent={{78,-106},{114,-120}},
                textColor={238,46,47},
                textString="Microgrid"),
              Text(
                extent={{76,58},{128,34}},
                textColor={28,108,200},
                textString="Utility Grid"),
              Text(
                extent={{-30,-102},{34,-124}},
                textColor={0,140,72},
                textString="Linearization Unit"),
              Text(
                extent={{-164,50},{-132,30}},
                textColor={0,140,72},
                textString="Inputs")}),
          Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),experiment(StopTime=10, __Dymola_Algorithm="Dassl"),
          Icon(coordinateSystem(extent={{-140,-140},{140,140}})));
      end MPCAppliedEnergyLinearized_WITHOUT_OUTPUTS;

      model Caceta

        GenerationUnits.PSSE.Solar_Units.SolarMPCLocalVQControl_OBSERVABILITY
                                                                PV(
          V_b=480,
          P_0=powerFlow.powerflow.machines.PPV,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QPV,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V8,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A8,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-10,-10},{10,10}})));
        Modelica.Blocks.Interfaces.RealInput QINPUT1
                                                    "Reactive Power Reference"
          annotation (Placement(transformation(extent={{-140,-20},{-100,20}})));
        OpenIPSL.Electrical.Buses.Bus
                             Bus8(v_0=powerFlow.powerflow.bus.V8, angle_0=powerFlow.powerflow.bus.A8)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={20,0})));
        OpenIPSL.Examples.ModelPredictiveControl.PFData.PowerFlow
                         powerFlow(redeclare record PowerFlow =
              OpenIPSL.Examples.ModelPredictiveControl.PFData.PF16)
          annotation (Placement(transformation(extent={{-60,72},{-40,92}})));
        OpenIPSL.Electrical.Loads.PSSE.Load Load2(
          P_0=powerFlow.powerflow.machines.PPV,
          Q_0=powerFlow.powerflow.machines.PPV,
          v_0=powerFlow.powerflow.bus.V8,
          angle_0=powerFlow.powerflow.bus.A8)
          annotation (Placement(transformation(extent={{40,-40},{60,-20}})));

        Modelica.Blocks.Sources.Constant IN11(k=0)
          annotation (Placement(transformation(extent={{-82,-36},{-70,-24}})));
        Modelica.Blocks.Math.Add AddU1
          annotation (Placement(transformation(extent={{-48,-10},{-28,10}})));
        Modelica.Blocks.Interfaces.RealOutput VT_STATE1
          annotation (Placement(transformation(extent={{-30,-30},{-10,-10}})));
        Modelica.Blocks.Interfaces.RealOutput PE_STATE1
          annotation (Placement(transformation(extent={{-42,-50},{-22,-30}})));
        Modelica.Blocks.Interfaces.RealOutput QGEN_STATE1
          annotation (Placement(transformation(extent={{-22,-66},{-2,-46}})));
        Modelica.Blocks.Interfaces.RealOutput PI2_DELAY_STATE1
          annotation (Placement(transformation(extent={{0,-70},{20,-50}})));
        Modelica.Blocks.Interfaces.RealOutput PI_STATE1
          annotation (Placement(transformation(extent={{-2,-46},{18,-26}})));
        Modelica.Blocks.Interfaces.RealOutput PI1_STATE1
          annotation (Placement(transformation(extent={{20,-26},{40,-6}})));
        Modelica.Blocks.Interfaces.RealOutput PI2_STATE1
          annotation (Placement(transformation(extent={{26,-38},{46,-18}})));
        Modelica.Blocks.Interfaces.RealOutput SIMPLELAG_STATE1
          annotation (Placement(transformation(extent={{30,14},{50,34}})));
        Modelica.Blocks.Interfaces.RealOutput SIMPLELAG1_STATE1
          annotation (Placement(transformation(extent={{32,4},{52,24}})));
        Modelica.Blocks.Interfaces.RealOutput SIMPLELAG2_STATE1
          annotation (Placement(transformation(extent={{66,0},{86,20}})));
      equation

      // OUT1 = PV.rEGCA1_1.simpleLag.state;
      // OUT2 = PV.rEGCA1_1.integrator.y;
      // OUT3 = PV.rEGCA1_1.integrator1.y;
      // OUT4 =PV.EC.IGQ.y;
      // OUT5 =PV.EC.IGV.y;
      // OUT6 =PV.EC.simpleLag.state;
      // OUT7 =PV.EC.simpleLag1.state;
      // OUT8 =PV.EC.simpleLag2.state;
      // OUT9 =PV.EC.IGP.y;
      // OUT10 =PV.EC.simpleLag3.state;
      // OUT11 =PV.EC.simpleLag5.state;
      // OUT12 =PV.EC.simpleLag4.state;
        connect(PV.p1, Bus8.p) annotation (Line(points={{10,0},{15,0},{15,-5.55112e-16},
                {20,-5.55112e-16}}, color={0,0,255}));
        connect(Load2.p, Bus8.p)
          annotation (Line(points={{50,-20},{50,0},{20,0}}, color={0,0,255}));
        connect(QINPUT1, AddU1.u1) annotation (Line(points={{-120,0},{-60,0},{-60,6},{
                -50,6}}, color={0,0,127}));
        connect(IN11.y, AddU1.u2) annotation (Line(points={{-69.4,-30},{-60,-30},{-60,
                -6},{-50,-6}}, color={0,0,127}));
        connect(AddU1.y, PV.QINPUT)
          annotation (Line(points={{-27,0},{-12,0}}, color={0,0,127}));
        connect(PV.VT_STATE1, VT_STATE1) annotation (Line(points={{-6,-11},{-14,
                -11},{-14,-20},{-20,-20}}, color={0,0,127}));
        connect(PV.PE_STATE1, PE_STATE1) annotation (Line(points={{-4,-11},{-4,
                -40},{-32,-40}}, color={0,0,127}));
        connect(PV.QGEN_STATE1, QGEN_STATE1) annotation (Line(points={{-2,-11},
                {-2,-20},{26,-20},{26,-56},{-12,-56}}, color={0,0,127}));
        connect(PV.PI2_DELAY_STATE1, PI2_DELAY_STATE1) annotation (Line(points=
                {{0,-11},{0,-18},{28,-18},{28,-60},{10,-60}}, color={0,0,127}));
        connect(PV.PI_STATE1, PI_STATE1) annotation (Line(points={{2,-11},{6,
                -11},{6,-36},{8,-36}}, color={0,0,127}));
        connect(PV.PI1_STATE1, PI1_STATE1) annotation (Line(points={{4,-11},{18,
                -11},{18,-16},{30,-16}}, color={0,0,127}));
        connect(PV.PI2_STATE1, PI2_STATE1) annotation (Line(points={{6,-11},{22,
                -11},{22,-28},{36,-28}}, color={0,0,127}));
        connect(PV.SIMPLELAG_STATE1, SIMPLELAG_STATE1) annotation (Line(points=
                {{11,-4},{26,-4},{26,24},{40,24}}, color={0,0,127}));
        connect(PV.SIMPLELAG1_STATE1, SIMPLELAG1_STATE1) annotation (Line(
              points={{11,-6},{26,-6},{26,14},{42,14}}, color={0,0,127}));
        connect(PV.SIMPLELAG2_STATE1, SIMPLELAG2_STATE1) annotation (Line(
              points={{11,-7.6},{43.5,-7.6},{43.5,10},{76,10}}, color={0,0,127}));
        annotation (experiment(__Dymola_Algorithm="Dassl"));
      end Caceta;

      model Caceta2

        OpenIPSL.Examples.ModelPredictiveControl.GenerationUnits.PSSE.Solar_Units.SolarMPCLocalVQControl
                                                                PV(
          V_b=480,
          P_0=powerFlow.powerflow.machines.PPV,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QPV,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V8,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A8,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-10,-10},{10,10}})));
        Modelica.Blocks.Interfaces.RealInput QINPUT1
                                                    "Reactive Power Reference"
          annotation (Placement(transformation(extent={{-140,-20},{-100,20}})));
        OpenIPSL.Electrical.Buses.Bus
                             Bus8(v_0=powerFlow.powerflow.bus.V8, angle_0=powerFlow.powerflow.bus.A8)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={20,0})));
        OpenIPSL.Examples.ModelPredictiveControl.PFData.PowerFlow
                         powerFlow(redeclare record PowerFlow =
              OpenIPSL.Examples.ModelPredictiveControl.PFData.PF16)
          annotation (Placement(transformation(extent={{-60,72},{-40,92}})));
        OpenIPSL.Electrical.Loads.PSSE.Load Load2(
          P_0=powerFlow.powerflow.machines.PPV,
          Q_0=powerFlow.powerflow.machines.QPV,
          v_0=powerFlow.powerflow.bus.V8,
          angle_0=powerFlow.powerflow.bus.A8)
          annotation (Placement(transformation(extent={{40,-40},{60,-20}})));

        Modelica.Blocks.Interfaces.RealOutput OUT1
          annotation (Placement(transformation(extent={{76,80},{96,100}})));
       Modelica.Blocks.Interfaces.RealOutput OUT2
          annotation (Placement(transformation(extent={{76,60},{96,80}})));
        Modelica.Blocks.Interfaces.RealOutput OUT3
          annotation (Placement(transformation(extent={{76,40},{96,60}})));
        Modelica.Blocks.Interfaces.RealOutput OUT4
          annotation (Placement(transformation(extent={{76,20},{96,40}})));
        Modelica.Blocks.Interfaces.RealOutput OUT5
          annotation (Placement(transformation(extent={{76,0},{96,20}})));
        Modelica.Blocks.Interfaces.RealOutput OUT6
          annotation (Placement(transformation(extent={{76,-20},{96,0}})));
        Modelica.Blocks.Interfaces.RealOutput OUT7
          annotation (Placement(transformation(extent={{76,-40},{96,-20}})));
        Modelica.Blocks.Interfaces.RealOutput OUT8
          annotation (Placement(transformation(extent={{76,-60},{96,-40}})));
        Modelica.Blocks.Interfaces.RealOutput OUT9
          annotation (Placement(transformation(extent={{76,-80},{96,-60}})));
        Modelica.Blocks.Interfaces.RealOutput OUT10
          annotation (Placement(transformation(extent={{76,-100},{96,-80}})));
        Modelica.Blocks.Interfaces.RealOutput OUT11
          annotation (Placement(transformation(extent={{100,80},{120,100}})));
        Modelica.Blocks.Interfaces.RealOutput OUT12
          annotation (Placement(transformation(extent={{100,60},{120,80}})));
        Modelica.Blocks.Sources.Constant IN11(k=0)
          annotation (Placement(transformation(extent={{-82,-36},{-70,-24}})));
        Modelica.Blocks.Math.Add AddU1
          annotation (Placement(transformation(extent={{-48,-10},{-28,10}})));
      equation

      OUT1 = PV.rEGCA1_1.simpleLag.state;
      OUT2 = PV.rEGCA1_1.integrator.y;
      OUT3 = PV.rEGCA1_1.integrator1.y;
      OUT4 =PV.EC.IGQ.y;
      OUT5 =PV.EC.IGV.y;
      OUT6 =PV.EC.simpleLag.state;
      OUT7 =PV.EC.simpleLag1.state;
      OUT8 =PV.EC.simpleLag2.state;
      OUT9 =PV.EC.IGP.y;
      OUT10 =PV.EC.simpleLag3.state;
      OUT11 =PV.EC.simpleLag5.state;
      OUT12 =PV.EC.simpleLag4.state;
        connect(PV.p1, Bus8.p) annotation (Line(points={{10,0},{15,0},{15,-5.55112e-16},
                {20,-5.55112e-16}}, color={0,0,255}));
        connect(Load2.p, Bus8.p)
          annotation (Line(points={{50,-20},{50,0},{20,0}}, color={0,0,255}));
        connect(QINPUT1, AddU1.u1) annotation (Line(points={{-120,0},{-60,0},{-60,6},{
                -50,6}}, color={0,0,127}));
        connect(IN11.y, AddU1.u2) annotation (Line(points={{-69.4,-30},{-60,-30},{-60,
                -6},{-50,-6}}, color={0,0,127}));
        connect(AddU1.y, PV.QINPUT)
          annotation (Line(points={{-27,0},{-12,0}}, color={0,0,127}));
      end Caceta2;

      model Caceta3

        OpenIPSL.Examples.ModelPredictiveControl.PFData.PowerFlow
                         powerFlow(redeclare record PowerFlow =
              OpenIPSL.Examples.ModelPredictiveControl.PFData.PF16)
          annotation (Placement(transformation(extent={{-60,72},{-40,92}})));

        Electrical.Buses.Bus          Bus5(angle_0=powerFlow.powerflow.bus.A5, v_0=
              powerFlow.powerflow.bus.V5)  annotation (Placement(
              transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={76,44})));
        Electrical.Buses.Bus          Bus6(v_0=powerFlow.powerflow.bus.V6, angle_0=
              powerFlow.powerflow.bus.A6) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-14,38})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T2(
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000,
          R=0.005,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={6,38})));
        GenerationUnits.PSSE.G2_16MVA                         G2(
          enableV_b=true,
          enableP_0=true,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V6,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A6,
          V_b=6000,
          P_0=powerFlow.powerflow.machines.PG2,
          Q_0=powerFlow.powerflow.machines.QG2,
          enableangle_0=true)
                        annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-34,38})));
        Modelica.Blocks.Sources.Constant IN11(k=0)
          annotation (Placement(transformation(extent={{-112,26},{-100,38}})));
        Modelica.Blocks.Math.Add AddU1
          annotation (Placement(transformation(extent={{-84,28},{-64,48}})));
        Modelica.Blocks.Sources.Constant IN22(k=0)
          annotation (Placement(transformation(extent={{-112,-4},{-100,8}})));
        Modelica.Blocks.Math.Add AddU2
          annotation (Placement(transformation(extent={{-84,-2},{-64,18}})));
        Electrical.Loads.PSSE.Load_ExtInput Load2(
          P_0=powerFlow.powerflow.loads.PL2,
          Q_0=powerFlow.powerflow.loads.QL2,
          v_0=powerFlow.powerflow.bus.V5,
          angle_0=powerFlow.powerflow.bus.A5,
          d_P=0,
          t1=100,
          d_t=1000)
          annotation (Placement(transformation(extent={{96,-2},{116,18}})));
        Electrical.Buses.Bus Bus10(v_0=powerFlow.powerflow.bus.V10, angle_0=powerFlow.powerflow.bus.A10)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-14,-62})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T4(
          G=0,
          B=0,
          CW=1,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={6,-62})));
        GenerationUnits.PSSE.Solar_Units.SolarMPCLocalVQControl PV(
          V_b=480,
          P_0=powerFlow.powerflow.machines.PPV,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QPV,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V8,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A8,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-44,-32},{-24,-12}})));
        Modelica.Blocks.Math.Add AddU3
          annotation (Placement(transformation(extent={{-84,-32},{-64,-12}})));
        Modelica.Blocks.Sources.Constant IN33(k=0)
          annotation (Placement(transformation(extent={{-112,-34},{-100,-22}})));
        Modelica.Blocks.Math.Add AddU4
          annotation (Placement(transformation(extent={{-84,-62},{-64,-42}})));
        Modelica.Blocks.Math.Add AddU5
          annotation (Placement(transformation(extent={{-84,-88},{-64,-68}})));
        Modelica.Blocks.Sources.Constant IN44(k=0)
          annotation (Placement(transformation(extent={{-112,-64},{-100,-52}})));
        Modelica.Blocks.Sources.Constant IN55(k=0)
          annotation (Placement(transformation(extent={{-112,-90},{-100,-78}})));
        GenerationUnits.PSSE.Battery_Units.BESSMPCLocalVQControlLinearized
                                                                 BESS(
          V_base=480,
          V_b(displayUnit="kV") = 480,
          enableV_b=true,
          P_0=powerFlow.powerflow.machines.PBESS,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QBESS,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V10,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A10,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-44,-72},{-24,-52}})));
        Electrical.Buses.Bus Bus8(v_0=powerFlow.powerflow.bus.V8, angle_0=powerFlow.powerflow.bus.A8)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-14,-22})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T3(
          G=0,
          B=0,
          CW=1,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={8,-22})));
        Electrical.Buses.Bus Bus11(v_0=powerFlow.powerflow.bus.V11, angle_0=powerFlow.powerflow.bus.A11)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={26,-62})));
        Electrical.Buses.Bus Bus9(v_0=powerFlow.powerflow.bus.V9, angle_0=powerFlow.powerflow.bus.A9)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={26,-22})));
        Electrical.Buses.Bus Bus7(v_0=powerFlow.powerflow.bus.V7, angle_0=powerFlow.powerflow.bus.A7)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={26,38})));
        Electrical.Branches.PwLine          L4(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{34,34},{46,42}})));
        Electrical.Branches.PwLine          L5(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{34,-26},{46,-18}})));
        Electrical.Branches.PwLine          L6(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{34,-66},{46,-58}})));
        Modelica.Blocks.Sources.Sine sine(
          amplitude=0,
          f=1/260,
          phase=3.1415926535898,
          startTime=1000)
          annotation (Placement(transformation(extent={{64,-8},{74,2}})));
        Electrical.Loads.NoiseInjections.WhiteNoiseInjection whiteNoiseInjection(
            active_sigma=0.0000000001, samplePeriod=0.01)
          annotation (Placement(transformation(extent={{62,10},{74,22}})));
        Modelica.Blocks.Math.Add add
          annotation (Placement(transformation(extent={{80,10},{88,18}})));
        Modelica.Blocks.Interfaces.RealInput IN1(start=0)
          "Connector of Real input signal 2" annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-154,38}),iconTransformation(extent={{-10,-10},{10,10}}, origin={-150,10})));
        Modelica.Blocks.Interfaces.RealInput IN2(start=0)
          "Connector of Real input signal 2"
                 annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-154,16}),  iconTransformation(extent={{-10,-10},{10,10}},
                origin={-150,-12})));
        Modelica.Blocks.Interfaces.RealInput IN3(start=0)   "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-164,-16},{-144,4}}),
              iconTransformation(extent={{-160,-44},{-140,-24}})));
        Modelica.Blocks.Interfaces.RealInput IN4(start=0)   "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-164,-38},{-144,-18}}),
              iconTransformation(extent={{-160,-66},{-140,-46}})));
        Modelica.Blocks.Interfaces.RealInput IN5(start=0)   "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-164,-60},{-144,-40}}),
              iconTransformation(extent={{-160,-88},{-140,-68}})));
        Electrical.Loads.PSSE.Load          Load1(
          P_0=-3004660,
          Q_0=-548994,
          v_0=powerFlow.powerflow.bus.V5,
          angle_0=powerFlow.powerflow.bus.A5)
          annotation (Placement(transformation(extent={{-10,-10},{10,10}},
              rotation=180,
              origin={76,72})));
        Modelica.Blocks.Interfaces.RealOutput OUT1
          annotation (Placement(transformation(extent={{130,78},{150,98}})));
      //   Modelica.Blocks.Interfaces.RealOutput OUT2 annotation (Placement(transformation(extent={{128,26},{148,46}})));
        Modelica.Blocks.Interfaces.RealOutput OUT3
          annotation (Placement(transformation(extent={{128,26},{148,46}})));
        Modelica.Blocks.Interfaces.RealOutput OUT4
          annotation (Placement(transformation(extent={{152,-2},{172,18}})));
        Modelica.Blocks.Interfaces.RealOutput OUT5
          annotation (Placement(transformation(extent={{152,2},{172,22}})));

        Modelica.Blocks.Interfaces.RealOutput OUT6
          annotation (Placement(transformation(extent={{130,-22},{150,-2}})));
        Modelica.Blocks.Interfaces.RealOutput OUT7
          annotation (Placement(transformation(extent={{130,-42},{150,-22}})));
        Modelica.Blocks.Interfaces.RealOutput OUT8
          annotation (Placement(transformation(extent={{130,-62},{150,-42}})));
        Modelica.Blocks.Interfaces.RealOutput OUT9
          annotation (Placement(transformation(extent={{130,-82},{150,-62}})));
        Modelica.Blocks.Interfaces.RealOutput OUT10
          annotation (Placement(transformation(extent={{130,-102},{150,-82}})));
        Modelica.Blocks.Interfaces.RealOutput OUT11
          annotation (Placement(transformation(extent={{154,78},{174,98}})));
        Modelica.Blocks.Interfaces.RealOutput OUT12
          annotation (Placement(transformation(extent={{154,58},{174,78}})));
        Modelica.Blocks.Interfaces.RealOutput OUT13
          annotation (Placement(transformation(extent={{154,38},{174,58}})));
        Modelica.Blocks.Interfaces.RealOutput OUT14
          annotation (Placement(transformation(extent={{154,18},{174,38}})));
        Modelica.Blocks.Interfaces.RealOutput OUT15
          annotation (Placement(transformation(extent={{154,-2},{174,18}})));
        Modelica.Blocks.Interfaces.RealOutput OUT16
          annotation (Placement(transformation(extent={{154,-22},{174,-2}})));
        Modelica.Blocks.Interfaces.RealOutput OUT17
          annotation (Placement(transformation(extent={{154,-42},{174,-22}})));
        Modelica.Blocks.Interfaces.RealOutput OUT18
          annotation (Placement(transformation(extent={{154,-62},{174,-42}})));
        Modelica.Blocks.Interfaces.RealOutput OUT19
          annotation (Placement(transformation(extent={{154,-82},{174,-62}})));
        Modelica.Blocks.Interfaces.RealOutput OUT20
          annotation (Placement(transformation(extent={{154,-102},{174,-82}})));
        Modelica.Blocks.Interfaces.RealOutput OUT21
          annotation (Placement(transformation(extent={{174,78},{194,98}})));
        Modelica.Blocks.Interfaces.RealOutput OUT22
          annotation (Placement(transformation(extent={{174,58},{194,78}})));
        Modelica.Blocks.Interfaces.RealOutput OUT23
          annotation (Placement(transformation(extent={{174,38},{194,58}})));
        Modelica.Blocks.Interfaces.RealOutput OUT24
          annotation (Placement(transformation(extent={{174,18},{194,38}})));
        Modelica.Blocks.Interfaces.RealOutput OUT25
          annotation (Placement(transformation(extent={{174,-2},{194,18}})));
        Modelica.Blocks.Interfaces.RealOutput OUT26
          annotation (Placement(transformation(extent={{174,-22},{194,-2}})));
        Modelica.Blocks.Interfaces.RealOutput OUT27
          annotation (Placement(transformation(extent={{174,-42},{194,-22}})));
        Modelica.Blocks.Interfaces.RealOutput OUT28
          annotation (Placement(transformation(extent={{174,-62},{194,-42}})));
        Modelica.Blocks.Interfaces.RealOutput OUT29
          annotation (Placement(transformation(extent={{174,-82},{194,-62}})));
        Modelica.Blocks.Interfaces.RealOutput OUT30
          annotation (Placement(transformation(extent={{174,-102},{194,-82}})));
        Modelica.Blocks.Interfaces.RealOutput OUT31
          annotation (Placement(transformation(extent={{194,78},{214,98}})));
        Modelica.Blocks.Interfaces.RealOutput OUT32
          annotation (Placement(transformation(extent={{194,58},{214,78}})));
        Modelica.Blocks.Interfaces.RealOutput OUT33
          annotation (Placement(transformation(extent={{194,38},{214,58}})));
        Modelica.Blocks.Interfaces.RealOutput OUT34
          annotation (Placement(transformation(extent={{194,18},{214,38}})));
        Modelica.Blocks.Interfaces.RealOutput OUT35
          annotation (Placement(transformation(extent={{228,-16},{248,4}})));
        Modelica.Blocks.Interfaces.RealOutput OUT36
          annotation (Placement(transformation(extent={{234,-50},{254,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT37
          annotation (Placement(transformation(extent={{260,-88},{280,-68}})));
        Modelica.Blocks.Interfaces.RealOutput OUT38
          annotation (Placement(transformation(extent={{258,-88},{278,-68}})));
        Modelica.Blocks.Interfaces.RealOutput OUT39
          annotation (Placement(transformation(extent={{278,-112},{298,-92}})));
        Modelica.Blocks.Interfaces.RealOutput OUT40
          annotation (Placement(transformation(extent={{242,-126},{262,-106}})));
        Modelica.Blocks.Interfaces.RealOutput OUT41
          annotation (Placement(transformation(extent={{232,-104},{252,-84}})));
        Modelica.Blocks.Interfaces.RealOutput OUT42
          annotation (Placement(transformation(extent={{278,-148},{298,-128}})));
      equation

      OUT1 = G2.gen.w;
      //OUT2 = G2.gen.delta;
      OUT3 = G2.gen.Epq;
      OUT4 = G2.gen.PSIkd;
      OUT5 = G2.gen.PSIppq;
      OUT6 = G2.sEXSMPC.simpleLagLim.state;
      OUT7 = G2.sEXSMPC.leadLag.TF.x_scaled[1];
      OUT8 = G2.gASTMPC.simpleLagLim.state;
      OUT9 = G2.gASTMPC.simpleLag.state;
      OUT10 = G2.gASTMPC.simpleLag1.state;
      OUT11 = PV.rEGCA1_1.simpleLag.state;
      OUT12 = PV.rEGCA1_1.integrator.y;
      OUT13 = PV.rEGCA1_1.integrator1.y;
      OUT14 =PV.EC.IGQ.y;
      OUT15 =PV.EC.IGV.y;
      OUT16 =PV.EC.simpleLag.state;
      OUT17 =PV.EC.simpleLag1.state;
      OUT18 =PV.EC.simpleLag2.state;
      OUT19 =PV.EC.IGP.y;
      OUT20 =PV.EC.simpleLag3.state;
      OUT21 =PV.EC.simpleLag5.state;
      OUT22 = PV.EC.simpleLag4.state;
      OUT23 = BESS.rEGCA1_1.simpleLag.state;
      OUT24 = BESS.rEGCA1_1.integrator.y;
      OUT25 = BESS.rEGCA1_1.integrator1.y;
      OUT26 =BESS.EC.integrator3.y;
      OUT27 =BESS.EC.simpleLag.state;
      OUT28 =BESS.EC.IGQ.y;
      OUT29 =BESS.EC.IGV.y;
      OUT30 =BESS.EC.IGP.y;
      OUT31 =BESS.EC.simpleLag1.state;
      OUT32 =BESS.EC.simpleLag2.state;
      OUT33 =BESS.EC.simpleLag3.state;
      OUT34 =BESS.EC.simpleLag4.state;
      OUT35 = Bus5.v;
      OUT36 = Bus5.angle;
      OUT37 = Bus6.v;
      OUT38 = Bus6.angle;
      OUT39 = Bus8.v;
      OUT40 = Bus8.angle;
      OUT41 = Bus10.v;
      OUT42 = Bus10.angle;
        connect(IN11.y,AddU1. u2) annotation (Line(points={{-99.4,32},{-86,32}},
                            color={0,0,127}));
        connect(IN1,AddU1. u1) annotation (Line(points={{-154,38},{-116,38},{-116,44},
                {-86,44}},
                       color={0,0,127}));
        connect(IN22.y,AddU2. u2) annotation (Line(points={{-99.4,2},{-86,2}},
                       color={0,0,127}));
        connect(IN2,AddU2. u1) annotation (Line(points={{-154,16},{-154,14},{-86,14}},
                       color={0,0,127}));
        connect(AddU2.y,G2. Efd_ref)
          annotation (Line(points={{-63,8},{-54,8},{-54,32},{-46,32}},
                                                                 color={0,0,127}));
        connect(AddU1.y,G2. P_ref1) annotation (Line(points={{-63,38},{-56,38},{-56,44},
                {-46,44}},                          color={0,0,127}));
        connect(Load2.p,Bus5. p) annotation (Line(points={{106,18},{106,30},{76,30},{76,
                44}},color={0,0,255}));
        connect(T4.n,Bus10. p)
          annotation (Line(points={{-5,-62},{-14,-62}}, color={0,0,255}));
        connect(Bus6.p,T2. n)
          annotation (Line(points={{-14,38},{-5,38}},
                                                  color={0,0,255}));
        connect(AddU3.y,PV. QINPUT) annotation (Line(points={{-63,-22},{-46,-22}},
                                 color={0,0,127}));
        connect(IN33.y,AddU3. u2)
          annotation (Line(points={{-99.4,-28},{-86,-28}}, color={0,0,127}));
        connect(BESS.p1,Bus10. p)
          annotation (Line(points={{-24,-62},{-14,-62}}, color={0,0,255}));
        connect(BESS.Paux1,AddU4. y) annotation (Line(points={{-46,-56},{-56,-56},{-56,
                -52},{-63,-52}}, color={0,0,127}));
        connect(IN55.y,AddU5. u2)
          annotation (Line(points={{-99.4,-84},{-86,-84}},   color={0,0,127}));
        connect(AddU5.y,BESS. Qext1) annotation (Line(points={{-63,-78},{-54,-78},{-54,
                -68},{-46,-68}},   color={0,0,127}));
        connect(IN44.y,AddU4. u2)
          annotation (Line(points={{-99.4,-58},{-86,-58}}, color={0,0,127}));
        connect(AddU4.u1,IN4)  annotation (Line(points={{-86,-46},{-138,-46},{-138,-28},
                {-154,-28}},                       color={0,0,127}));
        connect(AddU5.u1,IN5)  annotation (Line(points={{-86,-72},{-154,-72},{-154,-50}},
                             color={0,0,127}));
        connect(G2.conn,Bus6. p) annotation (Line(points={{-23,38},{-14,38}},
                                           color={0,0,255}));
        connect(AddU3.u1,IN3)  annotation (Line(points={{-86,-16},{-138,-16},{-138,-6},
                {-154,-6}},  color={0,0,127}));
        connect(PV.p1,Bus8. p)
          annotation (Line(points={{-24,-22},{-14,-22}}, color={0,0,255}));
        connect(Bus8.p,T3. n)
          annotation (Line(points={{-14,-22},{-3,-22}}, color={0,0,255}));
        connect(T2.p,Bus7. p) annotation (Line(points={{17,38},{26,38}},
                      color={0,0,255}));
        connect(T3.p,Bus9. p)
          annotation (Line(points={{19,-22},{26,-22}}, color={0,0,255}));
        connect(T4.p,Bus11. p)
          annotation (Line(points={{17,-62},{26,-62}}, color={0,0,255}));
        connect(L4.n,Bus5. p) annotation (Line(points={{45.4,38},{60,38},{60,44},{76,44}},
                              color={0,0,255}));
        connect(L5.n,Bus5. p) annotation (Line(points={{45.4,-22},{56,-22},{56,28},{76,
                28},{76,44}}, color={0,0,255}));
        connect(Bus11.p,L6. p)
          annotation (Line(points={{26,-62},{34.6,-62}}, color={0,0,255}));
        connect(Bus9.p,L5. p)
          annotation (Line(points={{26,-22},{34.6,-22}}, color={0,0,255}));
        connect(L6.n,Bus5. p) annotation (Line(points={{45.4,-62},{56,-62},{56,28},{76,
                28},{76,44}}, color={0,0,255}));
        connect(Bus7.p,L4. p) annotation (Line(points={{26,38},{34.6,38}},
                      color={0,0,255}));
        connect(sine.y,add. u2) annotation (Line(points={{74.5,-3},{74.5,11.6},{79.2,11.6}},
                               color={0,0,127}));
        connect(whiteNoiseInjection.y,add. u1) annotation (Line(points={{74.54,15.94},
                {76.87,15.94},{76.87,16.4},{79.2,16.4}},            color={0,0,
                127}));
        connect(add.y,Load2. u) annotation (Line(points={{88.4,14},{93.15,14},{93.15,13.5},
                {97.9,13.5}},                 color={0,0,127}));
        connect(Load1.p, Bus5.p)
          annotation (Line(points={{76,62},{76,44}}, color={0,0,255}));
        annotation (Diagram(graphics={
              Rectangle(
                extent={{-164,58},{-138,-62}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Text(
                extent={{-168,78},{-136,58}},
                textColor={0,140,72},
                textString="Inputs"),
              Text(
                extent={{118,126},{158,106}},
                textColor={0,140,72},
                textString="Outputs")}));
      end Caceta3;

      model Caceta4

        Modelica.Blocks.Interfaces.RealOutput y1
                     "Connector of Real output signal"
          annotation (Placement(transformation(extent={{100,10},{120,30}})));
        Modelica.Blocks.Interfaces.RealInput u1
                    "Connector of Real input signal"
          annotation (Placement(transformation(extent={{-140,-20},{-100,20}})));
        NonElectrical.Continuous.SimpleLag simpleLag(
          K=1,
          T=1,
          y_start=0)
          annotation (Placement(transformation(extent={{-8,-10},{12,10}})));
      equation

      // OUT1 = PV.rEGCA1_1.simpleLag.state;
      // OUT2 = PV.rEGCA1_1.integrator.y;
      // OUT3 = PV.rEGCA1_1.integrator1.y;
      // OUT4 =PV.EC.IGQ.y;
      // OUT5 =PV.EC.IGV.y;
      // OUT6 =PV.EC.simpleLag.state;
      // OUT7 =PV.EC.simpleLag1.state;
      // OUT8 =PV.EC.simpleLag2.state;
      // OUT9 =PV.EC.IGP.y;
      // OUT10 =PV.EC.simpleLag3.state;
      // OUT11 =PV.EC.simpleLag5.state;
      // OUT12 =PV.EC.simpleLag4.state;



        connect(u1, simpleLag.u)
          annotation (Line(points={{-120,0},{-10,0}}, color={0,0,127}));
        connect(simpleLag.y, y1) annotation (Line(points={{13,0},{96,0},{96,20},{110,20}},
              color={0,0,127}));
      end Caceta4;

      model Caceta5

        Modelica.Blocks.Interfaces.RealOutput y1
                     "Connector of Real output signal"
          annotation (Placement(transformation(extent={{100,-10},{120,10}})));
        Modelica.Blocks.Interfaces.RealInput u1
                    "Connector of Real input signal"
          annotation (Placement(transformation(extent={{-140,-20},{-100,20}})));
        Modelica.Blocks.Continuous.Integrator IGQ(
          k=1,
          initType=Modelica.Blocks.Types.Init.InitialState,
          y_start=0)
          annotation (Placement(transformation(extent={{-60,-30},{-40,-10}})));
        Modelica.Blocks.Math.Gain PGQ(k=1)
          annotation (Placement(transformation(extent={{-60,10},{-40,30}})));
        Modelica.Blocks.Math.Add add2
          annotation (Placement(transformation(extent={{-2,-10},{18,10}})));
      equation

      // OUT1 = PV.rEGCA1_1.simpleLag.state;
      // OUT2 = PV.rEGCA1_1.integrator.y;
      // OUT3 = PV.rEGCA1_1.integrator1.y;
      // OUT4 =PV.EC.IGQ.y;
      // OUT5 =PV.EC.IGV.y;
      // OUT6 =PV.EC.simpleLag.state;
      // OUT7 =PV.EC.simpleLag1.state;
      // OUT8 =PV.EC.simpleLag2.state;
      // OUT9 =PV.EC.IGP.y;
      // OUT10 =PV.EC.simpleLag3.state;
      // OUT11 =PV.EC.simpleLag5.state;
      // OUT12 =PV.EC.simpleLag4.state;

      y1 = IGQ.y;
        connect(PGQ.y,add2. u1)
          annotation (Line(points={{-39,20},{-12,20},{-12,6},{-4,6}},
                                                       color={0,0,127}));
        connect(IGQ.y,add2. u2) annotation (Line(points={{-39,-20},{-12,-20},{-12,-6},
                {-4,-6}},      color={0,0,127}));
        connect(IGQ.u, u1) annotation (Line(points={{-62,-20},{-94,-20},{-94,0},{-120,
                0}}, color={0,0,127}));
        connect(PGQ.u, u1) annotation (Line(points={{-62,20},{-94,20},{-94,0},{-120,0}},
              color={0,0,127}));
      end Caceta5;

      model MPCAppliedEnergyLinearized_test
        "THIS ONE IS STABLE, CONTROLLABLE, OBSERVABLE!!!!!!!"
        extends Modelica.Icons.Example;

        parameter Boolean equivalentGRID = false;
        parameter Boolean equivalentsystem = false;

        OpenIPSL.Electrical.Buses.Bus Bus1(v_0=powerFlow.powerflow.bus.V1, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-90,70},{-70,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus2(v_0=powerFlow.powerflow.bus.V2, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-50,70},{-30,90}})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
          R=0.001,
          X=0.2,
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000)  if not equivalentGRID annotation (Placement(transformation(
              extent={{-8,-8},{8,8}},
              rotation=180,
              origin={-60,80})));
        OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
          enableV_b=true,
          v_0=powerFlow.powerflow.bus.V1,
          angle_0=powerFlow.powerflow.bus.A1,
          P_0=powerFlow.powerflow.machines.PG1,
          Q_0=powerFlow.powerflow.machines.QG1,
          V_b=6000)  if not equivalentGRID
          annotation (Placement(transformation(extent={{-112,70},{-92,90}})));
        OpenIPSL.Electrical.Branches.PwLine L1(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{-26,76},
                  {-14,84}})));
        OpenIPSL.Electrical.Buses.Bus Bus3(v_0=powerFlow.powerflow.bus.V3, angle_0=
              powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-10,70},{10,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus4(v_0=powerFlow.powerflow.bus.V4, angle_0=
              powerFlow.powerflow.bus.V4) if not equivalentGRID
          annotation (Placement(transformation(extent={{50,70},{70,90}})));
        OpenIPSL.Electrical.Branches.PwLine L2_1(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,86},
                  {36,94}})));
        OpenIPSL.Electrical.Branches.PwLine L2_2(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,66},
                  {36,74}})));
        OpenIPSL.Electrical.Buses.Bus Bus5(angle_0=powerFlow.powerflow.bus.A5, v_0=
              powerFlow.powerflow.bus.V5)  annotation (Placement(
              transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={80,16})));
        OpenIPSL.Electrical.Branches.PwLine L3(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=-90,
              origin={80,60})));
        OpenIPSL.Electrical.Buses.Bus Bus6(v_0=powerFlow.powerflow.bus.V6, angle_0=
              powerFlow.powerflow.bus.A6) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,10})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000,
          R=0.005,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={10,10})));
        GenerationUnits.PSSE.G2_16MVA                         G2(
          enableV_b=true,
          enableP_0=true,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V6,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A6,
          V_b=6000,
          P_0=powerFlow.powerflow.machines.PG2,
          Q_0=powerFlow.powerflow.machines.QG2,
          enableangle_0=true)
                        annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-30,10})));
        inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000, fn=60)
          annotation (Placement(transformation(extent={{-128,104},{-74,124}})));
        OpenIPSL.Electrical.Loads.PSSE.Load Load1(
          V_b=220000,
          P_0=powerFlow.powerflow.loads.PL1,
          Q_0=powerFlow.powerflow.loads.QL1,
          v_0=powerFlow.powerflow.bus.V3,
          angle_0=powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-20,48},{0,68}})));
        Electrical.Events.Breaker breaker(enableTrigger=false,
          t_o=0.5,
          rc_enabled=true,
          t_rc=10000)       if not equivalentGRID                     annotation (Placement(transformation(
              extent={{-4,-4},{4,4}},
              rotation=90,
              origin={80,26})));

        Modelica.Blocks.Interfaces.RealInput IN1(start=0)
          "Connector of Real input signal 2" annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-150,10}),iconTransformation(extent={{-10,-10},{10,10}}, origin={-150,10})));
        Modelica.Blocks.Sources.Constant IN11(k=0)
          annotation (Placement(transformation(extent={{-108,-2},{-96,10}})));
        Modelica.Blocks.Math.Add AddU1
          annotation (Placement(transformation(extent={{-80,0},{-60,20}})));
        Modelica.Blocks.Sources.Constant IN22(k=0)
          annotation (Placement(transformation(extent={{-108,-32},{-96,-20}})));
        Modelica.Blocks.Math.Add AddU2
          annotation (Placement(transformation(extent={{-80,-30},{-60,-10}})));
        Modelica.Blocks.Interfaces.RealInput IN2(start=0)
          "Connector of Real input signal 2"
                 annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-150,-12}), iconTransformation(extent={{-10,-10},{10,10}},
                origin={-150,-12})));

        Modelica.Blocks.Interfaces.RealInput IN3(start = 0) "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-44},{-140,-24}}),
              iconTransformation(extent={{-160,-44},{-140,-24}})));
        Modelica.Blocks.Interfaces.RealInput IN4(start = 0) "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-66},{-140,-46}}),
              iconTransformation(extent={{-160,-66},{-140,-46}})));
        Modelica.Blocks.Interfaces.RealInput IN5(start = 0) "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-88},{-140,-68}}),
              iconTransformation(extent={{-160,-88},{-140,-68}})));

        PFData.PowerFlow powerFlow(redeclare record PowerFlow =
              OpenIPSL.Examples.ModelPredictiveControl.PFData.PF16)
          annotation (Placement(transformation(extent={{-68,104},{-48,124}})));
        Electrical.Machines.PSSE.GENCLS IB(
          V_b=220000,
          v_0=powerFlow.powerflow.bus.V4,
          angle_0=powerFlow.powerflow.bus.A4,
          P_0=powerFlow.powerflow.machines.Pinf,
          Q_0=powerFlow.powerflow.machines.Qinf,
          M_b=100000000,
          X_d=1) if not equivalentGRID annotation (Placement(transformation(extent={{110,70},
                  {100,90}})));
        Electrical.Loads.PSSE.Load_ExtInput Load2(
          P_0=powerFlow.powerflow.loads.PL2,
          Q_0=powerFlow.powerflow.loads.QL2,
          v_0=powerFlow.powerflow.bus.V5,
          angle_0=powerFlow.powerflow.bus.A5,
          d_P=0,
          t1=100,
          d_t=1000)
          annotation (Placement(transformation(extent={{100,-30},{120,-10}})));

        inner Modelica.Blocks.Noise.GlobalSeed globalSeed(useAutomaticSeed=false,
            fixedSeed=10000)
          annotation (Placement(transformation(extent={{-42,102},{-22,122}})));

        Electrical.Buses.Bus Bus10(v_0=powerFlow.powerflow.bus.V10, angle_0=powerFlow.powerflow.bus.A10)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,-90})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T4(
          G=0,
          B=0,
          CW=1,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={10,-90})));
        GenerationUnits.PSSE.Solar_Units.SolarMPCLocalVQControl PV(
          V_b=480,
          P_0=powerFlow.powerflow.machines.PPV,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QPV,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V8,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A8,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-60},{-20,-40}})));
        Modelica.Blocks.Math.Add AddU3
          annotation (Placement(transformation(extent={{-80,-60},{-60,-40}})));
        Modelica.Blocks.Sources.Step     IN33(height=0, startTime=1)
          annotation (Placement(transformation(extent={{-108,-62},{-96,-50}})));

        Modelica.Blocks.Math.Add AddU4
          annotation (Placement(transformation(extent={{-80,-90},{-60,-70}})));
        Modelica.Blocks.Math.Add AddU5
          annotation (Placement(transformation(extent={{-80,-116},{-60,-96}})));
        Modelica.Blocks.Sources.Step     IN44(height=0.05, startTime=1)
          annotation (Placement(transformation(extent={{-108,-92},{-96,-80}})));
        Modelica.Blocks.Sources.Step     IN55(height=0.05, startTime=1)
          annotation (Placement(transformation(extent={{-108,-118},{-96,-106}})));
        GenerationUnits.PSSE.Battery_Units.BESSMPCLocalVQControlLinearized
                                                                 BESS(
          V_base=480,
          V_b(displayUnit="kV") = 480,
          enableV_b=true,
          P_0=powerFlow.powerflow.machines.PBESS,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QBESS,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V10,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A10,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-100},{-20,-80}})));
        Electrical.Buses.Bus Bus8(v_0=powerFlow.powerflow.bus.V8, angle_0=powerFlow.powerflow.bus.A8)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,-50})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T3(
          G=0,
          B=0,
          CW=1,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={12,-50})));
        Electrical.Buses.Bus Bus11(v_0=powerFlow.powerflow.bus.V11, angle_0=powerFlow.powerflow.bus.A11)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,-90})));
        Electrical.Buses.Bus Bus9(v_0=powerFlow.powerflow.bus.V9, angle_0=powerFlow.powerflow.bus.A9)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,-50})));
        Electrical.Buses.Bus Bus7(v_0=powerFlow.powerflow.bus.V7, angle_0=powerFlow.powerflow.bus.A7)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,10})));
        Electrical.Branches.PwLine          L4(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,6},{
                  50,14}})));
        Electrical.Branches.PwLine          L5(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,-54},
                  {50,-46}})));
        Electrical.Branches.PwLine          L6(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,-94},
                  {50,-86}})));
        Modelica.Blocks.Sources.Sine sine(
          amplitude=0,
          f=1/260,
          phase=3.1415926535898,
          startTime=1000)
          annotation (Placement(transformation(extent={{68,-36},{78,-26}})));
        Electrical.Loads.NoiseInjections.WhiteNoiseInjection whiteNoiseInjection(
            active_sigma=0.0000000001, samplePeriod=0.01)
          annotation (Placement(transformation(extent={{66,-18},{78,-6}})));
        Modelica.Blocks.Math.Add add
          annotation (Placement(transformation(extent={{84,-18},{92,-10}})));
      equation


        connect(T1.p, Bus2.p)
          annotation (Line(points={{-51.2,80},{-40,80}}, color={0,0,255}));
        connect(Bus1.p, T1.n)
          annotation (Line(points={{-80,80},{-68.8,80}}, color={0,0,255}));
        connect(G1.conn, Bus1.p)
          annotation (Line(points={{-91,80},{-80,80}}, color={0,0,255}));
        connect(L1.n, Bus3.p)
          annotation (Line(points={{-14.6,80},{0,80}}, color={0,0,255}));
        connect(L1.p, Bus2.p)
          annotation (Line(points={{-25.4,80},{-40,80}}, color={0,0,255}));
        connect(L2_2.n, Bus4.p) annotation (Line(points={{35.4,70},{44,70},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.n, Bus4.p) annotation (Line(points={{35.4,90},{44,90},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.p, Bus3.p) annotation (Line(points={{24.6,90},{16,90},{16,80},{0,
                80}}, color={0,0,255}));
        connect(L2_2.p, Bus3.p) annotation (Line(points={{24.6,70},{16,70},{16,80},{0,
                80}}, color={0,0,255}));
        connect(Load1.p, Bus3.p)
          annotation (Line(points={{-10,68},{-10,80},{0,80}}, color={0,0,255}));
        connect(L3.p, Bus4.p)
          annotation (Line(points={{80,65.4},{80,80},{60,80}}, color={0,0,255}));
        connect(breaker.s, Bus5.p)
          annotation (Line(points={{80,22},{80,16}},color={0,0,255}));
        connect(breaker.r, L3.n)
          annotation (Line(points={{80,30},{80,54.6}},color={0,0,255}));
        connect(IN11.y, AddU1.u2) annotation (Line(points={{-95.4,4},{-82,4}},
                            color={0,0,127}));
        connect(IN1, AddU1.u1) annotation (Line(points={{-150,10},{-116,10},{-116,16},
                {-82,16}},
                       color={0,0,127}));

        connect(IN22.y,AddU2. u2) annotation (Line(points={{-95.4,-26},{-82,-26}},
                       color={0,0,127}));
        connect(IN2,AddU2. u1) annotation (Line(points={{-150,-12},{-118,-12},{-118,-14},
                {-82,-14}},
                       color={0,0,127}));
        connect(AddU2.y, G2.Efd_ref)
          annotation (Line(points={{-59,-20},{-52,-20},{-52,4},{-42,4}},
                                                                 color={0,0,127}));
        connect(AddU1.y, G2.P_ref1) annotation (Line(points={{-59,10},{-52,10},{-52,16},
                {-42,16}},                          color={0,0,127}));
        connect(IB.p, Bus4.p)
          annotation (Line(points={{100,80},{60,80}}, color={0,0,255}));
        connect(Load2.p, Bus5.p) annotation (Line(points={{110,-10},{110,10},{80,10},{
                80,16}},
                     color={0,0,255}));
        connect(T4.n, Bus10.p)
          annotation (Line(points={{-1,-90},{-10,-90}}, color={0,0,255}));
        connect(Bus6.p, T2.n)
          annotation (Line(points={{-10,10},{-1,10}},
                                                  color={0,0,255}));
        connect(IN33.y,AddU3. u2)
          annotation (Line(points={{-95.4,-56},{-82,-56}}, color={0,0,127}));
        connect(BESS.p1, Bus10.p)
          annotation (Line(points={{-20,-90},{-10,-90}}, color={0,0,255}));
        connect(BESS.Paux1, AddU4.y) annotation (Line(points={{-42,-84},{-54,-84},{-54,
                -80},{-59,-80}}, color={0,0,127}));
        connect(IN55.y, AddU5.u2)
          annotation (Line(points={{-95.4,-112},{-82,-112}}, color={0,0,127}));
        connect(AddU5.y, BESS.Qext1) annotation (Line(points={{-59,-106},{-52,-106},{-52,
                -96},{-42,-96}},   color={0,0,127}));
        connect(IN44.y, AddU4.u2)
          annotation (Line(points={{-95.4,-86},{-82,-86}}, color={0,0,127}));
        connect(AddU4.u1,IN4)  annotation (Line(points={{-82,-74},{-100,-74},{-100,-70},
                {-116,-70},{-116,-56},{-150,-56}}, color={0,0,127}));
        connect(AddU5.u1,IN5)  annotation (Line(points={{-82,-100},{-116,-100},{-116,-78},
                {-150,-78}}, color={0,0,127}));
        connect(G2.conn, Bus6.p) annotation (Line(points={{-19,10},{-10,10}},
                                           color={0,0,255}));
        connect(AddU3.u1, IN3) annotation (Line(points={{-82,-44},{-118,-44},{-118,-34},
                {-150,-34}}, color={0,0,127}));
        connect(PV.p1, Bus8.p)
          annotation (Line(points={{-20,-50},{-10,-50}}, color={0,0,255}));
        connect(Bus8.p, T3.n)
          annotation (Line(points={{-10,-50},{1,-50}},  color={0,0,255}));
        connect(T2.p, Bus7.p) annotation (Line(points={{21,10},{25.5,10},{25.5,10},{30,
                10}}, color={0,0,255}));
        connect(T3.p, Bus9.p)
          annotation (Line(points={{23,-50},{30,-50}}, color={0,0,255}));
        connect(T4.p, Bus11.p)
          annotation (Line(points={{21,-90},{30,-90}}, color={0,0,255}));
        connect(L4.n, Bus5.p) annotation (Line(points={{49.4,10},{60,10},{60,10},{80,10},
                {80,16}},     color={0,0,255}));
        connect(L5.n, Bus5.p) annotation (Line(points={{49.4,-50},{60,-50},{60,10},{80,
                10},{80,16}}, color={0,0,255}));
        connect(Bus11.p, L6.p)
          annotation (Line(points={{30,-90},{38.6,-90}}, color={0,0,255}));
        connect(Bus9.p, L5.p)
          annotation (Line(points={{30,-50},{38.6,-50}}, color={0,0,255}));
        connect(L6.n, Bus5.p) annotation (Line(points={{49.4,-90},{60,-90},{60,10},{80,
                10},{80,16}}, color={0,0,255}));
        connect(Bus7.p, L4.p) annotation (Line(points={{30,10},{34.3,10},{34.3,10},{38.6,
                10}}, color={0,0,255}));
        connect(sine.y, add.u2) annotation (Line(points={{78.5,-31},{78.5,-16.4},
                {83.2,-16.4}}, color={0,0,127}));
        connect(whiteNoiseInjection.y, add.u1) annotation (Line(points={{78.54,
                -12.06},{80.87,-12.06},{80.87,-11.6},{83.2,-11.6}}, color={0,0,
                127}));
        connect(add.y, Load2.u) annotation (Line(points={{92.4,-14},{97.15,-14},
                {97.15,-14.5},{101.9,-14.5}}, color={0,0,127}));
        connect(AddU3.y, PV.QINPUT)
          annotation (Line(points={{-59,-50},{-42,-50}}, color={0,0,127}));
          annotation (Placement(transformation(extent={{140,-20},{160,0}})),
                      Placement(transformation(extent={{140,-40},{160,-20}})),
                      Placement(transformation(extent={{140,-60},{160,-40}})),
                      Placement(transformation(extent={{140,-80},{160,-60}})),
                     Diagram(coordinateSystem(preserveAspectRatio=false,
                extent={{-140,-140},{140,140}}), graphics={
              Rectangle(
                extent={{-160,30},{-134,-90}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,36},{124,-124}},
                lineColor={238,46,47},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,98},{124,38}},
                lineColor={0,128,255},
                lineThickness=0.5),
              Text(
                extent={{78,-106},{114,-120}},
                textColor={238,46,47},
                textString="Microgrid"),
              Text(
                extent={{76,58},{128,34}},
                textColor={28,108,200},
                textString="Utility Grid"),
              Text(
                extent={{-30,-102},{34,-124}},
                textColor={0,140,72},
                textString="Linearization Unit"),
              Text(
                extent={{-164,50},{-132,30}},
                textColor={0,140,72},
                textString="Inputs")}),
          Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),experiment(
            StopTime=4,
            __Dymola_NumberOfIntervals=50000,
            __Dymola_Algorithm="Dassl"),
          Icon(coordinateSystem(extent={{-140,-140},{140,140}})));
      end MPCAppliedEnergyLinearized_test;

      model MPCAppliedEnergyLinearized_test2
        "THIS ONE IS STABLE, CONTROLLABLE, OBSERVABLE!!!!!!!"
        extends Modelica.Icons.Example;

        parameter Boolean equivalentGRID = true;
        parameter Boolean equivalentsystem = false;

        OpenIPSL.Electrical.Buses.Bus Bus5(angle_0=powerFlow.powerflow.bus.A5, v_0=
              powerFlow.powerflow.bus.V5)  annotation (Placement(
              transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={80,16})));
        OpenIPSL.Electrical.Buses.Bus Bus6(v_0=powerFlow.powerflow.bus.V6, angle_0=
              powerFlow.powerflow.bus.A6) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,10})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000,
          R=0.005,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={10,10})));
        GenerationUnits.PSSE.G2_16MVA                         G2(
          enableV_b=true,
          enableP_0=true,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V6,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A6,
          V_b=6000,
          P_0=powerFlow.powerflow.machines.PG2,
          Q_0=powerFlow.powerflow.machines.QG2,
          enableangle_0=true)
                        annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-30,10})));

        Modelica.Blocks.Interfaces.RealInput IN1(start=0)
          "Connector of Real input signal 2" annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-150,10}),iconTransformation(extent={{-10,-10},{10,10}}, origin={-150,10})));
        Modelica.Blocks.Sources.Constant IN11(k=0)
          annotation (Placement(transformation(extent={{-108,-2},{-96,10}})));
        Modelica.Blocks.Math.Add AddU1
          annotation (Placement(transformation(extent={{-80,0},{-60,20}})));
        Modelica.Blocks.Sources.Constant IN22(k=0)
          annotation (Placement(transformation(extent={{-108,-32},{-96,-20}})));
        Modelica.Blocks.Math.Add AddU2
          annotation (Placement(transformation(extent={{-80,-30},{-60,-10}})));
        Modelica.Blocks.Interfaces.RealInput IN2(start=0)
          "Connector of Real input signal 2"
                 annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-150,-12}), iconTransformation(extent={{-10,-10},{10,10}},
                origin={-150,-12})));

        Modelica.Blocks.Interfaces.RealInput IN3(start = 0) "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-44},{-140,-24}}),
              iconTransformation(extent={{-160,-44},{-140,-24}})));
        Modelica.Blocks.Interfaces.RealInput IN4(start = 0) "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-66},{-140,-46}}),
              iconTransformation(extent={{-160,-66},{-140,-46}})));
        Modelica.Blocks.Interfaces.RealInput IN5(start = 0) "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-88},{-140,-68}}),
              iconTransformation(extent={{-160,-88},{-140,-68}})));

        Electrical.Loads.PSSE.Load_ExtInput Load2(
          P_0=powerFlow.powerflow.loads.PL2,
          Q_0=powerFlow.powerflow.loads.QL2,
          v_0=powerFlow.powerflow.bus.V5,
          angle_0=powerFlow.powerflow.bus.A5,
          d_P=0,
          t1=100,
          d_t=1000)
          annotation (Placement(transformation(extent={{100,-30},{120,-10}})));

        Electrical.Buses.Bus Bus10(v_0=powerFlow.powerflow.bus.V10, angle_0=powerFlow.powerflow.bus.A10)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,-90})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T4(
          G=0,
          B=0,
          CW=1,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={10,-90})));
        GenerationUnits.PSSE.Solar_Units.SolarMPCLocalVQControl PV(
          V_b=480,
          P_0=powerFlow.powerflow.machines.PPV,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QPV,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V8,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A8,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-60},{-20,-40}})));
        Modelica.Blocks.Math.Add AddU3
          annotation (Placement(transformation(extent={{-80,-60},{-60,-40}})));
        Modelica.Blocks.Sources.Constant IN33(k=0)
          annotation (Placement(transformation(extent={{-108,-62},{-96,-50}})));

        Modelica.Blocks.Math.Add AddU4
          annotation (Placement(transformation(extent={{-80,-90},{-60,-70}})));
        Modelica.Blocks.Math.Add AddU5
          annotation (Placement(transformation(extent={{-80,-116},{-60,-96}})));
        Modelica.Blocks.Sources.Constant IN44(k=0)
          annotation (Placement(transformation(extent={{-108,-92},{-96,-80}})));
        Modelica.Blocks.Sources.Constant IN55(k=0)
          annotation (Placement(transformation(extent={{-108,-118},{-96,-106}})));
        GenerationUnits.PSSE.Battery_Units.BESSMPCLocalVQControlLinearized
                                                                 BESS(
          V_base=480,
          V_b(displayUnit="kV") = 480,
          enableV_b=true,
          P_0=powerFlow.powerflow.machines.PBESS,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QBESS,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V10,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A10,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-100},{-20,-80}})));
        Electrical.Buses.Bus Bus8(v_0=powerFlow.powerflow.bus.V8, angle_0=powerFlow.powerflow.bus.A8)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,-50})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T3(
          G=0,
          B=0,
          CW=1,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={12,-50})));
        Electrical.Buses.Bus Bus11(v_0=powerFlow.powerflow.bus.V11, angle_0=powerFlow.powerflow.bus.A11)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,-90})));
        Electrical.Buses.Bus Bus9(v_0=powerFlow.powerflow.bus.V9, angle_0=powerFlow.powerflow.bus.A9)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,-50})));
        Electrical.Buses.Bus Bus7(v_0=powerFlow.powerflow.bus.V7, angle_0=powerFlow.powerflow.bus.A7)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,10})));
        Electrical.Branches.PwLine          L4(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,6},{
                  50,14}})));
        Electrical.Branches.PwLine          L5(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,-54},
                  {50,-46}})));
        Electrical.Branches.PwLine          L6(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,-94},
                  {50,-86}})));
        Modelica.Blocks.Sources.Sine sine(
          amplitude=0,
          f=1/260,
          phase=3.1415926535898,
          startTime=1000)
          annotation (Placement(transformation(extent={{68,-36},{78,-26}})));
        Electrical.Loads.NoiseInjections.WhiteNoiseInjection whiteNoiseInjection(
            active_sigma=0.0000000001, samplePeriod=0.01)
          annotation (Placement(transformation(extent={{66,-18},{78,-6}})));
        Modelica.Blocks.Math.Add add
          annotation (Placement(transformation(extent={{84,-18},{92,-10}})));
        PFData.PowerFlow powerFlow(redeclare record PowerFlow = PFData.PF16)
          annotation (Placement(transformation(extent={{-116,106},{-96,126}})));
        Modelica.Blocks.Interfaces.RealOutput OUT1
          annotation (Placement(transformation(extent={{146,68},{166,88}})));
       Modelica.Blocks.Interfaces.RealOutput OUT2
          annotation (Placement(transformation(extent={{146,48},{166,68}})));
        Modelica.Blocks.Interfaces.RealOutput OUT3
          annotation (Placement(transformation(extent={{146,28},{166,48}})));
        Modelica.Blocks.Interfaces.RealOutput OUT4
          annotation (Placement(transformation(extent={{146,8},{166,28}})));
        Modelica.Blocks.Interfaces.RealOutput OUT5
          annotation (Placement(transformation(extent={{146,-12},{166,8}})));
        Modelica.Blocks.Interfaces.RealOutput OUT6
          annotation (Placement(transformation(extent={{146,-32},{166,-12}})));
        Modelica.Blocks.Interfaces.RealOutput OUT7
          annotation (Placement(transformation(extent={{146,-52},{166,-32}})));
        Modelica.Blocks.Interfaces.RealOutput OUT8
          annotation (Placement(transformation(extent={{146,-72},{166,-52}})));
        Modelica.Blocks.Interfaces.RealOutput OUT9
          annotation (Placement(transformation(extent={{146,-92},{166,-72}})));
        Modelica.Blocks.Interfaces.RealOutput OUT10
          annotation (Placement(transformation(extent={{146,-112},{166,-92}})));
        Modelica.Blocks.Interfaces.RealOutput OUT11
          annotation (Placement(transformation(extent={{170,68},{190,88}})));
        Modelica.Blocks.Interfaces.RealOutput OUT12
          annotation (Placement(transformation(extent={{170,48},{190,68}})));
        Modelica.Blocks.Interfaces.RealOutput OUT13
          annotation (Placement(transformation(extent={{170,28},{190,48}})));
        Modelica.Blocks.Interfaces.RealOutput OUT14
          annotation (Placement(transformation(extent={{170,8},{190,28}})));
        Modelica.Blocks.Interfaces.RealOutput OUT15
          annotation (Placement(transformation(extent={{170,-12},{190,8}})));
        Modelica.Blocks.Interfaces.RealOutput OUT16
          annotation (Placement(transformation(extent={{170,-32},{190,-12}})));
        Modelica.Blocks.Interfaces.RealOutput OUT17
          annotation (Placement(transformation(extent={{170,-52},{190,-32}})));
        Modelica.Blocks.Interfaces.RealOutput OUT18
          annotation (Placement(transformation(extent={{170,-72},{190,-52}})));
        Modelica.Blocks.Interfaces.RealOutput OUT19
          annotation (Placement(transformation(extent={{170,-92},{190,-72}})));
        Modelica.Blocks.Interfaces.RealOutput OUT20
          annotation (Placement(transformation(extent={{170,-112},{190,-92}})));
        Modelica.Blocks.Interfaces.RealOutput OUT21
          annotation (Placement(transformation(extent={{190,68},{210,88}})));
        Modelica.Blocks.Interfaces.RealOutput OUT22
          annotation (Placement(transformation(extent={{190,48},{210,68}})));
        Modelica.Blocks.Interfaces.RealOutput OUT23
          annotation (Placement(transformation(extent={{190,28},{210,48}})));
        Modelica.Blocks.Interfaces.RealOutput OUT24
          annotation (Placement(transformation(extent={{190,8},{210,28}})));
        Modelica.Blocks.Interfaces.RealOutput OUT25
          annotation (Placement(transformation(extent={{190,-12},{210,8}})));
        Modelica.Blocks.Interfaces.RealOutput OUT26
          annotation (Placement(transformation(extent={{190,-32},{210,-12}})));
        Modelica.Blocks.Interfaces.RealOutput OUT27
          annotation (Placement(transformation(extent={{190,-52},{210,-32}})));
        Modelica.Blocks.Interfaces.RealOutput OUT28
          annotation (Placement(transformation(extent={{190,-72},{210,-52}})));
        Modelica.Blocks.Interfaces.RealOutput OUT29
          annotation (Placement(transformation(extent={{190,-92},{210,-72}})));
        Modelica.Blocks.Interfaces.RealOutput OUT30
          annotation (Placement(transformation(extent={{190,-112},{210,-92}})));
        Modelica.Blocks.Interfaces.RealOutput OUT31
          annotation (Placement(transformation(extent={{210,68},{230,88}})));
        Modelica.Blocks.Interfaces.RealOutput OUT32
          annotation (Placement(transformation(extent={{210,48},{230,68}})));
        Modelica.Blocks.Interfaces.RealOutput OUT33
          annotation (Placement(transformation(extent={{210,28},{230,48}})));
        Modelica.Blocks.Interfaces.RealOutput OUT34
          annotation (Placement(transformation(extent={{210,8},{230,28}})));
        Electrical.Loads.PSSE.Load          Load1(
          P_0=-3004660,
          Q_0=-548994,
          v_0=powerFlow.powerflow.bus.V5,
          angle_0=powerFlow.powerflow.bus.A5)
          annotation (Placement(transformation(extent={{-10,-10},{10,10}},
              rotation=180,
              origin={80,60})));
        Modelica.Blocks.Interfaces.RealOutput OUT35
          annotation (Placement(transformation(extent={{210,-12},{230,8}})));
        Modelica.Blocks.Interfaces.RealOutput OUT36
          annotation (Placement(transformation(extent={{210,-32},{230,-12}})));
        Modelica.Blocks.Interfaces.RealOutput OUT37
          annotation (Placement(transformation(extent={{210,-52},{230,-32}})));
        Modelica.Blocks.Interfaces.RealOutput OUT38
          annotation (Placement(transformation(extent={{210,-72},{230,-52}})));
        Modelica.Blocks.Interfaces.RealOutput OUT39
          annotation (Placement(transformation(extent={{220,-96},{240,-76}})));
        Modelica.Blocks.Interfaces.RealOutput OUT40
          annotation (Placement(transformation(extent={{220,-116},{240,-96}})));
        Modelica.Blocks.Interfaces.RealOutput OUT41
          annotation (Placement(transformation(extent={{220,-136},{240,-116}})));
        Modelica.Blocks.Interfaces.RealOutput OUT42
          annotation (Placement(transformation(extent={{220,-156},{240,-136}})));
      equation

      OUT1 = G2.gen.w;
      OUT2 = G2.gen.delta;
      OUT3 = G2.gen.Epq;
      OUT4 = G2.gen.PSIkd;
      OUT5 = G2.gen.PSIppq;
      OUT6 = G2.sEXSMPC.simpleLagLim.state;
      OUT7 = G2.sEXSMPC.leadLag.TF.x_scaled[1];
      OUT8 = G2.gASTMPC.simpleLagLim.state;
      OUT9 = G2.gASTMPC.simpleLag.state;
      OUT10 = G2.gASTMPC.simpleLag1.state;
      OUT11 = PV.rEGCA1_1.simpleLag.state;
      OUT12 = PV.rEGCA1_1.integrator.y;
      OUT13 = PV.rEGCA1_1.integrator1.y;
      OUT14 =PV.EC.IGQ.y;
      OUT15 =PV.EC.IGV.y;
      OUT16 =PV.EC.simpleLag.state;
      OUT17 =PV.EC.simpleLag1.state;
      OUT18 =PV.EC.simpleLag2.state;
      OUT19 =PV.EC.IGP.y;
      OUT20 =PV.EC.simpleLag3.state;
      OUT21 =PV.EC.simpleLag5.state;
      OUT22 = PV.EC.simpleLag4.state;
      OUT23 = BESS.rEGCA1_1.simpleLag.state;
      OUT24 = BESS.rEGCA1_1.integrator.y;
      OUT25 = BESS.rEGCA1_1.integrator1.y;
      OUT26 =BESS.EC.integrator3.y;
      OUT27 =BESS.EC.simpleLag.state;
      OUT28 =BESS.EC.IGQ.y;
      OUT29 =BESS.EC.IGV.y;
      OUT30 =BESS.EC.IGP.y;
      OUT31 =BESS.EC.simpleLag1.state;
      OUT32 =BESS.EC.simpleLag2.state;
      OUT33 =BESS.EC.simpleLag3.state;
      OUT34 =BESS.EC.simpleLag4.state;
      OUT35 = G2.gen.PMECH;
      OUT36 = G2.sEXSMPC.EFD;
      OUT37 = BESS.rEGCA1_1.Pgen;
      OUT38 = BESS.rEGCA1_1.Qgen;
      OUT39 = PV.rEGCA1_1.Pgen;
      OUT40 = PV.rEGCA1_1.Qgen;
      OUT41 = Bus5.v;
      OUT42 = Bus5.angle;




        connect(IN11.y, AddU1.u2) annotation (Line(points={{-95.4,4},{-82,4}},
                            color={0,0,127}));
        connect(IN1, AddU1.u1) annotation (Line(points={{-150,10},{-116,10},{-116,16},
                {-82,16}},
                       color={0,0,127}));

        connect(IN22.y,AddU2. u2) annotation (Line(points={{-95.4,-26},{-82,-26}},
                       color={0,0,127}));
        connect(IN2,AddU2. u1) annotation (Line(points={{-150,-12},{-118,-12},{-118,-14},
                {-82,-14}},
                       color={0,0,127}));
        connect(AddU2.y, G2.Efd_ref)
          annotation (Line(points={{-59,-20},{-52,-20},{-52,4},{-42,4}},
                                                                 color={0,0,127}));
        connect(AddU1.y, G2.P_ref1) annotation (Line(points={{-59,10},{-52,10},{-52,16},
                {-42,16}},                          color={0,0,127}));
        connect(Load2.p, Bus5.p) annotation (Line(points={{110,-10},{110,10},{80,10},{
                80,16}},
                     color={0,0,255}));
        connect(T4.n, Bus10.p)
          annotation (Line(points={{-1,-90},{-10,-90}}, color={0,0,255}));
        connect(Bus6.p, T2.n)
          annotation (Line(points={{-10,10},{-1,10}},
                                                  color={0,0,255}));
        connect(AddU3.y, PV.QINPUT) annotation (Line(points={{-59,-50},{-42,-50}},
                                 color={0,0,127}));
        connect(IN33.y,AddU3. u2)
          annotation (Line(points={{-95.4,-56},{-82,-56}}, color={0,0,127}));
        connect(BESS.p1, Bus10.p)
          annotation (Line(points={{-20,-90},{-10,-90}}, color={0,0,255}));
        connect(BESS.Paux1, AddU4.y) annotation (Line(points={{-42,-84},{-54,-84},{-54,
                -80},{-59,-80}}, color={0,0,127}));
        connect(IN55.y, AddU5.u2)
          annotation (Line(points={{-95.4,-112},{-82,-112}}, color={0,0,127}));
        connect(AddU5.y, BESS.Qext1) annotation (Line(points={{-59,-106},{-52,-106},{-52,
                -96},{-42,-96}},   color={0,0,127}));
        connect(IN44.y, AddU4.u2)
          annotation (Line(points={{-95.4,-86},{-82,-86}}, color={0,0,127}));
        connect(AddU4.u1,IN4)  annotation (Line(points={{-82,-74},{-100,-74},{-100,-70},
                {-116,-70},{-116,-56},{-150,-56}}, color={0,0,127}));
        connect(AddU5.u1,IN5)  annotation (Line(points={{-82,-100},{-116,-100},{-116,-78},
                {-150,-78}}, color={0,0,127}));
        connect(G2.conn, Bus6.p) annotation (Line(points={{-19,10},{-10,10}},
                                           color={0,0,255}));
        connect(AddU3.u1, IN3) annotation (Line(points={{-82,-44},{-118,-44},{-118,-34},
                {-150,-34}}, color={0,0,127}));
        connect(PV.p1, Bus8.p)
          annotation (Line(points={{-20,-50},{-10,-50}}, color={0,0,255}));
        connect(Bus8.p, T3.n)
          annotation (Line(points={{-10,-50},{1,-50}},  color={0,0,255}));
        connect(T2.p, Bus7.p) annotation (Line(points={{21,10},{25.5,10},{25.5,10},{30,
                10}}, color={0,0,255}));
        connect(T3.p, Bus9.p)
          annotation (Line(points={{23,-50},{30,-50}}, color={0,0,255}));
        connect(T4.p, Bus11.p)
          annotation (Line(points={{21,-90},{30,-90}}, color={0,0,255}));
        connect(L4.n, Bus5.p) annotation (Line(points={{49.4,10},{60,10},{60,10},{80,10},
                {80,16}},     color={0,0,255}));
        connect(L5.n, Bus5.p) annotation (Line(points={{49.4,-50},{60,-50},{60,10},{80,
                10},{80,16}}, color={0,0,255}));
        connect(Bus11.p, L6.p)
          annotation (Line(points={{30,-90},{38.6,-90}}, color={0,0,255}));
        connect(Bus9.p, L5.p)
          annotation (Line(points={{30,-50},{38.6,-50}}, color={0,0,255}));
        connect(L6.n, Bus5.p) annotation (Line(points={{49.4,-90},{60,-90},{60,10},{80,
                10},{80,16}}, color={0,0,255}));
        connect(Bus7.p, L4.p) annotation (Line(points={{30,10},{34.3,10},{34.3,10},{38.6,
                10}}, color={0,0,255}));
        connect(sine.y, add.u2) annotation (Line(points={{78.5,-31},{78.5,-16.4},
                {83.2,-16.4}}, color={0,0,127}));
        connect(whiteNoiseInjection.y, add.u1) annotation (Line(points={{78.54,
                -12.06},{80.87,-12.06},{80.87,-11.6},{83.2,-11.6}}, color={0,0,
                127}));
        connect(add.y, Load2.u) annotation (Line(points={{92.4,-14},{97.15,-14},
                {97.15,-14.5},{101.9,-14.5}}, color={0,0,127}));
        connect(Load1.p, Bus5.p) annotation (Line(points={{80,50},{80,30},{94,30},{94,
                10},{80,10},{80,16}}, color={0,0,255}));
          annotation (Placement(transformation(extent={{140,-20},{160,0}})),
                      Placement(transformation(extent={{140,-40},{160,-20}})),
                      Placement(transformation(extent={{140,-60},{160,-40}})),
                      Placement(transformation(extent={{140,-80},{160,-60}})),
                     Diagram(coordinateSystem(preserveAspectRatio=false,
                extent={{-140,-140},{140,140}}), graphics={
              Rectangle(
                extent={{-160,30},{-134,-90}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,36},{124,-124}},
                lineColor={238,46,47},
                lineThickness=0.5),
              Text(
                extent={{78,-106},{114,-120}},
                textColor={238,46,47},
                textString="Microgrid"),
              Text(
                extent={{-30,-102},{34,-124}},
                textColor={0,140,72},
                textString="Linearization Unit"),
              Text(
                extent={{-164,50},{-132,30}},
                textColor={0,140,72},
                textString="Inputs")}),
          Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),experiment(StopTime=10, __Dymola_Algorithm="Dassl"),
          Icon(coordinateSystem(extent={{-140,-140},{140,140}})));
      end MPCAppliedEnergyLinearized_test2;

      model MPCAppliedEnergyLinearized_test2_table
        "THIS ONE IS STABLE, CONTROLLABLE, OBSERVABLE!!!!!!!"
        extends Modelica.Icons.Example;

        parameter Boolean equivalentGRID = true;
        parameter Boolean equivalentsystem = false;

        OpenIPSL.Electrical.Buses.Bus Bus1(v_0=powerFlow.powerflow.bus.V1, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-90,70},{-70,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus2(v_0=powerFlow.powerflow.bus.V2, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-50,70},{-30,90}})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
          R=0.001,
          X=0.2,
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000)  if not equivalentGRID annotation (Placement(transformation(
              extent={{-8,-8},{8,8}},
              rotation=180,
              origin={-60,80})));
        OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
          enableV_b=true,
          v_0=powerFlow.powerflow.bus.V1,
          angle_0=powerFlow.powerflow.bus.A1,
          P_0=powerFlow.powerflow.machines.PG1,
          Q_0=powerFlow.powerflow.machines.QG1,
          V_b=6000)  if not equivalentGRID
          annotation (Placement(transformation(extent={{-112,70},{-92,90}})));
        OpenIPSL.Electrical.Branches.PwLine L1(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{-26,76},
                  {-14,84}})));
        OpenIPSL.Electrical.Buses.Bus Bus3(v_0=powerFlow.powerflow.bus.V3, angle_0=
              powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-10,70},{10,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus4(v_0=powerFlow.powerflow.bus.V4, angle_0=
              powerFlow.powerflow.bus.V4) if not equivalentGRID
          annotation (Placement(transformation(extent={{50,70},{70,90}})));
        OpenIPSL.Electrical.Branches.PwLine L2_1(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,86},
                  {36,94}})));
        OpenIPSL.Electrical.Branches.PwLine L2_2(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,66},
                  {36,74}})));
        OpenIPSL.Electrical.Buses.Bus Bus5(angle_0=powerFlow.powerflow.bus.A5, v_0=
              powerFlow.powerflow.bus.V5)  annotation (Placement(
              transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={80,16})));
        OpenIPSL.Electrical.Branches.PwLine L3(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=-90,
              origin={80,60})));
        OpenIPSL.Electrical.Buses.Bus Bus6(v_0=powerFlow.powerflow.bus.V6, angle_0=
              powerFlow.powerflow.bus.A6) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,10})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000,
          R=0.005,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={10,10})));
        GenerationUnits.PSSE.G2_16MVA                         G2(
          enableV_b=true,
          enableP_0=true,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V6,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A6,
          V_b=6000,
          P_0=powerFlow.powerflow.machines.PG2,
          Q_0=powerFlow.powerflow.machines.QG2,
          enableangle_0=true)
                        annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-30,10})));
        inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000, fn=60)
          annotation (Placement(transformation(extent={{-128,104},{-74,124}})));
        OpenIPSL.Electrical.Loads.PSSE.Load Load1(
          V_b=220000,
          P_0=powerFlow.powerflow.loads.PL1,
          Q_0=powerFlow.powerflow.loads.QL1,
          v_0=powerFlow.powerflow.bus.V3,
          angle_0=powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-20,48},{0,68}})));
        Electrical.Events.Breaker breaker(enableTrigger=false,
          t_o=1.01,
          rc_enabled=true,
          t_rc=10000)       if not equivalentGRID                     annotation (Placement(transformation(
              extent={{-4,-4},{4,4}},
              rotation=90,
              origin={80,26})));

        PFData.PowerFlow powerFlow(redeclare record PowerFlow =
              OpenIPSL.Examples.ModelPredictiveControl.PFData.PF16)
          annotation (Placement(transformation(extent={{-68,104},{-48,124}})));
        Electrical.Machines.PSSE.GENCLS IB(
          V_b=220000,
          v_0=powerFlow.powerflow.bus.V4,
          angle_0=powerFlow.powerflow.bus.A4,
          P_0=powerFlow.powerflow.machines.Pinf,
          Q_0=powerFlow.powerflow.machines.Qinf,
          M_b=100000000,
          X_d=1) if not equivalentGRID annotation (Placement(transformation(extent={{110,70},
                  {100,90}})));
        Electrical.Loads.PSSE.Load_ExtInput Load2(
          P_0=powerFlow.powerflow.loads.PL2,
          Q_0=powerFlow.powerflow.loads.QL2,
          v_0=powerFlow.powerflow.bus.V5,
          angle_0=powerFlow.powerflow.bus.A5,
          d_P=0,
          t1=100,
          d_t=1000)
          annotation (Placement(transformation(extent={{100,-30},{120,-10}})));

        inner Modelica.Blocks.Noise.GlobalSeed globalSeed(useAutomaticSeed=false,
            fixedSeed=10000)
          annotation (Placement(transformation(extent={{-42,102},{-22,122}})));

        Electrical.Buses.Bus Bus10(v_0=powerFlow.powerflow.bus.V10, angle_0=powerFlow.powerflow.bus.A10)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,-90})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T4(
          G=0,
          B=0,
          CW=1,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={10,-90})));
        GenerationUnits.PSSE.Solar_Units.SolarMPCLocalVQControl_OBSERVABILITY
                                                                PV(
          V_b=480,
          P_0=powerFlow.powerflow.machines.PPV,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QPV,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V8,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A8,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-60},{-20,-40}})));

        GenerationUnits.PSSE.Battery_Units.BESSMPCLocalVQControlLinearized_OBSERVABILITY
                                                                 BESS(
          V_base=480,
          V_b(displayUnit="kV") = 480,
          enableV_b=true,
          P_0=powerFlow.powerflow.machines.PBESS,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QBESS,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V10,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A10,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-100},{-20,-80}})));
        Electrical.Buses.Bus Bus8(v_0=powerFlow.powerflow.bus.V8, angle_0=powerFlow.powerflow.bus.A8)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,-50})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T3(
          G=0,
          B=0,
          CW=1,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={12,-50})));
        Electrical.Buses.Bus Bus11(v_0=powerFlow.powerflow.bus.V11, angle_0=powerFlow.powerflow.bus.A11)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,-90})));
        Electrical.Buses.Bus Bus9(v_0=powerFlow.powerflow.bus.V9, angle_0=powerFlow.powerflow.bus.A9)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,-50})));
        Electrical.Buses.Bus Bus7(v_0=powerFlow.powerflow.bus.V7, angle_0=powerFlow.powerflow.bus.A7)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,10})));
        Electrical.Branches.PwLine          L4(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,6},{
                  50,14}})));
        Electrical.Branches.PwLine          L5(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,-54},
                  {50,-46}})));
        Electrical.Branches.PwLine          L6(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,-94},
                  {50,-86}})));
        Modelica.Blocks.Sources.Sine sine(
          amplitude=0,
          f=1/260,
          phase=3.1415926535898,
          startTime=1000)
          annotation (Placement(transformation(extent={{68,-36},{78,-26}})));
        Electrical.Loads.NoiseInjections.WhiteNoiseInjection whiteNoiseInjection(
            active_sigma=0.0000000001, samplePeriod=0.01)
          annotation (Placement(transformation(extent={{66,-18},{78,-6}})));
        Modelica.Blocks.Math.Add add
          annotation (Placement(transformation(extent={{84,-18},{92,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT1
          annotation (Placement(transformation(extent={{140,80},{160,100}})));
        Modelica.Blocks.Interfaces.RealOutput OUT6
          annotation (Placement(transformation(extent={{140,-20},{160,0}})));
        Modelica.Blocks.Interfaces.RealOutput OUT7
          annotation (Placement(transformation(extent={{140,-40},{160,-20}})));
        Modelica.Blocks.Interfaces.RealOutput OUT8
          annotation (Placement(transformation(extent={{140,-60},{160,-40}})));
        Modelica.Blocks.Interfaces.RealOutput OUT9
          annotation (Placement(transformation(extent={{140,-80},{160,-60}})));
        Modelica.Blocks.Interfaces.RealOutput OUT10
          annotation (Placement(transformation(extent={{140,-100},{160,-80}})));
        Modelica.Blocks.Interfaces.RealOutput OUT11
          annotation (Placement(transformation(extent={{164,80},{184,100}})));
        Modelica.Blocks.Interfaces.RealOutput OUT12
          annotation (Placement(transformation(extent={{164,60},{184,80}})));
        Modelica.Blocks.Interfaces.RealOutput OUT13
          annotation (Placement(transformation(extent={{164,40},{184,60}})));
        Modelica.Blocks.Interfaces.RealOutput OUT14
          annotation (Placement(transformation(extent={{164,20},{184,40}})));
        Modelica.Blocks.Interfaces.RealOutput OUT15
          annotation (Placement(transformation(extent={{164,0},{184,20}})));
        Modelica.Blocks.Interfaces.RealOutput OUT16
          annotation (Placement(transformation(extent={{164,-20},{184,0}})));
        Modelica.Blocks.Interfaces.RealOutput OUT17
          annotation (Placement(transformation(extent={{164,-40},{184,-20}})));
        Modelica.Blocks.Interfaces.RealOutput OUT18
          annotation (Placement(transformation(extent={{164,-60},{184,-40}})));
        Modelica.Blocks.Interfaces.RealOutput OUT19
          annotation (Placement(transformation(extent={{164,-80},{184,-60}})));
        Modelica.Blocks.Interfaces.RealOutput OUT20
          annotation (Placement(transformation(extent={{164,-100},{184,-80}})));
        Modelica.Blocks.Interfaces.RealOutput OUT21
          annotation (Placement(transformation(extent={{186,80},{206,100}})));
        Modelica.Blocks.Interfaces.RealOutput OUT22
          annotation (Placement(transformation(extent={{186,60},{206,80}})));
        Modelica.Blocks.Interfaces.RealOutput OUT23
          annotation (Placement(transformation(extent={{186,40},{206,60}})));
        Modelica.Blocks.Interfaces.RealOutput OUT24
          annotation (Placement(transformation(extent={{186,20},{206,40}})));
        Modelica.Blocks.Interfaces.RealOutput OUT25
          annotation (Placement(transformation(extent={{186,0},{206,20}})));
        Modelica.Blocks.Interfaces.RealOutput OUT26
          annotation (Placement(transformation(extent={{186,-20},{206,0}})));
        Modelica.Blocks.Interfaces.RealOutput OUT27
          annotation (Placement(transformation(extent={{186,-40},{206,-20}})));
        Modelica.Blocks.Interfaces.RealOutput OUT28
          annotation (Placement(transformation(extent={{186,-60},{206,-40}})));
        Modelica.Blocks.Interfaces.RealOutput OUT29
          annotation (Placement(transformation(extent={{186,-80},{206,-60}})));
        Modelica.Blocks.Interfaces.RealOutput OUT30
          annotation (Placement(transformation(extent={{186,-100},{206,-80}})));
        Modelica.Blocks.Interfaces.RealOutput OUT31
          annotation (Placement(transformation(extent={{212,80},{232,100}})));
        Modelica.Blocks.Interfaces.RealOutput OUT32
          annotation (Placement(transformation(extent={{212,60},{232,80}})));
        Modelica.Blocks.Interfaces.RealOutput OUT33
          annotation (Placement(transformation(extent={{212,40},{232,60}})));
        Modelica.Blocks.Interfaces.RealOutput OUT34
          annotation (Placement(transformation(extent={{212,20},{232,40}})));
        Modelica.Blocks.Interfaces.RealOutput OUT35
          annotation (Placement(transformation(extent={{212,0},{232,20}})));
        Modelica.Blocks.Interfaces.RealOutput OUT36
          annotation (Placement(transformation(extent={{212,-20},{232,0}})));
        Modelica.Blocks.Interfaces.RealOutput OUT37
          annotation (Placement(transformation(extent={{212,-40},{232,-20}})));
        Modelica.Blocks.Interfaces.RealOutput OUT38
          annotation (Placement(transformation(extent={{212,-60},{232,-40}})));
        Modelica.Blocks.Interfaces.RealOutput OUT39
          annotation (Placement(transformation(extent={{254,-54},{274,-34}})));
        Modelica.Blocks.Interfaces.RealOutput OUT40
          annotation (Placement(transformation(extent={{254,-74},{274,-54}})));
        Modelica.Blocks.Interfaces.RealOutput OUT41
          annotation (Placement(transformation(extent={{254,-94},{274,-74}})));
        Modelica.Blocks.Interfaces.RealOutput OUT42
          annotation (Placement(transformation(extent={{254,-114},{274,-94}})));
        Modelica.Blocks.Interfaces.RealOutput OUT43
          annotation (Placement(transformation(extent={{254,-134},{274,-114}})));
        Modelica.Blocks.Interfaces.RealOutput OUT44
          annotation (Placement(transformation(extent={{254,-154},{274,-134}})));
        Modelica.Blocks.Sources.CombiTimeTable combiTimeTable(table=[0,0; 0.5,0; 0.51,
              0.1; 5,0.1], smoothness=Modelica.Blocks.Types.Smoothness.ConstantSegments)
          annotation (Placement(transformation(extent={{-130,0},{-110,20}})));
        Modelica.Blocks.Sources.CombiTimeTable combiTimeTable1(table=[0,0; 0.5,0; 0.51,
              0.1; 5,0.1], smoothness=Modelica.Blocks.Types.Smoothness.ConstantSegments)
          annotation (Placement(transformation(extent={{-130,-26},{-110,-6}})));
        Modelica.Blocks.Sources.CombiTimeTable combiTimeTable2(table=[0,0; 0.5,0; 0.51,
              0.1; 5,0.1], smoothness=Modelica.Blocks.Types.Smoothness.ConstantSegments)
          annotation (Placement(transformation(extent={{-130,-54},{-110,-34}})));
        Modelica.Blocks.Sources.CombiTimeTable combiTimeTable3(table=[0,0; 0.5,0; 0.51,
              0.1; 5,0.1], smoothness=Modelica.Blocks.Types.Smoothness.ConstantSegments)
          annotation (Placement(transformation(extent={{-130,-100},{-110,-80}})));
        Modelica.Blocks.Sources.CombiTimeTable combiTimeTable4(table=[0,0; 0.5,0; 0.51,
              0.1; 5,0.1], smoothness=Modelica.Blocks.Types.Smoothness.ConstantSegments)
          annotation (Placement(transformation(extent={{-130,-126},{-110,-106}})));
      equation

      OUT1 = G2.gen.w;
      // OUT2 = G2.gen.delta;
      // OUT3 = G2.gen.Epq;
      // OUT4 = G2.gen.PSIkd;
      // OUT5 = G2.gen.PSIppq;
      OUT6 = G2.sEXSMPC.simpleLagLim.state;
      OUT7 = G2.sEXSMPC.leadLag.TF.x_scaled[1];
      OUT8 = G2.gASTMPC.simpleLagLim.state;
      OUT9 = G2.gASTMPC.simpleLag.state;
      OUT10 = G2.gASTMPC.simpleLag1.state;
      OUT11 = PV.rEGCA1_OBSERVABILITY.simpleLag.state;
      OUT12 = PV.rEGCA1_OBSERVABILITY.simpleLag1.state;
      OUT13 = PV.rEGCA1_OBSERVABILITY.simpleLag2.state;
      OUT14 = PV.EC.simpleLag.state;
      OUT15 = PV.EC.simpleLag3.state;
      OUT16 = PV.EC.simpleLag1.state;
      OUT17 = PV.EC.simpleLag2.state;
      OUT18 = PV.EC.PI.x;
      OUT19 = PV.EC.PI1.x;
      OUT20 = PV.EC.PI2.x;
      OUT21 = BESS.rEGCA1_OBSERVABILITY.simpleLag.state;
      OUT22 = BESS.rEGCA1_OBSERVABILITY.simpleLag1.state;
      OUT23 = BESS.rEGCA1_OBSERVABILITY.simpleLag2.state;
      OUT24 = BESS.EC.simpleLag.state;
      OUT25 = BESS.EC.simpleLag2.state;
      OUT26 = BESS.EC.simpleLag3.state;
      OUT27 = BESS.EC.PI.x;
      OUT28 = BESS.EC.PI1.x;
      OUT29 = BESS.EC.simpleLag1.state;
      OUT30 = BESS.EC.PI2.x;
      OUT31 = Bus5.v;
      OUT32 = Bus5.angle;
      OUT33 = Bus6.v;
      OUT34 = Bus6.angle;
      OUT35 = Bus8.v;
      OUT36 = Bus8.angle;
      OUT37 = Bus10.v;
      OUT38 = Bus10.angle;
      OUT39 = G2.gen.P;
      OUT40 = G2.gen.Q;
      OUT41 = PV.rEGCA1_OBSERVABILITY.Pgen;
      OUT42 = PV.rEGCA1_OBSERVABILITY.Qgen;
      OUT43 = BESS.rEGCA1_OBSERVABILITY.Pgen;
      OUT44 = BESS.rEGCA1_OBSERVABILITY.Qgen;

      // OUT1 = G2.gen.w;
      // OUT2 = G2.gen.delta;
      // OUT3 = G2.gen.Epq;
      // OUT4 = G2.gen.PSIkd;
      // OUT5 = G2.gen.PSIppq;
      // OUT6 = G2.sEXSMPC.simpleLagLim.state;
      // OUT7 = G2.sEXSMPC.leadLag.TF.x_scaled[1];
      // OUT8 = G2.gASTMPC.simpleLagLim.state;
      // OUT9 = G2.gASTMPC.simpleLag.state;
      // OUT10 = G2.gASTMPC.simpleLag1.state;
      // OUT11 = PV.rEGCA1_OBSERVABILITY.simpleLag.state;
      // OUT12 = PV.rEGCA1_OBSERVABILITY.simpleLag1.state;
      // OUT13 = PV.rEGCA1_OBSERVABILITY.simpleLag2.state;
      // OUT14 = PV.EC.simpleLag.state;
      // OUT15 = PV.EC.simpleLag3.state;
      // OUT16 = PV.EC.simpleLag1.state;
      // OUT17 = PV.EC.simpleLag2.state;
      // OUT18 = PV.EC.PI.x;
      // OUT19 = PV.EC.PI1.x;
      // OUT20 = PV.EC.PI2.x;
      // OUT21 = BESS.rEGCA1_1.simpleLag.state;
      // OUT22 = BESS.rEGCA1_1.integrator.y;
      // OUT23 = BESS.rEGCA1_1.integrator1.y;
      // OUT24 = BESS.EC.integrator3.y;
      // OUT25 = BESS.EC.simpleLag.state;
      // OUT26 = BESS.EC.IGQ.y;
      // OUT27 = BESS.EC.IGV.y;
      // OUT28 = BESS.EC.IGP.y;
      // OUT29 = BESS.EC.simpleLag1.state;
      // OUT30 = BESS.EC.simpleLag2.state;
      // OUT31 = BESS.EC.simpleLag3.state;
      // OUT32 = BESS.EC.simpleLag4.state;

        connect(T1.p, Bus2.p)
          annotation (Line(points={{-51.2,80},{-40,80}}, color={0,0,255}));
        connect(Bus1.p, T1.n)
          annotation (Line(points={{-80,80},{-68.8,80}}, color={0,0,255}));
        connect(G1.conn, Bus1.p)
          annotation (Line(points={{-91,80},{-80,80}}, color={0,0,255}));
        connect(L1.n, Bus3.p)
          annotation (Line(points={{-14.6,80},{0,80}}, color={0,0,255}));
        connect(L1.p, Bus2.p)
          annotation (Line(points={{-25.4,80},{-40,80}}, color={0,0,255}));
        connect(L2_2.n, Bus4.p) annotation (Line(points={{35.4,70},{44,70},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.n, Bus4.p) annotation (Line(points={{35.4,90},{44,90},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.p, Bus3.p) annotation (Line(points={{24.6,90},{16,90},{16,80},{0,
                80}}, color={0,0,255}));
        connect(L2_2.p, Bus3.p) annotation (Line(points={{24.6,70},{16,70},{16,80},{0,
                80}}, color={0,0,255}));
        connect(Load1.p, Bus3.p)
          annotation (Line(points={{-10,68},{-10,80},{0,80}}, color={0,0,255}));
        connect(L3.p, Bus4.p)
          annotation (Line(points={{80,65.4},{80,80},{60,80}}, color={0,0,255}));
        connect(breaker.s, Bus5.p)
          annotation (Line(points={{80,22},{80,16}},color={0,0,255}));
        connect(breaker.r, L3.n)
          annotation (Line(points={{80,30},{80,54.6}},color={0,0,255}));

        connect(IB.p, Bus4.p)
          annotation (Line(points={{100,80},{60,80}}, color={0,0,255}));
        connect(Load2.p, Bus5.p) annotation (Line(points={{110,-10},{110,10},{80,10},{
                80,16}},
                     color={0,0,255}));
        connect(T4.n, Bus10.p)
          annotation (Line(points={{-1,-90},{-10,-90}}, color={0,0,255}));
        connect(Bus6.p, T2.n)
          annotation (Line(points={{-10,10},{-1,10}},
                                                  color={0,0,255}));
        connect(BESS.p1, Bus10.p)
          annotation (Line(points={{-20,-90},{-10,-90}}, color={0,0,255}));
        connect(G2.conn, Bus6.p) annotation (Line(points={{-19,10},{-10,10}},
                                           color={0,0,255}));
        connect(PV.p1, Bus8.p)
          annotation (Line(points={{-20,-50},{-10,-50}}, color={0,0,255}));
        connect(Bus8.p, T3.n)
          annotation (Line(points={{-10,-50},{1,-50}},  color={0,0,255}));
        connect(T2.p, Bus7.p) annotation (Line(points={{21,10},{25.5,10},{25.5,10},{30,
                10}}, color={0,0,255}));
        connect(T3.p, Bus9.p)
          annotation (Line(points={{23,-50},{30,-50}}, color={0,0,255}));
        connect(T4.p, Bus11.p)
          annotation (Line(points={{21,-90},{30,-90}}, color={0,0,255}));
        connect(L4.n, Bus5.p) annotation (Line(points={{49.4,10},{60,10},{60,10},{80,10},
                {80,16}},     color={0,0,255}));
        connect(L5.n, Bus5.p) annotation (Line(points={{49.4,-50},{60,-50},{60,10},{80,
                10},{80,16}}, color={0,0,255}));
        connect(Bus11.p, L6.p)
          annotation (Line(points={{30,-90},{38.6,-90}}, color={0,0,255}));
        connect(Bus9.p, L5.p)
          annotation (Line(points={{30,-50},{38.6,-50}}, color={0,0,255}));
        connect(L6.n, Bus5.p) annotation (Line(points={{49.4,-90},{60,-90},{60,10},{80,
                10},{80,16}}, color={0,0,255}));
        connect(Bus7.p, L4.p) annotation (Line(points={{30,10},{34.3,10},{34.3,10},{38.6,
                10}}, color={0,0,255}));
        connect(sine.y, add.u2) annotation (Line(points={{78.5,-31},{78.5,-16.4},
                {83.2,-16.4}}, color={0,0,127}));
        connect(whiteNoiseInjection.y, add.u1) annotation (Line(points={{78.54,
                -12.06},{80.87,-12.06},{80.87,-11.6},{83.2,-11.6}}, color={0,0,
                127}));
        connect(add.y, Load2.u) annotation (Line(points={{92.4,-14},{97.15,-14},
                {97.15,-14.5},{101.9,-14.5}}, color={0,0,127}));
        connect(combiTimeTable.y[1], G2.P_ref1) annotation (Line(points={{-109,10},{-52,
                10},{-52,16},{-42,16}}, color={0,0,127}));
        connect(combiTimeTable1.y[1], G2.Efd_ref) annotation (Line(points={{-109,-16},
                {-50,-16},{-50,4},{-42,4}}, color={0,0,127}));
        connect(combiTimeTable2.y[1], PV.QINPUT) annotation (Line(points={{-109,-44},{
                -52,-44},{-52,-50},{-42,-50}}, color={0,0,127}));
        connect(combiTimeTable3.y[1], BESS.Paux1) annotation (Line(points={{-109,-90},
                {-52,-90},{-52,-84},{-42,-84}}, color={0,0,127}));
        connect(combiTimeTable4.y[1], BESS.Qext1) annotation (Line(points={{-109,-116},
                {-50,-116},{-50,-96},{-42,-96}}, color={0,0,127}));
          annotation (Placement(transformation(extent={{140,-20},{160,0}})),
                      Placement(transformation(extent={{140,-40},{160,-20}})),
                      Placement(transformation(extent={{140,-60},{160,-40}})),
                      Placement(transformation(extent={{140,-80},{160,-60}})),
                     Diagram(coordinateSystem(preserveAspectRatio=false,
                extent={{-140,-140},{140,140}}), graphics={
              Rectangle(
                extent={{-128,98},{124,38}},
                lineColor={0,128,255},
                lineThickness=0.5),
              Text(
                extent={{78,-106},{114,-120}},
                textColor={238,46,47},
                textString="Microgrid"),
              Text(
                extent={{76,58},{128,34}},
                textColor={28,108,200},
                textString="Utility Grid"),
              Text(
                extent={{-30,-102},{34,-124}},
                textColor={0,140,72},
                textString="Linearization Unit")}),
          Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),experiment(StopTime=10, __Dymola_Algorithm="Dassl"),
          Icon(coordinateSystem(extent={{-140,-140},{140,140}})));
      end MPCAppliedEnergyLinearized_test2_table;

      model MPCAppliedEnergyLinearized_test2_LINEAR
        "THIS ONE IS STABLE, CONTROLLABLE, OBSERVABLE!!!!!!!"
        extends Modelica.Icons.Example;

        import Modelica_LinearSystems2.StateSpace;
        parameter Real[:] y0 = vector(DataFiles.readMATmatrix("MyData.mat", "y0")) annotation(Evaluate = false);
        parameter StateSpace ss=StateSpace.Import.fromFile("MyData.mat", "ABCD");
        parameter Boolean equivalentGRID = true;
        parameter Boolean equivalentsystem = false;
        parameter Integer ny=size(ss.C,1);

        Modelica.Blocks.Interfaces.RealInput IN1(start=0)
          "Connector of Real input signal 2" annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-150,10}),iconTransformation(extent={{-10,-10},{10,10}}, origin={-150,10})));
        Modelica.Blocks.Sources.Constant IN11(k=0)
          annotation (Placement(transformation(extent={{-108,-2},{-96,10}})));
        Modelica.Blocks.Math.Add AddU1
          annotation (Placement(transformation(extent={{-80,0},{-60,20}})));
        Modelica.Blocks.Sources.Constant IN22(k=0)
          annotation (Placement(transformation(extent={{-108,-32},{-96,-20}})));
        Modelica.Blocks.Math.Add AddU2
          annotation (Placement(transformation(extent={{-80,-30},{-60,-10}})));
        Modelica.Blocks.Interfaces.RealInput IN2(start=0)
          "Connector of Real input signal 2"
                 annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-150,-12}), iconTransformation(extent={{-10,-10},{10,10}},
                origin={-150,-12})));

        Modelica.Blocks.Interfaces.RealInput IN3(start = 0) "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-44},{-140,-24}}),
              iconTransformation(extent={{-160,-44},{-140,-24}})));
        Modelica.Blocks.Interfaces.RealInput IN4(start = 0) "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-66},{-140,-46}}),
              iconTransformation(extent={{-160,-66},{-140,-46}})));
        Modelica.Blocks.Interfaces.RealInput IN5(start = 0) "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-88},{-140,-68}}),
              iconTransformation(extent={{-160,-88},{-140,-68}})));

        Modelica.Blocks.Math.Add AddU3
          annotation (Placement(transformation(extent={{-80,-60},{-60,-40}})));
        Modelica.Blocks.Sources.Constant IN33(k=0)
          annotation (Placement(transformation(extent={{-108,-62},{-96,-50}})));

        Modelica.Blocks.Math.Add AddU4
          annotation (Placement(transformation(extent={{-80,-90},{-60,-70}})));
        Modelica.Blocks.Math.Add AddU5
          annotation (Placement(transformation(extent={{-80,-116},{-60,-96}})));
        Modelica.Blocks.Sources.Constant IN44(k=0)
          annotation (Placement(transformation(extent={{-108,-92},{-96,-80}})));
        Modelica.Blocks.Sources.Constant IN55(k=0)
          annotation (Placement(transformation(extent={{-108,-118},{-96,-106}})));
        PFData.PowerFlow powerFlow(redeclare record PowerFlow = PFData.PF16)
          annotation (Placement(transformation(extent={{-116,106},{-96,126}})));
        Modelica.Blocks.Interfaces.RealOutput OUT1
          annotation (Placement(transformation(extent={{146,68},{166,88}})));
       Modelica.Blocks.Interfaces.RealOutput OUT2
          annotation (Placement(transformation(extent={{146,48},{166,68}})));
        Modelica.Blocks.Interfaces.RealOutput OUT3
          annotation (Placement(transformation(extent={{146,28},{166,48}})));
        Modelica.Blocks.Interfaces.RealOutput OUT4
          annotation (Placement(transformation(extent={{146,8},{166,28}})));
        Modelica.Blocks.Interfaces.RealOutput OUT5
          annotation (Placement(transformation(extent={{146,-12},{166,8}})));
        Modelica.Blocks.Interfaces.RealOutput OUT6
          annotation (Placement(transformation(extent={{146,-32},{166,-12}})));
        Modelica.Blocks.Interfaces.RealOutput OUT7
          annotation (Placement(transformation(extent={{146,-52},{166,-32}})));
        Modelica.Blocks.Interfaces.RealOutput OUT8
          annotation (Placement(transformation(extent={{146,-72},{166,-52}})));
        Modelica.Blocks.Interfaces.RealOutput OUT9
          annotation (Placement(transformation(extent={{146,-92},{166,-72}})));
        Modelica.Blocks.Interfaces.RealOutput OUT10
          annotation (Placement(transformation(extent={{146,-112},{166,-92}})));
        Modelica.Blocks.Interfaces.RealOutput OUT11
          annotation (Placement(transformation(extent={{170,68},{190,88}})));
        Modelica.Blocks.Interfaces.RealOutput OUT12
          annotation (Placement(transformation(extent={{170,48},{190,68}})));
        Modelica.Blocks.Interfaces.RealOutput OUT13
          annotation (Placement(transformation(extent={{170,28},{190,48}})));
        Modelica.Blocks.Interfaces.RealOutput OUT14
          annotation (Placement(transformation(extent={{170,8},{190,28}})));
        Modelica.Blocks.Interfaces.RealOutput OUT15
          annotation (Placement(transformation(extent={{170,-12},{190,8}})));
        Modelica.Blocks.Interfaces.RealOutput OUT16
          annotation (Placement(transformation(extent={{170,-32},{190,-12}})));
        Modelica.Blocks.Interfaces.RealOutput OUT17
          annotation (Placement(transformation(extent={{170,-52},{190,-32}})));
        Modelica.Blocks.Interfaces.RealOutput OUT18
          annotation (Placement(transformation(extent={{170,-72},{190,-52}})));
        Modelica.Blocks.Interfaces.RealOutput OUT19
          annotation (Placement(transformation(extent={{170,-92},{190,-72}})));
        Modelica.Blocks.Interfaces.RealOutput OUT20
          annotation (Placement(transformation(extent={{170,-112},{190,-92}})));
        Modelica.Blocks.Interfaces.RealOutput OUT21
          annotation (Placement(transformation(extent={{190,68},{210,88}})));
        Modelica.Blocks.Interfaces.RealOutput OUT22
          annotation (Placement(transformation(extent={{190,48},{210,68}})));
        Modelica.Blocks.Interfaces.RealOutput OUT23
          annotation (Placement(transformation(extent={{190,28},{210,48}})));
        Modelica.Blocks.Interfaces.RealOutput OUT24
          annotation (Placement(transformation(extent={{190,8},{210,28}})));
        Modelica.Blocks.Interfaces.RealOutput OUT25
          annotation (Placement(transformation(extent={{190,-12},{210,8}})));
        Modelica.Blocks.Interfaces.RealOutput OUT26
          annotation (Placement(transformation(extent={{190,-32},{210,-12}})));
        Modelica.Blocks.Interfaces.RealOutput OUT27
          annotation (Placement(transformation(extent={{190,-52},{210,-32}})));
        Modelica.Blocks.Interfaces.RealOutput OUT28
          annotation (Placement(transformation(extent={{190,-72},{210,-52}})));
        Modelica.Blocks.Interfaces.RealOutput OUT29
          annotation (Placement(transformation(extent={{190,-92},{210,-72}})));
        Modelica.Blocks.Interfaces.RealOutput OUT30
          annotation (Placement(transformation(extent={{190,-112},{210,-92}})));
        Modelica.Blocks.Interfaces.RealOutput OUT31
          annotation (Placement(transformation(extent={{210,68},{230,88}})));
        Modelica.Blocks.Interfaces.RealOutput OUT32
          annotation (Placement(transformation(extent={{210,48},{230,68}})));
        Modelica.Blocks.Interfaces.RealOutput OUT33
          annotation (Placement(transformation(extent={{210,28},{230,48}})));
        Modelica.Blocks.Interfaces.RealOutput OUT34
          annotation (Placement(transformation(extent={{210,8},{230,28}})));
        Modelica_LinearSystems2.Controller.StateSpace stateSpace(system=ss)
          annotation (Placement(transformation(extent={{0,-10},{20,10}})));
        Modelica.Blocks.Routing.Multiplex5 multiplex5_1
          annotation (Placement(transformation(extent={{-40,-50},{-20,-30}})));
        Modelica.Blocks.Routing.DeMultiplex demux(n=34)
          annotation (Placement(transformation(extent={{30,-10},{50,10}})));
        Modelica.Blocks.Math.Add add
          annotation (Placement(transformation(extent={{20,-50},{40,-30}})));
        Modelica.Blocks.Sources.Constant const(k=y0)
          annotation (Placement(transformation(extent={{-28,-90},{-8,-70}})));
      equation


        connect(IN11.y, AddU1.u2) annotation (Line(points={{-95.4,4},{-82,4}},
                            color={0,0,127}));
        connect(IN1, AddU1.u1) annotation (Line(points={{-150,10},{-116,10},{-116,16},
                {-82,16}},
                       color={0,0,127}));

        connect(IN22.y,AddU2. u2) annotation (Line(points={{-95.4,-26},{-82,-26}},
                       color={0,0,127}));
        connect(IN2,AddU2. u1) annotation (Line(points={{-150,-12},{-118,-12},{-118,-14},
                {-82,-14}},
                       color={0,0,127}));
        connect(IN33.y,AddU3. u2)
          annotation (Line(points={{-95.4,-56},{-82,-56}}, color={0,0,127}));
        connect(IN55.y, AddU5.u2)
          annotation (Line(points={{-95.4,-112},{-82,-112}}, color={0,0,127}));
        connect(IN44.y, AddU4.u2)
          annotation (Line(points={{-95.4,-86},{-82,-86}}, color={0,0,127}));
        connect(AddU4.u1,IN4)  annotation (Line(points={{-82,-74},{-100,-74},{-100,-70},
                {-116,-70},{-116,-56},{-150,-56}}, color={0,0,127}));
        connect(AddU5.u1,IN5)  annotation (Line(points={{-82,-100},{-116,-100},{-116,-78},
                {-150,-78}}, color={0,0,127}));
        connect(AddU3.u1, IN3) annotation (Line(points={{-82,-44},{-118,-44},{-118,-34},
                {-150,-34}}, color={0,0,127}));
        connect(AddU1.y, multiplex5_1.u1[1]) annotation (Line(points={{-59,10},{-50,10},
                {-50,-30},{-42,-30}}, color={0,0,127}));
        connect(AddU2.y, multiplex5_1.u2[1]) annotation (Line(points={{-59,-20},{-52,-20},
                {-52,-35},{-42,-35}}, color={0,0,127}));
        connect(AddU3.y, multiplex5_1.u3[1]) annotation (Line(points={{-59,-50},{-52,-50},
                {-52,-40},{-42,-40}}, color={0,0,127}));
        connect(AddU4.y, multiplex5_1.u4[1]) annotation (Line(points={{-59,-80},{-50,-80},
                {-50,-45},{-42,-45}}, color={0,0,127}));
        connect(AddU5.y, multiplex5_1.u5[1]) annotation (Line(points={{-59,-106},{-48,
                -106},{-48,-50},{-42,-50}}, color={0,0,127}));
        connect(multiplex5_1.y, stateSpace.u) annotation (Line(points={{-19,-40},{-16,
                -40},{-16,0},{-2,0}}, color={0,0,127}));
        connect(demux.y[1], OUT1) annotation (Line(points={{50,-3.39706},{64,-3.39706},
                {64,78},{156,78}}, color={0,0,127}));
        connect(OUT2, demux.y[2]) annotation (Line(points={{156,58},{64,58},{64,-3.19118},
                {50,-3.19118}}, color={0,0,127}));
        connect(OUT3, demux.y[3]) annotation (Line(points={{156,38},{64,38},{64,-2.98529},
                {50,-2.98529}}, color={0,0,127}));
        connect(OUT4, demux.y[4]) annotation (Line(points={{156,18},{64,18},{64,-2.77941},
                {50,-2.77941}}, color={0,0,127}));
        connect(OUT5, demux.y[5]) annotation (Line(points={{156,-2},{58,-2},{58,-2.57353},
                {50,-2.57353}}, color={0,0,127}));
        connect(OUT6, demux.y[6]) annotation (Line(points={{156,-22},{64,-22},{64,-2.36765},
                {50,-2.36765}}, color={0,0,127}));
        connect(OUT7, demux.y[7]) annotation (Line(points={{156,-42},{64,-42},{64,-2.16176},
                {50,-2.16176}}, color={0,0,127}));
        connect(OUT8, demux.y[8]) annotation (Line(points={{156,-62},{64,-62},{64,-1.95588},
                {50,-1.95588}}, color={0,0,127}));
        connect(OUT9, demux.y[9]) annotation (Line(points={{156,-82},{64,-82},{64,-1.75},
                {50,-1.75}}, color={0,0,127}));
        connect(OUT10, demux.y[10]) annotation (Line(points={{156,-102},{64,-102},{64,
                -1.54412},{50,-1.54412}}, color={0,0,127}));
        connect(OUT11, demux.y[11]) annotation (Line(points={{180,78},{176,78},{176,106},
                {44,106},{44,-1.33824},{50,-1.33824}}, color={0,0,127}));
        connect(OUT12, demux.y[12]) annotation (Line(points={{180,58},{64,58},{64,-1.13235},
                {50,-1.13235}}, color={0,0,127}));
        connect(OUT13, demux.y[13]) annotation (Line(points={{180,38},{64,38},{64,-0.926471},
                {50,-0.926471}}, color={0,0,127}));
        connect(OUT14, demux.y[14]) annotation (Line(points={{180,18},{64,18},{64,-0.720588},
                {50,-0.720588}}, color={0,0,127}));
        connect(OUT15, demux.y[15]) annotation (Line(points={{180,-2},{64,-2},{64,-0.514706},
                {50,-0.514706}}, color={0,0,127}));
        connect(OUT16, demux.y[16]) annotation (Line(points={{180,-22},{64,-22},{64,-0.308824},
                {50,-0.308824}}, color={0,0,127}));
        connect(OUT17, demux.y[17]) annotation (Line(points={{180,-42},{64,-42},{64,-0.102941},
                {50,-0.102941}}, color={0,0,127}));
        connect(OUT18, demux.y[18]) annotation (Line(points={{180,-62},{64,-62},{64,0.102941},
                {50,0.102941}}, color={0,0,127}));
        connect(OUT19, demux.y[19]) annotation (Line(points={{180,-82},{64,-82},{64,0.308824},
                {50,0.308824}}, color={0,0,127}));
        connect(OUT20, demux.y[20]) annotation (Line(points={{180,-102},{64,-102},{64,
                0.514706},{50,0.514706}}, color={0,0,127}));
        connect(OUT21, demux.y[21]) annotation (Line(points={{200,78},{176,78},{176,106},
                {44,106},{44,0.720588},{50,0.720588}}, color={0,0,127}));
        connect(OUT22, demux.y[22]) annotation (Line(points={{200,58},{64,58},{64,0.926471},
                {50,0.926471}}, color={0,0,127}));
        connect(OUT23, demux.y[23]) annotation (Line(points={{200,38},{64,38},{64,1.13235},
                {50,1.13235}}, color={0,0,127}));
        connect(OUT24, demux.y[24]) annotation (Line(points={{200,18},{64,18},{64,1.33824},
                {50,1.33824}}, color={0,0,127}));
        connect(OUT25, demux.y[25]) annotation (Line(points={{200,-2},{64,-2},{64,1.54412},
                {50,1.54412}}, color={0,0,127}));
        connect(OUT26, demux.y[26]) annotation (Line(points={{200,-22},{64,-22},{64,1.75},
                {50,1.75}}, color={0,0,127}));
        connect(OUT27, demux.y[27]) annotation (Line(points={{200,-42},{64,-42},{64,1.95588},
                {50,1.95588}}, color={0,0,127}));
        connect(OUT28, demux.y[28]) annotation (Line(points={{200,-62},{64,-62},{64,2.16176},
                {50,2.16176}}, color={0,0,127}));
        connect(OUT29, demux.y[29]) annotation (Line(points={{200,-82},{64,-82},{64,2.36765},
                {50,2.36765}}, color={0,0,127}));
        connect(OUT30, demux.y[30]) annotation (Line(points={{200,-102},{64,-102},{64,
                2.57353},{50,2.57353}}, color={0,0,127}));
        connect(OUT31, demux.y[31]) annotation (Line(points={{220,78},{176,78},{176,106},
                {44,106},{44,2.77941},{50,2.77941}}, color={0,0,127}));
        connect(OUT32, demux.y[32]) annotation (Line(points={{220,58},{64,58},{64,2.98529},
                {50,2.98529}}, color={0,0,127}));
        connect(OUT33, demux.y[33]) annotation (Line(points={{220,38},{64,38},{64,3.19118},
                {50,3.19118}}, color={0,0,127}));
        connect(OUT34, demux.y[34]) annotation (Line(points={{220,18},{64,18},{64,3.39706},
                {50,3.39706}},
                        color={0,0,127}));
        connect(add.u1, stateSpace.y[1]) annotation (Line(points={{18,-34},{8,
                -34},{8,-22},{21,-22},{21,0}}, color={0,0,127}));
        connect(const.y, add.u2) annotation (Line(points={{-7,-80},{6,-80},{6,
                -46},{18,-46}}, color={0,0,127}));
        connect(add.y, demux.u[1]) annotation (Line(points={{41,-40},{50,-40},{
                50,-20},{28,-20},{28,-0.970588}}, color={0,0,127}));
          annotation (Placement(transformation(extent={{140,-20},{160,0}})),
                      Placement(transformation(extent={{140,-40},{160,-20}})),
                      Placement(transformation(extent={{140,-60},{160,-40}})),
                      Placement(transformation(extent={{140,-80},{160,-60}})),
                     Diagram(coordinateSystem(preserveAspectRatio=false,
                extent={{-140,-140},{140,140}})),
          Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),experiment(StopTime=10, __Dymola_Algorithm="Dassl"),
          Icon(coordinateSystem(extent={{-140,-140},{140,140}})));
      end MPCAppliedEnergyLinearized_test2_LINEAR;

      model MPCAppliedEnergyLinearized_test22
        "THIS ONE IS STABLE, CONTROLLABLE, OBSERVABLE!!!!!!!"
        extends Modelica.Icons.Example;

        parameter Boolean equivalentGRID = true;
        parameter Boolean equivalentsystem = false;

        OpenIPSL.Electrical.Buses.Bus Bus5(angle_0=powerFlow.powerflow.bus.A5, v_0=
              powerFlow.powerflow.bus.V5)  annotation (Placement(
              transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={80,16})));
        OpenIPSL.Electrical.Buses.Bus Bus6(v_0=powerFlow.powerflow.bus.V6, angle_0=
              powerFlow.powerflow.bus.A6) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,10})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000,
          R=0.005,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={10,10})));
        GenerationUnits.PSSE.G2_16MVA                         G2(
          enableV_b=true,
          enableP_0=true,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V6,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A6,
          V_b=6000,
          P_0=powerFlow.powerflow.machines.PG2,
          Q_0=powerFlow.powerflow.machines.QG2,
          enableangle_0=true)
                        annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-30,10})));

        Modelica.Blocks.Interfaces.RealInput IN1(start=0)
          "Connector of Real input signal 2" annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-150,10}),iconTransformation(extent={{-10,-10},{10,10}}, origin={-150,10})));
        Modelica.Blocks.Sources.Constant IN11(k=0)
          annotation (Placement(transformation(extent={{-108,-2},{-96,10}})));
        Modelica.Blocks.Math.Add AddU1
          annotation (Placement(transformation(extent={{-80,0},{-60,20}})));
        Modelica.Blocks.Sources.Constant IN22(k=0)
          annotation (Placement(transformation(extent={{-108,-32},{-96,-20}})));
        Modelica.Blocks.Math.Add AddU2
          annotation (Placement(transformation(extent={{-80,-30},{-60,-10}})));
        Modelica.Blocks.Interfaces.RealInput IN2(start=0)
          "Connector of Real input signal 2"
                 annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-150,-12}), iconTransformation(extent={{-10,-10},{10,10}},
                origin={-150,-12})));

        Modelica.Blocks.Interfaces.RealInput IN3(start = 0) "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-44},{-140,-24}}),
              iconTransformation(extent={{-160,-44},{-140,-24}})));
        Modelica.Blocks.Interfaces.RealInput IN4(start = 0) "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-66},{-140,-46}}),
              iconTransformation(extent={{-160,-66},{-140,-46}})));
        Modelica.Blocks.Interfaces.RealInput IN5(start = 0) "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-88},{-140,-68}}),
              iconTransformation(extent={{-160,-88},{-140,-68}})));

        Electrical.Loads.PSSE.Load_ExtInput Load2(
          P_0=powerFlow.powerflow.loads.PL2,
          Q_0=powerFlow.powerflow.loads.QL2,
          v_0=powerFlow.powerflow.bus.V5,
          angle_0=powerFlow.powerflow.bus.A5,
          d_P=0,
          t1=100,
          d_t=1000)
          annotation (Placement(transformation(extent={{100,-30},{120,-10}})));

        Electrical.Buses.Bus Bus10(v_0=powerFlow.powerflow.bus.V10, angle_0=powerFlow.powerflow.bus.A10)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,-90})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T4(
          G=0,
          B=0,
          CW=1,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={10,-90})));
        GenerationUnits.PSSE.Solar_Units.SolarMPCLocalVQControl PV(
          V_b=480,
          P_0=powerFlow.powerflow.machines.PPV,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QPV,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V8,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A8,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-60},{-20,-40}})));
        Modelica.Blocks.Math.Add AddU3
          annotation (Placement(transformation(extent={{-80,-60},{-60,-40}})));
        Modelica.Blocks.Sources.Constant IN33(k=0)
          annotation (Placement(transformation(extent={{-108,-62},{-96,-50}})));

        Modelica.Blocks.Math.Add AddU4
          annotation (Placement(transformation(extent={{-80,-90},{-60,-70}})));
        Modelica.Blocks.Math.Add AddU5
          annotation (Placement(transformation(extent={{-80,-116},{-60,-96}})));
        Modelica.Blocks.Sources.Constant IN44(k=0)
          annotation (Placement(transformation(extent={{-108,-92},{-96,-80}})));
        Modelica.Blocks.Sources.Constant IN55(k=0)
          annotation (Placement(transformation(extent={{-108,-118},{-96,-106}})));
        GenerationUnits.PSSE.Battery_Units.BESSMPCSysIdentification
                                                                 BESS(
          V_base=480,
          V_b(displayUnit="kV") = 480,
          enableV_b=true,
          P_0=powerFlow.powerflow.machines.PBESS,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QBESS,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V10,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A10,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-100},{-20,-80}})));
        Electrical.Buses.Bus Bus8(v_0=powerFlow.powerflow.bus.V8, angle_0=powerFlow.powerflow.bus.A8)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,-50})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T3(
          G=0,
          B=0,
          CW=1,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={12,-50})));
        Electrical.Buses.Bus Bus11(v_0=powerFlow.powerflow.bus.V11, angle_0=powerFlow.powerflow.bus.A11)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,-90})));
        Electrical.Buses.Bus Bus9(v_0=powerFlow.powerflow.bus.V9, angle_0=powerFlow.powerflow.bus.A9)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,-50})));
        Electrical.Buses.Bus Bus7(v_0=powerFlow.powerflow.bus.V7, angle_0=powerFlow.powerflow.bus.A7)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,10})));
        Electrical.Branches.PwLine          L4(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,6},{
                  50,14}})));
        Electrical.Branches.PwLine          L5(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,-54},
                  {50,-46}})));
        Electrical.Branches.PwLine          L6(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,-94},
                  {50,-86}})));
        Modelica.Blocks.Sources.Sine sine(
          amplitude=0,
          f=1/260,
          phase=3.1415926535898,
          startTime=1000)
          annotation (Placement(transformation(extent={{68,-36},{78,-26}})));
        Electrical.Loads.NoiseInjections.WhiteNoiseInjection whiteNoiseInjection(
            active_sigma=0.0000000001, samplePeriod=0.01)
          annotation (Placement(transformation(extent={{66,-18},{78,-6}})));
        Modelica.Blocks.Math.Add add
          annotation (Placement(transformation(extent={{84,-18},{92,-10}})));
        PFData.PowerFlow powerFlow(redeclare record PowerFlow = PFData.PF16)
          annotation (Placement(transformation(extent={{-116,106},{-96,126}})));
        Modelica.Blocks.Interfaces.RealOutput OUT1
          annotation (Placement(transformation(extent={{146,68},{166,88}})));
       Modelica.Blocks.Interfaces.RealOutput OUT2
          annotation (Placement(transformation(extent={{146,48},{166,68}})));
        Modelica.Blocks.Interfaces.RealOutput OUT3
          annotation (Placement(transformation(extent={{146,28},{166,48}})));
        Modelica.Blocks.Interfaces.RealOutput OUT4
          annotation (Placement(transformation(extent={{146,8},{166,28}})));
        Modelica.Blocks.Interfaces.RealOutput OUT5
          annotation (Placement(transformation(extent={{146,-12},{166,8}})));
        Modelica.Blocks.Interfaces.RealOutput OUT6
          annotation (Placement(transformation(extent={{146,-32},{166,-12}})));
        Modelica.Blocks.Interfaces.RealOutput OUT7
          annotation (Placement(transformation(extent={{146,-52},{166,-32}})));
        Modelica.Blocks.Interfaces.RealOutput OUT8
          annotation (Placement(transformation(extent={{146,-72},{166,-52}})));
        Modelica.Blocks.Interfaces.RealOutput OUT9
          annotation (Placement(transformation(extent={{146,-92},{166,-72}})));
        Modelica.Blocks.Interfaces.RealOutput OUT10
          annotation (Placement(transformation(extent={{146,-112},{166,-92}})));
        Modelica.Blocks.Interfaces.RealOutput OUT11
          annotation (Placement(transformation(extent={{170,68},{190,88}})));
        Modelica.Blocks.Interfaces.RealOutput OUT12
          annotation (Placement(transformation(extent={{170,48},{190,68}})));
        Modelica.Blocks.Interfaces.RealOutput OUT13
          annotation (Placement(transformation(extent={{170,28},{190,48}})));
        Modelica.Blocks.Interfaces.RealOutput OUT14
          annotation (Placement(transformation(extent={{170,8},{190,28}})));
        Modelica.Blocks.Interfaces.RealOutput OUT15
          annotation (Placement(transformation(extent={{170,-12},{190,8}})));
        Modelica.Blocks.Interfaces.RealOutput OUT16
          annotation (Placement(transformation(extent={{170,-32},{190,-12}})));
        Modelica.Blocks.Interfaces.RealOutput OUT17
          annotation (Placement(transformation(extent={{170,-52},{190,-32}})));
        Modelica.Blocks.Interfaces.RealOutput OUT18
          annotation (Placement(transformation(extent={{170,-72},{190,-52}})));
        Modelica.Blocks.Interfaces.RealOutput OUT19
          annotation (Placement(transformation(extent={{170,-92},{190,-72}})));
        Modelica.Blocks.Interfaces.RealOutput OUT20
          annotation (Placement(transformation(extent={{170,-112},{190,-92}})));
        Modelica.Blocks.Interfaces.RealOutput OUT21
          annotation (Placement(transformation(extent={{190,68},{210,88}})));
        Modelica.Blocks.Interfaces.RealOutput OUT22
          annotation (Placement(transformation(extent={{190,48},{210,68}})));
        Modelica.Blocks.Interfaces.RealOutput OUT23
          annotation (Placement(transformation(extent={{190,28},{210,48}})));
        Modelica.Blocks.Interfaces.RealOutput OUT24
          annotation (Placement(transformation(extent={{190,8},{210,28}})));
        Modelica.Blocks.Interfaces.RealOutput OUT25
          annotation (Placement(transformation(extent={{190,-12},{210,8}})));
        Modelica.Blocks.Interfaces.RealOutput OUT26
          annotation (Placement(transformation(extent={{190,-32},{210,-12}})));
      equation

      OUT1 = G2.gen.w;
      OUT2 = G2.gen.delta;
      OUT3 = G2.gen.P;
      OUT4 = G2.gen.Q;
      OUT5 = G2.gen.p.ir;
      OUT6 = G2.gen.p.ii;
      OUT7 = G2.gen.PMECH;
      OUT8 = G2.sEXSMPC.EFD;
      OUT9 = Bus6.v;
      OUT10 = Bus6.angle;

      OUT11 = PV.rEGCA1_1.Pgen;
      OUT12 = PV.rEGCA1_1.Qgen;
      OUT13 = PV.rEGCA1_1.p.ir;
      OUT14 = PV.rEGCA1_1.p.ii;
      OUT15 = Bus8.v;
      OUT16 = Bus8.angle;

      OUT17 = BESS.rEGCA1_1.Pgen;
      OUT18 = BESS.rEGCA1_1.Qgen;
      OUT19 = BESS.rEGCA1_1.p.ir;
      OUT20 = BESS.rEGCA1_1.p.ii;
      OUT21 = Bus10.v;
      OUT22 = Bus10.angle;

      OUT23 = Load2.P;
      OUT24 = Load2.Q;

      OUT25 = Bus5.v;
      OUT26 = Bus5.angle;



        connect(IN11.y, AddU1.u2) annotation (Line(points={{-95.4,4},{-82,4}},
                            color={0,0,127}));
        connect(IN1, AddU1.u1) annotation (Line(points={{-150,10},{-116,10},{-116,16},
                {-82,16}},
                       color={0,0,127}));

        connect(IN22.y,AddU2. u2) annotation (Line(points={{-95.4,-26},{-82,-26}},
                       color={0,0,127}));
        connect(IN2,AddU2. u1) annotation (Line(points={{-150,-12},{-118,-12},{-118,-14},
                {-82,-14}},
                       color={0,0,127}));
        connect(AddU2.y, G2.Efd_ref)
          annotation (Line(points={{-59,-20},{-52,-20},{-52,4},{-42,4}},
                                                                 color={0,0,127}));
        connect(AddU1.y, G2.P_ref1) annotation (Line(points={{-59,10},{-52,10},{-52,16},
                {-42,16}},                          color={0,0,127}));
        connect(Load2.p, Bus5.p) annotation (Line(points={{110,-10},{110,10},{80,10},{
                80,16}},
                     color={0,0,255}));
        connect(T4.n, Bus10.p)
          annotation (Line(points={{-1,-90},{-10,-90}}, color={0,0,255}));
        connect(Bus6.p, T2.n)
          annotation (Line(points={{-10,10},{-1,10}},
                                                  color={0,0,255}));
        connect(AddU3.y, PV.QINPUT) annotation (Line(points={{-59,-50},{-42,-50}},
                                 color={0,0,127}));
        connect(IN33.y,AddU3. u2)
          annotation (Line(points={{-95.4,-56},{-82,-56}}, color={0,0,127}));
        connect(BESS.p1, Bus10.p)
          annotation (Line(points={{-20,-90},{-10,-90}}, color={0,0,255}));
        connect(BESS.Paux1, AddU4.y) annotation (Line(points={{-42,-84},{-54,-84},{-54,
                -80},{-59,-80}}, color={0,0,127}));
        connect(IN55.y, AddU5.u2)
          annotation (Line(points={{-95.4,-112},{-82,-112}}, color={0,0,127}));
        connect(AddU5.y, BESS.Qext1) annotation (Line(points={{-59,-106},{-52,-106},{-52,
                -96},{-42,-96}},   color={0,0,127}));
        connect(IN44.y, AddU4.u2)
          annotation (Line(points={{-95.4,-86},{-82,-86}}, color={0,0,127}));
        connect(AddU4.u1,IN4)  annotation (Line(points={{-82,-74},{-100,-74},{-100,-70},
                {-116,-70},{-116,-56},{-150,-56}}, color={0,0,127}));
        connect(AddU5.u1,IN5)  annotation (Line(points={{-82,-100},{-116,-100},{-116,-78},
                {-150,-78}}, color={0,0,127}));
        connect(G2.conn, Bus6.p) annotation (Line(points={{-19,10},{-10,10}},
                                           color={0,0,255}));
        connect(AddU3.u1, IN3) annotation (Line(points={{-82,-44},{-118,-44},{-118,-34},
                {-150,-34}}, color={0,0,127}));
        connect(PV.p1, Bus8.p)
          annotation (Line(points={{-20,-50},{-10,-50}}, color={0,0,255}));
        connect(Bus8.p, T3.n)
          annotation (Line(points={{-10,-50},{1,-50}},  color={0,0,255}));
        connect(T2.p, Bus7.p) annotation (Line(points={{21,10},{25.5,10},{25.5,10},{30,
                10}}, color={0,0,255}));
        connect(T3.p, Bus9.p)
          annotation (Line(points={{23,-50},{30,-50}}, color={0,0,255}));
        connect(T4.p, Bus11.p)
          annotation (Line(points={{21,-90},{30,-90}}, color={0,0,255}));
        connect(L4.n, Bus5.p) annotation (Line(points={{49.4,10},{60,10},{60,10},{80,10},
                {80,16}},     color={0,0,255}));
        connect(L5.n, Bus5.p) annotation (Line(points={{49.4,-50},{60,-50},{60,10},{80,
                10},{80,16}}, color={0,0,255}));
        connect(Bus11.p, L6.p)
          annotation (Line(points={{30,-90},{38.6,-90}}, color={0,0,255}));
        connect(Bus9.p, L5.p)
          annotation (Line(points={{30,-50},{38.6,-50}}, color={0,0,255}));
        connect(L6.n, Bus5.p) annotation (Line(points={{49.4,-90},{60,-90},{60,10},{80,
                10},{80,16}}, color={0,0,255}));
        connect(Bus7.p, L4.p) annotation (Line(points={{30,10},{34.3,10},{34.3,10},{38.6,
                10}}, color={0,0,255}));
        connect(sine.y, add.u2) annotation (Line(points={{78.5,-31},{78.5,-16.4},
                {83.2,-16.4}}, color={0,0,127}));
        connect(whiteNoiseInjection.y, add.u1) annotation (Line(points={{78.54,
                -12.06},{80.87,-12.06},{80.87,-11.6},{83.2,-11.6}}, color={0,0,
                127}));
        connect(add.y, Load2.u) annotation (Line(points={{92.4,-14},{97.15,-14},
                {97.15,-14.5},{101.9,-14.5}}, color={0,0,127}));
          annotation (Placement(transformation(extent={{140,-20},{160,0}})),
                      Placement(transformation(extent={{140,-40},{160,-20}})),
                      Placement(transformation(extent={{140,-60},{160,-40}})),
                      Placement(transformation(extent={{140,-80},{160,-60}})),
                     Diagram(coordinateSystem(preserveAspectRatio=false,
                extent={{-140,-140},{140,140}}), graphics={
              Rectangle(
                extent={{-160,30},{-134,-90}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,36},{124,-124}},
                lineColor={238,46,47},
                lineThickness=0.5),
              Text(
                extent={{78,-106},{114,-120}},
                textColor={238,46,47},
                textString="Microgrid"),
              Text(
                extent={{-30,-102},{34,-124}},
                textColor={0,140,72},
                textString="Linearization Unit"),
              Text(
                extent={{-164,50},{-132,30}},
                textColor={0,140,72},
                textString="Inputs")}),
          Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),experiment(
            StopTime=100,
            __Dymola_NumberOfIntervals=1000,
            __Dymola_Algorithm="Dassl"),
          Icon(coordinateSystem(extent={{-140,-140},{140,140}})));
      end MPCAppliedEnergyLinearized_test22;

      model MPCAppliedEnergyOriginal_test22
        "THIS ONE IS STABLE, CONTROLLABLE, OBSERVABLE!!!!!!!"
        extends Modelica.Icons.Example;

        parameter Boolean equivalentGRID = false;
        parameter Boolean equivalentsystem = false;

        OpenIPSL.Electrical.Buses.Bus Bus1(v_0=powerFlow.powerflow.bus.V1, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-90,70},{-70,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus2(v_0=powerFlow.powerflow.bus.V2, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-50,70},{-30,90}})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
          R=0.001,
          X=0.2,
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000)  if not equivalentGRID annotation (Placement(transformation(
              extent={{-8,-8},{8,8}},
              rotation=180,
              origin={-60,80})));
        OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
          enableV_b=true,
          v_0=powerFlow.powerflow.bus.V1,
          angle_0=powerFlow.powerflow.bus.A1,
          P_0=powerFlow.powerflow.machines.PG1,
          Q_0=powerFlow.powerflow.machines.QG1,
          V_b=6000)  if not equivalentGRID
          annotation (Placement(transformation(extent={{-112,70},{-92,90}})));
        OpenIPSL.Electrical.Branches.PwLine L1(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{-26,76},
                  {-14,84}})));
        OpenIPSL.Electrical.Buses.Bus Bus3(v_0=powerFlow.powerflow.bus.V3, angle_0=
              powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-10,70},{10,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus4(v_0=powerFlow.powerflow.bus.V4, angle_0=
              powerFlow.powerflow.bus.V4) if not equivalentGRID
          annotation (Placement(transformation(extent={{50,70},{70,90}})));
        OpenIPSL.Electrical.Branches.PwLine L2_1(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,86},
                  {36,94}})));
        OpenIPSL.Electrical.Branches.PwLine L2_2(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,66},
                  {36,74}})));
        OpenIPSL.Electrical.Buses.Bus Bus5(angle_0=powerFlow.powerflow.bus.A5, v_0=
              powerFlow.powerflow.bus.V5)  annotation (Placement(
              transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={80,16})));
        OpenIPSL.Electrical.Branches.PwLine L3(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=-90,
              origin={80,60})));
        OpenIPSL.Electrical.Buses.Bus Bus6(v_0=powerFlow.powerflow.bus.V6, angle_0=
              powerFlow.powerflow.bus.A6) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,10})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000,
          R=0.005,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={10,10})));
        GenerationUnits.PSSE.G2_16MVA                         G2(
          enableV_b=true,
          enableP_0=true,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V6,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A6,
          V_b=6000,
          P_0=powerFlow.powerflow.machines.PG2,
          Q_0=powerFlow.powerflow.machines.QG2,
          enableangle_0=true)
                        annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-30,10})));
        inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000, fn=60)
          annotation (Placement(transformation(extent={{-128,104},{-74,124}})));
        OpenIPSL.Electrical.Loads.PSSE.Load Load1(
          V_b=220000,
          P_0=powerFlow.powerflow.loads.PL1,
          Q_0=powerFlow.powerflow.loads.QL1,
          v_0=powerFlow.powerflow.bus.V3,
          angle_0=powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-20,48},{0,68}})));
        Electrical.Events.Breaker breaker(enableTrigger=false,
          t_o=1.01,
          rc_enabled=false,
          t_rc=80.01)       if not equivalentGRID                     annotation (Placement(transformation(
              extent={{-4,-4},{4,4}},
              rotation=90,
              origin={80,26})));

        Modelica.Blocks.Interfaces.RealInput IN1(start=0)
          "Connector of Real input signal 2" annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-150,10}),iconTransformation(extent={{-10,-10},{10,10}}, origin={-150,10})));
        Modelica.Blocks.Sources.Constant IN11(k=0)
          annotation (Placement(transformation(extent={{-108,-2},{-96,10}})));
        Modelica.Blocks.Math.Add AddU1
          annotation (Placement(transformation(extent={{-80,0},{-60,20}})));
        Modelica.Blocks.Sources.Constant IN22(k=0)
          annotation (Placement(transformation(extent={{-108,-32},{-96,-20}})));
        Modelica.Blocks.Math.Add AddU2
          annotation (Placement(transformation(extent={{-80,-30},{-60,-10}})));
        Modelica.Blocks.Interfaces.RealInput IN2(start=0)
          "Connector of Real input signal 2"
                 annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-150,-12}), iconTransformation(extent={{-10,-10},{10,10}},
                origin={-150,-12})));
                  Modelica.Blocks.Interfaces.RealInput IN3 "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-44},{-140,-24}}),
              iconTransformation(extent={{-160,-44},{-140,-24}})));
        Modelica.Blocks.Interfaces.RealInput IN4(start = 0) "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-66},{-140,-46}}),
              iconTransformation(extent={{-160,-66},{-140,-46}})));
        Modelica.Blocks.Interfaces.RealInput IN5(start = 0) "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-88},{-140,-68}}),
              iconTransformation(extent={{-160,-88},{-140,-68}})));

        PFData.PowerFlow powerFlow(redeclare record PowerFlow =
              OpenIPSL.Examples.ModelPredictiveControl.PFData.PF16)
          annotation (Placement(transformation(extent={{-68,104},{-48,124}})));
        Electrical.Machines.PSSE.GENCLS IB(
          V_b=220000,
          v_0=powerFlow.powerflow.bus.V4,
          angle_0=powerFlow.powerflow.bus.A4,
          P_0=powerFlow.powerflow.machines.Pinf,
          Q_0=powerFlow.powerflow.machines.Qinf,
          M_b=100000000,
          X_d=1) if not equivalentGRID annotation (Placement(transformation(extent={{110,70},
                  {100,90}})));
        Electrical.Loads.PSSE.Load_ExtInput Load2(
          P_0=powerFlow.powerflow.loads.PL2,
          Q_0=powerFlow.powerflow.loads.QL2,
          v_0=powerFlow.powerflow.bus.V5,
          angle_0=powerFlow.powerflow.bus.A5,
          d_P=0,
          t1=100,
          d_t=1000)
          annotation (Placement(transformation(extent={{100,-30},{120,-10}})));

        inner Modelica.Blocks.Noise.GlobalSeed globalSeed(useAutomaticSeed=false,
            fixedSeed=10000)
          annotation (Placement(transformation(extent={{-42,102},{-22,122}})));
        Modelica.Blocks.Sources.Sine sine(
          amplitude=0,
          f=1/260,
          phase=3.1415926535898,
          startTime=1000)
          annotation (Placement(transformation(extent={{70,-36},{80,-26}})));

        Electrical.Buses.Bus Bus10(v_0=powerFlow.powerflow.bus.V10, angle_0=powerFlow.powerflow.bus.A10)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,-90})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T4(
          G=0,
          B=0,
          CW=1,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={10,-90})));
        GenerationUnits.PSSE.Solar_Units.SolarMPCLocalVQControl PV(
          V_b=480,
          P_0=powerFlow.powerflow.machines.PPV,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QPV,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V8,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A8,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-60},{-20,-40}})));
        Modelica.Blocks.Math.Add AddU3
          annotation (Placement(transformation(extent={{-80,-60},{-60,-40}})));
        Modelica.Blocks.Sources.Constant IN33(k=0)
          annotation (Placement(transformation(extent={{-108,-62},{-96,-50}})));

        Modelica.Blocks.Math.Add AddU4
          annotation (Placement(transformation(extent={{-80,-90},{-60,-70}})));
        Modelica.Blocks.Math.Add AddU5
          annotation (Placement(transformation(extent={{-80,-116},{-60,-96}})));
        Modelica.Blocks.Sources.Constant IN44(k=0)
          annotation (Placement(transformation(extent={{-108,-92},{-96,-80}})));
        Modelica.Blocks.Sources.Constant IN55(k=0)
          annotation (Placement(transformation(extent={{-108,-118},{-96,-106}})));
        GenerationUnits.PSSE.Battery_Units.BESSMPCLocalVQControl BESS(
          V_base=480,
          V_b(displayUnit="kV") = 480,
          enableV_b=true,
          P_0=powerFlow.powerflow.machines.PBESS,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QBESS,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V10,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A10,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-100},{-20,-80}})));
        Electrical.Buses.Bus Bus8(v_0=powerFlow.powerflow.bus.V8, angle_0=powerFlow.powerflow.bus.A8)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,-50})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T3(
          G=0,
          B=0,
          CW=1,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={12,-50})));
        Electrical.Buses.Bus Bus11(v_0=powerFlow.powerflow.bus.V11, angle_0=powerFlow.powerflow.bus.A11)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,-90})));
        Electrical.Buses.Bus Bus9(v_0=powerFlow.powerflow.bus.V9, angle_0=powerFlow.powerflow.bus.A9)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,-50})));
        Electrical.Buses.Bus Bus7(v_0=powerFlow.powerflow.bus.V7, angle_0=powerFlow.powerflow.bus.A7)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,10})));
        Electrical.Branches.PwLine          L4(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,6},{
                  50,14}})));
        Electrical.Branches.PwLine          L5(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,-54},
                  {50,-46}})));
        Electrical.Branches.PwLine          L6(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,-94},
                  {50,-86}})));
        Electrical.Loads.NoiseInjections.WhiteNoiseInjection whiteNoiseInjection(
            active_sigma=0.0000000001, samplePeriod=0.1)
          annotation (Placement(transformation(extent={{68,-18},{80,-6}})));
        Modelica.Blocks.Math.Add add
          annotation (Placement(transformation(extent={{86,-18},{94,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT1
          annotation (Placement(transformation(extent={{140,70},{160,90}})));
       Modelica.Blocks.Interfaces.RealOutput OUT2
          annotation (Placement(transformation(extent={{140,50},{160,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT3
          annotation (Placement(transformation(extent={{140,30},{160,50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT4
          annotation (Placement(transformation(extent={{140,10},{160,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT5
          annotation (Placement(transformation(extent={{140,-10},{160,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT6
          annotation (Placement(transformation(extent={{140,-30},{160,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT7
          annotation (Placement(transformation(extent={{140,-50},{160,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT8
          annotation (Placement(transformation(extent={{140,-70},{160,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT9
          annotation (Placement(transformation(extent={{140,-90},{160,-70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT10
          annotation (Placement(transformation(extent={{140,-110},{160,-90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT11
          annotation (Placement(transformation(extent={{164,70},{184,90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT12
          annotation (Placement(transformation(extent={{164,50},{184,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT13
          annotation (Placement(transformation(extent={{164,30},{184,50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT14
          annotation (Placement(transformation(extent={{164,10},{184,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT15
          annotation (Placement(transformation(extent={{164,-10},{184,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT16
          annotation (Placement(transformation(extent={{164,-30},{184,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT17
          annotation (Placement(transformation(extent={{164,-50},{184,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT18
          annotation (Placement(transformation(extent={{164,-70},{184,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT19
          annotation (Placement(transformation(extent={{164,-90},{184,-70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT20
          annotation (Placement(transformation(extent={{164,-110},{184,-90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT21
          annotation (Placement(transformation(extent={{184,70},{204,90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT22
          annotation (Placement(transformation(extent={{184,50},{204,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT23
          annotation (Placement(transformation(extent={{184,30},{204,50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT24
          annotation (Placement(transformation(extent={{184,10},{204,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT25
          annotation (Placement(transformation(extent={{186,-10},{206,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT26
          annotation (Placement(transformation(extent={{186,-30},{206,-10}})));
      equation

      OUT1 = G2.gen.w;
      OUT2 = G2.gen.delta;
      OUT3 = G2.gen.P;
      OUT4 = G2.gen.Q;
      OUT5 = G2.gen.p.ir;
      OUT6 = G2.gen.p.ii;
      OUT7 = G2.gen.PMECH;
      OUT8 = G2.sEXSMPC.EFD;
      OUT9 = Bus6.v;
      OUT10 = Bus6.angle;

      OUT11 = PV.rEGCA1_1.Pgen;
      OUT12 = PV.rEGCA1_1.Qgen;
      OUT13 = PV.rEGCA1_1.p.ir;
      OUT14 = PV.rEGCA1_1.p.ii;
      OUT15 = Bus8.v;
      OUT16 = Bus8.angle;

      OUT17 = BESS.rEGCA1_1.Pgen;
      OUT18 = BESS.rEGCA1_1.Qgen;
      OUT19 = BESS.rEGCA1_1.p.ir;
      OUT20 = BESS.rEGCA1_1.p.ii;
      OUT21 = Bus10.v;
      OUT22 = Bus10.angle;

      OUT23 = Load2.P;
      OUT24 = Load2.Q;

      OUT25 = Bus5.v;
      OUT26 = Bus5.angle;


        connect(T1.p, Bus2.p)
          annotation (Line(points={{-51.2,80},{-40,80}}, color={0,0,255}));
        connect(Bus1.p, T1.n)
          annotation (Line(points={{-80,80},{-68.8,80}}, color={0,0,255}));
        connect(G1.conn, Bus1.p)
          annotation (Line(points={{-91,80},{-80,80}}, color={0,0,255}));
        connect(L1.n, Bus3.p)
          annotation (Line(points={{-14.6,80},{0,80}}, color={0,0,255}));
        connect(L1.p, Bus2.p)
          annotation (Line(points={{-25.4,80},{-40,80}}, color={0,0,255}));
        connect(L2_2.n, Bus4.p) annotation (Line(points={{35.4,70},{44,70},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.n, Bus4.p) annotation (Line(points={{35.4,90},{44,90},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.p, Bus3.p) annotation (Line(points={{24.6,90},{16,90},{16,80},{0,
                80}}, color={0,0,255}));
        connect(L2_2.p, Bus3.p) annotation (Line(points={{24.6,70},{16,70},{16,80},{0,
                80}}, color={0,0,255}));
        connect(Load1.p, Bus3.p)
          annotation (Line(points={{-10,68},{-10,80},{0,80}}, color={0,0,255}));
        connect(L3.p, Bus4.p)
          annotation (Line(points={{80,65.4},{80,80},{60,80}}, color={0,0,255}));
        connect(breaker.s, Bus5.p)
          annotation (Line(points={{80,22},{80,16}},color={0,0,255}));
        connect(breaker.r, L3.n)
          annotation (Line(points={{80,30},{80,54.6}},color={0,0,255}));
        connect(IN11.y, AddU1.u2) annotation (Line(points={{-95.4,4},{-82,4}},
                            color={0,0,127}));
        connect(IN1, AddU1.u1) annotation (Line(points={{-150,10},{-116,10},{-116,16},
                {-82,16}},
                       color={0,0,127}));

        connect(IN22.y,AddU2. u2) annotation (Line(points={{-95.4,-26},{-82,-26}},
                       color={0,0,127}));
        connect(IN2,AddU2. u1) annotation (Line(points={{-150,-12},{-118,-12},{-118,-14},
                {-82,-14}},
                       color={0,0,127}));
        connect(AddU2.y, G2.Efd_ref)
          annotation (Line(points={{-59,-20},{-52,-20},{-52,4},{-42,4}},
                                                                 color={0,0,127}));
        connect(AddU1.y, G2.P_ref1) annotation (Line(points={{-59,10},{-52,10},{-52,16},
                {-42,16}},                          color={0,0,127}));
        connect(IB.p, Bus4.p)
          annotation (Line(points={{100,80},{60,80}}, color={0,0,255}));
        connect(Load2.p, Bus5.p) annotation (Line(points={{110,-10},{110,10},{80,10},{
                80,16}},
                     color={0,0,255}));
        connect(T4.n, Bus10.p)
          annotation (Line(points={{-1,-90},{-10,-90}}, color={0,0,255}));
        connect(Bus6.p, T2.n)
          annotation (Line(points={{-10,10},{-1,10}},
                                                  color={0,0,255}));
        connect(AddU3.y, PV.QINPUT) annotation (Line(points={{-59,-50},{-42,-50}},
                                 color={0,0,127}));
        connect(IN33.y,AddU3. u2)
          annotation (Line(points={{-95.4,-56},{-82,-56}}, color={0,0,127}));
        connect(BESS.p1, Bus10.p)
          annotation (Line(points={{-20,-90},{-10,-90}}, color={0,0,255}));
        connect(BESS.Paux1, AddU4.y) annotation (Line(points={{-42,-84},{-54,-84},{-54,
                -80},{-59,-80}}, color={0,0,127}));
        connect(IN55.y, AddU5.u2)
          annotation (Line(points={{-95.4,-112},{-82,-112}}, color={0,0,127}));
        connect(AddU5.y, BESS.Qext1) annotation (Line(points={{-59,-106},{-52,-106},{-52,
                -96},{-42,-96}},   color={0,0,127}));
        connect(IN44.y, AddU4.u2)
          annotation (Line(points={{-95.4,-86},{-82,-86}}, color={0,0,127}));
        connect(AddU4.u1,IN4)  annotation (Line(points={{-82,-74},{-100,-74},{-100,-70},
                {-116,-70},{-116,-56},{-150,-56}}, color={0,0,127}));
        connect(AddU5.u1,IN5)  annotation (Line(points={{-82,-100},{-116,-100},{-116,-78},
                {-150,-78}}, color={0,0,127}));
        connect(G2.conn, Bus6.p) annotation (Line(points={{-19,10},{-10,10}},
                                           color={0,0,255}));
        connect(AddU3.u1, IN3) annotation (Line(points={{-82,-44},{-118,-44},{-118,-34},
                {-150,-34}}, color={0,0,127}));
        connect(PV.p1, Bus8.p)
          annotation (Line(points={{-20,-50},{-10,-50}}, color={0,0,255}));
        connect(Bus8.p, T3.n)
          annotation (Line(points={{-10,-50},{1,-50}},  color={0,0,255}));
        connect(T2.p, Bus7.p) annotation (Line(points={{21,10},{25.5,10},{25.5,10},{30,
                10}}, color={0,0,255}));
        connect(T3.p, Bus9.p)
          annotation (Line(points={{23,-50},{30,-50}}, color={0,0,255}));
        connect(T4.p, Bus11.p)
          annotation (Line(points={{21,-90},{30,-90}}, color={0,0,255}));
        connect(L4.n, Bus5.p) annotation (Line(points={{49.4,10},{60,10},{60,10},{80,10},
                {80,16}},     color={0,0,255}));
        connect(L5.n, Bus5.p) annotation (Line(points={{49.4,-50},{60,-50},{60,10},{80,
                10},{80,16}}, color={0,0,255}));
        connect(Bus11.p, L6.p)
          annotation (Line(points={{30,-90},{38.6,-90}}, color={0,0,255}));
        connect(Bus9.p, L5.p)
          annotation (Line(points={{30,-50},{38.6,-50}}, color={0,0,255}));
        connect(L6.n, Bus5.p) annotation (Line(points={{49.4,-90},{60,-90},{60,10},{80,
                10},{80,16}}, color={0,0,255}));
        connect(Bus7.p, L4.p) annotation (Line(points={{30,10},{34.3,10},{34.3,10},{38.6,
                10}}, color={0,0,255}));
        connect(sine.y, add.u2) annotation (Line(points={{80.5,-31},{85.2,-31},{85.2,-16.4}},
              color={0,0,127}));
        connect(whiteNoiseInjection.y, add.u1) annotation (Line(points={{80.54,-12.06},
                {82.87,-12.06},{82.87,-11.6},{85.2,-11.6}}, color={0,0,127}));
        connect(add.y, Load2.u) annotation (Line(points={{94.4,-14},{98.15,-14},{98.15,
                -14.5},{101.9,-14.5}}, color={0,0,127}));
          annotation (Placement(transformation(extent={{140,-20},{160,0}})),
                      Placement(transformation(extent={{140,-40},{160,-20}})),
                      Placement(transformation(extent={{140,-60},{160,-40}})),
                      Placement(transformation(extent={{140,-80},{160,-60}})),
                     Diagram(coordinateSystem(preserveAspectRatio=false,
                extent={{-140,-140},{140,140}}), graphics={
              Rectangle(
                extent={{-160,30},{-134,-90}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,36},{124,-124}},
                lineColor={238,46,47},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,98},{124,38}},
                lineColor={0,128,255},
                lineThickness=0.5),
              Text(
                extent={{78,-106},{114,-120}},
                textColor={238,46,47},
                textString="Microgrid"),
              Text(
                extent={{76,58},{128,34}},
                textColor={28,108,200},
                textString="Utility Grid"),
              Text(
                extent={{-30,-102},{34,-124}},
                textColor={0,140,72},
                textString="Linearization Unit"),
              Text(
                extent={{-164,50},{-132,30}},
                textColor={0,140,72},
                textString="Inputs")}),
          Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),experiment(
            StopTime=20,
            __Dymola_NumberOfIntervals=1000,
            __Dymola_Algorithm="Dassl"),
          Icon(coordinateSystem(extent={{-140,-140},{140,140}})));
      end MPCAppliedEnergyOriginal_test22;

      model MPCAppliedEnergyOriginal_test22_table
        "THIS ONE IS STABLE, CONTROLLABLE, OBSERVABLE!!!!!!!"
        extends Modelica.Icons.Example;

        parameter Boolean equivalentGRID = true;
        parameter Boolean equivalentsystem = false;

        OpenIPSL.Electrical.Buses.Bus Bus1(v_0=powerFlow.powerflow.bus.V1, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-90,70},{-70,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus2(v_0=powerFlow.powerflow.bus.V2, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-50,70},{-30,90}})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
          R=0.001,
          X=0.2,
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000)  if not equivalentGRID annotation (Placement(transformation(
              extent={{-8,-8},{8,8}},
              rotation=180,
              origin={-60,80})));
        OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
          enableV_b=true,
          v_0=powerFlow.powerflow.bus.V1,
          angle_0=powerFlow.powerflow.bus.A1,
          P_0=powerFlow.powerflow.machines.PG1,
          Q_0=powerFlow.powerflow.machines.QG1,
          V_b=6000)  if not equivalentGRID
          annotation (Placement(transformation(extent={{-112,70},{-92,90}})));
        OpenIPSL.Electrical.Branches.PwLine L1(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{-26,76},
                  {-14,84}})));
        OpenIPSL.Electrical.Buses.Bus Bus3(v_0=powerFlow.powerflow.bus.V3, angle_0=
              powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-10,70},{10,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus4(v_0=powerFlow.powerflow.bus.V4, angle_0=
              powerFlow.powerflow.bus.V4) if not equivalentGRID
          annotation (Placement(transformation(extent={{50,70},{70,90}})));
        OpenIPSL.Electrical.Branches.PwLine L2_1(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,86},
                  {36,94}})));
        OpenIPSL.Electrical.Branches.PwLine L2_2(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,66},
                  {36,74}})));
        OpenIPSL.Electrical.Buses.Bus Bus5(angle_0=powerFlow.powerflow.bus.A5, v_0=
              powerFlow.powerflow.bus.V5)  annotation (Placement(
              transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={80,16})));
        OpenIPSL.Electrical.Branches.PwLine L3(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=-90,
              origin={80,60})));
        OpenIPSL.Electrical.Buses.Bus Bus6(v_0=powerFlow.powerflow.bus.V6, angle_0=
              powerFlow.powerflow.bus.A6) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,10})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000,
          R=0.005,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={10,10})));
        GenerationUnits.PSSE.G2_16MVA                         G2(
          enableV_b=true,
          enableP_0=true,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V6,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A6,
          V_b=6000,
          P_0=powerFlow.powerflow.machines.PG2,
          Q_0=powerFlow.powerflow.machines.QG2,
          enableangle_0=true)
                        annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-30,10})));
        inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000, fn=60)
          annotation (Placement(transformation(extent={{-128,104},{-74,124}})));
        OpenIPSL.Electrical.Loads.PSSE.Load Load1(
          V_b=220000,
          P_0=powerFlow.powerflow.loads.PL1,
          Q_0=powerFlow.powerflow.loads.QL1,
          v_0=powerFlow.powerflow.bus.V3,
          angle_0=powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-20,48},{0,68}})));
        Electrical.Events.Breaker breaker(enableTrigger=false,
          t_o=1.01,
          rc_enabled=false,
          t_rc=80.01)       if not equivalentGRID                     annotation (Placement(transformation(
              extent={{-4,-4},{4,4}},
              rotation=90,
              origin={80,26})));

        PFData.PowerFlow powerFlow(redeclare record PowerFlow =
              OpenIPSL.Examples.ModelPredictiveControl.PFData.PF16)
          annotation (Placement(transformation(extent={{-68,104},{-48,124}})));
        Electrical.Machines.PSSE.GENCLS IB(
          V_b=220000,
          v_0=powerFlow.powerflow.bus.V4,
          angle_0=powerFlow.powerflow.bus.A4,
          P_0=powerFlow.powerflow.machines.Pinf,
          Q_0=powerFlow.powerflow.machines.Qinf,
          M_b=100000000,
          X_d=1) if not equivalentGRID annotation (Placement(transformation(extent={{110,70},
                  {100,90}})));
        Electrical.Loads.PSSE.Load_ExtInput Load2(
          P_0=powerFlow.powerflow.loads.PL2,
          Q_0=powerFlow.powerflow.loads.QL2,
          v_0=powerFlow.powerflow.bus.V5,
          angle_0=powerFlow.powerflow.bus.A5,
          d_P=0,
          t1=100,
          d_t=1000)
          annotation (Placement(transformation(extent={{100,-30},{120,-10}})));

        inner Modelica.Blocks.Noise.GlobalSeed globalSeed(useAutomaticSeed=false,
            fixedSeed=10000)
          annotation (Placement(transformation(extent={{-42,102},{-22,122}})));
        Modelica.Blocks.Sources.Sine sine(
          amplitude=0,
          f=1/260,
          phase=3.1415926535898,
          startTime=1000)
          annotation (Placement(transformation(extent={{70,-36},{80,-26}})));

        Electrical.Buses.Bus Bus10(v_0=powerFlow.powerflow.bus.V10, angle_0=powerFlow.powerflow.bus.A10)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,-90})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T4(
          G=0,
          B=0,
          CW=1,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={10,-90})));
        GenerationUnits.PSSE.Solar_Units.SolarMPCLocalVQControl PV(
          V_b=480,
          P_0=powerFlow.powerflow.machines.PPV,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QPV,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V8,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A8,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-60},{-20,-40}})));

        GenerationUnits.PSSE.Battery_Units.BESSMPCLocalVQControl BESS(
          V_base=480,
          V_b(displayUnit="kV") = 480,
          enableV_b=true,
          P_0=powerFlow.powerflow.machines.PBESS,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QBESS,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V10,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A10,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-100},{-20,-80}})));
        Electrical.Buses.Bus Bus8(v_0=powerFlow.powerflow.bus.V8, angle_0=powerFlow.powerflow.bus.A8)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,-50})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T3(
          G=0,
          B=0,
          CW=1,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={12,-50})));
        Electrical.Buses.Bus Bus11(v_0=powerFlow.powerflow.bus.V11, angle_0=powerFlow.powerflow.bus.A11)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,-90})));
        Electrical.Buses.Bus Bus9(v_0=powerFlow.powerflow.bus.V9, angle_0=powerFlow.powerflow.bus.A9)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,-50})));
        Electrical.Buses.Bus Bus7(v_0=powerFlow.powerflow.bus.V7, angle_0=powerFlow.powerflow.bus.A7)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,10})));
        Electrical.Branches.PwLine          L4(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,6},{
                  50,14}})));
        Electrical.Branches.PwLine          L5(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,-54},
                  {50,-46}})));
        Electrical.Branches.PwLine          L6(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,-94},
                  {50,-86}})));
        Electrical.Loads.NoiseInjections.WhiteNoiseInjection whiteNoiseInjection(
            active_sigma=0.0000000001, samplePeriod=0.1)
          annotation (Placement(transformation(extent={{68,-18},{80,-6}})));
        Modelica.Blocks.Math.Add add
          annotation (Placement(transformation(extent={{86,-18},{94,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT1
          annotation (Placement(transformation(extent={{140,70},{160,90}})));
       Modelica.Blocks.Interfaces.RealOutput OUT2
          annotation (Placement(transformation(extent={{140,50},{160,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT3
          annotation (Placement(transformation(extent={{140,30},{160,50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT4
          annotation (Placement(transformation(extent={{140,10},{160,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT5
          annotation (Placement(transformation(extent={{140,-10},{160,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT6
          annotation (Placement(transformation(extent={{140,-30},{160,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT7
          annotation (Placement(transformation(extent={{140,-50},{160,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT8
          annotation (Placement(transformation(extent={{140,-70},{160,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT9
          annotation (Placement(transformation(extent={{140,-90},{160,-70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT10
          annotation (Placement(transformation(extent={{140,-110},{160,-90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT11
          annotation (Placement(transformation(extent={{164,70},{184,90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT12
          annotation (Placement(transformation(extent={{164,50},{184,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT13
          annotation (Placement(transformation(extent={{164,30},{184,50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT14
          annotation (Placement(transformation(extent={{164,10},{184,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT15
          annotation (Placement(transformation(extent={{164,-10},{184,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT16
          annotation (Placement(transformation(extent={{164,-30},{184,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT17
          annotation (Placement(transformation(extent={{164,-50},{184,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT18
          annotation (Placement(transformation(extent={{164,-70},{184,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT19
          annotation (Placement(transformation(extent={{164,-90},{184,-70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT20
          annotation (Placement(transformation(extent={{164,-110},{184,-90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT21
          annotation (Placement(transformation(extent={{184,70},{204,90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT22
          annotation (Placement(transformation(extent={{184,50},{204,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT23
          annotation (Placement(transformation(extent={{184,30},{204,50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT24
          annotation (Placement(transformation(extent={{184,10},{204,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT25
          annotation (Placement(transformation(extent={{186,-10},{206,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT26
          annotation (Placement(transformation(extent={{186,-30},{206,-10}})));
        Modelica.Blocks.Sources.CombiTimeTable combiTimeTable(table=[0,0; 0.5,0;
              0.51,0.01; 5,0.01],
                           smoothness=Modelica.Blocks.Types.Smoothness.ConstantSegments)
          annotation (Placement(transformation(extent={{-128,6},{-108,26}})));
        Modelica.Blocks.Sources.CombiTimeTable combiTimeTable1(table=[0,0; 0.5,
              0; 0.51,0.01; 5,0.01],
                           smoothness=Modelica.Blocks.Types.Smoothness.ConstantSegments)
          annotation (Placement(transformation(extent={{-128,-20},{-108,0}})));
        Modelica.Blocks.Sources.CombiTimeTable combiTimeTable2(table=[0,0; 0.5,0; 0.51,
              0.1; 5,0.1], smoothness=Modelica.Blocks.Types.Smoothness.ConstantSegments)
          annotation (Placement(transformation(extent={{-128,-48},{-108,-28}})));
        Modelica.Blocks.Sources.CombiTimeTable combiTimeTable3(table=[0,0; 0.5,
              0; 0.51,0.3; 5,0.3],
                           smoothness=Modelica.Blocks.Types.Smoothness.ConstantSegments)
          annotation (Placement(transformation(extent={{-128,-94},{-108,-74}})));
        Modelica.Blocks.Sources.CombiTimeTable combiTimeTable4(table=[0,0; 0.5,0; 0.51,
              0.1; 5,0.1], smoothness=Modelica.Blocks.Types.Smoothness.ConstantSegments)
          annotation (Placement(transformation(extent={{-128,-120},{-108,-100}})));
      equation

      OUT1 = G2.gen.w;
      OUT2 = G2.gen.delta;
      OUT3 = G2.gen.P;
      OUT4 = G2.gen.Q;
      OUT5 = G2.gen.p.ir;
      OUT6 = G2.gen.p.ii;
      OUT7 = G2.gen.PMECH;
      OUT8 = G2.sEXSMPC.EFD;
      OUT9 = Bus6.v;
      OUT10 = Bus6.angle;

      OUT11 = PV.rEGCA1_1.Pgen;
      OUT12 = PV.rEGCA1_1.Qgen;
      OUT13 = PV.rEGCA1_1.p.ir;
      OUT14 = PV.rEGCA1_1.p.ii;
      OUT15 = Bus8.v;
      OUT16 = Bus8.angle;

      OUT17 = BESS.rEGCA1_1.Pgen;
      OUT18 = BESS.rEGCA1_1.Qgen;
      OUT19 = BESS.rEGCA1_1.p.ir;
      OUT20 = BESS.rEGCA1_1.p.ii;
      OUT21 = Bus10.v;
      OUT22 = Bus10.angle;

      OUT23 = Load2.P;
      OUT24 = Load2.Q;

      OUT25 = Bus5.v;
      OUT26 = Bus5.angle;

        connect(T1.p, Bus2.p)
          annotation (Line(points={{-51.2,80},{-40,80}}, color={0,0,255}));
        connect(Bus1.p, T1.n)
          annotation (Line(points={{-80,80},{-68.8,80}}, color={0,0,255}));
        connect(G1.conn, Bus1.p)
          annotation (Line(points={{-91,80},{-80,80}}, color={0,0,255}));
        connect(L1.n, Bus3.p)
          annotation (Line(points={{-14.6,80},{0,80}}, color={0,0,255}));
        connect(L1.p, Bus2.p)
          annotation (Line(points={{-25.4,80},{-40,80}}, color={0,0,255}));
        connect(L2_2.n, Bus4.p) annotation (Line(points={{35.4,70},{44,70},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.n, Bus4.p) annotation (Line(points={{35.4,90},{44,90},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.p, Bus3.p) annotation (Line(points={{24.6,90},{16,90},{16,80},{0,
                80}}, color={0,0,255}));
        connect(L2_2.p, Bus3.p) annotation (Line(points={{24.6,70},{16,70},{16,80},{0,
                80}}, color={0,0,255}));
        connect(Load1.p, Bus3.p)
          annotation (Line(points={{-10,68},{-10,80},{0,80}}, color={0,0,255}));
        connect(L3.p, Bus4.p)
          annotation (Line(points={{80,65.4},{80,80},{60,80}}, color={0,0,255}));
        connect(breaker.s, Bus5.p)
          annotation (Line(points={{80,22},{80,16}},color={0,0,255}));
        connect(breaker.r, L3.n)
          annotation (Line(points={{80,30},{80,54.6}},color={0,0,255}));

        connect(IB.p, Bus4.p)
          annotation (Line(points={{100,80},{60,80}}, color={0,0,255}));
        connect(Load2.p, Bus5.p) annotation (Line(points={{110,-10},{110,10},{80,10},{
                80,16}},
                     color={0,0,255}));
        connect(T4.n, Bus10.p)
          annotation (Line(points={{-1,-90},{-10,-90}}, color={0,0,255}));
        connect(Bus6.p, T2.n)
          annotation (Line(points={{-10,10},{-1,10}},
                                                  color={0,0,255}));
        connect(BESS.p1, Bus10.p)
          annotation (Line(points={{-20,-90},{-10,-90}}, color={0,0,255}));
        connect(G2.conn, Bus6.p) annotation (Line(points={{-19,10},{-10,10}},
                                           color={0,0,255}));
        connect(PV.p1, Bus8.p)
          annotation (Line(points={{-20,-50},{-10,-50}}, color={0,0,255}));
        connect(Bus8.p, T3.n)
          annotation (Line(points={{-10,-50},{1,-50}},  color={0,0,255}));
        connect(T2.p, Bus7.p) annotation (Line(points={{21,10},{25.5,10},{25.5,10},{30,
                10}}, color={0,0,255}));
        connect(T3.p, Bus9.p)
          annotation (Line(points={{23,-50},{30,-50}}, color={0,0,255}));
        connect(T4.p, Bus11.p)
          annotation (Line(points={{21,-90},{30,-90}}, color={0,0,255}));
        connect(L4.n, Bus5.p) annotation (Line(points={{49.4,10},{60,10},{60,10},{80,10},
                {80,16}},     color={0,0,255}));
        connect(L5.n, Bus5.p) annotation (Line(points={{49.4,-50},{60,-50},{60,10},{80,
                10},{80,16}}, color={0,0,255}));
        connect(Bus11.p, L6.p)
          annotation (Line(points={{30,-90},{38.6,-90}}, color={0,0,255}));
        connect(Bus9.p, L5.p)
          annotation (Line(points={{30,-50},{38.6,-50}}, color={0,0,255}));
        connect(L6.n, Bus5.p) annotation (Line(points={{49.4,-90},{60,-90},{60,10},{80,
                10},{80,16}}, color={0,0,255}));
        connect(Bus7.p, L4.p) annotation (Line(points={{30,10},{34.3,10},{34.3,10},{38.6,
                10}}, color={0,0,255}));
        connect(sine.y, add.u2) annotation (Line(points={{80.5,-31},{85.2,-31},{85.2,-16.4}},
              color={0,0,127}));
        connect(whiteNoiseInjection.y, add.u1) annotation (Line(points={{80.54,-12.06},
                {82.87,-12.06},{82.87,-11.6},{85.2,-11.6}}, color={0,0,127}));
        connect(add.y, Load2.u) annotation (Line(points={{94.4,-14},{98.15,-14},{98.15,
                -14.5},{101.9,-14.5}}, color={0,0,127}));
        connect(combiTimeTable.y[1], G2.P_ref1) annotation (Line(points={{-107,16},{-42,
                16}},                   color={0,0,127}));
        connect(combiTimeTable1.y[1], G2.Efd_ref) annotation (Line(points={{-107,-10},
                {-50,-10},{-50,4},{-42,4}}, color={0,0,127}));
        connect(combiTimeTable2.y[1], PV.QINPUT) annotation (Line(points={{-107,-38},{
                -50,-38},{-50,-50},{-42,-50}}, color={0,0,127}));
        connect(combiTimeTable3.y[1], BESS.Paux1) annotation (Line(points={{-107,-84},
                {-42,-84}},                     color={0,0,127}));
        connect(combiTimeTable4.y[1], BESS.Qext1) annotation (Line(points={{-107,-110},
                {-50,-110},{-50,-96},{-42,-96}}, color={0,0,127}));
          annotation (Placement(transformation(extent={{140,-20},{160,0}})),
                      Placement(transformation(extent={{140,-40},{160,-20}})),
                      Placement(transformation(extent={{140,-60},{160,-40}})),
                      Placement(transformation(extent={{140,-80},{160,-60}})),
                     Diagram(coordinateSystem(preserveAspectRatio=false,
                extent={{-140,-140},{140,140}}), graphics={
              Rectangle(
                extent={{-128,98},{124,38}},
                lineColor={0,128,255},
                lineThickness=0.5),
              Text(
                extent={{78,-106},{114,-120}},
                textColor={238,46,47},
                textString="Microgrid"),
              Text(
                extent={{76,58},{128,34}},
                textColor={28,108,200},
                textString="Utility Grid"),
              Text(
                extent={{-30,-102},{34,-124}},
                textColor={0,140,72},
                textString="Linearization Unit")}),
          Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),experiment(
            StopTime=20,
            __Dymola_NumberOfIntervals=1000,
            __Dymola_Algorithm="Dassl"),
          Icon(coordinateSystem(extent={{-140,-140},{140,140}})));
      end MPCAppliedEnergyOriginal_test22_table;

      model MPCAppliedEnergyLinearized_test22_PSAT_MODEL
        "THIS ONE IS STABLE, CONTROLLABLE, OBSERVABLE!!!!!!!"
        extends Modelica.Icons.Example;

        parameter Boolean equivalentGRID = true;
        parameter Boolean equivalentsystem = false;

        OpenIPSL.Electrical.Buses.Bus Bus5(angle_0=powerFlow.powerflow.bus.A5, v_0=
              powerFlow.powerflow.bus.V5)  annotation (Placement(
              transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={80,16})));
        OpenIPSL.Electrical.Buses.Bus Bus6(v_0=powerFlow.powerflow.bus.V6, angle_0=
              powerFlow.powerflow.bus.A6) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,10})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000,
          R=0.005,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={10,10})));
        GenerationUnits.PSSE.G2_16MVA                         G2(
          enableV_b=true,
          enableP_0=true,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V6,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A6,
          V_b=6000,
          P_0=powerFlow.powerflow.machines.PG2,
          Q_0=powerFlow.powerflow.machines.QG2,
          enableangle_0=true)
                        annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-30,10})));

        Modelica.Blocks.Interfaces.RealInput IN1(start=0)
          "Connector of Real input signal 2" annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-150,10}),iconTransformation(extent={{-10,-10},{10,10}}, origin={-150,10})));
        Modelica.Blocks.Sources.Constant IN11(k=0)
          annotation (Placement(transformation(extent={{-108,-2},{-96,10}})));
        Modelica.Blocks.Math.Add AddU1
          annotation (Placement(transformation(extent={{-80,0},{-60,20}})));
        Modelica.Blocks.Sources.Constant IN22(k=0)
          annotation (Placement(transformation(extent={{-108,-32},{-96,-20}})));
        Modelica.Blocks.Math.Add AddU2
          annotation (Placement(transformation(extent={{-80,-30},{-60,-10}})));
        Modelica.Blocks.Interfaces.RealInput IN2(start=0)
          "Connector of Real input signal 2"
                 annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-150,-12}), iconTransformation(extent={{-10,-10},{10,10}},
                origin={-150,-12})));

        Modelica.Blocks.Interfaces.RealInput IN3(start = 0) "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-44},{-140,-24}}),
              iconTransformation(extent={{-160,-44},{-140,-24}})));
        Modelica.Blocks.Interfaces.RealInput IN4(start = 0) "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-66},{-140,-46}}),
              iconTransformation(extent={{-160,-66},{-140,-46}})));
        Modelica.Blocks.Interfaces.RealInput IN5(start = 0) "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-88},{-140,-68}}),
              iconTransformation(extent={{-160,-88},{-140,-68}})));

        Electrical.Loads.PSSE.Load_ExtInput Load2(
          P_0=powerFlow.powerflow.loads.PL2,
          Q_0=powerFlow.powerflow.loads.QL2,
          v_0=powerFlow.powerflow.bus.V5,
          angle_0=powerFlow.powerflow.bus.A5,
          d_P=0,
          t1=100,
          d_t=1000)
          annotation (Placement(transformation(extent={{100,-30},{120,-10}})));

        Electrical.Buses.Bus Bus10(v_0=powerFlow.powerflow.bus.V10, angle_0=powerFlow.powerflow.bus.A10)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,-90})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T4(
          G=0,
          B=0,
          CW=1,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={10,-90})));
        GenerationUnits.PSSE.Solar_Units.SolarMPCLocalVQControl PV(
          V_b=480,
          P_0=powerFlow.powerflow.machines.PPV,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QPV,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V8,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A8,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-60},{-20,-40}})));
        Modelica.Blocks.Math.Add AddU3
          annotation (Placement(transformation(extent={{-80,-60},{-60,-40}})));
        Modelica.Blocks.Sources.Constant IN33(k=0)
          annotation (Placement(transformation(extent={{-108,-62},{-96,-50}})));

        Modelica.Blocks.Math.Add AddU4
          annotation (Placement(transformation(extent={{-80,-90},{-60,-70}})));
        Modelica.Blocks.Math.Add AddU5
          annotation (Placement(transformation(extent={{-80,-116},{-60,-96}})));
        Modelica.Blocks.Sources.Constant IN44(k=0)
          annotation (Placement(transformation(extent={{-108,-92},{-96,-80}})));
        Modelica.Blocks.Sources.Constant IN55(k=0)
          annotation (Placement(transformation(extent={{-108,-118},{-96,-106}})));
        GenerationUnits.PSSE.Battery_Units.BESSMPCLocalVQControlLinearized
                                                                 BESS(
          V_base=480,
          V_b(displayUnit="kV") = 480,
          enableV_b=true,
          P_0=powerFlow.powerflow.machines.PBESS,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QBESS,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V10,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A10,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-100},{-20,-80}})));
        Electrical.Buses.Bus Bus8(v_0=powerFlow.powerflow.bus.V8, angle_0=powerFlow.powerflow.bus.A8)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,-50})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T3(
          G=0,
          B=0,
          CW=1,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={12,-50})));
        Electrical.Buses.Bus Bus11(v_0=powerFlow.powerflow.bus.V11, angle_0=powerFlow.powerflow.bus.A11)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,-90})));
        Electrical.Buses.Bus Bus9(v_0=powerFlow.powerflow.bus.V9, angle_0=powerFlow.powerflow.bus.A9)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,-50})));
        Electrical.Buses.Bus Bus7(v_0=powerFlow.powerflow.bus.V7, angle_0=powerFlow.powerflow.bus.A7)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,10})));
        Electrical.Branches.PwLine          L4(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,6},{
                  50,14}})));
        Electrical.Branches.PwLine          L5(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,-54},
                  {50,-46}})));
        Electrical.Branches.PwLine          L6(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,-94},
                  {50,-86}})));
        Modelica.Blocks.Sources.Sine sine(
          amplitude=0,
          f=1/260,
          phase=3.1415926535898,
          startTime=1000)
          annotation (Placement(transformation(extent={{68,-36},{78,-26}})));
        Electrical.Loads.NoiseInjections.WhiteNoiseInjection whiteNoiseInjection(
            active_sigma=0.0000000001, samplePeriod=0.01)
          annotation (Placement(transformation(extent={{66,-18},{78,-6}})));
        Modelica.Blocks.Math.Add add
          annotation (Placement(transformation(extent={{84,-18},{92,-10}})));
        PFData.PowerFlow powerFlow(redeclare record PowerFlow = PFData.PF16)
          annotation (Placement(transformation(extent={{-116,106},{-96,126}})));
        Modelica.Blocks.Interfaces.RealOutput OUT1
          annotation (Placement(transformation(extent={{146,68},{166,88}})));
       Modelica.Blocks.Interfaces.RealOutput OUT2
          annotation (Placement(transformation(extent={{146,48},{166,68}})));
        Modelica.Blocks.Interfaces.RealOutput OUT3
          annotation (Placement(transformation(extent={{146,28},{166,48}})));
        Modelica.Blocks.Interfaces.RealOutput OUT4
          annotation (Placement(transformation(extent={{146,8},{166,28}})));
        Modelica.Blocks.Interfaces.RealOutput OUT5
          annotation (Placement(transformation(extent={{146,-12},{166,8}})));
        Modelica.Blocks.Interfaces.RealOutput OUT6
          annotation (Placement(transformation(extent={{146,-32},{166,-12}})));
        Modelica.Blocks.Interfaces.RealOutput OUT7
          annotation (Placement(transformation(extent={{146,-52},{166,-32}})));
        Modelica.Blocks.Interfaces.RealOutput OUT8
          annotation (Placement(transformation(extent={{146,-72},{166,-52}})));
        Modelica.Blocks.Interfaces.RealOutput OUT9
          annotation (Placement(transformation(extent={{146,-92},{166,-72}})));
        Modelica.Blocks.Interfaces.RealOutput OUT10
          annotation (Placement(transformation(extent={{146,-112},{166,-92}})));
        Modelica.Blocks.Interfaces.RealOutput OUT11
          annotation (Placement(transformation(extent={{170,68},{190,88}})));
        Modelica.Blocks.Interfaces.RealOutput OUT12
          annotation (Placement(transformation(extent={{170,48},{190,68}})));
        Modelica.Blocks.Interfaces.RealOutput OUT13
          annotation (Placement(transformation(extent={{170,28},{190,48}})));
        Modelica.Blocks.Interfaces.RealOutput OUT14
          annotation (Placement(transformation(extent={{170,8},{190,28}})));
        Modelica.Blocks.Interfaces.RealOutput OUT15
          annotation (Placement(transformation(extent={{170,-12},{190,8}})));
        Modelica.Blocks.Interfaces.RealOutput OUT16
          annotation (Placement(transformation(extent={{170,-32},{190,-12}})));
        Modelica.Blocks.Interfaces.RealOutput OUT17
          annotation (Placement(transformation(extent={{170,-52},{190,-32}})));
        Modelica.Blocks.Interfaces.RealOutput OUT18
          annotation (Placement(transformation(extent={{170,-72},{190,-52}})));
        Modelica.Blocks.Interfaces.RealOutput OUT19
          annotation (Placement(transformation(extent={{170,-92},{190,-72}})));
        Modelica.Blocks.Interfaces.RealOutput OUT20
          annotation (Placement(transformation(extent={{170,-112},{190,-92}})));
        Modelica.Blocks.Interfaces.RealOutput OUT21
          annotation (Placement(transformation(extent={{190,68},{210,88}})));
        Modelica.Blocks.Interfaces.RealOutput OUT22
          annotation (Placement(transformation(extent={{190,48},{210,68}})));
        Modelica.Blocks.Interfaces.RealOutput OUT23
          annotation (Placement(transformation(extent={{190,28},{210,48}})));
        Modelica.Blocks.Interfaces.RealOutput OUT24
          annotation (Placement(transformation(extent={{190,8},{210,28}})));
        Modelica.Blocks.Interfaces.RealOutput OUT25
          annotation (Placement(transformation(extent={{190,-12},{210,8}})));
        Modelica.Blocks.Interfaces.RealOutput OUT26
          annotation (Placement(transformation(extent={{190,-32},{210,-12}})));
        Electrical.Loads.PSSE.Load          Load1(
          P_0=-3004660,
          Q_0=-548994,
          v_0=powerFlow.powerflow.bus.V5,
          angle_0=powerFlow.powerflow.bus.A5)
          annotation (Placement(transformation(extent={{-10,-10},{10,10}},
              rotation=180,
              origin={80,58})));
      equation

      OUT1  = G2.gen.w;
      OUT2  = G2.gen.delta;
      OUT3  = G2.gen.P;
      OUT4  = G2.gen.Q;
      OUT5  = G2.gen.p.ir;
      OUT6  = G2.gen.p.ii;
      OUT7  = G2.gen.PMECH;
      OUT8  = G2.sEXSMPC.EFD;
      OUT9  = Bus6.v;
      OUT10 = Bus6.angle;

      OUT11 = PV.rEGCA1_1.Pgen;
      OUT12 = PV.rEGCA1_1.Qgen;
      OUT13 = PV.rEGCA1_1.p.ir;
      OUT14 = PV.rEGCA1_1.p.ii;
      OUT15 = Bus8.v;
      OUT16 = Bus8.angle;

      OUT17 = BESS.rEGCA1_1.Pgen;
      OUT18 = BESS.rEGCA1_1.Qgen;
      OUT19 = BESS.rEGCA1_1.p.ir;
      OUT20 = BESS.rEGCA1_1.p.ii;
      OUT21 = Bus10.v;
      OUT22 = Bus10.angle;

      OUT23 = Load2.P;
      OUT24 = Load2.Q;

      OUT25 = Bus5.v;
      OUT26 = Bus5.angle;

        connect(IN11.y, AddU1.u2) annotation (Line(points={{-95.4,4},{-82,4}},
                            color={0,0,127}));
        connect(IN1, AddU1.u1) annotation (Line(points={{-150,10},{-116,10},{-116,16},
                {-82,16}},
                       color={0,0,127}));

        connect(IN22.y,AddU2. u2) annotation (Line(points={{-95.4,-26},{-82,-26}},
                       color={0,0,127}));
        connect(IN2,AddU2. u1) annotation (Line(points={{-150,-12},{-118,-12},{-118,-14},
                {-82,-14}},
                       color={0,0,127}));
        connect(AddU2.y, G2.Efd_ref)
          annotation (Line(points={{-59,-20},{-52,-20},{-52,4},{-42,4}},
                                                                 color={0,0,127}));
        connect(AddU1.y, G2.P_ref1) annotation (Line(points={{-59,10},{-52,10},{-52,16},
                {-42,16}},                          color={0,0,127}));
        connect(Load2.p, Bus5.p) annotation (Line(points={{110,-10},{110,10},{80,10},{
                80,16}},
                     color={0,0,255}));
        connect(T4.n, Bus10.p)
          annotation (Line(points={{-1,-90},{-10,-90}}, color={0,0,255}));
        connect(Bus6.p, T2.n)
          annotation (Line(points={{-10,10},{-1,10}},
                                                  color={0,0,255}));
        connect(AddU3.y, PV.QINPUT) annotation (Line(points={{-59,-50},{-42,-50}},
                                 color={0,0,127}));
        connect(IN33.y,AddU3. u2)
          annotation (Line(points={{-95.4,-56},{-82,-56}}, color={0,0,127}));
        connect(BESS.p1, Bus10.p)
          annotation (Line(points={{-20,-90},{-10,-90}}, color={0,0,255}));
        connect(BESS.Paux1, AddU4.y) annotation (Line(points={{-42,-84},{-54,-84},{-54,
                -80},{-59,-80}}, color={0,0,127}));
        connect(IN55.y, AddU5.u2)
          annotation (Line(points={{-95.4,-112},{-82,-112}}, color={0,0,127}));
        connect(AddU5.y, BESS.Qext1) annotation (Line(points={{-59,-106},{-52,-106},{-52,
                -96},{-42,-96}},   color={0,0,127}));
        connect(IN44.y, AddU4.u2)
          annotation (Line(points={{-95.4,-86},{-82,-86}}, color={0,0,127}));
        connect(AddU4.u1,IN4)  annotation (Line(points={{-82,-74},{-100,-74},{-100,-70},
                {-116,-70},{-116,-56},{-150,-56}}, color={0,0,127}));
        connect(AddU5.u1,IN5)  annotation (Line(points={{-82,-100},{-116,-100},{-116,-78},
                {-150,-78}}, color={0,0,127}));
        connect(G2.conn, Bus6.p) annotation (Line(points={{-19,10},{-10,10}},
                                           color={0,0,255}));
        connect(AddU3.u1, IN3) annotation (Line(points={{-82,-44},{-118,-44},{-118,-34},
                {-150,-34}}, color={0,0,127}));
        connect(PV.p1, Bus8.p)
          annotation (Line(points={{-20,-50},{-10,-50}}, color={0,0,255}));
        connect(Bus8.p, T3.n)
          annotation (Line(points={{-10,-50},{1,-50}},  color={0,0,255}));
        connect(T2.p, Bus7.p) annotation (Line(points={{21,10},{25.5,10},{25.5,10},{30,
                10}}, color={0,0,255}));
        connect(T3.p, Bus9.p)
          annotation (Line(points={{23,-50},{30,-50}}, color={0,0,255}));
        connect(T4.p, Bus11.p)
          annotation (Line(points={{21,-90},{30,-90}}, color={0,0,255}));
        connect(L4.n, Bus5.p) annotation (Line(points={{49.4,10},{60,10},{60,10},{80,10},
                {80,16}},     color={0,0,255}));
        connect(L5.n, Bus5.p) annotation (Line(points={{49.4,-50},{60,-50},{60,10},{80,
                10},{80,16}}, color={0,0,255}));
        connect(Bus11.p, L6.p)
          annotation (Line(points={{30,-90},{38.6,-90}}, color={0,0,255}));
        connect(Bus9.p, L5.p)
          annotation (Line(points={{30,-50},{38.6,-50}}, color={0,0,255}));
        connect(L6.n, Bus5.p) annotation (Line(points={{49.4,-90},{60,-90},{60,10},{80,
                10},{80,16}}, color={0,0,255}));
        connect(Bus7.p, L4.p) annotation (Line(points={{30,10},{34.3,10},{34.3,10},{38.6,
                10}}, color={0,0,255}));
        connect(sine.y, add.u2) annotation (Line(points={{78.5,-31},{78.5,-16.4},
                {83.2,-16.4}}, color={0,0,127}));
        connect(whiteNoiseInjection.y, add.u1) annotation (Line(points={{78.54,
                -12.06},{80.87,-12.06},{80.87,-11.6},{83.2,-11.6}}, color={0,0,
                127}));
        connect(add.y, Load2.u) annotation (Line(points={{92.4,-14},{97.15,-14},
                {97.15,-14.5},{101.9,-14.5}}, color={0,0,127}));
        connect(Load1.p, Bus5.p)
          annotation (Line(points={{80,48},{80,16}}, color={0,0,255}));
          annotation (Placement(transformation(extent={{140,-20},{160,0}})),
                      Placement(transformation(extent={{140,-40},{160,-20}})),
                      Placement(transformation(extent={{140,-60},{160,-40}})),
                      Placement(transformation(extent={{140,-80},{160,-60}})),
                     Diagram(coordinateSystem(preserveAspectRatio=false,
                extent={{-140,-140},{140,140}}), graphics={
              Rectangle(
                extent={{-160,30},{-134,-90}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,36},{124,-124}},
                lineColor={238,46,47},
                lineThickness=0.5),
              Text(
                extent={{78,-106},{114,-120}},
                textColor={238,46,47},
                textString="Microgrid"),
              Text(
                extent={{-30,-102},{34,-124}},
                textColor={0,140,72},
                textString="Linearization Unit"),
              Text(
                extent={{-164,50},{-132,30}},
                textColor={0,140,72},
                textString="Inputs")}),
          Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),experiment(StopTime=10, __Dymola_Algorithm="Dassl"),
          Icon(coordinateSystem(extent={{-140,-140},{140,140}})));
      end MPCAppliedEnergyLinearized_test22_PSAT_MODEL;

      model Microgrid_with_simplified_renewable
        "THIS ONE IS STABLE, CONTROLLABLE, OBSERVABLE!!!!!!!"
        extends Modelica.Icons.Example;

        parameter Boolean equivalentGRID = true;
        parameter Boolean equivalentsystem = false;

        OpenIPSL.Electrical.Buses.Bus Bus1(v_0=powerFlow.powerflow.bus.V1, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-90,70},{-70,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus2(v_0=powerFlow.powerflow.bus.V2, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-50,70},{-30,90}})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
          R=0.001,
          X=0.2,
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000)  if not equivalentGRID annotation (Placement(transformation(
              extent={{-8,-8},{8,8}},
              rotation=180,
              origin={-60,80})));
        OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
          enableV_b=true,
          v_0=powerFlow.powerflow.bus.V1,
          angle_0=powerFlow.powerflow.bus.A1,
          P_0=powerFlow.powerflow.machines.PG1,
          Q_0=powerFlow.powerflow.machines.QG1,
          V_b=6000)  if not equivalentGRID
          annotation (Placement(transformation(extent={{-112,70},{-92,90}})));
        OpenIPSL.Electrical.Branches.PwLine L1(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{-26,76},
                  {-14,84}})));
        OpenIPSL.Electrical.Buses.Bus Bus3(v_0=powerFlow.powerflow.bus.V3, angle_0=
              powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-10,70},{10,90}})));
        OpenIPSL.Electrical.Buses.Bus Bus4(v_0=powerFlow.powerflow.bus.V4, angle_0=
              powerFlow.powerflow.bus.V4) if not equivalentGRID
          annotation (Placement(transformation(extent={{50,70},{70,90}})));
        OpenIPSL.Electrical.Branches.PwLine L2_1(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,86},
                  {36,94}})));
        OpenIPSL.Electrical.Branches.PwLine L2_2(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,66},
                  {36,74}})));
        OpenIPSL.Electrical.Buses.Bus Bus5(angle_0=powerFlow.powerflow.bus.A5, v_0=
              powerFlow.powerflow.bus.V5)  annotation (Placement(
              transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={80,16})));
        OpenIPSL.Electrical.Branches.PwLine L3(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=-90,
              origin={80,60})));
        OpenIPSL.Electrical.Buses.Bus Bus6(v_0=powerFlow.powerflow.bus.V6, angle_0=
              powerFlow.powerflow.bus.A6) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,10})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000,
          R=0.005,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={10,10})));
        GenerationUnits.PSSE.G2_16MVA                         G2(
          enableV_b=true,
          enableP_0=true,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V6,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A6,
          V_b=6000,
          P_0=powerFlow.powerflow.machines.PG2,
          Q_0=powerFlow.powerflow.machines.QG2,
          enableangle_0=true)
                        annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-30,10})));
        inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000, fn=60)
          annotation (Placement(transformation(extent={{-128,104},{-74,124}})));
        OpenIPSL.Electrical.Loads.PSSE.Load Load1(
          V_b=220000,
          P_0=powerFlow.powerflow.loads.PL1,
          Q_0=powerFlow.powerflow.loads.QL1,
          v_0=powerFlow.powerflow.bus.V3,
          angle_0=powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-20,48},{0,68}})));
        Electrical.Events.Breaker breaker(enableTrigger=false,
          t_o=0.5,
          rc_enabled=true,
          t_rc=10000)       if not equivalentGRID                     annotation (Placement(transformation(
              extent={{-4,-4},{4,4}},
              rotation=90,
              origin={80,26})));

        Modelica.Blocks.Interfaces.RealInput IN1(start=0)
          "Connector of Real input signal 2" annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-150,10}),iconTransformation(extent={{-10,-10},{10,10}}, origin={-150,10})));
        Modelica.Blocks.Sources.Constant IN11(k=0)
          annotation (Placement(transformation(extent={{-108,-2},{-96,10}})));
        Modelica.Blocks.Math.Add AddU1
          annotation (Placement(transformation(extent={{-80,0},{-60,20}})));
        Modelica.Blocks.Sources.Constant IN22(k=0)
          annotation (Placement(transformation(extent={{-108,-32},{-96,-20}})));
        Modelica.Blocks.Math.Add AddU2
          annotation (Placement(transformation(extent={{-80,-30},{-60,-10}})));
        Modelica.Blocks.Interfaces.RealInput IN2(start=0)
          "Connector of Real input signal 2"
                 annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-150,-12}), iconTransformation(extent={{-10,-10},{10,10}},
                origin={-150,-12})));

        Modelica.Blocks.Interfaces.RealInput IN3(start = 0) "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-44},{-140,-24}}),
              iconTransformation(extent={{-160,-44},{-140,-24}})));
        Modelica.Blocks.Interfaces.RealInput IN4(start = 0) "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-66},{-140,-46}}),
              iconTransformation(extent={{-160,-66},{-140,-46}})));
        Modelica.Blocks.Interfaces.RealInput IN5(start = 0) "Connector of Real input signal 1"
          annotation (Placement(transformation(extent={{-160,-88},{-140,-68}}),
              iconTransformation(extent={{-160,-88},{-140,-68}})));

        PFData.PowerFlow powerFlow(redeclare record PowerFlow =
              OpenIPSL.Examples.ModelPredictiveControl.PFData.PF16)
          annotation (Placement(transformation(extent={{-68,104},{-48,124}})));
        Electrical.Machines.PSSE.GENCLS IB(
          V_b=220000,
          v_0=powerFlow.powerflow.bus.V4,
          angle_0=powerFlow.powerflow.bus.A4,
          P_0=powerFlow.powerflow.machines.Pinf,
          Q_0=powerFlow.powerflow.machines.Qinf,
          M_b=100000000,
          X_d=1) if not equivalentGRID annotation (Placement(transformation(extent={{110,70},
                  {100,90}})));
        Electrical.Loads.PSSE.Load_ExtInput Load2(
          P_0=powerFlow.powerflow.loads.PL2,
          Q_0=powerFlow.powerflow.loads.QL2,
          v_0=powerFlow.powerflow.bus.V5,
          angle_0=powerFlow.powerflow.bus.A5,
          d_P=0,
          t1=100,
          d_t=1000)
          annotation (Placement(transformation(extent={{100,-30},{120,-10}})));

        inner Modelica.Blocks.Noise.GlobalSeed globalSeed(useAutomaticSeed=false,
            fixedSeed=10000)
          annotation (Placement(transformation(extent={{-42,102},{-22,122}})));

        Electrical.Buses.Bus Bus10(v_0=powerFlow.powerflow.bus.V10, angle_0=powerFlow.powerflow.bus.A10)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,-90})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T4(
          G=0,
          B=0,
          CW=1,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={10,-90})));
        GenerationUnits.PSSE.Solar_Units.SolarMPCSysIdentification
                                                                PV(
          V_b=480,
          P_0=powerFlow.powerflow.machines.PPV,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QPV,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V8,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A8,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-60},{-20,-40}})));
        Modelica.Blocks.Math.Add AddU3
          annotation (Placement(transformation(extent={{-80,-60},{-60,-40}})));
        Modelica.Blocks.Sources.Constant IN33(k=0)
          annotation (Placement(transformation(extent={{-108,-62},{-96,-50}})));

        Modelica.Blocks.Math.Add AddU4
          annotation (Placement(transformation(extent={{-80,-90},{-60,-70}})));
        Modelica.Blocks.Math.Add AddU5
          annotation (Placement(transformation(extent={{-80,-116},{-60,-96}})));
        Modelica.Blocks.Sources.Constant IN44(k=0)
          annotation (Placement(transformation(extent={{-108,-92},{-96,-80}})));
        Modelica.Blocks.Sources.Constant IN55(k=0)
          annotation (Placement(transformation(extent={{-108,-118},{-96,-106}})));
        GenerationUnits.PSSE.Battery_Units.BESSMPCSysIdentification
                                                                 BESS(
          V_base=480,
          V_b(displayUnit="kV") = 480,
          enableV_b=true,
          P_0=powerFlow.powerflow.machines.PBESS,
          enableP_0=true,
          Q_0=powerFlow.powerflow.machines.QBESS,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V10,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A10,
          enableangle_0=true)
          annotation (Placement(transformation(extent={{-40,-100},{-20,-80}})));
        Electrical.Buses.Bus Bus8(v_0=powerFlow.powerflow.bus.V8, angle_0=powerFlow.powerflow.bus.A8)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={-10,-50})));
        Electrical.Branches.PSSE.TwoWindingTransformer          T3(
          G=0,
          B=0,
          CW=1,
          VNOM1=13800,
          VB1=13800,
          VNOM2=480,
          VB2=480,
          R=0.001,
          X=0.1)  annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={12,-50})));
        Electrical.Buses.Bus Bus11(v_0=powerFlow.powerflow.bus.V11, angle_0=powerFlow.powerflow.bus.A11)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,-90})));
        Electrical.Buses.Bus Bus9(v_0=powerFlow.powerflow.bus.V9, angle_0=powerFlow.powerflow.bus.A9)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,-50})));
        Electrical.Buses.Bus Bus7(v_0=powerFlow.powerflow.bus.V7, angle_0=powerFlow.powerflow.bus.A7)
          annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={30,10})));
        Electrical.Branches.PwLine          L4(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,6},{
                  50,14}})));
        Electrical.Branches.PwLine          L5(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,-54},
                  {50,-46}})));
        Electrical.Branches.PwLine          L6(
          R=0.01,
          X=0.001,
          G=0,
          B=0)  annotation (Placement(transformation(extent={{38,-94},
                  {50,-86}})));
        Modelica.Blocks.Sources.Sine sine(
          amplitude=0,
          f=1/260,
          phase=3.1415926535898,
          startTime=1000)
          annotation (Placement(transformation(extent={{68,-36},{78,-26}})));
        Electrical.Loads.NoiseInjections.WhiteNoiseInjection whiteNoiseInjection(
            active_sigma=0.0000000001, samplePeriod=0.01)
          annotation (Placement(transformation(extent={{66,-18},{78,-6}})));
        Modelica.Blocks.Math.Add add
          annotation (Placement(transformation(extent={{84,-18},{92,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT1
          annotation (Placement(transformation(extent={{140,70},{160,90}})));
       Modelica.Blocks.Interfaces.RealOutput OUT2
          annotation (Placement(transformation(extent={{140,50},{160,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT3
          annotation (Placement(transformation(extent={{140,30},{160,50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT4
          annotation (Placement(transformation(extent={{140,10},{160,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT5
          annotation (Placement(transformation(extent={{140,-10},{160,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT6
          annotation (Placement(transformation(extent={{140,-30},{160,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT7
          annotation (Placement(transformation(extent={{140,-50},{160,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT8
          annotation (Placement(transformation(extent={{140,-70},{160,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT9
          annotation (Placement(transformation(extent={{140,-90},{160,-70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT10
          annotation (Placement(transformation(extent={{140,-110},{160,-90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT11
          annotation (Placement(transformation(extent={{164,70},{184,90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT12
          annotation (Placement(transformation(extent={{164,50},{184,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT13
          annotation (Placement(transformation(extent={{164,30},{184,50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT14
          annotation (Placement(transformation(extent={{164,10},{184,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT15
          annotation (Placement(transformation(extent={{164,-10},{184,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT16
          annotation (Placement(transformation(extent={{164,-30},{184,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT17
          annotation (Placement(transformation(extent={{164,-50},{184,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT18
          annotation (Placement(transformation(extent={{164,-70},{184,-50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT19
          annotation (Placement(transformation(extent={{164,-90},{184,-70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT20
          annotation (Placement(transformation(extent={{164,-110},{184,-90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT21
          annotation (Placement(transformation(extent={{184,70},{204,90}})));
        Modelica.Blocks.Interfaces.RealOutput OUT22
          annotation (Placement(transformation(extent={{184,50},{204,70}})));
        Modelica.Blocks.Interfaces.RealOutput OUT23
          annotation (Placement(transformation(extent={{184,30},{204,50}})));
        Modelica.Blocks.Interfaces.RealOutput OUT24
          annotation (Placement(transformation(extent={{184,10},{204,30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT25
          annotation (Placement(transformation(extent={{184,-10},{204,10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT26
          annotation (Placement(transformation(extent={{184,-30},{204,-10}})));
        Modelica.Blocks.Interfaces.RealOutput OUT27
          annotation (Placement(transformation(extent={{186,-50},{206,-30}})));
        Modelica.Blocks.Interfaces.RealOutput OUT28
          annotation (Placement(transformation(extent={{184,-70},{204,-50}})));
      equation

      OUT1 = G2.gen.w;
      OUT2 = G2.gen.delta;
      OUT3 = G2.gen.Epq;
      OUT4 = G2.gen.PSIkd;
      OUT5 = G2.gen.PSIppq;
      OUT6 = G2.sEXSMPC.simpleLagLim.state;
      OUT7 = G2.sEXSMPC.leadLag.TF.x_scaled[1];
      OUT8 = G2.gASTMPC.simpleLagLim.state;
      OUT9 = G2.gASTMPC.simpleLag.state;
      OUT10 = G2.gASTMPC.simpleLag1.state;

      // OUT1 = G2.gen.w;
      // OUT2 = G2.gen.delta;
      // OUT3 = G2.gen.P;
      // OUT4 = G2.gen.Q;
      // OUT5 = G2.gen.p.ir;
      // OUT6 = G2.gen.p.ii;
      // OUT7 = G2.gen.PMECH;
      // OUT8 = G2.sEXSMPC.EFD;
      // OUT9 = G2.gASTMPC.simpleLag1.y;
      OUT11 = Bus6.v;
      OUT12 = Bus6.angle;

      OUT13 =PV.rEGCA1_1.Pgen;
      OUT14 =PV.rEGCA1_1.Qgen;
      OUT15 =PV.rEGCA1_1.p.ir;
      OUT16 =PV.rEGCA1_1.p.ii;
      OUT17 = Bus8.v;
      OUT18 = Bus8.angle;

      OUT19 =BESS.rEGCA1_1.Pgen;
      OUT20 =BESS.rEGCA1_1.Qgen;
      OUT21 =BESS.rEGCA1_1.p.ir;
      OUT22 =BESS.rEGCA1_1.p.ii;
      OUT23 = Bus10.v;
      OUT24 = Bus10.angle;

      OUT25 = Load2.P;
      OUT26 = Load2.Q;

      OUT27 = Bus5.v;
      OUT28 = Bus5.angle;


        connect(T1.p, Bus2.p)
          annotation (Line(points={{-51.2,80},{-40,80}}, color={0,0,255}));
        connect(Bus1.p, T1.n)
          annotation (Line(points={{-80,80},{-68.8,80}}, color={0,0,255}));
        connect(G1.conn, Bus1.p)
          annotation (Line(points={{-91,80},{-80,80}}, color={0,0,255}));
        connect(L1.n, Bus3.p)
          annotation (Line(points={{-14.6,80},{0,80}}, color={0,0,255}));
        connect(L1.p, Bus2.p)
          annotation (Line(points={{-25.4,80},{-40,80}}, color={0,0,255}));
        connect(L2_2.n, Bus4.p) annotation (Line(points={{35.4,70},{44,70},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.n, Bus4.p) annotation (Line(points={{35.4,90},{44,90},{44,80},{60,
                80}}, color={0,0,255}));
        connect(L2_1.p, Bus3.p) annotation (Line(points={{24.6,90},{16,90},{16,80},{0,
                80}}, color={0,0,255}));
        connect(L2_2.p, Bus3.p) annotation (Line(points={{24.6,70},{16,70},{16,80},{0,
                80}}, color={0,0,255}));
        connect(Load1.p, Bus3.p)
          annotation (Line(points={{-10,68},{-10,80},{0,80}}, color={0,0,255}));
        connect(L3.p, Bus4.p)
          annotation (Line(points={{80,65.4},{80,80},{60,80}}, color={0,0,255}));
        connect(breaker.s, Bus5.p)
          annotation (Line(points={{80,22},{80,16}},color={0,0,255}));
        connect(breaker.r, L3.n)
          annotation (Line(points={{80,30},{80,54.6}},color={0,0,255}));
        connect(IN11.y, AddU1.u2) annotation (Line(points={{-95.4,4},{-82,4}},
                            color={0,0,127}));
        connect(IN1, AddU1.u1) annotation (Line(points={{-150,10},{-116,10},{-116,16},
                {-82,16}},
                       color={0,0,127}));

        connect(IN22.y,AddU2. u2) annotation (Line(points={{-95.4,-26},{-82,-26}},
                       color={0,0,127}));
        connect(IN2,AddU2. u1) annotation (Line(points={{-150,-12},{-118,-12},{-118,-14},
                {-82,-14}},
                       color={0,0,127}));
        connect(AddU2.y, G2.Efd_ref)
          annotation (Line(points={{-59,-20},{-52,-20},{-52,4},{-42,4}},
                                                                 color={0,0,127}));
        connect(AddU1.y, G2.P_ref1) annotation (Line(points={{-59,10},{-52,10},{-52,16},
                {-42,16}},                          color={0,0,127}));
        connect(IB.p, Bus4.p)
          annotation (Line(points={{100,80},{60,80}}, color={0,0,255}));
        connect(Load2.p, Bus5.p) annotation (Line(points={{110,-10},{110,10},{80,10},{
                80,16}},
                     color={0,0,255}));
        connect(T4.n, Bus10.p)
          annotation (Line(points={{-1,-90},{-10,-90}}, color={0,0,255}));
        connect(Bus6.p, T2.n)
          annotation (Line(points={{-10,10},{-1,10}},
                                                  color={0,0,255}));
        connect(IN33.y,AddU3. u2)
          annotation (Line(points={{-95.4,-56},{-82,-56}}, color={0,0,127}));
        connect(BESS.p1, Bus10.p)
          annotation (Line(points={{-20,-90},{-10,-90}}, color={0,0,255}));
        connect(BESS.Paux1, AddU4.y) annotation (Line(points={{-42,-84},{-54,-84},{-54,
                -80},{-59,-80}}, color={0,0,127}));
        connect(IN55.y, AddU5.u2)
          annotation (Line(points={{-95.4,-112},{-82,-112}}, color={0,0,127}));
        connect(AddU5.y, BESS.Qext1) annotation (Line(points={{-59,-106},{-52,-106},{-52,
                -96},{-42,-96}},   color={0,0,127}));
        connect(IN44.y, AddU4.u2)
          annotation (Line(points={{-95.4,-86},{-82,-86}}, color={0,0,127}));
        connect(AddU4.u1,IN4)  annotation (Line(points={{-82,-74},{-100,-74},{-100,-70},
                {-116,-70},{-116,-56},{-150,-56}}, color={0,0,127}));
        connect(AddU5.u1,IN5)  annotation (Line(points={{-82,-100},{-116,-100},{-116,-78},
                {-150,-78}}, color={0,0,127}));
        connect(G2.conn, Bus6.p) annotation (Line(points={{-19,10},{-10,10}},
                                           color={0,0,255}));
        connect(AddU3.u1, IN3) annotation (Line(points={{-82,-44},{-118,-44},{-118,-34},
                {-150,-34}}, color={0,0,127}));
        connect(PV.p1, Bus8.p)
          annotation (Line(points={{-20,-50},{-10,-50}}, color={0,0,255}));
        connect(Bus8.p, T3.n)
          annotation (Line(points={{-10,-50},{1,-50}},  color={0,0,255}));
        connect(T2.p, Bus7.p) annotation (Line(points={{21,10},{25.5,10},{25.5,10},{30,
                10}}, color={0,0,255}));
        connect(T3.p, Bus9.p)
          annotation (Line(points={{23,-50},{30,-50}}, color={0,0,255}));
        connect(T4.p, Bus11.p)
          annotation (Line(points={{21,-90},{30,-90}}, color={0,0,255}));
        connect(L4.n, Bus5.p) annotation (Line(points={{49.4,10},{60,10},{60,10},{80,10},
                {80,16}},     color={0,0,255}));
        connect(L5.n, Bus5.p) annotation (Line(points={{49.4,-50},{60,-50},{60,10},{80,
                10},{80,16}}, color={0,0,255}));
        connect(Bus11.p, L6.p)
          annotation (Line(points={{30,-90},{38.6,-90}}, color={0,0,255}));
        connect(Bus9.p, L5.p)
          annotation (Line(points={{30,-50},{38.6,-50}}, color={0,0,255}));
        connect(L6.n, Bus5.p) annotation (Line(points={{49.4,-90},{60,-90},{60,10},{80,
                10},{80,16}}, color={0,0,255}));
        connect(Bus7.p, L4.p) annotation (Line(points={{30,10},{34.3,10},{34.3,10},{38.6,
                10}}, color={0,0,255}));
        connect(sine.y, add.u2) annotation (Line(points={{78.5,-31},{78.5,-16.4},
                {83.2,-16.4}}, color={0,0,127}));
        connect(whiteNoiseInjection.y, add.u1) annotation (Line(points={{78.54,
                -12.06},{80.87,-12.06},{80.87,-11.6},{83.2,-11.6}}, color={0,0,
                127}));
        connect(add.y, Load2.u) annotation (Line(points={{92.4,-14},{97.15,-14},
                {97.15,-14.5},{101.9,-14.5}}, color={0,0,127}));
        connect(PV.Qref, AddU3.y) annotation (Line(points={{-42,-56},{-54,-56},{-54,-50},
                {-59,-50}}, color={0,0,127}));
          annotation (Placement(transformation(extent={{140,-20},{160,0}})),
                      Placement(transformation(extent={{140,-40},{160,-20}})),
                      Placement(transformation(extent={{140,-60},{160,-40}})),
                      Placement(transformation(extent={{140,-80},{160,-60}})),
                     Diagram(coordinateSystem(preserveAspectRatio=false,
                extent={{-140,-140},{140,140}}), graphics={
              Rectangle(
                extent={{-160,30},{-134,-90}},
                lineColor={0,140,72},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,36},{124,-124}},
                lineColor={238,46,47},
                lineThickness=0.5),
              Rectangle(
                extent={{-128,98},{124,38}},
                lineColor={0,128,255},
                lineThickness=0.5),
              Text(
                extent={{78,-106},{114,-120}},
                textColor={238,46,47},
                textString="Microgrid"),
              Text(
                extent={{76,58},{128,34}},
                textColor={28,108,200},
                textString="Utility Grid"),
              Text(
                extent={{-30,-102},{34,-124}},
                textColor={0,140,72},
                textString="Linearization Unit"),
              Text(
                extent={{-164,50},{-132,30}},
                textColor={0,140,72},
                textString="Inputs")}),
          Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),experiment(
            StopTime=10,
            __Dymola_NumberOfIntervals=10000,
            __Dymola_Algorithm="Dassl"),
          Icon(coordinateSystem(extent={{-140,-140},{140,140}})));
      end Microgrid_with_simplified_renewable;
    end EquipmentOnlyLinearization;

    package MicrogridWithDistrictHeating
      "Microgrid Model with District Heating System and Load"
      model OptimizationModel_with_DistrictHeating
        "THIS ONE IS STABLE, CONTROLLABLE, OBSERVABLE!!!!!!!"
        extends Modelica.Icons.Example;

        parameter Boolean equivalentGRID = false;
        parameter Boolean equivalentsystem = false;

        OpenIPSL.Electrical.Buses.Bus Bus1(v_0=powerFlow.powerflow.bus.V1, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-90,60},{-70,80}})));
        OpenIPSL.Electrical.Buses.Bus Bus2(v_0=powerFlow.powerflow.bus.V2, angle_0=
              powerFlow.powerflow.bus.A1) if not equivalentGRID
          annotation (Placement(transformation(extent={{-50,60},{-30,80}})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T1(
          R=0.001,
          X=0.2,
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000)  if not equivalentGRID annotation (Placement(transformation(
              extent={{-8,-8},{8,8}},
              rotation=180,
              origin={-60,70})));
        OpenIPSL.Examples.OpenCPS.Generators.G1 G1(
          enableV_b=true,
          v_0=powerFlow.powerflow.bus.V1,
          angle_0=powerFlow.powerflow.bus.A1,
          P_0=powerFlow.powerflow.machines.PG1,
          Q_0=powerFlow.powerflow.machines.QG1,
          V_b=6000)  if not equivalentGRID
          annotation (Placement(transformation(extent={{-112,60},{-92,80}})));
        OpenIPSL.Electrical.Branches.PwLine L1(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{-26,66},{-14,74}})));
        OpenIPSL.Electrical.Buses.Bus Bus3(v_0=powerFlow.powerflow.bus.V3, angle_0=
              powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-10,60},{10,80}})));
        OpenIPSL.Electrical.Buses.Bus Bus4(v_0=powerFlow.powerflow.bus.V4, angle_0=
              powerFlow.powerflow.bus.V4) if not equivalentGRID
          annotation (Placement(transformation(extent={{50,60},{70,80}})));
        OpenIPSL.Electrical.Branches.PwLine L2_1(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,76},{36,84}})));
        OpenIPSL.Electrical.Branches.PwLine L2_2(
          R=0.0005,
          X=0.1,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(extent={{24,56},{36,64}})));
        OpenIPSL.Electrical.Buses.Bus Bus5(angle_0=powerFlow.powerflow.bus.A5, v_0=
              powerFlow.powerflow.bus.V5)  annotation (Placement(
              transformation(
              extent={{-10,-10},{10,10}},
              rotation=90,
              origin={80,6})));
        OpenIPSL.Electrical.Branches.PwLine L3(
          R=0.001,
          X=0.2,
          G=0,
          B=0) if not equivalentGRID annotation (Placement(transformation(
              extent={{-6,-4},{6,4}},
              rotation=-90,
              origin={80,50})));
        OpenIPSL.Electrical.Buses.Bus Bus6(v_0=powerFlow.powerflow.bus.V6, angle_0=
              powerFlow.powerflow.bus.A6) annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=180,
              origin={34,-36})));
        OpenIPSL.Electrical.Branches.PSSE.TwoWindingTransformer T2(
          G=0,
          B=0,
          VNOM1=13800,
          VB1=13800,
          VNOM2=6000,
          VB2=6000,
          R=0.005,
          X=0.1)  annotation (Placement(transformation(
              extent={{-8,-8},{8,8}},
              rotation=270,
              origin={50,-16})));
        GenerationUnits.PSSE.G2_16MVA_THERMAL                 G2(
          enableV_b=true,
          enableP_0=true,
          enableQ_0=true,
          v_0=powerFlow.powerflow.bus.V6,
          enablev_0=true,
          angle_0=powerFlow.powerflow.bus.A6,
          V_b=6000,
          P_0=powerFlow.powerflow.machines.PG2,
          Q_0=powerFlow.powerflow.machines.QG2,
          enableangle_0=true)
                        annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={10,-36})));
        inner OpenIPSL.Electrical.SystemBase SysData(S_b=100000000, fn=60)
          annotation (Placement(transformation(extent={{-128,94},{-74,114}})));
        OpenIPSL.Electrical.Loads.PSSE.Load Load1(
          V_b=220000,
          P_0=powerFlow.powerflow.loads.PL1,
          Q_0=powerFlow.powerflow.loads.QL1,
          v_0=powerFlow.powerflow.bus.V3,
          angle_0=powerFlow.powerflow.bus.A3) if not equivalentGRID
          annotation (Placement(transformation(extent={{-20,38},{0,58}})));
        Electrical.Events.Breaker breaker(enableTrigger=false,
          t_o=1.01,
          rc_enabled=true,
          t_rc=80.01)       if not equivalentGRID                     annotation (Placement(transformation(
              extent={{-4,-4},{4,4}},
              rotation=90,
              origin={80,16})));

        Modelica.Blocks.Interfaces.RealInput IN1(start=0)
          "Connector of Real input signal 2" annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-150,0}), iconTransformation(extent={{-10,-10},{10,10}}, origin=
                 {-150,0})));
        Modelica.Blocks.Sources.Constant IN11(k=0)
          annotation (Placement(transformation(extent={{-120,-40},{-100,-20}})));
        Modelica.Blocks.Math.Add AddU1
          annotation (Placement(transformation(extent={{-80,-16},{-60,4}})));
        Modelica.Blocks.Sources.Constant IN22(k=0)
          annotation (Placement(transformation(extent={{-120,-100},{-100,-80}})));
        Modelica.Blocks.Math.Add AddU2
          annotation (Placement(transformation(extent={{-80,-76},{-60,-56}})));
        Modelica.Blocks.Interfaces.RealInput IN2(start=0)
          "Connector of Real input signal 2" annotation (Placement(transformation(
              extent={{-10,-10},{10,10}},
              rotation=0,
              origin={-150,-60}), iconTransformation(extent={{-10,-10},{10,10}},
                origin={-150,-60})));
        Modelica.Blocks.Interfaces.RealOutput OUT1
          annotation (Placement(transformation(extent={{140,58},{160,78}})));
       Modelica.Blocks.Interfaces.RealOutput OUT2
          annotation (Placement(transformation(extent={{140,38},{160,58}})));
        Modelica.Blocks.Interfaces.RealOutput OUT3
          annotation (Placement(transformation(extent={{140,18},{160,38}})));
        Modelica.Blocks.Interfaces.RealOutput OUT4
          annotation (Placement(transformation(extent={{140,-2},{160,18}})));
        Modelica.Blocks.Interfaces.RealOutput OUT5
          annotation (Placement(transformation(extent={{140,-22},{160,-2}})));
        Modelica.Blocks.Interfaces.RealOutput OUT6
          annotation (Placement(transformation(extent={{140,-42},{160,-22}})));
        Modelica.Blocks.Interfaces.RealOutput OUT7
          annotation (Placement(transformation(extent={{140,-62},
                  {160,-42}})));
        Modelica.Blocks.Interfaces.RealOutput OUT8
          annotation (Placement(transformation(extent={{140,-82},
                  {160,-62}})));
        Modelica.Blocks.Interfaces.RealOutput OUT9    annotation (Placement(transformation(extent={{140,-42},{160,-22}})));
        Modelica.Blocks.Interfaces.RealOutput OUT10   annotation (Placement(transformation(extent={{140,-62},{160,-42}})));
        Modelica.Blocks.Interfaces.RealOutput OUT11  annotation (Placement(transformation(extent={{140,-82},{160,-62}})));
        Modelica.Blocks.Interfaces.RealOutput OUT12    annotation (Placement(transformation(extent={{140,-42},{160,-22}})));
        Modelica.Blocks.Interfaces.RealOutput OUT13   annotation (Placement(transformation(extent={{140,-62},{160,-42}})));
        Modelica.Blocks.Interfaces.RealOutput OUT14  annotation (Placement(transformation(extent={{140,-82},{160,-62}})));
        Modelica.Blocks.Interfaces.RealOutput OUT15  annotation (Placement(transformation(extent={{140,-82},{160,-62}})));

        PFData.PowerFlow powerFlow(redeclare record PowerFlow =
              OpenIPSL.Examples.ModelPredictiveControl.PFData.PF02)
          annotation (Placement(transformation(extent={{-68,94},{-48,114}})));
        Electrical.Machines.PSSE.GENCLS IB(
          V_b=220000,
          v_0=powerFlow.powerflow.bus.V4,
          angle_0=powerFlow.powerflow.bus.A4,
          P_0=powerFlow.powerflow.machines.Pinf,
          Q_0=powerFlow.powerflow.machines.Qinf,
          M_b=100000000,
          X_d=1) if not equivalentGRID annotation (Placement(transformation(extent={{110,60},{100,80}})));
        Electrical.Loads.PSSE.Load_ExtInput Load2(
          P_0=powerFlow.powerflow.loads.PL2,
          Q_0=powerFlow.powerflow.loads.QL2,
          v_0=powerFlow.powerflow.bus.V5,
          angle_0=powerFlow.powerflow.bus.A5,
          d_P=0,
          t1=100,
          d_t=1000)
          annotation (Placement(transformation(extent={{100,-40},{120,-20}})));
        Electrical.Loads.NoiseInjections.WhiteNoiseInjection whiteNoiseInjection(
            active_sigma=0.0000000005,
                                  samplePeriod=0.02)
          annotation (Placement(transformation(extent={{70,-30},{82,-18}})));

        inner Modelica.Blocks.Noise.GlobalSeed globalSeed(useAutomaticSeed=false,
            fixedSeed=10000)
          annotation (Placement(transformation(extent={{-42,92},{-22,112}})));
        Modelica.Blocks.Sources.Sine sine(
          amplitude=0,
          f=1/260,
          phase=3.1415926535898,
          startTime=5.5)
          annotation (Placement(transformation(extent={{72,-44},{82,-34}})));
        Modelica.Blocks.Math.Add add
          annotation (Placement(transformation(extent={{86,-30},{94,-22}})));

        ThermalPower.DistrictHeating.Consumers.IdealHeatConsumer
          idealHeatConsumer(use_heatDemand_in=false)
          annotation (Placement(transformation(extent={{88,-78},{108,-58}})));
        ThermalPower.TwoPhase.FlowChannels.DualPipe_dynamicDelay
          dualPipe_dynamicDelay(N_B_supply=1, N_B_return=1)
          annotation (Placement(transformation(extent={{56,-84},{76,-64}})));
        Modelon.ThermoFluid.Sources.PressureBoundary pressureBoundary(N=1)
          annotation (Placement(transformation(extent={{16,-82},{36,-62}})));
      equation

        OUT1 = G2.gen.w;
        OUT2 = G2.gen.delta;
        OUT3 = G2.gen.Epq;
        OUT4 = G2.gen.PSIkd;
        OUT5 = G2.gen.PSIppq;
        OUT6 = G2.sEXSMPC.simpleLagLim.state;
        OUT7 = G2.sEXSMPC.leadLag.TF.x[1];
        OUT8 = G2.gASTMPC.simpleLagLim.state;
        OUT9 = G2.gASTMPC.simpleLag.state;
        OUT10 = G2.gASTMPC.simpleLag1.state;
        OUT11 = G2.gASTMPC.PMECH;
        OUT12 = G2.sEXSMPC.EFD;
        OUT13 = Bus5.v;
        OUT14 = Bus5.angle;
        OUT15 = G2.gen.P;

        connect(T1.p, Bus2.p)
          annotation (Line(points={{-51.2,70},{-40,70}}, color={0,0,255}));
        connect(Bus1.p, T1.n)
          annotation (Line(points={{-80,70},{-68.8,70}}, color={0,0,255}));
        connect(G1.conn, Bus1.p)
          annotation (Line(points={{-91,70},{-80,70}}, color={0,0,255}));
        connect(L1.n, Bus3.p)
          annotation (Line(points={{-14.6,70},{0,70}}, color={0,0,255}));
        connect(L1.p, Bus2.p)
          annotation (Line(points={{-25.4,70},{-40,70}}, color={0,0,255}));
        connect(L2_2.n, Bus4.p) annotation (Line(points={{35.4,60},{44,60},{44,70},{
                60,70}},
                      color={0,0,255}));
        connect(L2_1.n, Bus4.p) annotation (Line(points={{35.4,80},{44,80},{44,70},{
                60,70}},
                      color={0,0,255}));
        connect(L2_1.p, Bus3.p) annotation (Line(points={{24.6,80},{16,80},{16,70},{0,
                70}}, color={0,0,255}));
        connect(L2_2.p, Bus3.p) annotation (Line(points={{24.6,60},{16,60},{16,70},{0,
                70}}, color={0,0,255}));
        connect(G2.conn, Bus6.p)
          annotation (Line(points={{21,-36},{34,-36}}, color={0,0,255}));
        connect(Load1.p, Bus3.p)
          annotation (Line(points={{-10,58},{-10,70},{0,70}}, color={0,0,255}));
        connect(L3.p, Bus4.p)
          annotation (Line(points={{80,55.4},{80,70},{60,70}}, color={0,0,255}));
        connect(breaker.s, Bus5.p)
          annotation (Line(points={{80,12},{80,6}}, color={0,0,255}));
        connect(breaker.r, L3.n)
          annotation (Line(points={{80,20},{80,44.6}},color={0,0,255}));
        connect(T2.n, Bus6.p)
          annotation (Line(points={{50,-24.8},{50,-36},{34,-36}}, color={0,0,255}));
        connect(IN11.y, AddU1.u2) annotation (Line(points={{-99,-30},{-90,-30},{-90,-12},
                {-82,-12}}, color={0,0,127}));
        connect(IN1, AddU1.u1) annotation (Line(points={{-150,0},{-82,0}},
                       color={0,0,127}));
        connect(T2.p, Bus5.p) annotation (Line(points={{50,-7.2},{50,0},{80,0},{80,6}},
              color={0,0,255}));

        connect(IN22.y,AddU2. u2) annotation (Line(points={{-99,-90},{-90,-90},{-90,-72},
                {-82,-72}},
                       color={0,0,127}));
        connect(IN2,AddU2. u1) annotation (Line(points={{-150,-60},{-82,-60}},
                       color={0,0,127}));
        connect(AddU2.y, G2.Efd_ref)
          annotation (Line(points={{-59,-66},{-10,-66},{-10,-42},{-2,-42}},
                                                                 color={0,0,127}));
        connect(AddU1.y, G2.P_ref1) annotation (Line(points={{-59,-6},{-10,-6},{-10,-30},
                {-2,-30}},                          color={0,0,127}));
        connect(IB.p, Bus4.p)
          annotation (Line(points={{100,70},{60,70}}, color={0,0,255}));
        connect(Load2.p, Bus5.p) annotation (Line(points={{110,-20},{110,0},{80,0},{80,
                6}}, color={0,0,255}));
        connect(sine.y, add.u2) annotation (Line(points={{82.5,-39},{82.5,-34},{85.2,-34},
                {85.2,-28.4}}, color={0,0,127}));
        connect(whiteNoiseInjection.y, add.u1) annotation (Line(points={{82.54,-24.06},
                {82.54,-23.6},{85.2,-23.6}}, color={0,0,127}));
        connect(add.y, Load2.u) annotation (Line(points={{94.4,-26},{94.4,-24.5},{101.9,
                -24.5}}, color={0,0,127}));
        connect(dualPipe_dynamicDelay.portB_supply[1], idealHeatConsumer.portA)
          annotation (Line(points={{76.2,-72},{88,-72}}, color={0,0,255}));
        connect(dualPipe_dynamicDelay.portB_return[1], idealHeatConsumer.portB)
          annotation (Line(points={{76,-76},{88,-76}}, color={0,0,255}));
        connect(pressureBoundary.fluidPort[1], dualPipe_dynamicDelay.portA_supply)
          annotation (Line(points={{35,-72},{56,-72}}, color={255,128,0}));
          annotation (Placement(transformation(extent={{140,-20},{160,0}})),
                      Placement(transformation(extent={{140,-40},{160,-20}})),
                      Placement(transformation(extent={{140,-60},{160,-40}})),
                      Placement(transformation(extent={{140,-80},{160,-60}})),
                     Diagram(coordinateSystem(preserveAspectRatio=false,
                extent={{-140,-120},{140,120}}), graphics={
              Text(
                extent={{76,48},{128,24}},
                textColor={28,108,200},
                textString="Utility Grid"),
              Text(
                extent={{-164,40},{-132,20}},
                textColor={0,140,72},
                textString="Inputs"),
              Text(
                extent={{128,108},{168,88}},
                textColor={0,140,72},
                textString="Outputs")}),
          Documentation(info="<html>
<p>This example system shows how the preparation for resynchronization of Generator 2 to the grid. Note that at 2 seconds, a signal is triggered so voltages between buses 3 and 4 should be equal.</p>
<p>Simulate the system for 10 seconds. Variables of interest are:</p>
<ul>
<li><code>B3.v</code></li>
<li><code>B4.v</code></li>
<li><code>G1.gen.SPEED</code></li>
<li><code>G2.gen.SPEED</code></li>
</ul>
<p>Note the behavior of those variables before and after the connection of generator G2 to the main grid.</p>
</html>"),experiment(
            StopTime=10,
            __Dymola_NumberOfIntervals=100,
            __Dymola_Algorithm="Dassl"));
      end OptimizationModel_with_DistrictHeating;

      model LearningThermalPower

        parameter Modelica.Units.SI.Temperature T0=70 "Supply temperature";


        ThermalPower.DistrictHeating.Consumers.IdealHeatConsumer idealHeatConsumer(
            redeclare package Medium =
              Modelon.Media.PreDefined.TwoPhase.WaterIF97,
            use_heatDemand_in=true)
          annotation (Placement(transformation(extent={{32,-4},{52,16}})));
        ThermalPower.TwoPhase.FlowChannels.DualPipe_dynamicDelay
          dualPipe_dynamicDelay(N_B_supply=1, N_B_return=1)
          annotation (Placement(transformation(extent={{0,-10},{20,10}})));
        Modelon.ThermoFluid.Sources.PressureBoundary pressureBoundary(
          redeclare package Medium =
              Modelon.Media.PreDefined.TwoPhase.WaterIF97,
          energyDefinition=Modelon.ThermoFluid.Choices.EnergyDefinition.T,
          p=500000,
          T=298.15,
          pressureUnit=Modelon.ThermoFluid.Choices.RealPressureUnit.Pa,
          temperatureUnit=Modelon.ThermoFluid.Choices.RealTemperatureUnit.degC,
          use_p_in=false,
          use_Th_in=false,
          N=1) annotation (Placement(transformation(extent={{-60,-30},{-40,-10}})));

        Modelica.Blocks.Sources.Ramp           ThermalLoad(
          height=500,
          duration=100,
          offset=100,
          startTime=10)
          annotation (Placement(transformation(extent={{90,0},{70,20}})));
        Modelon.ThermoFluid.Sources.PressureBoundary pressureBoundary_supply(
          redeclare package Medium =
              Modelon.Media.PreDefined.TwoPhase.WaterIF97,
          pressureUnit=Modelon.ThermoFluid.Choices.RealPressureUnit.bar,
          temperatureUnit=Modelon.ThermoFluid.Choices.RealTemperatureUnit.degC,
          use_p_in=true,
          use_Th_in=true,
          N=1) annotation (Placement(transformation(extent={{-60,10},{-40,30}})));
        Modelica.Blocks.Sources.RealExpression SourcePressure(y=8)
          annotation (Placement(transformation(extent={{-92,26},{-72,46}})));
        Modelica.Blocks.Sources.RealExpression SourceTemperature(y=100)
          annotation (Placement(transformation(extent={{-92,50},{-72,70}})));
      equation
        connect(dualPipe_dynamicDelay.portB_supply[1], idealHeatConsumer.portA)
          annotation (Line(points={{20.2,2},{32,2}}, color={0,0,255}));
        connect(dualPipe_dynamicDelay.portB_return[1], idealHeatConsumer.portB)
          annotation (Line(points={{20,-2},{32,-2}}, color={0,0,255}));
        connect(idealHeatConsumer.heatDemand, ThermalLoad.y)
          annotation (Line(points={{53,10},{69,10}}, color={0,0,127}));
        connect(pressureBoundary.fluidPort[1], dualPipe_dynamicDelay.portA_return)
          annotation (Line(points={{-41,-20},{-20,-20},{-20,-2},{0,-2}}, color={255,128,
                0}));
        connect(pressureBoundary_supply.fluidPort[1], dualPipe_dynamicDelay.portA_supply)
          annotation (Line(points={{-41,20},{-20,20},{-20,2},{0,2}}, color={255,128,0}));
        connect(SourcePressure.y, pressureBoundary_supply.p_in)
          annotation (Line(points={{-71,36},{-56,36},{-56,30}}, color={0,0,127}));
        connect(SourceTemperature.y, pressureBoundary_supply.T_in) annotation (
            Line(points={{-71,60},{-49,60},{-49,30}}, color={0,0,127}));
        annotation (Icon(coordinateSystem(preserveAspectRatio=false)), Diagram(
              coordinateSystem(preserveAspectRatio=false)));
      end LearningThermalPower;
    end MicrogridWithDistrictHeating;
  end PSSE;

  package PFData
    record PowerFlowTemplate "Template Record for Power Flow Results"
      extends Modelica.Icons.Record;

      annotation (Documentation(info="<html>
<p>Template Record for Power Flow Results.</p>
</html>"));
    end PowerFlowTemplate;

    record PowerFlow "Record containing replaceable record with power flow results"
      extends Modelica.Icons.Record;

      replaceable record PowerFlow =
          PowerFlowTemplate constrainedby PowerFlowTemplate "Replaceable power flow record"
                                                      annotation (
          choicesAllMatching);

      PowerFlow powerflow;

      annotation (Documentation(info="<html>
<p>Instantiable record containing the replaceable record with power flow results.</p>
</html>"));
    end PowerFlow;

    extends Modelica.Icons.RecordsPackage;

    package BusData
      partial record BusTemplatewithRenewables2
        "Record template for power flow solutions in buses"

        parameter OpenIPSL.Types.PerUnit V1 "Voltage magnitude at G1"
          annotation (Dialog(enable=false));
        parameter OpenIPSL.Types.Angle A1 "Voltage angle at G1" annotation (Dialog(enable=false));

        parameter OpenIPSL.Types.PerUnit V2 "Voltage magnitude at bus 2"
          annotation (Dialog(enable=false));
        parameter OpenIPSL.Types.Angle A2 "Voltage angle at bus 2" annotation (Dialog(enable=false));

        parameter OpenIPSL.Types.PerUnit V3 "Voltage magnitude at bus 3"
          annotation (Dialog(enable=false));
        parameter OpenIPSL.Types.Angle A3 "Voltage angle at bus 3" annotation (Dialog(enable=false));

        parameter OpenIPSL.Types.PerUnit V4 "Voltage magnitude at bus 4"
          annotation (Dialog(enable=false));
        parameter OpenIPSL.Types.Angle A4 "Voltage angle at bus 4" annotation (Dialog(enable=false));

        parameter OpenIPSL.Types.PerUnit V5 "Voltage magnitude at bus 5"
          annotation (Dialog(enable=false));
        parameter OpenIPSL.Types.Angle A5 "Voltage angle at bus 5" annotation (Dialog(enable=false));
       parameter OpenIPSL.Types.PerUnit V6 "Voltage magnitude at G2"
          annotation (Dialog(enable=false));
        parameter OpenIPSL.Types.Angle A6 "Voltage angle at G2" annotation (Dialog(enable=false));
         parameter OpenIPSL.Types.PerUnit V7 "Voltage magnitude at G2"
          annotation (Dialog(enable=false));
        parameter OpenIPSL.Types.Angle A7 "Voltage angle at G2" annotation (Dialog(enable=false));
        parameter OpenIPSL.Types.PerUnit V8 "Voltage magnitude at G2"
          annotation (Dialog(enable=false));
        parameter OpenIPSL.Types.Angle A8 "Voltage angle at G2" annotation (Dialog(enable=false));
        parameter OpenIPSL.Types.PerUnit V9 "Voltage magnitude at G2"
          annotation (Dialog(enable=false));
        parameter OpenIPSL.Types.Angle A9 "Voltage angle at G2" annotation (Dialog(enable=false));
        parameter OpenIPSL.Types.PerUnit V10 "Voltage magnitude at G2"
          annotation (Dialog(enable=false));
        parameter OpenIPSL.Types.Angle A10 "Voltage angle at G2" annotation (Dialog(enable=false));
        parameter OpenIPSL.Types.PerUnit V11 "Voltage magnitude at G2"
          annotation (Dialog(enable=false));
        parameter OpenIPSL.Types.Angle A11 "Voltage angle at G2" annotation (Dialog(enable=false));

      end BusTemplatewithRenewables2;

      partial record BusTemplatewithRenewables
        "Record template for power flow solutions in buses"

        parameter OpenIPSL.Types.PerUnit V1 "Voltage magnitude at G1"
          annotation (Dialog(enable=false));
        parameter OpenIPSL.Types.Angle A1 "Voltage angle at G1" annotation (Dialog(enable=false));

        parameter OpenIPSL.Types.PerUnit V2 "Voltage magnitude at bus 2"
          annotation (Dialog(enable=false));
        parameter OpenIPSL.Types.Angle A2 "Voltage angle at bus 2" annotation (Dialog(enable=false));

        parameter OpenIPSL.Types.PerUnit V3 "Voltage magnitude at bus 3"
          annotation (Dialog(enable=false));
        parameter OpenIPSL.Types.Angle A3 "Voltage angle at bus 3" annotation (Dialog(enable=false));

        parameter OpenIPSL.Types.PerUnit V4 "Voltage magnitude at bus 4"
          annotation (Dialog(enable=false));
        parameter OpenIPSL.Types.Angle A4 "Voltage angle at bus 4" annotation (Dialog(enable=false));

        parameter OpenIPSL.Types.PerUnit V5 "Voltage magnitude at bus 5"
          annotation (Dialog(enable=false));
        parameter OpenIPSL.Types.Angle A5 "Voltage angle at bus 5" annotation (Dialog(enable=false));
       parameter OpenIPSL.Types.PerUnit V6 "Voltage magnitude at G2"
          annotation (Dialog(enable=false));
        parameter OpenIPSL.Types.Angle A6 "Voltage angle at G2" annotation (Dialog(enable=false));
         parameter OpenIPSL.Types.PerUnit V7 "Voltage magnitude at G2"
          annotation (Dialog(enable=false));
        parameter OpenIPSL.Types.Angle A7 "Voltage angle at G2" annotation (Dialog(enable=false));

      end BusTemplatewithRenewables;
      extends Modelica.Icons.RecordsPackage;

      partial record BusTemplate "Record template for power flow solutions in buses"

        parameter OpenIPSL.Types.PerUnit V1 "Voltage magnitude at G1"
          annotation (Dialog(enable=false));
        parameter OpenIPSL.Types.Angle A1 "Voltage angle at G1" annotation (Dialog(enable=false));

        parameter OpenIPSL.Types.PerUnit V2 "Voltage magnitude at bus 2"
          annotation (Dialog(enable=false));
        parameter OpenIPSL.Types.Angle A2 "Voltage angle at bus 2" annotation (Dialog(enable=false));

        parameter OpenIPSL.Types.PerUnit V3 "Voltage magnitude at bus 3"
          annotation (Dialog(enable=false));
        parameter OpenIPSL.Types.Angle A3 "Voltage angle at bus 3" annotation (Dialog(enable=false));

        parameter OpenIPSL.Types.PerUnit V4 "Voltage magnitude at bus 4"
          annotation (Dialog(enable=false));
        parameter OpenIPSL.Types.Angle A4 "Voltage angle at bus 4" annotation (Dialog(enable=false));

        parameter OpenIPSL.Types.PerUnit V5 "Voltage magnitude at bus 5"
          annotation (Dialog(enable=false));
        parameter OpenIPSL.Types.Angle A5 "Voltage angle at bus 5" annotation (Dialog(enable=false));
       parameter OpenIPSL.Types.PerUnit V6 "Voltage magnitude at G2"
          annotation (Dialog(enable=false));
        parameter OpenIPSL.Types.Angle A6 "Voltage angle at G2" annotation (Dialog(enable=false));

      end BusTemplate;

      record PFBus01
        "Record for power flow solutions in buses - Microgrid Load = 5 MW"
        import Modelica.Constants.pi;
        extends BusTemplate(
        V1 = 1.0000,
        V2 = 0.9903815,
        V3 = 0.9927449,
        V4 = 1.0000,
        V5 = 0.9978245,
        V6 = 1.0000,
        A1 = 12.69018*pi/180,
        A2 = 6.426857*pi/180,
        A3 = 0.117574*pi/180,
        A4 = 0*pi/180,
        A5 = -0.4589332*pi/180,
        A6 = -0.1773913*pi/180);

          // Voltage Magnitudes

        // Angle

        // Bus: 'B01' (PV bus)

        // Bus: 'B02' (slack bus)

        // Bus: 'B03' (PQ bus)

        // Bus: 'B04' (PQ bus)

        // Bus: 'B05' (PQ bus)

      end PFBus01;

      record PFBus02
        "Record for power flow solutions in buses - Microgrid Load = 10 MW"
        import Modelica.Constants.pi;
        extends BusTemplate(
        V1 = 1.0000,
        V2 = 0.9910569,
        V3 = 0.9929926,
        V4 = 1.0000,
        V5 = 0.997748,
        V6 = 0.9999999,
        A1 = 12.02401*pi/180,
        A2 = 6.055835*pi/180,
        A3 = 0.04538411*pi/180,
        A4 = 0*pi/180,
        A5 = -0.1719799*pi/180,
        A6 = 0.2532443*pi/180);

          // Voltage Magnitudes

        // Angle

        // Bus: 'B01' (PV bus)

        // Bus: 'B02' (slack bus)

        // Bus: 'B03' (PQ bus)

        // Bus: 'B04' (PQ bus)

        // Bus: 'B05' (PQ bus)

      end PFBus02;

      record PFBus03
        "Record for power flow solutions in buses - Microgrid Load = 10 MW"
        import Modelica.Constants.pi;
        extends BusTemplate(
        V1 = 1.0000,
        V2 = 0.9916971,
        V3 = 0.9932263,
        V4 = 1.0000,
        V5 = 0.9976591,
        V6 = 1.0000,
        A1 = 11.35992*pi/180,
        A2 = 5.686001*pi/180,
        A3 = -0.02673999*pi/180,
        A4 = 0*pi/180,
        A5 = 0.1149386*pi/180,
        A6 = 0.6838229*pi/180);

          // Voltage Magnitudes

        // Angle

        // Bus: 'B01' (PV bus)

        // Bus: 'B02' (slack bus)

        // Bus: 'B03' (PQ bus)

        // Bus: 'B04' (PQ bus)

        // Bus: 'B05' (PQ bus)

      end PFBus03;

      record PFBus04
        "Record for power flow solutions in buses - Microgrid Load = 10 MW"
        import Modelica.Constants.pi;
        extends BusTemplate(
        V1 = 1.0000,
        V2 = 0.9926503,
        V3 = 0.9935721,
        V4 = 1.0000,
        V5 = 0.9985361,
        V6 = 1.0000,
        A1 = 10.30002*pi/180,
        A2 = 5.095809*pi/180,
        A3 = -0.1421618*pi/180,
        A4 = 0*pi/180,
        A5 = 0.5736473*pi/180,
        A6 = 1.144547*pi/180);

          // Voltage Magnitudes

        // Angle

        // Bus: 'B01' (PV bus)

        // Bus: 'B02' (slack bus)

        // Bus: 'B03' (PQ bus)

        // Bus: 'B04' (PQ bus)

        // Bus: 'B05' (PQ bus)

      end PFBus04;

      record PFBus05
        "Record for power flow solutions in buses - Microgrid Load = 10 MW"
        import Modelica.Constants.pi;
        extends BusTemplate(
        V1 = 1.0000,
        V2 = 0.9920654,
        V3 = 0.9933603,
        V4 = 1.0000,
        V5 = 0.9986383,
        V6 = 1.0000,
        A1 = 10.96133*pi/180,
        A2 = 5.464046*pi/180,
        A3 = -0.07010145*pi/180,
        A4 = 0*pi/180,
        A5 = 0.2869359*pi/180,
        A6 = 0.714334*pi/180);

          // Voltage Magnitudes

        // Angle

        // Bus: 'B01' (PV bus)

        // Bus: 'B02' (slack bus)

        // Bus: 'B03' (PQ bus)

        // Bus: 'B04' (PQ bus)

        // Bus: 'B05' (PQ bus)

      end PFBus05;

      record PFBus06
        "Record for power flow solutions in buses - Microgrid Load = 10 MW"
        import Modelica.Constants.pi;
        extends BusTemplate(
        V1 = 0.9999999,
        V2 = 0.9914459,
        V3 = 0.9931347,
        V4 = 1.0000,
        V5 = 0.998728,
        V6 = 1.0000,
        A1 = 11.62454*pi/180,
        A2 = 5.833365*pi/180,
        A3 = 0.002017891*pi/180,
        A4 = 0*pi/180,
        A5 = 0.0002148477*pi/180,
        A6 = 0.2840931*pi/180);

          // Voltage Magnitudes

        // Angle

        // Bus: 'B01' (PV bus)

        // Bus: 'B02' (slack bus)

        // Bus: 'B03' (PQ bus)

        // Bus: 'B04' (PQ bus)

        // Bus: 'B05' (PQ bus)

      end PFBus06;

      record PFBus07
        "Record for power flow solutions in buses - Microgrid Load = 10 MW"
        import Modelica.Constants.pi;
        extends BusTemplate(
        V1 = 1.0000000,
        V2 = 0.9914461,
        V3 = 0.9931349,
        V4 = 1.0000,
        V5 = 0.9993664,
        V6 = 0.9999999,
        A1 = 11.62429*pi/180,
        A2 = 5.833227*pi/180,
        A3 = 0.001990927*pi/180,
        A4 = 0*pi/180,
        A5 = 0.0001441713*pi/180,
        A6 = 0.142008*pi/180);

      end PFBus07;

      record PFBus08
        "Record for power flow solutions in buses - Microgrid Load = 10 MW"
        import Modelica.Constants.pi;
        extends BusTemplate(
        V1 = 1.0000000,
        V2 = 0.9914461,
        V3 = 0.9931349,
        V4 = 1.0000,
        V5 = 0.9993664,
        V6 = 0.9999999,
        A1 = 11.62453*pi/180,
        A2 = 5.83336*pi/180,
        A3 = 0.00201686*pi/180,
        A4 = 0*pi/180,
        A5 = 0.0002148475*pi/180,
        A6 = 0.2840931*pi/180);

      end PFBus08;

      record PFBus09
        "Record for power flow solutions in buses - Microgrid Load = 10 MW"
        import Modelica.Constants.pi;
        extends BusTemplate(
        V1 = 1.0000000,
        V2 = 0.9914455,
        V3 = 0.9931346,
        V4 = 1.0000,
        V5 = 0.9980846,
        V6 = 1.0000,
        A1 = 11.62498*pi/180,
        A2 = 5.833611*pi/180,
        A3 = 0.002065807*pi/180,
        A4 = 0*pi/180,
        A5 = 0.0002116913*pi/180,
        A6 = 0.4262582*pi/180);

      end PFBus09;

      record PFBus10
        "Record for power flow solutions in buses - Microgrid Load = 10 MW"
        import Modelica.Constants.pi;
        extends BusTemplate(
        V1 = 1.0000000,
        V2 = 0.9914451,
        V3 = 0.9931345,
        V4 = 1.0000,
        V5 = 0.9976962,
        V6 = 1.0000,
        A1 = 11.62533*pi/180,
        A2 = 5.833803*pi/180,
        A3 = 0.002103247*pi/180,
        A4 = 0*pi/180,
        A5 = 0.0001742224*pi/180,
        A6 = 0.5115968*pi/180);

      end PFBus10;

      record PFBus11
        "Record for power flow solutions in buses - Microgrid Load = 1 MW"
        import Modelica.Constants.pi;
        extends BusTemplate(
        V1 = 1.0000000,
        V2 = 0.9903815,
        V3 = 0.9927449,
        V4 = 1.0000,
        V5 = 0.9978246,
        V6 = 1.0000,
        A1 = 12.69018*pi/180,
        A2 = 6.426857*pi/180,
        A3 = 0.117574*pi/180,
        A4 = 0*pi/180,
        A5 = -0.4589332*pi/180,
        A6 = -0.177391*pi/180);

      end PFBus11;

      record PFBus12
        "Record for power flow solutions in buses - Microgrid Load = 1 MW"
        import Modelica.Constants.pi;
        extends BusTemplate(
        V1 = 1.0000000,
        V2 = 0.9903815,
        V3 = 0.9927449,
        V4 = 1.0000,
        V5 = 0.9978246,
        V6 = 1.0000,
        A1 = 12.69018*pi/180,
        A2 = 6.426857*pi/180,
        A3 = 0.117574*pi/180,
        A4 = 0*pi/180,
        A5 = -0.4589332*pi/180,
        A6 = -0.177391*pi/180);

      end PFBus12;

      record PFBus13
        "Record for power flow solutions in buses - Microgrid Load = 1 MW"
        import Modelica.Constants.pi;
        extends BusTemplatewithRenewables(
        V1 = 1.0000000,
        V2 = 0.9903815,
        V3 = 0.992745,
        V4 = 1.0000,
        V5 = 0.9986958,
        V6 = 1.0000,
        V7 = 1.0000,
        A1 = 12.69013*pi/180,
        A2 = 6.426827*pi/180,
        A3 = 0.1175681*pi/180,
        A4 = 0*pi/180,
        A5 = -0.4587689*pi/180,
        A6 = -0.1749737*pi/180,
        A7 = -0.4595171*pi/180);

      end PFBus13;

      record PFBus14
        "Record for power flow solutions in buses - Microgrid Load = 1 MW"
        import Modelica.Constants.pi;
        extends BusTemplatewithRenewables(
        V1 = 1.0000000,
        V2 = 0.9906561,
        V3 = 0.9928458,
        V4 = 1.0000,
        V5 = 0.9986964,
        V6 = 1.0000,
        V7 = 1.0000,
        A1 = 12.42328*pi/180,
        A2 = 6.278201*pi/180,
        A3 = 0.08867037*pi/180,
        A4 = 0*pi/180,
        A5 = -0.3440189*pi/180,
        A6 = -0.0602222*pi/180,
        A7 = -0.2873908*pi/180);

      end PFBus14;

      record PFBus15
        "Record for power flow solutions in buses - Microgrid Load = 1 MW"
        import Modelica.Constants.pi;
        extends BusTemplatewithRenewables(
        V1 = 1.0000000,
        V2 = 0.990681,
        V3 = 0.99287,
        V4 = 1.0000,
        V5 = 0.999095,
        V6 = 1.0000,
        V7 = 1.0000,
        A1 = 12.4219*pi/180,
        A2 = 6.27711*pi/180,
        A3 = 0.0878938*pi/180,
        A4 = 0*pi/180,
        A5 = -0.344745*pi/180,
        A6 = -0.06*pi/180,
        A7 = -0.3171*pi/180);

      end PFBus15;

      record PFBus16
        "Record for power flow solutions in buses - Microgrid Load = 1 MW"
        import Modelica.Constants.pi;
        extends BusTemplatewithRenewables2(
        V1 = 1.0000000,
        V2 = 0.9906552,
        V3 = 0.9928454,
        V4 = 1.0000,
        V5 = 0.99889,
        V6 = 1.0000,
        V7 = 0.9994217,
        V8 = 0.9999999,
        V9 = 0.9990281,
        V10 = 1.0000,
        V11 = 0.99883,
        A1 = 12.42416*pi/180,
        A2 = 6.27869*pi/180,
        A3 = 0.08876556*pi/180,
        A4 = 0*pi/180,
        A5 =-0.3443786*pi/180,
        A6 =-0.05788516*pi/180,
        A7 = -0.343482*pi/180,
        A8 = -0.2340838*pi/180,
        A9 = -0.3482724*pi/180,
        A10 = -0.4099371*pi/180,
        A11 = -0.3518794*pi/180);

      end PFBus16;

      record PFBus17
        "Record for power flow solutions in buses - Microgrid Load = 1 MW"
        import Modelica.Constants.pi;
        extends BusTemplatewithRenewables2(
        V1 = 1.0000000,
        V2 = 0.9926486,
        V3 = 0.9935714,
        V4 = 1.0000,
        V5 = 0.9990979,
        V6 = 1.0000,
        V7 = 0.9994217,
        V8 = 0.9999999,
        V9 = 0.9990281,
        V10 = 1.0000,
        V11 = 0.9990,
        A1 = 10.30208*pi/180,
        A2 = 5.096955*pi/180,
        A3 = -0.1419372*pi/180,
        A4 = 0*pi/180,
        A5 = 0.5722654*pi/180,
        A6 =1.09702*pi/180,
        A7 = 0.5801952*pi/180,
        A8 = 0.6838356*pi/180,
        A9 = 0.5695525*pi/180,
        A10 = 0.5080193*pi/180,
        A11 = 0.5659471*pi/180);

      end PFBus17;
      annotation (Documentation(info="<html>
<p>Records with power flow solutions for buses.</p>
</html>"));

    end BusData;

    package LoadData "Records with power flow solutions for loads"
      extends Modelica.Icons.RecordsPackage;

      partial record LoadTemplate
        "Record template for power flow solutions in loads"

        parameter OpenIPSL.Types.ActivePower PL1 "Load: constantLoad"
          annotation (Dialog(enable=false));
        parameter OpenIPSL.Types.ReactivePower QL1 "Load: constantLoad"
          annotation (Dialog(enable=false));
        parameter OpenIPSL.Types.ActivePower PL2 "Load: constantLoad"
          annotation (Dialog(enable=false));
        parameter OpenIPSL.Types.ReactivePower QL2 "Load: constantLoad"
          annotation (Dialog(enable=false));

      end LoadTemplate;

      record PFLoad01
        "{PL1  = 50MW, QL1 = 10MVar, PL2 = 9MW, QL2 = 2.9582 MVar}"
        extends LoadTemplate(
         PL1=50e6,
         QL1=10e6,
         PL2=9e6,
         QL2=2.9582e6);
        // Load 1

        // Load 2

        // Load: '3_1'

      end PFLoad01;

      record PFLoad02
        "{PL1  = 50MW, QL1 = 10MVar, PL2 = 9MW, QL2 = 2.9582 MVar}"
        extends LoadTemplate(
         PL1=50e6,
         QL1=10e6,
         PL2=9e6,
         QL2=2.9582e6);
        // Load 1

        // Load 2

        // Load: '3_1'

      end PFLoad02;

      record PFLoad03 "{PL1  = 50MW, QL1 = 10MVar, PL2 = 9MW, QL2 = 2.9582 MVar}"
        extends LoadTemplate(
         PL1=50e6,
         QL1=10e6,
         PL2=9e6,
         QL2=2.9582e6);
        // Load 1

        // Load 2

        // Load: '3_1'

      end PFLoad03;

      record PFLoad04
        "{PL1  = 50MW, QL1 = 10MVar, PL2 = 5MW, QL2 = 1.6434 MVar}"
        extends LoadTemplate(
         PL1=50e6,
         QL1=10e6,
         PL2=5e6,
         QL2=1.643421e6);
        // Load 1

        // Load 2

        // Load: '3_1'

      end PFLoad04;

      record PFLoad05 "{PL1  = 50MW, QL1 = 10MVar, PL2 = 5MW, QL2 = 1.6434 MVar}"
        extends LoadTemplate(
         PL1=50e6,
         QL1=10e6,
         PL2=5e6,
         QL2=1.643421e6);
        // Load 1

        // Load 2

        // Load: '3_1'

      end PFLoad05;

      record PFLoad06 "{PL1  = 50MW, QL1 = 10MVar, PL2 = 5MW, QL2 = 1.6434 MVar}"
        extends LoadTemplate(
         PL1=50e6,
         QL1=10e6,
         PL2=5e6,
         QL2=1.643421e6);
        // Load 1

        // Load 2

        // Load: '3_1'

      end PFLoad06;

      record PFLoad07
        "{PL1  = 50MW, QL1 = 10MVar, PL2 = 2.5MW, QL2 = 0.8217 MVar}"
        extends LoadTemplate(
         PL1=50e6,
         QL1=10e6,
         PL2=2.5e6,
         QL2=0.82171e6);
        // Load 1

        // Load 2

        // Load: '3_1'

      end PFLoad07;

      record PFLoad08
        "{PL1  = 50MW, QL1 = 10MVar, PL2 = 5MW, QL2 = 1.6434 MVar}"
        extends LoadTemplate(
         PL1=50e6,
         QL1=10e6,
         PL2=5e6,
         QL2=1.64342e6);
        // Load 1

        // Load 2

        // Load: '3_1'

      end PFLoad08;

      record PFLoad09
        "{PL1  = 50MW, QL1 = 10MVar, PL2 = 7.5MW, QL2 = 2.4651 MVar}"
        extends LoadTemplate(
         PL1=50e6,
         QL1=10e6,
         PL2=7.5e6,
         QL2=2.46513e6);
        // Load 1

        // Load 2

        // Load: '3_1'

      end PFLoad09;

      record PFLoad10
        "Record for power flow solutions in loads - Pload = 10 MW"
        extends LoadTemplate(
         PL1=50e6,
         QL1=10e6,
         PL2=9e6,
         QL2=2.9582e6);
        // Load 1

        // Load 2

        // Load: '3_1'

      end PFLoad10;

      record PFLoad11
        "{PL1  = 50MW, QL1 = 10MVar, PL2 = 9MW, QL2 = 2.9582 MVar}"
        extends LoadTemplate(
         PL1=50e6,
         QL1=10e6,
         PL2=9e6,
         QL2=2.9582e6);

      end PFLoad11;

      record PFLoad12 "{PL1  = 50MW, QL1 = 10MVar, PL2 = 9MW, QL2 = 2.9582 MVar}"
        extends LoadTemplate(
         PL1=50e6,
         QL1=10e6,
         PL2=9e6,
         QL2=2.9582e6);

      end PFLoad12;

      record PFLoad13
        "{PL1  = 50MW, QL1 = 10MVar, PL2 = 9MW, QL2 = 2.9582 MVar}"
        extends LoadTemplate(
         PL1=50e6,
         QL1=10e6,
         PL2=9e6,
         QL2=2.9582e6);

      end PFLoad13;

      record PFLoad14
        "{PL1  = 50MW, QL1 = 10MVar, PL2 = 9MW, QL2 = 2.9582 MVar}"
        extends LoadTemplate(
         PL1=50e6,
         QL1=10e6,
         PL2=9e6,
         QL2=2.9582e6);

      end PFLoad14;

      record PFLoad15
        "{PL1  = 50MW, QL1 = 10MVar, PL2 = 9MW, QL2 = 2.9582 MVar}"
        extends LoadTemplate(
         PL1=50e6,
         QL1=10e6,
         PL2=9e6,
         QL2=2.9580e6);

      end PFLoad15;

      record PFLoad16
        "{PL1  = 50MW, QL1 = 10MVar, PL2 = 9MW, QL2 = 2.9582 MVar}"
        extends LoadTemplate(
         PL1=50e6,
         QL1=10e6,
         PL2=9e6,
         QL2=2.9580e6);

      end PFLoad16;

      record PFLoad17
        "{PL1  = 50MW, QL1 = 10MVar, PL2 = 9MW, QL2 = 2.9582 MVar}"
        extends LoadTemplate(
         PL1=50e6,
         QL1=10e6,
         PL2=5e6,
         QL2=1.64e6);

      end PFLoad17;
      annotation (Documentation(info="<html>
<p>Records with power flow solutions for loads.</p>
</html>"));
    end LoadData;

    package MachineData "Records with power flow solutions for machines"
      partial record MachineTemplatewithRenewables
        "Record template for power flow solutions in machines"

        parameter OpenIPSL.Types.ActivePower PG1 "machine: generator1"
          annotation (Dialog(enable=false));
        parameter OpenIPSL.Types.ReactivePower QG1 "machine: generator1"
          annotation (Dialog(enable=false));

        parameter OpenIPSL.Types.ActivePower PG2 "machine: generator2"
          annotation (Dialog(enable=false));
        parameter OpenIPSL.Types.ReactivePower QG2 "machine: generator2"
           annotation (Dialog(enable=false));
          parameter OpenIPSL.Types.ActivePower PPV "machine: generator2"
          annotation (Dialog(enable=false));
        parameter OpenIPSL.Types.ReactivePower QPV "machine: generator2"
           annotation (Dialog(enable=false));
             parameter OpenIPSL.Types.ActivePower PBESS "machine: generator2"
          annotation (Dialog(enable=false));
        parameter OpenIPSL.Types.ReactivePower QBESS "machine: generator2"
           annotation (Dialog(enable=false));
           parameter OpenIPSL.Types.ActivePower Pinf "machine: infinite bus"
          annotation (Dialog(enable=false));
        parameter OpenIPSL.Types.ReactivePower Qinf "machine: infinite bus"
          annotation (Dialog(enable=false));

      end MachineTemplatewithRenewables;
      extends Modelica.Icons.RecordsPackage;

      partial record MachineTemplate
        "Record template for power flow solutions in machines"

        parameter OpenIPSL.Types.ActivePower PG1 "machine: generator1"
          annotation (Dialog(enable=false));
        parameter OpenIPSL.Types.ReactivePower QG1 "machine: generator1"
          annotation (Dialog(enable=false));

        parameter OpenIPSL.Types.ActivePower PG2 "machine: generator2"
          annotation (Dialog(enable=false));
        parameter OpenIPSL.Types.ReactivePower QG2 "machine: generator2"
           annotation (Dialog(enable=false));
           parameter OpenIPSL.Types.ActivePower Pinf "machine: infinite bus"
          annotation (Dialog(enable=false));
        parameter OpenIPSL.Types.ReactivePower Qinf "machine: infinite bus"
          annotation (Dialog(enable=false));

      end MachineTemplate;

      record PFMachine01
        "Machine Record - [L2 10MW/3.28684MVar]; [G2 5MW/2.1669MVar]"
        extends MachineTemplate(
         PG1=54.0618e6,
         QG1=7.494723e6,
         PG2=5.00000e6,
         QG2=1.93757e6,
         Pinf=-4.524317e-05,
         Qinf=15.61806e6);
          // Machine G1

        // Machine G2

        // Machine Inf

      end PFMachine01;

      record PFMachine02
        "Record for power flow solutions in machines - Pload = 10 MW"
        extends MachineTemplate(
         PG1=51.5576e6,
         QG1=6.899646e6,
         PG2=7.5e6,
         QG2=1.904409e6,
         Pinf=4.163468e-05,
         Qinf=15.14367e6);
          // Machine G1

        // Machine G2

        // Machine Inf

      end PFMachine02;

      record PFMachine03
        "Record for power flow solutions in machines - Pload = 10 MW"
        extends MachineTemplate(
         PG1=49.0546e6,
         QG1=6.335524e6,
         PG2=10e6,
         QG2=1.890087e6,
         Pinf=-5.40828e-06,
         Qinf=14.71908e6);
          // Machine G1

        // Machine G2

        // Machine Inf

      end PFMachine03;

      record PFMachine04
        "Record for power flow solutions in machines - Pload = 10 MW"
        extends MachineTemplate(
         PG1=45.047e6,
         QG1=5.495558e6,
         PG2=10e6,
         QG2=1.013569e6,
         Pinf=-3.016484e-05,
         Qinf=13.61904e6);
          // Machine G1

        // Machine G2

        // Machine Inf

      end PFMachine04;

      record PFMachine05
        "Record for power flow solutions in machines - Pload = 10 MW"
        extends MachineTemplate(
         PG1=47.5493e6,
         QG1=6.010928e6,
         PG2=7.5e6,
         QG2=1.01453e6,
         Pinf=2.667061e-05,
         Qinf=13.96811e6);
          // Machine G1

        // Machine G2

        // Machine Inf

      end PFMachine05;

      record PFMachine06
        "Record for power flow solutions in machines - Pload = 10 MW"
        extends MachineTemplate(
         PG1=50.05274e6,
         QG1=6.556822e6,
         PG2=5e6,
         QG2=1.03429e6,
         Pinf=6.032772e-06,
         Qinf=14.36652e6);
          // Machine G1

        // Machine G2

        // Machine Inf

      end PFMachine06;

      record PFMachine07
        "Record for power flow solutions in machines - Pload = 10 MW"
        extends MachineTemplate(
         PG1=50.0518e6,
         QG1=6.556613e6,
         PG2=2.5000e6,
         QG2=0.5116372e6,
         Pinf=-4.105587e-05,
         Qinf=14.04712e6);
          // Machine G1

        // Machine G2

        // Machine Inf

      end PFMachine07;

      record PFMachine08
        "Record for power flow solutions in machines - Pload = 10 MW"
        extends MachineTemplate(
         PG1=50.0527e6,
         QG1=6.556815e6,
         PG2=5e6,
         QG2=1.03429e6,
         Pinf=4.172131e-05,
         Qinf=14.36652e6);
          // Machine G1

        // Machine G2

        // Machine Inf

      end PFMachine08;

      record PFMachine09
        "Record for power flow solutions in machines - Pload = 10 MW"
        extends MachineTemplate(
         PG1=50.0544e6,
         QG1=6.557196e6,
         PG2=7.5e6,
         QG2=1.56799e6,
         Pinf=-1.641935e-05,
         Qinf=14.68852e6);
          // Machine G1

        // Machine G2

        // Machine Inf

      end PFMachine09;

      record PFMachine10
        "Record for power flow solutions in machines - Pload = 10 MW"
        extends MachineTemplate(
         PG1=50.0557e6,
         QG1=6.557487e6,
         PG2=9e6,
         QG2=1.893555e6,
         Pinf=-1.516062e-05,
         Qinf=14.88296e6);
          // Machine G1

        // Machine G2

        // Machine Inf

      end PFMachine10;

      record PFMachine11
        "Record for power flow solutions in machines - Pload = 1 MW"
        extends MachineTemplate(
         PG1=54.0618e6,
         QG1=7.494723e6,
         PG2=5e6,
         QG2=1.937436e6,
         Pinf=-4.527057e-05,
         Qinf=15.618e6);
          // Machine G1

        // Machine G2

        // Machine Inf

      end PFMachine11;

      record PFMachine12
        "Record for power flow solutions in machines - Pload = 1 MW"
        extends MachineTemplate(
         PG1=54.0618e6,
         QG1=7.494723e6,
         PG2=5e6,
         QG2=1.937436e6,
         Pinf=-4.527057e-05,
         Qinf=15.618e6);
          // Machine G1

        // Machine G2

        // Machine Inf

      end PFMachine12;

      record PFMachine13
        "Record for power flow solutions in machines - Pload = 1 MW"
        extends MachineTemplatewithRenewables(
         PG1=54.0616e6,
         QG1=7.494674e6,
         PG2=5e6,
         QG2=1.066431e6,
         PPV=1e6,
         QPV=0.6520903e6,
         PBESS=-1e6,
         QBESS=0.6520903e6,
         Pinf=3.556131e-05,
         Qinf=15.18235e6);
          // Machine G1

        // Machine G2

        // Machine Inf

      end PFMachine13;

      record PFMachine14
        "This is the first example with G2 and a PV source only"
        extends MachineTemplatewithRenewables(
         PG1=53.0593e6,
         QG1=7.252797e6,
         PG2=5e6,
         QG2=1.065823e6,
         PPV=1e6,
         QPV=1.294059e6,
         PBESS=0,
         QBESS=0,
         Pinf=2.37497e-5,
         Qinf=14.97167e6);
          // Machine G1

        // Machine G2

        // Machine Inf

      end PFMachine14;

      record PFMachine15
        "This is the first example with G2 and a PV source only"
        extends MachineTemplatewithRenewables(
         PG1=53.0593e6,
         QG1=7.25264e6,
         PG2=5e6,
         QG2=0.698234e6,
         PPV=0,
         QPV=0,
         PBESS=1e6,
         QBESS=1.84739e6,
         Pinf=1.4769e-1,
         Qinf=14.7846e6);
          // Machine G1

        // Machine G2

        // Machine Inf

      end PFMachine15;

      record PFMachine16 "New Microgrid Scenario with G2, PV, and BESS"
        extends MachineTemplatewithRenewables(
         PG1=53.0626e6,
         QG1=7.253585e6,
         Pinf=-3.868197e1,
         Qinf=14.87556e6,
         PG2=5e6,
         QG2=0.3687915e6,
         PPV=2e6,
         QPV=0.8830127e6,
         PBESS=-1e6,
         QBESS=1.20856e6);
          // Machine G1

        // Machine G2

        // Machine Inf

      end PFMachine16;

      record PFMachine17 "New Microgrid Scenario with G2, PV, and BESS"
        extends MachineTemplatewithRenewables(
         PG1=45.0548e6,
         QG1=5.497117e6,
         Pinf=1.418905e1,
         Qinf=13.33923e6,
         PG2=9e6,
         QG2=-0.4020076e6,
         PPV=2e6,
         QPV=0.6771919e6,
         PBESS=-1e6,
         QBESS=1.002671e6);
          // Machine G1

        // Machine G2

        // Machine Inf

      end PFMachine17;
      annotation (Documentation(info="<html>
<p>Records with power flow solutions for machines.</p>
</html>"));
    end MachineData;

    record PF01 "Microgrid Load Scenario: [L2 10MW/3.28684MVar]; [G2 5MW/2.1669MVar]"
      extends PowerFlowTemplate;

      replaceable record Bus =
          BusData.PFBus01   constrainedby BusData.BusTemplate
        "Power flow results for buses";
      Bus bus;

      replaceable record Loads =
          LoadData.PFLoad01    constrainedby LoadData.LoadTemplate
        "Power flow results for loads";
      Loads loads;

      replaceable record Machines =
          MachineData.PFMachine01    constrainedby MachineData.MachineTemplate
        "Power flow results for machines";
      Machines machines;

    end PF01;

    record PF02 "Microgrid Load Scenario: [L2 10MW/3.28684MVar]; [G2 7.5MW/2.1304MVar]"
      extends PowerFlowTemplate;

      replaceable record Bus =
          BusData.PFBus02   constrainedby BusData.BusTemplate
        "Power flow results for buses";
      Bus bus;

      replaceable record Loads =
          LoadData.PFLoad02    constrainedby LoadData.LoadTemplate
        "Power flow results for loads";
      Loads loads;

      replaceable record Machines =
          MachineData.PFMachine02    constrainedby MachineData.MachineTemplate
        "Power flow results for machines";
      Machines machines;

    end PF02;

    record PF03
      "Microgrid Load Scenario: [L2 10MW/3.28684MVar]; [G2 10MW/2.1127MVar]"
      extends PowerFlowTemplate;

      replaceable record Bus =
          BusData.PFBus03   constrainedby BusData.BusTemplate
        "Power flow results for buses";
      Bus bus;

      replaceable record Loads =
          LoadData.PFLoad03    constrainedby LoadData.LoadTemplate
        "Power flow results for loads";
      Loads loads;

      replaceable record Machines =
          MachineData.PFMachine03    constrainedby MachineData.MachineTemplate
        "Power flow results for machines";
      Machines machines;

    end PF03;

    record PF04
      "Microgrid Load Scenario: [L2 5MW/1.6434MVar]; [G2 10MW/1.0135MVar]"
      extends PowerFlowTemplate;

      replaceable record Bus =
          BusData.PFBus04   constrainedby BusData.BusTemplate
        "Power flow results for buses";
      Bus bus;

      replaceable record Loads =
          LoadData.PFLoad04    constrainedby LoadData.LoadTemplate
        "Power flow results for loads";
      Loads loads;

      replaceable record Machines =
          MachineData.PFMachine04    constrainedby MachineData.MachineTemplate
        "Power flow results for machines";
      Machines machines;

    end PF04;

    record PF05
      "Microgrid Load Scenario: [L2 5MW/1.6434MVar]; [G2 7.5MW/1.0145MVar]"
      extends PowerFlowTemplate;

      replaceable record Bus =
          BusData.PFBus05   constrainedby BusData.BusTemplate
        "Power flow results for buses";
      Bus bus;

      replaceable record Loads =
          LoadData.PFLoad05    constrainedby LoadData.LoadTemplate
        "Power flow results for loads";
      Loads loads;

      replaceable record Machines =
          MachineData.PFMachine05    constrainedby MachineData.MachineTemplate
        "Power flow results for machines";
      Machines machines;

    end PF05;

    record PF06
      "Microgrid Load Scenario: [L2 5MW/1.6434MVar]; [G2 5MW/1.0342MVar]"
      extends PowerFlowTemplate;

      replaceable record Bus =
          BusData.PFBus06   constrainedby BusData.BusTemplate
        "Power flow results for buses";
      Bus bus;

      replaceable record Loads =
          LoadData.PFLoad06    constrainedby LoadData.LoadTemplate
        "Power flow results for loads";
      Loads loads;

      replaceable record Machines =
          MachineData.PFMachine06    constrainedby MachineData.MachineTemplate
        "Power flow results for machines";
      Machines machines;

    end PF06;

    record PF07
      "Microgrid Load Scenario: [L2 2.5MW/0.8217MVar]; [G2 2.5MW/6.6782MVar]"
      extends PowerFlowTemplate;

      replaceable record Bus =
          BusData.PFBus07   constrainedby BusData.BusTemplate
        "Power flow results for buses";
      Bus bus;

      replaceable record Loads =
          LoadData.PFLoad07    constrainedby LoadData.LoadTemplate
        "Power flow results for loads";
      Loads loads;

      replaceable record Machines =
          MachineData.PFMachine07    constrainedby MachineData.MachineTemplate
        "Power flow results for machines";
      Machines machines;

    end PF07;

    record PF08
      "Microgrid Load Scenario: [L2 2.5MW/0.8217MVar]; [G2 2.5MW/6.6782MVar]"
      extends PowerFlowTemplate;

      replaceable record Bus =
          BusData.PFBus08   constrainedby BusData.BusTemplate
        "Power flow results for buses";
      Bus bus;

      replaceable record Loads =
          LoadData.PFLoad08    constrainedby LoadData.LoadTemplate
        "Power flow results for loads";
      Loads loads;

      replaceable record Machines =
          MachineData.PFMachine08    constrainedby MachineData.MachineTemplate
        "Power flow results for machines";
      Machines machines;

    end PF08;

    record PF09
      "Microgrid Load Scenario: [L2 2.5MW/0.8217MVar]; [G2 2.5MW/6.6782MVar]"
      extends PowerFlowTemplate;

      replaceable record Bus =
          BusData.PFBus09   constrainedby BusData.BusTemplate
        "Power flow results for buses";
      Bus bus;

      replaceable record Loads =
          LoadData.PFLoad09    constrainedby LoadData.LoadTemplate
        "Power flow results for loads";
      Loads loads;

      replaceable record Machines =
          MachineData.PFMachine09    constrainedby MachineData.MachineTemplate
        "Power flow results for machines";
      Machines machines;

    end PF09;

    record PF10
      "Microgrid Load Scenario: [L2 2.5MW/0.8217MVar]; [G2 2.5MW/6.6782MVar]"
      extends PowerFlowTemplate;

      replaceable record Bus =
          BusData.PFBus10   constrainedby BusData.BusTemplate
        "Power flow results for buses";
      Bus bus;

      replaceable record Loads =
          LoadData.PFLoad10    constrainedby LoadData.LoadTemplate
        "Power flow results for loads";
      Loads loads;

      replaceable record Machines =
          MachineData.PFMachine10    constrainedby MachineData.MachineTemplate
        "Power flow results for machines";
      Machines machines;

    end PF10;

    record PF11
      "Microgrid Load Scenario: [L2 1MW/0.328MVar]; [G2 10MW/0.1599MVar]"
      extends PowerFlowTemplate;

      replaceable record Bus =
          BusData.PFBus11   constrainedby BusData.BusTemplate
        "Power flow results for buses";
      Bus bus;

      replaceable record Loads =
          LoadData.PFLoad11    constrainedby LoadData.LoadTemplate
        "Power flow results for loads";
      Loads loads;

      replaceable record Machines =
          MachineData.PFMachine11    constrainedby MachineData.MachineTemplate
        "Power flow results for machines";
      Machines machines;

    end PF11;

    record PF13 "Microgrid Load Scenario with Renewables"
      extends PowerFlowTemplate;

      replaceable record Bus =
          BusData.PFBus13   constrainedby BusData.BusTemplate
        "Power flow results for buses";
      Bus bus;

      replaceable record Loads =
          LoadData.PFLoad13    constrainedby LoadData.LoadTemplate
        "Power flow results for loads";
      Loads loads;

      replaceable record Machines =
          MachineData.PFMachine13    constrainedby MachineData.MachineTemplate
        "Power flow results for machines";
      Machines machines;

    end PF13;

    record PF14 "Microgrid Load Scenario with Renewables"
      extends PowerFlowTemplate;

      replaceable record Bus =
          BusData.PFBus14   constrainedby BusData.BusTemplate
        "Power flow results for buses";
      Bus bus;

      replaceable record Loads =
          LoadData.PFLoad14    constrainedby LoadData.LoadTemplate
        "Power flow results for loads";
      Loads loads;

      replaceable record Machines =
          MachineData.PFMachine14    constrainedby MachineData.MachineTemplate
        "Power flow results for machines";
      Machines machines;

    end PF14;

    record PF15 "Microgrid Load Scenario with Renewables"
      extends PowerFlowTemplate;

      replaceable record Bus =
          BusData.PFBus15   constrainedby BusData.BusTemplate
        "Power flow results for buses";
      Bus bus;

      replaceable record Loads =
          LoadData.PFLoad15    constrainedby LoadData.LoadTemplate
        "Power flow results for loads";
      Loads loads;

      replaceable record Machines =
          MachineData.PFMachine15    constrainedby MachineData.MachineTemplate
        "Power flow results for machines";
      Machines machines;

    end PF15;

    record PF16 "Microgrid Load Scenario with Renewables"
      extends PowerFlowTemplate;

      replaceable record Bus =
          BusData.PFBus16   constrainedby BusData.BusTemplate
        "Power flow results for buses";
      Bus bus;

      replaceable record Loads =
          LoadData.PFLoad16    constrainedby LoadData.LoadTemplate
        "Power flow results for loads";
      Loads loads;

      replaceable record Machines =
          MachineData.PFMachine16    constrainedby MachineData.MachineTemplate
        "Power flow results for machines";
      Machines machines;

    end PF16;

    record PF17 "Microgrid Load Scenario with Renewables"
      extends PowerFlowTemplate;

      replaceable record Bus =
          BusData.PFBus17   constrainedby BusData.BusTemplate
        "Power flow results for buses";
      Bus bus;

      replaceable record Loads =
          LoadData.PFLoad17    constrainedby LoadData.LoadTemplate
        "Power flow results for loads";
      Loads loads;

      replaceable record Machines =
          MachineData.PFMachine17    constrainedby MachineData.MachineTemplate
        "Power flow results for machines";
      Machines machines;

    end PF17;
  end PFData;

  package Functions
    function Linearization_Microgrid
      import Modelica_LinearSystems2.StateSpace;
      import Modelica_LinearSystems2.TransferFunction;

      input String pathToNonlinearPlantModel="OpenIPSL.Examples.ModelPredictiveControl.PSSE.EquipmentOnlyLinearization.MPCAppliedEnergyLinearized_test2";
      input Modelica.Units.SI.Time tlin = 0.001;

    algorithm


      // Linearize plant model at t_lin
      ss := Modelica_LinearSystems2.ModelAnalysis.Linearize(pathToNonlinearPlantModel,
      simulationSetup=Modelica_LinearSystems2.Records.SimulationOptionsForLinearization(linearizeAtInitial=false, t_linearize=tlin));

      // Print Linear System
      Modelica.Utilities.Streams.print(String(ss));

      //SAVE the data in a .mat file
      DataFiles.writeMATmatrix(
      "MyData.mat",
      "ABCD",
      [ss.A,ss.B; ss.C,ss.D],
      append = false);

      nx:= size(ss.A, 1);
      DataFiles.writeMATmatrix(
      "MyData.mat",
      "nx",
      [nx],
      append = true);





    end Linearization_Microgrid;
  end Functions;
end ModelPredictiveControl;
